<!doctype html><html><head><title>spring IOC 加载过程简要介绍 // 超的博客</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="spring IOC 加载过程简要介绍"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:locale" content="zh"><meta property="og:url" content="https://dccmmtop.github.io/posts/springioc%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E7%AE%80%E8%A6%81%E4%BB%8B%E7%BB%8D/"><link rel=icon type=image/x-icon href=../../favicon.ico><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js integrity=sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1 crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<link href=https://dccmmtop.github.io/webfonts/ptserif/main.css rel=stylesheet type=text/css><link href=https://dccmmtop.github.io/webfonts/source-code-pro/main.css rel=stylesheet type=text/css><link rel=stylesheet href=https://dccmmtop.github.io/css/style.css><link rel=stylesheet href=https://dccmmtop.github.io/css/custom.css><link rel=stylesheet href=https://dccmmtop.github.io/css/copy-to-clipboard.css><script src=https://dccmmtop.github.io/js/fastsearch.js></script>
<script src=https://dccmmtop.github.io/js/fuse.js></script>
<script src=https://dccmmtop.github.io/js/custom.js></script>
<script src=https://dccmmtop.github.io/js/copy-to-clipboard.js></script>
<script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?e0fe0b20745a9435509785b9f15eb32d",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta name=google-site-verification content="15Pa8fZ9IfDWw5gRPmi3YLNnHcciUc4a3Hv8cNKm-Ac"><meta name=generator content="Hugo 0.111.3"></head><body><div id=container><header id=header><div id=header-outer class=outer><div id=header-inner class=inner><a id=main-nav-toggle class=nav-icon href=javascript:;></a>
<a id=logo class=logo-text href=https://dccmmtop.github.io/>超的博客</a><nav id=main-nav><a class=main-nav-link href=../../posts/>文章</a>
<a class=main-nav-link href=../../tags/>标签</a>
<a class=main-nav-link href=../../about/>我</a>
<a class=main-nav-link id=search><input id=inputSearch placeholder=search><svg t="1634282825021" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="2401" width="15" height="15"><path d="M1005.312 914.752 806.784 716.288A448 448 0 100 448a448 448 0 00716.288 358.784l198.4 198.4a64 64 0 1090.624-90.432zM448 767.936A320 320 0 11448 128a320 320 0 010 640z" fill="#262626" p-id="2402"/></svg></a></nav><nav id=sub-nav><div id=search-form-wrap></div></nav></div></div><div class="modal fade" id=exampleModal tabindex=-1 role=dialog aria-labelledby=exampleModalLabel aria-hidden=true><div class=modal-dialog role=document><div class=modal-content><div class=modal-header><h5 class=modal-title id=exampleModalLabel>搜索结果</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class="modal-body searchResults"></div></div></div></div></header><section id=main class=outer><article class="article article-type-post" itemscope itemprop=blogPost><div class=article-inner><header class=article-header><h1 class=article-title itemprop=name>spring IOC 加载过程简要介绍</h1></header><div class=article-meta><a href=../../posts/springioc%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E7%AE%80%E8%A6%81%E4%BB%8B%E7%BB%8D/ class=article-date><time datetime=2022-11-08T14:48:39.000+00:00 itemprop=datePublished>2022-11-08</time></a></div><div class=article-entry itemprop=articleBody><p>本文从源码层面简要介绍一下 Spring IoC 加载过程，以及这个过程遇到的重点方法，重点类。</p><h2 id=new-annotationconfigapplicationcontext>new AnnotationConfigApplicationContext()</h2><p>一切的根源都要从 <code>new AnnotationConfigApplicationContext()</code> 方法开始，这是 Spring 启动的入口，先准备如下代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>ContextDemo</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        AnnotationConfigApplicationContext context <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> AnnotationConfigApplicationContext<span style=color:#ff79c6>(</span>Config<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        context<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBean</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;car&#34;</span><span style=color:#ff79c6>,</span>Car<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Configuration
</span></span><span style=display:flex><span>@ComponentScan<span style=color:#ff79c6>(</span>basePackageClasses <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>{</span>Car<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>})</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Config</span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    @Bean
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> User1 <span style=color:#50fa7b>user</span><span style=color:#ff79c6>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> User1<span style=color:#ff79c6>(</span><span style=color:#bd93f9>10</span><span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;dc1&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Component
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Car</span>  <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> color<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> String name<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>User1</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> age<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> String name<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>进入 <code>new AnnotationConfigApplicationContext(Config.class);</code> 方法可见如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>AnnotationConfigApplicationContext</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>&lt;?&gt;...</span> annotatedClasses<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    register<span style=color:#ff79c6>(</span>annotatedClasses<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    refresh<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>再进入 <code>this()</code> 方法，如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>AnnotationConfigApplicationContext</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>reader</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> AnnotatedBeanDefinitionReader<span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>scanner</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ClassPathBeanDefinitionScanner<span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>发现调用的 <code>AnnotationConfigApplicationContext</code> 无参构造器， 再调用一个类的无参构造器时，会先调用父类的无参构造器， 同时发现这个类的父类构造器如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>GenericApplicationContext</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>beanFactory</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> DefaultListableBeanFactory<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>方法很简单，只是 new 了一个 <code>beanFactory</code>, 从名称来看，这个属性是 bean 工厂。现在只知道 <code>AnnotationConfigApplicationContext</code> 中有一个 <code>beanFactory</code> 的字段，这个字段是从父类继承来的。</p><p>父类的构造方法已经结束，接着往下看， <code>this.reader = new AnnotatedBeanDefinitionReader(this);</code>, <code>this.scanner = new ClassPathBeanDefinitionScanner(this); </code>。初始化 <code>reader</code> 和 <code>scanner</code>.</p><ol><li>找到 <code>reader</code> 属性，会发现它是 <code>AnnotatedBeanDefinitionReader</code> 类型。看一下这个类型的注释说明：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * Convenient adapter for programmatic registration of annotated bean classes.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * This is an alternative to {@link ClassPathBeanDefinitionScanner}, applying
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * the same resolution of annotations but for explicitly registered classes only.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @author Juergen Hoeller
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @author Chris Beams
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @author Sam Brannen
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @author Phillip Webb
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @since 3.0
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @see AnnotationConfigApplicationContext#register
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>AnnotatedBeanDefinitionReader</span> <span style=color:#ff79c6>{....}</span>
</span></span></code></pre></div><p>翻译一下：</p><blockquote><p>简便的适配器，用于注解 bean 类的注册。这是 ClassPathBeanDefinitionScanner 的替代方案，应用相同的注解，但仅适用于显式注册的类。</p></blockquote><p>意思就是可以替代 <code>ClassPathBeanDefinitionScanner</code> 使用，但是它只能用于我们手动注册的类。</p><ol start=2><li>找到<code>scanner</code> 属性，发现它正是 <code>ClassPathBeanDefinitionScanner</code> 类型。再看一下这个类的注释说明：</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * A bean definition scanner that detects bean candidates on the classpath,
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * registering corresponding bean definitions with a given registry ({@code BeanFactory}
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * or {@code ApplicationContext}).
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * &lt;p&gt;Candidate classes are detected through configurable type filters. The
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * default filters include classes that are annotated with Spring&#39;s
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * {@link org.springframework.stereotype.Component @Component},
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * {@link org.springframework.stereotype.Repository @Repository},
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * {@link org.springframework.stereotype.Service @Service}, or
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * {@link org.springframework.stereotype.Controller @Controller} stereotype.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * &lt;p&gt;Also supports Java EE 6&#39;s {@link javax.annotation.ManagedBean} and
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * JSR-330&#39;s {@link javax.inject.Named} annotations, if available.
</span></span></span><span style=display:flex><span><span style=color:#6272a4> *
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @author Mark Fisher
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @author Juergen Hoeller
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @author Chris Beams
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @since 2.5
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @see AnnotationConfigApplicationContext#scan
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @see org.springframework.stereotype.Component
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @see org.springframework.stereotype.Repository
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @see org.springframework.stereotype.Service
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * @see org.springframework.stereotype.Controller
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>ClassPathBeanDefinitionScanner</span> <span style=color:#8be9fd;font-style:italic>extends</span> ClassPathScanningCandidateComponentProvider <span style=color:#ff79c6>{...}</span>
</span></span></code></pre></div><p>翻译一下：</p><blockquote><p>一个 bean 定义扫描器，用于检测类路径上的 bean 的候选者，将相应的 bean 定义注册到给定的注册表（ BeanFactory 或 ApplicationContext ）。<br>通过可配置的类型过滤器检测候选类。默认过滤器包括使用 Spring 的@Component 、 @Repository 、 @Service 或@Controller 原型注释的类。<br>如果可用，还支持 Java EE 6 的 javax.annotation.ManagedBean 和 JSR-330 的 javax.inject.Named 注释。</p></blockquote><p>它的意思说，把类路径中的所有类进行扫描。把类中配置的 bean 放到注册表， 注册表可能是 <code>BeanFactory</code> 或者 <code>ApplicationContext</code></p><p>到这里可以知道， <code>AnnotationConfigApplicationContext</code> 除了继承父类的属性外，还初始化了 1. bean 定义读取器 (reader) 2. bean 定义扫描器 (scanner)</p><p>下面看一下如何初始化的：</p><h2 id=初始化-annotatedbeandefinitionreader>初始化 AnnotatedBeanDefinitionReader</h2><p>一层层进入 <code>new AnnotatedBeanDefinitionReader(this)</code>, 最终找到方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    * Register all relevant annotation post processors in the given registry.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    * @param registry the registry to operate on
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    * @param source the configuration source element (already extracted)
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    * that this registration was triggered from. May be {@code null}.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    * @return a Set of BeanDefinitionHolders, containing all bean definitions
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    * that have actually been registered by this call
</span></span></span><span style=display:flex><span><span style=color:#6272a4>    */</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> Set<span style=color:#ff79c6>&lt;</span>BeanDefinitionHolder<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>registerAnnotationConfigProcessors</span><span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>        BeanDefinitionRegistry registry<span style=color:#ff79c6>,</span> @Nullable Object source<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    DefaultListableBeanFactory beanFactory <span style=color:#ff79c6>=</span> unwrapDefaultListableBeanFactory<span style=color:#ff79c6>(</span>registry<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>beanFactory <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDependencyComparator</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>instanceof</span> AnnotationAwareOrderComparator<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setDependencyComparator</span><span style=color:#ff79c6>(</span>AnnotationAwareOrderComparator<span style=color:#ff79c6>.</span><span style=color:#50fa7b>INSTANCE</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getAutowireCandidateResolver</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>instanceof</span> ContextAnnotationAutowireCandidateResolver<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAutowireCandidateResolver</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> ContextAnnotationAutowireCandidateResolver<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Set<span style=color:#ff79c6>&lt;</span>BeanDefinitionHolder<span style=color:#ff79c6>&gt;</span> beanDefs <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> LinkedHashSet<span style=color:#ff79c6>&lt;&gt;(</span><span style=color:#bd93f9>8</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>registry<span style=color:#ff79c6>.</span><span style=color:#50fa7b>containsBeanDefinition</span><span style=color:#ff79c6>(</span>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        RootBeanDefinition def <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> RootBeanDefinition<span style=color:#ff79c6>(</span>ConfigurationClassPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        def<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setSource</span><span style=color:#ff79c6>(</span>source<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        beanDefs<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>registerPostProcessor<span style=color:#ff79c6>(</span>registry<span style=color:#ff79c6>,</span> def<span style=color:#ff79c6>,</span> CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>registry<span style=color:#ff79c6>.</span><span style=color:#50fa7b>containsBeanDefinition</span><span style=color:#ff79c6>(</span>AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        RootBeanDefinition def <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> RootBeanDefinition<span style=color:#ff79c6>(</span>AutowiredAnnotationBeanPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        def<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setSource</span><span style=color:#ff79c6>(</span>source<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        beanDefs<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>registerPostProcessor<span style=color:#ff79c6>(</span>registry<span style=color:#ff79c6>,</span> def<span style=color:#ff79c6>,</span> AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// .... 省略很多代码
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>return</span> beanDefs<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>先翻译一下这个方法的注释，以及参数和返回值：</p><p><strong>注释：</strong></p><blockquote><p>在给定的注册表中注册所有相关的注解后处理器</p></blockquote><p><strong>参数：</strong></p><ol><li>第一个参数是： <code>register</code>, 这个是从最开始传入的 <code>AnnotationConfigApplicationContext</code> 对象</li><li>第二个参数是：<code>Object source</code> 这个传入的 null, 暂不关心它</li></ol><p><strong>返回值：</strong></p><p>返回的是 <code>Set&lt;BeanDefinitionHolder></code> 集合，到这里先暂停一下，需要看 <code>BeanDefinitionHolder</code> 是什么，它里面都是什么属性，以及干嘛用的：</p><h3 id=beandefinition>BeanDefinition</h3><p>进入这个类，查看它的注释和内部结构：<br>通过注释可以知道它是 <strong>具有名称和别名的 BeanDefinition 的持有者</strong></p><p><img src=https://raw.githubusercontent.com/dccmmtop/notebook/master/images/2022-11-08-16-12-20.png alt></p><p>由此可知道关键信息不在它，而是 <code>BeanDefinition</code>, <code>BeanDefinitionHolder</code> 只是 <code>BeanDefinition</code> 的持有者，只比 <code>BeanDefinition</code> 多了 <code>beanName</code> 以及别名属性。为的是可以有一个具体的名称来描述 <code>BeanDefinition</code>. 所以要接着看 <code>BeanDefinition</code>：</p><p>先看翻译下 <code>BeanDefinition</code> 的注释：</p><blockquote><p>BeanDefinition 描述了一个 bean 实例，它具有属性值、构造函数参数值以及具体实现提供的更多信息。 这只是一个最小接口：主要目的是允许像 PropertyPlaceholderConfigurer 这样的 BeanFactoryPostProcessor 内省和修改属性值和其他 bean 元数据。</p></blockquote><p>它说 BeanDefinition <strong>描述了</strong> bean 的实例。也就是建筑图纸和建筑物的关系，BeanDefinition 会存有 某个 bean 的字段，构造方法等等。可以根据 BeanDefinition 构造出应的 bean。就如同可以通过建筑图纸还原出建筑物一样。</p><p>这里就非常巧妙了，一个系统中的有各式各样的 bean，功能不同，类型不同。用一个相同的东西去描述，操作这些 bean，是一个非常有利的转换。因为它们都是对象，是对象就会有方法，字段，类型。把这些方法，字段，类型再抽象，聚合就形成了 BeanDefinition.</p><p>看一下 BeanDefinition 内部结构：</p><p><img src=https://raw.githubusercontent.com/dccmmtop/notebook/master/images/2022-11-08-16-40-24.png alt></p><p>内容很多，都是设置，获取 某个对象类型信息的，挑几个看一下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>interface</span> <span style=color:#50fa7b>BeanDefinition</span> <span style=color:#8be9fd;font-style:italic>extends</span> AttributeAccessor<span style=color:#ff79c6>,</span> BeanMetadataElement <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 标准单例范围的范围标识符：“单例”。
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	String SCOPE_SINGLETON <span style=color:#ff79c6>=</span> ConfigurableBeanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>SCOPE_SINGLETON</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 标准原型范围的范围标识符：“原型”。
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>  	String SCOPE_PROTOTYPE <span style=color:#ff79c6>=</span> ConfigurableBeanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>SCOPE_PROTOTYPE</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ...
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 指定此 bean 定义的 bean 类名。
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 类名可以在 bean 工厂后期处理期间修改，通常用它的解析变体替换原始类名。
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setBeanClassName</span><span style=color:#ff79c6>(</span>@Nullable String beanClassName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 覆盖此 bean 的目标范围，指定一个新的范围名称
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setScope</span><span style=color:#ff79c6>(</span>@Nullable String scope<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//设置这个 bean 是否应该被延迟初始化。
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>//如果为 false ，则 bean 将在启动时由执行单例预初始化的 bean 工厂实例化。
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setLazyInit</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>boolean</span> lazyInit<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//返回此 bean 是否应该延迟初始化，即在启动时不急切地实例化。仅适用于单例 bean。
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#8be9fd>boolean</span> <span style=color:#50fa7b>isLazyInit</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ....
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>好了，对 BeanDefinition 的了解暂时到此。不再深入了。继续上面的<code> registerAnnotationConfigProcessors</code>方法：</p><p>第一行： <code>DefaultListableBeanFactory beanFactory = unwrapDefaultListableBeanFactory(registry);</code></p><p>进入方法后，发现没有做太多的是事情，就是把注册器的 beanFactory 包装一下，再返回。这里的 register 就是最开始 main 方法中的 <code>AnnotationConfigApplicationContext</code> 对象。</p><p>接着看下面：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>beanFactory <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getDependencyComparator</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>instanceof</span> AnnotationAwareOrderComparator<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setDependencyComparator</span><span style=color:#ff79c6>(</span>AnnotationAwareOrderComparator<span style=color:#ff79c6>.</span><span style=color:#50fa7b>INSTANCE</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getAutowireCandidateResolver</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>instanceof</span> ContextAnnotationAutowireCandidateResolver<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setAutowireCandidateResolver</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> ContextAnnotationAutowireCandidateResolver<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>对 beanFactory 添加 <code>依赖比较器</code> 和 <code>Autowire 候选解析器</code> 暂时不知道设么作用，跳过。继续：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Set<span style=color:#ff79c6>&lt;</span>BeanDefinitionHolder<span style=color:#ff79c6>&gt;</span> beanDefs <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> LinkedHashSet<span style=color:#ff79c6>&lt;&gt;(</span><span style=color:#bd93f9>8</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>registry<span style=color:#ff79c6>.</span><span style=color:#50fa7b>containsBeanDefinition</span><span style=color:#ff79c6>(</span>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    RootBeanDefinition def <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> RootBeanDefinition<span style=color:#ff79c6>(</span>ConfigurationClassPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    def<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setSource</span><span style=color:#ff79c6>(</span>source<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    beanDefs<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>registerPostProcessor<span style=color:#ff79c6>(</span>registry<span style=color:#ff79c6>,</span> def<span style=color:#ff79c6>,</span> CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>先构造了一个 <code>BeanDefinitionHolder</code> 的集合，也就是这个方法要返回的集合，if 语句中， 判断注册器是否包含某个 BeanDefinition, 进去看一下怎么判断的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>   <span style=color:#6272a4>// 在 DefaultListableBeanFactory 类下面
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	@Override
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>boolean</span> <span style=color:#50fa7b>containsBeanDefinition</span><span style=color:#ff79c6>(</span>String beanName<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>		Assert<span style=color:#ff79c6>.</span><span style=color:#50fa7b>notNull</span><span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;Bean name must not be null&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>beanDefinitionMap</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>containsKey</span><span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>最终会进入 <code>DefaultListableBeanFactory</code> 类中的 <code>containsBeanDefinition</code> 方法，也就是说这个方法不是注册器提供的，而是它的 beanFactory 属性提供的。并且在 beanFactory 中有一个 <code>Map&lt;String, BeanDefinition> beanDefinitionMap</code>；通过名字就可以知道，存放的是 BeanDefinition, 判断注册器是否包已经包含某个 BeanDefinition, 就是看这个 map 是否包含相应的 key 了。这个功能是由它所辖的 beanFactory 实现的。这也比较符合常理： bean 工厂去管理 bean 定义。到这里就可以猜测出注册 bean 时，也是放入这个 Map, 取出 bean 时，也是从这个 Map 中获取。</p><p>再看一下传入的 key 是什么：<br><code>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME</code> 是写死在源码中的常量：<code>org.springframework.context.annotation.internalConfigurationAnnotationProcessor</code> 某个类的全名称。继续向下看</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>RootBeanDefinition def <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> RootBeanDefinition<span style=color:#ff79c6>(</span>ConfigurationClassPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>def<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setSource</span><span style=color:#ff79c6>(</span>source<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>beanDefs<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>registerPostProcessor<span style=color:#ff79c6>(</span>registry<span style=color:#ff79c6>,</span> def<span style=color:#ff79c6>,</span> CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME<span style=color:#ff79c6>));</span>
</span></span></code></pre></div><p>将 <code>ConfigurationClassPostProcessor.class</code> 作为参数，构造了一个 RootBeanDefinition , 查看类关系，发现 RootBeanDefinition 是 BeanDefinition 的一个实现类。这里只需明白把一个 class 转成了 BeanDefinition 就行了。至于怎么转的，可以自行查看</p><p><code>def.setSource(source)</code> 刚刚说过 source 参数是 null, 先跳过。不深究它是什么意思。</p><p>再看 <code>registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)</code> 这一行，方法名是 <code>注册后置处理器</code>， 把注册器，BeanDefinition, 和 类全名作为参数传入方法，再一路跟踪下去发现最后还是进入了 DefaultListableBeanFactory 类。执行的是 <code>registerBeanDefinition</code> 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Override
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>registerBeanDefinition</span><span style=color:#ff79c6>(</span>String beanName<span style=color:#ff79c6>,</span> BeanDefinition beanDefinition<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>throws</span> BeanDefinitionStoreException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Assert<span style=color:#ff79c6>.</span><span style=color:#50fa7b>hasText</span><span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;Bean name must not be empty&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    Assert<span style=color:#ff79c6>.</span><span style=color:#50fa7b>notNull</span><span style=color:#ff79c6>(</span>beanDefinition<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;BeanDefinition must not be null&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 省略很多校验性代码
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    BeanDefinition existingDefinition <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>beanDefinitionMap</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>get</span><span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>existingDefinition <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 省略很多校验性代码
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>beanDefinitionMap</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>,</span> beanDefinition<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 检查这个工厂的 bean 创建阶段是否已经开始，即在此期间是否有任何 bean 被标记为已创建。
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>hasBeanCreationStarted<span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>//... 省略暂不会执行的代码
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Still in startup registration phase: 仍处于启动注册阶段
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// beanName 作为 key, beanDefinition 是 value, 这些都是参数传入的
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>beanDefinitionMap</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>,</span> beanDefinition<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// bean 工厂还维护了所有的 beanName，有序的
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>beanDefinitionNames</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 不懂，先跳过
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>manualSingletonNames</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>remove</span><span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 不懂。先跳过
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>frozenBeanDefinitionNames</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 省略后置代码，先跳过
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>从上面代码可知，注册 BeanDefinition 也是有注册器的 beanFactory 实现的。还记得 <code>AnnotatedBeanDefinitionReader</code> 这个类的注释说道：<code>用于注解 bean 类的编程注册。这是 ClassPathBeanDefinitionScanner 的替代方案，应用相同的注解，但仅适用于显式注册的类</code>. <strong>显示注册</strong> 就是手动把事先定义好的类添加到 beanDefinitionMap。 那么猜测一下 <code>ClassPathBeanDefinitionScanner</code> 是不是自动扫描我们系统自定义的类，然后把我们自定义类自动添加到 beanDefinitionMap 中的。比如被 @Service @Controller @Bean 修饰的类。我们使用 Spring 时，可没有把这些类向 bean 工厂手动注册</p><p>这个方法的后面还注册了很多其他内置的类。就不一一罗列了。之后这个方法就结束了。</p><p>总结一下 <code>this.reader = new AnnotatedBeanDefinitionReader(this);</code> 都干了哪些事情：</p><ol><li>new 一个 <code>AnnotatedBeanDefinitionReader</code> Bean 定义读取类</li><li>在 new 的过程中，把 spring 内置的各种类注册到 beanDefinitionMap 中。</li></ol><p>从这个方法中我们可以知道：</p><ol><li>AnnotationConfigApplicationContext 中有 AnnotatedBeanDefinitionReader 类型的属性</li><li>BeanDefinition 是用来描述各种 bean 的类，类似建筑图纸和建筑物的关系</li><li>BeanDefinitionHolder 只是 BeanDefinition 的持有者，相当于为 BeanDefinition 增加了名称和别名</li><li>AnnotationConfigApplicationContext 中有 beanFactory, beanDefinition 的注册都是由 beanFactory 完成的。</li><li>BeanFactory 中有 beanDefinitionMap, 用来存放 beanDefinition.</li><li>BeanFactory 中还有 beanDefinitionNames, 存放所有的 beanDefinition 的名称</li></ol><p>目前为止我们只知道向注册器中注册了一堆内置的类。还没有看到这些类的用法， 大胆猜测一下，这些内置类是一些创世纪的类，后面用到的类扫描，属性注入，切面等，可能都是由这些类实现的。</p><h2 id=初始化-classpathbeandefinitionscanner>初始化 ClassPathBeanDefinitionScanner</h2><p>这里主要是初始化一个扫描器，扫描器的作用就是把某个路径下的 class 文件加载 jvm 中，然后找到这些类中可以使用的 Bean, 把这些 bean 注册进来。</p><p>初始化 reader 后，接着就是初始化 scanner 字段了：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>scanner</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ClassPathBeanDefinitionScanner<span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>);</span>
</span></span></code></pre></div><p>一层层进入方法后，会到达这个地方：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>ClassPathBeanDefinitionScanner</span><span style=color:#ff79c6>(</span>BeanDefinitionRegistry registry<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>boolean</span> useDefaultFilters<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span>        Environment environment<span style=color:#ff79c6>,</span> @Nullable ResourceLoader resourceLoader<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Assert<span style=color:#ff79c6>.</span><span style=color:#50fa7b>notNull</span><span style=color:#ff79c6>(</span>registry<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;BeanDefinitionRegistry must not be null&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>registry</span> <span style=color:#ff79c6>=</span> registry<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>useDefaultFilters<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        registerDefaultFilters<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    setEnvironment<span style=color:#ff79c6>(</span>environment<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    setResourceLoader<span style=color:#ff79c6>(</span>resourceLoader<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>这是一个构造器，第一个参数是<code>register</code>, 和 reader 一样，是 AnnotationConfigApplicationContext 的对象，第二参数默认传的 true， 第三个参数是环境相关信息，第四个参数是一个 resourceLoader, 这里传入的也是 AnnotationConfigApplicationContext.</p><p>其中 <code>registerDefaultFilters();</code> 是一个默认的过滤器，其方法实现是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>registerDefaultFilters</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 首先把 Component 注解加入
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>includeFilters</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> AnnotationTypeFilter<span style=color:#ff79c6>(</span>Component<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 获取类加载器
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    ClassLoader cl <span style=color:#ff79c6>=</span> ClassPathScanningCandidateComponentProvider<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClassLoader</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 想把 javax.annotation.ManagedBean 加载到 jvm 中，如果系统中没有这个包，就会异常
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>includeFilters</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> AnnotationTypeFilter<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>((</span>Class<span style=color:#ff79c6>&lt;?</span> <span style=color:#8be9fd;font-style:italic>extends</span> Annotation<span style=color:#ff79c6>&gt;)</span> ClassUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;javax.annotation.ManagedBean&#34;</span><span style=color:#ff79c6>,</span> cl<span style=color:#ff79c6>)),</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        logger<span style=color:#ff79c6>.</span><span style=color:#50fa7b>debug</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;JSR-250 &#39;javax.annotation.ManagedBean&#39; found and supported for component scanning&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>ClassNotFoundException ex<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// JSR-250 1.1 API (as included in Java EE 6) not available - simply skip.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 想把 javax.inject.Named 加载到 jvm 中，如果系统中没有这个包，就会异常
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>includeFilters</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span><span style=color:#ff79c6>new</span> AnnotationTypeFilter<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>((</span>Class<span style=color:#ff79c6>&lt;?</span> <span style=color:#8be9fd;font-style:italic>extends</span> Annotation<span style=color:#ff79c6>&gt;)</span> ClassUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forName</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;javax.inject.Named&#34;</span><span style=color:#ff79c6>,</span> cl<span style=color:#ff79c6>)),</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        logger<span style=color:#ff79c6>.</span><span style=color:#50fa7b>debug</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;JSR-330 &#39;javax.inject.Named&#39; annotation found and supported for component scanning&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>ClassNotFoundException ex<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// JSR-330 API not available - simply skip.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>这个方法想把 @Component 、@ManagedBean、 @Named 注解加入过滤器中，但是由于系统没有后面两个包，会走到异常处理块。所以过滤器中只会有 @Component.</p><p>然后下面就是为扫描器设置环境信息，和资源加载信息了。这时候并没有开始扫描包。只是完成了扫描器的初始化。到此我们可以知道扫描器 scanner 中有下面几个属性：</p><ol><li>默认过滤器，用来判断哪些 bean 应该注册到工厂中</li><li>一些环境信息。暂时不深究</li><li>资源加载器</li></ol><p>猜测应该是使用资源加载器把某个包下的所有 class 加载到 jvm 中，然后根据反射遍历每个 class 的信息，看看类上的注解是否在默认的过滤器中，如果在就注册到 bean 工厂中。 我们还需要了解一下资源加载器是什么？</p><h3 id=resourceloader>ResourceLoader</h3><p>进入 <code>setResourceLoader</code> 方法，最后会进入 <code>PathMatchingResourcePatternResolver</code> 类。这个类的根是 ResourceLoader. 进入这个接口看一下他都有哪些方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>interface</span> <span style=color:#50fa7b>ResourceLoader</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/** Pseudo URL prefix for loading from the class path: &#34;classpath:&#34; */</span>
</span></span><span style=display:flex><span>	String CLASSPATH_URL_PREFIX <span style=color:#ff79c6>=</span> ResourceUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>CLASSPATH_URL_PREFIX</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>	Resource <span style=color:#50fa7b>getResource</span><span style=color:#ff79c6>(</span>String location<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	@Nullable
</span></span><span style=display:flex><span>	ClassLoader <span style=color:#50fa7b>getClassLoader</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>就只有两个方法，到这里就比较明显了，不同的 ResourceLoader 实现类都会实现特定的 getResource 方法，功能就是根据一个位置，获取一个 Resource. 进入 Resource 类中可知，里面有很多和文件相关的方法。它保存着一个文件的详细信息，比如 文件所在的路径，文件的 File 对象等等。可以理解为 ResourceLoader 把某个路径的下的 class 文件封装成了 Resource 对象。</p><p>而 PathMatchingResourcePatternResolver 正是 ResourceLoader 的一个实现，从这个类的注释可知它能够将指定的资源位置路径解析为一个或多个匹配的资源。源路径可以是与目标 Resource 一对一映射的简单路径，或者可以包含特殊的“ classpath*: ”前缀和/或内部 Ant 样式的正则表达式</p><p>到这里已经知道 ResourceLoader 是什么了，暂不向下深究了。</p><p>已经浏览完 AnnotationConfigApplicationContext 无参构造器中的功能了。接着往下看：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>AnnotationConfigApplicationContext</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>&lt;?&gt;...</span> annotatedClasses<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>();</span> <span style=color:#6272a4>// 结束了
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    register<span style=color:#ff79c6>(</span>annotatedClasses<span style=color:#ff79c6>);</span> <span style=color:#6272a4>// 该它了
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    refresh<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>通过 <code>this()</code> 这个构造方法，注册器 AnnotationConfigApplicationContext 中有了 reader, scanner, bean 工厂中有了一些内置类的 beanDefinition. scanner 中有了资源加载器。</p><h2 id=注册配置类>注册配置类</h2><p>进入 <code>register(annotatedClasses)</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>register</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>&lt;?&gt;...</span> annotatedClasses<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    Assert<span style=color:#ff79c6>.</span><span style=color:#50fa7b>notEmpty</span><span style=color:#ff79c6>(</span>annotatedClasses<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;At least one annotated class must be specified&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 使用 reader 注册配置类
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>reader</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>register</span><span style=color:#ff79c6>(</span>annotatedClasses<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>上面已经说过，reader 是用来显式注册 beanDefinition 的。这里还是指定一个具体的 class 来注册，属于显式注册，所以用 reader 中的注册方法，没毛病。进入方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>//从给定的 bean 类注册一个 bean，从类声明的注释中派生其元数据。
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span><span style=color:#6272a4>//参数：
</span></span></span><span style=display:flex><span><span style=color:#6272a4>//annotatedClass – bean 的类
</span></span></span><span style=display:flex><span><span style=color:#6272a4>//instanceSupplier – 创建 bean 实例的回调（可能为 null ）
</span></span></span><span style=display:flex><span><span style=color:#6272a4>//name – bean 的显式名称
</span></span></span><span style=display:flex><span><span style=color:#6272a4>//qualifiers – 除了 bean 类级别的限定符之外，要考虑的特定限定符注释（如果有）
</span></span></span><span style=display:flex><span><span style=color:#6272a4>//definitionCustomizers – 一个或多个用于自定义工厂 BeanDefinition 的回调，例如设置惰性初始化或主标志
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>doRegisterBean</span><span style=color:#ff79c6>(</span>Class<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> annotatedClass<span style=color:#ff79c6>,</span> @Nullable Supplier<span style=color:#ff79c6>&lt;</span>T<span style=color:#ff79c6>&gt;</span> instanceSupplier<span style=color:#ff79c6>,</span> @Nullable String name<span style=color:#ff79c6>,</span>
</span></span><span style=display:flex><span>        @Nullable Class<span style=color:#ff79c6>&lt;?</span> <span style=color:#8be9fd;font-style:italic>extends</span> Annotation<span style=color:#ff79c6>&gt;[]</span> qualifiers<span style=color:#ff79c6>,</span> BeanDefinitionCustomizer<span style=color:#ff79c6>...</span> definitionCustomizers<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// 把 class 转换成一个 BeanDefinition, 而这个 BeanDefinition 还保留了注解信息
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    AnnotatedGenericBeanDefinition abd <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> AnnotatedGenericBeanDefinition<span style=color:#ff79c6>(</span>annotatedClass<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 如果这个类有 @Condition 注解，那么就会判断是否应该跳过
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>conditionEvaluator</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>shouldSkip</span><span style=color:#ff79c6>(</span>abd<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getMetadata</span><span style=color:#ff79c6>()))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 省略。...
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 注册 BeanDefinition
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    BeanDefinitionReaderUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>registerBeanDefinition</span><span style=color:#ff79c6>(</span>definitionHolder<span style=color:#ff79c6>,</span> <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>registry</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>这里已经把配置类注册到工厂中了。 这里仅仅是把系统中的配置类进行注册，并没有开始扫描配置类中的代码。接下来就是 refresh 方法了：</p><h2 id=refresh>refresh</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Override
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>refresh</span><span style=color:#ff79c6>()</span> <span style=color:#8be9fd;font-style:italic>throws</span> BeansException<span style=color:#ff79c6>,</span> IllegalStateException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>synchronized</span> <span style=color:#ff79c6>(</span><span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>startupShutdownMonitor</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 刷新前做一些准备，记录开始时间等
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        prepareRefresh<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 获取 bean 工厂
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        ConfigurableListableBeanFactory beanFactory <span style=color:#ff79c6>=</span> obtainFreshBeanFactory<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 对 bean 工厂做一些预处理、先不展开
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        prepareBeanFactory<span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 这个类是一个模板方法，给子类留了一个接口，可以做一些事情
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// 当前类并没有做什么事情 是一个空方法
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            postProcessBeanFactory<span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Invoke factory processors registered as beans in the context.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// 调用 bean 工厂中所有 实现了 BeanFactoryPostProcessor 和
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// BeanDefinitionRegistryPostProcessor 接口的 bean 的 postProcessBeanFactory 方法，或者 postProcessBeanDefinitionRegistry 方法，
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            invokeBeanFactoryPostProcessors<span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Register bean processors that intercept bean creation.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            registerBeanPostProcessors<span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Initialize message source for this context.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            initMessageSource<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Initialize event multicaster for this context.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            initApplicationEventMulticaster<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Initialize other special beans in specific context subclasses.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            onRefresh<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Check for listener beans and register them.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            registerListeners<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Instantiate all remaining (non-lazy-init) singletons.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            finishBeanFactoryInitialization<span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Last step: publish corresponding event.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            finishRefresh<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>BeansException ex<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>logger<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isWarnEnabled</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                logger<span style=color:#ff79c6>.</span><span style=color:#50fa7b>warn</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;Exception encountered during context initialization - &#34;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>                        <span style=color:#f1fa8c>&#34;cancelling refresh attempt: &#34;</span> <span style=color:#ff79c6>+</span> ex<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Destroy already created singletons to avoid dangling resources.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            destroyBeans<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Reset &#39;active&#39; flag.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            cancelRefresh<span style=color:#ff79c6>(</span>ex<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Propagate exception to caller.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>throw</span> ex<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>finally</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// Reset common introspection caches in Spring&#39;s core, since we
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// might not ever need metadata for singleton beans anymore...
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            resetCommonCaches<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h3 id=invokebeanfactorypostprocessors>invokeBeanFactoryPostProcessors</h3><p>进入 <code>invokeBeanFactoryPostProcessors(beanFactory)</code> ：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>// 第一个参数 bean 工厂
</span></span></span><span style=display:flex><span><span style=color:#6272a4>// 第二参数是 BeanFactoryPostProcessor 的实现类。 这里是空集合
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>invokeBeanFactoryPostProcessors</span><span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>        ConfigurableListableBeanFactory beanFactory<span style=color:#ff79c6>,</span> List<span style=color:#ff79c6>&lt;</span>BeanFactoryPostProcessor<span style=color:#ff79c6>&gt;</span> beanFactoryPostProcessors<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Invoke BeanDefinitionRegistryPostProcessors first, if any.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    Set<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> processedBeans <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashSet<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>beanFactory <span style=color:#ff79c6>instanceof</span> BeanDefinitionRegistry<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        BeanDefinitionRegistry registry <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>BeanDefinitionRegistry<span style=color:#ff79c6>)</span> beanFactory<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>BeanFactoryPostProcessor<span style=color:#ff79c6>&gt;</span> regularPostProcessors <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span><span style=display:flex><span>        List<span style=color:#ff79c6>&lt;</span>BeanDefinitionRegistryPostProcessor<span style=color:#ff79c6>&gt;</span> registryProcessors <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 这个集合是空的，不会走这个循环 .. 省略
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>BeanFactoryPostProcessor postProcessor <span style=color:#ff79c6>:</span> beanFactoryPostProcessors<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// .... 省略了
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Do not initialize FactoryBeans here: We need to leave all regular beans
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// uninitialized to let the bean factory post-processors apply to them!
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// Separate between BeanDefinitionRegistryPostProcessors that implement
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// PriorityOrdered, Ordered, and the rest.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        List<span style=color:#ff79c6>&lt;</span>BeanDefinitionRegistryPostProcessor<span style=color:#ff79c6>&gt;</span> currentRegistryProcessors <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 这里是个重点，通过 bean 工厂获取所有类型为 BeanDefinitionRegistryPostProcessor
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 的 bean， 也就是说只要 bean 实现了这个接口，都会被获取到
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        String<span style=color:#ff79c6>[]</span> postProcessorNames <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span>                beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBeanNamesForType</span><span style=color:#ff79c6>(</span>BeanDefinitionRegistryPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 遍历所有的 BeanDefinitionRegistryPostProcessor 类型的 bean
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>String ppName <span style=color:#ff79c6>:</span> postProcessorNames<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 如果这个 bean 还实现了 PriorityOrdered 接口
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isTypeMatch</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>,</span> PriorityOrdered<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 把这个 bean 单独放到 currentRegistryProcessors 集合中
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                <span style=color:#6272a4>// 注意看这里，已经使用 getBean 方法，把该 BeanDefinition 进行实例化了
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                <span style=color:#6272a4>// 实例化 bean 时还要遵循 bean 的生命周期。下面会讲到
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                currentRegistryProcessors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBean</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>,</span> BeanDefinitionRegistryPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 同时把 bean 添加到 processedBeans 集合中
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                processedBeans<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 把这些有优先级的 bean 排序
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        sortPostProcessors<span style=color:#ff79c6>(</span>currentRegistryProcessors<span style=color:#ff79c6>,</span> beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        registryProcessors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addAll</span><span style=color:#ff79c6>(</span>currentRegistryProcessors<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 先调用这些有优先级的 bean 中的 postProcessBeanDefinitionRegistry 方法
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        invokeBeanDefinitionRegistryPostProcessors<span style=color:#ff79c6>(</span>currentRegistryProcessors<span style=color:#ff79c6>,</span> registry<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 清空有优先 bean 集合，注意 registryProcessors 并没有清空
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        currentRegistryProcessors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>clear</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 再一次获取 获取所有类型为 BeanDefinitionRegistryPostProcessor
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 的 bean， 因为上面执行了 postProcessBeanDefinitionRegistry 方法
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 可能有新的 bean 被注册
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        postProcessorNames <span style=color:#ff79c6>=</span> beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBeanNamesForType</span><span style=color:#ff79c6>(</span>BeanDefinitionRegistryPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 遍历
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>String ppName <span style=color:#ff79c6>:</span> postProcessorNames<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 如果没有在集合中，并且属于 Ordered 类型，也就是说 bean 还实现了 Ordered 接口
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>processedBeans<span style=color:#ff79c6>.</span><span style=color:#50fa7b>contains</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&amp;&amp;</span> beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isTypeMatch</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>,</span> Ordered<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 把有排序的 bean 加入 currentRegistryProcessors 集合
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                currentRegistryProcessors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBean</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>,</span> BeanDefinitionRegistryPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 同时加入 processedBeans 集合
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                processedBeans<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 排序
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        sortPostProcessors<span style=color:#ff79c6>(</span>currentRegistryProcessors<span style=color:#ff79c6>,</span> beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        registryProcessors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addAll</span><span style=color:#ff79c6>(</span>currentRegistryProcessors<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 再调用这些有排序的 bean 中的 postProcessBeanDefinitionRegistry 方法
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        invokeBeanDefinitionRegistryPostProcessors<span style=color:#ff79c6>(</span>currentRegistryProcessors<span style=color:#ff79c6>,</span> registry<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 清空
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        currentRegistryProcessors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>clear</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 同上，继续查找普通的 BeanDefinitionRegistryPostProcessor 的 bean. 直到没有出现新的了
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#8be9fd>boolean</span> reiterate <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>while</span> <span style=color:#ff79c6>(</span>reiterate<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            reiterate <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>            postProcessorNames <span style=color:#ff79c6>=</span> beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBeanNamesForType</span><span style=color:#ff79c6>(</span>BeanDefinitionRegistryPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>String ppName <span style=color:#ff79c6>:</span> postProcessorNames<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>processedBeans<span style=color:#ff79c6>.</span><span style=color:#50fa7b>contains</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                    currentRegistryProcessors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBean</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>,</span> BeanDefinitionRegistryPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>                    processedBeans<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>                    <span style=color:#6272a4>// 还有新的 bean 被加入，就不能终止，可能因为这个新的 bean 会引入更多的 bean
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                    reiterate <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>            sortPostProcessors<span style=color:#ff79c6>(</span>currentRegistryProcessors<span style=color:#ff79c6>,</span> beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            registryProcessors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>addAll</span><span style=color:#ff79c6>(</span>currentRegistryProcessors<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            invokeBeanDefinitionRegistryPostProcessors<span style=color:#ff79c6>(</span>currentRegistryProcessors<span style=color:#ff79c6>,</span> registry<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            currentRegistryProcessors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>clear</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Now, invoke the postProcessBeanFactory callback of all processors handled so far.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        invokeBeanFactoryPostProcessors<span style=color:#ff79c6>(</span>registryProcessors<span style=color:#ff79c6>,</span> beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        invokeBeanFactoryPostProcessors<span style=color:#ff79c6>(</span>regularPostProcessors<span style=color:#ff79c6>,</span> beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Invoke factory processors registered with the context instance.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        invokeBeanFactoryPostProcessors<span style=color:#ff79c6>(</span>beanFactoryPostProcessors<span style=color:#ff79c6>,</span> beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 所有 BeanDefinitionRegistryPostProcessor 类型的 bean 的 postProcessBeanDefinitionRegistry  放法执行完后
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 再执行所有 BeanFactoryPostProcessor 类型的 bean 的 postProcessBeanFactory 方法
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Do not initialize FactoryBeans here: We need to leave all regular beans
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// uninitialized to let the bean factory post-processors apply to them!
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 获取所有 BeanFactoryPostProcessor 类型的 bean
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 因为 BeanDefinitionRegistryPostProcessor 继承了 BeanFactoryPostProcessor
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 所以这里还会获取到所有 BeanDefinitionRegistryPostProcessor 的 bean
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 当然这些 bean 已经处理过了，下面会跳过已经处理过的 bean
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    String<span style=color:#ff79c6>[]</span> postProcessorNames <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span>            beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBeanNamesForType</span><span style=color:#ff79c6>(</span>BeanFactoryPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>true</span><span style=color:#ff79c6>,</span> <span style=color:#ff79c6>false</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// Ordered, and the rest.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 同上，分别获取有优先级的，有排序的，普通的 bean
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 然后调用他们的 postProcessBeanFactory 方法
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    List<span style=color:#ff79c6>&lt;</span>BeanFactoryPostProcessor<span style=color:#ff79c6>&gt;</span> priorityOrderedPostProcessors <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> orderedPostProcessorNames <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    List<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> nonOrderedPostProcessorNames <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>String ppName <span style=color:#ff79c6>:</span> postProcessorNames<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 跳过已经处理过的 bean
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>processedBeans<span style=color:#ff79c6>.</span><span style=color:#50fa7b>contains</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// skip - already processed in first phase above
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 优先级
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isTypeMatch</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>,</span> PriorityOrdered<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            priorityOrderedPostProcessors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBean</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>,</span> BeanFactoryPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 有排序
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isTypeMatch</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>,</span> Ordered<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            orderedPostProcessorNames<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 普通的 bean
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            nonOrderedPostProcessorNames<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>ppName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    sortPostProcessors<span style=color:#ff79c6>(</span>priorityOrderedPostProcessors<span style=color:#ff79c6>,</span> beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    invokeBeanFactoryPostProcessors<span style=color:#ff79c6>(</span>priorityOrderedPostProcessors<span style=color:#ff79c6>,</span> beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Next, invoke the BeanFactoryPostProcessors that implement Ordered.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    List<span style=color:#ff79c6>&lt;</span>BeanFactoryPostProcessor<span style=color:#ff79c6>&gt;</span> orderedPostProcessors <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>String postProcessorName <span style=color:#ff79c6>:</span> orderedPostProcessorNames<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        orderedPostProcessors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBean</span><span style=color:#ff79c6>(</span>postProcessorName<span style=color:#ff79c6>,</span> BeanFactoryPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    sortPostProcessors<span style=color:#ff79c6>(</span>orderedPostProcessors<span style=color:#ff79c6>,</span> beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    invokeBeanFactoryPostProcessors<span style=color:#ff79c6>(</span>orderedPostProcessors<span style=color:#ff79c6>,</span> beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Finally, invoke all other BeanFactoryPostProcessors.
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    List<span style=color:#ff79c6>&lt;</span>BeanFactoryPostProcessor<span style=color:#ff79c6>&gt;</span> nonOrderedPostProcessors <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> ArrayList<span style=color:#ff79c6>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>String postProcessorName <span style=color:#ff79c6>:</span> nonOrderedPostProcessorNames<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        nonOrderedPostProcessors<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getBean</span><span style=color:#ff79c6>(</span>postProcessorName<span style=color:#ff79c6>,</span> BeanFactoryPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    invokeBeanFactoryPostProcessors<span style=color:#ff79c6>(</span>nonOrderedPostProcessors<span style=color:#ff79c6>,</span> beanFactory<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Clear cached merged bean definitions since the post-processors might have
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// modified the original metadata, e.g. replacing placeholders in values...
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    beanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>clearMetadataCache</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>refresh 方法中的 <code>invokeBeanFactoryPostProcessors()</code> 作用是：</p><ol><li>找到所有实现了 BeanDefinitionRegistryPostProcessor 接口的 bean，然后调用他们的 postProcessBeanDefinitionRegistry 方法。</li><li>找到所有实现了 BeanFactoryPostProcessor 接口的 bean，然后调用他们的 postProcessBeanFactory 方法。</li></ol><p>还记得在初始化 reader 时，注册了很多内置类到 bean 工厂中吗？其中第一个注册的就是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(!</span>registry<span style=color:#ff79c6>.</span><span style=color:#50fa7b>containsBeanDefinition</span><span style=color:#ff79c6>(</span>CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    RootBeanDefinition def <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> RootBeanDefinition<span style=color:#ff79c6>(</span>ConfigurationClassPostProcessor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    def<span style=color:#ff79c6>.</span><span style=color:#50fa7b>setSource</span><span style=color:#ff79c6>(</span>source<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    beanDefs<span style=color:#ff79c6>.</span><span style=color:#50fa7b>add</span><span style=color:#ff79c6>(</span>registerPostProcessor<span style=color:#ff79c6>(</span>registry<span style=color:#ff79c6>,</span> def<span style=color:#ff79c6>,</span> CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME<span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>而 <code>ConfigurationClassPostProcessor</code> 正是实现了 BeanDefinitionRegistryPostProcessor 接口，所以会调用这个类的 postProcessBeanDefinitionRegistry 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4>* Build and validate a configuration model based on the registry of
</span></span></span><span style=display:flex><span><span style=color:#6272a4>* {@link Configuration} classes.
</span></span></span><span style=display:flex><span><span style=color:#6272a4>*/</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>processConfigBeanDefinitions</span><span style=color:#ff79c6>(</span>BeanDefinitionRegistry registry<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span><span style=color:#6272a4>//....
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>翻译一下注释：</p><blockquote><p>基于 Configuration 类的注册表构建和验证配置模型。</p></blockquote><p>也就是说这个方法会解析我们传入的配置类，如果配置类上有 @ComponentScan 注解，还会扫描给定的包下的所有 class, 找到所有需要注册的 bean. 也就是在这里会把系统中我们定义的 bean 注册成 BeanDefinition 到工厂中。具体的扫描动作在 ClassPathBeanDefinitionScanner 类中的 doScan() 方法：<br><img src=https://raw.githubusercontent.com/dccmmtop/notebook/master/images/2022-11-10-11-20-54.png alt></p><p><img src=https://raw.githubusercontent.com/dccmmtop/notebook/master/images/2022-11-10-11-24-58.png alt></p><h4 id=beanfactorypostprocessor>BeanFactoryPostProcessor</h4><p>上面我们说了。 spring IoC 容器在加载过程中会找到所有实现了 BeanFactoryPostProcessor 接口的 bean，然后调用他们的 postProcessBeanFactory 方法。而这个时机是在 bean 定义注册到工厂之后，bean 实例生成之前。所以如果我们自己的 bean 想在 bean 通过 bean 工厂做一些事情的时候，可以实现这个接口，做一些特殊的操作：下面是对加密的配置进行解密，</p><p>数据库配置：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span>mysql.host=127.0.0.1
</span></span><span style=display:flex><span>mysql.port=13306
</span></span><span style=display:flex><span><span style=color:#6272a4># 密码是加密的</span>
</span></span><span style=display:flex><span>mysql.password=SM@jfajoadajdfa
</span></span></code></pre></div><p>代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>ContxtDemo</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        AnnotationConfigApplicationContext context <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> AnnotationConfigApplicationContext<span style=color:#ff79c6>(</span>Config<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 获取解密后的密码
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span>context<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getEnvironment</span><span style=color:#ff79c6>().</span><span style=color:#50fa7b>getProperty</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;mysql.password&#34;</span><span style=color:#ff79c6>));</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Configuration
</span></span><span style=display:flex><span>@ComponentScan<span style=color:#ff79c6>(</span>basePackageClasses <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>{</span>Config<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>})</span>
</span></span><span style=display:flex><span>@PropertySource<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;classpath:/app.properties&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Config</span><span style=color:#ff79c6>{</span> <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * 还实现了 EnvironmentAware 接口，可以获得 Environment 信息
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span>@Component
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>DecryptConfig</span> <span style=color:#8be9fd;font-style:italic>implements</span> EnvironmentAware<span style=color:#ff79c6>,</span>BeanFactoryPostProcessor <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> ConfigurableEnvironment environment<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>postProcessBeanFactory</span><span style=color:#ff79c6>(</span>ConfigurableListableBeanFactory beanFactory<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> BeansException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        MutablePropertySources propertySources <span style=color:#ff79c6>=</span> environment<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getPropertySources</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 获取所有 PropertySource
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>org<span style=color:#ff79c6>.</span><span style=color:#50fa7b>springframework</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>core</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>env</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>PropertySource</span><span style=color:#ff79c6>&lt;?&gt;</span> propertySource <span style=color:#ff79c6>:</span> propertySources<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            Map<span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>,</span>String<span style=color:#ff79c6>&gt;</span> map <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>Map<span style=color:#ff79c6>)</span>propertySource<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getSource</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 遍历所有配置信息，
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#6272a4>// 如果值是 SM@ 开头的，说明是加密信息，需要解密
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>forEach</span><span style=color:#ff79c6>((</span>k<span style=color:#ff79c6>,</span>v<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>-&gt;</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>v<span style=color:#ff79c6>.</span><span style=color:#50fa7b>indexOf</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;SM@&#34;</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>==</span> <span style=color:#bd93f9>0</span><span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                    String ciphertext <span style=color:#ff79c6>=</span>  v<span style=color:#ff79c6>.</span><span style=color:#50fa7b>substring</span><span style=color:#ff79c6>(</span><span style=color:#bd93f9>3</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;解密后&#34;</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>                    map<span style=color:#ff79c6>.</span><span style=color:#50fa7b>put</span><span style=color:#ff79c6>(</span>k<span style=color:#ff79c6>,</span>ciphertext<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>});</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setEnvironment</span><span style=color:#ff79c6>(</span>Environment environment<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 得到环境信息
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>this</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>environment</span> <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>ConfigurableEnvironment<span style=color:#ff79c6>)</span>environment<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><strong>结果</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>jfajoadajdfa 解密后
</span></span></code></pre></div><h3 id=finishbeanfactoryinitializationbeanfactory>finishBeanFactoryInitialization(beanFactory);</h3><p>实例化剩余非懒加载的 bean, 为什么说是剩余的？ 因为在前面的 invokeBeanFactoryPostProcessors 方法中，可能有的 bean 已经调用 getBean() 方法进行实例化了。</p><p>这里会看到 bean 实例化过程会执行留给用户的扩展点。下面列出过程重要的步骤：</p><h4 id=1-实例化-bean>1. 实例化 bean</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>instanceWrapper <span style=color:#ff79c6>=</span> createBeanInstance<span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>,</span> mbd<span style=color:#ff79c6>,</span> args<span style=color:#ff79c6>);</span><span style=color:#6272a4>//创建 bean 的实例。核心
</span></span></span></code></pre></div><h4 id=2-填充属性>2. 填充属性</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>opulateBean<span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>,</span> mbd<span style=color:#ff79c6>,</span> instanceWrapper<span style=color:#ff79c6>);</span><span style=color:#6272a4>//填充属性，重要
</span></span></span></code></pre></div><h4 id=3-aware-系列接口的回调>3. Aware 系列接口的回调</h4><p>aware 系列接口的回调位于 initializeBean 中的 invokeAwareMethods 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> Object <span style=color:#50fa7b>initializeBean</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> String beanName<span style=color:#ff79c6>,</span> <span style=color:#8be9fd;font-style:italic>final</span> Object bean<span style=color:#ff79c6>,</span> @Nullable RootBeanDefinition mbd<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getSecurityManager</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        AccessController<span style=color:#ff79c6>.</span><span style=color:#50fa7b>doPrivileged</span><span style=color:#ff79c6>((</span>PrivilegedAction<span style=color:#ff79c6>&lt;</span>Object<span style=color:#ff79c6>&gt;)</span> <span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-&gt;</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            invokeAwareMethods<span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>,</span> bean<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>},</span> getAccessControlContext<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// aware 系列接口回调
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        invokeAwareMethods<span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>,</span> bean<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Object wrappedBean <span style=color:#ff79c6>=</span> bean<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mbd <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>mbd<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isSynthetic</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// BeanPostProcessor 方法回调
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        wrappedBean <span style=color:#ff79c6>=</span> applyBeanPostProcessorsBeforeInitialization<span style=color:#ff79c6>(</span>wrappedBean<span style=color:#ff79c6>,</span> beanName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// initMethods 方法回调
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        invokeInitMethods<span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>,</span> wrappedBean<span style=color:#ff79c6>,</span> mbd<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>Throwable ex<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> BeanCreationException<span style=color:#ff79c6>(</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>(</span>mbd <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>?</span> mbd<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getResourceDescription</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>),</span>
</span></span><span style=display:flex><span>                beanName<span style=color:#ff79c6>,</span> <span style=color:#f1fa8c>&#34;Invocation of init method failed&#34;</span><span style=color:#ff79c6>,</span> ex<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mbd <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>mbd<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isSynthetic</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// BeanPostProcessorsAfterInitialization 方法回调
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        wrappedBean <span style=color:#ff79c6>=</span> applyBeanPostProcessorsAfterInitialization<span style=color:#ff79c6>(</span>wrappedBean<span style=color:#ff79c6>,</span> beanName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> wrappedBean<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>下面是 aware 方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>invokeAwareMethods</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd;font-style:italic>final</span> String beanName<span style=color:#ff79c6>,</span> <span style=color:#8be9fd;font-style:italic>final</span> Object bean<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>bean <span style=color:#ff79c6>instanceof</span> Aware<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>bean <span style=color:#ff79c6>instanceof</span> BeanNameAware<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>((</span>BeanNameAware<span style=color:#ff79c6>)</span> bean<span style=color:#ff79c6>).</span><span style=color:#50fa7b>setBeanName</span><span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>bean <span style=color:#ff79c6>instanceof</span> BeanClassLoaderAware<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            ClassLoader bcl <span style=color:#ff79c6>=</span> getBeanClassLoader<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>bcl <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>((</span>BeanClassLoaderAware<span style=color:#ff79c6>)</span> bean<span style=color:#ff79c6>).</span><span style=color:#50fa7b>setBeanClassLoader</span><span style=color:#ff79c6>(</span>bcl<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>bean <span style=color:#ff79c6>instanceof</span> BeanFactoryAware<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>((</span>BeanFactoryAware<span style=color:#ff79c6>)</span> bean<span style=color:#ff79c6>).</span><span style=color:#50fa7b>setBeanFactory</span><span style=color:#ff79c6>(</span>AbstractAutowireCapableBeanFactory<span style=color:#ff79c6>.</span><span style=color:#50fa7b>this</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h4 id=4-postprocessbeforeinitialization>4. postProcessBeforeInitialization</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>applyBeanPostProcessorsBeforeInitialization</span><span style=color:#ff79c6>(</span>Object existingBean<span style=color:#ff79c6>,</span> String beanName<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>throws</span> BeansException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Object result <span style=color:#ff79c6>=</span> existingBean<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>BeanPostProcessor processor <span style=color:#ff79c6>:</span> getBeanPostProcessors<span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        Object current <span style=color:#ff79c6>=</span> processor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>postProcessBeforeInitialization</span><span style=color:#ff79c6>(</span>result<span style=color:#ff79c6>,</span> beanName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>current <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> result<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        result <span style=color:#ff79c6>=</span> current<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> result<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h4 id=5-afterpropertiesset-和-init-method>5. afterPropertiesSet 和 init-method</h4><p>在 invokeInitMethods 方法中又掉了两个回调方法：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>protected</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>invokeInitMethods</span><span style=color:#ff79c6>(</span>String beanName<span style=color:#ff79c6>,</span> <span style=color:#8be9fd;font-style:italic>final</span> Object bean<span style=color:#ff79c6>,</span> @Nullable RootBeanDefinition mbd<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>throws</span> Throwable <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>boolean</span> isInitializingBean <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>(</span>bean <span style=color:#ff79c6>instanceof</span> InitializingBean<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>isInitializingBean <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#ff79c6>(</span>mbd <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span>mbd<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isExternallyManagedInitMethod</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;afterPropertiesSet&#34;</span><span style=color:#ff79c6>)))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>logger<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isDebugEnabled</span><span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            logger<span style=color:#ff79c6>.</span><span style=color:#50fa7b>debug</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;Invoking afterPropertiesSet() on bean with name &#39;&#34;</span> <span style=color:#ff79c6>+</span> beanName <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;&#39;&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getSecurityManager</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>try</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                AccessController<span style=color:#ff79c6>.</span><span style=color:#50fa7b>doPrivileged</span><span style=color:#ff79c6>((</span>PrivilegedExceptionAction<span style=color:#ff79c6>&lt;</span>Object<span style=color:#ff79c6>&gt;)</span> <span style=color:#ff79c6>()</span> <span style=color:#ff79c6>-&gt;</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>((</span>InitializingBean<span style=color:#ff79c6>)</span> bean<span style=color:#ff79c6>).</span><span style=color:#50fa7b>afterPropertiesSet</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>},</span> getAccessControlContext<span style=color:#ff79c6>());</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>catch</span> <span style=color:#ff79c6>(</span>PrivilegedActionException pae<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>throw</span> pae<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getException</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 回调 afterPropertiesSet 方法
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            <span style=color:#ff79c6>((</span>InitializingBean<span style=color:#ff79c6>)</span> bean<span style=color:#ff79c6>).</span><span style=color:#50fa7b>afterPropertiesSet</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>mbd <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span> <span style=color:#ff79c6>&amp;&amp;</span> bean<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getClass</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>!=</span> NullBean<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        String initMethodName <span style=color:#ff79c6>=</span> mbd<span style=color:#ff79c6>.</span><span style=color:#50fa7b>getInitMethodName</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>StringUtils<span style=color:#ff79c6>.</span><span style=color:#50fa7b>hasLength</span><span style=color:#ff79c6>(</span>initMethodName<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>!(</span>isInitializingBean <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#f1fa8c>&#34;afterPropertiesSet&#34;</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>initMethodName<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>&amp;&amp;</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>!</span>mbd<span style=color:#ff79c6>.</span><span style=color:#50fa7b>isExternallyManagedInitMethod</span><span style=color:#ff79c6>(</span>initMethodName<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 回调 init 方法
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>            invokeCustomInitMethod<span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>,</span> bean<span style=color:#ff79c6>,</span> mbd<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h4 id=6-postprocessafterinitialization>6. postProcessAfterInitialization</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>applyBeanPostProcessorsAfterInitialization</span><span style=color:#ff79c6>(</span>Object existingBean<span style=color:#ff79c6>,</span> String beanName<span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>throws</span> BeansException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Object result <span style=color:#ff79c6>=</span> existingBean<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> <span style=color:#ff79c6>(</span>BeanPostProcessor processor <span style=color:#ff79c6>:</span> getBeanPostProcessors<span style=color:#ff79c6>())</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 回调 postProcessAfterInitialization 方法
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        Object current <span style=color:#ff79c6>=</span> processor<span style=color:#ff79c6>.</span><span style=color:#50fa7b>postProcessAfterInitialization</span><span style=color:#ff79c6>(</span>result<span style=color:#ff79c6>,</span> beanName<span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>current <span style=color:#ff79c6>==</span> <span style=color:#ff79c6>null</span><span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> result<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        result <span style=color:#ff79c6>=</span> current<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> result<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h3 id=spring-bean-的生命周期>Spring Bean 的生命周期</h3><ol><li>实例化 Bean 对象，这个时候 Bean 的对象是非常低级的，基本不能够被我们使用，因为连最基本的属性都没有设置，可以理解为 连 Autowired 注解都是没有解析的；</li><li>填充属性，当做完这一步，Bean 对象基本是完整的了，可以理解为 Autowired 注解已经解析完毕，依赖注入完成了；</li><li>如果 Bean 实现了 BeanNameAware 接口，则调用 setBeanName 方法；</li><li>如果 Bean 实现了 BeanClassLoaderAware 接口，则调用 setBeanClassLoader 方法；</li><li>如果 Bean 实现了 BeanFactoryAware 接口，则调用 setBeanFactory 方法；</li><li>调用 BeanPostProcessor 的 postProcessBeforeInitialization 方法；</li><li>如果 Bean 实现了 InitializingBean 接口，调用 afterPropertiesSet 方法；</li><li>如果 Bean 定义了 init-method 方法，则调用 Bean 的 init-method 方法；</li><li>调用 BeanPostProcessor 的 postProcessAfterInitialization 方法；当进行到这一步，Bean 已经被准备就绪了，一直停留在应用的<br>上下文中，直到被销毁；</li><li>如果应用的上下文被销毁了，如果 Bean 实现了 DisposableBean 接口，则调用 destroy 方法，如果 Bean 定义了 destory-method<br>声明了销毁方法也会被调用。</li></ol><p>写个程序验证一下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>ContxtDemo</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>main</span><span style=color:#ff79c6>(</span>String<span style=color:#ff79c6>[]</span> args<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        AnnotationConfigApplicationContext context <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> AnnotationConfigApplicationContext<span style=color:#ff79c6>(</span>Config<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Configuration
</span></span><span style=display:flex><span>@ComponentScan<span style=color:#ff79c6>(</span>basePackageClasses <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>{</span>Config<span style=color:#ff79c6>.</span><span style=color:#50fa7b>class</span><span style=color:#ff79c6>})</span>
</span></span><span style=display:flex><span>@PropertySource<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;classpath:/app.properties&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Config</span><span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Bean<span style=color:#ff79c6>(</span>initMethod <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;init&#34;</span><span style=color:#ff79c6>,</span> destroyMethod <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;des&#34;</span><span style=color:#ff79c6>,</span> name<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;car&#34;</span><span style=color:#ff79c6>)</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Car <span style=color:#50fa7b>car</span><span style=color:#ff79c6>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> Car<span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Car</span> <span style=color:#8be9fd;font-style:italic>implements</span> BeanPostProcessor<span style=color:#ff79c6>,</span> InitializingBean<span style=color:#ff79c6>,</span> BeanNameAware<span style=color:#ff79c6>,</span> BeanFactoryAware<span style=color:#ff79c6>,</span> BeanClassLoaderAware<span style=color:#ff79c6>,</span> DisposableBean <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> age<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#50fa7b>Car</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;构造方法&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>postProcessBeforeInitialization</span><span style=color:#ff79c6>(</span>Object bean<span style=color:#ff79c6>,</span> String beanName<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> BeansException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;tank&#34;</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;postProcessBeforeInitialization&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> bean<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>postProcessAfterInitialization</span><span style=color:#ff79c6>(</span>Object bean<span style=color:#ff79c6>,</span> String beanName<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> BeansException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;tank&#34;</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span>beanName<span style=color:#ff79c6>))</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>            System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;postProcessAfterInitialization&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> bean<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>afterPropertiesSet</span><span style=color:#ff79c6>()</span> <span style=color:#8be9fd;font-style:italic>throws</span> Exception <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;afterPropertiesSet&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setBeanClassLoader</span><span style=color:#ff79c6>(</span>ClassLoader classLoader<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;setBeanClassLoader&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setBeanFactory</span><span style=color:#ff79c6>(</span>BeanFactory beanFactory<span style=color:#ff79c6>)</span> <span style=color:#8be9fd;font-style:italic>throws</span> BeansException <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;setBeanFactory&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>setBeanName</span><span style=color:#ff79c6>(</span>String name<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;setBeanName&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Override
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>destroy</span><span style=color:#ff79c6>()</span> <span style=color:#8be9fd;font-style:italic>throws</span> Exception <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;destroy&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>init</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;initMe&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>des</span><span style=color:#ff79c6>()</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        System<span style=color:#ff79c6>.</span><span style=color:#50fa7b>out</span><span style=color:#ff79c6>.</span><span style=color:#50fa7b>println</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;desM&#34;</span><span style=color:#ff79c6>);</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>@Component
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>Tank</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p><strong>结果:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>构造方法
</span></span><span style=display:flex><span>setBeanName
</span></span><span style=display:flex><span>setBeanClassLoader
</span></span><span style=display:flex><span>setBeanFactory
</span></span><span style=display:flex><span>afterPropertiesSet
</span></span><span style=display:flex><span>initMe
</span></span><span style=display:flex><span>postProcessBeforeInitialization
</span></span><span style=display:flex><span>postProcessAfterInitialization
</span></span></code></pre></div><h3 id=heading></h3></div><footer class=article-footer><ul class=article-tag-list><li class=article-tag-list-item><a class=article-tag-list-link href=https://dccmmtop.github.io/%20tags/java>java</a></li><li class=article-tag-list-item><a class=article-tag-list-link href=https://dccmmtop.github.io/%20tags/spring>spring</a></li></ul></footer></div><nav id=article-nav><a href=../../posts/%E8%8E%B7%E5%8F%96%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E8%BF%9B%E7%A8%8B/ id=article-nav-newer class=article-nav-link-wrap><div class=article-nav-title><span>&lt;</span>&nbsp;
获取正在运行的进程</div></a><a href=../../posts/ioc%E6%80%9D%E6%83%B3%E8%AE%B2%E8%A7%A3%E5%92%8C%E5%AE%9E%E7%8E%B0/ id=article-nav-older class=article-nav-link-wrap><div class=article-nav-title>IoC 思想和实现&nbsp;<span>></span></div></a></nav></article></section><div><script src=https://utteranc.es/client.js repo=dccmmtop/dccmmtop.github.io issue-term=pathname label=Comment theme=github-light crossorigin=anonymous async></script></div><footer id=footer><div class=outer><div id=footer-info class=inner>&copy; 2023 dc<br>Powered by <a href=https://gohugo.io target=_blank>Hugo</a> with theme <a href=https://github.com/carsonip/hugo-theme-minos target=_blank>Minos</a></div></div><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin=anonymous></script>
<script>hljs.initHighlightingOnLoad()</script><script>document.getElementById("main-nav-toggle").addEventListener("click",function(){var e=document.getElementById("header");e.classList.contains("mobile-on")?e.classList.remove("mobile-on"):e.classList.add("mobile-on")})</script><style>#footer-info{line-height:1.4em;font-size:10px}.custom-blog-info{font-family:long cang,cursive;border-top:1px dashed #333;font-size:16px;margin-top:10px;padding-top:10px;line-height:1.4em}</style></footer></div></body></html>