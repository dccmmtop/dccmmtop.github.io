<!doctype html><html><head><title>ArrayList和CopyOnWriteArrayList // 超的博客</title><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta property="og:title" content="ArrayList和CopyOnWriteArrayList"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:locale" content="zh"><meta property="og:url" content="https://dccmmtop.github.io/posts/arraylist%E5%92%8Ccopyonwritearraylist/"><link rel=icon type=image/x-icon href=../../favicon.ico><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css integrity=sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js integrity=sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1 crossorigin=anonymous></script>
<script src=https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script>
<link href=https://dccmmtop.github.io/webfonts/ptserif/main.css rel=stylesheet type=text/css><link href=https://dccmmtop.github.io/webfonts/source-code-pro/main.css rel=stylesheet type=text/css><link rel=stylesheet href=https://dccmmtop.github.io/css/style.css><link rel=stylesheet href=https://dccmmtop.github.io/css/custom.css><link rel=stylesheet href=https://dccmmtop.github.io/css/copy-to-clipboard.css><script src=https://dccmmtop.github.io/js/fastsearch.js></script>
<script src=https://dccmmtop.github.io/js/fuse.js></script>
<script src=https://dccmmtop.github.io/js/custom.js></script>
<script src=https://dccmmtop.github.io/js/copy-to-clipboard.js></script><meta name=google-site-verification content="15Pa8fZ9IfDWw5gRPmi3YLNnHcciUc4a3Hv8cNKm-Ac"><meta name=generator content="Hugo 0.105.0"></head><body><div id=container><header id=header><div id=header-outer class=outer><div id=header-inner class=inner><a id=main-nav-toggle class=nav-icon href=javascript:;></a>
<a id=logo class=logo-text href=https://dccmmtop.github.io/>超的博客</a><nav id=main-nav><a class=main-nav-link href=../../posts/>文章</a>
<a class=main-nav-link href=../../tags/>标签</a>
<a class=main-nav-link href=../../about/>我</a>
<a class=main-nav-link id=search><input id=inputSearch placeholder=search><svg t="1634282825021" class="icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="2401" width="15" height="15"><path d="M1005.312 914.752 806.784 716.288A448 448 0 100 448a448 448 0 00716.288 358.784l198.4 198.4a64 64 0 1090.624-90.432zM448 767.936A320 320 0 11448 128a320 320 0 010 640z" fill="#262626" p-id="2402"/></svg></a></nav><nav id=sub-nav><div id=search-form-wrap></div></nav></div></div><div class="modal fade" id=exampleModal tabindex=-1 role=dialog aria-labelledby=exampleModalLabel aria-hidden=true><div class=modal-dialog role=document><div class=modal-content><div class=modal-header><h5 class=modal-title id=exampleModalLabel>搜索结果</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class="modal-body searchResults"></div></div></div></div></header><section id=main class=outer><article class="article article-type-post" itemscope itemprop=blogPost><div class=article-inner><header class=article-header><h1 class=article-title itemprop=name>ArrayList和CopyOnWriteArrayList</h1></header><div class=article-meta><a href=../../posts/arraylist%E5%92%8Ccopyonwritearraylist/ class=article-date><time datetime=2022-10-18T17:08:33.000+00:00 itemprop=datePublished>2022-10-18</time></a></div><div class=article-entry itemprop=articleBody><h1 id=arraylist>ArrayList</h1><h2 id=arraylist-的保护机制>ArrayList 的保护机制</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#ff79c6>for</span><span style=color:#ff79c6>(</span>String str <span style=color:#ff79c6>:</span> list<span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span><span style=color:#ff79c6>(</span>str<span style=color:#ff79c6>.</span><span style=color:#50fa7b>equals</span><span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;123&#34;</span><span style=color:#ff79c6>)){</span>
</span></span><span style=display:flex><span>        list<span style=color:#ff79c6>.</span><span style=color:#50fa7b>remove</span><span style=color:#ff79c6>(</span>str<span style=color:#ff79c6>);</span>   <span style=color:#6272a4>//抛出异常
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>这里的 <code>foreach</code> 语法糖实际上调用了 ArrayList 的迭代器类。如下：
<img src=https://raw.githubusercontent.com/dccmmtop/notebook/master/images/Pasted%20image%2020221018171628.png alt></p><p>如果在开始迭代的时候数组中有 5 个元素，但是在迭代中移除了一个元素，数组实际上还有 4 个元素，但是还是会遍历第五个元素，这就导致了下标越界错误，ArrayList 不允许这种异常发生。还有在多线程下场景下，一个线程遍历这个 ArrayList , 另一个线程移除数组中的某个元素，也会发生 <code>ConcurrentModificationException</code> 异常。</p><h2 id=fail-fast-机制>fail-Fast 机制</h2><p>这个机制就是 fail-Fast 机制，快速失败系统，通常设计用于停止有缺陷的过程，这是一种理念，在进行系统设计时优先考虑异常情况，一旦发生异常，直接停止并上报。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> <span style=color:#50fa7b>divide</span><span style=color:#ff79c6>(</span><span style=color:#8be9fd>int</span> divisor<span style=color:#ff79c6>,</span> <span style=color:#8be9fd>int</span> dividend<span style=color:#ff79c6>){</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> <span style=color:#ff79c6>(</span>dividend <span style=color:#ff79c6>==</span> 0<span style=color:#ff79c6>)</span> <span style=color:#ff79c6>{</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>throw</span> <span style=color:#ff79c6>new</span> RuntimeException<span style=color:#ff79c6>(</span><span style=color:#f1fa8c>&#34;被除数不能为 0&#34;</span><span style=color:#ff79c6>);</span>    <span style=color:#6272a4>//这里就是 fail-fast 的体现
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> divisor <span style=color:#ff79c6>/</span> dividend<span style=color:#ff79c6>;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h2 id=保护机制的实现原理>保护机制的实现原理</h2><p>在 ArrayList 中有一个成员变量： <code>modCount</code>, 它是从 <code>AbstractList</code> 继承来的， <code>modCount</code> 记录数组每次写操作的次数。当像数组增加或移除一个元素，其值加 1，初始值为 0，在开始遍历的时候，会记录当下数组的 <code>modCount</code> 值为 <code>expectedModCount</code>，遍历每个元素时都会比较 <code>modCount</code> 和 <code>expectedModCount</code> 两个值，如果不同，就会抛出异常，代表着在遍历的时候修改了数组。如下：
<img src=https://raw.githubusercontent.com/dccmmtop/notebook/master/images/Pasted%20image%2020221018173604.png alt></p><h2 id=怎么样才可以在循环中修改数组>怎么样才可以在循环中修改数组？</h2><p>如果我们每次向数组中添加或删除元素时，同步修改 <code>exceptedModCount</code> 就不会抛出异常了，ArrayList 没有直接提供这种方法，而是把这种方法委托给迭代器了：
<img src=https://raw.githubusercontent.com/dccmmtop/notebook/master/images/Pasted%20image%2020221018174601.png alt></p><p><img src=https://raw.githubusercontent.com/dccmmtop/notebook/master/images/Pasted%20image%2020221018174633.png alt></p><p>所以我们可以这样做：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Iterator <span style=color:#ff79c6>&lt;</span>String<span style=color:#ff79c6>&gt;</span> iterator <span style=color:#ff79c6>=</span> list<span style=color:#ff79c6>.</span><span style=color:#50fa7b>iterator</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>while</span><span style=color:#ff79c6>(</span>iterator<span style=color:#ff79c6>.</span><span style=color:#50fa7b>hasNext</span><span style=color:#ff79c6>()){</span>
</span></span><span style=display:flex><span>    String str <span style=color:#ff79c6>=</span> iterator<span style=color:#ff79c6>.</span><span style=color:#50fa7b>next</span><span style=color:#ff79c6>();</span>
</span></span><span style=display:flex><span>    iterator<span style=color:#ff79c6>.</span><span style=color:#50fa7b>remove</span><span style=color:#ff79c6>();</span>   <span style=color:#6272a4>//正确做法
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h1 id=copyonwritearraylist>CopyOnWriteArrayList</h1><p>CopyOnWriteArrayList 是 ArrayList 的线程安全版本，读取无锁，写时有锁。适用于 写少读多的场景，会有不一致的现象</p><h2 id=实现原理>实现原理</h2><p>见名知意—— 写时复制， 当线程在数组上移除，添加元素时，先加锁，将原数组复制一份，然后基于副本操作，最后将已经更改的副本覆盖元数组，释放锁。</p><p>其内部有一个 <code>ReentranLock</code> 来控制锁的获取和释放。</p><p>先看一下内部结构图：
<img src=https://raw.githubusercontent.com/dccmmtop/notebook/master/images/Pasted%20image%2020221018180738.png alt></p><h3 id=get-方法>get 方法</h3><p><img src=https://raw.githubusercontent.com/dccmmtop/notebook/master/images/Pasted%20image%2020221018181025.png alt></p><p>可以看到get方法非常简单，直接获取内部数组第i个元素，没有其他加锁的操作</p><h3 id=add-方法>add 方法</h3><p><img src=https://raw.githubusercontent.com/dccmmtop/notebook/master/images/Pasted%20image%2020221018181333.png alt></p><p>一些其他方法都是这种套路，不再一一罗列。</p><h2 id=存在的问题>存在的问题</h2><p>利用了空间换时间的思想提高性能，因为在每一步的写操作都复制了一个副本，如果数组比较大，就会导致内存占用急剧增加，引发频繁 full GC,从而影响系统性能。</p><h3 id=如何解决>如何解决</h3><p>我们可以利用 ReenTranLock 自定义一个线程安全的ArrayList, 分别定义一个 读锁和写锁，读写、写写 互斥。 读读不互斥。避免这种数组的拷贝</p></div><div class=article-toc><h3></h3><nav id=TableOfContents><ul><li><a href=#arraylist-的保护机制>ArrayList 的保护机制</a></li><li><a href=#fail-fast-机制>fail-Fast 机制</a></li><li><a href=#保护机制的实现原理>保护机制的实现原理</a></li><li><a href=#怎么样才可以在循环中修改数组>怎么样才可以在循环中修改数组？</a></li></ul><ul><li><a href=#实现原理>实现原理</a><ul><li><a href=#get-方法>get 方法</a></li><li><a href=#add-方法>add 方法</a></li></ul></li><li><a href=#存在的问题>存在的问题</a><ul><li><a href=#如何解决>如何解决</a></li></ul></li></ul></nav></div><footer class=article-footer><ul class=article-tag-list><li class=article-tag-list-item><a class=article-tag-list-link href=https://dccmmtop.github.io/tags/java>java</a></li></ul></footer></div><nav id=article-nav><a href=../../posts/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%BA%94%E7%94%A8/ id=article-nav-newer class=article-nav-link-wrap><div class=article-nav-title><span>&lt;</span>&nbsp;
线程池的应用与原理</div></a><a href=../../posts/concurrenthashmap%E4%B8%8Ehashtable/ id=article-nav-older class=article-nav-link-wrap><div class=article-nav-title>ConcurrentHashMap与HashTable&nbsp;<span>></span></div></a></nav></article></section><div><script src=https://utteranc.es/client.js repo=dccmmtop/dccmmtop.github.io issue-term=pathname label=Comment theme=github-light crossorigin=anonymous async></script></div><footer id=footer><div class=outer><div id=footer-info class=inner>&copy; 2022 dc<br>Powered by <a href=https://gohugo.io target=_blank>Hugo</a> with theme <a href=https://github.com/carsonip/hugo-theme-minos target=_blank>Minos</a></div></div><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin=anonymous></script>
<script>hljs.initHighlightingOnLoad()</script><script>document.getElementById("main-nav-toggle").addEventListener("click",function(){var e=document.getElementById("header");e.classList.contains("mobile-on")?e.classList.remove("mobile-on"):e.classList.add("mobile-on")})</script></footer></div></body></html>