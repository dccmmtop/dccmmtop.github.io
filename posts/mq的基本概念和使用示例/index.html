<!DOCTYPE html>
<html>

<head>
    <title>MQ 的基本概念和五种模式使用示例 // 超的博客</title>

    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    
    

        <meta property="og:title" content="MQ 的基本概念和五种模式使用示例" />
    <meta property="og:description" content="" />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="zh" />
    <meta property="og:url" content="https://dccmmtop.github.io/posts/mq%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%92%8C%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B/" />
    

    <link rel="icon" type="image/x-icon" href="../../favicon.ico">

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <link href="https://dccmmtop.github.io/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
    <link href="https://dccmmtop.github.io/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href=" https://dccmmtop.github.io/css/style.css">
    <link rel="stylesheet" href=" https://dccmmtop.github.io/css/custom.css">
    <link rel="stylesheet" href=" https://dccmmtop.github.io/css/copy-to-clipboard.css">

    <script src=" https://dccmmtop.github.io/js/fastsearch.js"></script>
    <script src=" https://dccmmtop.github.io/js/fuse.js"></script>
    <script src=" https://dccmmtop.github.io/js/custom.js"></script>
    <script src=" https://dccmmtop.github.io/js/copy-to-clipboard.js"></script>
    <meta name="google-site-verification" content="15Pa8fZ9IfDWw5gRPmi3YLNnHcciUc4a3Hv8cNKm-Ac" />
    

    <meta name="generator" content="Hugo 0.111.3">
</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-outer" class="outer">
        <div id="header-inner" class="inner">
            <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
            <a id="logo" class="logo-text" href="https://dccmmtop.github.io/">超的博客</a>
            <nav id="main-nav">
                
                <a class="main-nav-link" href="../../posts/">文章</a>
                
                <a class="main-nav-link" href="../../tags/">标签</a>
                
                <a class="main-nav-link" href="../../about/">我</a>
                
                <a class="main-nav-link" id="search" >
                  <input id="inputSearch" placeholder="search">
                  <svg t="1634282825021" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2401" width="15" height="15"><path d="M1005.312 914.752l-198.528-198.464A448 448 0 1 0 0 448a448 448 0 0 0 716.288 358.784l198.4 198.4a64 64 0 1 0 90.624-90.432zM448 767.936A320 320 0 1 1 448 128a320 320 0 0 1 0 640z" fill="#262626" p-id="2402"></path></svg></a>
            </nav>
            <nav id="sub-nav">
                <div id="search-form-wrap">
                </div>
            </nav>
        </div>
    </div>

    
    
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">搜索结果</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body searchResults">
          </div>
        </div>
      </div>
    </div>
</header>

        <section id="main" class="outer">
            <article class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            <h1 class="article-title" itemprop="name">MQ 的基本概念和五种模式使用示例</h1>
        </header>
        
        <div class="article-meta">
            <a href="../../posts/mq%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%92%8C%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B/" class="article-date">
                <time datetime='2023-04-07T23:27:52.000&#43;00:00' itemprop="datePublished">2023-04-07</time>
            </a>
            
            
            
        </div>
        <div class="article-entry" itemprop="articleBody">
            <h2 id="概念">概念</h2>
<p>MQ 全称 Message Queue（消息队列），是在消息的传输过程中保存消息的容器。<strong>多用于分布式系统之间进行通信。</strong></p>
<p><strong>无 MQ</strong></p>
<p><img src="../../images/2023-04-07-16-16-04.png" alt=""></p>
<p><strong>有 MQ</strong></p>
<p><img src="../../images/2023-04-07-16-16-28.png" alt=""></p>
<h2 id="优势">优势</h2>
<h3 id="应用解耦">应用解耦</h3>
<p>系统的耦合性越高，容错性就越低，可维护性就越低</p>
<p><img src="../../images/2023-04-07-16-18-06.png" alt=""><br>
<img src="../../images/2023-04-07-16-19-53.png" alt=""></p>
<h3 id="异步提速">异步提速</h3>
<p><img src="../../images/2023-04-07-16-20-17.png" alt=""></p>
<p>如图所示，在没有 MQ 的情况下，订单系统需要等待其他下游系统的反馈。总耗时： 20 + 300 + 300 + 300 = 920ms<br>
加入 MQ 后，只需把任务交给 MQ, 然后让 MQ 给下游系统分发任务：<br>
<img src="../../images/2023-04-07-16-22-11.png" alt=""></p>
<p>用户点击完下单按钮后，只需等待 25ms 就能得到下单响应 (20 + 5 = 25ms)。<br>
提升用户体验和系统吞吐量（单位时间内处理请求的数目）。</p>
<h3 id="削峰填谷">削峰填谷</h3>
<p>假设系统每秒最大能接受 1000 个请求，突然来了 5000 个请求，高并发下可能会导致服务不可用：<br>
<img src="../../images/2023-04-07-16-23-12.png" alt=""></p>
<p>在用户请求和服务器之间加入一层 MQ:</p>
<p><img src="../../images/2023-04-07-16-24-50.png" alt=""></p>
<p><img src="../../images/2023-04-07-16-25-21.png" alt=""></p>
<p>使用了 MQ 之后，限制消费消息的速度为 1000，这样一来，高峰期产生的数据势必会被积压在 MQ 中，高峰就被“削”掉了，但是因为消息积压，在高峰期过后的一段时间内，消费消息的速度还是会维持在 1000，直到消费完积压的消息，这就叫做“填谷”。</p>
<p><strong>使用 MQ 后，可以提高系统稳定性。</strong></p>
<h2 id="劣势">劣势</h2>
<h3 id="降低系统的可用性">降低系统的可用性</h3>
<p>系统引入的外部依赖越多，系统的稳定性越差，一旦 MQ 宕机，机会对业务造成影响，需要额外可虑 MQ 的高可用</p>
<h3 id="提高系统的复杂性">提高系统的复杂性</h3>
<p>MQ 的加入大大增加了系统的复杂度，以前系统间是同步的远程调用，现在是通过 MQ 进行异步调用。需要考虑消息丢失的情况</p>
<h2 id="常见的-mq-产品">常见的 MQ 产品</h2>
<p><img src="../../images/2023-04-07-16-28-41.png" alt=""></p>
<h2 id="rabbitmq-简介">RabbitMQ 简介</h2>
<p>2007 年，Rabbit 技术公司基于 AMQP 标准开发的 RabbitMQ 1.0 发布。RabbitMQ 采用 Erlang 语言开发。Erlang 语言由 Ericson 设计，专门为开发高并发和分布式系统的一种语言，在电信领域使用广泛。</p>
<p>AMQP 即 Advanced Message Queuing Protocol（高级消息队列协议），是一个网络协议，是应用层协议的一个开放标准，为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端/中间件不同产品，不同的开发语言等条件的限制</p>
<h3 id="架构图">架构图</h3>
<p><img src="../../images/2023-04-07-16-30-55.png" alt=""></p>
<p>图中涉及的几个概念：</p>
<h4 id="broker">Broker</h4>
<p>接收和分发消息的应用，RabbitMQ Server 就是 Message Broker</p>
<h4 id="virtual-host">Virtual host</h4>
<p><strong>虚拟机</strong><br>
出于多租户和安全因素考虑而设计的，把 AMQP 的基本组件划分到一个虚拟的分组中，类似与网络中的 namespace 概念，当不同的用户使用同一个 MQ 服务时，可以划分多个 vhost</p>
<h4 id="connection">Connection</h4>
<p>就是生产者和消费者与 MQ 服务器之间的 TCP 链接</p>
<h4 id="channel">Channel</h4>
<p>如果每一次访问都建立一个 connection, 在消息量大的时候建立 TCP 链接对系统资源的消耗将是巨大的，Channel 是 Connection 内部建立的逻辑链接，通常每个线程会单独创建 Channel 与消息队列服务器进行通讯，每个 channel 都有唯一标识，他们之间是完全隔离的，可以把 channel 理解为轻量级的 connection。极大的减少了操作系统建立 TCP 链接的开销。</p>
<h4 id="exchange">Exchange</h4>
<p><strong>交换器</strong></p>
<p>是消息到达消息队列服务的第一站，可以根据分发规则把消息分发不同的队列中去。</p>
<blockquote>
<p>交换器不像队列那样有真实的进程， <strong>它只是一张名称与队列进程 PID 的关系表</strong><br>
当你将消息发布到交换器时，实际上是由你所连接到的信道将消息上的路由键同交换器的绑定列表进行比较，然后路由消息。正是信道（channel）按照绑定匹配的结果，将消息路由到队列。 <strong>信道才是真正的路由器</strong><br>
由于交换器只是一张表，因此将交换器在整个集群中进行复制，更加简单<br>
举例来说，当创建一个新的交换器时，RabbitMQ 所要做的是将查询表添加到集群中的所有节点上。这时，每个节点上的每条信道都可以访问到新的交换器了。因此，相对于默认情况下队列的完整信息存在于集群中的单一节点来说，<strong>集群中的每个节点拥有每个交换器的所有信息</strong>。就可用性来讲，这非常棒，因为这意味着你不用担心在节点故障时重新声明交换器。<strong>只需让故障节点上的生产者重新连接到集群上，它们立即就能开始往交换器上发布消息了</strong>。</p>
</blockquote>
<h4 id="queue">Queue</h4>
<p><strong>队列</strong><br>
消息最终被送达到这里，等待被消费者取走。</p>
<h4 id="binding">Binding</h4>
<p><strong>绑定</strong><br>
交换器和队列之间的虚拟连接，其实就是这两者之间的对应关系。</p>
<h2 id="常用的五工作模式">常用的五工作模式</h2>
<h3 id="简单模式">简单模式</h3>
<p>最简单的工作模式，只包含一个生产者，一个消费者。这种模式下不要指定交换器，使用默认的即可，如下图：</p>
<p><img src="../../images/2023-04-07-17-11-44.png" alt=""></p>
<p>java 代码展示：<br>
<strong>依赖</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;groupId&gt;</span>com.rabbitmq<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;artifactId&gt;</span>amqp-client<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;version&gt;</span>5.3.0<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><p><strong>rabbitmq 连接工具类</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.Connection<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.ConnectionFactory<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RabbitUtils</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> ConnectionFactory connectionFactory  <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ConnectionFactory<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        connectionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setHost</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;127.0.0.1&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 默认端口号
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        connectionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setPort</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">5672</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        connectionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setUsername</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;dc&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        connectionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setPassword</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Aa111111&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 设置要连接的虚机
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        connectionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setVirtualHost</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/dc0407&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> Connection <span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>        Connection connection <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            connection <span style="color:#ff79c6">=</span> connectionFactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newConnection</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> connection<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> RuntimeException<span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><strong>生产者</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.Channel<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.Connection<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.example.util.RabbitUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.concurrent.TimeoutException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * 生产者
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Producer</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> TimeoutException<span style="color:#ff79c6">,</span> InterruptedException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 获得连接
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Connection connection <span style="color:#ff79c6">=</span> RabbitUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 获得 channel
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Channel channel <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createChannel</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        String queueName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;hello&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 声明队列并创建一个队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 第一个参数： 队列名称
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 第二个参数：是否持久化队列，不持久化队列时，MQ 重启后，队列中的消息会丢失
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 第三个参数：是否私有化队列，false 代表所有消费者都可以访问，true 代表只有第一次拥有它的消费者才能访问
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 第四个参数：是否自动删除，false 代表连接停掉后不自动删除这个队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 其他额外参数： null
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueDeclare</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 发送消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        String msg <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;你好 dc&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 交换机： 简单模式下用不到，后面的发布订阅模式下用到
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 队列名称
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 额外的参数
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 发送的消息，字节形式
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicPublish</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">,</span> queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span>msg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;消息已发送&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 关闭连接
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><strong>消费者</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.example.util.RabbitUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * 消费者
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Consumer</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 获取连接
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Connection connection <span style="color:#ff79c6">=</span> RabbitUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 获取 chanel
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Channel channel <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createChannel</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 要绑定的队列，参数同消费者
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        String queueName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;hello&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueDeclare</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 接受并处理消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 队列名称
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 是否自动确认收到消息，false 代表需要编程手动来确认，这是 MQ 推荐的做法
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 用来处理接收到的消息，是 DefaultConsumer 的实现类
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicConsume</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">new</span> Reciver<span style="color:#ff79c6">(</span>channel<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 不要关闭连接，要持续等待消息的到来
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Reciver</span> <span style="color:#8be9fd;font-style:italic">extends</span> DefaultConsumer <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> Channel channel<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">Reciver</span><span style="color:#ff79c6">(</span>Channel channel<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">(</span>channel<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">channel</span> <span style="color:#ff79c6">=</span> channel<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">handleDelivery</span><span style="color:#ff79c6">(</span>String consumerTag<span style="color:#ff79c6">,</span> Envelope envelope<span style="color:#ff79c6">,</span> AMQP<span style="color:#ff79c6">.</span><span style="color:#50fa7b">BasicProperties</span> properties<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> body<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        String msg <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>body<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;消费者收到消息：&#34;</span> <span style="color:#ff79c6">+</span> msg<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;消息的 TagId: &#34;</span> <span style="color:#ff79c6">+</span> envelope<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeliveryTag</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 第二个参数： false 代表只确认签收当前的消息，true: 代表签收该消费者所有未签收的消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicAck</span><span style="color:#ff79c6">(</span>envelope<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeliveryTag</span><span style="color:#ff79c6">(),</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="woker-queues">woker queues</h3>
<p>工作队列</p>
<p><img src="../../images/2023-04-07-22-51-10.png" alt=""></p>
<p>与简单模式相比消费从单个变成了多个，当单个消费者能力不足时，可以增加多个消费者同时去处理队列中的任务。</p>
<p>消息队列服务对任务的分发有两种方式：1. 轮询机制，挨个给每个消费者分发任务，100 个任务，2 个消费者，每个消费者依次处理 50 个任务。 2. 公平模式： 消费者处理完一个任务时立刻派发新的任务，不关系上个任务是不是该消费者处理。也就是能者多劳。</p>
<p><strong>展示</strong></p>
<p><strong>生产者：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.Channel<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.Connection<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.example.util.RabbitUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.concurrent.TimeoutException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * 生产者
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Producer</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> TimeoutException<span style="color:#ff79c6">,</span> InterruptedException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 获得连接
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Connection connection <span style="color:#ff79c6">=</span> RabbitUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 获得 channel
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Channel channel <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createChannel</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        String queueName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;hello&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 声明队列并创建一个队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 第一个参数： 队列名称
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 第二个参数：是否持久化队列，不持久化队列时，MQ 重启后，队列中的消息会丢失
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 第三个参数：是否私有化队列，false 代表所有消费者都可以访问，true 代表只有第一次拥有它的消费者才能访问
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 第四个参数：是否自动删除，false 代表连接停掉后不自动删除这个队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 其他额外参数： null
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueDeclare</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 发送消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        String msg <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;你好 dc&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 交换机： 简单模式下用不到，后面的发布订阅模式下用到
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 队列名称
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 额外的参数
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 发送的消息，字节形式
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">100</span><span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">++)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            String m1 <span style="color:#ff79c6">=</span> msg <span style="color:#ff79c6">+</span> i<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicPublish</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">,</span> queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span>m1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;消息已发送&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 关闭连接
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><strong>消费者 1</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.example.util.RabbitUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * 消费者
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Consumer1</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 获取连接
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Connection connection <span style="color:#ff79c6">=</span> RabbitUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 获取 chanel
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Channel channel <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createChannel</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 要绑定的队列，参数同消费者
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        String queueName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;hello&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueDeclare</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 处理完一个再取一个。公平模式，默认是轮询机制
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//        channel.basicQos(1);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 接受并处理消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 队列名称
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 是否自动确认收到消息，false 代表需要编程手动来确认，这是 MQ 推荐的做法
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 用来处理接收到的消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicConsume</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> DefaultConsumer<span style="color:#ff79c6">(</span>channel<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">handleDelivery</span><span style="color:#ff79c6">(</span>String consumerTag<span style="color:#ff79c6">,</span> Envelope envelope<span style="color:#ff79c6">,</span> AMQP<span style="color:#ff79c6">.</span><span style="color:#50fa7b">BasicProperties</span> properties<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> body<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                String msg <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>body<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;消费者 1 收到消息：&#34;</span> <span style="color:#ff79c6">+</span> msg <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;。TagId: &#34;</span> <span style="color:#ff79c6">+</span> envelope<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeliveryTag</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#6272a4">// 模拟处理任务的耗时
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                    Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">100</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> RuntimeException<span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// 第二个参数： false 代表只确认签收当前的消息，true: 代表签收该消费者所有未签收的消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicAck</span><span style="color:#ff79c6">(</span>envelope<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeliveryTag</span><span style="color:#ff79c6">(),</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 不要关闭连接，要持续等待消息的到来
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><strong>消费者 2</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.example.util.RabbitUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * 消费者
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Consumer2</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 获取连接
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Connection connection <span style="color:#ff79c6">=</span> RabbitUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 获取 chanel
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Channel channel <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createChannel</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 要绑定的队列，参数同消费者
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        String queueName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;hello&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueDeclare</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 处理完一个再取一个。公平模式，默认是轮询机制
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//        channel.basicQos(1);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 接受并处理消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 队列名称
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 是否自动确认收到消息，false 代表需要编程手动来确认，这是 MQ 推荐的做法
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 用来处理接收到的消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicConsume</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> DefaultConsumer<span style="color:#ff79c6">(</span>channel<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">handleDelivery</span><span style="color:#ff79c6">(</span>String consumerTag<span style="color:#ff79c6">,</span> Envelope envelope<span style="color:#ff79c6">,</span> AMQP<span style="color:#ff79c6">.</span><span style="color:#50fa7b">BasicProperties</span> properties<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> body<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                String msg <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>body<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;消费者 2 收到消息：&#34;</span> <span style="color:#ff79c6">+</span> msg <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;。TagId: &#34;</span> <span style="color:#ff79c6">+</span> envelope<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeliveryTag</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#6272a4">// 模拟处理任务的耗时
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                    Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">500</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> RuntimeException<span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">// 第二个参数： false 代表只确认签收当前的消息，true: 代表签收该消费者所有未签收的消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicAck</span><span style="color:#ff79c6">(</span>envelope<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeliveryTag</span><span style="color:#ff79c6">(),</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 不要关闭连接，要持续等待消息的到来
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><strong>轮询机制输出结果：</strong></p>
<p>不管两个消费者处理消息能力的强弱，被分配的任务一样多：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>消费者 1 收到消息：你好 dc0。TagId: 1
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc2。TagId: 2
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc4。TagId: 3
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc6。TagId: 4
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc8。TagId: 5
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc10。TagId: 6
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc12。TagId: 7
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc14。TagId: 8
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc16。TagId: 9
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc18。TagId: 10
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>消费者 2 收到消息：你好 dc1。TagId: 1
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc3。TagId: 2
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc5。TagId: 3
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc7。TagId: 4
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc9。TagId: 5
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc11。TagId: 6
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc13。TagId: 7
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc15。TagId: 8
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc17。TagId: 9
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc19。TagId: 10
</span></span></code></pre></div><p><strong>公平模式下的输出结果：</strong></p>
<p>消费者 1 处理能力强，单位时间内处理任务数多</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>消费者 1 收到消息：你好 dc0。TagId: 1
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc2。TagId: 2
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc3。TagId: 3
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc4。TagId: 4
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc5。TagId: 5
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc7。TagId: 6
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc8。TagId: 7
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc9。TagId: 8
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc10。TagId: 9
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc11。TagId: 10
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc13。TagId: 11
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc14。TagId: 12
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc15。TagId: 13
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc16。TagId: 14
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc17。TagId: 15
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc19。TagId: 16
</span></span><span style="display:flex;"><span>消费者 1 收到消息：你好 dc20。TagId: 17
</span></span></code></pre></div><p>消费者 2 处理能力弱，单位时间内处理任务数少</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>消费者 2 收到消息：你好 dc1。TagId: 1
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc6。TagId: 2
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc12。TagId: 3
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc18。TagId: 4
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc23。TagId: 5
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc29。TagId: 6
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc35。TagId: 7
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc40。TagId: 8
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc46。TagId: 9
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc52。TagId: 10
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc58。TagId: 11
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc63。TagId: 12
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc69。TagId: 13
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc75。TagId: 14
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc81。TagId: 15
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc86。TagId: 16
</span></span><span style="display:flex;"><span>消费者 2 收到消息：你好 dc92。TagId: 17
</span></span></code></pre></div><h3 id="publishsubscribe">Publish/Subscribe</h3>
<p><strong>发布订阅模式</strong></p>
<p>目前为止，系统中只出现了一个队列，队列中的消息一般只能被消费一次，当一个消费者从队列中取出消息后，其他消费者便无法再次处理该消息了。</p>
<p>假如有一个天气预报发布系统，有一个气象发布中心以及各大气象软件和门户网站，这些软件和网站都要从气象中心获取天气信息。如下图：<br>
<img src="../../images/2023-04-10-17-02-15.png" alt=""></p>
<p>气象发布中心不可能一个个去对接不同的展示平台，他们是把天气信息按照一定的格式发布到某个地方，其他各大展示平台都从这里获取。现在我们用 RabbitMQ 来设计这套系统，上面介绍的工作队列模式就无法适用了，因为如果一个地方的天气信息被“墨迹天气”取走后，这条消息就没了，肯定不合适。我们自然想到每个天气展示平台都去绑定一个队列，各自从队列中接收气象中发布的消息。而气象中心每次都要向这些队列中依次发布消息。就像下面这样：<br>
<img src="../../images/2023-04-10-17-08-34.png" alt=""></p>
<p>这样是可行，只不过在生产者一端增加了几行代码而已，但是这样做大大的增加了系统的耦合度。每当新增加一个展示平台时，气象中心都要修改代码新增一个推送消息的队列。</p>
<p>这种一端发布，多端都能收到的场景很像广播站与收音机的关系。只要用户把收音机调到固定频道，就都可以接收到来自该频道的信息。在 RabbitMQ 中也有这种广播模式，而这种广播模式就是依靠<code>交换器</code>来实现的。 如下图：<br>
<img src="../../images/2023-04-10-17-15-14.png" alt=""></p>
<p>这种模式下，生产者只需把消息发送指定交换器上，消费者绑定队列的时候，声明一下队列与交换器的关系即可。生产者在发布消息时，交换器会根据这种绑定关系把消息向所有队列都发送一遍。</p>
<p>下面来看一下代码实现：</p>
<p>需要先在RabbitMQ 管理端创建``weather_routing_exchange`交换器 , 类型是 fanout</p>
<p><strong>气象站</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.Channel<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.Connection<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.example.util.RabbitUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.concurrent.TimeoutException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * 气象站
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">WeatherStation</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> TimeoutException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Connection connection <span style="color:#ff79c6">=</span> RabbitUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Channel channel <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createChannel</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String weather<span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;{&#39;date&#39;: &#39;2023-04-10&#39;,&#39;location&#39;:&#39;郑州&#39;,&#39;text&#39;: &#39;晴，16℃~28℃&#39;}&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 第一个参数：指定交换器
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 第二个参数：路由 key, 暂时用不到。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 第三个参数：额外信息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 第四个参数：消息内容，字节形式
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 与工作队列模式不同，这里直接发布消息了，没有指定发布到哪个队列中，这是由 RabbitMQ 中的交换器来决定的
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicPublish</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;weather_exchange&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span>weather<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        weather<span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;{&#39;date&#39;: &#39;2023-04-10&#39;,&#39;location&#39;:&#39;新乡&#39;,&#39;text&#39;: &#39;多云，10℃~26℃&#39;}&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicPublish</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;weather_exchange&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span>weather<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><strong>墨迹 APP</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.example.util.RabbitUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * 墨迹 APP
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MoJiApp</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Connection connection <span style="color:#ff79c6">=</span> RabbitUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Channel channel <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createChannel</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        String queueName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;moji&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 声明一个队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueDeclare</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 绑定队列与交换器的关系
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueBind</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;weather_exchange&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicQos</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 监听消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicConsume</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> DefaultConsumer<span style="color:#ff79c6">(</span>channel<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">handleDelivery</span><span style="color:#ff79c6">(</span>String consumerTag<span style="color:#ff79c6">,</span> Envelope envelope<span style="color:#ff79c6">,</span> AMQP<span style="color:#ff79c6">.</span><span style="color:#50fa7b">BasicProperties</span> properties<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> body<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;墨迹 APP 收到天气信息：&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>body<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>                channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicAck</span><span style="color:#ff79c6">(</span>envelope<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeliveryTag</span><span style="color:#ff79c6">(),</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><strong>彩云 APP</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.example.util.RabbitUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * 彩云 APP
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">CaiYunApp</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Connection connection <span style="color:#ff79c6">=</span> RabbitUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Channel channel <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createChannel</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        String queueName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;caiyun&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 声明一个队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueDeclare</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 绑定队列与交换器的关系
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueBind</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;weather_exchange&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicQos</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 监听消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicConsume</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> DefaultConsumer<span style="color:#ff79c6">(</span>channel<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">handleDelivery</span><span style="color:#ff79c6">(</span>String consumerTag<span style="color:#ff79c6">,</span> Envelope envelope<span style="color:#ff79c6">,</span> AMQP<span style="color:#ff79c6">.</span><span style="color:#50fa7b">BasicProperties</span> properties<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> body<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;彩云 APP 收到天气信息：&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>body<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>                channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicAck</span><span style="color:#ff79c6">(</span>envelope<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeliveryTag</span><span style="color:#ff79c6">(),</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>墨迹 APP 收到天气信息：{&#39;date&#39;: &#39;2023-04-10&#39;,&#39;location&#39;:&#39;郑州&#39;,&#39;text&#39;: &#39;晴，16℃~28℃&#39;}
</span></span><span style="display:flex;"><span>墨迹 APP 收到天气信息：{&#39;date&#39;: &#39;2023-04-10&#39;,&#39;location&#39;:&#39;新乡&#39;,&#39;text&#39;: &#39;多云，10℃~26℃&#39;}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>彩云 APP 收到天气信息：{&#39;date&#39;: &#39;2023-04-10&#39;,&#39;location&#39;:&#39;郑州&#39;,&#39;text&#39;: &#39;晴，16℃~28℃&#39;}
</span></span><span style="display:flex;"><span>彩云 APP 收到天气信息：{&#39;date&#39;: &#39;2023-04-10&#39;,&#39;location&#39;:&#39;新乡&#39;,&#39;text&#39;: &#39;多云，10℃~26℃&#39;}
</span></span></code></pre></div><p>这种发布订阅模式实现了一端发布，多端订阅的功能，一旦客户端绑定了队列与交换器的关系，只要发布在交换器上的消息，该客户端都可以收到。假如墨迹 APP 用户只想关注郑州的天气，彩云 APP 用户只想关注新乡的天气。这又该如何做呢？最先想到的可能就是让气象站按照地区给交换器分类，郑州的天气往郑州的交换器上发，新乡的天气往新乡的交换器上发，等等。但是这样会很麻烦，假如以后国家多了一个省，或者行政区域有变动，岂不是又要气象站修改代码。</p>
<h3 id="routing">Routing</h3>
<p>这时候交换器的路由模式，就派上用场了，生产者在发布一条消息时，可以给该消息指定一个<code>路由 key</code>, 消费者在绑定队列与交换器的关系时，可以指定具有哪一种的<code>路由 key</code>的消息应该发布到该队列里面，而不是一股脑的全部接收该交换器的所有消息。如下图；</p>
<p><img src="../../images/2023-04-10-18-08-39.png" alt=""></p>
<p>下面看一下代码实现；<br>
需要先在RabbitMQ 管理端创建``weather_routing_exchange`交换器 , 类型是 direct</p>
<p><strong>气象站</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.Channel<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.Connection<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.example.util.RabbitUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.ArrayList<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.List<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.concurrent.TimeoutException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * 气象站
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">WeatherStation</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> TimeoutException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Connection connection <span style="color:#ff79c6">=</span> RabbitUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Channel channel <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createChannel</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        List<span style="color:#ff79c6">&lt;</span>Weather<span style="color:#ff79c6">&gt;</span> weatherList <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ArrayList<span style="color:#ff79c6">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        weatherList<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Weather<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;zhengzhou&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;郑州晴，16℃~28℃&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        weatherList<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Weather<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;xinxiang&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;新乡多云，10℃~26℃&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Weather weather <span style="color:#ff79c6">:</span> weatherList<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4">// 指定了路由key， 路由key的格式是地区
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicPublish</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;weather_routing_exchange&#34;</span><span style="color:#ff79c6">,</span>weather<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getKey</span><span style="color:#ff79c6">(),</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span>weather<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMsg</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Weather</span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> String key<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> String msg<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">Weather</span><span style="color:#ff79c6">(</span>String key<span style="color:#ff79c6">,</span> String msg<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span> <span style="color:#ff79c6">=</span> key<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">msg</span> <span style="color:#ff79c6">=</span> msg<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">getKey</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> key<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">getMsg</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> msg<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><strong>墨迹APP</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.example.util.RabbitUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * 墨迹APP
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MoJiApp</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Connection connection <span style="color:#ff79c6">=</span> RabbitUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Channel channel <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createChannel</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        String queueName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;moji&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 声明一个队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueDeclare</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 绑定队列与交换器的关系,同时指定了路由key是郑州
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueBind</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;weather_routing_exchange&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;zhengzhou&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicQos</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 监听消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicConsume</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> DefaultConsumer<span style="color:#ff79c6">(</span>channel<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">handleDelivery</span><span style="color:#ff79c6">(</span>String consumerTag<span style="color:#ff79c6">,</span> Envelope envelope<span style="color:#ff79c6">,</span> AMQP<span style="color:#ff79c6">.</span><span style="color:#50fa7b">BasicProperties</span> properties<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> body<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;墨迹APP 收到天气信息: &#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>body<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>                channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicAck</span><span style="color:#ff79c6">(</span>envelope<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeliveryTag</span><span style="color:#ff79c6">(),</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><strong>彩云APP</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.example.util.RabbitUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * 彩云APP
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">CaiYunApp</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Connection connection <span style="color:#ff79c6">=</span> RabbitUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Channel channel <span style="color:#ff79c6">=</span> connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createChannel</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        String queueName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;caiyun&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 声明一个队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueDeclare</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 绑定队列与交换器的关系
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">queueBind</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;weather_routing_exchange&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;xinxiang&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicQos</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">1</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 监听消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicConsume</span><span style="color:#ff79c6">(</span>queueName<span style="color:#ff79c6">,</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> DefaultConsumer<span style="color:#ff79c6">(</span>channel<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>            @Override
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">handleDelivery</span><span style="color:#ff79c6">(</span>String consumerTag<span style="color:#ff79c6">,</span> Envelope envelope<span style="color:#ff79c6">,</span> AMQP<span style="color:#ff79c6">.</span><span style="color:#50fa7b">BasicProperties</span> properties<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> body<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;彩云APP 收到天气信息: &#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>body<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>                channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicAck</span><span style="color:#ff79c6">(</span>envelope<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeliveryTag</span><span style="color:#ff79c6">(),</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><strong>输出内容</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>墨迹APP 收到天气信息: 郑州晴，16℃~28℃
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>彩云APP 收到天气信息: 新乡多云，10℃~26℃
</span></span></code></pre></div><h3 id="topics">Topics</h3>
<p>这种模式就比较好理解了，上面的 Routing 模式是要求key完全一致，消息才能被交换器投递到队列。而Topics 模式支持统配符的key，在设计key的时候，一般由多个关键词组成，并用.连接，而通配符支持两种模式:</p>
<ol>
<li><code>#</code>: 匹配一个或者多个单词</li>
<li><code>*</code>: 只匹配一个单词</li>
</ol>
<p>例如 item.# 可以匹配 item.insert  item.insert.abc<br>
item.* 只能匹配 item.insert</p>
<p>这种模式最灵活，用的最多</p>
<h2 id="总结">总结</h2>
<ul>
<li>简单模式: 一个生产者，一个队列，一个消费者。</li>
<li>工作队列模式: 一个队列，多个消费者。队列种的消息只能被消费一次，可以增加消费者的数量快速处理队列中的任务。队列中的任务派发给消费者的模式有两种: 1. 轮询。 2. 能者多劳</li>
<li>发布订阅模式: 引入交换器，多个队列，多个消费者。实现一端发布，多端都能收到消息</li>
<li>路由模式: 在发布订阅的基础上，给消费者增加了自由选择消息的能力。通过全值匹配路由key实现的</li>
<li>Topics 模式: 在路由模式的基础上，路由key采用通配符的匹配方式， 这种模式最灵活，使用最多</li>
</ul>
<h2 id="消息的可靠投递">消息的可靠投递</h2>
<p>RabbitMQ 通过两个回调方法来让生产者确认消息是否正确投递到队列中，</p>
<ol>
<li>消息是否投递到交换器中，调用 confirmListener</li>
<li>消息是否投递到队列中，调用 returnListener</li>
</ol>
<p><strong>注意：上面两种状态只是生产者与Broker之间的关系，和消费者的是否接收确认消息无关</strong></p>
<h3 id="confirmlistener">confirmListener</h3>
<p>代表生产者将消息投递到Broker时的状态，后续会出现两种情况：</p>
<ol>
<li>ack 代表数据已经被broker接收，</li>
<li>nack 代表broker拒收消息，原因有多种：队列已满，限流，IO异常等&hellip;</li>
</ol>
<p>示例代码:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#6272a4">//测试 Confirm 模式
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>@Test
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">testConfirm</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//定义回调
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setConfirmCallback</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> RabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">ConfirmCallback</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">            *
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">            * @param correlationData 相关配置信息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">            * @param ack   exchange交换机 是否成功收到了消息。true 成功，false代表失败
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">            * @param cause 失败原因
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">            */</span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">confirm</span><span style="color:#ff79c6">(</span>CorrelationData correlationData<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">boolean</span> ack<span style="color:#ff79c6">,</span> String cause<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;confirm方法被执行了....&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">//ack 为  true表示 消息已经到达交换机
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>ack<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">//接收成功
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;接收成功消息&#34;</span> <span style="color:#ff79c6">+</span> cause<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">//接收失败
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;接收失败消息&#34;</span> <span style="color:#ff79c6">+</span> cause<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#6272a4">//做一些处理，让消息再次发送。
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//进行消息发送
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;test_exchange_confirm&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;confirm&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;message Confirm...&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="returnlistener">returnListener</h3>
<p>代表消息正常被broker接收(ack)，但broker没有对应的队列对消息进行投递，消息被退回给生产者。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#6272a4">//测试 return模式
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>@Test
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">testReturn</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//设置交换机处理失败消息的模式   为true的时候，消息达到不了 队列时，会将消息重新返回给生产者
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setMandatory</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//定义回调
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setReturnCallback</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> RabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">ReturnCallback</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">            *
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">            * @param message   消息对象
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">            * @param replyCode 错误码
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">            * @param replyText 错误信息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">            * @param exchange  交换机
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">            * @param routingKey 路由键
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">            */</span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">returnedMessage</span><span style="color:#ff79c6">(</span>Message message<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> replyCode<span style="color:#ff79c6">,</span> String replyText<span style="color:#ff79c6">,</span> String exchange<span style="color:#ff79c6">,</span> String routingKey<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;return 执行了....&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;message:&#34;</span><span style="color:#ff79c6">+</span>message<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;replyCode:&#34;</span><span style="color:#ff79c6">+</span>replyCode<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;replyText:&#34;</span><span style="color:#ff79c6">+</span>replyText<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;exchange:&#34;</span><span style="color:#ff79c6">+</span>exchange<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;routingKey:&#34;</span><span style="color:#ff79c6">+</span>routingKey<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#6272a4">//处理
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//进行消息发送
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;test_exchange_confirm&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;confirm&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;message return...&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div>
        </div>

        

        


        
        <footer class="article-footer">
            <ul class="article-tag-list">
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://dccmmtop.github.io/%20tags/rabbitmq">rabbitMQ
                    </a>
                </li>
                
            </ul>
        </footer>
        
    </div>
    
<nav id="article-nav">
    
    <a href="../../posts/springboot%E4%B8%8Erabbitmq%E9%9B%86%E6%88%90%E5%92%8C%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/" id="article-nav-newer" class="article-nav-link-wrap">
        <div class="article-nav-title"><span>&lt;</span>&nbsp;
            SpringBoot 与 RabbitMQ 集成和高级用法
        </div>
    </a>
    
    
    <a href="../../posts/redis%E5%86%85%E5%AD%98%E6%B8%85%E7%90%86%E7%AD%96%E7%95%A5/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">Redis 内存清理策略&nbsp;<span>&gt;</span></div>
    </a>
    
</nav>


</article>
            
        </section>

        <div>
            

            <script src="https://utteranc.es/client.js" repo="dccmmtop/dccmmtop.github.io" issue-term="pathname"
                label="Comment" theme="github-light" crossorigin="anonymous" async>
                </script>
            

        </div>

        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2023 dc
            <br />
            Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with theme <a
                href="https://github.com/carsonip/hugo-theme-minos" target="_blank">Minos</a>


        </div>
    </div>
    

    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css"
        integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"
        integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    <script>
        document.getElementById('main-nav-toggle').addEventListener('click', function () {
            var header = document.getElementById('header');
            if (header.classList.contains('mobile-on')) {
                header.classList.remove('mobile-on');
            } else {
                header.classList.add('mobile-on');
            }
        });
    </script>
    <style>
        #footer-info {
            line-height: 1.4em;
            font-size: 10px;
        }

        .custom-blog-info {
            font-family: 'Long Cang', cursive;
            border-top: 1px dashed #333;
            font-size: 16px;
            margin-top: 10px;
            padding-top: 10px;
            line-height: 1.4em;
        }
    </style>
</footer>

    </div>
</body>

</html>