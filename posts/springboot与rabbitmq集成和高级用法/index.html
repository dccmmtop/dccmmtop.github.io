<!DOCTYPE html>
<html>

<head>
    <title>SpringBoot 与 RabbitMQ 集成和高级用法 // 超的博客</title>

    <meta charset="utf-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    
    

        <meta property="og:title" content="SpringBoot 与 RabbitMQ 集成和高级用法" />
    <meta property="og:description" content="" />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="zh" />
    <meta property="og:url" content="https://dccmmtop.github.io/posts/springboot%E4%B8%8Erabbitmq%E9%9B%86%E6%88%90%E5%92%8C%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/" />
    

    <link rel="icon" type="image/x-icon" href="../../favicon.ico">

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

    <link href="https://dccmmtop.github.io/webfonts/ptserif/main.css" rel='stylesheet' type='text/css'>
    <link href="https://dccmmtop.github.io/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href=" https://dccmmtop.github.io/css/style.css">
    <link rel="stylesheet" href=" https://dccmmtop.github.io/css/custom.css">
    <link rel="stylesheet" href=" https://dccmmtop.github.io/css/copy-to-clipboard.css">

    <script src=" https://dccmmtop.github.io/js/fastsearch.js"></script>
    <script src=" https://dccmmtop.github.io/js/fuse.js"></script>
    <script src=" https://dccmmtop.github.io/js/custom.js"></script>
    <script src=" https://dccmmtop.github.io/js/copy-to-clipboard.js"></script>
    <script> var _hmt = _hmt || []; (function() { var hm = document.createElement("script"); hm.src = "https://hm.baidu.com/hm.js?e0fe0b20745a9435509785b9f15eb32d"; var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s); })(); </script>

    <meta name="google-site-verification" content="15Pa8fZ9IfDWw5gRPmi3YLNnHcciUc4a3Hv8cNKm-Ac" />
    

    <meta name="generator" content="Hugo 0.111.3">
</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-outer" class="outer">
        <div id="header-inner" class="inner">
            <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
            <a id="logo" class="logo-text" href="https://dccmmtop.github.io/">超的博客</a>
            <nav id="main-nav">
                
                <a class="main-nav-link" href="../../posts/">文章</a>
                
                <a class="main-nav-link" href="../../tags/">标签</a>
                
                <a class="main-nav-link" href="../../about/">我</a>
                
                <a class="main-nav-link" id="search" >
                  <input id="inputSearch" placeholder="search">
                  <svg t="1634282825021" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2401" width="15" height="15"><path d="M1005.312 914.752l-198.528-198.464A448 448 0 1 0 0 448a448 448 0 0 0 716.288 358.784l198.4 198.4a64 64 0 1 0 90.624-90.432zM448 767.936A320 320 0 1 1 448 128a320 320 0 0 1 0 640z" fill="#262626" p-id="2402"></path></svg></a>
            </nav>
            <nav id="sub-nav">
                <div id="search-form-wrap">
                </div>
            </nav>
        </div>
    </div>

    
    
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">搜索结果</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body searchResults">
          </div>
        </div>
      </div>
    </div>
</header>

        <section id="main" class="outer">
            <article class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            <h1 class="article-title" itemprop="name">SpringBoot 与 RabbitMQ 集成和高级用法</h1>
        </header>
        
        <div class="article-meta">
            <a href="../../posts/springboot%E4%B8%8Erabbitmq%E9%9B%86%E6%88%90%E5%92%8C%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/" class="article-date">
                <time datetime='2023-04-12T11:33:58.000&#43;00:00' itemprop="datePublished">2023-04-12</time>
            </a>
            
            
            
        </div>
        <div class="article-entry" itemprop="articleBody">
            <ul>
<li><a href="#%E7%AE%80%E5%8D%95%E7%A4%BA%E4%BE%8B">简单示例</a>
<ul>
<li><a href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84">项目结构</a></li>
<li><a href="#%E4%BE%9D%E8%B5%96">依赖</a></li>
<li><a href="#%E9%85%8D%E7%BD%AE">配置</a></li>
<li><a href="#%E7%94%9F%E4%BA%A7%E8%80%85">生产者</a></li>
<li><a href="#%E6%B6%88%E8%B4%B9%E8%80%85">消费者</a></li>
</ul>
</li>
<li><a href="#%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%8A%95%E9%80%92%E7%A4%BA%E4%BE%8B">消息的可靠投递示例</a>
<ul>
<li><a href="#confirm">confirm</a></li>
<li><a href="#return">return</a></li>
</ul>
</li>
<li><a href="#%E6%B6%88%E8%B4%B9%E8%80%85%E7%A1%AE%E8%AE%A4%E6%9C%BA%E5%88%B6">消费者确认机制</a></li>
<li><a href="#%E6%B6%88%E8%B4%B9%E7%AB%AF%E9%99%90%E6%B5%81">消费端限流</a></li>
<li><a href="#ttl">TTL</a>
<ul>
<li><a href="#%E5%8D%95%E6%9D%A1%E6%B6%88%E6%81%AF">单条消息</a></li>
<li><a href="#%E6%95%B4%E4%B8%AA%E9%98%9F%E5%88%97%E8%AE%BE%E7%BD%AE-ttl">整个队列设置 TTL</a></li>
</ul>
</li>
<li><a href="#%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97">死信队列</a>
<ul>
<li><a href="#%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4">死信队列的实现步骤</a></li>
</ul>
</li>
<li><a href="#%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97">延迟队列</a></li>
<li><a href="#%E6%B6%88%E6%81%AF%E5%B9%82%E7%AD%89%E8%AE%BE%E8%AE%A1">消息幂等设计</a></li>
</ul>
<h2 id="简单示例">简单示例</h2>
<h3 id="项目结构">项目结构</h3>
<p><img src="../../images/2023-04-12-11-37-36.png" alt=""></p>
<h3 id="依赖">依赖</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;artifactId&gt;</span>spring-boot-starter-amqp<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;groupId&gt;</span>junit<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;artifactId&gt;</span>junit<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;version&gt;</span>RELEASE<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;scope&gt;</span>compile<span style="color:#ff79c6">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h3 id="配置">配置</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yml" data-lang="yml"><span style="display:flex;"><span><span style="color:#ff79c6">spring</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">host</span>: <span style="color:#bd93f9">127.0.0.1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">port</span>: <span style="color:#bd93f9">5672</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">username</span>: dc
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">password</span>: Aa111111
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">virtual-host</span>: /dc0407
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 让发布者可以收到消息是否投递成功的回调</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 默认是 false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">publisher-confirms</span>: <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">listener</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">simple</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 消费者开启手动确认模式，默认是 none </span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">acknowledge-mode</span>: manual
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4"># 每次消费一个</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">prefetch</span>: <span style="color:#bd93f9">1</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> io.dc.rabbitmqinspringboot.config<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.amqp.core.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.beans.factory.annotation.Qualifier<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.beans.factory.annotation.Value<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.context.annotation.Bean<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.context.annotation.Configuration<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Configuration
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RabbitMQConfig</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String EXCHANGE_NAME <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;boot_topic_exchange&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String QUEUE_NAME <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;boot_queue&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 1. 声明交换机
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    @Bean<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootTopicExchange&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Exchange <span style="color:#50fa7b">bootExchange</span><span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> ExchangeBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">topicExchange</span><span style="color:#ff79c6">(</span>EXCHANGE_NAME<span style="color:#ff79c6">).</span><span style="color:#50fa7b">durable</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 2. 声明队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    @Bean<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootQueue&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Queue <span style="color:#50fa7b">bootQueue</span><span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> QueueBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">durable</span><span style="color:#ff79c6">(</span>QUEUE_NAME<span style="color:#ff79c6">).</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 3. 将队列与交换器进行绑定
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    @Bean
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Binding <span style="color:#50fa7b">bindQueueExchange</span><span style="color:#ff79c6">(</span>@Qualifier<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootQueue&#34;</span><span style="color:#ff79c6">)</span> Queue queue<span style="color:#ff79c6">,</span> @Qualifier<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootTopicExchange&#34;</span><span style="color:#ff79c6">)</span> Exchange exchange<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> BindingBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>queue<span style="color:#ff79c6">).</span><span style="color:#50fa7b">to</span><span style="color:#ff79c6">(</span>exchange<span style="color:#ff79c6">).</span><span style="color:#50fa7b">with</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;boot.#&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">noargs</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 自定义连接工厂，自由程度高，本次演示没用到
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    @Bean<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;customConnectionFactory&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> ConnectionFactory <span style="color:#50fa7b">connectionFactory</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>            @Value<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;${spring.rabbitmq.host}&#34;</span><span style="color:#ff79c6">)</span> String host<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>            @Value<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;${spring.rabbitmq.port}&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#8be9fd">int</span> port<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>            @Value<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;${spring.rabbitmq.username}&#34;</span><span style="color:#ff79c6">)</span> String username<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>            @Value<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;${spring.rabbitmq.password}&#34;</span><span style="color:#ff79c6">)</span> String password<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>            @Value<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;${spring.rabbitmq.virtual-host}&#34;</span><span style="color:#ff79c6">)</span> String vhost
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>        CachingConnectionFactory factory <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> CachingConnectionFactory<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setHost</span><span style="color:#ff79c6">(</span>host<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setPort</span><span style="color:#ff79c6">(</span>port<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setUsername</span><span style="color:#ff79c6">(</span>username<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setPassword</span><span style="color:#ff79c6">(</span>password<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setVirtualHost</span><span style="color:#ff79c6">(</span>vhost<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> factory<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 自定义消息监听器工厂，自由程度高
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    @Bean<span style="color:#ff79c6">(</span>name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;customListenFactory&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> SimpleRabbitListenerContainerFactory <span style="color:#50fa7b">listenerContainerFactory</span><span style="color:#ff79c6">(</span>@Qualifier<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;customConnectionFactory&#34;</span><span style="color:#ff79c6">)</span> ConnectionFactory connectionFactory<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>        SimpleRabbitListenerContainerFactory factory <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> SimpleRabbitListenerContainerFactory<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        factory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setConnectionFactory</span><span style="color:#ff79c6">(</span>connectionFactory<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 设置手动签收
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        factory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAcknowledgeMode</span><span style="color:#ff79c6">(</span>AcknowledgeMode<span style="color:#ff79c6">.</span><span style="color:#50fa7b">MANUAL</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 设置预处理数量，同时没有确认的消息不能超过 N 个，起到消费者限流的作用，详细解释见下
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        factory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setPrefetchCount</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">5</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> factory<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="生产者">生产者</h3>
<p>在测试类中发消息</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">package</span> io.dc.rabbitmqinspringboot<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> io.dc.rabbitmqinspringboot.config.RabbitMQConfig<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.junit.Test<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.junit.runner.RunWith<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.amqp.core.Message<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.amqp.rabbit.connection.CorrelationData<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.beans.factory.annotation.Autowired<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.boot.test.context.SpringBootTest<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@SpringBootTest
</span></span><span style="display:flex;"><span>@RunWith<span style="color:#ff79c6">(</span>SpringJUnit4ClassRunner<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">RabbitMqInSpringBootApplicationTests</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    RabbitTemplate rabbitTemplate<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#6272a4">// 发一次消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">sendMsg</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>RabbitMQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">EXCHANGE_NAME</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;boot.dc&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;你好 rabbitMQ&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 批量发消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">sendBatchMsg</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span><span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> <span style="color:#bd93f9">10</span><span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">++)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>RabbitMQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">EXCHANGE_NAME</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;boot.dc&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;你好 rabbitMQ&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="消费者">消费者</h3>
<p>简单版，自动 ack</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> io.dc.rabbitmqinspringboot.consumer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> io.dc.rabbitmqinspringboot.config.RabbitMQConfig<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.stereotype.Component<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.amqp.core.Message<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Consumer1</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    @RabbitListener<span style="color:#ff79c6">(</span>queues <span style="color:#ff79c6">=</span> RabbitMQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">QUEUE_NAME</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">listenerQueue</span><span style="color:#ff79c6">(</span>Message message<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;消费者 1 接收到消息：&#34;</span><span style="color:#ff79c6">+</span> message<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>手动 ack:<br>
需要在配置文件中额外设置为手动确认：manual</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> io.dc.rabbitmqinspringboot.consumer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.rabbitmq.client.Channel<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> io.dc.rabbitmqinspringboot.config.RabbitMQConfig<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.amqp.core.Message<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.stereotype.Component<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Consumer2</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 也可以采用自定义监听工厂
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// @RabbitListener(queues = RabbitMQConfig.QUEUE_NAME, containerFactory = &#34;customListenFactory&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    @RabbitListener<span style="color:#ff79c6">(</span>queues <span style="color:#ff79c6">=</span> RabbitMQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">QUEUE_NAME</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">onMessage</span><span style="color:#ff79c6">(</span>Message message<span style="color:#ff79c6">,</span> Channel channel<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;消费者 2 收到消息：&#34;</span> <span style="color:#ff79c6">+</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBody</span><span style="color:#ff79c6">()));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">long</span> deliveryTag <span style="color:#ff79c6">=</span> message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMessageProperties</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getDeliveryTag</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;消息 Id: &#34;</span> <span style="color:#ff79c6">+</span> deliveryTag<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 进行消息签收，如果不签收，将只会收到 ${listener.simple.prefetch} 个消息，因为设置了手动签收模式
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        channel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">basicAck</span><span style="color:#ff79c6">(</span>deliveryTag<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 拒绝签收
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#6272a4">// 最后一个参数： 是否重回队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//        channel.basicNack(deliveryTag,false, false);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h2 id="消息的可靠投递示例">消息的可靠投递示例</h2>
<p>在 <a href="https://blog.csdn.net/a141210104/article/details/130022768">RabbitMQ 的基本概念和五种模式使用示例</a> 中已经介绍了两种实现可靠投递的机制，这里仅作为一个完整的补充：</p>
<h3 id="confirm">confirm</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">testConfirm</span><span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setConfirmCallback</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> RabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">ConfirmCallback</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">confirm</span><span style="color:#ff79c6">(</span>CorrelationData correlationData<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">boolean</span> b<span style="color:#ff79c6">,</span> String s<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;执行了 confirm 方法。..&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>b<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;发送成功&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span><span style="color:#ff79c6">else</span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;发送失败：&#34;</span> <span style="color:#ff79c6">+</span> s<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 正常
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>RabbitMQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">EXCHANGE_NAME</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;boot.dc&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;你好 rabbitMQ&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 错误的交换器。会打印发送失败
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>RabbitMQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">EXCHANGE_NAME</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;111&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;boot.dc&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;你好 rabbitMQ&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">5000</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> RuntimeException<span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="return">return</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">testReturn</span><span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 只有设置 true，消息无法到达队列时，才会退回给生产者
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setMandatory</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setReturnCallback</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> RabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">ReturnCallback</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        *
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * @param message the returned message.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * @param replyCode the reply code.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * @param replyText the reply text.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * @param exchange the exchange.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * @param routingKey the routing key.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        */</span>
</span></span><span style="display:flex;"><span>        @Override
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">returnedMessage</span><span style="color:#ff79c6">(</span>Message message<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> replyCode<span style="color:#ff79c6">,</span> String replyText<span style="color:#ff79c6">,</span> String exchange<span style="color:#ff79c6">,</span> String routingKey<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;消息退回了~&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;message: &#34;</span> <span style="color:#ff79c6">+</span> message<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;replyCode: &#34;</span> <span style="color:#ff79c6">+</span> replyCode<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;replyText: &#34;</span> <span style="color:#ff79c6">+</span> replyText<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;exchange: &#34;</span> <span style="color:#ff79c6">+</span> exchange<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;routingKey: &#34;</span> <span style="color:#ff79c6">+</span> routingKey<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 正常
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>RabbitMQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">EXCHANGE_NAME</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;boot.dc&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;你好 rabbitMQ&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 错误的路由 key。消息会被退回
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>RabbitMQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">EXCHANGE_NAME</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;1111_boot.dc&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;你好 rabbitMQ&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sleep</span><span style="color:#ff79c6">(</span><span style="color:#bd93f9">5000</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InterruptedException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> RuntimeException<span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h2 id="消费者确认机制">消费者确认机制</h2>
<p>Ack 指的是 ack 指 Acknowledge，确认。 表示消费端收到消息后的确认方式。</p>
<p>有三种确认方式：</p>
<ul>
<li>自动确认 acknowledge = none</li>
<li>手动确认 acknowledge = manual</li>
<li>根据异常情况确认 acknowledge = auto 这种情况使用麻烦，一般不用</li>
</ul>
<p>其中自动确认是指，当消息一旦被 Consumer 接收到，则自动确认收到，并将相应 message 从 RabbitMQ 的消息缓存中移除。但是在实际业务处理中，很可能消息接收到，业务处理出现异常，那么该消息就会丢失。如果设置了手动确认方式，则需要在业务处理成功后，调用 channel.basicAck()，手动签收，如果出现异常，则调用 channel.basicNack() 方法，让其自动重新发送消息。</p>
<p>消费者调用 <code>basicAck</code> 或者 <code>basicNack</code> 签收或拒绝</p>
<p>消息可靠性总结：</p>
<ol>
<li>持久化： exchange 要持久化，queue 要持久化， message 要持久化</li>
<li>生产者要 confirm</li>
<li>消费者要 ack</li>
<li>Broker 要高可用</li>
</ol>
<h2 id="消费端限流">消费端限流</h2>
<p>假设有一个场景：服务端挤压了大量的消息消息，此时启动消费者客户端，大量的消息会瞬间流入该客户端，可能会让客户端宕机。</p>
<p>当数据量特别大的时候，对生产者限制肯定是不科学的，这是用户的行为，我们应该对消费端限流。</p>
<p>RabbitMQ 提供了一种 qos（服务质量保证）功能，在非自动确认消息的前提下，如果一定数目的消息未被确认前，不消费新得消息</p>
<p>设置方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    * Request specific &#34;quality of service&#34; settings.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    *
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    * These settings impose limits on the amount of data the server
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    * will deliver to consumers before requiring acknowledgements.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    * Thus they provide a means of consumer-initiated flow control.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    * @see com.rabbitmq.client.AMQP.Basic.Qos
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    * @param prefetchSize maximum amount of content (measured in
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    * octets) that the server will deliver, 0 if unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    * @param prefetchCount maximum number of messages that the server
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    * will deliver, 0 if unlimited
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    * @param global true if the settings should be applied to the
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    * entire channel rather than each consumer
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    * @throws java.io.IOException if an error is encountered
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">    */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">void</span> <span style="color:#50fa7b">basicQos</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> prefetchSize<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">int</span> prefetchCount<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">boolean</span> global<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">;</span>
</span></span></code></pre></div><ul>
<li>prefetchSize: 每条消息得大小。0： 不限制 <strong>注意： RabbitMQ 没有实现这个功能</strong></li>
<li>prefetchCount: 一次性消费消息得数量，会告诉 RabbitMQ 不要同时个同一个客户端推送对于 N 个消息，也就是一旦超过 N 个消息美欧被 ack，则该客户端就会阻塞，知道有消息 ack</li>
<li>global: true / false 是否将上面得设置应用到 channel，简单得说上面得限制是 channel 级别还是某个消费者客户端级别。设置 false 的时候生效，<strong>因为 rabbitmq 没有实现 channel 级别的控制</strong></li>
</ul>
<p>在 sprinBoot 中，对客户端限流只需配置 <code>prefetch</code> 即可。和调用 <code>basicQos(0, N, false)</code> 效果一样</p>
<h2 id="ttl">TTL</h2>
<p>TTL 全称是 Time To Live （存活时间）, 当消息到达存活时间后还没有被消费就会自动清除，这与 redis 中的过期时间概念类似，我们应该合理应用 TTL，可以有效的处理过期的垃圾信息，从而降低服务器的负载。</p>
<p>RabbitMQ 既可以对单条消息设置存活时间，也可以对整个队列设置</p>
<h3 id="单条消息">单条消息</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>@Test
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">sendMsgWithTtl</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MessageProperties properties1 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> MessageProperties<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    properties1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setExpiration</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;6000&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    Message message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Message<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;你好&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(),</span>properties1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>RabbitMQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">EXCHANGE_NAME</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;boot.dc&#34;</span><span style="color:#ff79c6">,</span>message<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h3 id="整个队列设置-ttl">整个队列设置 TTL</h3>
<p>可以在后管设置：</p>
<p><img src="../../images/2023-04-12-22-47-56.png" alt=""></p>
<p>也可以在代码中设置：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#6272a4">// 2. 声明队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>@Bean<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootQueueTTL&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> Queue <span style="color:#50fa7b">bootQueue</span><span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>    Map<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">&gt;</span> arg <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    arg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;x-message-ttl&#34;</span><span style="color:#ff79c6">,</span><span style="color:#bd93f9">10000</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> QueueBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">durable</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootQueueTTL&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">withArguments</span><span style="color:#ff79c6">(</span>arg<span style="color:#ff79c6">).</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>后管查看结果：<br>
<img src="../../images/2023-04-12-22-52-23.png" alt=""></p>
<p><strong>如果两者都设置了 TTL 以短的时间为准</strong></p>
<h2 id="死信队列">死信队列</h2>
<p>没有被及时消费的消息将被投放到一个特殊队列，被称为死信队列</p>
<p>没有被及时消费的原因:</p>
<ol>
<li>消息被拒绝(basic.reject, basic.nack)， 并且不再重新投递，（requeue = false）</li>
<li>消息超时未被消费</li>
<li>队列长度达到最大</li>
</ol>
<h3 id="死信队列的实现步骤">死信队列的实现步骤</h3>
<p>声明队列Q的时候，在附加参数 <code>x-dead-letter-exchange</code> 指定交换器E的名称，只是声明，并非绑定。 它的含义是，当在队列Q上产生死信时，该消息会通过交换器 E 发走。<br>
就这么简单，至于 E 会把消息发送发送到哪里，就看交换器E绑定了哪些队列。<br>
<img src="../../images/2023-04-13-22-56-52.png" alt=""></p>
<p>代码示例:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 带有死信的队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String QUEUE_NAME_WITH_DEAD <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;boot_queue_with_dead&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 死信消息从正常队列中移除，通过该交换机进入死信队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// 和正常交换机没有差别，只不过被带有死信的队列指定了
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd;font-style:italic">final</span> String deadExchange <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;dead_exchange&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 死信队列,接收死信交换机过来的消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String deadQueue <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;dead_queue&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 声明死信交换器,和普通交换器一样
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>@Bean<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootDeadExchange&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> Exchange <span style="color:#50fa7b">bootDeadExchange</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> ExchangeBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">topicExchange</span><span style="color:#ff79c6">(</span>deadExchange<span style="color:#ff79c6">).</span><span style="color:#50fa7b">durable</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 声明接收死信的队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>@Bean<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootDeadQueue&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> Queue <span style="color:#50fa7b">bootDeadQueue</span><span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> QueueBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">durable</span><span style="color:#ff79c6">(</span>deadQueue<span style="color:#ff79c6">).</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 把接收死信的队列与死信交换器绑定
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>@Bean
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> Binding <span style="color:#50fa7b">bindWithDeadQueueExchange</span><span style="color:#ff79c6">(</span>@Qualifier<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootDeadQueue&#34;</span><span style="color:#ff79c6">)</span> Queue queue<span style="color:#ff79c6">,</span> @Qualifier<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootDeadExchange&#34;</span><span style="color:#ff79c6">)</span> Exchange exchange<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> BindingBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>queue<span style="color:#ff79c6">).</span><span style="color:#50fa7b">to</span><span style="color:#ff79c6">(</span>exchange<span style="color:#ff79c6">).</span><span style="color:#50fa7b">with</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;boot.#&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">noargs</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//********* 这才是死信队列的重要步骤 ***************
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// 声明带有死信的队列
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>@Bean<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootWithDeadQueue&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> Queue <span style="color:#50fa7b">bootWithDeadQueue</span><span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>    Map<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">&gt;</span> arg <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 声明接收死信消息的交换器
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// *****这一步很重要，可以让死信通过 deadExchange 发走****
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    arg<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;x-dead-letter-exchange&#34;</span><span style="color:#ff79c6">,</span>deadExchange<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> QueueBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">durable</span><span style="color:#ff79c6">(</span>QUEUE_NAME_WITH_DEAD<span style="color:#ff79c6">).</span><span style="color:#50fa7b">withArguments</span><span style="color:#ff79c6">(</span>arg<span style="color:#ff79c6">).</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 将带有死信的队列绑定到交换机上
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>@Bean
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> Binding <span style="color:#50fa7b">bindDeadQueueExchange</span><span style="color:#ff79c6">(</span>@Qualifier<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootWithDeadQueue&#34;</span><span style="color:#ff79c6">)</span> Queue queue<span style="color:#ff79c6">,</span> @Qualifier<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bootTopicExchange&#34;</span><span style="color:#ff79c6">)</span> Exchange exchange<span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> BindingBuilder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span>queue<span style="color:#ff79c6">).</span><span style="color:#50fa7b">to</span><span style="color:#ff79c6">(</span>exchange<span style="color:#ff79c6">).</span><span style="color:#50fa7b">with</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;boot.#&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">noargs</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// 发消息
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>@Test
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">sendDeadMsg</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MessageProperties properties <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> MessageProperties<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    properties<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setExpiration</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;6000&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    Message message <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Message<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;你好,6秒后我将要从列中移除，并进入死信队列&#34;</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(),</span>properties<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rabbitTemplate<span style="color:#ff79c6">.</span><span style="color:#50fa7b">convertAndSend</span><span style="color:#ff79c6">(</span>RabbitMQConfig<span style="color:#ff79c6">.</span><span style="color:#50fa7b">EXCHANGE_NAME</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;boot.hei&#34;</span><span style="color:#ff79c6">,</span>message<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>效果如下：</p>
<p><img src="../../images/2023-04-13-23-03-19.png" alt=""></p>
<p>六秒后:</p>
<p><img src="../../images/2023-04-13-23-03-48.png" alt=""></p>
<h2 id="延迟队列">延迟队列</h2>
<p>RabbitMQ 没有自己实现延迟队列，但是我们可以借助TTL 和死信队列完成延迟队列的功能。</p>
<ol>
<li>把需要延时处理的消息设置TTL,并发送到带有死信的队列中。</li>
<li>消费者监听死信队列</li>
</ol>
<h2 id="消息幂等设计">消息幂等设计</h2>
<p>幂等设计是一种设计思想，一次或多次请求同一个资源，对资源本身应该有同样的结果，也就是说任意执行多次对资源本身产生的影响与执行一次的影响相同</p>
<p>在MQ中，消费多条相同的消息应该与只消费一次带来的效果相同</p>
<p>可以采用乐观锁的方式实现消息幂等：</p>
<p>以sql 更新语句为例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#6272a4">-- version 某时刻等于 1
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">update</span> account <span style="color:#ff79c6">set</span> price <span style="color:#ff79c6">=</span> price <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">100</span>, <span style="color:#ff79c6">version</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">version</span> <span style="color:#ff79c6">+</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">where</span> id <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span> <span style="color:#ff79c6">and</span> <span style="color:#ff79c6">version</span>  <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span><span style="color:#6272a4">-- 把版本号作为更新语句的条件，同时版本号自增
</span></span></span></code></pre></div>
        </div>

        

        


        
        <footer class="article-footer">
            <ul class="article-tag-list">
                
                <li class="article-tag-list-item">
                    <a class="article-tag-list-link" href="https://dccmmtop.github.io/%20tags/rabbitmq">rabbitMQ
                    </a>
                </li>
                
            </ul>
        </footer>
        
    </div>
    
<nav id="article-nav">
    
    <a href="../../posts/%E5%B8%B8%E7%94%A8%E8%BD%AF%E4%BB%B6%E6%B8%85%E5%8D%95/" id="article-nav-newer" class="article-nav-link-wrap">
        <div class="article-nav-title"><span>&lt;</span>&nbsp;
            常用软件清单
        </div>
    </a>
    
    
    <a href="../../posts/mq%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%92%8C%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B/" id="article-nav-older" class="article-nav-link-wrap">
        <div class="article-nav-title">MQ 的基本概念和五种模式使用示例&nbsp;<span>&gt;</span></div>
    </a>
    
</nav>


</article>
            
        </section>

        <div>
            

            <script src="https://utteranc.es/client.js" repo="dccmmtop/dccmmtop.github.io" issue-term="pathname"
                label="Comment" theme="github-light" crossorigin="anonymous" async>
                </script>
            

        </div>

        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2023 dc
            <br />
            Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> with theme <a
                href="https://github.com/carsonip/hugo-theme-minos" target="_blank">Minos</a>


        </div>
    </div>
    

    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/tomorrow-night.min.css"
        integrity="sha256-2wL88NKUqvJi/ExflDzkzUumjUM73mcK2gBvBBeLvTk=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"
        integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    
    <script>
        document.getElementById('main-nav-toggle').addEventListener('click', function () {
            var header = document.getElementById('header');
            if (header.classList.contains('mobile-on')) {
                header.classList.remove('mobile-on');
            } else {
                header.classList.add('mobile-on');
            }
        });
    </script>
    <style>
        #footer-info {
            line-height: 1.4em;
            font-size: 10px;
        }

        .custom-blog-info {
            font-family: 'Long Cang', cursive;
            border-top: 1px dashed #333;
            font-size: 16px;
            margin-top: 10px;
            padding-top: 10px;
            line-height: 1.4em;
        }
    </style>
</footer>

    </div>
</body>

</html>