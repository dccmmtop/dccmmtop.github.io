[{"categories":null,"contents":" ç®€å•ç¤ºä¾‹ é¡¹ç›®ç»“æ„ ä¾èµ– é…ç½® ç”Ÿäº§è€… æ¶ˆè´¹è€… æ¶ˆæ¯çš„å¯é æŠ•é€’ç¤ºä¾‹ confirm return æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ æ¶ˆè´¹ç«¯é™æµ TTL å•æ¡æ¶ˆæ¯ æ•´ä¸ªé˜Ÿåˆ—è®¾ç½® TTL æ­»ä¿¡é˜Ÿåˆ— å»¶è¿Ÿé˜Ÿåˆ— æ¶ˆæ¯å¹‚ç­‰è®¾è®¡ ç®€å•ç¤ºä¾‹ é¡¹ç›®ç»“æ„ ä¾èµ– \u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-amqp\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;junit\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;junit\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;RELEASE\u0026lt;/version\u0026gt; \u0026lt;scope\u0026gt;compile\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; é…ç½® spring: rabbitmq: host: 127.0.0.1 port: 5672 username: dc password: Aa111111 virtual-host: /dc0407 # è®©å‘å¸ƒè€…å¯ä»¥æ”¶åˆ°æ¶ˆæ¯æ˜¯å¦æŠ•é€’æˆåŠŸçš„å›è°ƒ # é»˜è®¤æ˜¯ false publisher-confirms: true listener: simple: # æ¶ˆè´¹è€…å¼€å¯æ‰‹åŠ¨ç¡®è®¤æ¨¡å¼ï¼Œé»˜è®¤æ˜¯ none acknowledge-mode: manual # æ¯æ¬¡æ¶ˆè´¹ä¸€ä¸ª prefetch: 1 package io.dc.rabbitmqinspringboot.config; import org.springframework.amqp.core.*; import org.springframework.amqp.rabbit.config.SimpleRabbitListenerContainerFactory; import org.springframework.amqp.rabbit.connection.CachingConnectionFactory; import org.springframework.amqp.rabbit.connection.ConnectionFactory; import org.springframework.beans.factory.annotation.Qualifier; import org.springframework.beans.factory.annotation.Value; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; @Configuration public class RabbitMQConfig { public static final String EXCHANGE_NAME = \u0026#34;boot_topic_exchange\u0026#34;; public static final String QUEUE_NAME = \u0026#34;boot_queue\u0026#34;; // 1. å£°æ˜äº¤æ¢æœº @Bean(\u0026#34;bootTopicExchange\u0026#34;) public Exchange bootExchange(){ return ExchangeBuilder.topicExchange(EXCHANGE_NAME).durable(false).build(); } // 2. å£°æ˜é˜Ÿåˆ— @Bean(\u0026#34;bootQueue\u0026#34;) public Queue bootQueue(){ return QueueBuilder.durable(QUEUE_NAME).build(); } // 3. å°†é˜Ÿåˆ—ä¸äº¤æ¢å™¨è¿›è¡Œç»‘å®š @Bean public Binding bindQueueExchange(@Qualifier(\u0026#34;bootQueue\u0026#34;) Queue queue, @Qualifier(\u0026#34;bootTopicExchange\u0026#34;) Exchange exchange){ return BindingBuilder.bind(queue).to(exchange).with(\u0026#34;boot.#\u0026#34;).noargs(); } // è‡ªå®šä¹‰è¿æ¥å·¥å‚ï¼Œè‡ªç”±ç¨‹åº¦é«˜ï¼Œæœ¬æ¬¡æ¼”ç¤ºæ²¡ç”¨åˆ° @Bean(\u0026#34;customConnectionFactory\u0026#34;) public ConnectionFactory connectionFactory( @Value(\u0026#34;${spring.rabbitmq.host}\u0026#34;) String host, @Value(\u0026#34;${spring.rabbitmq.port}\u0026#34;) int port, @Value(\u0026#34;${spring.rabbitmq.username}\u0026#34;) String username, @Value(\u0026#34;${spring.rabbitmq.password}\u0026#34;) String password, @Value(\u0026#34;${spring.rabbitmq.virtual-host}\u0026#34;) String vhost ){ CachingConnectionFactory factory = new CachingConnectionFactory(); factory.setHost(host); factory.setPort(port); factory.setUsername(username); factory.setPassword(password); factory.setVirtualHost(vhost); return factory; } // è‡ªå®šä¹‰æ¶ˆæ¯ç›‘å¬å™¨å·¥å‚ï¼Œè‡ªç”±ç¨‹åº¦é«˜ @Bean(name = \u0026#34;customListenFactory\u0026#34;) public SimpleRabbitListenerContainerFactory listenerContainerFactory(@Qualifier(\u0026#34;customConnectionFactory\u0026#34;) ConnectionFactory connectionFactory){ SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory(); factory.setConnectionFactory(connectionFactory); // è®¾ç½®æ‰‹åŠ¨ç­¾æ”¶ factory.setAcknowledgeMode(AcknowledgeMode.MANUAL); // è®¾ç½®é¢„å¤„ç†æ•°é‡ï¼ŒåŒæ—¶æ²¡æœ‰ç¡®è®¤çš„æ¶ˆæ¯ä¸èƒ½è¶…è¿‡ N ä¸ªï¼Œèµ·åˆ°æ¶ˆè´¹è€…é™æµçš„ä½œç”¨ï¼Œè¯¦ç»†è§£é‡Šè§ä¸‹ factory.setPrefetchCount(5); return factory; } } ç”Ÿäº§è€… åœ¨æµ‹è¯•ç±»ä¸­å‘æ¶ˆæ¯\npackage io.dc.rabbitmqinspringboot; import io.dc.rabbitmqinspringboot.config.RabbitMQConfig; import org.junit.Test; import org.junit.runner.RunWith; import org.springframework.amqp.core.Message; import org.springframework.amqp.rabbit.connection.CorrelationData; import org.springframework.amqp.rabbit.core.RabbitTemplate; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.boot.test.context.SpringBootTest; import org.springframework.test.context.junit4.SpringJUnit4ClassRunner; @SpringBootTest @RunWith(SpringJUnit4ClassRunner.class) public class RabbitMqInSpringBootApplicationTests { @Autowired RabbitTemplate rabbitTemplate; // å‘ä¸€æ¬¡æ¶ˆæ¯ @Test public void sendMsg() { rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_NAME,\u0026#34;boot.dc\u0026#34;,\u0026#34;ä½ å¥½ rabbitMQ\u0026#34;); } // æ‰¹é‡å‘æ¶ˆæ¯ @Test public void sendBatchMsg() { for (int i = 0; i \u0026lt; 10; i++) { rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_NAME,\u0026#34;boot.dc\u0026#34;,\u0026#34;ä½ å¥½ rabbitMQ\u0026#34;); } } } æ¶ˆè´¹è€… ç®€å•ç‰ˆï¼Œè‡ªåŠ¨ ack\npackage io.dc.rabbitmqinspringboot.consumer; import io.dc.rabbitmqinspringboot.config.RabbitMQConfig; import org.springframework.amqp.rabbit.annotation.RabbitListener; import org.springframework.stereotype.Component; import org.springframework.amqp.core.Message; @Component public class Consumer1 { @RabbitListener(queues = RabbitMQConfig.QUEUE_NAME) public void listenerQueue(Message message){ System.out.println(\u0026#34;æ¶ˆè´¹è€… 1 æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š\u0026#34;+ message); } } æ‰‹åŠ¨ ack:\néœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é¢å¤–è®¾ç½®ä¸ºæ‰‹åŠ¨ç¡®è®¤ï¼šmanual\npackage io.dc.rabbitmqinspringboot.consumer; import com.rabbitmq.client.Channel; import io.dc.rabbitmqinspringboot.config.RabbitMQConfig; import org.springframework.amqp.core.Message; import org.springframework.amqp.rabbit.annotation.RabbitListener; import org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener; import org.springframework.stereotype.Component; @Component public class Consumer2 { // ä¹Ÿå¯ä»¥é‡‡ç”¨è‡ªå®šä¹‰ç›‘å¬å·¥å‚ // @RabbitListener(queues = RabbitMQConfig.QUEUE_NAME, containerFactory = \u0026#34;customListenFactory\u0026#34;) @RabbitListener(queues = RabbitMQConfig.QUEUE_NAME) public void onMessage(Message message, Channel channel) throws Exception { System.out.println(\u0026#34;æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼š\u0026#34; + new String(message.getBody())); long deliveryTag = message.getMessageProperties().getDeliveryTag(); System.out.println(\u0026#34;æ¶ˆæ¯ Id: \u0026#34; + deliveryTag); // è¿›è¡Œæ¶ˆæ¯ç­¾æ”¶ï¼Œå¦‚æœä¸ç­¾æ”¶ï¼Œå°†åªä¼šæ”¶åˆ° ${listener.simple.prefetch} ä¸ªæ¶ˆæ¯ï¼Œå› ä¸ºè®¾ç½®äº†æ‰‹åŠ¨ç­¾æ”¶æ¨¡å¼ channel.basicAck(deliveryTag, true); // æ‹’ç»ç­¾æ”¶ // æœ€åä¸€ä¸ªå‚æ•°ï¼š æ˜¯å¦é‡å›é˜Ÿåˆ— // channel.basicNack(deliveryTag,false, false); } } æ¶ˆæ¯çš„å¯é æŠ•é€’ç¤ºä¾‹ åœ¨ RabbitMQ çš„åŸºæœ¬æ¦‚å¿µå’Œäº”ç§æ¨¡å¼ä½¿ç”¨ç¤ºä¾‹ ä¸­å·²ç»ä»‹ç»äº†ä¸¤ç§å®ç°å¯é æŠ•é€’çš„æœºåˆ¶ï¼Œè¿™é‡Œä»…ä½œä¸ºä¸€ä¸ªå®Œæ•´çš„è¡¥å……ï¼š\nconfirm @Test public void testConfirm(){ rabbitTemplate.setConfirmCallback(new RabbitTemplate.ConfirmCallback() { @Override public void confirm(CorrelationData correlationData, boolean b, String s) { System.out.println(\u0026#34;æ‰§è¡Œäº† confirm æ–¹æ³•ã€‚..\u0026#34;); if(b){ System.out.println(\u0026#34;å‘é€æˆåŠŸ\u0026#34;); }else{ System.out.println(\u0026#34;å‘é€å¤±è´¥ï¼š\u0026#34; + s); } } }); // æ­£å¸¸ rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_NAME,\u0026#34;boot.dc\u0026#34;,\u0026#34;ä½ å¥½ rabbitMQ\u0026#34;); // é”™è¯¯çš„äº¤æ¢å™¨ã€‚ä¼šæ‰“å°å‘é€å¤±è´¥ rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_NAME + \u0026#34;111\u0026#34;,\u0026#34;boot.dc\u0026#34;,\u0026#34;ä½ å¥½ rabbitMQ\u0026#34;); try { Thread.sleep(5000); } catch (InterruptedException e) { throw new RuntimeException(e); } } return @Test public void testReturn(){ // åªæœ‰è®¾ç½® trueï¼Œæ¶ˆæ¯æ— æ³•åˆ°è¾¾é˜Ÿåˆ—æ—¶ï¼Œæ‰ä¼šé€€å›ç»™ç”Ÿäº§è€… rabbitTemplate.setMandatory(true); rabbitTemplate.setReturnCallback(new RabbitTemplate.ReturnCallback() { /** * * @param message the returned message. * @param replyCode the reply code. * @param replyText the reply text. * @param exchange the exchange. * @param routingKey the routing key. */ @Override public void returnedMessage(Message message, int replyCode, String replyText, String exchange, String routingKey) { System.out.println(\u0026#34;æ¶ˆæ¯é€€å›äº†~\u0026#34;); System.out.println(\u0026#34;message: \u0026#34; + message.toString()); System.out.println(\u0026#34;replyCode: \u0026#34; + replyCode); System.out.println(\u0026#34;replyText: \u0026#34; + replyText); System.out.println(\u0026#34;exchange: \u0026#34; + exchange); System.out.println(\u0026#34;routingKey: \u0026#34; + routingKey); } }); // æ­£å¸¸ rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_NAME,\u0026#34;boot.dc\u0026#34;,\u0026#34;ä½ å¥½ rabbitMQ\u0026#34;); // é”™è¯¯çš„è·¯ç”± keyã€‚æ¶ˆæ¯ä¼šè¢«é€€å› rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_NAME,\u0026#34;1111_boot.dc\u0026#34;,\u0026#34;ä½ å¥½ rabbitMQ\u0026#34;); try { Thread.sleep(5000); } catch (InterruptedException e) { throw new RuntimeException(e); } } æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶ Ack æŒ‡çš„æ˜¯ ack æŒ‡ Acknowledgeï¼Œç¡®è®¤ã€‚ è¡¨ç¤ºæ¶ˆè´¹ç«¯æ”¶åˆ°æ¶ˆæ¯åçš„ç¡®è®¤æ–¹å¼ã€‚\næœ‰ä¸‰ç§ç¡®è®¤æ–¹å¼ï¼š\nè‡ªåŠ¨ç¡®è®¤ acknowledge = none æ‰‹åŠ¨ç¡®è®¤ acknowledge = manual æ ¹æ®å¼‚å¸¸æƒ…å†µç¡®è®¤ acknowledge = auto è¿™ç§æƒ…å†µä½¿ç”¨éº»çƒ¦ï¼Œä¸€èˆ¬ä¸ç”¨ å…¶ä¸­è‡ªåŠ¨ç¡®è®¤æ˜¯æŒ‡ï¼Œå½“æ¶ˆæ¯ä¸€æ—¦è¢« Consumer æ¥æ”¶åˆ°ï¼Œåˆ™è‡ªåŠ¨ç¡®è®¤æ”¶åˆ°ï¼Œå¹¶å°†ç›¸åº” message ä» RabbitMQ çš„æ¶ˆæ¯ç¼“å­˜ä¸­ç§»é™¤ã€‚ä½†æ˜¯åœ¨å®é™…ä¸šåŠ¡å¤„ç†ä¸­ï¼Œå¾ˆå¯èƒ½æ¶ˆæ¯æ¥æ”¶åˆ°ï¼Œä¸šåŠ¡å¤„ç†å‡ºç°å¼‚å¸¸ï¼Œé‚£ä¹ˆè¯¥æ¶ˆæ¯å°±ä¼šä¸¢å¤±ã€‚å¦‚æœè®¾ç½®äº†æ‰‹åŠ¨ç¡®è®¤æ–¹å¼ï¼Œåˆ™éœ€è¦åœ¨ä¸šåŠ¡å¤„ç†æˆåŠŸåï¼Œè°ƒç”¨ channel.basicAck()ï¼Œæ‰‹åŠ¨ç­¾æ”¶ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ï¼Œåˆ™è°ƒç”¨ channel.basicNack() æ–¹æ³•ï¼Œè®©å…¶è‡ªåŠ¨é‡æ–°å‘é€æ¶ˆæ¯ã€‚\næ¶ˆè´¹è€…è°ƒç”¨ basicAck æˆ–è€… basicNack ç­¾æ”¶æˆ–æ‹’ç»\næ¶ˆæ¯å¯é æ€§æ€»ç»“ï¼š\næŒä¹…åŒ–ï¼š exchange è¦æŒä¹…åŒ–ï¼Œqueue è¦æŒä¹…åŒ–ï¼Œ message è¦æŒä¹…åŒ– ç”Ÿäº§è€…è¦ confirm æ¶ˆè´¹è€…è¦ ack Broker è¦é«˜å¯ç”¨ æ¶ˆè´¹ç«¯é™æµ å‡è®¾æœ‰ä¸€ä¸ªåœºæ™¯ï¼šæœåŠ¡ç«¯æŒ¤å‹äº†å¤§é‡çš„æ¶ˆæ¯æ¶ˆæ¯ï¼Œæ­¤æ—¶å¯åŠ¨æ¶ˆè´¹è€…å®¢æˆ·ç«¯ï¼Œå¤§é‡çš„æ¶ˆæ¯ä¼šç¬é—´æµå…¥è¯¥å®¢æˆ·ç«¯ï¼Œå¯èƒ½ä¼šè®©å®¢æˆ·ç«¯å®•æœºã€‚\nå½“æ•°æ®é‡ç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œå¯¹ç”Ÿäº§è€…é™åˆ¶è‚¯å®šæ˜¯ä¸ç§‘å­¦çš„ï¼Œè¿™æ˜¯ç”¨æˆ·çš„è¡Œä¸ºï¼Œæˆ‘ä»¬åº”è¯¥å¯¹æ¶ˆè´¹ç«¯é™æµã€‚\nRabbitMQ æä¾›äº†ä¸€ç§ qosï¼ˆæœåŠ¡è´¨é‡ä¿è¯ï¼‰åŠŸèƒ½ï¼Œåœ¨éè‡ªåŠ¨ç¡®è®¤æ¶ˆæ¯çš„å‰æä¸‹ï¼Œå¦‚æœä¸€å®šæ•°ç›®çš„æ¶ˆæ¯æœªè¢«ç¡®è®¤å‰ï¼Œä¸æ¶ˆè´¹æ–°å¾—æ¶ˆæ¯\nè®¾ç½®æ–¹æ³•ï¼š\n/** * Request specific \u0026#34;quality of service\u0026#34; settings. * * These settings impose limits on the amount of data the server * will deliver to consumers before requiring acknowledgements. * Thus they provide a means of consumer-initiated flow control. * @see com.rabbitmq.client.AMQP.Basic.Qos * @param prefetchSize maximum amount of content (measured in * octets) that the server will deliver, 0 if unlimited * @param prefetchCount maximum number of messages that the server * will deliver, 0 if unlimited * @param global true if the settings should be applied to the * entire channel rather than each consumer * @throws java.io.IOException if an error is encountered */ void basicQos(int prefetchSize, int prefetchCount, boolean global) throws IOException; prefetchSize: æ¯æ¡æ¶ˆæ¯å¾—å¤§å°ã€‚0ï¼š ä¸é™åˆ¶ æ³¨æ„ï¼š RabbitMQ æ²¡æœ‰å®ç°è¿™ä¸ªåŠŸèƒ½ prefetchCount: ä¸€æ¬¡æ€§æ¶ˆè´¹æ¶ˆæ¯å¾—æ•°é‡ï¼Œä¼šå‘Šè¯‰ RabbitMQ ä¸è¦åŒæ—¶ä¸ªåŒä¸€ä¸ªå®¢æˆ·ç«¯æ¨é€å¯¹äº N ä¸ªæ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯ä¸€æ—¦è¶…è¿‡ N ä¸ªæ¶ˆæ¯ç¾æ¬§è¢« ackï¼Œåˆ™è¯¥å®¢æˆ·ç«¯å°±ä¼šé˜»å¡ï¼ŒçŸ¥é“æœ‰æ¶ˆæ¯ ack global: true / false æ˜¯å¦å°†ä¸Šé¢å¾—è®¾ç½®åº”ç”¨åˆ° channelï¼Œç®€å•å¾—è¯´ä¸Šé¢å¾—é™åˆ¶æ˜¯ channel çº§åˆ«è¿˜æ˜¯æŸä¸ªæ¶ˆè´¹è€…å®¢æˆ·ç«¯çº§åˆ«ã€‚è®¾ç½® false çš„æ—¶å€™ç”Ÿæ•ˆï¼Œå› ä¸º rabbitmq æ²¡æœ‰å®ç° channel çº§åˆ«çš„æ§åˆ¶ åœ¨ sprinBoot ä¸­ï¼Œå¯¹å®¢æˆ·ç«¯é™æµåªéœ€é…ç½® prefetch å³å¯ã€‚å’Œè°ƒç”¨ basicQos(0, N, false) æ•ˆæœä¸€æ ·\nTTL TTL å…¨ç§°æ˜¯ Time To Live ï¼ˆå­˜æ´»æ—¶é—´ï¼‰, å½“æ¶ˆæ¯åˆ°è¾¾å­˜æ´»æ—¶é—´åè¿˜æ²¡æœ‰è¢«æ¶ˆè´¹å°±ä¼šè‡ªåŠ¨æ¸…é™¤ï¼Œè¿™ä¸ redis ä¸­çš„è¿‡æœŸæ—¶é—´æ¦‚å¿µç±»ä¼¼ï¼Œæˆ‘ä»¬åº”è¯¥åˆç†åº”ç”¨ TTLï¼Œå¯ä»¥æœ‰æ•ˆçš„å¤„ç†è¿‡æœŸçš„åƒåœ¾ä¿¡æ¯ï¼Œä»è€Œé™ä½æœåŠ¡å™¨çš„è´Ÿè½½ã€‚\nRabbitMQ æ—¢å¯ä»¥å¯¹å•æ¡æ¶ˆæ¯è®¾ç½®å­˜æ´»æ—¶é—´ï¼Œä¹Ÿå¯ä»¥å¯¹æ•´ä¸ªé˜Ÿåˆ—è®¾ç½®\nå•æ¡æ¶ˆæ¯ @Test public void sendMsgWithTtl() { MessageProperties properties1 = new MessageProperties(); properties1.setExpiration(\u0026#34;6000\u0026#34;); Message message = new Message(\u0026#34;ä½ å¥½\u0026#34;.getBytes(),properties1); rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE_NAME,\u0026#34;boot.dc\u0026#34;,message); } æ•´ä¸ªé˜Ÿåˆ—è®¾ç½® TTL å¯ä»¥åœ¨åç®¡è®¾ç½®ï¼š\nä¹Ÿå¯ä»¥åœ¨ä»£ç ä¸­è®¾ç½®ï¼š\n// 2. å£°æ˜é˜Ÿåˆ— @Bean(\u0026#34;bootQueueTTL\u0026#34;) public Queue bootQueue(){ Map\u0026lt;String, Object\u0026gt; arg = new HashMap\u0026lt;\u0026gt;(); arg.put(\u0026#34;x-message-ttl\u0026#34;,10000); return QueueBuilder.durable(\u0026#34;bootQueueTTL\u0026#34;).withArguments(arg).build(); } åç®¡æŸ¥çœ‹ç»“æœï¼š\nå¦‚æœä¸¤è€…éƒ½è®¾ç½®äº† TTL ä»¥çŸ­çš„æ—¶é—´ä¸ºå‡†\næ­»ä¿¡é˜Ÿåˆ— TODO\nå»¶è¿Ÿé˜Ÿåˆ— TODO\næ¶ˆæ¯å¹‚ç­‰è®¾è®¡ TODO\n","date":"2023-04-12T11:33:58Z","permalink":"https://dccmmtop.github.io/posts/springboot%E4%B8%8Erabbitmq%E9%9B%86%E6%88%90%E5%92%8C%E9%AB%98%E7%BA%A7%E7%94%A8%E6%B3%95/","section":"posts","tags":["rabbitMQ"],"title":"SpringBoot ä¸ RabbitMQ é›†æˆå’Œé«˜çº§ç”¨æ³•"},{"categories":null,"contents":"æ¦‚å¿µ MQ å…¨ç§° Message Queueï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼Œæ˜¯åœ¨æ¶ˆæ¯çš„ä¼ è¾“è¿‡ç¨‹ä¸­ä¿å­˜æ¶ˆæ¯çš„å®¹å™¨ã€‚å¤šç”¨äºåˆ†å¸ƒå¼ç³»ç»Ÿä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚\næ—  MQ\næœ‰ MQ\nä¼˜åŠ¿ åº”ç”¨è§£è€¦ ç³»ç»Ÿçš„è€¦åˆæ€§è¶Šé«˜ï¼Œå®¹é”™æ€§å°±è¶Šä½ï¼Œå¯ç»´æŠ¤æ€§å°±è¶Šä½\nå¼‚æ­¥æé€Ÿ å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨æ²¡æœ‰ MQ çš„æƒ…å†µä¸‹ï¼Œè®¢å•ç³»ç»Ÿéœ€è¦ç­‰å¾…å…¶ä»–ä¸‹æ¸¸ç³»ç»Ÿçš„åé¦ˆã€‚æ€»è€—æ—¶ï¼š 20 + 300 + 300 + 300 = 920ms\nåŠ å…¥ MQ åï¼Œåªéœ€æŠŠä»»åŠ¡äº¤ç»™ MQ, ç„¶åè®© MQ ç»™ä¸‹æ¸¸ç³»ç»Ÿåˆ†å‘ä»»åŠ¡ï¼š\nç”¨æˆ·ç‚¹å‡»å®Œä¸‹å•æŒ‰é’®åï¼Œåªéœ€ç­‰å¾… 25ms å°±èƒ½å¾—åˆ°ä¸‹å•å“åº” (20 + 5 = 25ms)ã€‚\næå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿååé‡ï¼ˆå•ä½æ—¶é—´å†…å¤„ç†è¯·æ±‚çš„æ•°ç›®ï¼‰ã€‚\nå‰Šå³°å¡«è°· å‡è®¾ç³»ç»Ÿæ¯ç§’æœ€å¤§èƒ½æ¥å— 1000 ä¸ªè¯·æ±‚ï¼Œçªç„¶æ¥äº† 5000 ä¸ªè¯·æ±‚ï¼Œé«˜å¹¶å‘ä¸‹å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡ä¸å¯ç”¨ï¼š\nåœ¨ç”¨æˆ·è¯·æ±‚å’ŒæœåŠ¡å™¨ä¹‹é—´åŠ å…¥ä¸€å±‚ MQ:\nä½¿ç”¨äº† MQ ä¹‹åï¼Œé™åˆ¶æ¶ˆè´¹æ¶ˆæ¯çš„é€Ÿåº¦ä¸º 1000ï¼Œè¿™æ ·ä¸€æ¥ï¼Œé«˜å³°æœŸäº§ç”Ÿçš„æ•°æ®åŠ¿å¿…ä¼šè¢«ç§¯å‹åœ¨ MQ ä¸­ï¼Œé«˜å³°å°±è¢«â€œå‰Šâ€æ‰äº†ï¼Œä½†æ˜¯å› ä¸ºæ¶ˆæ¯ç§¯å‹ï¼Œåœ¨é«˜å³°æœŸè¿‡åçš„ä¸€æ®µæ—¶é—´å†…ï¼Œæ¶ˆè´¹æ¶ˆæ¯çš„é€Ÿåº¦è¿˜æ˜¯ä¼šç»´æŒåœ¨ 1000ï¼Œç›´åˆ°æ¶ˆè´¹å®Œç§¯å‹çš„æ¶ˆæ¯ï¼Œè¿™å°±å«åšâ€œå¡«è°·â€ã€‚\nä½¿ç”¨ MQ åï¼Œå¯ä»¥æé«˜ç³»ç»Ÿç¨³å®šæ€§ã€‚\nåŠ£åŠ¿ é™ä½ç³»ç»Ÿçš„å¯ç”¨æ€§ ç³»ç»Ÿå¼•å…¥çš„å¤–éƒ¨ä¾èµ–è¶Šå¤šï¼Œç³»ç»Ÿçš„ç¨³å®šæ€§è¶Šå·®ï¼Œä¸€æ—¦ MQ å®•æœºï¼Œæœºä¼šå¯¹ä¸šåŠ¡é€ æˆå½±å“ï¼Œéœ€è¦é¢å¤–å¯è™‘ MQ çš„é«˜å¯ç”¨\næé«˜ç³»ç»Ÿçš„å¤æ‚æ€§ MQ çš„åŠ å…¥å¤§å¤§å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œä»¥å‰ç³»ç»Ÿé—´æ˜¯åŒæ­¥çš„è¿œç¨‹è°ƒç”¨ï¼Œç°åœ¨æ˜¯é€šè¿‡ MQ è¿›è¡Œå¼‚æ­¥è°ƒç”¨ã€‚éœ€è¦è€ƒè™‘æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µ\nå¸¸è§çš„ MQ äº§å“ RabbitMQ ç®€ä»‹ 2007 å¹´ï¼ŒRabbit æŠ€æœ¯å…¬å¸åŸºäº AMQP æ ‡å‡†å¼€å‘çš„ RabbitMQ 1.0 å‘å¸ƒã€‚RabbitMQ é‡‡ç”¨ Erlang è¯­è¨€å¼€å‘ã€‚Erlang è¯­è¨€ç”± Ericson è®¾è®¡ï¼Œä¸“é—¨ä¸ºå¼€å‘é«˜å¹¶å‘å’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€ç§è¯­è¨€ï¼Œåœ¨ç”µä¿¡é¢†åŸŸä½¿ç”¨å¹¿æ³›ã€‚\nAMQP å³ Advanced Message Queuing Protocolï¼ˆé«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼‰ï¼Œæ˜¯ä¸€ä¸ªç½‘ç»œåè®®ï¼Œæ˜¯åº”ç”¨å±‚åè®®çš„ä¸€ä¸ªå¼€æ”¾æ ‡å‡†ï¼Œä¸ºé¢å‘æ¶ˆæ¯çš„ä¸­é—´ä»¶è®¾è®¡ã€‚åŸºäºæ­¤åè®®çš„å®¢æˆ·ç«¯ä¸æ¶ˆæ¯ä¸­é—´ä»¶å¯ä¼ é€’æ¶ˆæ¯ï¼Œå¹¶ä¸å—å®¢æˆ·ç«¯/ä¸­é—´ä»¶ä¸åŒäº§å“ï¼Œä¸åŒçš„å¼€å‘è¯­è¨€ç­‰æ¡ä»¶çš„é™åˆ¶\næ¶æ„å›¾ å›¾ä¸­æ¶‰åŠçš„å‡ ä¸ªæ¦‚å¿µï¼š\nBroker æ¥æ”¶å’Œåˆ†å‘æ¶ˆæ¯çš„åº”ç”¨ï¼ŒRabbitMQ Server å°±æ˜¯ Message Broker\nVirtual host è™šæ‹Ÿæœº\nå‡ºäºå¤šç§Ÿæˆ·å’Œå®‰å…¨å› ç´ è€ƒè™‘è€Œè®¾è®¡çš„ï¼ŒæŠŠ AMQP çš„åŸºæœ¬ç»„ä»¶åˆ’åˆ†åˆ°ä¸€ä¸ªè™šæ‹Ÿçš„åˆ†ç»„ä¸­ï¼Œç±»ä¼¼ä¸ç½‘ç»œä¸­çš„ namespace æ¦‚å¿µï¼Œå½“ä¸åŒçš„ç”¨æˆ·ä½¿ç”¨åŒä¸€ä¸ª MQ æœåŠ¡æ—¶ï¼Œå¯ä»¥åˆ’åˆ†å¤šä¸ª vhost\nConnection å°±æ˜¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸ MQ æœåŠ¡å™¨ä¹‹é—´çš„ TCP é“¾æ¥\nChannel å¦‚æœæ¯ä¸€æ¬¡è®¿é—®éƒ½å»ºç«‹ä¸€ä¸ª connection, åœ¨æ¶ˆæ¯é‡å¤§çš„æ—¶å€™å»ºç«‹ TCP é“¾æ¥å¯¹ç³»ç»Ÿèµ„æºçš„æ¶ˆè€—å°†æ˜¯å·¨å¤§çš„ï¼ŒChannel æ˜¯ Connection å†…éƒ¨å»ºç«‹çš„é€»è¾‘é“¾æ¥ï¼Œé€šå¸¸æ¯ä¸ªçº¿ç¨‹ä¼šå•ç‹¬åˆ›å»º Channel ä¸æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨è¿›è¡Œé€šè®¯ï¼Œæ¯ä¸ª channel éƒ½æœ‰å”¯ä¸€æ ‡è¯†ï¼Œä»–ä»¬ä¹‹é—´æ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œå¯ä»¥æŠŠ channel ç†è§£ä¸ºè½»é‡çº§çš„ connectionã€‚æå¤§çš„å‡å°‘äº†æ“ä½œç³»ç»Ÿå»ºç«‹ TCP é“¾æ¥çš„å¼€é”€ã€‚\nExchange äº¤æ¢å™¨\næ˜¯æ¶ˆæ¯åˆ°è¾¾æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡çš„ç¬¬ä¸€ç«™ï¼Œå¯ä»¥æ ¹æ®åˆ†å‘è§„åˆ™æŠŠæ¶ˆæ¯åˆ†å‘ä¸åŒçš„é˜Ÿåˆ—ä¸­å»ã€‚\näº¤æ¢å™¨ä¸åƒé˜Ÿåˆ—é‚£æ ·æœ‰çœŸå®çš„è¿›ç¨‹ï¼Œ å®ƒåªæ˜¯ä¸€å¼ åç§°ä¸é˜Ÿåˆ—è¿›ç¨‹ PID çš„å…³ç³»è¡¨\nå½“ä½ å°†æ¶ˆæ¯å‘å¸ƒåˆ°äº¤æ¢å™¨æ—¶ï¼Œå®é™…ä¸Šæ˜¯ç”±ä½ æ‰€è¿æ¥åˆ°çš„ä¿¡é“å°†æ¶ˆæ¯ä¸Šçš„è·¯ç”±é”®åŒäº¤æ¢å™¨çš„ç»‘å®šåˆ—è¡¨è¿›è¡Œæ¯”è¾ƒï¼Œç„¶åè·¯ç”±æ¶ˆæ¯ã€‚æ­£æ˜¯ä¿¡é“ï¼ˆchannelï¼‰æŒ‰ç…§ç»‘å®šåŒ¹é…çš„ç»“æœï¼Œå°†æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—ã€‚ ä¿¡é“æ‰æ˜¯çœŸæ­£çš„è·¯ç”±å™¨\nç”±äºäº¤æ¢å™¨åªæ˜¯ä¸€å¼ è¡¨ï¼Œå› æ­¤å°†äº¤æ¢å™¨åœ¨æ•´ä¸ªé›†ç¾¤ä¸­è¿›è¡Œå¤åˆ¶ï¼Œæ›´åŠ ç®€å•\nä¸¾ä¾‹æ¥è¯´ï¼Œå½“åˆ›å»ºä¸€ä¸ªæ–°çš„äº¤æ¢å™¨æ—¶ï¼ŒRabbitMQ æ‰€è¦åšçš„æ˜¯å°†æŸ¥è¯¢è¡¨æ·»åŠ åˆ°é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šã€‚è¿™æ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„æ¯æ¡ä¿¡é“éƒ½å¯ä»¥è®¿é—®åˆ°æ–°çš„äº¤æ¢å™¨äº†ã€‚å› æ­¤ï¼Œç›¸å¯¹äºé»˜è®¤æƒ…å†µä¸‹é˜Ÿåˆ—çš„å®Œæ•´ä¿¡æ¯å­˜åœ¨äºé›†ç¾¤ä¸­çš„å•ä¸€èŠ‚ç‚¹æ¥è¯´ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ‹¥æœ‰æ¯ä¸ªäº¤æ¢å™¨çš„æ‰€æœ‰ä¿¡æ¯ã€‚å°±å¯ç”¨æ€§æ¥è®²ï¼Œè¿™éå¸¸æ£’ï¼Œå› ä¸ºè¿™æ„å‘³ç€ä½ ä¸ç”¨æ‹…å¿ƒåœ¨èŠ‚ç‚¹æ•…éšœæ—¶é‡æ–°å£°æ˜äº¤æ¢å™¨ã€‚åªéœ€è®©æ•…éšœèŠ‚ç‚¹ä¸Šçš„ç”Ÿäº§è€…é‡æ–°è¿æ¥åˆ°é›†ç¾¤ä¸Šï¼Œå®ƒä»¬ç«‹å³å°±èƒ½å¼€å§‹å¾€äº¤æ¢å™¨ä¸Šå‘å¸ƒæ¶ˆæ¯äº†ã€‚\nQueue é˜Ÿåˆ—\næ¶ˆæ¯æœ€ç»ˆè¢«é€è¾¾åˆ°è¿™é‡Œï¼Œç­‰å¾…è¢«æ¶ˆè´¹è€…å–èµ°ã€‚\nBinding ç»‘å®š\näº¤æ¢å™¨å’Œé˜Ÿåˆ—ä¹‹é—´çš„è™šæ‹Ÿè¿æ¥ï¼Œå…¶å®å°±æ˜¯è¿™ä¸¤è€…ä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚\nå¸¸ç”¨çš„äº”å·¥ä½œæ¨¡å¼ ç®€å•æ¨¡å¼ æœ€ç®€å•çš„å·¥ä½œæ¨¡å¼ï¼ŒåªåŒ…å«ä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ã€‚è¿™ç§æ¨¡å¼ä¸‹ä¸è¦æŒ‡å®šäº¤æ¢å™¨ï¼Œä½¿ç”¨é»˜è®¤çš„å³å¯ï¼Œå¦‚ä¸‹å›¾ï¼š\njava ä»£ç å±•ç¤ºï¼š\nä¾èµ–\n\u0026lt;dependencies\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.rabbitmq\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;amqp-client\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;5.3.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;/dependencies\u0026gt; rabbitmq è¿æ¥å·¥å…·ç±»\nimport com.rabbitmq.client.Connection; import com.rabbitmq.client.ConnectionFactory; public class RabbitUtils { private static ConnectionFactory connectionFactory = new ConnectionFactory(); static { connectionFactory.setHost(\u0026#34;127.0.0.1\u0026#34;); // é»˜è®¤ç«¯å£å· connectionFactory.setPort(5672); connectionFactory.setUsername(\u0026#34;dc\u0026#34;); connectionFactory.setPassword(\u0026#34;Aa111111\u0026#34;); // è®¾ç½®è¦è¿æ¥çš„è™šæœº connectionFactory.setVirtualHost(\u0026#34;/dc0407\u0026#34;); } public static Connection getConnection(){ Connection connection = null; try { connection = connectionFactory.newConnection(); return connection; } catch (Exception e) { throw new RuntimeException(e); } } } ç”Ÿäº§è€…\nimport com.rabbitmq.client.Channel; import com.rabbitmq.client.Connection; import org.example.util.RabbitUtils; import java.io.IOException; import java.util.concurrent.TimeoutException; /** * ç”Ÿäº§è€… */ public class Producer { public static void main(String[] args) throws IOException, TimeoutException, InterruptedException { // è·å¾—è¿æ¥ Connection connection = RabbitUtils.getConnection(); // è·å¾— channel Channel channel = connection.createChannel(); String queueName = \u0026#34;hello\u0026#34;; // å£°æ˜é˜Ÿåˆ—å¹¶åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ— // ç¬¬ä¸€ä¸ªå‚æ•°ï¼š é˜Ÿåˆ—åç§° // ç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦æŒä¹…åŒ–é˜Ÿåˆ—ï¼Œä¸æŒä¹…åŒ–é˜Ÿåˆ—æ—¶ï¼ŒMQ é‡å¯åï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šä¸¢å¤± // ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ˜¯å¦ç§æœ‰åŒ–é˜Ÿåˆ—ï¼Œfalse ä»£è¡¨æ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¯ä»¥è®¿é—®ï¼Œtrue ä»£è¡¨åªæœ‰ç¬¬ä¸€æ¬¡æ‹¥æœ‰å®ƒçš„æ¶ˆè´¹è€…æ‰èƒ½è®¿é—® // ç¬¬å››ä¸ªå‚æ•°ï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œfalse ä»£è¡¨è¿æ¥åœæ‰åä¸è‡ªåŠ¨åˆ é™¤è¿™ä¸ªé˜Ÿåˆ— // å…¶ä»–é¢å¤–å‚æ•°ï¼š null channel.queueDeclare(queueName,false,false,false, null); // å‘é€æ¶ˆæ¯ String msg = \u0026#34;ä½ å¥½ dc\u0026#34;; // äº¤æ¢æœºï¼š ç®€å•æ¨¡å¼ä¸‹ç”¨ä¸åˆ°ï¼Œåé¢çš„å‘å¸ƒè®¢é˜…æ¨¡å¼ä¸‹ç”¨åˆ° // é˜Ÿåˆ—åç§° // é¢å¤–çš„å‚æ•° // å‘é€çš„æ¶ˆæ¯ï¼Œå­—èŠ‚å½¢å¼ channel.basicPublish(\u0026#34;\u0026#34;, queueName,null,msg.getBytes()); System.out.println(\u0026#34;æ¶ˆæ¯å·²å‘é€\u0026#34;); channel.close(); // å…³é—­è¿æ¥ connection.close(); } } æ¶ˆè´¹è€…\nimport com.rabbitmq.client.*; import org.example.util.RabbitUtils; import java.io.IOException; /** * æ¶ˆè´¹è€… */ public class Consumer { public static void main(String[] args) throws IOException { // è·å–è¿æ¥ Connection connection = RabbitUtils.getConnection(); // è·å– chanel Channel channel = connection.createChannel(); // è¦ç»‘å®šçš„é˜Ÿåˆ—ï¼Œå‚æ•°åŒæ¶ˆè´¹è€… String queueName = \u0026#34;hello\u0026#34;; channel.queueDeclare(queueName,false,false,false,null); // æ¥å—å¹¶å¤„ç†æ¶ˆæ¯ // é˜Ÿåˆ—åç§° // æ˜¯å¦è‡ªåŠ¨ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯ï¼Œfalse ä»£è¡¨éœ€è¦ç¼–ç¨‹æ‰‹åŠ¨æ¥ç¡®è®¤ï¼Œè¿™æ˜¯ MQ æ¨èçš„åšæ³• // ç”¨æ¥å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œæ˜¯ DefaultConsumer çš„å®ç°ç±» channel.basicConsume(queueName,false,new Reciver(channel)); // ä¸è¦å…³é—­è¿æ¥ï¼Œè¦æŒç»­ç­‰å¾…æ¶ˆæ¯çš„åˆ°æ¥ } } class Reciver extends DefaultConsumer { private Channel channel; public Reciver(Channel channel) { super(channel); this.channel = channel; } @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { String msg = new String(body); System.out.println(\u0026#34;æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯ï¼š\u0026#34; + msg); System.out.println(\u0026#34;æ¶ˆæ¯çš„ TagId: \u0026#34; + envelope.getDeliveryTag()); // ç¬¬äºŒä¸ªå‚æ•°ï¼š false ä»£è¡¨åªç¡®è®¤ç­¾æ”¶å½“å‰çš„æ¶ˆæ¯ï¼Œtrue: ä»£è¡¨ç­¾æ”¶è¯¥æ¶ˆè´¹è€…æ‰€æœ‰æœªç­¾æ”¶çš„æ¶ˆæ¯ channel.basicAck(envelope.getDeliveryTag(),false); } } woker queues å·¥ä½œé˜Ÿåˆ—\nä¸ç®€å•æ¨¡å¼ç›¸æ¯”æ¶ˆè´¹ä»å•ä¸ªå˜æˆäº†å¤šä¸ªï¼Œå½“å•ä¸ªæ¶ˆè´¹è€…èƒ½åŠ›ä¸è¶³æ—¶ï¼Œå¯ä»¥å¢åŠ å¤šä¸ªæ¶ˆè´¹è€…åŒæ—¶å»å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚\næ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å¯¹ä»»åŠ¡çš„åˆ†å‘æœ‰ä¸¤ç§æ–¹å¼ï¼š1. è½®è¯¢æœºåˆ¶ï¼ŒæŒ¨ä¸ªç»™æ¯ä¸ªæ¶ˆè´¹è€…åˆ†å‘ä»»åŠ¡ï¼Œ100 ä¸ªä»»åŠ¡ï¼Œ2 ä¸ªæ¶ˆè´¹è€…ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…ä¾æ¬¡å¤„ç† 50 ä¸ªä»»åŠ¡ã€‚ 2. å…¬å¹³æ¨¡å¼ï¼š æ¶ˆè´¹è€…å¤„ç†å®Œä¸€ä¸ªä»»åŠ¡æ—¶ç«‹åˆ»æ´¾å‘æ–°çš„ä»»åŠ¡ï¼Œä¸å…³ç³»ä¸Šä¸ªä»»åŠ¡æ˜¯ä¸æ˜¯è¯¥æ¶ˆè´¹è€…å¤„ç†ã€‚ä¹Ÿå°±æ˜¯èƒ½è€…å¤šåŠ³ã€‚\nå±•ç¤º\nç”Ÿäº§è€…ï¼š\nimport com.rabbitmq.client.Channel; import com.rabbitmq.client.Connection; import org.example.util.RabbitUtils; import java.io.IOException; import java.util.concurrent.TimeoutException; /** * ç”Ÿäº§è€… */ public class Producer { public static void main(String[] args) throws IOException, TimeoutException, InterruptedException { // è·å¾—è¿æ¥ Connection connection = RabbitUtils.getConnection(); // è·å¾— channel Channel channel = connection.createChannel(); String queueName = \u0026#34;hello\u0026#34;; // å£°æ˜é˜Ÿåˆ—å¹¶åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ— // ç¬¬ä¸€ä¸ªå‚æ•°ï¼š é˜Ÿåˆ—åç§° // ç¬¬äºŒä¸ªå‚æ•°ï¼šæ˜¯å¦æŒä¹…åŒ–é˜Ÿåˆ—ï¼Œä¸æŒä¹…åŒ–é˜Ÿåˆ—æ—¶ï¼ŒMQ é‡å¯åï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šä¸¢å¤± // ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ˜¯å¦ç§æœ‰åŒ–é˜Ÿåˆ—ï¼Œfalse ä»£è¡¨æ‰€æœ‰æ¶ˆè´¹è€…éƒ½å¯ä»¥è®¿é—®ï¼Œtrue ä»£è¡¨åªæœ‰ç¬¬ä¸€æ¬¡æ‹¥æœ‰å®ƒçš„æ¶ˆè´¹è€…æ‰èƒ½è®¿é—® // ç¬¬å››ä¸ªå‚æ•°ï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œfalse ä»£è¡¨è¿æ¥åœæ‰åä¸è‡ªåŠ¨åˆ é™¤è¿™ä¸ªé˜Ÿåˆ— // å…¶ä»–é¢å¤–å‚æ•°ï¼š null channel.queueDeclare(queueName,false,false,false, null); // å‘é€æ¶ˆæ¯ String msg = \u0026#34;ä½ å¥½ dc\u0026#34;; // äº¤æ¢æœºï¼š ç®€å•æ¨¡å¼ä¸‹ç”¨ä¸åˆ°ï¼Œåé¢çš„å‘å¸ƒè®¢é˜…æ¨¡å¼ä¸‹ç”¨åˆ° // é˜Ÿåˆ—åç§° // é¢å¤–çš„å‚æ•° // å‘é€çš„æ¶ˆæ¯ï¼Œå­—èŠ‚å½¢å¼ for (int i = 0; i \u0026lt; 100; i++) { String m1 = msg + i; channel.basicPublish(\u0026#34;\u0026#34;, queueName,null,m1.getBytes()); } System.out.println(\u0026#34;æ¶ˆæ¯å·²å‘é€\u0026#34;); channel.close(); // å…³é—­è¿æ¥ connection.close(); } } æ¶ˆè´¹è€… 1\nimport com.rabbitmq.client.*; import org.example.util.RabbitUtils; import java.io.IOException; /** * æ¶ˆè´¹è€… */ public class Consumer1 { public static void main(String[] args) throws IOException { // è·å–è¿æ¥ Connection connection = RabbitUtils.getConnection(); // è·å– chanel Channel channel = connection.createChannel(); // è¦ç»‘å®šçš„é˜Ÿåˆ—ï¼Œå‚æ•°åŒæ¶ˆè´¹è€… String queueName = \u0026#34;hello\u0026#34;; channel.queueDeclare(queueName,false,false,false,null); // å¤„ç†å®Œä¸€ä¸ªå†å–ä¸€ä¸ªã€‚å…¬å¹³æ¨¡å¼ï¼Œé»˜è®¤æ˜¯è½®è¯¢æœºåˆ¶ // channel.basicQos(1); // æ¥å—å¹¶å¤„ç†æ¶ˆæ¯ // é˜Ÿåˆ—åç§° // æ˜¯å¦è‡ªåŠ¨ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯ï¼Œfalse ä»£è¡¨éœ€è¦ç¼–ç¨‹æ‰‹åŠ¨æ¥ç¡®è®¤ï¼Œè¿™æ˜¯ MQ æ¨èçš„åšæ³• // ç”¨æ¥å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ channel.basicConsume(queueName, false, new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { String msg = new String(body); System.out.println(\u0026#34;æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼š\u0026#34; + msg + \u0026#34;ã€‚TagId: \u0026#34; + envelope.getDeliveryTag()); try { // æ¨¡æ‹Ÿå¤„ç†ä»»åŠ¡çš„è€—æ—¶ Thread.sleep(100); } catch (InterruptedException e) { throw new RuntimeException(e); } // ç¬¬äºŒä¸ªå‚æ•°ï¼š false ä»£è¡¨åªç¡®è®¤ç­¾æ”¶å½“å‰çš„æ¶ˆæ¯ï¼Œtrue: ä»£è¡¨ç­¾æ”¶è¯¥æ¶ˆè´¹è€…æ‰€æœ‰æœªç­¾æ”¶çš„æ¶ˆæ¯ channel.basicAck(envelope.getDeliveryTag(),false); } }); // ä¸è¦å…³é—­è¿æ¥ï¼Œè¦æŒç»­ç­‰å¾…æ¶ˆæ¯çš„åˆ°æ¥ } } æ¶ˆè´¹è€… 2\nimport com.rabbitmq.client.*; import org.example.util.RabbitUtils; import java.io.IOException; /** * æ¶ˆè´¹è€… */ public class Consumer2 { public static void main(String[] args) throws IOException { // è·å–è¿æ¥ Connection connection = RabbitUtils.getConnection(); // è·å– chanel Channel channel = connection.createChannel(); // è¦ç»‘å®šçš„é˜Ÿåˆ—ï¼Œå‚æ•°åŒæ¶ˆè´¹è€… String queueName = \u0026#34;hello\u0026#34;; channel.queueDeclare(queueName,false,false,false,null); // å¤„ç†å®Œä¸€ä¸ªå†å–ä¸€ä¸ªã€‚å…¬å¹³æ¨¡å¼ï¼Œé»˜è®¤æ˜¯è½®è¯¢æœºåˆ¶ // channel.basicQos(1); // æ¥å—å¹¶å¤„ç†æ¶ˆæ¯ // é˜Ÿåˆ—åç§° // æ˜¯å¦è‡ªåŠ¨ç¡®è®¤æ”¶åˆ°æ¶ˆæ¯ï¼Œfalse ä»£è¡¨éœ€è¦ç¼–ç¨‹æ‰‹åŠ¨æ¥ç¡®è®¤ï¼Œè¿™æ˜¯ MQ æ¨èçš„åšæ³• // ç”¨æ¥å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ channel.basicConsume(queueName, false, new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { String msg = new String(body); System.out.println(\u0026#34;æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼š\u0026#34; + msg + \u0026#34;ã€‚TagId: \u0026#34; + envelope.getDeliveryTag()); try { // æ¨¡æ‹Ÿå¤„ç†ä»»åŠ¡çš„è€—æ—¶ Thread.sleep(500); } catch (InterruptedException e) { throw new RuntimeException(e); } // ç¬¬äºŒä¸ªå‚æ•°ï¼š false ä»£è¡¨åªç¡®è®¤ç­¾æ”¶å½“å‰çš„æ¶ˆæ¯ï¼Œtrue: ä»£è¡¨ç­¾æ”¶è¯¥æ¶ˆè´¹è€…æ‰€æœ‰æœªç­¾æ”¶çš„æ¶ˆæ¯ channel.basicAck(envelope.getDeliveryTag(),false); } }); // ä¸è¦å…³é—­è¿æ¥ï¼Œè¦æŒç»­ç­‰å¾…æ¶ˆæ¯çš„åˆ°æ¥ } } è½®è¯¢æœºåˆ¶è¾“å‡ºç»“æœï¼š\nä¸ç®¡ä¸¤ä¸ªæ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯èƒ½åŠ›çš„å¼ºå¼±ï¼Œè¢«åˆ†é…çš„ä»»åŠ¡ä¸€æ ·å¤šï¼š\næ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc0ã€‚TagId: 1 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc2ã€‚TagId: 2 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc4ã€‚TagId: 3 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc6ã€‚TagId: 4 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc8ã€‚TagId: 5 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc10ã€‚TagId: 6 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc12ã€‚TagId: 7 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc14ã€‚TagId: 8 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc16ã€‚TagId: 9 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc18ã€‚TagId: 10 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc1ã€‚TagId: 1 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc3ã€‚TagId: 2 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc5ã€‚TagId: 3 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc7ã€‚TagId: 4 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc9ã€‚TagId: 5 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc11ã€‚TagId: 6 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc13ã€‚TagId: 7 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc15ã€‚TagId: 8 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc17ã€‚TagId: 9 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc19ã€‚TagId: 10 å…¬å¹³æ¨¡å¼ä¸‹çš„è¾“å‡ºç»“æœï¼š\næ¶ˆè´¹è€… 1 å¤„ç†èƒ½åŠ›å¼ºï¼Œå•ä½æ—¶é—´å†…å¤„ç†ä»»åŠ¡æ•°å¤š\næ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc0ã€‚TagId: 1 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc2ã€‚TagId: 2 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc3ã€‚TagId: 3 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc4ã€‚TagId: 4 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc5ã€‚TagId: 5 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc7ã€‚TagId: 6 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc8ã€‚TagId: 7 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc9ã€‚TagId: 8 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc10ã€‚TagId: 9 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc11ã€‚TagId: 10 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc13ã€‚TagId: 11 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc14ã€‚TagId: 12 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc15ã€‚TagId: 13 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc16ã€‚TagId: 14 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc17ã€‚TagId: 15 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc19ã€‚TagId: 16 æ¶ˆè´¹è€… 1 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc20ã€‚TagId: 17 æ¶ˆè´¹è€… 2 å¤„ç†èƒ½åŠ›å¼±ï¼Œå•ä½æ—¶é—´å†…å¤„ç†ä»»åŠ¡æ•°å°‘\næ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc1ã€‚TagId: 1 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc6ã€‚TagId: 2 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc12ã€‚TagId: 3 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc18ã€‚TagId: 4 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc23ã€‚TagId: 5 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc29ã€‚TagId: 6 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc35ã€‚TagId: 7 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc40ã€‚TagId: 8 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc46ã€‚TagId: 9 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc52ã€‚TagId: 10 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc58ã€‚TagId: 11 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc63ã€‚TagId: 12 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc69ã€‚TagId: 13 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc75ã€‚TagId: 14 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc81ã€‚TagId: 15 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc86ã€‚TagId: 16 æ¶ˆè´¹è€… 2 æ”¶åˆ°æ¶ˆæ¯ï¼šä½ å¥½ dc92ã€‚TagId: 17 Publish/Subscribe å‘å¸ƒè®¢é˜…æ¨¡å¼\nç›®å‰ä¸ºæ­¢ï¼Œç³»ç»Ÿä¸­åªå‡ºç°äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¸€èˆ¬åªèƒ½è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œå½“ä¸€ä¸ªæ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯åï¼Œå…¶ä»–æ¶ˆè´¹è€…ä¾¿æ— æ³•å†æ¬¡å¤„ç†è¯¥æ¶ˆæ¯äº†ã€‚\nå‡å¦‚æœ‰ä¸€ä¸ªå¤©æ°”é¢„æŠ¥å‘å¸ƒç³»ç»Ÿï¼Œæœ‰ä¸€ä¸ªæ°”è±¡å‘å¸ƒä¸­å¿ƒä»¥åŠå„å¤§æ°”è±¡è½¯ä»¶å’Œé—¨æˆ·ç½‘ç«™ï¼Œè¿™äº›è½¯ä»¶å’Œç½‘ç«™éƒ½è¦ä»æ°”è±¡ä¸­å¿ƒè·å–å¤©æ°”ä¿¡æ¯ã€‚å¦‚ä¸‹å›¾ï¼š\næ°”è±¡å‘å¸ƒä¸­å¿ƒä¸å¯èƒ½ä¸€ä¸ªä¸ªå»å¯¹æ¥ä¸åŒçš„å±•ç¤ºå¹³å°ï¼Œä»–ä»¬æ˜¯æŠŠå¤©æ°”ä¿¡æ¯æŒ‰ç…§ä¸€å®šçš„æ ¼å¼å‘å¸ƒåˆ°æŸä¸ªåœ°æ–¹ï¼Œå…¶ä»–å„å¤§å±•ç¤ºå¹³å°éƒ½ä»è¿™é‡Œè·å–ã€‚ç°åœ¨æˆ‘ä»¬ç”¨ RabbitMQ æ¥è®¾è®¡è¿™å¥—ç³»ç»Ÿï¼Œä¸Šé¢ä»‹ç»çš„å·¥ä½œé˜Ÿåˆ—æ¨¡å¼å°±æ— æ³•é€‚ç”¨äº†ï¼Œå› ä¸ºå¦‚æœä¸€ä¸ªåœ°æ–¹çš„å¤©æ°”ä¿¡æ¯è¢«â€œå¢¨è¿¹å¤©æ°”â€å–èµ°åï¼Œè¿™æ¡æ¶ˆæ¯å°±æ²¡äº†ï¼Œè‚¯å®šä¸åˆé€‚ã€‚æˆ‘ä»¬è‡ªç„¶æƒ³åˆ°æ¯ä¸ªå¤©æ°”å±•ç¤ºå¹³å°éƒ½å»ç»‘å®šä¸€ä¸ªé˜Ÿåˆ—ï¼Œå„è‡ªä»é˜Ÿåˆ—ä¸­æ¥æ”¶æ°”è±¡ä¸­å‘å¸ƒçš„æ¶ˆæ¯ã€‚è€Œæ°”è±¡ä¸­å¿ƒæ¯æ¬¡éƒ½è¦å‘è¿™äº›é˜Ÿåˆ—ä¸­ä¾æ¬¡å‘å¸ƒæ¶ˆæ¯ã€‚å°±åƒä¸‹é¢è¿™æ ·ï¼š\nè¿™æ ·æ˜¯å¯è¡Œï¼Œåªä¸è¿‡åœ¨ç”Ÿäº§è€…ä¸€ç«¯å¢åŠ äº†å‡ è¡Œä»£ç è€Œå·²ï¼Œä½†æ˜¯è¿™æ ·åšå¤§å¤§çš„å¢åŠ äº†ç³»ç»Ÿçš„è€¦åˆåº¦ã€‚æ¯å½“æ–°å¢åŠ ä¸€ä¸ªå±•ç¤ºå¹³å°æ—¶ï¼Œæ°”è±¡ä¸­å¿ƒéƒ½è¦ä¿®æ”¹ä»£ç æ–°å¢ä¸€ä¸ªæ¨é€æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚\nè¿™ç§ä¸€ç«¯å‘å¸ƒï¼Œå¤šç«¯éƒ½èƒ½æ”¶åˆ°çš„åœºæ™¯å¾ˆåƒå¹¿æ’­ç«™ä¸æ”¶éŸ³æœºçš„å…³ç³»ã€‚åªè¦ç”¨æˆ·æŠŠæ”¶éŸ³æœºè°ƒåˆ°å›ºå®šé¢‘é“ï¼Œå°±éƒ½å¯ä»¥æ¥æ”¶åˆ°æ¥è‡ªè¯¥é¢‘é“çš„ä¿¡æ¯ã€‚åœ¨ RabbitMQ ä¸­ä¹Ÿæœ‰è¿™ç§å¹¿æ’­æ¨¡å¼ï¼Œè€Œè¿™ç§å¹¿æ’­æ¨¡å¼å°±æ˜¯ä¾é äº¤æ¢å™¨æ¥å®ç°çš„ã€‚ å¦‚ä¸‹å›¾ï¼š\nè¿™ç§æ¨¡å¼ä¸‹ï¼Œç”Ÿäº§è€…åªéœ€æŠŠæ¶ˆæ¯å‘é€æŒ‡å®šäº¤æ¢å™¨ä¸Šï¼Œæ¶ˆè´¹è€…ç»‘å®šé˜Ÿåˆ—çš„æ—¶å€™ï¼Œå£°æ˜ä¸€ä¸‹é˜Ÿåˆ—ä¸äº¤æ¢å™¨çš„å…³ç³»å³å¯ã€‚ç”Ÿäº§è€…åœ¨å‘å¸ƒæ¶ˆæ¯æ—¶ï¼Œäº¤æ¢å™¨ä¼šæ ¹æ®è¿™ç§ç»‘å®šå…³ç³»æŠŠæ¶ˆæ¯å‘æ‰€æœ‰é˜Ÿåˆ—éƒ½å‘é€ä¸€éã€‚\nä¸‹é¢æ¥çœ‹ä¸€ä¸‹ä»£ç å®ç°ï¼š\néœ€è¦å…ˆåœ¨RabbitMQ ç®¡ç†ç«¯åˆ›å»º``weather_routing_exchange`äº¤æ¢å™¨ , ç±»å‹æ˜¯ fanout\næ°”è±¡ç«™\nimport com.rabbitmq.client.Channel; import com.rabbitmq.client.Connection; import org.example.util.RabbitUtils; import java.io.IOException; import java.util.concurrent.TimeoutException; /** * æ°”è±¡ç«™ */ public class WeatherStation { public static void main(String[] args) throws IOException, TimeoutException { Connection connection = RabbitUtils.getConnection(); Channel channel = connection.createChannel(); String weather= \u0026#34;{\u0026#39;date\u0026#39;: \u0026#39;2023-04-10\u0026#39;,\u0026#39;location\u0026#39;:\u0026#39;éƒ‘å·\u0026#39;,\u0026#39;text\u0026#39;: \u0026#39;æ™´ï¼Œ16â„ƒ~28â„ƒ\u0026#39;}\u0026#34;; // ç¬¬ä¸€ä¸ªå‚æ•°ï¼šæŒ‡å®šäº¤æ¢å™¨ // ç¬¬äºŒä¸ªå‚æ•°ï¼šè·¯ç”± key, æš‚æ—¶ç”¨ä¸åˆ°ã€‚ // ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šé¢å¤–ä¿¡æ¯ // ç¬¬å››ä¸ªå‚æ•°ï¼šæ¶ˆæ¯å†…å®¹ï¼Œå­—èŠ‚å½¢å¼ // ä¸å·¥ä½œé˜Ÿåˆ—æ¨¡å¼ä¸åŒï¼Œè¿™é‡Œç›´æ¥å‘å¸ƒæ¶ˆæ¯äº†ï¼Œæ²¡æœ‰æŒ‡å®šå‘å¸ƒåˆ°å“ªä¸ªé˜Ÿåˆ—ä¸­ï¼Œè¿™æ˜¯ç”± RabbitMQ ä¸­çš„äº¤æ¢å™¨æ¥å†³å®šçš„ channel.basicPublish(\u0026#34;weather_exchange\u0026#34;,\u0026#34;\u0026#34;,null,weather.getBytes()); weather= \u0026#34;{\u0026#39;date\u0026#39;: \u0026#39;2023-04-10\u0026#39;,\u0026#39;location\u0026#39;:\u0026#39;æ–°ä¹¡\u0026#39;,\u0026#39;text\u0026#39;: \u0026#39;å¤šäº‘ï¼Œ10â„ƒ~26â„ƒ\u0026#39;}\u0026#34;; channel.basicPublish(\u0026#34;weather_exchange\u0026#34;,\u0026#34;\u0026#34;,null,weather.getBytes()); channel.close(); connection.close(); } } å¢¨è¿¹ APP\nimport com.rabbitmq.client.*; import org.example.util.RabbitUtils; import java.io.IOException; /** * å¢¨è¿¹ APP */ public class MoJiApp { public static void main(String[] args) throws IOException { Connection connection = RabbitUtils.getConnection(); Channel channel = connection.createChannel(); String queueName = \u0026#34;moji\u0026#34;; // å£°æ˜ä¸€ä¸ªé˜Ÿåˆ— channel.queueDeclare(queueName,false,false,false, null); // ç»‘å®šé˜Ÿåˆ—ä¸äº¤æ¢å™¨çš„å…³ç³» channel.queueBind(queueName,\u0026#34;weather_exchange\u0026#34;,\u0026#34;\u0026#34;); channel.basicQos(1); // ç›‘å¬æ¶ˆæ¯ channel.basicConsume(queueName,false, new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\u0026#34;å¢¨è¿¹ APP æ”¶åˆ°å¤©æ°”ä¿¡æ¯ï¼š\u0026#34; + new String(body)); channel.basicAck(envelope.getDeliveryTag(),false); } }); } } å½©äº‘ APP\nimport com.rabbitmq.client.*; import org.example.util.RabbitUtils; import java.io.IOException; /** * å½©äº‘ APP */ public class CaiYunApp { public static void main(String[] args) throws IOException { Connection connection = RabbitUtils.getConnection(); Channel channel = connection.createChannel(); String queueName = \u0026#34;caiyun\u0026#34;; // å£°æ˜ä¸€ä¸ªé˜Ÿåˆ— channel.queueDeclare(queueName,false,false,false, null); // ç»‘å®šé˜Ÿåˆ—ä¸äº¤æ¢å™¨çš„å…³ç³» channel.queueBind(queueName,\u0026#34;weather_exchange\u0026#34;,\u0026#34;\u0026#34;); channel.basicQos(1); // ç›‘å¬æ¶ˆæ¯ channel.basicConsume(queueName,false, new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\u0026#34;å½©äº‘ APP æ”¶åˆ°å¤©æ°”ä¿¡æ¯ï¼š\u0026#34; + new String(body)); channel.basicAck(envelope.getDeliveryTag(),false); } }); } } è¾“å‡ºï¼š\nå¢¨è¿¹ APP æ”¶åˆ°å¤©æ°”ä¿¡æ¯ï¼š{\u0026#39;date\u0026#39;: \u0026#39;2023-04-10\u0026#39;,\u0026#39;location\u0026#39;:\u0026#39;éƒ‘å·\u0026#39;,\u0026#39;text\u0026#39;: \u0026#39;æ™´ï¼Œ16â„ƒ~28â„ƒ\u0026#39;} å¢¨è¿¹ APP æ”¶åˆ°å¤©æ°”ä¿¡æ¯ï¼š{\u0026#39;date\u0026#39;: \u0026#39;2023-04-10\u0026#39;,\u0026#39;location\u0026#39;:\u0026#39;æ–°ä¹¡\u0026#39;,\u0026#39;text\u0026#39;: \u0026#39;å¤šäº‘ï¼Œ10â„ƒ~26â„ƒ\u0026#39;} å½©äº‘ APP æ”¶åˆ°å¤©æ°”ä¿¡æ¯ï¼š{\u0026#39;date\u0026#39;: \u0026#39;2023-04-10\u0026#39;,\u0026#39;location\u0026#39;:\u0026#39;éƒ‘å·\u0026#39;,\u0026#39;text\u0026#39;: \u0026#39;æ™´ï¼Œ16â„ƒ~28â„ƒ\u0026#39;} å½©äº‘ APP æ”¶åˆ°å¤©æ°”ä¿¡æ¯ï¼š{\u0026#39;date\u0026#39;: \u0026#39;2023-04-10\u0026#39;,\u0026#39;location\u0026#39;:\u0026#39;æ–°ä¹¡\u0026#39;,\u0026#39;text\u0026#39;: \u0026#39;å¤šäº‘ï¼Œ10â„ƒ~26â„ƒ\u0026#39;} è¿™ç§å‘å¸ƒè®¢é˜…æ¨¡å¼å®ç°äº†ä¸€ç«¯å‘å¸ƒï¼Œå¤šç«¯è®¢é˜…çš„åŠŸèƒ½ï¼Œä¸€æ—¦å®¢æˆ·ç«¯ç»‘å®šäº†é˜Ÿåˆ—ä¸äº¤æ¢å™¨çš„å…³ç³»ï¼Œåªè¦å‘å¸ƒåœ¨äº¤æ¢å™¨ä¸Šçš„æ¶ˆæ¯ï¼Œè¯¥å®¢æˆ·ç«¯éƒ½å¯ä»¥æ”¶åˆ°ã€‚å‡å¦‚å¢¨è¿¹ APP ç”¨æˆ·åªæƒ³å…³æ³¨éƒ‘å·çš„å¤©æ°”ï¼Œå½©äº‘ APP ç”¨æˆ·åªæƒ³å…³æ³¨æ–°ä¹¡çš„å¤©æ°”ã€‚è¿™åˆè¯¥å¦‚ä½•åšå‘¢ï¼Ÿæœ€å…ˆæƒ³åˆ°çš„å¯èƒ½å°±æ˜¯è®©æ°”è±¡ç«™æŒ‰ç…§åœ°åŒºç»™äº¤æ¢å™¨åˆ†ç±»ï¼Œéƒ‘å·çš„å¤©æ°”å¾€éƒ‘å·çš„äº¤æ¢å™¨ä¸Šå‘ï¼Œæ–°ä¹¡çš„å¤©æ°”å¾€æ–°ä¹¡çš„äº¤æ¢å™¨ä¸Šå‘ï¼Œç­‰ç­‰ã€‚ä½†æ˜¯è¿™æ ·ä¼šå¾ˆéº»çƒ¦ï¼Œå‡å¦‚ä»¥åå›½å®¶å¤šäº†ä¸€ä¸ªçœï¼Œæˆ–è€…è¡Œæ”¿åŒºåŸŸæœ‰å˜åŠ¨ï¼Œå²‚ä¸æ˜¯åˆè¦æ°”è±¡ç«™ä¿®æ”¹ä»£ç ã€‚\nRouting è¿™æ—¶å€™äº¤æ¢å™¨çš„è·¯ç”±æ¨¡å¼ï¼Œå°±æ´¾ä¸Šç”¨åœºäº†ï¼Œç”Ÿäº§è€…åœ¨å‘å¸ƒä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œå¯ä»¥ç»™è¯¥æ¶ˆæ¯æŒ‡å®šä¸€ä¸ªè·¯ç”± key, æ¶ˆè´¹è€…åœ¨ç»‘å®šé˜Ÿåˆ—ä¸äº¤æ¢å™¨çš„å…³ç³»æ—¶ï¼Œå¯ä»¥æŒ‡å®šå…·æœ‰å“ªä¸€ç§çš„è·¯ç”± keyçš„æ¶ˆæ¯åº”è¯¥å‘å¸ƒåˆ°è¯¥é˜Ÿåˆ—é‡Œé¢ï¼Œè€Œä¸æ˜¯ä¸€è‚¡è„‘çš„å…¨éƒ¨æ¥æ”¶è¯¥äº¤æ¢å™¨çš„æ‰€æœ‰æ¶ˆæ¯ã€‚å¦‚ä¸‹å›¾ï¼›\nä¸‹é¢çœ‹ä¸€ä¸‹ä»£ç å®ç°ï¼›\néœ€è¦å…ˆåœ¨RabbitMQ ç®¡ç†ç«¯åˆ›å»º``weather_routing_exchange`äº¤æ¢å™¨ , ç±»å‹æ˜¯ direct\næ°”è±¡ç«™\nimport com.rabbitmq.client.Channel; import com.rabbitmq.client.Connection; import org.example.util.RabbitUtils; import java.io.IOException; import java.util.ArrayList; import java.util.List; import java.util.concurrent.TimeoutException; /** * æ°”è±¡ç«™ */ public class WeatherStation { public static void main(String[] args) throws IOException, TimeoutException { Connection connection = RabbitUtils.getConnection(); Channel channel = connection.createChannel(); List\u0026lt;Weather\u0026gt; weatherList = new ArrayList\u0026lt;\u0026gt;(); weatherList.add(new Weather(\u0026#34;zhengzhou\u0026#34;,\u0026#34;éƒ‘å·æ™´ï¼Œ16â„ƒ~28â„ƒ\u0026#34;)); weatherList.add(new Weather(\u0026#34;xinxiang\u0026#34;,\u0026#34;æ–°ä¹¡å¤šäº‘ï¼Œ10â„ƒ~26â„ƒ\u0026#34;)); for (Weather weather : weatherList) { // æŒ‡å®šäº†è·¯ç”±keyï¼Œ è·¯ç”±keyçš„æ ¼å¼æ˜¯åœ°åŒº channel.basicPublish(\u0026#34;weather_routing_exchange\u0026#34;,weather.getKey(),null,weather.getMsg().getBytes()); } channel.close(); connection.close(); } } class Weather{ private String key; private String msg; public Weather(String key, String msg) { this.key = key; this.msg = msg; } public String getKey() { return key; } public String getMsg() { return msg; } } å¢¨è¿¹APP\nimport com.rabbitmq.client.*; import org.example.util.RabbitUtils; import java.io.IOException; /** * å¢¨è¿¹APP */ public class MoJiApp { public static void main(String[] args) throws IOException { Connection connection = RabbitUtils.getConnection(); Channel channel = connection.createChannel(); String queueName = \u0026#34;moji\u0026#34;; // å£°æ˜ä¸€ä¸ªé˜Ÿåˆ— channel.queueDeclare(queueName,false,false,false, null); // ç»‘å®šé˜Ÿåˆ—ä¸äº¤æ¢å™¨çš„å…³ç³»,åŒæ—¶æŒ‡å®šäº†è·¯ç”±keyæ˜¯éƒ‘å· channel.queueBind(queueName,\u0026#34;weather_routing_exchange\u0026#34;,\u0026#34;zhengzhou\u0026#34;); channel.basicQos(1); // ç›‘å¬æ¶ˆæ¯ channel.basicConsume(queueName,false, new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\u0026#34;å¢¨è¿¹APP æ”¶åˆ°å¤©æ°”ä¿¡æ¯: \u0026#34; + new String(body)); channel.basicAck(envelope.getDeliveryTag(),false); } }); } } å½©äº‘APP\nimport com.rabbitmq.client.*; import org.example.util.RabbitUtils; import java.io.IOException; /** * å½©äº‘APP */ public class CaiYunApp { public static void main(String[] args) throws IOException { Connection connection = RabbitUtils.getConnection(); Channel channel = connection.createChannel(); String queueName = \u0026#34;caiyun\u0026#34;; // å£°æ˜ä¸€ä¸ªé˜Ÿåˆ— channel.queueDeclare(queueName,false,false,false, null); // ç»‘å®šé˜Ÿåˆ—ä¸äº¤æ¢å™¨çš„å…³ç³» channel.queueBind(queueName,\u0026#34;weather_routing_exchange\u0026#34;,\u0026#34;xinxiang\u0026#34;); channel.basicQos(1); // ç›‘å¬æ¶ˆæ¯ channel.basicConsume(queueName,false, new DefaultConsumer(channel){ @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException { System.out.println(\u0026#34;å½©äº‘APP æ”¶åˆ°å¤©æ°”ä¿¡æ¯: \u0026#34; + new String(body)); channel.basicAck(envelope.getDeliveryTag(),false); } }); } } è¾“å‡ºå†…å®¹\nå¢¨è¿¹APP æ”¶åˆ°å¤©æ°”ä¿¡æ¯: éƒ‘å·æ™´ï¼Œ16â„ƒ~28â„ƒ å½©äº‘APP æ”¶åˆ°å¤©æ°”ä¿¡æ¯: æ–°ä¹¡å¤šäº‘ï¼Œ10â„ƒ~26â„ƒ Topics è¿™ç§æ¨¡å¼å°±æ¯”è¾ƒå¥½ç†è§£äº†ï¼Œä¸Šé¢çš„ Routing æ¨¡å¼æ˜¯è¦æ±‚keyå®Œå…¨ä¸€è‡´ï¼Œæ¶ˆæ¯æ‰èƒ½è¢«äº¤æ¢å™¨æŠ•é€’åˆ°é˜Ÿåˆ—ã€‚è€ŒTopics æ¨¡å¼æ”¯æŒç»Ÿé…ç¬¦çš„keyï¼Œåœ¨è®¾è®¡keyçš„æ—¶å€™ï¼Œä¸€èˆ¬ç”±å¤šä¸ªå…³é”®è¯ç»„æˆï¼Œå¹¶ç”¨.è¿æ¥ï¼Œè€Œé€šé…ç¬¦æ”¯æŒä¸¤ç§æ¨¡å¼:\n#: åŒ¹é…ä¸€ä¸ªæˆ–è€…å¤šä¸ªå•è¯ *: åªåŒ¹é…ä¸€ä¸ªå•è¯ ä¾‹å¦‚ item.# å¯ä»¥åŒ¹é… item.insert item.insert.abc\nitem.* åªèƒ½åŒ¹é… item.insert\nè¿™ç§æ¨¡å¼æœ€çµæ´»ï¼Œç”¨çš„æœ€å¤š\næ€»ç»“ ç®€å•æ¨¡å¼: ä¸€ä¸ªç”Ÿäº§è€…ï¼Œä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ¶ˆè´¹è€…ã€‚ å·¥ä½œé˜Ÿåˆ—æ¨¡å¼: ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ã€‚é˜Ÿåˆ—ç§çš„æ¶ˆæ¯åªèƒ½è¢«æ¶ˆè´¹ä¸€æ¬¡ï¼Œå¯ä»¥å¢åŠ æ¶ˆè´¹è€…çš„æ•°é‡å¿«é€Ÿå¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ´¾å‘ç»™æ¶ˆè´¹è€…çš„æ¨¡å¼æœ‰ä¸¤ç§: 1. è½®è¯¢ã€‚ 2. èƒ½è€…å¤šåŠ³ å‘å¸ƒè®¢é˜…æ¨¡å¼: å¼•å…¥äº¤æ¢å™¨ï¼Œå¤šä¸ªé˜Ÿåˆ—ï¼Œå¤šä¸ªæ¶ˆè´¹è€…ã€‚å®ç°ä¸€ç«¯å‘å¸ƒï¼Œå¤šç«¯éƒ½èƒ½æ”¶åˆ°æ¶ˆæ¯ è·¯ç”±æ¨¡å¼: åœ¨å‘å¸ƒè®¢é˜…çš„åŸºç¡€ä¸Šï¼Œç»™æ¶ˆè´¹è€…å¢åŠ äº†è‡ªç”±é€‰æ‹©æ¶ˆæ¯çš„èƒ½åŠ›ã€‚é€šè¿‡å…¨å€¼åŒ¹é…è·¯ç”±keyå®ç°çš„ Topics æ¨¡å¼: åœ¨è·¯ç”±æ¨¡å¼çš„åŸºç¡€ä¸Šï¼Œè·¯ç”±keyé‡‡ç”¨é€šé…ç¬¦çš„åŒ¹é…æ–¹å¼ï¼Œ è¿™ç§æ¨¡å¼æœ€çµæ´»ï¼Œä½¿ç”¨æœ€å¤š æ¶ˆæ¯çš„å¯é æŠ•é€’ RabbitMQ é€šè¿‡ä¸¤ä¸ªå›è°ƒæ–¹æ³•æ¥è®©ç”Ÿäº§è€…ç¡®è®¤æ¶ˆæ¯æ˜¯å¦æ­£ç¡®æŠ•é€’åˆ°é˜Ÿåˆ—ä¸­ï¼Œ\næ¶ˆæ¯æ˜¯å¦æŠ•é€’åˆ°äº¤æ¢å™¨ä¸­ï¼Œè°ƒç”¨ confirmListener æ¶ˆæ¯æ˜¯å¦æŠ•é€’åˆ°é˜Ÿåˆ—ä¸­ï¼Œè°ƒç”¨ returnListener æ³¨æ„ï¼šä¸Šé¢ä¸¤ç§çŠ¶æ€åªæ˜¯ç”Ÿäº§è€…ä¸Brokerä¹‹é—´çš„å…³ç³»ï¼Œå’Œæ¶ˆè´¹è€…çš„æ˜¯å¦æ¥æ”¶ç¡®è®¤æ¶ˆæ¯æ— å…³\nconfirmListener ä»£è¡¨ç”Ÿäº§è€…å°†æ¶ˆæ¯æŠ•é€’åˆ°Brokeræ—¶çš„çŠ¶æ€ï¼Œåç»­ä¼šå‡ºç°ä¸¤ç§æƒ…å†µï¼š\nack ä»£è¡¨æ•°æ®å·²ç»è¢«brokeræ¥æ”¶ï¼Œ nack ä»£è¡¨brokeræ‹’æ”¶æ¶ˆæ¯ï¼ŒåŸå› æœ‰å¤šç§ï¼šé˜Ÿåˆ—å·²æ»¡ï¼Œé™æµï¼ŒIOå¼‚å¸¸ç­‰\u0026hellip; ç¤ºä¾‹ä»£ç :\n//æµ‹è¯• Confirm æ¨¡å¼ @Test public void testConfirm() { //å®šä¹‰å›è°ƒ rabbitTemplate.setConfirmCallback(new RabbitTemplate.ConfirmCallback() { /** * * @param correlationData ç›¸å…³é…ç½®ä¿¡æ¯ * @param ack exchangeäº¤æ¢æœº æ˜¯å¦æˆåŠŸæ”¶åˆ°äº†æ¶ˆæ¯ã€‚true æˆåŠŸï¼Œfalseä»£è¡¨å¤±è´¥ * @param cause å¤±è´¥åŸå›  */ @Override public void confirm(CorrelationData correlationData, boolean ack, String cause) { System.out.println(\u0026#34;confirmæ–¹æ³•è¢«æ‰§è¡Œäº†....\u0026#34;); //ack ä¸º trueè¡¨ç¤º æ¶ˆæ¯å·²ç»åˆ°è¾¾äº¤æ¢æœº if (ack) { //æ¥æ”¶æˆåŠŸ System.out.println(\u0026#34;æ¥æ”¶æˆåŠŸæ¶ˆæ¯\u0026#34; + cause); } else { //æ¥æ”¶å¤±è´¥ System.out.println(\u0026#34;æ¥æ”¶å¤±è´¥æ¶ˆæ¯\u0026#34; + cause); //åšä¸€äº›å¤„ç†ï¼Œè®©æ¶ˆæ¯å†æ¬¡å‘é€ã€‚ } } }); //è¿›è¡Œæ¶ˆæ¯å‘é€ rabbitTemplate.convertAndSend(\u0026#34;test_exchange_confirm\u0026#34;,\u0026#34;confirm\u0026#34;,\u0026#34;message Confirm...\u0026#34;); } returnListener ä»£è¡¨æ¶ˆæ¯æ­£å¸¸è¢«brokeræ¥æ”¶(ack)ï¼Œä½†brokeræ²¡æœ‰å¯¹åº”çš„é˜Ÿåˆ—å¯¹æ¶ˆæ¯è¿›è¡ŒæŠ•é€’ï¼Œæ¶ˆæ¯è¢«é€€å›ç»™ç”Ÿäº§è€…ã€‚\n//æµ‹è¯• returnæ¨¡å¼ @Test public void testReturn() { //è®¾ç½®äº¤æ¢æœºå¤„ç†å¤±è´¥æ¶ˆæ¯çš„æ¨¡å¼ ä¸ºtrueçš„æ—¶å€™ï¼Œæ¶ˆæ¯è¾¾åˆ°ä¸äº† é˜Ÿåˆ—æ—¶ï¼Œä¼šå°†æ¶ˆæ¯é‡æ–°è¿”å›ç»™ç”Ÿäº§è€… rabbitTemplate.setMandatory(true); //å®šä¹‰å›è°ƒ rabbitTemplate.setReturnCallback(new RabbitTemplate.ReturnCallback() { /** * * @param message æ¶ˆæ¯å¯¹è±¡ * @param replyCode é”™è¯¯ç  * @param replyText é”™è¯¯ä¿¡æ¯ * @param exchange äº¤æ¢æœº * @param routingKey è·¯ç”±é”® */ @Override public void returnedMessage(Message message, int replyCode, String replyText, String exchange, String routingKey) { System.out.println(\u0026#34;return æ‰§è¡Œäº†....\u0026#34;); System.out.println(\u0026#34;message:\u0026#34;+message); System.out.println(\u0026#34;replyCode:\u0026#34;+replyCode); System.out.println(\u0026#34;replyText:\u0026#34;+replyText); System.out.println(\u0026#34;exchange:\u0026#34;+exchange); System.out.println(\u0026#34;routingKey:\u0026#34;+routingKey); //å¤„ç† } }); //è¿›è¡Œæ¶ˆæ¯å‘é€ rabbitTemplate.convertAndSend(\u0026#34;test_exchange_confirm\u0026#34;,\u0026#34;confirm\u0026#34;,\u0026#34;message return...\u0026#34;); } ","date":"2023-04-07T23:27:52Z","permalink":"https://dccmmtop.github.io/posts/mq%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%92%8C%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B/","section":"posts","tags":["rabbitMQ"],"title":"MQ çš„åŸºæœ¬æ¦‚å¿µå’Œäº”ç§æ¨¡å¼ä½¿ç”¨ç¤ºä¾‹"},{"categories":null,"contents":" ä¸‰ç§æ¸…è§¦ç­–ç•¥ é’ˆå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key é’ˆå¯¹æ‰€æœ‰çš„ key ä¸å¤„ç† LRU ç®—æ³•ï¼ˆLeastÂ RecentlyÂ Usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ LFU ç®—æ³•ï¼ˆLeastÂ FrequentlyÂ Usedï¼Œæœ€ä¸ç»å¸¸ä½¿ç”¨ï¼‰ å®é™…åº”ç”¨ ä¸‰ç§æ¸…è§¦ç­–ç•¥ è¢«åŠ¨æ¸…é™¤\nå½“è¯»å†™ä¸€ä¸ªå·²ç»è¿‡æœŸçš„ key æ—¶ï¼Œä¼šè§¦å‘æƒ°æ€§åˆ é™¤ç­–ç•¥ï¼Œç›´æ¥åˆ é™¤æ‰è¿™ä¸ªè¿‡æœŸçš„ key ä¸»åŠ¨åˆ é™¤\nç”±äºæƒ°æ€§åˆ é™¤æ— æ³•ä¿è¯å†·æ•°æ®åŠæ—¶æ¸…ç†ï¼Œæ‰€ä»¥ redis ä¼šå®šæœŸä¸»åŠ¨æ·˜æ±°å·²ç»è¿‡æœŸçš„éƒ¨åˆ† keyï¼Œé»˜è®¤æ˜¯æ¯ 100ms ä¸€æ¬¡ã€‚è¿™é‡Œåªæ˜¯éƒ¨åˆ†å·²è¿‡æœŸçš„ keyï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°éƒ¨åˆ† key å·²ç»è¿‡æœŸï¼Œä½†æ²¡æœ‰æ¸…ç†æ‰çš„æƒ…å†µï¼Œå¯¼è‡´å†…å­˜å¹¶æ²¡æœ‰é‡Šæ”¾ maxmemory é™å®š\nå½“å‰å†…å­˜ä½¿ç”¨è¶…è¿‡ maxmemory é™å®šæ—¶ï¼Œè§¦å‘ä¸»åŠ¨æ¸…ç†ç­–ç•¥ ä¸»åŠ¨æ¸…ç†ç­–ç•¥åœ¨ redis 4.0 ä¹‹å‰ä¸€å…±å®ç°äº† 6 ç§å†…å­˜æ·˜æ±°ç®—æ³•ï¼Œ4.0 ä¹‹åï¼Œåˆå¢åŠ äº† 2 ä¸­ï¼Œå…± 8 ç§ã€‚å¯ä»¥æŒ‰ç…§é’ˆå¯¹ key æ˜¯å¦è®¾ç½®è¿‡æœŸæ—¶é—´åˆ†ä¸ºä¸¤å¤§ç±»ï¼š\né’ˆå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key volatile-ttl: ä¼šé’ˆå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ keyï¼Œæ ¹æ®è¿‡æœŸæ—¶é—´çš„å…ˆåè¿›è¡Œæ¸…ç†ï¼Œè¶Šæ—©è¿‡æœŸçš„ï¼Œè¶Šå…ˆè¢«åˆ é™¤ volatile-random: åœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key ä¸­ï¼Œéšæœºé€‰æ‹©åˆ é™¤ volatile-lru: ä¼šä½¿ç”¨ lru ç®—æ³•æ¥é€‰æ‹©è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key è¿›è¡Œåˆ é™¤ volatile-lfu: ä¼šä½¿ç”¨ lfu ç®—æ³•æ¥é€‰æ‹©è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key è¿›è¡Œåˆ é™¤ é’ˆå¯¹æ‰€æœ‰çš„ key allkeys-random: ä»æ‰€æœ‰çš„é”®å€¼å¯¹ä¸­éšæœºé€‰æ‹©å¹¶åˆ é™¤ allkeys-lru: ä»æ‰€æœ‰çš„é”®å€¼å¯¹ä¸­ä½¿ç”¨ lru ç®—æ³•é€‰æ‹©å¹¶åˆ é™¤ allkeys-lfu: ä»æ‰€æœ‰çš„é”®å€¼å¯¹ä¸­ä½¿ç”¨ lfu ç®—æ³•é€‰æ‹©å¹¶åˆ é™¤ ä¸å¤„ç† noevictionï¼šä¸ä¼šå‰”é™¤ä»»ä½•æ•°æ®ï¼Œæ‹’ç»æ‰€æœ‰å†™å…¥æ“ä½œå¹¶è¿”å›å®¢æˆ·ç«¯é”™è¯¯ä¿¡æ¯\u0026quot;(error) OOM command not allowed when used memory\u0026quot;ï¼Œæ­¤æ—¶ Redis åªå“åº”è¯»æ“ä½œã€‚ LRU ç®—æ³•ï¼ˆLeastÂ RecentlyÂ Usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ æ·˜æ±°å¾ˆä¹…æ²¡è¢«è®¿é—®è¿‡çš„æ•°æ®ï¼Œä»¥æœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´ä½œä¸ºå‚è€ƒã€‚\nLFU ç®—æ³•ï¼ˆLeastÂ FrequentlyÂ Usedï¼Œæœ€ä¸ç»å¸¸ä½¿ç”¨ï¼‰ æ·˜æ±°æœ€è¿‘ä¸€æ®µæ—¶é—´è¢«è®¿é—®æ¬¡æ•°æœ€å°‘çš„æ•°æ®ï¼Œä»¥æ¬¡æ•°ä½œä¸ºå‚è€ƒã€‚\nå®é™…åº”ç”¨ å½“å­˜åœ¨çƒ­ç‚¹æ•°æ®æ—¶ï¼ŒLRU çš„æ•ˆç‡å¾ˆå¥½ï¼Œä½†å¶å‘æ€§çš„ã€å‘¨æœŸæ€§çš„æ‰¹é‡æ“ä½œä¼šå¯¼è‡´ LRU å‘½ä¸­ç‡æ€¥å‰§ä¸‹é™ï¼Œç¼“å­˜æ±¡æŸ“æƒ…å†µæ¯”è¾ƒä¸¥é‡ã€‚è¿™æ—¶ä½¿ç”¨ LFU å¯èƒ½æ›´å¥½ç‚¹ã€‚\næ ¹æ®è‡ªèº«ä¸šåŠ¡ç±»å‹ï¼Œé…ç½®å¥½ maxmemory-policyï¼ˆé»˜è®¤æ˜¯ noeviction)ï¼Œæ¨èä½¿ç”¨ volatile-lruã€‚å¦‚æœä¸è®¾ç½®æœ€å¤§å†…å­˜ï¼Œå½“ Redis å†…å­˜è¶…å‡ºç‰©ç†å†…å­˜é™åˆ¶æ—¶ï¼Œå†…å­˜çš„æ•°æ®ä¼šå¼€å§‹å’Œç£ç›˜äº§ç”Ÿé¢‘ç¹çš„äº¤æ¢ (swap)ï¼Œä¼šè®© Redis çš„æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚\nå½“ Redis è¿è¡Œåœ¨ä¸»ä»æ¨¡å¼æ—¶ï¼Œåªæœ‰ä¸»ç»“ç‚¹æ‰ä¼šæ‰§è¡Œè¿‡æœŸåˆ é™¤ç­–ç•¥ï¼Œç„¶åæŠŠåˆ é™¤æ“ä½œâ€del keyâ€åŒæ­¥åˆ°ä»ç»“ç‚¹åˆ é™¤æ•°æ®ã€‚\n","date":"2023-03-30T08:14:20Z","permalink":"https://dccmmtop.github.io/posts/redis%E5%86%85%E5%AD%98%E6%B8%85%E7%90%86%E7%AD%96%E7%95%A5/","section":"posts","tags":["redis"],"title":"Redis å†…å­˜æ¸…ç†ç­–ç•¥"},{"categories":null,"contents":"ç›®å½•\né”®çš„è®¾è®¡ value è®¾è®¡ æ‹’ç» bigkey ï¼ˆå¼ºåˆ¶ï¼‰ bigkey çš„å±å®³ï¼š bigKey çš„äº§ç”Ÿ å¦‚ä½•ä¼˜åŒ– bigkey é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹ æ§åˆ¶ key çš„ç”Ÿå‘½å‘¨æœŸï¼Œredis ä¸æ˜¯åƒåœ¾æ¡¶ å‘½ä»¤çš„ä½¿ç”¨ å…³æ³¨å…ƒç´ æ•°é‡ ç¦ç”¨å±é™©å‘½ä»¤ æ‰¹é‡æ“ä½œæå‡æ•ˆç‡ ä¸å»ºè®®ä½¿ç”¨è‡ªå¸¦äº‹åŠ¡ å®¢æˆ·ç«¯çš„ä½¿ç”¨ é¿å…å¤šä¸ªä¸šåŠ¡ä½¿ç”¨ä¸€ä¸ª redis æœåŠ¡ï¼ˆæ¨èï¼‰ ä½¿ç”¨å¸¦æœ‰è¿æ¥æ± çš„å®¢æˆ·ç«¯ è¿æ¥æ± å‚æ•°å«ä¹‰ï¼š ä¼˜åŒ–å»ºè®® maxTotal: æœ€å¤§è¿æ¥æ•°ï¼Œæ—©æœŸå«åš maxActive maxIdle å’Œ minIdel è¿æ¥æ± é¢„çƒ­ ç³»ç»Ÿå†…æ ¸å‚æ•°ä¼˜åŒ– vm.swapniess vm.overcommit_memory åˆç†è®¾ç½®æ–‡ä»¶å¥æŸ„æ•° æ…¢æ—¥å¿—æŸ¥è¯¢ é”®çš„è®¾è®¡ å…¼é¡¾å¯è¯»æ€§å’Œå¯ç®¡ç†æ€§\nä»¥ä¸šåŠ¡åï¼ˆæˆ–æ•°æ®åº“åï¼‰ä¸ºå‰ç¼€ï¼ˆé˜²æ­¢ key å†²çªï¼‰ï¼Œç”¨å†’å·åˆ†éš”ï¼Œæ¯”å¦‚ä¸šåŠ¡åï¼šè¡¨åï¼šid ç®€æ´æ€§\nä¿è¯è¯­ä¹‰çš„å‰æä¸‹ï¼Œæ§åˆ¶ key çš„é•¿åº¦ï¼Œå½“ key è¾ƒå¤šæ—¶ï¼Œå†…å­˜å ç”¨ä¹Ÿä¸å®¹å¿½è§†ï¼Œä¾‹å¦‚ï¼š user:{uid}:friends:messages:{mid} ç®€åŒ–ä¸º u:{uid}ğŸ‡«ğŸ‡·m:{mid} ä¸è¦åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆå¼ºåˆ¶ï¼‰ value è®¾è®¡ æ‹’ç» bigkey ï¼ˆå¼ºåˆ¶ï¼‰ åœ¨ Redis ä¸­ï¼Œä¸€ä¸ªå­—ç¬¦ä¸²æœ€å¤§ 512MBï¼Œä¸€ä¸ªäºŒçº§æ•°æ®ç»“æ„ï¼ˆä¾‹å¦‚ hashã€listã€setã€zsetï¼‰å¯ä»¥å­˜å‚¨å¤§çº¦ 40 äº¿ä¸ª (2^32-1) ä¸ªå…ƒç´ ï¼Œä½†å®é™…ä¸­å¦‚æœä¸‹é¢ä¸¤ç§æƒ…å†µï¼Œå°±ä¼šè®¤ä¸ºå®ƒæ˜¯ bigkeyã€‚\nå­—ç¬¦ä¸²ç±»å‹ï¼šå®ƒçš„ big ä½“ç°åœ¨å•ä¸ª value å€¼å¾ˆå¤§ï¼Œä¸€èˆ¬è®¤ä¸ºè¶…è¿‡ 10KB å°±æ˜¯ bigkeyã€‚ éå­—ç¬¦ä¸²ç±»å‹ï¼šå“ˆå¸Œã€åˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆï¼Œå®ƒä»¬çš„ big ä½“ç°åœ¨å…ƒç´ ä¸ªæ•°å¤ªå¤šã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œstring ç±»å‹æ§åˆ¶åœ¨ 10KB ä»¥å†…ï¼Œhashã€listã€setã€zset å…ƒç´ ä¸ªæ•°ä¸è¦è¶…è¿‡ 5000ã€‚ åä¾‹ï¼šä¸€ä¸ªåŒ…å« 200 ä¸‡ä¸ªå…ƒç´ çš„ listã€‚\néå­—ç¬¦ä¸²çš„ bigkeyï¼Œä¸è¦ä½¿ç”¨ del åˆ é™¤ï¼Œä½¿ç”¨ hscanã€sscanã€zscan æ–¹å¼æ¸è¿›å¼åˆ é™¤ï¼ŒåŒæ—¶è¦æ³¨æ„é˜²æ­¢ bigkey è¿‡æœŸæ—¶é—´è‡ªåŠ¨åˆ é™¤é—®é¢˜ï¼ˆä¾‹å¦‚ä¸€ä¸ª 200 ä¸‡çš„ zset è®¾ç½® 1 å°æ—¶è¿‡æœŸï¼Œä¼šè§¦å‘ del æ“ä½œï¼Œé€ æˆé˜»å¡ï¼‰\nbigkey çš„å±å®³ï¼š å¯¼è‡´ redis é˜»å¡ ç½‘ç»œæ‹¥å¡\nbigkey ä¹Ÿå°±æ„å‘³ç€æ¯æ¬¡è·å–è¦äº§ç”Ÿçš„ç½‘ç»œæµé‡è¾ƒå¤§ï¼Œå‡è®¾ä¸€ä¸ª bigkey ä¸º 1MBï¼Œå®¢æˆ·ç«¯æ¯ç§’è®¿é—®é‡ä¸º 1000ï¼Œé‚£ä¹ˆæ¯ç§’äº§ç”Ÿ 1000MB çš„æµé‡ï¼Œå¯¹äºæ™®é€šçš„åƒå…†ç½‘å¡ï¼ˆæŒ‰ç…§å­—èŠ‚ç®—æ˜¯ 128MB/sï¼‰ çš„æœåŠ¡å™¨æ¥è¯´ç®€ç›´æ˜¯ç­é¡¶ä¹‹ç¾ï¼Œè€Œä¸”ä¸€èˆ¬æœåŠ¡å™¨ä¼šé‡‡ç”¨å•æœºå¤šå®ä¾‹çš„æ–¹å¼æ¥éƒ¨ç½²ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ª bigkey å¯èƒ½ä¼šå¯¹å…¶ä»–å®ä¾‹ä¹Ÿé€ æˆå½±å“ï¼Œå…¶åæœä¸å ªè®¾æƒ³ã€‚ è¿‡æœŸåˆ é™¤\næœ‰ä¸ª bigkeyï¼Œå®ƒå®‰åˆ†å®ˆå·±ï¼ˆåªæ‰§è¡Œç®€å•çš„å‘½ä»¤ï¼Œä¾‹å¦‚ hgetã€lpopã€zscore ç­‰ï¼‰ï¼Œä½†å®ƒè®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œå½“å®ƒè¿‡æœŸåï¼Œä¼šè¢«åˆ é™¤ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ Redis 4.0 çš„è¿‡æœŸå¼‚æ­¥åˆ é™¤ (lazyfree-lazy-expire yes)ï¼Œå°±ä¼šå­˜åœ¨é˜»å¡ Redis çš„å¯èƒ½æ€§ã€‚\nbigkey çš„äº§ç”Ÿï¼š bigKey çš„äº§ç”Ÿ ä¸€èˆ¬æ¥è¯´ï¼Œbigkey çš„äº§ç”Ÿéƒ½æ˜¯ç”±äºç¨‹åºè®¾è®¡ä¸å½“ï¼Œæˆ–è€…å¯¹äºæ•°æ®è§„æ¨¡é¢„æ–™ä¸æ¸…æ¥šé€ æˆçš„ï¼Œæ¥çœ‹å‡ ä¸ªä¾‹å­ï¼š\nç¤¾äº¤ç±»ï¼šç²‰ä¸åˆ—è¡¨ï¼Œå¦‚æœæŸäº›æ˜æ˜Ÿæˆ–è€…å¤§ v ä¸ç²¾å¿ƒè®¾è®¡ä¸‹ï¼Œå¿…æ˜¯ bigkeyã€‚ ç»Ÿè®¡ç±»ï¼šä¾‹å¦‚æŒ‰å¤©å­˜å‚¨æŸé¡¹åŠŸèƒ½æˆ–è€…ç½‘ç«™çš„ç”¨æˆ·é›†åˆï¼Œé™¤éæ²¡å‡ ä¸ªäººç”¨ï¼Œå¦åˆ™å¿…æ˜¯ bigkeyã€‚ ç¼“å­˜ç±»ï¼šå°†æ•°æ®ä»æ•°æ®åº“ load å‡ºæ¥åºåˆ—åŒ–æ”¾åˆ° Redis é‡Œï¼Œè¿™ä¸ªæ–¹å¼éå¸¸å¸¸ç”¨ï¼Œä½†æœ‰ä¸¤ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ï¼Œç¬¬ä¸€ï¼Œæ˜¯ä¸æ˜¯æœ‰å¿…è¦æŠŠæ‰€æœ‰å­—æ®µéƒ½ç¼“å­˜ï¼›ç¬¬äºŒï¼Œæœ‰æ²¡æœ‰ç›¸å…³å…³è”çš„æ•°æ®ï¼Œæœ‰çš„åŒå­¦ä¸ºäº†å›¾æ–¹ä¾¿æŠŠç›¸å…³æ•°æ®éƒ½å­˜ä¸€ä¸ª key ä¸‹ï¼Œäº§ç”Ÿ bigkeyã€‚ å¦‚ä½•ä¼˜åŒ– bigkey æ‹†\nbig listï¼š list1ã€list2ã€\u0026hellip;listN å°±æ˜¯æŠŠå¤§åˆ—è¡¨åˆ†æˆå‡ ä¸ªå°åˆ—è¡¨å­˜å‚¨\nbig hashï¼šå¯ä»¥è®²æ•°æ®åˆ†æ®µå­˜å‚¨ï¼Œæ¯”å¦‚ä¸€ä¸ªå¤§çš„ keyï¼Œå‡è®¾å­˜äº† 1 ç™¾ä¸‡çš„ç”¨æˆ·æ•°æ®ï¼Œå¯ä»¥æ‹†åˆ†æˆ 200 ä¸ª keyï¼Œæ¯ä¸ª key ä¸‹é¢å­˜æ”¾ 5000 ä¸ªç”¨æˆ·æ•°æ®\nå¦‚æœ bigkey ä¸å¯é¿å…ï¼Œä¹Ÿè¦æ€è€ƒä¸€ä¸‹è¦ä¸è¦æ¯æ¬¡æŠŠæ‰€æœ‰å…ƒç´ éƒ½å–å‡ºæ¥ï¼ˆä¾‹å¦‚æœ‰æ—¶å€™ä»…ä»…éœ€è¦ hmgetï¼Œè€Œä¸æ˜¯ hgetall)ï¼Œåˆ é™¤ä¹Ÿæ˜¯ä¸€æ ·ï¼Œå°½é‡ä½¿ç”¨ä¼˜é›…çš„æ–¹å¼æ¥å¤„ç†ã€‚\né€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹ æ§åˆ¶ key çš„ç”Ÿå‘½å‘¨æœŸï¼Œredis ä¸æ˜¯åƒåœ¾æ¡¶ å»ºè®®ä½¿ç”¨ expire è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆæ¡ä»¶å…è®¸å¯ä»¥æ‰“æ•£è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢é›†ä¸­è¿‡æœŸï¼‰ã€‚\nå‘½ä»¤çš„ä½¿ç”¨ å…³æ³¨å…ƒç´ æ•°é‡ ä¾‹å¦‚ hgetallã€lrangeã€smembersã€zrangeã€sinter ç­‰å¹¶éä¸èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯éœ€è¦æ˜ç¡® N çš„å€¼ã€‚æœ‰éå†çš„éœ€æ±‚å¯ä»¥ä½¿ç”¨ hscanã€sscanã€zscan ä»£æ›¿ã€‚\nç¦ç”¨å±é™©å‘½ä»¤ ç¦æ­¢çº¿ä¸Šä½¿ç”¨ keysã€flushallã€flushdb ç­‰ï¼Œé€šè¿‡ redis çš„ rename æœºåˆ¶ç¦æ‰å‘½ä»¤ï¼Œæˆ–è€…ä½¿ç”¨ scan çš„æ–¹å¼æ¸è¿›å¼å¤„ç†ã€‚\næ‰¹é‡æ“ä½œæå‡æ•ˆç‡ åŸç”Ÿå‘½ä»¤ï¼šä¾‹å¦‚ mgetã€msetã€‚ éåŸç”Ÿå‘½ä»¤ï¼šå¯ä»¥ä½¿ç”¨ pipeline æé«˜æ•ˆç‡ã€‚ ä¸å»ºè®®ä½¿ç”¨è‡ªå¸¦äº‹åŠ¡ Redis äº‹åŠ¡åŠŸèƒ½è¾ƒå¼±ï¼Œä¸å»ºè®®è¿‡å¤šä½¿ç”¨ï¼Œå¯ä»¥ç”¨ lua æ›¿ä»£\nå®¢æˆ·ç«¯çš„ä½¿ç”¨ é¿å…å¤šä¸ªä¸šåŠ¡ä½¿ç”¨ä¸€ä¸ª redis æœåŠ¡ï¼ˆæ¨èï¼‰ å¤šä¸ªä¸ç›¸å¹²çš„ä¸šåŠ¡åº”è¯¥ä½¿ç”¨ä¸åŒçš„ redis æœåŠ¡ï¼Œå…¬å…±æ•°æ®åšæœåŠ¡åŒ–\nä½¿ç”¨å¸¦æœ‰è¿æ¥æ± çš„å®¢æˆ·ç«¯ å¯ä»¥æœ‰æ•ˆæ§åˆ¶è¿æ¥æ•°é‡ï¼ŒåŒæ—¶æé«˜æ•ˆç‡ï¼Œæ ‡å‡†ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š\nJedisPoolConfig jedisPoolConfig = new JedisPoolConfig(); jedisPoolConfig.setMaxTotal(5); jedisPoolConfig.setMaxIdle(2); jedisPoolConfig.setTestOnBorrow(true); JedisPool jedisPool = new JedisPool(jedisPoolConfig, \u0026#34;192.168.0.60\u0026#34;, 6379, 3000, null); Jedis jedis = null; try { jedis = jedisPool.getResource(); //å…·ä½“çš„å‘½ä»¤ jedis.executeCommand() } catch (Exception e) { logger.error(\u0026#34;op key {} error: \u0026#34; + e.getMessage(), key, e); } finally { //æ³¨æ„è¿™é‡Œä¸æ˜¯å…³é—­è¿æ¥ï¼Œåœ¨ JedisPool æ¨¡å¼ä¸‹ï¼ŒJedis ä¼šè¢«å½’è¿˜ç»™èµ„æºæ± ã€‚ if (jedis != null) jedis.close(); } è¿æ¥æ± å‚æ•°å«ä¹‰ï¼š åºå· å‚æ•°å å«ä¹‰ é»˜è®¤å€¼ ä½¿ç”¨å»ºè®® 1 maxTotal èµ„æºæ± ä¸­æœ€å¤§è¿æ¥æ•° 8 è®¾ç½®å»ºè®®è§ä¸‹é¢ 2 maxIdle èµ„æºæ± å…è®¸æœ€å¤§ç©ºé—²çš„è¿æ¥æ•° 8 è®¾ç½®å»ºè®®è§ä¸‹é¢ 3 minIdle èµ„æºæ± ç¡®ä¿æœ€å°‘ç©ºé—²çš„è¿æ¥æ•° 0 è®¾ç½®å»ºè®®è§ä¸‹é¢ 4 blockWhenExhausted å½“èµ„æºæ± ç”¨å°½åï¼Œè°ƒç”¨è€…æ˜¯å¦è¦ç­‰å¾…ã€‚åªæœ‰å½“ä¸º true æ—¶ï¼Œä¸‹é¢çš„ maxWaitMillis æ‰ä¼šç”Ÿæ•ˆ true å»ºè®®ä½¿ç”¨é»˜è®¤å€¼ 5 maxWaitMillis å½“èµ„æºæ± è¿æ¥ç”¨å°½åï¼Œè°ƒç”¨è€…çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆå•ä½ä¸ºæ¯«ç§’ï¼‰ -1ï¼šè¡¨ç¤ºæ°¸ä¸è¶…æ—¶ ä¸å»ºè®®ä½¿ç”¨é»˜è®¤å€¼ 6 testOnBorrow å‘èµ„æºæ± å€Ÿç”¨è¿æ¥æ—¶æ˜¯å¦åšè¿æ¥æœ‰æ•ˆæ€§æ£€æµ‹ (ping)ï¼Œæ— æ•ˆè¿æ¥ä¼šè¢«ç§»é™¤ false ä¸šåŠ¡é‡å¾ˆå¤§æ—¶å€™å»ºè®®è®¾ç½®ä¸º falseï¼ˆå¤šä¸€æ¬¡ ping çš„å¼€é”€ï¼‰ã€‚ 7 testOnReturn å‘èµ„æºæ± å½’è¿˜è¿æ¥æ—¶æ˜¯å¦åšè¿æ¥æœ‰æ•ˆæ€§æ£€æµ‹ (ping)ï¼Œæ— æ•ˆè¿æ¥ä¼šè¢«ç§»é™¤ false ä¸šåŠ¡é‡å¾ˆå¤§æ—¶å€™å»ºè®®è®¾ç½®ä¸º falseï¼ˆå¤šä¸€æ¬¡ ping çš„å¼€é”€ï¼‰ã€‚ 8 jmxEnabled æ˜¯å¦å¼€å¯ jmx ç›‘æ§ï¼Œå¯ç”¨äºç›‘æ§ true å»ºè®®å¼€å¯ï¼Œä½†åº”ç”¨æœ¬èº«ä¹Ÿè¦å¼€å¯ ä¼˜åŒ–å»ºè®® maxTotal: æœ€å¤§è¿æ¥æ•°ï¼Œæ—©æœŸå«åš maxActive å¦‚ä½•è®¾ç½®è¿™ä¸ªå€¼æ˜¯æ¯”è¾ƒéš¾å›ç­”çš„ï¼Œæ²¡æœ‰å›ºå®šçš„è®¡ç®—æ–¹å¼ï¼Œè€ƒè™‘çš„å› ç´ æ¯”è¾ƒå¤šï¼š\nä¸šåŠ¡å¸Œæœ› redis çš„å¹¶å‘é‡ å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ—¶é—´ redis èµ„æºï¼Œåº”ç”¨çš„ä¸ªæ•° * maxTotal \u0026lt; redis çš„æœ€å¤§è¿æ¥æ•° maxclients èµ„æºå¼€é”€ï¼Œä¾‹å¦‚è™½ç„¶å¸Œæœ›æ§åˆ¶ç©ºé—²è¿æ¥ï¼ˆè¿æ¥æ± æ­¤åˆ»å¯é©¬ä¸Šä½¿ç”¨çš„è¿æ¥ï¼‰ï¼Œä½†æ˜¯ä¸å¸Œæœ›å› ä¸ºè¿æ¥æ± çš„é¢‘ç¹é‡Šæ”¾åˆ›å»ºè¿æ¥é€ æˆä¸å¿…é å¼€é”€ã€‚ ä¾‹å­ï¼š\nå‡è®¾ï¼šä¸€æ¬¡å‘½ä»¤æ—¶é—´ï¼ˆborrow|return resource + Jedis æ‰§è¡Œå‘½ä»¤ï¼ˆå«ç½‘ç»œï¼‰ ï¼‰çš„å¹³å‡è€—æ—¶çº¦ä¸º 1msï¼Œä¸€ä¸ªè¿æ¥çš„ QPS å¤§çº¦æ˜¯ 1000, ä¸šåŠ¡æœŸæœ›çš„ QPS æ˜¯ 50000\né‚£ä¹ˆç†è®ºä¸Šéœ€è¦çš„èµ„æºæ± å¤§å°æ˜¯ 50000 / 1000 = 50 ä¸ªã€‚ä½†äº‹å®ä¸Šè¿™æ˜¯ä¸ªç†è®ºå€¼ï¼Œè¿˜è¦è€ƒè™‘åˆ°è¦æ¯”ç†è®ºå€¼é¢„ç•™ä¸€äº›èµ„æºï¼Œé€šå¸¸æ¥è®² maxTotal å¯ä»¥æ¯”ç†è®ºå€¼å¤§ä¸€äº›ã€‚\nä½†è¿™ä¸ªå€¼ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œä¸€æ–¹é¢è¿æ¥å¤ªå¤šå ç”¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯èµ„æºï¼Œå¦ä¸€æ–¹é¢å¯¹äº Redis è¿™ç§é«˜ QPS çš„æœåŠ¡å™¨ï¼Œä¸€ä¸ªå¤§å‘½ä»¤çš„é˜»å¡å³ä½¿è®¾ç½®å†å¤§èµ„æºæ± ä»ç„¶ä¼šæ— æµäºäº‹ã€‚\nmaxIdle å’Œ minIdel maxIdle å®é™…ä¸Šæ‰æ˜¯ä¸šåŠ¡éœ€è¦çš„æœ€å¤§è¿æ¥æ•°ï¼ŒmaxTotal æ˜¯ä¸ºäº†ç»™å‡ºç»“ä½™é‡ï¼Œæ‰€ä»¥ maxIdele ä¸è¦è®¾ç½®çš„å¤ªå°ï¼Œå¦åˆ™ä¼šä¸æ–­çš„å‘ç”Ÿæ–°å»ºè¿æ¥ï¼Œé‡Šæ”¾è¿æ¥çš„å¼€é”€ã€‚\nè¿æ¥æ± çš„æœ€ä½³æ€§èƒ½æ˜¯ maxTotal = maxIdle è¿™æ ·å°±é¿å…è¿æ¥æ± ä¼¸ç¼©å¸¦æ¥çš„æ€§èƒ½å¹²æ‰°ï¼Œä½†æ˜¯åœ¨å¹¶å‘é‡ä¸å¤§çš„æ—¶å€™ï¼Œæˆ–è€… maxTotal è®¾ç½®è¿‡é«˜ï¼Œä¼šå¯¼è‡´ä¸å¿…è¦çš„è¿æ¥èµ„æºæµªè´¹ï¼Œä¸€èˆ¬æ¨è maxIdle æŒ‰ç…§ä¸Šé¢çš„è®¡ç®—æ–¹å¼è®¾ç½®ï¼ŒmaxTotal å¯ä»¥å†æ”¾å¤§ä¸€å€ã€‚\nminIdleï¼ˆæœ€å°ç©ºé—²è¿æ¥æ•°ï¼‰ï¼Œä¸å…¶è¯´æ˜¯æœ€å°ç©ºé—²è¿æ¥æ•°ï¼Œä¸å¦‚è¯´æ˜¯\u0026quot;è‡³å°‘éœ€è¦ä¿æŒçš„ç©ºé—²è¿æ¥æ•°\u0026quot;ï¼Œåœ¨ä½¿ç”¨è¿æ¥çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¿æ¥æ•°è¶…è¿‡äº† minIdleï¼Œé‚£ä¹ˆç»§ç»­å»ºç«‹è¿æ¥ï¼Œå¦‚æœè¶…è¿‡äº† maxIdleï¼Œå½“è¶…è¿‡çš„è¿æ¥æ‰§è¡Œå®Œä¸šåŠ¡åä¼šæ…¢æ…¢è¢«ç§»å‡ºè¿æ¥æ± é‡Šæ”¾æ‰\nè¿æ¥æ± é¢„çƒ­ å¦‚æœç³»ç»Ÿåˆšå¯åŠ¨å®Œï¼Œå°±é©¬ä¸Šæœ‰å¾ˆå¤šè¯·æ±‚è¿‡æ¥ï¼Œé‚£ä¹ˆå¯ä»¥ç»™è¿æ¥æ± åšé¢„çƒ­ï¼Œæ¯”å¦‚å¿«é€Ÿçš„åˆ›å»ºä¸€äº› redis è¿æ¥ï¼Œæ‰§è¡Œç®€å•å‘½ä»¤ï¼Œå¦‚ ping, å¿«é€Ÿçš„å°†è¿æ¥æ± ä¸­çš„è¿æ¥æå‡åˆ° minIdel çš„æ•°é‡\nç¤ºä¾‹ä»£ç ï¼š\nList\u0026lt;Jedis\u0026gt; minIdleJedisList = new ArrayList\u0026lt;Jedis\u0026gt;(jedisPoolConfig.getMinIdle()); for (int i = 0; i \u0026lt; jedisPoolConfig.getMinIdle(); i++) { Jedis jedis = null; try { jedis = pool.getResource(); minIdleJedisList.add(jedis); jedis.ping(); } catch (Exception e) { logger.error(e.getMessage(), e); } finally { //æ³¨æ„ï¼Œè¿™é‡Œä¸èƒ½é©¬ä¸Š close å°†è¿æ¥è¿˜å›è¿æ¥æ± ï¼Œå¦åˆ™æœ€åè¿æ¥æ± é‡Œåªä¼šå»ºç«‹ 1 ä¸ªè¿æ¥ã€‚ //jedis.close(); } } //ç»Ÿä¸€å°†é¢„çƒ­çš„è¿æ¥è¿˜å›è¿æ¥æ±  for (int i = 0; i \u0026lt; jedisPoolConfig.getMinIdle(); i++) { Jedis jedis = null; try { jedis = minIdleJedisList.get(i); //å°†è¿æ¥å½’è¿˜å›è¿æ¥æ± ï¼Œæ³¨æ„è¿™é‡Œæ˜¯è§„èŒƒè¿æ¥ï¼Œè€Œä¸æ˜¯å…³é—­ jedis.close(); } catch (Exception e) { logger.error(e.getMessage(), e); } finally { } } ç³»ç»Ÿå†…æ ¸å‚æ•°ä¼˜åŒ– vm.swapniess swap å¯¹æ“ä½œç³»ç»Ÿæ¯”è¾ƒé‡è¦ï¼Œå½“ç‰©ç†å†…å­˜ä¸è¶³æ—¶ï¼Œå¯ä»¥å°†ä¸€éƒ¨åˆ†å†…å­˜ä¹Ÿ swap åˆ°ç¡¬ç›˜ä¸Šï¼Œå·²è§£ç‡ƒçœ‰ä¹‹æ€¥ï¼Œå¯¹äºéœ€è¦é«˜å¹¶å‘ï¼Œé«˜ååçš„åº”ç”¨æ¥è¯´ï¼Œç£ç›˜ IO é€šå¸¸ä¼šæˆä¸ºç³»ç»Ÿçš„ç“¶é¢ˆï¼Œå† Linux ä¸­ï¼Œå¹¶ä¸æ˜¯ç­‰æ‰€æœ‰çš„ç‰©ç†å†…å­˜ä½¿ç”¨å®Œåæ‰ç”¨åˆ° swapã€‚ç³»ç»Ÿå‚æ•° swapniess å†³å®šäº†æ“ä½œç³»ç»Ÿä½¿ç”¨ swap çš„å€¾å‘ç¨‹åº¦ï¼Œswapniess å–å€¼èŒƒå›´æ˜¯ 0-100ï¼Œå€¼è¶Šå¤§ï¼Œè¯´æ˜æ“ä½œç³»ç»Ÿä½¿ç”¨ swapniess çš„æ¦‚ç‡è¶Šé«˜ã€‚å€¼è¶Šä½ï¼Œè¡¨ç¤ºæ“ä½œç³»ç»Ÿæ›´åŠ å€¾å‘äºä½¿ç”¨ç‰©ç†å†…å­˜ã€‚\nå¦‚æœå†…æ ¸ç‰ˆæœ¬ \u0026lt; 3.5, é‚£ä¹ˆ swapniess çš„å€¼ä¸º 0ï¼Œç³»ç»Ÿå®æ„¿ swap ä¹Ÿä¸ä¼š oom killer ï¼ˆæ€æ‰è¿›ç¨‹ï¼‰\nå¦‚æœå†…æ ¸ç‰ˆæœ¬ \u0026gt;= 3.5, é‚£ä¹ˆ swapniess çš„å€¼ä¸º 1ï¼Œç³»ç»Ÿå®æ„¿ swap ä¹Ÿä¸ä¼š oom killer ï¼ˆæ€æ‰è¿›ç¨‹ï¼‰\nOOM killer æœºåˆ¶æ˜¯æŒ‡ Linux æ“ä½œç³»ç»Ÿå‘ç°å¯ç”¨å†…å­˜ä¸è¶³æ—¶ï¼Œå¼ºåˆ¶æ€æ­»ä¸€äº›ç”¨æˆ·è¿›ç¨‹ï¼ˆéå†…æ ¸è¿›ç¨‹ï¼‰ï¼Œæ¥ä¿è¯ç³»ç»Ÿæœ‰è¶³å¤Ÿçš„å¯ç”¨å†…å­˜è¿›è¡Œåˆ†é…ã€‚\nä¸€èˆ¬è¦ä¿è¯ redis ä¸ä¼šè¢« kill\nå…ˆæŸ¥çœ‹ç³»ç»Ÿç‰ˆæœ¬ï¼Œå†è®¾å€¼\ncat /proc/version echo 1 \u0026gt; /proc/sys/vm/swapniess echo vm.swapniess=1 \u0026gt;\u0026gt; /etc/sysctl.conf vm.overcommit_memory é»˜è®¤å€¼æ˜¯ 0\n0: è¡¨ç¤ºå†…æ ¸å°†æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç‰©ç†å†…å­˜ä¾›è¿›ç¨‹ä½¿ç”¨ï¼ˆè€Œä¸æ˜¯æ£€æŸ¥æ˜¯å¦ç”¨å°½ï¼‰ï¼Œå¦‚æœæœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œå†…å­˜ç”³è¯·å…è®¸ï¼Œå¦åˆ™å†…å­˜ç”³è¯·å¤±è´¥ï¼Œå¹¶æŠŠé”™è¯¯è¿”å›ç»™åº”ç”¨è¿›ç¨‹ 1: è¡¨ç¤ºå†…æ ¸å…è®¸åˆ†é…æ‰€æœ‰çš„ç‰©ç†å†…å­˜ï¼Œè€Œä¸ç®¡å½“å‰å†…å­˜çŠ¶æ€å¦‚ä½• å¦‚æœæ˜¯ 0 çš„è¯ï¼Œå¯èƒ½å¯¼è‡´ç±»ä¼¼äº fork ç­‰æ“ä½œå¤±è´¥ï¼Œç”³è¯·ä¸åˆ°è¶³å¤Ÿçš„å†…å­˜ç©ºé—´\nRedis å»ºè®®æŠŠè¿™ä¸ªå€¼è®¾ç½®ä¸º 1ï¼Œå°±æ˜¯ä¸ºäº†è®© fork å†ä½å†…å­˜ä¸‹ä¹Ÿèƒ½è¿è¡Œ\ncat /proc/sys/vm/overcommit_memory echo \u0026#34;vm.overcommit_memory=1\u0026#34; \u0026gt;\u0026gt; /etc/sysctl.conf sysctl vm.overcommit_memory=1 åˆç†è®¾ç½®æ–‡ä»¶å¥æŸ„æ•° æ“ä½œç³»ç»Ÿè¿›ç¨‹è¯•å›¾æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼ˆæˆ–è€…å«å¥æŸ„ï¼‰ï¼Œä½†æ˜¯ç°åœ¨è¿›ç¨‹æ‰“å¼€çš„å¥æŸ„æ•°å·²ç»è¾¾åˆ°äº†ä¸Šé™ï¼Œç»§ç»­æ‰“å¼€ä¼šæŠ¥é”™ï¼šâ€œTooÂ manyÂ openÂ filesâ€\nulimit -a #æŸ¥çœ‹ç³»ç»Ÿæ–‡ä»¶å¥æŸ„æ•°ï¼Œçœ‹ open files é‚£é¡¹ ulimit -n 65535 #è®¾ç½®ç³»ç»Ÿæ–‡ä»¶å¥æŸ„æ•° æ…¢æ—¥å¿—æŸ¥è¯¢ Redis æ…¢æ—¥å¿—å‘½ä»¤è¯´æ˜ï¼š\nconfig get slow* #æŸ¥è¯¢æœ‰å…³æ…¢æ—¥å¿—çš„é…ç½®ä¿¡æ¯ config set slowlog-log-slower-than 20000 #è®¾ç½®æ…¢æ—¥å¿—ä½¿æ—¶é—´é˜ˆå€¼ï¼Œå•ä½å¾®ç§’ï¼Œæ­¤å¤„ä¸º 20 æ¯«ç§’ï¼Œå³è¶…è¿‡ 20 æ¯«ç§’çš„æ“ä½œéƒ½ä¼šè®°å½•ä¸‹æ¥ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½® 1000ï¼Œä¹Ÿå°±æ˜¯ 1msï¼Œè¿™æ ·ç†è®ºä¸Š redis å¹¶å‘è‡³å°‘è¾¾åˆ° 1000ï¼Œå¦‚æœè¦æ±‚å•æœºå¹¶å‘è¾¾åˆ° 1 ä¸‡ä»¥ä¸Šï¼Œè¿™ä¸ªå€¼å¯ä»¥è®¾ç½®ä¸º 100 config set slowlog-max-len 1024 #è®¾ç½®æ…¢æ—¥å¿—è®°å½•ä¿å­˜æ•°é‡ï¼Œå¦‚æœä¿å­˜æ•°é‡å·²æ»¡ï¼Œä¼šåˆ é™¤æœ€æ—©çš„è®°å½•ï¼Œæœ€æ–°çš„è®°å½•è¿½åŠ è¿›æ¥ã€‚è®°å½•æ…¢æŸ¥è¯¢æ—¥å¿—æ—¶ Redis ä¼šå¯¹é•¿å‘½ä»¤åšæˆªæ–­æ“ä½œï¼Œå¹¶ä¸ä¼šå ç”¨å¤§é‡å†…å­˜ï¼Œå»ºè®®è®¾ç½®ç¨å¤§äº›ï¼Œé˜²æ­¢ä¸¢å¤±æ—¥å¿— config rewrite #å°†æœåŠ¡å™¨å½“å‰æ‰€ä½¿ç”¨çš„é…ç½®ä¿å­˜åˆ° redis.conf slowlog len #è·å–æ…¢æŸ¥è¯¢æ—¥å¿—åˆ—è¡¨çš„å½“å‰é•¿åº¦ slowlog get 5 #è·å–æœ€æ–°çš„ 5 æ¡æ…¢æŸ¥è¯¢æ—¥å¿—ã€‚æ…¢æŸ¥è¯¢æ—¥å¿—ç”±å››ä¸ªå±æ€§ç»„æˆï¼šæ ‡è¯† IDï¼Œå‘ç”Ÿæ—¶é—´æˆ³ï¼Œå‘½ä»¤è€—æ—¶ï¼Œæ‰§è¡Œå‘½ä»¤å’Œå‚æ•° slowlog reset #é‡ç½®æ…¢æŸ¥è¯¢æ—¥å¿— ","date":"2023-03-27T23:11:51Z","permalink":"https://dccmmtop.github.io/posts/redis%E4%BD%BF%E7%94%A8%E8%A7%84%E8%8C%83%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/","section":"posts","tags":["redis"],"title":"redis ä½¿ç”¨è§„èŒƒä¸æ€§èƒ½ä¼˜åŒ–"},{"categories":null,"contents":"ä¸ºäº†èƒ½å¤Ÿåœ¨ Windows ä¸Šä½¿ç”¨ç³»ç»Ÿå‰ªè´´æ¿ï¼Œæ‚¨éœ€è¦å®‰è£…win32yankåº”ç”¨ç¨‹åºã€‚æ‚¨å¯ä»¥ä»è¿™é‡Œä¸‹è½½ã€‚ä¹‹åï¼Œæ‚¨éœ€è¦å°†å‰ªè´´æ¿è®¾ç½®\nvim è„šæœ¬ set clipboard+=unnamedplus lua è„šæœ¬ vim.opt.clipboard = \u0026#34;unnamedplus\u0026#34; ","date":"2023-03-27T22:29:41Z","permalink":"https://dccmmtop.github.io/posts/%E4%B8%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%89%AA%E8%B4%B4%E6%9D%BF%E4%BA%92%E9%80%9A/","section":"posts","tags":["vim"],"title":"nvimä¸æ“ä½œç³»ç»Ÿå‰ªè´´æ¿äº’é€š"},{"categories":null,"contents":" ç¼“å­˜ç©¿é€ ç¼“å­˜ç©¿é€é—®é¢˜è§£å†³æ–¹æ¡ˆ ç¼“å­˜ç©ºå¯¹è±¡ å¸ƒéš†è¿‡æ»¤å™¨ redisson å®ç°å¸ƒéš†è¿‡æ»¤å™¨ å¼•å…¥ä¾èµ– é¢„å…ˆæ”¾å…¥æ•°æ® ä½¿ç”¨ ç¼“å­˜å‡»ç©¿ ç¼“å­˜é›ªå´© é¢„é˜²å’Œè§£å†³æ–¹æ¡ˆ çƒ­ç‚¹keyçš„é‡å»ºä¼˜åŒ– ç¼“å­˜ç©¿é€ ç¼“å­˜ç©¿é€æŒ‡çš„æ˜¯æŸ¥è¯¢ä¸€ä¸ªæ ¹æœ¬ä¸å­˜åœ¨çš„æ•°æ®ï¼Œç¼“å­˜å±‚å’Œå­˜å‚¨å±‚éƒ½ä¸ä¼šå‘½ä¸­ï¼Œé€šå¸¸å¤„äºå®¹é”™çš„è€ƒè™‘ï¼Œå¦‚æœå­˜å‚¨å±‚ä¸å­˜åœ¨æ•°æ®ä¹Ÿä¸ä¼šå†™å…¥ç¼“å­˜å±‚ã€‚è¿™æ ·å°±å¯¼è‡´æ¯æ¬¡è¯·æ±‚éƒ½è¦å»å­˜å‚¨å±‚æŸ¥è¯¢ï¼Œå¤±å»äº†ç¼“å­˜ä¿æŠ¤åç«¯å­˜å‚¨çš„æ„ä¹‰ã€‚\né€ æˆç¼“å­˜ç©¿é€çš„åŸå› æœ‰ä¸¤ä¸ª:\nè‡ªèº«ä¸šåŠ¡ä»£ç æˆ–è€…æ•°æ®å‡ºç°é—®é¢˜ ä¸€äº›æ¶æ„æ”»å‡»ï¼Œçˆ¬è™«ç­‰é€ æˆå¤§é‡çš„ç©ºå‘½ä¸­ ç¼“å­˜ç©¿é€é—®é¢˜è§£å†³æ–¹æ¡ˆ ç¼“å­˜ç©ºå¯¹è±¡ String get(String key) { // ä»ç¼“å­˜ä¸­è·å–æ•°æ® String cacheValue = cache.get(key); // ç¼“å­˜ä¸ºç©º if (StringUtils.isBlank(cacheValue)) { // ä»å­˜å‚¨ä¸­è·å– String storageValue = storage.get(key); cache.set(key, storageValue); // å¦‚æœå­˜å‚¨æ•°æ®ä¸ºç©ºï¼Œ éœ€è¦è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´(300ç§’) if (storageValue == null) { cache.expire(key, 60 * 5); } return storageValue; } else { // ç¼“å­˜éç©º return cacheValue; } } å¸ƒéš†è¿‡æ»¤å™¨ å¯¹äºæ¶æ„æ”»å‡»ï¼Œå‘æœåŠ¡å™¨è¯·æ±‚å¤§é‡ä¸å­˜åœ¨çš„æ•°æ®é€ æˆçš„ç¼“å­˜ç©¿é€å¯ä»¥å…ˆç”¨å¸ƒéš†è¿‡æ»¤å™¨åšä¸€æ¬¡ç­›é€‰ï¼Œå¯¹äºä¸å­˜åœ¨æ•°æ®ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ä¸€èˆ¬éƒ½èƒ½å¤Ÿè¿‡æ»¤æ‰ï¼Œä¸è®©è¯·æ±‚å†ç»§ç»­å¾€åç«¯èµ°ã€‚\nå¸ƒéš†è¿‡æ»¤å™¨çš„ç‰¹æ€§æ˜¯ï¼šå½“å®ƒè¯´è¿™ä¸ªå€¼å­˜åœ¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼å¯èƒ½å­˜åœ¨ï¼Œä¹Ÿå¯èƒ½ä¸å­˜åœ¨ï¼›å½“å®ƒè¯´ä¸å­˜åœ¨æ—¶ï¼Œè¿™ä¸ªå€¼ä¸€å®šä¸å­˜åœ¨\nå®ƒçš„è¿™ç§ç‰¹æ€§æ˜¯ç”±å®ƒçš„ç®—æ³•å’Œæ•°æ®ç»“æ„å†³å®šçš„ï¼š\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¸ƒéš†è¿‡æ»¤å™¨å°±æ˜¯ä¸€ä¸ªå¤§å‹çš„ä½æ•°ç»„å’Œå‡ ä¸ªä¸ä¸€æ ·çš„æ— åhashå‡½æ•°ï¼Œæ‰€è°“æ— åï¼Œå°±æ˜¯èƒ½å¤ŸæŠŠå…ƒç´ çš„hashå€¼è®¡ç®—çš„æ¯”è¾ƒå‡åŒ€ã€‚å·¥ä½œåŸç†å¦‚ä¸‹ï¼š\nå‘å¸ƒéš†è¿‡æ»¤å™¨æ·»åŠ keyæ—¶ï¼Œä¼šä½¿ç”¨å¤šä¸ªhashå‡½æ•°å¯¹keyè¿›è¡Œhashè¿ç®—ï¼Œå¾—å‡ºä¸€ä¸ªæ•´æ•°ç´¢å¼•å€¼ï¼Œç„¶åå¯¹æ•°ç»„é•¿åº¦è¿›è¡Œå–æ¨¡è¿ç®—ï¼Œå¾—åˆ°åœ¨æ•°ç»„ä¸­çš„ä½ç½®ã€‚æ¯ä¸ªhashå‡½æ•°éƒ½ä¼šç®—çš„ä¸€ä¸ªä¸åŒçš„ä½ç½®ï¼Œå†æŠŠä¸ºä½æ•°ç»„çš„è¿™å‡ ä¸ªä½ç½®éƒ½ç½®ä¸º1ï¼Œå°±å®Œæˆäº†addæ“ä½œ\né‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦å¤šä¸ªhashå‡½æ•°å‘¢ï¼Ÿå…ˆå¸¦ç€é—®é¢˜çœ‹ä¸€ä¸‹å¸ƒéš†è¿‡æ»¤å™¨å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦å­˜åœ¨:\nå½“æ£€æŸ¥ä¸€ä¸ªå…ƒç´ æ˜¯å¦åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­æ—¶ï¼ŒåŒæ ·ä¼šå°†è¯¥å…ƒç´ å“ˆå¸Œæˆå¤šä¸ªä¸åŒçš„ä½æ•°ç»„ä¸‹æ ‡ï¼Œç„¶åæ£€æŸ¥è¿™äº›ä¸‹æ ‡å¯¹åº”çš„ä½æ˜¯å¦éƒ½ä¸º1ã€‚å¦‚æœæœ‰ä»»ä½•ä¸€ä¸ªä½ä¸º0ï¼Œåˆ™å¯ä»¥ç¡®å®šè¯¥å…ƒç´ ä¸€å®šä¸å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼›å¦‚æœæ‰€æœ‰ä½éƒ½ä¸º1ï¼Œåˆ™è¯¥å…ƒç´ å¯èƒ½å­˜åœ¨äºå¸ƒéš†è¿‡æ»¤å™¨ä¸­ï¼Œä½†ä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªå‡é˜³æ€§ï¼ˆfalse positiveï¼‰ã€‚\nè®¾ç½®å¤šä¸ªhashå‡½æ•°ä¸»è¦æ˜¯ä¸ºäº†å‡å°‘å‡é˜³æ€§çš„æ¦‚ç‡ã€‚å½“åªä½¿ç”¨ä¸€ä¸ªå“ˆå¸Œå‡½æ•°æ—¶ï¼Œä¼šæœ‰å¯èƒ½å‡ºç°å¤šä¸ªå…ƒç´ è¢«å“ˆå¸Œåˆ°åŒä¸€ä¸ªä½æ•°ç»„ä¸‹æ ‡çš„æƒ…å†µï¼Œä»è€Œå¯¼è‡´è¯¯åˆ¤ã€‚è€Œä½¿ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°å¯ä»¥è®©å…ƒç´ åˆ†å¸ƒåœ¨æ›´å¤šçš„ä½æ•°ç»„ä¸‹æ ‡ä¸Šï¼Œä»è€Œå‡å°‘å‡é˜³æ€§çš„æ¦‚ç‡ã€‚å½“ä½¿ç”¨kä¸ªå“ˆå¸Œå‡½æ•°æ—¶ï¼Œå‡é˜³æ€§çš„æ¦‚ç‡ä¸º(1 - \\frac{1}{m})^{kn}ï¼Œå…¶ä¸­mæ˜¯ä½æ•°ç»„çš„é•¿åº¦ï¼Œnæ˜¯å…ƒç´ æ•°é‡ã€‚\nå› æ­¤ï¼Œä½¿ç”¨å¤šä¸ªå“ˆå¸Œå‡½æ•°å¯ä»¥æé«˜å¸ƒéš†è¿‡æ»¤å™¨çš„å‡†ç¡®æ€§å’Œå¯é æ€§ã€‚\nç»¼ä¸Šè¿°å¯ä»¥å¾—çŸ¥ï¼Œå¸ƒéš†è¿‡æ»¤å™¨çš„å¯é æ€§å¤§è‡´ç”± hash å‡½æ•°çš„ä¸ªæ•°ï¼Œä»¥åŠä½æ•°ç»„çš„é•¿åº¦å†³å®šã€‚hash å‡½æ•°çš„ä¸ªæ•°è®¡ç®—æœ‰äº›å¤æ‚ï¼Œæš‚æŒ‰ä¸‹ä¸è¡¨ã€‚è€Œä½æ•°ç»„çš„é•¿åº¦ä¸€èˆ¬æˆ‘ä»¬ä¸èƒ½ç›´æ¥è®¾å®šï¼Œè€Œæ˜¯å…ˆè®¾ç½®æˆä¸šåŠ¡ä¸­å¾…æŸ¥æ‰¾æ ·æœ¬çš„æ€»é‡ï¼Œå¸ƒéš†è¿‡æ»¤å™¨ä¼šè‡ªåŠ¨è°ƒæ•´ä½æ•°ç»„çš„é•¿åº¦ã€‚è¿™ä¸ªé•¿åº¦ä¸€èˆ¬å¾ˆå¤§ï¼Œè¿‡äº¿éƒ½æ˜¯æ­£å¸¸çš„ï¼Œå› ä¸ºå®ƒæ˜¯æŒ‰ä½å­˜å‚¨çš„ï¼Œä¸€äº¿çš„é•¿åº¦æ‰€å çš„ç©ºé—´ä¹Ÿå°± 12Mã€‚\nè¿™ç§æ–¹æ³•é€‚ç”¨äºæ•°æ®å‘½ä¸­ä¸é«˜ã€ æ•°æ®ç›¸å¯¹å›ºå®šã€ å®æ—¶æ€§ä½ï¼ˆé€šå¸¸æ˜¯æ•°æ®é›†è¾ƒå¤§ï¼‰ çš„åº”ç”¨åœºæ™¯ï¼Œ ä»£ç ç»´æŠ¤è¾ƒä¸ºå¤æ‚ï¼Œ ä½†æ˜¯ç¼“å­˜ç©ºé—´å ç”¨å¾ˆå°‘ã€‚\nredisson å®ç°å¸ƒéš†è¿‡æ»¤å™¨ å¼•å…¥ä¾èµ– dependency\u0026gt; \u0026lt;groupId\u0026gt;org.redisson\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;redisson\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.6.5\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; é¢„å…ˆæ”¾å…¥æ•°æ® ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨éœ€è¦æŠŠæ‰€æœ‰æ•°æ®æå‰æ”¾å…¥å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå¹¶ä¸”åœ¨å¢åŠ æ•°æ®æ—¶ä¹Ÿè¦å¾€å¸ƒéš†è¿‡æ»¤å™¨é‡Œæ”¾ï¼Œä½†æ˜¯å¸ƒéš†è¿‡æ»¤å™¨ä¸æ”¯æŒåˆ é™¤æ•°æ®ï¼Œå¦‚æœåŸå§‹æ•°æ®åˆ é™¤æ¯”è¾ƒå¤šï¼Œéœ€è¦å®šæœŸé‡ç½®å¸ƒéš†è¿‡æ»¤å™¨ï¼Œä»¥ä¿æŒè¾ƒé«˜çš„æ­£ç¡®æ€§\n/åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ RBloomFilter\u0026lt;String\u0026gt; bloomFilter = redisson.getBloomFilter(\u0026#34;nameList\u0026#34;); //åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ï¼šé¢„è®¡å…ƒç´ ä¸º100000000L,è¯¯å·®ç‡ä¸º3% bloomFilter.tryInit(100000000L,0.03); //æŠŠæ‰€æœ‰æ•°æ®å­˜å…¥å¸ƒéš†è¿‡æ»¤å™¨ voidÂ init(){ keys = [\u0026#34;zhangsan\u0026#34;,\u0026#34;lisi\u0026#34;,\u0026#34;wanger\u0026#34; ....] forÂ (StringÂ key:Â keys)Â { bloomFilter.put(key); } } ä½¿ç”¨ public class RedissonBloomFilter { public static void main(String[] args) { Config config = new Config(); config.useSingleServer().setAddress(\u0026#34;redis://localhost:6379\u0026#34;); //æ„é€ Redisson RedissonClient redisson = Redisson.create(config); RBloomFilter\u0026lt;String\u0026gt; bloomFilter = redisson.getBloomFilter(\u0026#34;nameList\u0026#34;); //åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ï¼šé¢„è®¡å…ƒç´ ä¸º100000000L,è¯¯å·®ç‡ä¸º3%,æ ¹æ®è¿™ä¸¤ä¸ªå‚æ•°ä¼šè®¡ç®—å‡ºåº•å±‚çš„bitæ•°ç»„å¤§å° bloomFilter.tryInit(100000000L,0.03); //åˆ¤æ–­ä¸‹é¢å·ç æ˜¯å¦åœ¨å¸ƒéš†è¿‡æ»¤å™¨ä¸­ System.out.println(bloomFilter.contains(\u0026#34;sa\u0026#34;));//false System.out.println(bloomFilter.contains(\u0026#34;jlsd\u0026#34;));//false System.out.println(bloomFilter.contains(\u0026#34;zhangsan\u0026#34;));//true } } ç¼“å­˜å‡»ç©¿ ç”±äºå¤§æ‰¹é‡ç¼“å­˜åœ¨åŒä¸€æ—¶é—´å¤±æ•ˆå¯èƒ½å¯¼è‡´å¤§é‡å¾—è¯·æ±‚åŒæ—¶ç©¿é€ç¼“å­˜ç›´è¾¾è®¿é—®æ•°æ®åº“ï¼Œå¯èƒ½ä¼šé€ æˆæ•°æ®åº“ç¬é—´å‹åŠ›è¿‡å¤§ç”šè‡³æŒ‚æ‰ã€‚ä¸ºåº”å¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬ä¸€èˆ¬å°†æŸæ‰¹ç¼“å­˜åœ¨è¿‡æœŸçš„æ—¶é—´åŸºç¡€ä¸Šå†åŠ ä¸€ä¸ªçŸ­æš‚çš„éšæœºå€¼ï¼Œé¿å…åŒæ—¶å¤±æ•ˆ, ä¼ªä»£ç å¦‚ä¸‹:\nString get(String key) { // ä»ç¼“å­˜ä¸­è·å–æ•°æ® String cacheValue = cache.get(key); // ç¼“å­˜ä¸ºç©º if (StringUtils.isBlank(cacheValue)) { // ä»å­˜å‚¨ä¸­è·å– String storageValue = storage.get(key); cache.set(key, storageValue); //è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´(300åˆ°600ä¹‹é—´çš„ä¸€ä¸ªéšæœºæ•°) int expireTime = new Random().nextInt(300) + 300; if (storageValue == null) { cache.expire(key, expireTime); } return storageValue; } else { // ç¼“å­˜éç©º return cacheValue; } } ç¼“å­˜é›ªå´© ç¼“å­˜é›ªå´©æŒ‡çš„æ˜¯ç¼“å­˜å±‚æ”¯æ’‘ä¸ä½è¯·æ±‚æˆ–è€…å®•æœºäº†ï¼Œæµé‡ä¼šç›´æ¥å†²å‡»åˆ°åç«¯å­˜å‚¨å±‚ã€‚\nç”±äºç¼“å­˜å±‚æ‰¿è½½è¿™å¤§é‡çš„è¯·æ±‚ï¼Œæœ‰æ•ˆçš„ä¿æŠ¤äº†å­˜å‚¨å±‚ï¼Œä½†æ˜¯å¦‚æœæŸäº›åŸå› å¯¼è‡´ç¼“å­˜å±‚ä¸èƒ½æä¾›æ­£å¸¸çš„æœåŠ¡ï¼Œå¦‚ï¼š\nè¶…å¤§å¹¶å‘ï¼Œç¼“å­˜å±‚æ”¯æ’‘ä¸ä½ ç¼“å­˜è®¾è®¡ä¸å¥½ï¼Œç±»ä¼¼äºå¤§é‡è¯·æ±‚ bigkey,å¯¼è‡´ç¼“å­˜å±‚æœåŠ¡æ€§èƒ½æ€¥å‰§ä¸‹é™\nè¿™æ ·å°±å¯¼è‡´å¤§é‡çš„è¯·æ±‚éƒ½ä¼šæ‰“åˆ°åç«¯ï¼Œé€ æˆå­˜å‚¨å±‚å®•æœº é¢„é˜²å’Œè§£å†³æ–¹æ¡ˆ ä¿è¯ç¼“å­˜æœåŠ¡çš„é«˜å¯ç”¨ï¼Œä½¿ç”¨å“¨å…µæ¶æ„ï¼Œæˆ–è€…é›†ç¾¤æ¶æ„ ä¾èµ–éš”ç¦»ç»„ä»¶ä¸ºåç«¯è¯·æ±‚é™æµç†”æ–­å¹¶é™çº§ï¼Œæ¯”å¦‚ä½¿ç”¨ sentinel æˆ–è€… Hystrix é™æµé™çº§ç»„ä»¶ æ¯”å¦‚æœåŠ¡é™çº§ï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹ä¸åŒçš„æ•°æ®é‡‡å–ä¸åŒçš„å¤„ç†æ–¹å¼ã€‚å½“ä¸šåŠ¡åº”ç”¨è®¿é—®çš„æ˜¯éæ ¸å¿ƒæ•°æ®ï¼ˆä¾‹å¦‚ç”µå•†å•†å“å±æ€§ï¼Œç”¨æˆ·ä¿¡æ¯ç­‰ï¼‰æ—¶ï¼Œæš‚æ—¶åœæ­¢ä»ç¼“å­˜ä¸­æŸ¥è¯¢è¿™äº›æ•°æ®ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›é¢„å®šä¹‰çš„é»˜è®¤é™çº§ä¿¡æ¯ã€ç©ºå€¼æˆ–æ˜¯é”™è¯¯æç¤ºä¿¡æ¯ï¼›å½“ä¸šåŠ¡åº”ç”¨è®¿é—®çš„æ˜¯æ ¸å¿ƒæ•°æ®ï¼ˆä¾‹å¦‚ç”µå•†å•†å“åº“å­˜ï¼‰æ—¶ï¼Œä»ç„¶å…è®¸æŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜ç¼ºå¤±ï¼Œä¹Ÿå¯ä»¥ç»§ç»­é€šè¿‡æ•°æ®åº“è¯»å–ã€‚\næå‰æ¼”ç»ƒã€‚åœ¨é¡¹ç›®ä¸Šçº¿å‰ï¼Œ æ¼”ç»ƒç¼“å­˜å±‚å®•æ‰åï¼Œ åº”ç”¨ä»¥åŠåç«¯çš„è´Ÿè½½æƒ…å†µä»¥åŠå¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œ åœ¨æ­¤åŸºç¡€ä¸Šåšä¸€äº›é¢„æ¡ˆè®¾å®šã€‚ çƒ­ç‚¹keyçš„é‡å»ºä¼˜åŒ– å¯¹äºç¼“å­˜çš„ä½¿ç”¨ä¸€èˆ¬æ˜¯ \u0026ldquo;ç¼“å­˜ + è¿‡æœŸæ—¶é—´\u0026quot;çš„æ–¹å¼ï¼Œæ—¢èƒ½æé«˜æ¥å£çš„å¹¶å‘ï¼Œä¹Ÿèƒ½åœ¨ä¸€å®šçš„æ—¶é—´å†…ä¿è¯æ•°æ®æœ€æ–°ã€‚è¿™ç§æ–¹å¼åŸºæœ¬èƒ½æ»¡è¶³å¤§éƒ¨åˆ†éœ€æ±‚ï¼Œä½†æ˜¯ä¸‹é¢ä¸¤ä¸ªé—®é¢˜åŒæ—¶å‡ºç°æ—¶ï¼Œå¯èƒ½ä¼šå¯¹åº”ç”¨é€ æˆè‡´å‘½çš„ä¼¤å®³:\nå½“å‰keyçƒ­åº¦å¾ˆé«˜ï¼Œå¹¶å‘é‡å¾ˆå¤§ é‡å»ºç¼“å­˜çš„è¿‡ç¨‹æ¯”è¾ƒè€—æ—¶ è¿™ç§æƒ…å†µä¸‹ç¼“å­˜å¤±æ•ˆçš„ç¬é—´ï¼Œæœ‰å¤§é‡çš„çº¿ç¨‹å»é‡å»ºç¼“å­˜ï¼Œé€ æˆåç«¯è´Ÿè½½è¿‡å¤§ï¼Œç”šè‡³å¯¼è‡´å®•æœºã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„å…³é”®æ˜¯è¦é¿å…å¤§é‡çº¿ç¨‹åŒæ—¶é‡å»ºç¼“å­˜ï¼š\nå¯ä»¥ä½¿ç”¨äº’æ–¥é”æ¥è§£å†³ï¼Œæ­¤æ–¹æ³•åªå…è®¸ä¸€ä¸ªçº¿ç¨‹é‡å»ºç¼“å­˜ï¼Œå…¶ä»–çº¿ç¨‹ç­‰å¾…ï¼Œç„¶åé‡æ–°è·å–æœ€æ–°æ•°æ®ï¼Œä¼ªä»£ç å¦‚ä¸‹:\nString get(String key) { // ä»Redisä¸­è·å–æ•°æ® String value = redis.get(key); // å¦‚æœvalueä¸ºç©ºï¼Œ åˆ™å¼€å§‹é‡æ„ç¼“å­˜ if (value == null) { // åªå…è®¸ä¸€ä¸ªçº¿ç¨‹é‡å»ºç¼“å­˜ï¼Œ ä½¿ç”¨nxï¼Œ å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ex String mutexKey = \u0026#34;mutextğŸ”‘\u0026#34; + key; if (redis.set(mutexKey, \u0026#34;1\u0026#34;, \u0026#34;ex 180\u0026#34;, \u0026#34;nx\u0026#34;)) { // ä»æ•°æ®æºè·å–æ•°æ® value = db.get(key); // å›å†™Redisï¼Œ å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ redis.setex(key, timeout, value); // åˆ é™¤key_mutex redis.delete(mutexKey); }// å…¶ä»–çº¿ç¨‹ä¼‘æ¯50æ¯«ç§’åé‡è¯• else { Thread.sleep(50); get(key); } } return value; } ","date":"2023-03-27T07:59:48Z","permalink":"https://dccmmtop.github.io/posts/redis%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%E5%92%8C%E7%A9%BF%E9%80%8F%E4%BB%A5%E5%8F%8A%E9%9B%AA%E5%B4%A9/","section":"posts","tags":["redis"],"title":"Redisç¼“å­˜å‡»ç©¿å’Œç©¿é€ä»¥åŠé›ªå´©"},{"categories":null,"contents":"Redis çš„ä¸»ä»æ¶æ„ ä¸»ä»æ¶æ„æ­å»ºæ­¥éª¤ 1. æ·»åŠ ä»èŠ‚ç‚¹ å¤åˆ¶ä¸€ä»½ redis.conf æ–‡ä»¶ï¼Œå°†ç›¸å…³é…ç½®ä¿®æ”¹å¦‚ä¸‹ï¼š\n# å¦‚æœåœ¨ä¸åŒæœºå™¨ä¸Šéƒ¨ç½²ï¼Œç«¯å£å¯ä»¥ä¸ç”¨ä¿®æ”¹\rport 6380\r# æŠŠ pid è¿›ç¨‹å·å†™å…¥ pidfile é…ç½®çš„æ–‡ä»¶\rpidfile /var/run/redis_6380.pid logfile \u0026#34;6380.log\u0026#34;\r# æŒ‡å®šæ•°æ®å­˜æ”¾ç›®å½•\rdir /usr/local/redis-5.0.3/data/6380 # éœ€è¦æ³¨é‡Šæ‰ bind\r# bind 127.0.0.1ï¼ˆbind ç»‘å®šçš„æ˜¯è‡ªå·±æœºå™¨ç½‘å¡çš„ ipï¼Œå¦‚æœæœ‰å¤šå—ç½‘å¡å¯ä»¥é…å¤šä¸ª ipï¼Œä»£è¡¨å…è®¸å®¢æˆ·ç«¯é€šè¿‡æœºå™¨çš„å“ªäº›ç½‘å¡ ip å»è®¿é—®ï¼Œå†…ç½‘ä¸€èˆ¬å¯ä»¥ä¸é…ç½® bindï¼Œæ³¨é‡Šæ‰å³å¯ï¼‰\r# é…ç½®ä¸»ä»å¤åˆ¶\r# ä» 192.168.2.10 6379 çš„ redis å®ä¾‹å¤åˆ¶æ•°æ®ï¼ŒRedis 5.0 ä¹‹å‰ä½¿ç”¨ slaveof\rreplicaof 192.168.2.10 6379 # é…ç½®ä»èŠ‚ç‚¹åªè¯»\rreplica-read-only yes 2. å¯åŠ¨ä»èŠ‚ç‚¹ redis-server redis.conf\n3. è¿æ¥ä»èŠ‚ç‚¹ redis-cli -p 6380\n4. æµ‹è¯• åœ¨ä¸»èŠ‚ç‚¹ 6379 ä¸Šå†™å¦‚æ•°æ®ï¼Œç„¶ååœ¨ 6380 ä¸Šçœ‹çœ‹æ˜¯å¦èƒ½è¯»å–åˆ°\n5. åŒç†ï¼Œå†æ·»åŠ ä¸€ä¸ª 6381 èŠ‚ç‚¹ Redis ä¸»ä»å·¥ä½œåŸç† å¦‚æœä¸ºä¸€ä¸ª master é…ç½®ä¸€ä¸ª slave ï¼Œä¸ç®¡è¿™ä¸ª slave æ˜¯å¦ç¬¬ä¸€æ¬¡è¿æ¥ä¸Š Masterï¼Œ å®ƒéƒ½ä¼šå‘é€ä¸€ä¸ª PSYNC å‘½ä»¤ç»™ masterï¼Œ è¯·æ±‚å¤åˆ¶æ•°æ®ã€‚ master æ¥æ”¶åˆ° PSYNC å‘½ä»¤åï¼Œä¼šåœ¨åå°é€šè¿‡ bgsave å‘½ä»¤ï¼Œç”Ÿæˆæœ€æ–°çš„ rdb å¿«ç…§æ–‡ä»¶ï¼Œåœ¨æŒä¹…åŒ–æœŸé—´ï¼Œmaster ä¼šç»§ç»­æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼ŒæŠŠå¯èƒ½ä¿®æ”¹æ•°æ®çš„è¯·æ±‚è®°å½•åœ¨å†…å­˜ä¸­ï¼Œmaster ä¼šæŠŠ rdb æ–‡ä»¶å‘ç»™ slaveï¼Œsalve æ¥æ”¶åˆ° rdb æ–‡ä»¶åï¼Œä¿å­˜åœ¨æœ¬åœ°ï¼Œç„¶ååŠ è½½åˆ°å†…å­˜ä¸­ã€‚ ä¹‹åï¼Œmaster ä¼šæŠŠåˆšåˆšè®°å½•åœ¨å†…å­˜ä¸­çš„ä¿®æ”¹æ•°æ®çš„å‘½ä»¤å†å‘ç»™ slaveï¼Œ slave å†ä¾æ¬¡æ‰§è¡Œè¿™äº›å‘½ä»¤ã€‚è¾¾åˆ°æ•°æ®ä¸€è‡´ã€‚ å½“ master ä¸ slave ä¹‹é—´å› ä¸ºç½‘ç»œé—®é¢˜è€Œæ–­å¼€æ—¶ï¼Œ slave èƒ½å¤Ÿè‡ªåŠ¨è¿æ¥åˆ° masterã€‚ å¦‚æœ master æ”¶åˆ°å¤šä¸ª slave çš„è¿æ¥è¯·æ±‚ï¼Œå®ƒåªä¼šè¿›è¡Œä¸€æ¬¡æŒä¹…åŒ–åŠ¨ä½œï¼Œè€Œä¸æ˜¯æ¯ä¸ªè¿æ¥ä¸€æ¬¡ï¼Œç„¶åå†æŠŠè¿™æŒä¹…åŒ–æ–‡ä»¶å‘é€ç»™å„ä¸ª slaveã€‚ ä¸»ä»å…¨é‡å¤åˆ¶çš„æµç¨‹ æ•°æ®çš„éƒ¨åˆ†å¤åˆ¶ å½“ä¸»èŠ‚ç‚¹ä¸ä»èŠ‚ç‚¹æ–­å¼€é‡è¿åï¼Œä¸€èˆ¬éƒ½ä¼šè¿›è¡Œå…¨é‡çš„æ•°æ®å¤åˆ¶ï¼Œä» 2.8 ç‰ˆæœ¬å¼€å§‹ï¼Œredis å¯ä»¥æ”¯æŒéƒ¨åˆ†æ•°æ®å¤åˆ¶çš„å‘½ä»¤ä¸ master åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯æ–­ç‚¹ç»­ä¼ ã€‚\nä¸»èŠ‚ç‚¹ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªå¤åˆ¶æ•°æ®ç”¨çš„ç¼“å­˜é˜Ÿåˆ—ï¼Œè¿™ä¸ªé˜Ÿåˆ—ä¿å­˜è¿™æœ€è¿‘ä¸€æ®µæ—¶é—´çš„æ•°æ®ï¼Œmaster å’Œ slave éƒ½ä¼šç»´æŠ¤å¤åˆ¶æ•°æ®çš„ä¸‹æ ‡ offsetï¼Œå’Œ master çš„è¿›ç¨‹ idã€‚å› æ­¤å½“ç½‘ç»œé‡è¿åï¼Œslave ä¼šè¯·æ±‚ master ç»§ç»­æœªå®Œæˆçš„å¤åˆ¶ï¼Œä»æ‰€è®°å½•çš„ä¸‹æ ‡ä½ç½®å¼€å§‹ï¼Œå¦‚æœ master çš„è¿›ç¨‹ id å˜äº†ï¼Œæˆ–è€…åœ¨ master ä¸­çš„ç¼“å­˜é˜Ÿåˆ—ä¸­æ‰¾ä¸åˆ°è¿™ä¸ªä¸‹æ ‡ï¼Œï¼ˆæ„å‘³ç€ä»èŠ‚ç‚¹çš„ä¸‹æ ‡ offset å¤ªæ—§äº†ï¼‰ é‚£ä¹ˆå°†ä¼šè¿›è¡Œä¸€æ¬¡å…¨é‡çš„æ•°æ®å¤åˆ¶ã€‚\næµç¨‹å›¾å¦‚ä¸‹ï¼š\nä¸»ä»å¤åˆ¶é£æš´ å¦‚æœæœ‰å¾ˆå¤šä¸ªä»èŠ‚ç‚¹ï¼Œå¤šä¸ªä»èŠ‚ç‚¹åŒæ—¶ä»ä¸»èŠ‚ç‚¹å¤åˆ¶æ•°æ®ï¼Œå¯¼è‡´ä¸»èŠ‚ç‚¹å‹åŠ›è¿‡å¤§ï¼Œå¯ä»¥åšå¦‚ä¸‹é˜¶æ¢¯å¼æ¶æ„ï¼Œè®©éƒ¨åˆ†ä»èŠ‚ç‚¹ä»å…¶ä»–ä»èŠ‚ç‚¹å¤åˆ¶æ•°æ®ï¼š\nRedis å“¨å…µé«˜å¯ç”¨æ¶æ„ sentinel å“¨å…µæ˜¯ç‰¹æ®Šçš„ redis æœåŠ¡ï¼Œä¸æä¾›è¯»å†™æœåŠ¡ï¼Œä¸»è¦ç”¨æ¥ç›‘æ§ redis èŠ‚ç‚¹ã€‚\nå“¨å…µæ¶æ„ä¸‹çš„ client ç«¯ç¬¬ä¸€æ¬¡ä»å“¨å…µä¸­æ‰¾å‡ºä¸»èŠ‚ç‚¹ï¼Œåç»­å°±ç›´æ¥è®¿é—® redis çš„ä¸»èŠ‚ç‚¹ï¼Œä¸ä¼šæ¯æ¬¡éƒ½é€šè¿‡å“¨å…µä»£ç†è®¿é—®ä¸»èŠ‚ç‚¹ï¼Œå½“ redis çš„ä¸»èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå“¨å…µä¼šç¬¬ä¸€æ—¶é—´æ„ŸçŸ¥åˆ°ï¼Œå¹¶å°†æ–°çš„ redis ä¸»èŠ‚ç‚¹é€šçŸ¥ç»™å®¢æˆ·ç«¯ï¼Œè¿™é‡Œçš„ redis å®¢æˆ·ç«¯ä¸€èˆ¬éƒ½å®ç°äº†è®¢é˜…åŠŸèƒ½ï¼Œè®¢é˜…å“¨å…µå‘å¸ƒçš„èŠ‚ç‚¹å˜åŠ¨ä¿¡æ¯ã€‚\nå“¨å…µæ¶æ„æ­å»ºæ­¥éª¤ å¤åˆ¶ä¸€ä»½ sentinel.conf æ–‡ä»¶\ncp sentinel.conf sentinel-26379.conf ä¿®æ”¹ç›¸å…³é…ç½® port 26379\rdaemonize yes\rpidfile \u0026#34;/var/run/redis-sentinel-26379.pid\u0026#34;\rlogfile \u0026#34;26379.log\u0026#34;\rdir \u0026#34;/usr/local/redis-5.0.3/data\u0026#34;\r# sentinel monitor \u0026lt;master-redis-name\u0026gt; \u0026lt;master-redis-ip\u0026gt; \u0026lt;master-redis-port\u0026gt; \u0026lt;quorum\u0026gt;\r# quorum æ˜¯ä¸€ä¸ªæ•°å­—ï¼ŒæŒ‡æ˜å½“æœ‰å¤šå°‘ä¸ª sentinel è®¤ä¸ºä¸€ä¸ª master å¤±æ•ˆæ—¶ï¼ˆå€¼ä¸€èˆ¬ä¸ºï¼šsentinel æ€»æ•°/2 + 1)ï¼Œmaster æ‰ç®—çœŸæ­£å¤±æ•ˆ\rsentinel monitor mymaster 192.168.1.32 6379 2 # mymaster è¿™ä¸ªåå­—éšä¾¿å–ï¼Œå®¢æˆ·ç«¯è®¿é—®æ—¶ä¼šç”¨åˆ° å¯åŠ¨å“¨å…µå®ä¾‹ src/redis-sentinel sentinel-26379.conf è¿æ¥ redis å®¢æˆ·ç«¯æ‰§è¡Œ info å‘½ä»¤æŸ¥çœ‹å“¨å…µä¿¡æ¯ å†é…ç½®å¦å¤–ä¸¤ä¸ª sentinel, ç«¯å£ä¸º 26380ï¼Œ 26381 å“¨å…µé›†ç¾¤å¯åŠ¨å®Œæ¯•åï¼Œä¼šå°†å“¨å…µé›†ç¾¤çš„å…ƒä¿¡æ¯å†™å…¥æ‰€æœ‰çš„ sentinel çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œä¾‹å¦‚ï¼š\nsentinel known-replica mymaster 192.168.0.60 6380 #ä»£è¡¨ redis ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ä¿¡æ¯ sentinel known-replica mymaster 192.168.0.60 6381 #ä»£è¡¨ redis ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ä¿¡æ¯ sentinel known-sentinel mymaster 192.168.0.60 26380 52d0a5d70c1f90475b4fc03b6ce7c3c56935760f #ä»£è¡¨æ„ŸçŸ¥åˆ°çš„å…¶å®ƒå“¨å…µèŠ‚ç‚¹ sentinel known-sentinel mymaster 192.168.0.60 26381 e9f530d3882f8043f76ebb8e1686438ba8bd5ca6 #ä»£è¡¨æ„ŸçŸ¥åˆ°çš„å…¶å®ƒå“¨å…µèŠ‚ç‚¹ å¦‚æœä¸»èŠ‚ç‚¹ï¼ˆ6379ï¼‰å®•æœºï¼Œå“¨å…µé›†ç¾¤ä¼šé‡æ–°é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹ï¼ŒåŒæ—¶ä¿®æ”¹æ‰€æœ‰ sentinel èŠ‚ç‚¹é…ç½®æ–‡ä»¶çš„é›†ç¾¤å…ƒä¿¡æ¯ï¼Œ åŒæ—¶è¿˜ä¼šä¿®æ”¹ sentinel é…ç½®æ–‡ä»¶ä¸­çš„ mymaster å¯¹åº”çš„ 6379 ç«¯å£ï¼Œæ”¹ä¸º 6380:\nsentinel monitor mymaster 192.168.0.60 6380 2 å½“ 6379 èŠ‚ç‚¹å†æ¬¡å¯åŠ¨æ—¶ï¼Œå“¨å…µé›†ç¾¤æ ¹æ®é›†ç¾¤å…ƒä¿¡æ¯å°±å¯ä»¥å°† 6379 ä½œä¸ºä»èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ä¸­ã€‚\nRedis é›†ç¾¤ TODO:\njava ä½¿ç”¨ Jedis è¿æ¥é›†ç¾¤ public class JedisSentinelTest { public static void main(String[] args) throws IOException { JedisPoolConfig config = new JedisPoolConfig(); config.setMaxTotal(20); config.setMaxIdle(10); config.setMinIdle(5); String masterName = \u0026#34;mymaster\u0026#34;; Set\u0026lt;String\u0026gt; sentinels = new HashSet\u0026lt;String\u0026gt;(); sentinels.add(new HostAndPort(\u0026#34;192.168.1.32\u0026#34;,26379).toString()); sentinels.add(new HostAndPort(\u0026#34;192.168.1.32\u0026#34;,26380).toString()); sentinels.add(new HostAndPort(\u0026#34;192.168.1.32\u0026#34;,26381).toString()); //JedisSentinelPool å…¶å®æœ¬è´¨è·Ÿ JedisPool ç±»ä¼¼ï¼Œéƒ½æ˜¯ä¸ redis ä¸»èŠ‚ç‚¹å»ºç«‹çš„è¿æ¥æ±  //JedisSentinelPool å¹¶ä¸æ˜¯è¯´ä¸ sentinel å»ºç«‹çš„è¿æ¥æ± ï¼Œè€Œæ˜¯é€šè¿‡ sentinel å‘ç° redis ä¸»èŠ‚ç‚¹å¹¶ä¸å…¶å»ºç«‹è¿æ¥ JedisSentinelPool jedisSentinelPool = new JedisSentinelPool(masterName, sentinels, config, 3000, null); Jedis jedis = null; try { jedis = jedisSentinelPool.getResource(); System.out.println(jedis.set(\u0026#34;sentinel\u0026#34;, \u0026#34;dc\u0026#34;)); System.out.println(jedis.get(\u0026#34;sentinel\u0026#34;)); } catch (Exception e) { e.printStackTrace(); } finally { //æ³¨æ„è¿™é‡Œä¸æ˜¯å…³é—­è¿æ¥ï¼Œåœ¨ JedisPool æ¨¡å¼ä¸‹ï¼ŒJedis ä¼šè¢«å½’è¿˜ç»™èµ„æºæ± ã€‚ if (jedis != null) jedis.close(); } } } spting-boot è¿æ¥é›†ç¾¤ å¼•å…¥ä¾èµ– dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-data-redis\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.apache.commons\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;commons-pool2\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; é…ç½®ä¿¡æ¯ server: port: 8080 spring: redis: database: 0 timeout: 3000 sentinel: #å“¨å…µæ¨¡å¼ master: mymaster #ä¸»æœåŠ¡å™¨æ‰€åœ¨é›†ç¾¤åç§° nodes: 192.168.1.32:26379,192.168.1.32:26380,192.168.1.32:26381 lettuce: pool: max-idle: 50 min-idle: 10 max-active: 100 max-wait: 1000 è®¿é—®ä»£ç  @RestController public class IndexController { private static final Logger logger = LoggerFactory.getLogger(IndexController.class); @Autowired private StringRedisTemplate stringRedisTemplate; /** * æµ‹è¯•èŠ‚ç‚¹æŒ‚äº†å“¨å…µé‡æ–°é€‰ä¸¾æ–°çš„ master èŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯æ˜¯å¦èƒ½åŠ¨æ€æ„ŸçŸ¥åˆ° * æ–°çš„ master é€‰ä¸¾å‡ºæ¥åï¼Œå“¨å…µä¼šæŠŠæ¶ˆæ¯å‘å¸ƒå‡ºå»ï¼Œå®¢æˆ·ç«¯å®é™…ä¸Šæ˜¯å®ç°äº†ä¸€ä¸ªæ¶ˆæ¯ç›‘å¬æœºåˆ¶ï¼Œ * å½“å“¨å…µæŠŠæ–° master çš„æ¶ˆæ¯å‘å¸ƒå‡ºå»ï¼Œå®¢æˆ·ç«¯ä¼šç«‹é©¬æ„ŸçŸ¥åˆ°æ–° master çš„ä¿¡æ¯ï¼Œä»è€ŒåŠ¨æ€åˆ‡æ¢è®¿é—®çš„ masterip * * @throws InterruptedException */ @RequestMapping(\u0026#34;/test_sentinel\u0026#34;) public void testSentinel() throws InterruptedException { int i = 1; while (true){ try { stringRedisTemplate.opsForValue().set(\u0026#34;zhuge\u0026#34;+i, i+\u0026#34;\u0026#34;); System.out.println(\u0026#34;è®¾ç½® keyï¼š\u0026#34;+ \u0026#34;zhuge\u0026#34; + i); i++; Thread.sleep(1000); }catch (Exception e){ logger.error(\u0026#34;é”™è¯¯ï¼š\u0026#34;, e); } } } } StringRedisTemplate ä¸ RedisTemplate è¯¦è§£ spring å°è£…äº† RedisTemplate å¯¹è±¡æ¥è¿›è¡Œå¯¹ redis çš„å„ç§æ“ä½œï¼Œå®ƒæ”¯æŒæ‰€æœ‰çš„ redis åŸç”Ÿçš„ apiã€‚åœ¨ RedisTemplate ä¸­æä¾›äº†å‡ ä¸ªå¸¸ç”¨çš„æ¥å£æ–¹æ³•çš„ä½¿ç”¨ï¼Œåˆ†åˆ«æ˜¯ï¼š\nprivate ValueOperations\u0026lt;K, V\u0026gt; valueOps; private HashOperations\u0026lt;K, V\u0026gt; hashOps; private ListOperations\u0026lt;K, V\u0026gt; listOps; private SetOperations\u0026lt;K, V\u0026gt; setOps; private ZSetOperations\u0026lt;K, V\u0026gt; zSetOps; // RedisTemplate ä¸­å®šä¹‰äº†å¯¹ 5 ç§æ•°æ®ç»“æ„æ“ä½œ redisTemplate.opsForValue();//æ“ä½œå­—ç¬¦ä¸² redisTemplate.opsForHash();//æ“ä½œ hash redisTemplate.opsForList();//æ“ä½œ list redisTemplate.opsForSet();//æ“ä½œ set redisTemplate.opsForZSet();//æ“ä½œæœ‰åº set StringRedisTemplate ç»§æ‰¿è‡ª RedisTemplateï¼Œä¹Ÿä¸€æ ·æ‹¥æœ‰ä¸Šé¢è¿™äº›æ“ä½œã€‚\nStringRedisTemplate é»˜è®¤é‡‡ç”¨çš„æ˜¯ String çš„åºåˆ—åŒ–ç­–ç•¥ï¼Œä¿å­˜çš„ key å’Œ value éƒ½æ˜¯é‡‡ç”¨æ­¤ç­–ç•¥åºåˆ—åŒ–ä¿å­˜çš„ã€‚\nRedisTemplate é»˜è®¤é‡‡ç”¨çš„æ˜¯ JDK çš„åºåˆ—åŒ–ç­–ç•¥ï¼Œä¿å­˜çš„ key å’Œ value éƒ½æ˜¯é‡‡ç”¨æ­¤ç­–ç•¥åºåˆ—åŒ–ä¿å­˜çš„ã€‚\nRedis å®¢æˆ·ç«¯å‘½ä»¤å¯¹åº”çš„ RedisTemplate ä¸­çš„æ–¹æ³•åˆ—è¡¨ï¼š\nString ç±»å‹ç»“æ„ Redis RedisTemplate rt set key value rt.opsForValue().set(\u0026ldquo;key\u0026rdquo;,\u0026ldquo;value\u0026rdquo;) get key rt.opsForValue().get(\u0026ldquo;key\u0026rdquo;) del key rt.delete(\u0026ldquo;key\u0026rdquo;) strlen key rt.opsForValue().size(\u0026ldquo;key\u0026rdquo;) getset key value rt.opsForValue().getAndSet(\u0026ldquo;key\u0026rdquo;,\u0026ldquo;value\u0026rdquo;) getrange key start end rt.opsForValue().get(\u0026ldquo;key\u0026rdquo;,start,end) append key value rt.opsForValue().append(\u0026ldquo;key\u0026rdquo;,\u0026ldquo;value\u0026rdquo;) Hash ç»“æ„ hmset key field1 value1 field2 value2\u0026hellip; rt.opsForHash().putAll(\u0026ldquo;key\u0026rdquo;,map) //map æ˜¯ä¸€ä¸ªé›†åˆå¯¹è±¡ hset key field value rt.opsForHash().put(\u0026ldquo;key\u0026rdquo;,\u0026ldquo;field\u0026rdquo;,\u0026ldquo;value\u0026rdquo;) hexists key field rt.opsForHash().hasKey(\u0026ldquo;key\u0026rdquo;,\u0026ldquo;field\u0026rdquo;) hgetall key rt.opsForHash().entries(\u0026ldquo;key\u0026rdquo;) //è¿”å› Map å¯¹è±¡ hvals key rt.opsForHash().values(\u0026ldquo;key\u0026rdquo;) //è¿”å› List å¯¹è±¡ hkeys key rt.opsForHash().keys(\u0026ldquo;key\u0026rdquo;) //è¿”å› List å¯¹è±¡ hmget key field1 field2\u0026hellip; rt.opsForHash().multiGet(\u0026ldquo;key\u0026rdquo;,keyList) hsetnx key field value rt.opsForHash().putIfAbsent(\u0026ldquo;key\u0026rdquo;,\u0026ldquo;field\u0026rdquo;,\u0026ldquo;value\u0026rdquo; hdel key field1 field2 rt.opsForHash().delete(\u0026ldquo;key\u0026rdquo;,\u0026ldquo;field1\u0026rdquo;,\u0026ldquo;field2\u0026rdquo;) hget key field rt.opsForHash().get(\u0026ldquo;key\u0026rdquo;,\u0026ldquo;field\u0026rdquo;) List ç»“æ„ lpush list node1 node2 node3\u0026hellip; rt.opsForList().leftPush(\u0026ldquo;list\u0026rdquo;,\u0026ldquo;node\u0026rdquo;) rt.opsForList().leftPushAll(\u0026ldquo;list\u0026rdquo;,list) //list æ˜¯é›†åˆå¯¹è±¡ rpush list node1 node2 node3\u0026hellip; rt.opsForList().rightPush(\u0026ldquo;list\u0026rdquo;,\u0026ldquo;node\u0026rdquo;) rt.opsForList().rightPushAll(\u0026ldquo;list\u0026rdquo;,list) //list æ˜¯é›†åˆå¯¹è±¡ lindex key index rt.opsForList().index(\u0026ldquo;list\u0026rdquo;, index) llen key rt.opsForList().size(\u0026ldquo;key\u0026rdquo;) lpop key rt.opsForList().leftPop(\u0026ldquo;key\u0026rdquo;) rpop key rt.opsForList().rightPop(\u0026ldquo;key\u0026rdquo;) lpushx list node rt.opsForList().leftPushIfPresent(\u0026ldquo;list\u0026rdquo;,\u0026ldquo;node\u0026rdquo;) rpushx list node rt.opsForList().rightPushIfPresent(\u0026ldquo;list\u0026rdquo;,\u0026ldquo;node\u0026rdquo;) lrange list start end rt.opsForList().range(\u0026ldquo;list\u0026rdquo;,start,end) lrem list count value rt.opsForList().remove(\u0026ldquo;list\u0026rdquo;,count,\u0026ldquo;value\u0026rdquo;) lset key index value rt.opsForList().set(\u0026ldquo;list\u0026rdquo;,index,\u0026ldquo;value\u0026rdquo;) Set ç»“æ„ sadd key member1 member2\u0026hellip; rt.boundSetOps(\u0026ldquo;key\u0026rdquo;).add(\u0026ldquo;member1\u0026rdquo;,\u0026ldquo;member2\u0026rdquo;,\u0026hellip;) rt.opsForSet().add(\u0026ldquo;key\u0026rdquo;, set) //set æ˜¯ä¸€ä¸ªé›†åˆå¯¹è±¡ scard key rt.opsForSet().size(\u0026ldquo;key\u0026rdquo;) sidff key1 key2 rt.opsForSet().difference(\u0026ldquo;key1\u0026rdquo;,\u0026ldquo;key2\u0026rdquo;) //è¿”å›ä¸€ä¸ªé›†åˆå¯¹è±¡ sinter key1 key2 rt.opsForSet().intersect(\u0026ldquo;key1\u0026rdquo;,\u0026ldquo;key2\u0026rdquo;)//åŒä¸Š sunion key1 key2 rt.opsForSet().union(\u0026ldquo;key1\u0026rdquo;,\u0026ldquo;key2\u0026rdquo;)//åŒä¸Š sdiffstore des key1 key2 rt.opsForSet().differenceAndStore(\u0026ldquo;key1\u0026rdquo;,\u0026ldquo;key2\u0026rdquo;,\u0026ldquo;des\u0026rdquo;) sinter des key1 key2 rt.opsForSet().intersectAndStore(\u0026ldquo;key1\u0026rdquo;,\u0026ldquo;key2\u0026rdquo;,\u0026ldquo;des\u0026rdquo;) sunionstore des key1 key2 rt.opsForSet().unionAndStore(\u0026ldquo;key1\u0026rdquo;,\u0026ldquo;key2\u0026rdquo;,\u0026ldquo;des\u0026rdquo;) sismember key member rt.opsForSet().isMember(\u0026ldquo;key\u0026rdquo;,\u0026ldquo;member\u0026rdquo;) smembers key rt.opsForSet().members(\u0026ldquo;key\u0026rdquo;) spop key rt.opsForSet().pop(\u0026ldquo;key\u0026rdquo;) srandmember key count rt.opsForSet().randomMember(\u0026ldquo;key\u0026rdquo;,count) srem key member1 member2\u0026hellip; rt.opsForSet().remove(\u0026ldquo;key\u0026rdquo;,\u0026ldquo;member1\u0026rdquo;,\u0026ldquo;member2\u0026rdquo;,\u0026hellip;) ","date":"2023-03-23T08:01:20Z","permalink":"https://dccmmtop.github.io/posts/redis%E7%9A%84%E4%B8%BB%E4%BB%8E%E5%92%8C%E5%93%A8%E5%85%B5%E4%BB%A5%E5%8F%8A%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84/","section":"posts","tags":["redis"],"title":"Redis çš„ä¸»ä»å’Œå“¨å…µä»¥åŠé›†ç¾¤æ¶æ„"},{"categories":null,"contents":"redis çš„å•çº¿ç¨‹å’Œå’Œé«˜æ€§èƒ½ redis æ˜¯å•çº¿ç¨‹çš„å— Redis çš„å•çº¿ç¨‹ä¸»è¦æ˜¯æŒ‡ç½‘ç»œ IO å’Œé”®å€¼å¯¹è¯»å†™æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹å®Œæˆçš„ï¼Œè¿™ä¹Ÿæ˜¯ Redis å¯¹å¤–æä¾›é”®å€¼å­˜å‚¨æœåŠ¡çš„ä¸»è¦æµç¨‹ã€‚ä½† Redis çš„å…¶ä»–åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼šæŒä¹…åŒ–ï¼Œå¼‚æ­¥åˆ é™¤ï¼Œé›†ç¾¤æ•°æ®åŒæ­¥ç­‰ï¼Œå…¶å®æ˜¯ç”±é¢å¤–çš„çº¿ç¨‹æ‰§è¡Œçš„ã€‚\nRedis å•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿˜èƒ½è¿™ä¹ˆå¿«ï¼Ÿ å› ä¸ºå®ƒçš„æ‰€æœ‰æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼Œæ‰€æœ‰çš„è¿ç®—éƒ½æ˜¯å†…å­˜çº§åˆ«çš„è¿ç®—ï¼Œè€Œä¸”é¿å…äº†å¤šçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æŸè€—ã€‚\næ­£å› ä¸º Redis æ˜¯å•çº¿ç¨‹çš„ï¼Œä½¿ç”¨çš„è¿‡ç¨‹ä¸­ä¸€å®šè¦æ³¨æ„é¿å…é˜»å¡æ“ä½œï¼Œæ¯”å¦‚ åœ¨ key æ•°é‡éå¸¸å¤šçš„æƒ…å†µä¸‹ä½¿ç”¨ keys *ï¼Œ è¿™ä¼šé˜»å¡åç»­æ‰€æœ‰ redis å¯¹ key çš„æ“ä½œã€‚\nRedis å•çº¿ç¨‹å¦‚ä½•å¤„ç†å¤šå®¢æˆ·ç«¯å¹¶å‘è¿æ¥ Redis çš„ IO å¤šè·¯å¤ç”¨ï¼Œredis åˆ©ç”¨ epoll æ¥å®ç° IO å¤šè·¯å¤ç”¨ï¼Œå°†è¿æ¥ä¿¡æ¯å’Œäº‹ä»¶æ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œä¾æ¬¡æ”¾åˆ°æ–‡ä»¶äº‹ä»¶åˆ†æ´¾å™¨ï¼Œäº‹ä»¶åˆ†æ´¾å™¨å°†äº‹ä»¶åˆ†å‘ç»™äº‹ä»¶å¤„ç†å™¨ã€‚\nå¦‚å›¾ï¼š\nredis æ”¯æŒçš„æœ€å¤§è¿æ¥æ•° åœ¨é…ç½®æ–‡ä»¶ä¸­ redis.conf :\nmaxlients 6000 ä¹Ÿå¯ä»¥åœ¨ redis-cli ä¸­æŸ¥çœ‹ï¼š\n127.0.0.1:6379\u0026gt; CONFIG GET maxclients \u0026#34;maxclients\u0026#34; \u0026#34;6000\u0026#34; æŸ¥çœ‹æœåŠ¡è¿è¡Œä¿¡æ¯ info å‘½ä»¤å¯ä»¥æŸ¥çœ‹ redis æœåŠ¡è¿è¡Œä¿¡æ¯ï¼Œåˆ†ä¸º 9 å¤§å—ï¼Œåˆ†åˆ«æ˜¯ï¼š\nServer æœåŠ¡å™¨è¿è¡Œå‚æ•° Clients å®¢æˆ·ç«¯ç›¸å…³ä¿¡æ¯ Memory æœåŠ¡å™¨è¿è¡Œå†…å­˜ç»Ÿè®¡æ•°æ® Persistence æŒä¹…åŒ–ä¿¡æ¯ Stats é€šç”¨ç»Ÿè®¡æ•°æ® Replication ä¸»ä»å¤åˆ¶ç›¸å…³ä¿¡æ¯ CPU CPU ä½¿ç”¨æƒ…å†µ Cluster é›†ç¾¤ä¿¡æ¯ KeySpace é”®å€¼å¯¹ç»Ÿè®¡æ•°é‡ä¿¡æ¯ ä¸‹é¢ç®€è¦ä»‹ç»ä¸€äº›ä¿¡æ¯ï¼š\nconnected_clients:2 # æ­£åœ¨è¿æ¥çš„å®¢æˆ·ç«¯æ•°é‡ instantaneous_ops_per_sec:789 # æ¯ç§’æ‰§è¡Œå¤šå°‘æ¬¡æŒ‡ä»¤ used_memory:929864 # Redis åˆ†é…çš„å†…å­˜æ€»é‡ (byte)ï¼ŒåŒ…å« redis è¿›ç¨‹å†…éƒ¨çš„å¼€é”€å’Œæ•°æ®å ç”¨çš„å†…å­˜ used_memory_human:908.07K # Redis åˆ†é…çš„å†…å­˜æ€»é‡ (Kbï¼Œhuman ä¼šå±•ç¤ºå‡ºå•ä½ï¼‰ used_memory_rss_human:2.28M # å‘æ“ä½œç³»ç»Ÿç”³è¯·çš„å†…å­˜å¤§å° (Mb)ï¼ˆè¿™ä¸ªå€¼ä¸€èˆ¬æ˜¯å¤§äº used_memory çš„ï¼Œå› ä¸º Redis çš„å†…å­˜åˆ†é…ç­–ç•¥ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼‰ used_memory_peak:929864 # redis çš„å†…å­˜æ¶ˆè€—å³°å€¼ (byte) used_memory_peak_human:908.07K # redis çš„å†…å­˜æ¶ˆè€—å³°å€¼ (KB) maxmemory:0 # é…ç½®ä¸­è®¾ç½®çš„æœ€å¤§å¯ä½¿ç”¨å†…å­˜å€¼ (byte), é»˜è®¤ 0, ä¸é™åˆ¶ï¼Œä¸€èˆ¬é…ç½®ä¸ºæœºå™¨ç‰©ç†å†…å­˜çš„ç™¾åˆ†ä¹‹ä¸ƒå…«åï¼Œéœ€è¦ç•™ä¸€éƒ¨åˆ†ç»™æ“ä½œç³»ç»Ÿ maxmemory_human:0B # é…ç½®ä¸­è®¾ç½®çš„æœ€å¤§å¯ä½¿ç”¨å†…å­˜å€¼ maxmemory_policy:noeviction # å½“è¾¾åˆ° maxmemory æ—¶çš„æ·˜æ±°ç­–ç•¥ Redis æŒä¹…åŒ– RDB å¿«ç…§ é»˜è®¤æƒ…å†µä¸‹ï¼Œredis å°†å†…å­˜æ•°æ®åº“å¿«ç…§ä¿å­˜åœ¨åå­—ä¸º dump.rbd çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­\nå¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½® \u0026ldquo;N ç§’å†…è‡³å°‘æœ‰ M ä¸ªæ”¹åŠ¨\u0026rdquo; æ¡ä»¶è§¦å‘æ—¶ï¼Œè‡ªåŠ¨ä¿å­˜ä¸€æ¬¡æ•°æ®ï¼Œé…ç½®é¡¹æ˜¯ save, å¦‚ï¼š\nsave 60 1000 è¿™ä¸ªé…ç½®è®© redis åœ¨æ»¡è¶³ â€œ60 ç§’å†…è‡³å°‘æœ‰ 1000 ä¸ªé”®æ”¹åŠ¨â€ æ¡ä»¶æ—¶ï¼Œè‡ªåŠ¨ä¿å­˜ä¸€æ¬¡æ•°æ®é›†\nè¿˜å¯ä»¥æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤ç”Ÿæˆ RDB å¿«ç…§ï¼Œè¿›å…¥ reids å®¢æˆ·ç«¯å‘½ä»¤æ‰§è¡Œ save æˆ–è€… bgsave å¯ä»¥ç”Ÿæˆ dump.rbd æ–‡ä»¶ï¼Œæ¯æ¬¡æ‰§è¡Œå‘½ä»¤éƒ½ä¼šå°†å†…å­˜ä¸­çš„æ•°æ®ä¿å­˜åˆ°ä¸€ä¸ªæ–°çš„ rdb æ–‡ä»¶ä¸­ï¼Œå¹¶è¦†ç›–åŸæœ‰çš„ rdb å¿«ç…§æ–‡ä»¶\nå¦‚æœæƒ³å…³é—­ RDB å¿«ç…§åŠŸèƒ½ï¼Œç›´æ¥å°†æ­¤é…ç½®æ³¨é‡Šå³å¯\nbgsave çš„å†™æ—¶å¤åˆ¶æœºåˆ¶ (COW) reids å€ŸåŠ©æ“ä½œç³»ç»Ÿæä¾›çš„å†™æ—¶å¤åˆ¶æŠ€æœ¯ (Copy-On-Write) åœ¨ç”Ÿæˆå¿«ç…§çš„åŒæ—¶ï¼Œä¾ç„¶å¯ä»¥è¿›è¡Œå†™å‘½ä»¤ã€‚å®ç°æœºåˆ¶æ˜¯ï¼šbgsave æ˜¯ç”±å­è¿›ç¨‹æ“ä½œçš„ï¼Œå®ƒæœ‰ä¸»çº¿ç¨‹ fork ç”Ÿæˆï¼Œå¯ä»¥å…±äº«ä¸»çº¿ç¨‹çš„æ‰€æœ‰å†…å­˜æ•°æ®ï¼Œbgsave å­è¿›ç¨‹ç”Ÿæˆåï¼Œå®ƒå¼€å§‹è¯»å–ä¸»çº¿ç¨‹çš„å†…å­˜æ•°æ®ï¼Œå¹¶æŠŠä»–ä»¬å†™å…¥ RDB æ–‡ä»¶ã€‚ æ­¤æ—¶ å¦‚æœä¸»çº¿ç¨‹å¯¹æ•°æ®éƒ½æ˜¯è¯»æ“ä½œï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹å’Œå­è¿›ç¨‹äº’ä¸å½±å“ï¼Œä½†æ˜¯å¦‚æœä¸»çº¿ç¨‹è¦ä¿®æ”¹ä¸€å—æ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®å°±ä¼šè¢«å¤åˆ¶ä¸€ä»½ï¼Œç”Ÿæˆè¯¥æ•°æ®çš„å‰¯æœ¬ï¼Œbgsave å­è¿›ç¨‹ä¼šæŠŠè¿™ä¸ªå‰¯æœ¬æ•°æ®å†™å…¥ RDB æ–‡ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»è¿›ç¨‹ä»ç„¶å¯ä»¥ç›´æ¥ä¿®æ”¹åŸæ¥çš„æ•°æ®ã€‚\nåœ¨é…ç½®æ–‡ä»¶æŒ‡å®š save 60 1000 ç”¨çš„æ˜¯ basave çš„æ–¹å¼\nsave ä¸ bgsave çš„å¯¹æ¯” save bgsave IO ç±»å‹ åŒæ­¥ å¼‚æ­¥ æ˜¯å¦é˜»å¡ redis å…¶å®ƒå‘½ä»¤ æ˜¯ å¦ å¤æ‚åº¦ O(n) O(n) ä¼˜ç‚¹ ä¸ä¼šæ¶ˆè€—é¢å¤–çš„å†…å­˜ ä¸é˜»å¡å®¢æˆ·ç«¯å‘½ä»¤ ç¼ºç‚¹ é˜»å¡å®¢æˆ·ç«¯å‘½ä»¤ éœ€è¦ fork å­è¿›ç¨‹ï¼Œæ¶ˆè€—å†…å­˜ AOF(append-only file) å¿«ç…§åŠŸèƒ½å¹¶ä¸æ˜¯éå¸¸è€ä¹…ï¼ˆdurableï¼‰ï¼š å¦‚æœ Redis å› ä¸ºæŸäº›åŸå› è€Œé€ æˆæ•…éšœåœæœºï¼Œ **é‚£ä¹ˆæœåŠ¡å™¨å°†ä¸¢å¤± æœ€è¿‘å†™å…¥ã€ä¸”ä»æœªä¿å­˜åˆ°å¿«ç…§ä¸­çš„é‚£äº›æ•°æ®ã€‚**ä» 1.1 ç‰ˆæœ¬å¼€å§‹ï¼Œ Redis å¢åŠ äº†ä¸€ç§å®Œå…¨è€ä¹…çš„æŒä¹…åŒ–æ–¹å¼ï¼š AOF æŒä¹…åŒ–ï¼Œå°†ä¿®æ”¹çš„æ¯ä¸€æ¡æŒ‡ä»¤è®°å½•è¿›æ–‡ä»¶ appendonly.aof ä¸­ï¼ˆå…ˆå†™å…¥ os cacheï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ fsync åˆ°ç£ç›˜ï¼‰\næ¯”å¦‚æ‰§è¡Œå‘½ä»¤set dc 666ï¼Œaof æ–‡ä»¶é‡Œä¼šè®°å½•å¦‚ä¸‹æ•°æ®\n1 *3 2 $3 3 set 4 $5 5 dc 6 $3 7 666 è¿™æ˜¯ä¸€ç§ resp åè®®æ ¼å¼æ•°æ®ï¼Œæ˜Ÿå·åé¢çš„æ•°å­—ä»£è¡¨å‘½ä»¤æœ‰å¤šå°‘ä¸ªå‚æ•°ï¼Œ$å·åé¢çš„æ•°å­—ä»£è¡¨è¿™ä¸ªå‚æ•°æœ‰å‡ ä¸ªå­—ç¬¦ï¼Œæ³¨æ„ï¼šå¦‚æœæ‰§è¡Œå¸¦è¿‡æœŸæ—¶é—´çš„ set å‘½ä»¤ï¼Œaof æ–‡ä»¶é‡Œè®°å½•çš„æ˜¯å¹¶ä¸æ˜¯æ‰§è¡Œçš„åŸå§‹å‘½ä»¤ï¼Œè€Œæ˜¯è®°å½• key è¿‡æœŸçš„æ—¶é—´æˆ³\nå¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥æ‰“å¼€ AOF åŠŸèƒ½ï¼š\nappendonly yes å½“ Redis é‡æ–°å¯åŠ¨æ—¶ï¼Œ ç¨‹åºå°±å¯ä»¥é€šè¿‡é‡æ–°æ‰§è¡Œ AOF æ–‡ä»¶ä¸­çš„å‘½ä»¤æ¥è¾¾åˆ°é‡å»ºæ•°æ®é›†çš„ç›®çš„ï¼Œç”±äº redis ä¸æ˜¯ç›´æ¥æŠŠå‘½ä»¤å†™å…¥ç£ç›˜ï¼Œè€Œæ˜¯å…ˆå†™å…¥ os cache, éš”ä¸€æ®µæ—¶é—´æ‰æŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ï¼Œæ•…è€Œå¯ä»¥é…ç½® Redis å¤šä¹…æ‰å°†æ•°æ® fsync å¾—åˆ°ç£ç›˜ä¸€æ¬¡ï¼Œæœ‰ä¸‰ç§é€‰æ‹©ï¼š\nappenfsync always # æ¯æ¬¡æœ‰æ–°å‘½ä»¤è¿½åŠ åˆ° AOF æ–‡ä»¶æ—¶ï¼Œå°±æ‰§è¡Œä¸€æ¬¡ fsyncï¼Œ éå¸¸æ…¢ä¹Ÿéå¸¸å®‰å…¨ appenfsync everysec # æ¯ç§’ fsnc ä¸€æ¬¡ï¼Œè¶³å¤Ÿå¿«ï¼Œå¹¶ä¸”æŒ‡æŒ¥ä¸¢å¤± 1 ç§’ä¸­çš„æ•°æ®ã€‚ appenfsync no # ä»ä¸ fsync ä¾èµ–æ“ä½œç³»ç»Ÿå¤„ç†ï¼Œå¤Ÿå¿«ï¼Œä½†ä¸å¤Ÿå®‰å…¨ æ¨èæ¯ç§’ä¸€æ¬¡ï¼Œä¹Ÿæ˜¯é»˜è®¤çš„é…ç½®ï¼Œ å…¼é¡¾é€Ÿåº¦å’Œå®‰å…¨\nAOF é‡å†™ åŠ å…¥å¯¹ä¸€ä¸ª key è¿›è¡Œ N æ¬¡ç´¯åŠ ï¼š incr viewCnt, AOF æ–‡ä»¶ä¸­å°±ä¼šè®°å½• N æ¬¡è¿™ä¸ªå‘½ä»¤ï¼Œå…¶å®åªéœ€è®°å½• incr ViewCnt N å³å¯ã€‚ æ‰€ä»¥ reids ä¼šå®šæœŸå¯¹ AOF ä¸­çš„å‘½ä»¤é‡å†™ï¼Œä»¥ä¾¿å°†æ¥å¯ä»¥æ›´å¿«çš„æ¢å¤æ•°æ®ã€‚\næœ‰ä¸¤ä¸ªé…ç½®å¯ä»¥æ§åˆ¶é‡å†™çš„é¢‘ç‡ï¼š\nautoâ€aofâ€rewriteâ€minâ€size 64mb # aof æ–‡ä»¶è‡³å°‘è¦è¾¾åˆ° 64M æ‰ä¼šè‡ªåŠ¨é‡å†™ï¼Œæ–‡ä»¶å¤ªå°æ¢å¤é€Ÿåº¦æœ¬æ¥å°± å¾ˆå¿«ï¼Œé‡å†™çš„æ„ä¹‰ä¸å¤§ autoâ€aofâ€rewriteâ€percentage 100 # aof æ–‡ä»¶è‡ªä¸Šä¸€æ¬¡é‡å†™åæ–‡ä»¶å¤§å°å¢é•¿äº† 100%åˆ™å†æ¬¡è§¦å‘é‡å†™ å½“è®© AOF é‡å†™åŠ¨ä½œè¿˜å¯ä»¥æ‰‹åŠ¨è§¦å‘ï¼Œåœ¨ redis-cli ä¸­æ‰§è¡Œ bgrewriteaof, AOF é‡å†™ä¼š fork å‡ºä¸€ä¸ªå­è¿›ç¨‹å»åšï¼Œå’Œ bgsave ç±»ä¼¼ï¼Œä¸ä¼šå¯¹ redis æ‰§è¡Œæ­£å¸¸çš„å‘½ä»¤æœ‰å¤ªå¤šçš„å½±å“ã€‚\nRDB ä¸ AOF çš„å¯¹æ¯” RDB AOF å¯åŠ¨ä¼˜å…ˆçº§ ä½ é«˜ æ–‡ä»¶ä½“ç§¯ å° å¤§ æ¢å¤é€Ÿåº¦ å¿« æ…¢ æ•°æ®å®‰å…¨æ€§ å®¹æ˜“ä¸¢æ•°æ® æ ¹æ®ç­–ç•¥å†³å®š åœ¨ç”Ÿäº§ç¯å¢ƒéƒ½å¯ä»¥å¯ç”¨ï¼Œå¦‚æœæ—¢æœ‰ RBD æ–‡ä»¶ï¼Œä¹Ÿæœ‰ AOF æ–‡ä»¶ï¼Œåˆ™ä¼˜å…ˆé€‰æ‹© AOF æ–‡ä»¶æ¥æ¢å¤æ•°æ®ï¼Œå› ä¸ºç›¸å¯¹æ¥è¯´æ•°æ®æ›´å®‰å…¨ä¸€äº›\nRedis 4.0 æ··åˆæŒä¹…åŒ– é‡å¯ redis æ—¶ï¼Œå¾ˆå°‘ä¼šä½¿ç”¨ rdb æ–‡ä»¶æ¥æ¢å¤æ•°æ®ï¼Œå› ä¸ºä¼šä¸¢å¤±å¤§é‡æ•°æ®ï¼Œé€šå¸¸ä¼šé€šè¿‡ AOF æ—¥å¿—é‡æ”¾ï¼Œä½†æ˜¯é‡æ”¾ AOF æ—¥å¿—çš„æ€§èƒ½ä¼šæ¯” RDB æ¥è¯´æ…¢çš„å¤šï¼Œå°¤å…¶åœ¨ redis ä¸­æ•°æ®å¾ˆå¤§çš„æƒ…å†µä¸‹å¯åŠ¨è¦èŠ±è´¹å¾ˆé•¿æ—¶é—´ï¼Œ redis ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¸¦æ¥äº†ä¸€ä¸ªæ–°çš„æŒä¹…åŒ–é€‰é¡¹â€”â€”æ··åˆæŒä¹…åŒ–ã€‚é€šè¿‡ä¸‹é¢çš„é…ç½®å¯ä»¥å¼€å¯æ··åˆæŒä¹…åŒ–ï¼Œæ³¨æ„ï¼šå¿…é¡»å…ˆå¼€å¯ aof æŒä¹…åŒ–ï¼š\naof-use-rdb-premable yes å¦‚æœå¼€å¯äº†æ··åˆæŒä¹…åŒ–ï¼ŒAOF åœ¨é‡å†™æ—¶ï¼Œä¸å†æ˜¯å•çº¯å°†å†…å­˜æ•°æ®è½¬æ¢ä¸º RESP å‘½ä»¤å†™å…¥ AOF æ–‡ä»¶ï¼Œè€Œæ˜¯å°†é‡å†™è¿™ä¸€åˆ»ä¹‹å‰çš„å†…å­˜åš RDB å¿«ç…§å¤„ç†ï¼Œå¹¶ä¸”å°† RDB å¿«ç…§å†…å®¹å’Œå¢é‡çš„ AOF ä¿®æ”¹å†…å­˜æ•°æ®çš„å‘½ä»¤å­˜åœ¨ä¸€èµ·ï¼Œéƒ½å†™å…¥æ–°çš„ AOF æ–‡ä»¶ï¼Œæ–°çš„æ–‡ä»¶ä¸€å¼€å§‹ä¸å« appendonly.aofï¼Œç­‰åˆ°é‡å†™å®Œæ–°çš„ AOF æ–‡ä»¶æ‰ä¼šè¿›è¡Œæ”¹åï¼Œè¦†ç›–åŸæœ‰çš„ AOF æ–‡ä»¶ï¼Œå®Œæˆæ–°æ—§ä¸¤ä¸ª AOF æ–‡ä»¶çš„æ›¿æ¢ã€‚ äºæ˜¯åœ¨ Redis é‡å¯çš„æ—¶å€™ï¼Œå¯ä»¥å…ˆåŠ è½½ RDB çš„å†…å®¹ï¼Œç„¶åå†é‡æ”¾å¢é‡ AOF æ—¥å¿—å°±å¯ä»¥å®Œå…¨æ›¿ä»£ä¹‹å‰çš„ AOF å…¨é‡æ–‡ä»¶é‡æ”¾ï¼Œå› æ­¤é‡å¯æ•ˆç‡å¤§å¹…å¾—åˆ°æå‡ã€‚\næ··åˆæŒä¹…åŒ–AOFæ–‡ä»¶ç»“æ„å¦‚ä¸‹:\nRedis æ•°æ®å¤‡ä»½ç­–ç•¥ å†™crontabå®šæ—¶è°ƒåº¦è„šæœ¬ï¼Œæ¯å°æ—¶éƒ½copyä¸€ä»½rdbæˆ–aofçš„å¤‡ä»½åˆ°ä¸€ä¸ªç›®å½•ä¸­å»ï¼Œä»…ä»…ä¿ç•™æœ€è¿‘48 å°æ—¶çš„å¤‡ä»½ æ¯å¤©éƒ½ä¿ç•™ä¸€ä»½å½“æ—¥çš„æ•°æ®å¤‡ä»½åˆ°ä¸€ä¸ªç›®å½•ä¸­å»ï¼Œå¯ä»¥ä¿ç•™æœ€è¿‘1ä¸ªæœˆçš„å¤‡ä»½ æ¯æ¬¡copyå¤‡ä»½çš„æ—¶å€™ï¼Œéƒ½æŠŠå¤ªæ—§çš„å¤‡ä»½ç»™åˆ äº† æ¯å¤©æ™šä¸Šå°†å½“å‰æœºå™¨ä¸Šçš„å¤‡ä»½å¤åˆ¶ä¸€ä»½åˆ°å…¶ä»–æœºå™¨ä¸Šï¼Œä»¥é˜²æœºå™¨æŸå ","date":"2023-03-22T22:58:08Z","permalink":"https://dccmmtop.github.io/posts/redis%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E5%92%8C%E6%8C%81%E4%B9%85%E5%8C%96/","section":"posts","tags":["redis"],"title":"redisåŸºç¡€é…ç½®å’ŒæŒä¹…åŒ–"},{"categories":null,"contents":"ä¸ºä»€ä¹ˆéœ€è¦æ¸è¿›å¼éå†key æœ‰æ—¶å€™éœ€è¦ä» Redis å®ä¾‹æˆåƒä¸Šä¸‡çš„ key ä¸­æ‰¾å‡ºç‰¹å®šå‰ç¼€çš„ key åˆ—è¡¨æ¥æ‰‹åŠ¨å¤„ç†æ•°æ®ï¼Œå¯èƒ½æ˜¯ä¿®æ”¹å®ƒçš„å€¼ï¼Œä¹Ÿå¯èƒ½æ˜¯åˆ é™¤ keyã€‚è¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚ä½•ä»æµ·é‡çš„ key ä¸­æ‰¾å‡ºæ»¡è¶³ç‰¹å®šå‰ç¼€çš„ key åˆ—è¡¨æ¥ï¼Ÿ\nRedis æä¾›äº†ä¸€ä¸ªç®€å•æš´åŠ›çš„æŒ‡ä»¤ keys ç”¨æ¥åˆ—å‡ºæ‰€æœ‰æ»¡è¶³ç‰¹å®šæ­£åˆ™å­—ç¬¦ä¸²è§„åˆ™çš„ keyã€‚\n!redis-cli keys key67* 1) \u0026#34;key6764\u0026#34; 2) \u0026#34;key6738\u0026#34; 3) \u0026#34;key6774\u0026#34; 4) \u0026#34;key673\u0026#34; 5) \u0026#34;key6710\u0026#34; 6) \u0026#34;key6759\u0026#34; 7) \u0026#34;key6715\u0026#34; 8) \u0026#34;key6746\u0026#34; 9) \u0026#34;key6796\u0026#34; è¿™ä¸ªæŒ‡ä»¤ä½¿ç”¨éå¸¸ç®€å•ï¼Œæä¾›ä¸€ä¸ªç®€å•çš„æ­£åˆ™å­—ç¬¦ä¸²å³å¯ï¼Œä½†æ˜¯æœ‰å¾ˆæ˜æ˜¾çš„ä¸¤ä¸ªç¼ºç‚¹ã€‚ æ²¡æœ‰ offsetã€limit å‚æ•°ï¼Œä¸€æ¬¡æ€§åå‡ºæ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ keyï¼Œä¸‡ä¸€å®ä¾‹ä¸­æœ‰å‡ ç™¾ w ä¸ª key æ»¡è¶³æ¡ä»¶ï¼Œ å½“ä½ çœ‹åˆ°æ»¡å±çš„å­—ç¬¦ä¸²åˆ·çš„æ²¡æœ‰å°½å¤´æ—¶ï¼Œä½ å°±çŸ¥é“éš¾å—äº†ã€‚\nkeys ç®—æ³•æ˜¯éå†ç®—æ³•ï¼Œå¤æ‚åº¦æ˜¯ O(n)ï¼Œå¦‚æœå®ä¾‹ä¸­æœ‰åƒä¸‡çº§ä»¥ä¸Šçš„ keyï¼Œè¿™ä¸ªæŒ‡ä»¤å°±ä¼šå¯¼è‡´ Redis æœåŠ¡å¡é¡¿ï¼Œ æ‰€æœ‰è¯»å†™ Redis çš„å…¶å®ƒçš„æŒ‡ä»¤éƒ½ä¼šè¢«å»¶åç”šè‡³ä¼šè¶…æ—¶æŠ¥é”™ï¼Œ å› ä¸º Redis æ˜¯å•çº¿ç¨‹ç¨‹åºï¼Œé¡ºåºæ‰§è¡Œæ‰€æœ‰æŒ‡ä»¤ï¼Œå…¶å®ƒæŒ‡ä»¤å¿…é¡»ç­‰åˆ°å½“å‰çš„ keys æŒ‡ä»¤æ‰§è¡Œå®Œäº†æ‰å¯ä»¥ç»§ç»­ã€‚\nå»ºè®®ç”Ÿäº§ç¯å¢ƒå±è”½ keys å‘½ä»¤\nscan Redis ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒåœ¨ 2.8 ç‰ˆæœ¬ä¸­åŠ å…¥äº†æŒ‡ä»¤â€”â€”scanã€‚\nscan ç›¸æ¯” keys å…·å¤‡æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\nå¤æ‚åº¦è™½ç„¶ä¹Ÿæ˜¯ O(n)ï¼Œä½†æ˜¯å®ƒæ˜¯é€šè¿‡æ¸¸æ ‡åˆ†æ­¥è¿›è¡Œçš„ï¼Œä¸ä¼šé˜»å¡çº¿ç¨‹ï¼› æä¾› limit å‚æ•°ï¼Œå¯ä»¥æ§åˆ¶æ¯æ¬¡è¿”å›ç»“æœçš„æœ€å¤§æ¡æ•°ï¼Œlimit åªæ˜¯å¯¹å¢é‡å¼è¿­ä»£å‘½ä»¤çš„ä¸€ç§æç¤º (hint)ï¼Œè¿”å›çš„ç»“æœå¯å¤šå¯å°‘ï¼› åŒ keys ä¸€æ ·ï¼Œå®ƒä¹Ÿæä¾›æ¨¡å¼åŒ¹é…åŠŸèƒ½ï¼› æœåŠ¡å™¨ä¸éœ€è¦ä¸ºæ¸¸æ ‡ä¿å­˜çŠ¶æ€ï¼Œæ¸¸æ ‡çš„å”¯ä¸€çŠ¶æ€å°±æ˜¯ scan è¿”å›ç»™å®¢æˆ·ç«¯çš„æ¸¸æ ‡æ•´æ•°ï¼› è¿”å›çš„ç»“æœå¯èƒ½ä¼šæœ‰é‡å¤ï¼Œéœ€è¦å®¢æˆ·ç«¯å»é‡å¤ï¼Œè¿™ç‚¹éå¸¸é‡è¦ï¼› éå†çš„è¿‡ç¨‹ä¸­å¦‚æœæœ‰æ•°æ®ä¿®æ”¹ï¼Œæ”¹åŠ¨åçš„æ•°æ®èƒ½ä¸èƒ½éå†åˆ°æ˜¯ä¸ç¡®å®šçš„ï¼› å•æ¬¡è¿”å›çš„ç»“æœæ˜¯ç©ºçš„å¹¶ä¸æ„å‘³ç€éå†ç»“æŸï¼Œè€Œè¦çœ‹è¿”å›çš„æ¸¸æ ‡å€¼æ˜¯å¦ä¸ºé›¶ scan åŸºç¡€ä½¿ç”¨ SCAN cursor [MATCH pattern] [COUNT count]\nåˆå§‹æ‰§è¡Œ scan å‘½ä»¤ä¾‹å¦‚ scan 0ã€‚SCAN å‘½ä»¤æ˜¯ä¸€ä¸ªåŸºäºæ¸¸æ ‡çš„è¿­ä»£å™¨ã€‚ è¿™æ„å‘³ç€å‘½ä»¤æ¯æ¬¡è¢«è°ƒç”¨éƒ½éœ€è¦ä½¿ç”¨ä¸Šä¸€æ¬¡è¿™ä¸ªè°ƒç”¨è¿”å›çš„æ¸¸æ ‡ä½œä¸ºè¯¥æ¬¡è°ƒç”¨çš„æ¸¸æ ‡å‚æ•°ï¼Œä»¥æ­¤æ¥å»¶ç»­ä¹‹å‰çš„è¿­ä»£è¿‡ç¨‹ã€‚\nå½“ SCAN å‘½ä»¤çš„æ¸¸æ ‡å‚æ•°è¢«è®¾ç½®ä¸º 0 æ—¶ï¼ŒæœåŠ¡å™¨å°†å¼€å§‹ä¸€æ¬¡æ–°çš„è¿­ä»£ï¼Œè€Œå½“ redis æœåŠ¡å™¨å‘ç”¨æˆ·è¿”å›å€¼ä¸º 0 çš„æ¸¸æ ‡æ—¶ï¼Œ è¡¨ç¤ºè¿­ä»£å·²ç»“æŸï¼Œè¿™æ˜¯å”¯ä¸€è¿­ä»£ç»“æŸçš„åˆ¤å®šæ–¹å¼ï¼Œè€Œä¸èƒ½é€šè¿‡è¿”å›ç»“æœé›†æ˜¯å¦ä¸ºç©ºåˆ¤æ–­è¿­ä»£ç»“æŸã€‚\nscan å‚æ•°æä¾›äº†ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ cursor æ•´æ•°å€¼ï¼Œç¬¬äºŒä¸ªæ˜¯ key çš„æ­£åˆ™æ¨¡å¼ï¼Œç¬¬ä¸‰ä¸ªæ˜¯éå†çš„ limit hintã€‚\nç¬¬ä¸€æ¬¡éå†æ—¶ï¼Œcursor å€¼ä¸º 0ï¼Œç„¶åå°†è¿”å›ç»“æœä¸­ç¬¬ä¸€ä¸ªæ•´æ•°å€¼ä½œä¸ºä¸‹ä¸€æ¬¡éå†çš„ cursorã€‚ ä¸€ç›´éå†åˆ°è¿”å›çš„ cursor å€¼ä¸º 0 æ—¶ç»“æŸã€‚\n!redis-cli scan 0 match key99* count 1000 1) \u0026#34;13912\u0026#34; # è¿”å›çš„æ¸¸æ ‡ 2) 1) \u0026#34;key997\u0026#34; 2) \u0026#34;key9906\u0026#34; 3) \u0026#34;key9957\u0026#34; 4) \u0026#34;key9902\u0026#34; 5) \u0026#34;key9971\u0026#34; 6) \u0026#34;key9935\u0026#34; 7) \u0026#34;key9958\u0026#34; 8) \u0026#34;key9928\u0026#34; 9) \u0026#34;key9931\u0026#34; 10) \u0026#34;key9961\u0026#34; 11) \u0026#34;key9948\u0026#34; 12) \u0026#34;key9965\u0026#34; 13) \u0026#34;key9937\u0026#34; !redis-cli scan 13912 match key99* count 1000 1) \u0026#34;5292\u0026#34; # è¿”å›çš„æ¸¸æ ‡ 2) 1) \u0026#34;key996\u0026#34; 2) \u0026#34;key9960\u0026#34; 3) \u0026#34;key9973\u0026#34; 4) \u0026#34;key9978\u0026#34; 5) \u0026#34;key9927\u0026#34; 6) \u0026#34;key995\u0026#34; 7) \u0026#34;key9992\u0026#34; 8) \u0026#34;key9993\u0026#34; 9) \u0026#34;key9964\u0026#34; 10) \u0026#34;key9934\u0026#34; è¿”å›ç»“æœåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šç¬¬ä¸€éƒ¨åˆ†å³ 1) å°±æ˜¯ä¸‹ä¸€æ¬¡è¿­ä»£æ¸¸æ ‡ï¼Œç¬¬äºŒéƒ¨åˆ†å³ 2) å°±æ˜¯æœ¬æ¬¡è¿­ä»£ç»“æœé›†ã€‚\nä»ä¸Šé¢çš„è¿‡ç¨‹å¯ä»¥çœ‹åˆ°è™½ç„¶æä¾›çš„ limit æ˜¯ 1000ï¼Œä½†æ˜¯è¿”å›çš„ç»“æœåªæœ‰ 10 ä¸ªå·¦å³ã€‚ å› ä¸ºè¿™ä¸ª limit ä¸æ˜¯é™å®šè¿”å›ç»“æœçš„æ•°é‡ï¼Œè€Œæ˜¯é™å®šæœåŠ¡å™¨å•æ¬¡éå†çš„å­—å…¸æ§½ä½æ•°é‡ï¼ˆçº¦ç­‰äºï¼‰ã€‚ å¦‚æœå°† limit è®¾ç½®ä¸º 10ï¼Œä½ ä¼šå‘ç°è¿”å›ç»“æœæ˜¯ç©ºçš„ï¼Œä½†æ˜¯æ¸¸æ ‡å€¼ä¸ä¸ºé›¶ï¼Œæ„å‘³ç€éå†è¿˜æ²¡ç»“æŸã€‚\nå¦‚ä¸‹:\n!redis-cli scan 0 match key99* count 10 1) \u0026#34;15360\u0026#34; 2) (empty list or set) !redis-cli scan 15360 match key99* count 10 1) \u0026#34;2304\u0026#34; 2) (empty list or set) æ›´å¤šçš„ scan æŒ‡ä»¤ scan æŒ‡ä»¤æ˜¯ä¸€ç³»åˆ—æŒ‡ä»¤ï¼Œé™¤äº†å¯ä»¥éå†æ‰€æœ‰çš„ key ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å¯¹æŒ‡å®šçš„å®¹å™¨é›†åˆè¿›è¡Œéå†ã€‚ zscan éå† zset é›†åˆå…ƒç´ ï¼Œ hscan éå† hash å­—å…¸çš„å…ƒç´ ã€ sscan éå† set é›†åˆçš„å…ƒç´ ã€‚ æ³¨æ„ç‚¹ï¼š\nSSCAN å‘½ä»¤ã€ HSCAN å‘½ä»¤å’Œ ZSCAN å‘½ä»¤çš„ç¬¬ä¸€ä¸ªå‚æ•°æ€»æ˜¯ä¸€ä¸ªæ•°æ®åº“é”®ã€‚ è€Œ SCAN å‘½ä»¤åˆ™ä¸éœ€è¦åœ¨ç¬¬ä¸€ä¸ªå‚æ•°æä¾›ä»»ä½•æ•°æ®åº“é”® â€”â€” å› ä¸ºå®ƒè¿­ä»£çš„æ˜¯å½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰æ•°æ®åº“é”®ã€‚\nå¤§ key æ‰«æ æœ‰æ—¶å€™ä¼šå› ä¸ºä¸šåŠ¡äººå‘˜ä½¿ç”¨ä¸å½“ï¼Œåœ¨ Redis å®ä¾‹ä¸­ä¼šå½¢æˆå¾ˆå¤§çš„å¯¹è±¡ï¼Œæ¯”å¦‚ä¸€ä¸ªå¾ˆå¤§çš„ hashï¼Œä¸€ä¸ªå¾ˆå¤§çš„ zset è¿™éƒ½æ˜¯ç»å¸¸å‡ºç°çš„ã€‚\nè¿™æ ·çš„å¯¹è±¡å¯¹ Redis çš„é›†ç¾¤æ•°æ®è¿ç§»å¸¦æ¥äº†å¾ˆå¤§çš„é—®é¢˜ï¼Œå› ä¸ºåœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œå¦‚æœæŸä¸ª key å¤ªå¤§ï¼Œä¼šè®©æ•°æ®å¯¼è‡´è¿ç§»å¡é¡¿ã€‚ å¦å¤–åœ¨å†…å­˜åˆ†é…ä¸Šï¼Œå¦‚æœä¸€ä¸ª key å¤ªå¤§ï¼Œé‚£ä¹ˆå½“å®ƒéœ€è¦æ‰©å®¹æ—¶ï¼Œä¼šä¸€æ¬¡æ€§ç”³è¯·æ›´å¤§çš„ä¸€å—å†…å­˜ï¼Œè¿™ä¹Ÿä¼šå¯¼è‡´å¡é¡¿ã€‚ å¦‚æœè¿™ä¸ªå¤§ key è¢«åˆ é™¤ï¼Œå†…å­˜ä¼šä¸€æ¬¡æ€§å›æ”¶ï¼Œå¡é¡¿ç°è±¡ä¼šå†ä¸€æ¬¡äº§ç”Ÿã€‚\nåœ¨å¹³æ—¶çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œè¦å°½é‡é¿å…å¤§ key çš„äº§ç”Ÿã€‚ å¦‚æœä½ è§‚å¯Ÿåˆ° Redis çš„å†…å­˜å¤§èµ·å¤§è½ï¼Œè¿™ææœ‰å¯èƒ½æ˜¯å› ä¸ºå¤§ key å¯¼è‡´çš„ï¼Œè¿™æ—¶å€™ä½ å°±éœ€è¦å®šä½å‡ºå…·ä½“æ˜¯é‚£ä¸ª keyï¼Œ è¿›ä¸€æ­¥å®šä½å‡ºå…·ä½“çš„ä¸šåŠ¡æ¥æºï¼Œç„¶åå†æ”¹è¿›ç›¸å…³ä¸šåŠ¡ä»£ç è®¾è®¡ã€‚\né‚£å¦‚ä½•å®šä½å¤§ key å‘¢ï¼Ÿ ä¸ºäº†é¿å…å¯¹çº¿ä¸Š Redis å¸¦æ¥å¡é¡¿ï¼Œè¿™å°±è¦ç”¨åˆ° scan æŒ‡ä»¤ï¼Œå¯¹äºæ‰«æå‡ºæ¥çš„æ¯ä¸€ä¸ª keyï¼Œä½¿ç”¨ type æŒ‡ä»¤è·å¾— key çš„ç±»å‹ï¼Œ ç„¶åä½¿ç”¨ç›¸åº”æ•°æ®ç»“æ„çš„ size æˆ–è€… len æ–¹æ³•æ¥å¾—åˆ°å®ƒçš„å¤§å°ï¼Œå¯¹äºæ¯ä¸€ç§ç±»å‹ï¼Œä¿ç•™å¤§å°çš„å‰ N åä½œä¸ºæ‰«æç»“æœå±•ç¤ºå‡ºæ¥ã€‚\nä¸Šé¢è¿™æ ·çš„è¿‡ç¨‹éœ€è¦ç¼–å†™è„šæœ¬ï¼Œæ¯”è¾ƒç¹çï¼Œä¸è¿‡ Redis å®˜æ–¹å·²ç»åœ¨ redis-cli æŒ‡ä»¤ä¸­æä¾›äº†è¿™æ ·çš„æ‰«æåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ‹¿æ¥å³ç”¨ã€‚\n!redis-cli --bigkeys # Scanning the entire keyspace to find biggest keys as well as # average sizes per key type. You can use -i 0.1 to sleep 0.1 sec # per 100 SCAN commands (not usually needed). [00.00%] Biggest string found so far \u0026#39;key316\u0026#39; with 3 bytes [00.00%] Biggest string found so far \u0026#39;key7806\u0026#39; with 4 bytes [12.79%] Biggest zset found so far \u0026#39;salary\u0026#39; with 1 members [13.19%] Biggest string found so far \u0026#39;counter:__rand_int__\u0026#39; with 6 bytes [13.50%] Biggest hash found so far \u0026#39;websit\u0026#39; with 2 fields [14.37%] Biggest set found so far \u0026#39;bbs\u0026#39; with 3 members [14.67%] Biggest hash found so far \u0026#39;website\u0026#39; with 3 fields [30.41%] Biggest list found so far \u0026#39;mylist\u0026#39; with 100000 items [95.53%] Biggest zset found so far \u0026#39;page_rank\u0026#39; with 3 members -------- summary ------- Sampled 10019 keys in the keyspace! Total key length in bytes is 68990 (avg len 6.89) Biggest string found \u0026#39;counter:__rand_int__\u0026#39; has 6 bytes Biggest list found \u0026#39;mylist\u0026#39; has 100000 items Biggest set found \u0026#39;bbs\u0026#39; has 3 members Biggest hash found \u0026#39;website\u0026#39; has 3 fields Biggest zset found \u0026#39;page_rank\u0026#39; has 3 members 10011 strings with 38919 bytes (99.92% of keys, avg size 3.89) 3 lists with 100003 items (00.03% of keys, avg size 33334.33) 1 sets with 3 members (00.01% of keys, avg size 3.00) 2 hashs with 5 fields (00.02% of keys, avg size 2.50) 2 zsets with 4 members (00.02% of keys, avg size 2.00) å¦‚æœä½ æ‹…å¿ƒè¿™ä¸ªæŒ‡ä»¤ä¼šå¤§å¹…æŠ¬å‡ Redis çš„ ops å¯¼è‡´çº¿ä¸ŠæŠ¥è­¦ï¼Œè¿˜å¯ä»¥å¢åŠ ä¸€ä¸ªä¼‘çœ å‚æ•°ã€‚\n!redis-cli --bigkeys -i 0.1 # Scanning the entire keyspace to find biggest keys as well as # average sizes per key type. You can use -i 0.1 to sleep 0.1 sec # per 100 SCAN commands (not usually needed). [00.00%] Biggest string found so far \u0026#39;key316\u0026#39; with 3 bytes [00.00%] Biggest string found so far \u0026#39;key7806\u0026#39; with 4 bytes [12.79%] Biggest zset found so far \u0026#39;salary\u0026#39; with 1 members [13.19%] Biggest string found so far \u0026#39;counter:__rand_int__\u0026#39; with 6 bytes [13.50%] Biggest hash found so far \u0026#39;websit\u0026#39; with 2 fields [14.37%] Biggest set found so far \u0026#39;bbs\u0026#39; with 3 members [14.67%] Biggest hash found so far \u0026#39;website\u0026#39; with 3 fields [30.41%] Biggest list found so far \u0026#39;mylist\u0026#39; with 100000 items [95.53%] Biggest zset found so far \u0026#39;page_rank\u0026#39; with 3 members -------- summary ------- Sampled 10019 keys in the keyspace! Total key length in bytes is 68990 (avg len 6.89) Biggest string found \u0026#39;counter:__rand_int__\u0026#39; has 6 bytes Biggest list found \u0026#39;mylist\u0026#39; has 100000 items Biggest set found \u0026#39;bbs\u0026#39; has 3 members Biggest hash found \u0026#39;website\u0026#39; has 3 fields Biggest zset found \u0026#39;page_rank\u0026#39; has 3 members 10011 strings with 38919 bytes (99.92% of keys, avg size 3.89) 3 lists with 100003 items (00.03% of keys, avg size 33334.33) 1 sets with 3 members (00.01% of keys, avg size 3.00) 2 hashs with 5 fields (00.02% of keys, avg size 2.50) 2 zsets with 4 members (00.02% of keys, avg size 2.00) ä¸Šé¢è¿™ä¸ªæŒ‡ä»¤æ¯éš” 100 æ¡ scan æŒ‡ä»¤å°±ä¼šä¼‘çœ  0.1sï¼Œops å°±ä¸ä¼šå‰§çƒˆæŠ¬å‡ï¼Œä½†æ˜¯æ‰«æçš„æ—¶é—´ä¼šå˜é•¿ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ª bigkeys å¾—åˆ°çš„æœ€å¤§ï¼Œä¸ä¸€å®šæ˜¯æœ€å¤§ã€‚\nè¯´æ˜åŸå› å‰ï¼Œé¦–å…ˆè¯´æ˜ bigkeys çš„åŸç†ï¼Œéå¸¸ç®€å•ï¼Œé€šè¿‡ scan å‘½ä»¤éå†ï¼Œå„ç§ä¸åŒæ•°æ®ç»“æ„çš„ keyï¼Œåˆ†åˆ«é€šè¿‡ä¸åŒçš„å‘½ä»¤å¾—åˆ°æœ€å¤§çš„ keyï¼š\nå¦‚æœæ˜¯ string ç»“æ„ï¼Œé€šè¿‡ strlen åˆ¤æ–­ï¼›\nå¦‚æœæ˜¯ list ç»“æ„ï¼Œé€šè¿‡ llen åˆ¤æ–­ï¼›\nå¦‚æœæ˜¯ hash ç»“æ„ï¼Œé€šè¿‡ hlen åˆ¤æ–­ï¼›\nå¦‚æœæ˜¯ set ç»“æ„ï¼Œé€šè¿‡ scard åˆ¤æ–­ï¼›\nå¦‚æœæ˜¯ sorted set ç»“æ„ï¼Œé€šè¿‡ zcard åˆ¤æ–­ã€‚\næ­£å› ä¸ºè¿™æ ·çš„åˆ¤æ–­æ–¹å¼ï¼Œè™½ç„¶ string ç»“æ„è‚¯å®šå¯ä»¥æ­£ç¡®çš„ç­›é€‰å‡ºæœ€å ç”¨ç¼“å­˜ï¼Œä¹Ÿå¯ä»¥è¯´æœ€å¤§çš„ keyã€‚\nä½†æ˜¯ list ä¸ä¸€å®šï¼Œä¾‹å¦‚ï¼Œç°åœ¨æœ‰ä¸¤ä¸ª list ç±»å‹çš„ keyï¼Œåˆ†åˆ«æ˜¯ï¼šnumberlistâ€“[0,1,2]ï¼Œstringlistâ€“[â€œ123456789123456789â€]ï¼Œ ç”±äºé€šè¿‡ llen åˆ¤æ–­ï¼Œæ‰€ä»¥ numberlist è¦å¤§äº stringlistã€‚ è€Œäº‹å®ä¸Š stringlist æ›´å ç”¨å†…å­˜ã€‚å…¶ä»–ä¸‰ç§æ•°æ®ç»“æ„ hashï¼Œsetï¼Œsorted set éƒ½ä¼šå­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚ ä½¿ç”¨ bigkeys ä¸€å®šè¦æ³¨æ„è¿™ä¸€ç‚¹ã€‚\nslowlog å‘½ä»¤ ä¸Šé¢æåˆ°ä¸èƒ½ä½¿ç”¨ keys å‘½ä»¤ï¼Œå¦‚æœå°±æœ‰å¼€å‘è¿™ä¹ˆåšäº†å‘¢ï¼Œæˆ‘ä»¬å¦‚ä½•å¾—çŸ¥ï¼Ÿ ä¸å…¶ä»–ä»»æ„å­˜å‚¨ç³»ç»Ÿä¾‹å¦‚ mysqlï¼Œmongodb å¯ä»¥æŸ¥çœ‹æ…¢æ—¥å¿—ä¸€æ ·ï¼Œredis ä¹Ÿå¯ä»¥ï¼Œå³é€šè¿‡å‘½ä»¤ slowlogã€‚\nç”¨æ³•å¦‚ä¸‹\nSLOWLOG subcommand [argument] subcommand ä¸»è¦æœ‰ï¼š\ngetï¼Œç”¨æ³•ï¼šslowlog get [argument]ï¼Œè·å– argument å‚æ•°æŒ‡å®šæ•°é‡çš„æ…¢æ—¥å¿—ã€‚\nlenï¼Œç”¨æ³•ï¼šslowlog lenï¼Œæ€»æ…¢æ—¥å¿—æ•°é‡ã€‚\nresetï¼Œç”¨æ³•ï¼šslowlog resetï¼Œæ¸…ç©ºæ…¢æ—¥å¿—ã€‚\n!redis-cli slowlog get 5 1) 1) (integer) 2 2) (integer) 1537786953 3) (integer) 17980 4) 1) \u0026#34;scan\u0026#34; 2) \u0026#34;0\u0026#34; 3) \u0026#34;match\u0026#34; 4) \u0026#34;key99*\u0026#34; 5) \u0026#34;count\u0026#34; 6) \u0026#34;1000\u0026#34; 5) \u0026#34;127.0.0.1:50129\u0026#34; 6) \u0026#34;\u0026#34; 2) 1) (integer) 1 2) (integer) 1537785886 3) (integer) 39537 4) 1) \u0026#34;keys\u0026#34; 2) \u0026#34;*\u0026#34; 5) \u0026#34;127.0.0.1:49701\u0026#34; 6) \u0026#34;\u0026#34; 3) 1) (integer) 0 2) (integer) 1537681701 3) (integer) 18276 4) 1) \u0026#34;ZADD\u0026#34; 2) \u0026#34;page_rank\u0026#34; 3) \u0026#34;10\u0026#34; 4) \u0026#34;google.com\u0026#34; 5) \u0026#34;127.0.0.1:52334\u0026#34; 6) \u0026#34;\u0026#34; å‘½ä»¤è€—æ—¶è¶…è¿‡å¤šå°‘æ‰ä¼šä¿å­˜åˆ° slowlog ä¸­ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤ config set slowlog-log-slower-than 2000 é…ç½®å¹¶ä¸”ä¸éœ€è¦é‡å¯ redisã€‚ æ³¨æ„ï¼šå•ä½æ˜¯å¾®å¦™ï¼Œ2000 å¾®å¦™å³ 2 æ¯«ç§’ã€‚\nç¦ç”¨å±é™©å‘½ä»¤ rename-command ä¸ºäº†é˜²æ­¢æŠŠé—®é¢˜å¸¦åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶é‡å‘½åä¸€äº›å±é™©å‘½ä»¤ï¼Œ\nä¾‹å¦‚ keys ç­‰ä¸€äº›é«˜å±å‘½ä»¤ã€‚æ“ä½œéå¸¸ç®€å•ï¼Œ\nåªéœ€è¦åœ¨ conf é…ç½®æ–‡ä»¶å¢åŠ å¦‚ä¸‹æ‰€ç¤ºé…ç½®å³å¯ï¼š\nrename-command flushdb flushddbb\rrename-command flushall flushallall\rrename-command keys keysys ","date":"2023-03-22T07:30:03Z","permalink":"https://dccmmtop.github.io/posts/scan/","section":"posts","tags":["redis"],"title":"Redisä¸­æ¸è¿›å¼éå†key"},{"categories":null,"contents":"æŸ¥çœ‹é¡¹ç›®ä¾èµ– gradle: gradle dependencies\nmaven: mvn dependency:tree\næ’é™¤ä¾èµ– ä¸éœ€è¦æŸä¸ªä¾èµ–æˆ–è€…éœ€è¦æ›¿æ¢æ‰æŸä¾èµ–æ—¶ï¼Œå°±éœ€è¦æŠŠè¿™ä¸ªä¾èµ–æ’é™¤:\nä»¥Spring Bootçš„Webèµ·æ­¥ä¾èµ–ä¸ºä¾‹ï¼Œå®ƒä¼ é€’ä¾èµ–äº†Jackson JSONåº“ã€‚å¦‚æœä½ æ­£åœ¨æ„å»ºä¸€ä¸ªç”Ÿäº§æˆ–æ¶ˆè´¹JSONèµ„æºè¡¨è¿°çš„RESTæœåŠ¡ï¼Œé‚£å®ƒä¼šå¾ˆæœ‰ç”¨ã€‚ä½†æ˜¯ï¼Œè¦æ„å»ºä¼ ç»Ÿçš„é¢å‘äººç±»ç”¨æˆ·çš„Webåº”ç”¨ç¨‹åºï¼Œä½ å¯èƒ½ç”¨ä¸ä¸ŠJacksonã€‚è™½ç„¶æŠŠå®ƒåŠ è¿›æ¥ä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆåå¤„ï¼Œä½†æ’é™¤æ‰å®ƒçš„ä¼ é€’ä¾èµ–ï¼Œå¯ä»¥ä¸ºä½ çš„é¡¹ç›®ç˜¦èº«ã€‚\ngradle: compile(\u0026#34;org.springframework.boot:spring-boot-starter-web\u0026#34;)Â {Â excludeÂ group:Â \u0026#39;com.fasterxml.jackson.core\u0026#39; } maven \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;exclusions\u0026gt; \u0026lt;exclusion\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;/exclusion\u0026gt;Â \u0026lt;/exclusions\u0026gt; \u0026lt;/dependency\u0026gt; å¦ä¸€æ–¹é¢ï¼Œä¹Ÿè®¸é¡¹ç›®éœ€è¦Jacksonï¼Œä½†ä½ éœ€è¦ç”¨å¦ä¸€ä¸ªç‰ˆæœ¬çš„Jacksonæ¥è¿›è¡Œæ„å»ºï¼Œè€Œä¸æ˜¯Webèµ·æ­¥ä¾èµ–é‡Œçš„é‚£ä¸ªã€‚å‡è®¾Webèµ·æ­¥ä¾èµ–å¼•ç”¨äº†Jackson 2.3.4ï¼Œä½†ä½ éœ€è¦ä½¿ç”¨2.4.33ã€‚åœ¨Mavené‡Œï¼Œä½ å¯ä»¥ç›´æ¥åœ¨pom.xmlä¸­è¡¨è¾¾è¯‰æ±‚ï¼Œå°±åƒè¿™æ ·ï¼š\nmaven: \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.fasterxml.jackson.core\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jackson-databind\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;2.4.3\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; Mavenæ€»æ˜¯ä¼šç”¨æœ€è¿‘çš„ä¾èµ–ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä½ åœ¨é¡¹ç›®çš„æ„å»ºè¯´æ˜æ–‡ä»¶é‡Œå¢åŠ çš„è¿™ä¸ªä¾èµ–ï¼Œä¼šè¦†ç›–ä¼ é€’ä¾èµ–å¼•å…¥çš„å¦ä¸€ä¸ªä¾èµ–ã€‚\ngradle\nå‡å¦‚è¦æ›¿æ¢çš„ç‰ˆæœ¬æ›´æ–°ã€‚ç›´æ¥å†™æ–°ç‰ˆæœ¬å³å¯: compile(\u0026#34;com.fasterxml.jackson.core:jackson-databind:2.4.3\u0026#34;) å‡å¦‚è¦æ›¿æ¢çš„æ˜¯ä¸€ä¸ªæ—§ç‰ˆæœ¬,éœ€è¦æŠŠåŸæœ‰æ›´æ–°çš„ç‰ˆæœ¬æ’é™¤ï¼Œå†æ·»åŠ æ—§ç‰ˆæœ¬çš„åŒ…:\ncompile(\u0026#34;org.springframework.boot:spring-boot-starter-web\u0026#34;)Â {Â excludeÂ group:Â \u0026#39;com.fasterxml.jackson.core\u0026#39; } compile(\u0026#34;com.fasterxml.jackson.core:jackson-databind:2.3.1\u0026#34;) ä¸ç®¡ä»€ä¹ˆæƒ…å†µï¼Œåœ¨è¦†ç›–Spring Bootèµ·æ­¥ä¾èµ–å¼•å…¥çš„ä¼ é€’ä¾èµ–æ—¶éƒ½è¦å¤šåŠ å°å¿ƒã€‚è™½ç„¶ä¸åŒçš„ç‰ˆæœ¬æ”¾åœ¨ä¸€èµ·ä¹Ÿè®¸æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†ä½ è¦çŸ¥é“ï¼Œèµ·æ­¥ä¾èµ–ä¸­å„ä¸ªä¾èµ–ç‰ˆæœ¬ä¹‹é—´çš„å…¼å®¹æ€§éƒ½ç»è¿‡äº†ç²¾å¿ƒçš„æµ‹è¯•ã€‚åº”è¯¥åªåœ¨ç‰¹æ®Šçš„æƒ…å†µä¸‹è¦†ç›–è¿™äº›ä¼ é€’ä¾èµ–ï¼ˆæ¯”å¦‚æ–°ç‰ˆæœ¬ä¿®å¤äº†ä¸€ä¸ªbugï¼‰ã€‚\nè¯»å–é…ç½® Spring Bootèƒ½ä»å¤šç§å±æ€§æºè·å¾—å±æ€§ï¼ŒåŒ…æ‹¬å¦‚ä¸‹å‡ å¤„ã€‚\nå‘½ä»¤è¡Œå‚æ•° java:comp/env é‡Œçš„JNDIå±æ€§ JVMç³»ç»Ÿå±æ€§ æ“ä½œç³»ç»Ÿç¯å¢ƒå˜é‡ éšæœºç”Ÿæˆçš„å¸¦random.* å‰ç¼€çš„å±æ€§ï¼ˆåœ¨è®¾ç½®å…¶ä»–å±æ€§æ—¶ï¼Œå¯ä»¥å¼•ç”¨å®ƒä»¬ï¼Œæ¯”å¦‚${random.long} ï¼‰ åº”ç”¨ç¨‹åºä»¥å¤–çš„application.propertiesæˆ–è€…appliaction.ymlæ–‡ä»¶ æ‰“åŒ…åœ¨åº”ç”¨ç¨‹åºå†…çš„application.propertiesæˆ–è€…appliaction.ymlæ–‡ä»¶ é€šè¿‡@PropertySource æ ‡æ³¨çš„å±æ€§æº é»˜è®¤å±æ€§ è¿™ä¸ªåˆ—è¡¨æŒ‰ç…§ä¼˜å…ˆçº§æ’åºï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä»»ä½•åœ¨é«˜ä¼˜å…ˆçº§å±æ€§æºé‡Œè®¾ç½®çš„å±æ€§éƒ½ä¼šè¦†ç›–ä½ä¼˜å…ˆçº§çš„ç›¸åŒå±æ€§ã€‚ä¾‹å¦‚ï¼Œå‘½ä»¤è¡Œå‚æ•°ä¼šè¦†ç›–å…¶ä»–å±æ€§æºé‡Œçš„å±æ€§ã€‚\napplication.propertieså’Œapplication.ymlæ–‡ä»¶èƒ½æ”¾åœ¨ä»¥ä¸‹å››ä¸ªä½ç½®ã€‚\nå¤–ç½®ï¼Œåœ¨ç›¸å¯¹äºåº”ç”¨ç¨‹åºè¿è¡Œç›®å½•çš„/configå­ç›®å½•é‡Œã€‚ å¤–ç½®ï¼Œåœ¨åº”ç”¨ç¨‹åºè¿è¡Œçš„ç›®å½•é‡Œã€‚ å†…ç½®ï¼Œåœ¨configåŒ…å†…ã€‚ å†…ç½®ï¼Œåœ¨Classpathæ ¹ç›®å½•ã€‚ ","date":"2022-12-30T14:42:18Z","permalink":"https://dccmmtop.github.io/posts/%E5%B8%B8%E7%94%A8%E5%B7%A5%E5%85%B7%E5%A4%87%E5%BF%98/","section":"posts","tags":["spring"],"title":"å¸¸ç”¨å·¥å…·å¤‡å¿˜"},{"categories":null,"contents":"å£°æ˜åˆ‡ç‚¹@Poincut æŠŠåˆ‡ç‚¹å£°æ˜æˆä¸€ä¸ªæ–¹æ³•ï¼Œä¾¿äºé‡ç”¨\n@Poincut çš„ä½¿ç”¨æ ¼å¼å¦‚ä¸‹ï¼š\n@Poincut(\u0026#34;PCD\u0026#34;) // åˆ‡ç‚¹è¡¨è¾¾å¼ è¡¨ç¤ºå¯¹å“ªäº›æ–¹æ³•è¿›è¡Œå¢å¼º public void pc(){} // åˆ‡ç‚¹ç­¾åï¼Œè¿”å›å€¼å¿…é¡»ä¸º void 10 ç§åˆ‡ç‚¹è¡¨è¾¾å¼ AspectJ çš„åˆ‡ç‚¹æŒ‡ç¤ºç¬¦ AspectJ pointcut designators (PCD) ï¼Œä¹Ÿå°±æ˜¯ä¿—ç§°çš„åˆ‡ç‚¹è¡¨è¾¾å¼ï¼ŒSpring ä¸­æ”¯æŒ 10 ç§ï¼Œå¦‚ä¸‹è¡¨ï¼š\nè¡¨è¾¾å¼ç±»å‹ ä½œç”¨ åŒ¹é…è§„åˆ™ execution ç”¨äºåŒ¹é…æ–¹æ³•æ‰§è¡Œçš„è¿æ¥ç‚¹ within ç”¨äºåŒ¹é…æŒ‡å®šç±»å‹å†…çš„æ–¹æ³•æ‰§è¡Œ within(x) åŒ¹é…è§„åˆ™ target.getClass().equals(x) this ç”¨äºåŒ¹é…å½“å‰ AOP ä»£ç†å¯¹è±¡ç±»å‹çš„æ‰§è¡Œæ–¹æ³•ï¼ŒåŒ…å«å¼•å…¥çš„æ¥å£ç±»å‹åŒ¹é… this(x) åŒ¹é…è§„åˆ™ï¼šx.getClass.isAssingableFrom(proxy.getClass) target ç”¨äºåŒ¹é…å½“å‰ç›®æ ‡å¯¹è±¡ç±»å‹çš„æ‰§è¡Œæ–¹æ³•ï¼Œä¸åŒ…æ‹¬å¼•å…¥æ¥å£çš„ç±»å‹åŒ¹é… target(x) åŒ¹é…è§„åˆ™ï¼šx.getClass().isAssignableFrom(target.getClass()); args ç”¨äºåŒ¹é…å½“å‰æ‰§è¡Œçš„æ–¹æ³•ä¼ å…¥çš„å‚æ•°ä¸ºæŒ‡å®šç±»å‹çš„æ‰§è¡Œæ–¹æ³• ä¼ å…¥çš„ç›®æ ‡ä½ç½®å‚æ•°ã€‚getClass().equals(@argsï¼ˆå¯¹åº”çš„å‚æ•°ä½ç½®çš„æ³¨è§£ç±»å‹ï¼‰)!= null @target ç”¨äºåŒ¹é…å½“å‰ç›®æ ‡å¯¹è±¡ç±»å‹çš„æ‰§è¡Œæ–¹æ³•ï¼Œå…¶ä¸­ç›®æ ‡å¯¹è±¡æŒæœ‰æŒ‡å®šçš„æ³¨è§£ target.class.getAnnotationï¼ˆæŒ‡å®šçš„æ³¨è§£ç±»å‹ï¼‰ != null @args ç”¨äºåŒ¹é…å½“å‰æ‰§è¡Œçš„æ–¹æ³•ä¼ å…¥çš„å‚æ•°æŒæœ‰æŒ‡å®šæ³¨è§£çš„æ‰§è¡Œ ä¼ å…¥çš„ç›®æ ‡ä½ç½®å‚æ•°ã€‚getClass().getAnnotation(@argsï¼ˆå¯¹åº”çš„å‚æ•°ä½ç½®çš„æ³¨è§£ç±»å‹ï¼‰)!= null @within ç”¨äºåŒ¹é…æ‰€æœ‰æŒæœ‰æŒ‡å®šæ³¨è§£ç±»å‹å†…çš„æ–¹æ³• è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³• Method å¯¹è±¡ã€‚getDeclaringClass().getAnnotation(within ä¸­æŒ‡å®šçš„æ³¨è§£ç±»å‹ï¼‰ != null @annotation ç”¨äºåŒ¹é…å½“å‰æ‰§è¡Œæ–¹æ³•æŒæœ‰æŒ‡å®šæ³¨è§£çš„æ–¹æ³• target.getClass().getMethod(\u0026ldquo;ç›®æ ‡æ–¹æ³•å\u0026rdquo;).getDeclaredAnnotation(@annotationï¼ˆç›®æ ‡æ³¨è§£ï¼‰)!=null bean Spring AOP æ‰©å±•çš„ï¼ŒAspectJ æ²¡æœ‰å¯¹åº”çš„æŒ‡ç¤ºç¬¦ï¼Œç”¨äºåŒ¹é…ç‰¹å®šåç§°çš„ Bean å¯¹è±¡çš„æ‰§è¡Œæ–¹æ³• ApplicationContext.getBean(\u0026ldquo;bean è¡¨è¾¾å¼ä¸­æŒ‡å®šçš„ bean åç§°\u0026rdquo;) != null ç®€å•ä»‹ç»ä¸‹ AspectJ ä¸­å¸¸ç”¨çš„ 3 ä¸ªé€šé…ç¬¦ï¼š\n*ï¼šåŒ¹é…ä»»ä½•æ•°é‡å­—ç¬¦ ..ï¼šåŒ¹é…ä»»ä½•æ•°é‡å­—ç¬¦çš„é‡å¤ï¼Œå¦‚ä»»ä½•æ•°é‡å­åŒ…ï¼Œä»»ä½•æ•°é‡æ–¹æ³•å‚æ•° +ï¼šåŒ¹é…æŒ‡å®šç±»å‹åŠå…¶å­ç±»å‹ï¼Œä»…ä½œä¸ºåç¼€é˜²è¿‡è½½ç±»å‹æ¨¡å¼åé¢ã€‚ execution ç”¨äºåŒ¹é…æ–¹æ³•æ‰§è¡Œï¼Œæœ€å¸¸ç”¨ã€‚\næ ¼å¼è¯´æ˜ execution(modifiers-pattern? ret-type-pattern declaring-type-pattern?name-pattern(param-pattern) throws-pattern?) å…¶ä¸­å¸¦ ?å·çš„ modifiers-pattern?ï¼Œdeclaring-type-pattern?ï¼Œthrows-pattern?æ˜¯å¯é€‰é¡¹ ret-type-pattern,name-pattern, parameters-patternæ˜¯å¿…é€‰é¡¹ modifier-pattern? ä¿®é¥°ç¬¦åŒ¹é…ï¼Œå¦‚ public è¡¨ç¤ºåŒ¹é…å…¬æœ‰æ–¹æ³•ï¼Œ*è¡¨ç¤ºä»»æ„ä¿®é¥°ç¬¦ ret-type-pattern è¿”å›å€¼åŒ¹é…ï¼Œ* è¡¨ç¤ºä»»ä½•è¿”å›å€¼ï¼Œå…¨è·¯å¾„çš„ç±»åç­‰ declaring-type-pattern? ç±»è·¯å¾„åŒ¹é… name-pattern æ–¹æ³•ååŒ¹é…ï¼Œ* ä»£è¡¨æ‰€æœ‰ï¼Œxx*ä»£è¡¨ä»¥ xx å¼€å¤´çš„æ‰€æœ‰æ–¹æ³• (param-pattern) å‚æ•°åŒ¹é…ï¼ŒæŒ‡å®šæ–¹æ³•å‚æ•°ï¼ˆå£°æ˜çš„ç±»å‹ï¼‰ï¼Œ(..)ä»£è¡¨æ‰€æœ‰å‚æ•°ï¼Œ(*,String)ä»£è¡¨ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºä»»ä½•å€¼ï¼Œç¬¬äºŒä¸ªä¸º String ç±»å‹ï¼Œ(..,String)ä»£è¡¨æœ€åä¸€ä¸ªå‚æ•°æ˜¯ String ç±»å‹ throws-pattern? å¼‚å¸¸ç±»å‹åŒ¹é… ä¸¾ä¾‹è¯´æ˜ public class PointcutExecution { // com.crab.spring.aop.demo02 åŒ…ä¸‹ä»»ä½•ç±»çš„ä»»æ„æ–¹æ³• @Pointcut(\u0026#34;execution(* com.crab.spring.aop.demo02.*.*(..))\u0026#34;) public void m1(){} // com.crab.spring.aop.demo02 åŒ…åŠå…¶å­åŒ…ä¸‹ä»»ä½•ç±»çš„ä»»æ„æ–¹æ³• @Pointcut(\u0026#34;execution(* com.crab.spring.aop.demo02..*.*(..))\u0026#34;) public void m2(){} // com.crab.spring.aop åŒ…åŠå…¶å­åŒ…ä¸‹ IService æ¥å£çš„ä»»æ„æ— å‚æ–¹æ³• @Pointcut(\u0026#34;execution(* com.crab.spring.aop..IService.*(..))\u0026#34;) public void m3(){} // com.crab.spring.aop åŒ…åŠå…¶å­åŒ…ä¸‹ IService æ¥å£åŠå…¶å­ç±»å‹çš„ä»»æ„æ— å‚æ–¹æ³• @Pointcut(\u0026#34;execution(* com.crab.spring.aop..IService+.*(..))\u0026#34;) public void m4(){} // com.crab.spring.aop.demo02.UserService ç±»ä¸­æœ‰ä¸”åªæœ‰ä¸€ä¸ª String å‚æ•°çš„æ–¹æ³• @Pointcut(\u0026#34;execution(* com.crab.spring.aop.demo02.UserService.*(String))\u0026#34;) public void m5(){} // com.crab.spring.aop.demo02.UserService ç±»ä¸­å‚æ•°ä¸ªæ•°ä¸º 2 ä¸”æœ€åä¸€ä¸ªå‚æ•°ç±»å‹æ˜¯ String çš„æ–¹æ³• @Pointcut(\u0026#34;execution(* com.crab.spring.aop.demo02.UserService.*(*,String))\u0026#34;) public void m6(){} // com.crab.spring.aop.demo02.UserService ç±»ä¸­æœ€åä¸€ä¸ªå‚æ•°ç±»å‹æ˜¯ String çš„æ–¹æ³• @Pointcut(\u0026#34;execution(* com.crab.spring.aop.demo02.UserService.*(..,String))\u0026#34;) public void m7(){} } within æ ¼å¼è¯´æ˜ withinï¼ˆç±»å‹è¡¨è¾¾å¼ï¼‰ï¼šç›®æ ‡å¯¹è±¡ target çš„ç±»å‹æ˜¯å¦å’Œ within ä¸­æŒ‡å®šçš„ç±»å‹åŒ¹é…\nåŒ¹é…è§„åˆ™ï¼š target.getClass().equals(within è¡¨è¾¾å¼ä¸­æŒ‡å®šçš„ç±»å‹ï¼‰\nä¸¾ä¾‹è¯´æ˜ public class PointcutWithin { // åŒ¹é… com.crab.spring.aop.demo02 åŒ…åŠå…¶å­åŒ…ä¸‹ä»»ä½•ç±»çš„ä»»ä½•æ–¹æ³• @Pointcut(\u0026#34;within(com.crab.spring.aop.demo02..*)\u0026#34;) public void m() { } // åŒ¹é… m.crab.spring.aop.demo02 åŒ…åŠå…¶å­åŒ…ä¸‹ IService ç±»å‹åŠå…¶å­ç±»å‹çš„ä»»ä½•æ–¹æ³• @Pointcut(\u0026#34;within(com.crab.spring.aop.demo02..IService+)\u0026#34;) public void m2() { } // åŒ¹é… com.crab.spring.aop.demo02.UserService ç±»ä¸­æ‰€æœ‰æ–¹æ³•ï¼Œä¸å«å…¶å­ç±» @Pointcut(\u0026#34;within(com.crab.spring.aop.demo02.UserService)\u0026#34;) public void m3() { } } this æ ¼å¼è¯´æ˜ thisï¼ˆç±»å‹å…¨é™å®šåï¼‰ï¼šé€šè¿‡ aop åˆ›å»ºçš„ä»£ç†å¯¹è±¡çš„ç±»å‹æ˜¯å¦å’Œ this ä¸­æŒ‡å®šçš„ç±»å‹åŒ¹é…ï¼›this ä¸­ä½¿ç”¨çš„è¡¨è¾¾å¼å¿…é¡»æ˜¯ç±»å‹å…¨é™å®šåï¼Œä¸æ”¯æŒé€šé…ç¬¦ã€‚\nthis(x) çš„åŒ¹é…è§„åˆ™æ˜¯ï¼šx.getClass.isAssingableFrom(proxy.getClass) ä¸¾ä¾‹è¯´æ˜ package com.crab.spring.aop.demo02.aspectj; @Aspect public class PointcutThis { interface I1{ void m(); } static class C1 implements I1{ @Override public void m() { System.out.println(\u0026#34;C1 m()\u0026#34;); } } // åŒ¹é… I1 ç±»å‹æˆ–æ˜¯å…¶å­ç±» @Pointcut(\u0026#34;this(com.crab.spring.aop.demo02.aspectj.PointcutThis.I1)\u0026#34;) public void pc(){} @Before(\u0026#34;pc()\u0026#34;) public void before(JoinPoint joinPoint) { System.out.println(\u0026#34;before: \u0026#34; + joinPoint); } public static void main(String[] args) { C1 target = new C1(); AspectJProxyFactory proxyFactory = new AspectJProxyFactory(); proxyFactory.setTarget(target); // proxyFactory.setProxyTargetClass(true); // è·å– C1 ä¸Šæ‰€æœ‰æ¥å£ spring å·¥å…·ç±»æä¾›çš„æ–¹æ³• Class\u0026lt;?\u0026gt;[] allInterfaces = ClassUtils.getAllInterfaces(target); // è®¾ç½®ä»£ç†æ¥å£ proxyFactory.setInterfaces(allInterfaces); // æ·»åŠ åˆ‡é¢ proxyFactory.addAspect(PointcutThis.class); // è·å–ä»£ç† I1 proxy = proxyFactory.getProxy(); // è°ƒç”¨æ–¹æ³• proxy.m(); System.out.println(\u0026#34;JDK ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isJdkDynamicProxy(proxy)); System.out.println(\u0026#34;CGLIB ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isCglibProxy(proxy)); //åˆ¤æ–­ä»£ç†å¯¹è±¡æ˜¯å¦æ˜¯ C1 ç±»å‹çš„ System.out.println(C1.class.isAssignableFrom(proxy.getClass())); } } æ¥è§‚å¯Ÿä¸‹è¾“å‡º\nbefore: execution(void com.crab.spring.aop.demo02.aspectj.PointcutThis$C1.m()) C1 m() JDK ä»£ç†ï¼Ÿfalse CGLIB ä»£ç†ï¼Ÿtrue true ä½¿ç”¨ JDK åŠ¨æ€ä»£ç†ç”Ÿæˆçš„ä»£ç†å¯¹è±¡ï¼Œå…¶ç±»å‹æ˜¯ I1 ç±»å‹ã€‚\næ€è€ƒä¸‹ï¼šå°†åˆ‡ç‚¹è¡¨è¾¾å¼æ”¹æˆä¸‹é¢çš„è¾“å‡ºç»“æœæ˜¯ï¼Ÿ\n// åŒ¹é… C1 ç±»å‹æˆ–æ˜¯å…¶å­ç±»\n@Pointcut(\u0026ldquo;this(com.crab.spring.aop.demo02.aspectj.PointcutThis.C1)\u0026rdquo;)\npublic void pc(){}\ntarget æ ¼å¼è¯´æ˜ targetï¼ˆç±»å‹å…¨é™å®šåï¼‰ï¼šåˆ¤æ–­ç›®æ ‡å¯¹è±¡çš„ç±»å‹æ˜¯å¦å’ŒæŒ‡å®šçš„ç±»å‹åŒ¹é…ï¼›è¡¨è¾¾å¼å¿…é¡»æ˜¯ç±»å‹å…¨é™å®šåï¼Œä¸æ”¯æŒé€šé…ç¬¦ã€‚\ntarget(x) åŒ¹é…è§„åˆ™ï¼šx.getClass().isAssignableFrom(target.getClass()); ä¸¾ä¾‹è¯´æ˜ @Aspect public class PointcutTarget { interface I1{ void m(); } static class C1 implements I1{ @Override public void m() { System.out.println(\u0026#34;C1 m()\u0026#34;); } } // åŒ¹é…ç›®æ ‡ç±»å‹å¿…é¡»æ˜¯ @Pointcut(\u0026#34;target(com.crab.spring.aop.demo02.aspectj.PointcutTarget.C1)\u0026#34;) public void pc(){} @Before(\u0026#34;pc()\u0026#34;) public void before(JoinPoint joinPoint) { System.out.println(\u0026#34;before: \u0026#34; + joinPoint); } public static void main(String[] args) { C1 target = new C1(); AspectJProxyFactory proxyFactory = new AspectJProxyFactory(); proxyFactory.setTarget(target); proxyFactory.setProxyTargetClass(true); // è·å– C1 ä¸Šæ‰€æœ‰æ¥å£ spring å·¥å…·ç±»æä¾›çš„æ–¹æ³• Class\u0026lt;?\u0026gt;[] allInterfaces = ClassUtils.getAllInterfaces(target); // è®¾ç½®ä»£ç†æ¥å£ proxyFactory.setInterfaces(allInterfaces); // æ·»åŠ åˆ‡é¢ proxyFactory.addAspect(PointcutTarget.class); // è·å–ä»£ç† I1 proxy = proxyFactory.getProxy(); // è°ƒç”¨æ–¹æ³• proxy.m(); System.out.println(\u0026#34;JDK ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isJdkDynamicProxy(proxy)); System.out.println(\u0026#34;CGLIB ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isCglibProxy(proxy)); //åˆ¤æ–­ä»£ç†å¯¹è±¡æ˜¯å¦æ˜¯ C1 ç±»å‹çš„ System.out.println(C1.class.isAssignableFrom(target.getClass())); } } è¾“å‡ºç»“æœ\nbefore: execution(void com.crab.spring.aop.demo02.aspectj.PointcutTarget$C1.m()) C1 m() JDK ä»£ç†ï¼Ÿfalse CGLIB ä»£ç†ï¼Ÿtrue true args æ ¼å¼è¯´æ˜ argsï¼ˆå‚æ•°ç±»å‹åˆ—è¡¨ï¼‰åŒ¹é…å½“å‰æ‰§è¡Œçš„æ–¹æ³•ä¼ å…¥çš„å‚æ•°æ˜¯å¦ä¸º args ä¸­æŒ‡å®šçš„ç±»å‹ï¼›å‚æ•°ç±»å‹åˆ—è¡¨ä¸­çš„å‚æ•°å¿…é¡»æ˜¯ç±»å‹å…¨é™å®šåï¼Œä¸æ”¯æŒé€šé…ç¬¦ï¼›args å±äºåŠ¨æ€åˆ‡å…¥ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œæ–¹æ³•çš„æ—¶å€™è¿›è¡Œåˆ¤æ–­çš„ï¼Œå¼€é”€éå¸¸å¤§ï¼Œéç‰¹æ®Šæƒ…å†µæœ€å¥½ä¸è¦ä½¿ç”¨ã€‚\nargs(String) // æ–¹æ³•ä¸ªæ•°ä¸º 1ï¼Œç±»å‹æ˜¯ String args(*,String) // æ–¹æ³•å‚æ•°ä¸ªæ•° 2ï¼Œç¬¬ 2 ä¸ªæ˜¯ String ç±»å‹ args(..,String) // æ–¹æ³•ä¸ªæ•°ä¸é™åˆ¶ï¼Œæœ€åä¸€ä¸ªå¿…é¡»æ˜¯ String ä¸¾ä¾‹è¯´æ˜ package com.crab.spring.aop.demo02.aspectj; @Aspect public class PointcutArgs { interface I1{ void m(Object name); } static class C1 implements I1{ @Override public void m(Object name) { String type = name.getClass().getName(); System.out.println(\u0026#34;C1 m() å‚æ•°ç±»å‹ \u0026#34; + type); } } // åŒ¹é…æ–¹æ³•å‚æ•°ä¸ªæ•° 1 ä¸”ç±»å‹æ˜¯å¿…é¡»æ˜¯ String @Pointcut(\u0026#34;args(String)\u0026#34;) public void pc(){} @Before(\u0026#34;pc()\u0026#34;) public void before(JoinPoint joinPoint) { System.out.println(\u0026#34;before: \u0026#34; + joinPoint); } public static void main(String[] args) { C1 target = new C1(); AspectJProxyFactory proxyFactory = new AspectJProxyFactory(); proxyFactory.setTarget(target); proxyFactory.setProxyTargetClass(true); // è·å– C1 ä¸Šæ‰€æœ‰æ¥å£ spring å·¥å…·ç±»æä¾›çš„æ–¹æ³• Class\u0026lt;?\u0026gt;[] allInterfaces = ClassUtils.getAllInterfaces(target); // è®¾ç½®ä»£ç†æ¥å£ proxyFactory.setInterfaces(allInterfaces); // æ·»åŠ åˆ‡é¢ proxyFactory.addAspect(PointcutArgs.class); // è·å–ä»£ç† I1 proxy = proxyFactory.getProxy(); // è°ƒç”¨æ–¹æ³• proxy.m(\u0026#34;xxxx\u0026#34;); proxy.m(100L); System.out.println(\u0026#34;JDK ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isJdkDynamicProxy(proxy)); System.out.println(\u0026#34;CGLIB ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isCglibProxy(proxy)); //åˆ¤æ–­ä»£ç†å¯¹è±¡æ˜¯å¦æ˜¯ C1 ç±»å‹çš„ System.out.println(C1.class.isAssignableFrom(target.getClass())); } } è§‚å¯Ÿä¸‹è¾“å‡º\nbefore: execution(void com.crab.spring.aop.demo02.aspectj.PointcutArgs$C1.m(Object)) C1 m() å‚æ•°ç±»å‹ java.lang.String C1 m() å‚æ•°ç±»å‹ java.lang.Long JDK ä»£ç†ï¼Ÿfalse CGLIB ä»£ç†ï¼Ÿtrue true\tå‚æ•°ç±»å‹ä¼ é€’æ˜¯ String æ—¶å€™å¢å¼ºäº†ï¼Œè€Œ Long çš„æ—¶å€™æ²¡æœ‰æ‰§è¡Œå¢å¼ºæ–¹æ³•ã€‚\n@within æ ¼å¼è¯´æ˜ @withinï¼ˆæ³¨è§£ç±»å‹ï¼‰ï¼šåŒ¹é…æŒ‡å®šçš„æ³¨è§£å†…å®šä¹‰çš„æ–¹æ³•ã€‚\nåŒ¹é…è§„åˆ™ï¼š è¢«è°ƒç”¨çš„ç›®æ ‡æ–¹æ³• Method å¯¹è±¡ã€‚getDeclaringClass().getAnnotation(within ä¸­æŒ‡å®šçš„æ³¨è§£ç±»å‹ï¼‰ != null ä¸¾ä¾‹è¯´æ˜ package com.crab.spring.aop.demo02.aspectj; @Aspect public class PointcutAnnWithin { @Retention(RetentionPolicy.RUNTIME) @Target(ElementType.TYPE) @interface MyAnn { } interface I1 { void m(); } @MyAnn static class C1 implements I1 { @Override public void m() { System.out.println(\u0026#34;C1 m()\u0026#34;); } } // åŒ¹é…ç›®æ ‡ç±»å‹å¿…é¡»ä¸Šå¿…é¡»æœ‰æ³¨è§£ MyAnn @Pointcut(\u0026#34;@within(com.crab.spring.aop.demo02.aspectj.PointcutAnnWithin.MyAnn)\u0026#34;) public void pc() { } @Before(\u0026#34;pc()\u0026#34;) public void before(JoinPoint joinPoint) { System.out.println(\u0026#34;before: \u0026#34; + joinPoint); } public static void main(String[] args) { C1 target = new C1(); AspectJProxyFactory proxyFactory = new AspectJProxyFactory(); proxyFactory.setTarget(target); proxyFactory.setProxyTargetClass(true); // è·å– C1 ä¸Šæ‰€æœ‰æ¥å£ spring å·¥å…·ç±»æä¾›çš„æ–¹æ³• Class\u0026lt;?\u0026gt;[] allInterfaces = ClassUtils.getAllInterfaces(target); // è®¾ç½®ä»£ç†æ¥å£ proxyFactory.setInterfaces(allInterfaces); // æ·»åŠ åˆ‡é¢ proxyFactory.addAspect(PointcutAnnWithin.class); // è·å–ä»£ç† I1 proxy = proxyFactory.getProxy(); // è°ƒç”¨æ–¹æ³• proxy.m(); System.out.println(\u0026#34;JDK ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isJdkDynamicProxy(proxy)); System.out.println(\u0026#34;CGLIB ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isCglibProxy(proxy)); //åˆ¤æ–­ä»£ç†å¯¹è±¡æ˜¯å¦æ˜¯ C1 ç±»å‹çš„ System.out.println(C1.class.isAssignableFrom(target.getClass())); } } è¾“å‡º\nbefore: execution(void com.crab.spring.aop.demo02.aspectj.PointcutAnnWithin$C1.m()) C1 m() JDK ä»£ç†ï¼Ÿfalse CGLIB ä»£ç†ï¼Ÿtrue true æ€è€ƒä¸‹çˆ¶ç±»ä¸Šæœ‰æ³¨è§£ï¼Œå­ç±»ç»§æ‰¿çˆ¶ç±»çš„æ–¹æ³•ï¼ŒåŒæ—¶è€ƒè™‘ä¸‹æ³¨è§£@Inherited æ˜¯å¦åœ¨åˆ‡ç‚¹æ³¨è§£çš„åœºæ™¯ï¼Ÿ\n@target æ ¼å¼è¯´æ˜ @targetï¼ˆæ³¨è§£ç±»å‹ï¼‰ï¼šåˆ¤æ–­ç›®æ ‡å¯¹è±¡ target ç±»å‹ä¸Šæ˜¯å¦æœ‰æŒ‡å®šçš„æ³¨è§£ï¼›@target ä¸­æ³¨è§£ç±»å‹ä¹Ÿå¿…é¡»æ˜¯å…¨é™å®šç±»å‹åã€‚\nåŒ¹é…è§„åˆ™ï¼š target.class.getAnnotationï¼ˆæŒ‡å®šçš„æ³¨è§£ç±»å‹ï¼‰ != null æ³¨æ„ï¼Œå¦‚æœç›®æ ‡æ³¨è§£æ˜¯æ ‡æ³¨åœ¨çˆ¶ç±»ä¸Šçš„ï¼Œé‚£ä¹ˆå®šä¹‰ç›®æ ‡æ³¨è§£æ—¶å€™åº”ä½¿ç”¨@Inheritedæ ‡æ³¨ï¼Œä½¿å­ç±»èƒ½ç»§æ‰¿çˆ¶ç±»çš„æ³¨è§£ã€‚\nä¸¾ä¾‹è¯´æ˜ package com.crab.spring.aop.demo02.aspectj; @Aspect public class PointcutAnnTarget { @Retention(RetentionPolicy.RUNTIME) @Target(ElementType.TYPE) @Inherited // å­ç±»èƒ½ç»§æ‰¿çˆ¶ç±»çš„æ³¨è§£ @interface MyAnn2 { } @MyAnn2 // æ³¨è§£åœ¨çˆ¶ç±»ä¸Š static class P1 { void m(){} } static class C1 extends P1 { @Override public void m() { System.out.println(\u0026#34;C1 m()\u0026#34;); } } // åŒ¹é…ç›®æ ‡ç±»å‹å¿…é¡»ä¸Šå¿…é¡»æœ‰æ³¨è§£ MyAnn @Pointcut(\u0026#34;@target(com.crab.spring.aop.demo02.aspectj.PointcutAnnTarget.MyAnn2)\u0026#34;) public void pc() { } @Before(\u0026#34;pc()\u0026#34;) public void before(JoinPoint joinPoint) { System.out.println(\u0026#34;before: \u0026#34; + joinPoint); } public static void main(String[] args) { C1 target = new C1(); AspectJProxyFactory proxyFactory = new AspectJProxyFactory(); proxyFactory.setTarget(target); proxyFactory.setProxyTargetClass(true); // è·å– C1 ä¸Šæ‰€æœ‰æ¥å£ spring å·¥å…·ç±»æä¾›çš„æ–¹æ³• Class\u0026lt;?\u0026gt;[] allInterfaces = ClassUtils.getAllInterfaces(target); // è®¾ç½®ä»£ç†æ¥å£ proxyFactory.setInterfaces(allInterfaces); // æ·»åŠ åˆ‡é¢ proxyFactory.addAspect(PointcutAnnTarget.class); // è·å–ä»£ç† C1 proxy = proxyFactory.getProxy(); // è°ƒç”¨æ–¹æ³• proxy.m(); System.out.println(\u0026#34;JDK ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isJdkDynamicProxy(proxy)); System.out.println(\u0026#34;CGLIB ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isCglibProxy(proxy)); // ç›®æ ‡ç±»ä¸Šæ˜¯å¦æœ‰åˆ‡ç‚¹æ³¨è§£ System.out.println(target.getClass().getAnnotation(MyAnn2.class)!= null); } } è¾“å‡ºç»“æœ\nbefore: execution(void com.crab.spring.aop.demo02.aspectj.PointcutAnnTarget$C1.m()) C1 m() JDK ä»£ç†ï¼Ÿfalse CGLIB ä»£ç†ï¼Ÿtrue true ä»ç»“æœæœ€åä¸€è¡Œçœ‹ï¼Œç›®æ ‡å¯¹è±¡ç»§æ‰¿äº†çˆ¶ç±»çš„æ³¨è§£ï¼Œç¬¦åˆ@target çš„åˆ‡ç‚¹è§„åˆ™ã€‚\n@args æ ¼å¼è¯´æ˜ @argsï¼ˆæ³¨è§£ç±»å‹ï¼‰ï¼šæ–¹æ³•å‚æ•°æ‰€å±çš„ç±»ä¸Šæœ‰æŒ‡å®šçš„æ³¨è§£ï¼›æ³¨æ„ä¸æ˜¯å‚æ•°ä¸Šæœ‰æŒ‡å®šçš„æ³¨è§£ï¼Œè€Œæ˜¯å‚æ•°ç±»å‹çš„ç±»ä¸Šæœ‰æŒ‡å®šçš„æ³¨è§£ã€‚å’Œargsç±»ä¼¼ï¼Œä¸è¿‡é’ˆå¯¹çš„æ˜¯å‚æ•°ç±»å‹ä¸Šçš„æ³¨è§£ã€‚\nåŒ¹é…è§„åˆ™ï¼š ä¼ å…¥çš„ç›®æ ‡ä½ç½®å‚æ•°ã€‚getClass().getAnnotation(@argsï¼ˆå¯¹åº”çš„å‚æ•°ä½ç½®çš„æ³¨è§£ç±»å‹ï¼‰)!= null ä¸¾ä¾‹è¯´æ˜ package com.crab.spring.aop.demo02.aspectj; @Aspect public class PointcutAnnArgs { @Retention(RetentionPolicy.RUNTIME) @Target(ElementType.TYPE) @Inherited // å­ç±»èƒ½ç»§æ‰¿çˆ¶ç±»çš„æ³¨è§£ @interface MyAnn3 { } @MyAnn3 static class MyParameter{ } static class C1 { public void m(MyParameter myParameter) { System.out.println(myParameter.getClass().getAnnotation(MyAnn3.class)); System.out.println(\u0026#34;C1 m()\u0026#34;); } } // åŒ¹é…æ–¹æ³•ä¸Šæœ€åçš„ä¸€ä¸ªå‚æ•°ç±»å‹ä¸Šæœ‰æ³¨è§£ MyAnn3 @Pointcut(\u0026#34;@args(..,com.crab.spring.aop.demo02.aspectj.PointcutAnnArgs.MyAnn3)\u0026#34;) public void pc() { } @Before(\u0026#34;pc()\u0026#34;) public void before(JoinPoint joinPoint) { System.out.println(\u0026#34;before: \u0026#34; + joinPoint); } public static void main(String[] args) { C1 target = new C1(); AspectJProxyFactory proxyFactory = new AspectJProxyFactory(); proxyFactory.setTarget(target); proxyFactory.setProxyTargetClass(true); // è·å– C1 ä¸Šæ‰€æœ‰æ¥å£ spring å·¥å…·ç±»æä¾›çš„æ–¹æ³• Class\u0026lt;?\u0026gt;[] allInterfaces = ClassUtils.getAllInterfaces(target); // è®¾ç½®ä»£ç†æ¥å£ proxyFactory.setInterfaces(allInterfaces); // æ·»åŠ åˆ‡é¢ proxyFactory.addAspect(PointcutAnnArgs.class); // è·å–ä»£ç† C1 proxy = proxyFactory.getProxy(); // è°ƒç”¨æ–¹æ³• MyParameter myParameter = new MyParameter(); proxy.m(myParameter); System.out.println(\u0026#34;JDK ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isJdkDynamicProxy(proxy)); System.out.println(\u0026#34;CGLIB ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isCglibProxy(proxy)); // ç›®æ ‡ç±»ä¸Šæ˜¯å¦æœ‰åˆ‡ç‚¹æ³¨è§£ System.out.println(myParameter.getClass().getAnnotation(MyAnn3.class)!= null); } } è§‚å¯Ÿç»“æœ\nbefore: execution(void com.crab.spring.aop.demo02.aspectj.PointcutAnnArgs$C1.m(MyParameter)) @com.crab.spring.aop.demo02.aspectj.PointcutAnnArgs$MyAnn3() C1 m() JDK ä»£ç†ï¼Ÿfalse CGLIB ä»£ç†ï¼Ÿtrue true ç¬¬äºŒè¡Œä¸­ç›®æ ‡æ–¹æ³•ä¸Šè¾“å‡ºäº†å‚æ•°çš„æ³¨è§£ã€‚\næœ€åä¸€è¡Œåˆ¤æ–­å‚æ•°ç±»å‹ä¸Šç¡®å®æœ‰æ³¨è§£ã€‚\n@annotation æ ¼å¼è¯´æ˜ @annotationï¼ˆæ³¨è§£ç±»å‹ï¼‰ï¼šåŒ¹é…è¢«è°ƒç”¨çš„ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ä¸Šæœ‰æŒ‡å®šçš„æ³¨è§£\nåŒ¹é…è§„åˆ™ï¼štarget.getClass().getMethod(\u0026#34;ç›®æ ‡æ–¹æ³•å\u0026#34;).getDeclaredAnnotation(@annotationï¼ˆç›®æ ‡æ³¨è§£ï¼‰)!=null è¿™ä¸ªåœ¨é’ˆå¯¹ç‰¹å®šæ³¨è§£çš„æ–¹æ³•æ—¥å¿—æ‹¦æˆªåœºæ™¯ä¸‹åº”ç”¨æ¯”è¾ƒå¤šã€‚\nä¸¾ä¾‹è¯´æ˜ package com.crab.spring.aop.demo02.aspectj; @Aspect public class PointcutAnnotation { @Retention(RetentionPolicy.RUNTIME) @Target(ElementType.METHOD) @interface MyAnn4 { } /** * çˆ¶ç±» æ–¹æ³•ä¸Šéƒ½æœ‰@MyAnn4 */ static class P1{ @MyAnn4 public void m1(){ System.out.println(\u0026#34;P1 m()\u0026#34;); } @MyAnn4 public void m2(){ System.out.println(\u0026#34;P1 m2()\u0026#34;); } } /** * å­ç±» * æ³¨æ„é‡æ–°é‡å†™äº†çˆ¶ç±»çš„ m1 æ–¹æ³•ä½†æ˜¯æ²¡æœ‰å£°æ˜æ³¨è§£@Ann4 * æ–°å¢äº† m3 æ–¹æ³•å¸¦æ³¨è§£@Ann4 */ static class C1 extends P1 { @Override public void m1() { System.out.println(\u0026#34;C1 m1()\u0026#34;); } @MyAnn4 public void m3() { System.out.println(\u0026#34;C1 m3()\u0026#34;); } } // åŒ¹é…è°ƒç”¨çš„æ–¹æ³•ä¸Šå¿…é¡»æœ‰æ³¨è§£ @Pointcut(\u0026#34;@annotation(com.crab.spring.aop.demo02.aspectj.PointcutAnnotation.MyAnn4)\u0026#34;) public void pc() { } @Before(\u0026#34;pc()\u0026#34;) public void before(JoinPoint joinPoint) { System.out.println(\u0026#34;before: \u0026#34; + joinPoint); } public static void main(String[] args) throws NoSuchMethodException { C1 target = new C1(); AspectJProxyFactory proxyFactory = new AspectJProxyFactory(); proxyFactory.setTarget(target); proxyFactory.setProxyTargetClass(true); // è·å– C1 ä¸Šæ‰€æœ‰æ¥å£ spring å·¥å…·ç±»æä¾›çš„æ–¹æ³• Class\u0026lt;?\u0026gt;[] allInterfaces = ClassUtils.getAllInterfaces(target); // è®¾ç½®ä»£ç†æ¥å£ proxyFactory.setInterfaces(allInterfaces); // æ·»åŠ åˆ‡é¢ proxyFactory.addAspect(PointcutAnnotation.class); // è·å–ä»£ç† C1 proxy = proxyFactory.getProxy(); // è°ƒç”¨æ–¹æ³• proxy.m1(); proxy.m2(); proxy.m3(); System.out.println(\u0026#34;JDK ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isJdkDynamicProxy(proxy)); System.out.println(\u0026#34;CGLIB ä»£ç†ï¼Ÿ\u0026#34; + AopUtils.isCglibProxy(proxy)); // ç›®æ ‡å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•ä¸Šæ˜¯å¦ç›´æ¥å£°æ˜äº†æ³¨è§£ MyAnn4 System.out.println(target.getClass().getMethod(\u0026#34;m1\u0026#34;).getDeclaredAnnotation(MyAnn4.class)!=null); System.out.println(target.getClass().getMethod(\u0026#34;m2\u0026#34;).getDeclaredAnnotation(MyAnn4.class)!=null); System.out.println(target.getClass().getMethod(\u0026#34;m3\u0026#34;).getDeclaredAnnotation(MyAnn4.class)!=null); } } è§‚å¯Ÿä¸‹ç»“æœ\nC1 m1() before: execution(void com.crab.spring.aop.demo02.aspectj.PointcutAnnotation$P1.m2()) P1 m2() before: execution(void com.crab.spring.aop.demo02.aspectj.PointcutAnnotation$C1.m3()) C1 m3() JDK ä»£ç†ï¼Ÿfalse CGLIB ä»£ç†ï¼Ÿtrue false true ç®€å•åˆ†æä¸‹ï¼š\nC1 ä¸­é‡å†™äº† m1 æ–¹æ³•ï¼Œä¸Šé¢æœ‰æ²¡æœ‰ @Ann4ï¼Œæ‰€æœ‰æ–¹æ³•æ²¡æœ‰è¢«æ‹¦æˆª å…¶å®ƒçš„ m2 åœ¨çˆ¶ç±»ä¸Šæœ‰æ³¨è§£@Ann4ï¼Œm3 åœ¨å­ç±»ä¸Šä¹Ÿæœ‰æ³¨è§£@Ann4ï¼Œæ‰€ä»¥æ‹¦æˆªäº†ã€‚ æœ€å 3 è¡Œè¾“å‡ºäº†ç›®æ ‡å¯¹è±¡çš„ 3 ä¸ªæ–¹æ³•ä¸Šæ˜¯å¦æœ‰æ³¨è§£çš„æƒ…å†µã€‚ bean æ ¼å¼è¯´æ˜ bean(bean åç§°ï¼‰ï¼šè¿™ä¸ªç”¨åœ¨ spring ç¯å¢ƒä¸­ï¼ŒåŒ¹é…å®¹å™¨ä¸­æŒ‡å®šåç§°çš„ beanã€‚\nåŒ¹é…æ ¼å¼ï¼šApplicationContext.getBean(\u0026#34;bean è¡¨è¾¾å¼ä¸­æŒ‡å®šçš„ bean åç§°\u0026#34;) != null ä¸¾ä¾‹è¯´æ˜ å®šä¹‰ä¸€ä¸ª bean\npackage com.crab.spring.aop.demo02.aspectj; public class MyBean { private String beanName; public MyBean(String beanName) { this.beanName = beanName; } public void m() { System.out.println(\u0026#34;æˆ‘æ˜¯\u0026#34; + this.beanName); } } åˆ‡é¢ä¸­çš„åˆ‡ç‚¹å’Œé€šçŸ¥å®šä¹‰\n@Aspect public class PointcutBean { // å®¹å™¨ä¸­ bean åç§°æ˜¯\u0026#34;myBean1\u0026#34;çš„æ–¹æ³•è¿›è¡Œæ‹¦æˆª @Pointcut(\u0026#34;bean(myBean1)\u0026#34;) public void pc() { } @Before(\u0026#34;pc()\u0026#34;) public void m(JoinPoint joinPoint) { System.out.println(\u0026#34;start \u0026#34; + joinPoint); } } ç»„åˆä½¿ç”¨\n@Aspect @Configuration @EnableAspectJAutoProxy // è‡ªåŠ¨ç”Ÿæˆä»£ç†å¯¹è±¡ public class PointcutBeanConfig { // æ³¨å…¥ myBean1 @Bean(\u0026#34;myBean1\u0026#34;) public MyBean myBean1() { return new MyBean(\u0026#34;myBean1\u0026#34;); } // myBean2 @Bean(\u0026#34;myBean2\u0026#34;) public MyBean myBean2() { return new MyBean(\u0026#34;myBean2\u0026#34;); } // æ³¨å…¥åˆ‡é¢ @Bean(\u0026#34;pointcutBean\u0026#34;) public PointcutBean pointcutBean() { return new PointcutBean(); } public static void main(String[] args) { AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(PointcutBeanConfig.class); MyBean myBean1 = context.getBean(\u0026#34;myBean1\u0026#34;, MyBean.class); myBean1.m(); MyBean myBean2 = context.getBean(\u0026#34;myBean2\u0026#34;, MyBean.class); myBean2.m(); } } è§‚å¯Ÿä¸‹ç»“æœ\nstart execution(void com.crab.spring.aop.demo02.aspectj.MyBean.m()) æˆ‘æ˜¯ myBean1 æˆ‘æ˜¯ myBean2 myBean1 çš„æ–¹æ³•è¢«æ‹¦æˆªäº†ã€‚\nä¸Šé¢ä»‹ç»äº† Spring ä¸­ 10 ä¸­åˆ‡ç‚¹è¡¨è¾¾å¼ï¼Œä¸‹é¢ä»‹ç»ä¸‹åˆ‡ç‚¹çš„ç»„åˆä½¿ç”¨å’Œå…¬å…±åˆ‡ç‚¹çš„æŠ½å–ã€‚\nåˆ‡ç‚¹çš„ç»„åˆ åˆ‡ç‚¹ä¸åˆ‡ç‚¹ç›´æ¥æ”¯æŒé€»è¾‘é€»è¾‘ç»„åˆæ“ä½œï¼š \u0026amp;\u0026amp; ã€||ã€ !ã€‚ä½¿ç”¨è¾ƒå°çš„å‘½åç»„ä»¶æ„å»ºæ›´å¤æ‚çš„åˆ‡å…¥ç‚¹è¡¨è¾¾å¼æ˜¯æœ€ä½³å®è·µã€‚\nåŒä¸€ä¸ªç±»å†…åˆ‡ç‚¹ç»„åˆ public class CombiningPointcut { /** * åŒ¹é… com.crab.spring.aop.demo02 åŒ…åŠå­åŒ…ä¸‹ä»»ä½•ç±»çš„ public æ–¹æ³• */ @Pointcut(\u0026#34;execution(public * com.crab.spring.aop.demo02..*.*(..))\u0026#34;) public void publicMethodPc() { } /** * com.crab.spring.aop.demo02.UserService ç±»çš„æ‰€æœ‰æ–¹æ³• */ @Pointcut(\u0026#34;execution(* com.crab.spring.aop.demo02.UserService.*(..))\u0026#34;) public void serviceMethodPc(){} /** * ç»„åˆçš„åˆ‡ç‚¹ */ @Pointcut(\u0026#34;publicMethodPc() \u0026amp;\u0026amp; serviceMethodPc()\u0026#34;) public void combiningPc(){ } /** * ç»„åˆçš„åˆ‡ç‚¹ 2 */ @Pointcut(\u0026#34;publicMethodPc() || !serviceMethodPc()\u0026#34;) public void combiningPc2(){ } } ä¸åŒç±»ä¹‹é—´åˆ‡ç‚¹ç»„åˆ åˆ‡ç‚¹æ–¹æ³•çš„å¯è§æ€§ä¼šå½±å“ç»„åˆä½†æ˜¯ä¸å½±å“åˆ‡ç‚¹çš„åŒ¹é…ã€‚\npublic class CombiningPointcut2 { /** * com.crab.spring.aop.demo02.UserService ç±»çš„æ‰€æœ‰æ–¹æ³• */ @Pointcut(\u0026#34;execution(* com.crab.spring.aop.demo02.UserService.*(..))\u0026#34;) public void serviceMethodPc2(){} /** * ç»„åˆçš„åˆ‡ç‚¹ï¼Œè·¨ç±»ç»„åˆ */ @Pointcut(\u0026#34;com.crab.spring.aop.demo02.aspectj.reuse.CombiningPointcut.publicMethodPc() \u0026amp;\u0026amp; serviceMethodPc2()\u0026#34;) public void combiningPc(){ } /** * ç»„åˆçš„åˆ‡ç‚¹ï¼Œè·¨ç±»ç»„åˆï¼Œç”±äº serviceMethodPc æ˜¯ private, æ­¤å¤„æ— æ³•ç»„åˆ */ @Pointcut(\u0026#34;com.crab.spring.aop.demo02.aspectj.reuse.CombiningPointcut.serviceMethodPc() \u0026amp;\u0026amp; serviceMethodPc2()\u0026#34;) public void combiningPc2(){ } } åˆ‡ç‚¹çš„å…¬ç”¨ åœ¨ä½¿ç”¨ä¼ä¸šåº”ç”¨ç¨‹åºæ—¶ï¼Œå¼€å‘äººå‘˜é€šå¸¸å¸Œæœ›ä»å¤šä¸ªæ–¹é¢å¼•ç”¨åº”ç”¨ç¨‹åºçš„æ¨¡å—å’Œç‰¹å®šçš„æ“ä½œé›†ã€‚å»ºè®®ä¸ºæ­¤ç›®çš„å®šä¹‰ä¸€ä¸ªæ•è·å…¬å…±åˆ‡å…¥ç‚¹è¡¨è¾¾å¼çš„ CommonPointcuts æ–¹é¢ã€‚ç›´æ¥çœ‹æ¡ˆä¾‹ã€‚\nä¸åŒå±‚çš„å…¬å…±åˆ‡ç‚¹\n/** * å…¬ç”¨çš„åˆ‡ç‚¹ */ public class CommonPointcuts { /** * web å±‚çš„é€šç”¨åˆ‡ç‚¹ */ @Pointcut(\u0026#34;within(com.xyz.myapp.web..*)\u0026#34;) public void inWebLayer() {} @Pointcut(\u0026#34;within(com.xyz.myapp.service..*)\u0026#34;) public void inServiceLayer() {} @Pointcut(\u0026#34;within(com.xyz.myapp.dao..*)\u0026#34;) public void inDataAccessLayer() {} @Pointcut(\u0026#34;execution(* com.xyz.myapp..service.*.*(..))\u0026#34;) public void businessService() {} @Pointcut(\u0026#34;execution(* com.xyz.myapp.dao.*.*(..))\u0026#34;) public void dataAccessOperation() {} } ç¨‹åºä¸­å¯ä»¥ç›´æ¥å¼•ç”¨è¿™äº›å…¬å…±çš„åˆ‡ç‚¹\n@Aspect public class UseCommonPointcuts { /** * ç›´æ¥ä½¿ç”¨å…¬å…±åˆ‡ç‚¹ */ @Before(\u0026#34;com.crab.spring.aop.demo02.aspectj.reuse.CommonPointcuts.inWebLayer()\u0026#34;) public void before(JoinPoint joinPoint){ System.out.println(\u0026#34;before:\u0026#34; + joinPoint); } } å¸¦å‚æ•°çš„åˆ‡ç‚¹ @RunWith(SpringJUnit4ClassRunner.class) @ContextConfiguration(classes = AspectConfig.class) public class AspectDemo { @Autowired private List\u0026lt;Perform\u0026gt; performList; @Test public void testPerform(){ for (Perform perform : performList) { perform.doPerform(\u0026#34;dc1\u0026#34;); } } } @Configuration @ComponentScan @EnableAspectJAutoProxy public class AspectConfig { @Bean public Audience audience() { return new Audience(); } } @Aspect public class Audience { /** * å£°æ˜ä¸€ä¸ªåˆ‡ç‚¹ */ @Pointcut(\u0026#34;execution(* io2.dc.Perform.doPerform(..)) \u0026amp;\u0026amp; bean(poet)\u0026#34;) public void perform(){}; /** * å£°æ˜ä¸€ä¸ªå¯ä»¥æ¥æ”¶å‚æ•°çš„åˆ‡ç‚¹ * @param name */ @Pointcut(\u0026#34;execution(* io2.dc.Perform.doPerform(String)) \u0026amp;\u0026amp; args(name)\u0026#34;) public void performWithArg(String name){}; @Before(\u0026#34;perform()\u0026#34;) public void drinkWater() { System.out.println(\u0026#34;å–å£æ°´\u0026#34;); } @Before(\u0026#34;performWithArg(name)\u0026#34;) public void printName(String name) { System.out.println((name + \u0026#34;å¼€å§‹è¡¨æ¼”äº†\u0026#34;)); } } public interface Perform{ int doPerform(String name); } @Component public class Poet implements Perform { @Override public int doPerform(String name) { System.out.println((\u0026#34;æœ—è¯µ\u0026#34; + name)); return 0; } } @Component public class Singer implements Perform { @Override public int doPerform(String name) { System.out.println((\u0026#34;æ­Œå”±å®¶\u0026#34; + name)); return 0; } } å‚è€ƒèµ„æ–™\nhttps://www.cnblogs.com/kongbubihai/p/16017046.html ã€ŠSpring å®æˆ˜ç¬¬4ç‰ˆã€‹ ","date":"2022-11-27T17:08:10Z","permalink":"https://dccmmtop.github.io/posts/aop%E7%9A%84%E4%BD%BF%E7%94%A8/","section":"posts","tags":["spring"],"title":"AOP çš„ä½¿ç”¨"},{"categories":null,"contents":"æ¨ªåˆ‡å…³æ³¨ç‚¹ æ•£æ’­åº”ç”¨ä¸­å¤šå¤„çš„åŠŸèƒ½è¢«ç§°ä¸ºæ¨ªåˆ‡å…³æ³¨ç‚¹\nå®‰å…¨å°±æ˜¯ä¸€ä¸ªå…³æ³¨ç‚¹ï¼Œæ¯ä¸ªæ–¹æ³•æˆ–è€…ç±»éƒ½éœ€è¦æ³¨é‡å®‰å…¨ æ–¹æ³•å‚æ•°æ—¥å¿—è®°å½•ä¹Ÿæ˜¯ä¸€ä¸ªå…³æ³¨ç‚¹ ä»¥åŠäº‹åŠ¡ç®¡ç† æ¨ªåˆ‡å…³æ³¨ç‚¹ä»æ¦‚å¿µä¸Šè®²æ˜¯ä¸ä¸šåŠ¡åˆ†ç¦»çš„ï¼Œä½†å¾€å¾€ä¼šç›´æ¥åµŒå…¥åˆ°ä¸šåŠ¡ä¸­\nå¤šä¸ªç±»ä½¿ç”¨åˆ°ç›¸åŒçš„åŠŸèƒ½ã€‚æœ€å¸¸è§åˆ°çš„å°±æ˜¯ç»§æ‰¿æˆ–å§”æ‰˜\nä¸ºä»€ä¹ˆä¸ä½¿ç”¨ç»§æ‰¿\nå¦‚æœæ•´ä¸ªåº”ç”¨éƒ½ä½¿ç”¨ç›¸åŒçš„åŸºç±»ï¼Œä¼šå¯¼è‡´è„†å¼±çš„å¯¹è±¡ä½“ç³»\nä¸ºä»€ä¹ˆä¸ä½¿ç”¨å§”æ‰˜\nå¯èƒ½éœ€è¦å¯¹å§”æ‰˜å¯¹è±¡è¿›è¡Œå¤æ‚çš„è°ƒç”¨\næŠŠæ¨ªåˆ‡å…³æ³¨ç‚¹ä¸ä¸šåŠ¡åˆ†ç¦»æ˜¯é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰è¦è§£å†³çš„é‡è¦é—®é¢˜\nåˆ‡é¢ æ¨ªåˆ‡ç‚¹å¯ä»¥è¢«æ¨¡å—åŒ–ä¸ºç‰¹æ®Šçš„ç±»ï¼Œè¿™ä¸ªç±»è¢«ç§°ä¸ºåˆ‡é¢ å–ä»£ç»§æ‰¿å’Œå§”æ‰˜çš„å¦ä¸€ç§æ–¹æ¡ˆ ä¸€å¤„å®šä¹‰åŠŸèƒ½ï¼Œç”Ÿå£°æ˜ä½•æ—¶ä½•åœ°ä½¿ç”¨ æœ¯è¯­ AOP å·²ç»å½¢æˆäº†è‡ªå·±çš„æœ¯è¯­ï¼Œå¸¸è§çš„æœ‰ 1. é€šçŸ¥ 2. åˆ‡ç‚¹ 3. è¿æ¥ç‚¹\né€šçŸ¥ Advice åˆ‡é¢è¦å®Œæˆçš„å·¥ä½œè¢«ç§°ä¸ºé€šçŸ¥ï¼Œå®ƒå®šä¹‰äº†åˆ‡é¢è¦åšä»€ä¹ˆï¼Œä½•æ—¶ä½¿ç”¨\nä½•æ—¶ä½¿ç”¨\nå‰ç½®é€šçŸ¥ Before\nåœ¨ç›®æ ‡æ–¹æ³•è¢«è°ƒç”¨ä¹‹å‰è°ƒç”¨é€šçŸ¥åŠŸèƒ½ åç½®é€šçŸ¥ After\nåœ¨ç›®æ ‡æ–¹æ³•å®Œæˆä¹‹åè°ƒç”¨é€šçŸ¥ï¼Œä¸ä¼šå…³å¿ƒæ–¹æ³•è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Œä¹Ÿä¸ä¼šå…³å¿ƒæ˜¯å¦æ‰§è¡ŒæˆåŠŸ è¿”å›é€šçŸ¥ After-returning\nåœ¨ç›®æ ‡æ–¹æ³•æˆåŠŸæ‰§è¡Œä¹‹åè°ƒç”¨é€šçŸ¥ å¼‚å¸¸é€šçŸ¥ After-throwing\nåœ¨ç›®æ ‡æ–¹æ³•æŠ›å‡ºå¼‚å¸¸åè°ƒç”¨é€šçŸ¥ ç¯ç»•é€šçŸ¥ Around\nåŒ…è£¹è¢«é€šçŸ¥çš„æ–¹æ³•ï¼šç›®æ ‡æ–¹æ³•è°ƒç”¨ä¹‹å‰ä¹‹åéƒ½è¦æ‰§è¡Œ è¿æ¥ç‚¹ JoinPoint è§¦å‘é€šçŸ¥çš„æ—¶æœºå«åšè¿æ¥ç‚¹\nè°ƒç”¨æ–¹æ³•æ—¶ æŠ›å‡ºå¼‚å¸¸æ—¶ ä¿®æ”¹å­—æ®µæ—¶ ç­‰ åˆ‡ç‚¹ PointCut è¦æ‰§è¡Œé€šçŸ¥çš„åœ°ç‚¹ï¼ŒæŒ‡æ˜äº†å“ªäº›æ–¹æ³•è¦æ‰§è¡Œåˆ‡é¢ã€‚ é€šå¸¸ä½¿ç”¨æ˜ç¡®çš„ç±»æˆ–æ–¹æ³•åç§°æˆ–æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ç±»æˆ–æ–¹æ³•åæŒ‡å®šåˆ‡ç‚¹ åˆ‡é¢ Aspect åˆ‡é¢æ˜¯é€šçŸ¥å’Œåˆ‡ç‚¹çš„ç»“åˆï¼Œå®ƒæ˜¯ä»€ä¹ˆï¼Œä½•æ—¶ ä½•åœ°å®Œæˆå…¶åŠŸèƒ½ å¼•å…¥ Introduction å¯ä»¥åœ¨ç°æœ‰çš„ç±»ä¸­æ·»åŠ æ–°çš„æ–¹æ³•å’Œå±æ€§ ç»‡å…¥ Weaving æŠŠåˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡å¹¶åˆ›å»ºæ–°çš„ä»£ç†å¯¹è±¡çš„è¿‡ç¨‹ã€‚\nç»‡å…¥å¯ä»¥åœ¨å¤šä¸ªæ—¶æœŸå‘ç”Ÿï¼š\nç¼–è¯‘æœŸ\nåˆ‡é¢åœ¨ç›®æ ‡ç±»ç¼–è¯‘æœŸè¢«ç»‡å…¥ï¼Œéœ€è¦ç‰¹æ®Šçš„ç¼–è¯‘å™¨ ç±»åŠ è½½æœŸ\nåˆ‡é¢åœ¨ç›®æ ‡ç±»åŠ è½½åˆ°JVMæ—¶è¢«ç»‡å…¥ï¼Œéœ€è¦ç‰¹æ®Šçš„ç±»åŠ è½½å™¨ã€‚ä»–å¯ä»¥åœ¨ç›®æ ‡ç±»è¢«å¼•å…¥åˆ°åº”ç”¨ä¹‹å‰å¢å¼ºè¯¥ç›®æ ‡ç±»çš„å­—èŠ‚ç  è¿è¡ŒæœŸ\nåˆ‡é¢åœ¨åº”ç”¨è¿è¡Œçš„æŸæ—¶åˆ»è¢«ç»‡å…¥ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨ç»‡å…¥åˆ‡é¢æ—¶ï¼ŒAOPå®¹å™¨ä¼šä¸ºç›®æ ‡å¯¹è±¡åŠ¨æ€çš„åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ï¼ŒSpringAOPå°±æ˜¯ä»¥è¿™ç§æ–¹å¼ç»‡å…¥åˆ‡é¢çš„ Springå¯¹AOPçš„æ”¯æŒ Spring æä¾›äº†4ç§ç±»å‹çš„AOPæ”¯æŒ åŸºäºä»£ç†çš„ç»å…¸AOP\nä¸ç”¨ï¼Œè¿‡äºç¬¨é‡å’Œå¤æ‚ çº¯POJOåˆ‡é¢\nä¸æ€ä¹ˆç”¨ï¼Œéœ€è¦XMLé…ç½® @AspectJæ³¨è§£é©±åŠ¨åˆ‡é¢\nç”¨çš„å¤š æ³¨å…¥å¼ AspectJåˆ‡é¢ï¼Œé€‚ç”¨Springå„ç§ç‰ˆæœ¬\nSpring åªæ”¯æŒæ–¹æ³•çº§åˆ«çš„è¿æ¥ç‚¹ å› ä¸ºSpring åŸºäºåŠ¨æ€ä»£ç†å®ç°çš„AOP\nSpring ä¸æ”¯æŒå¯¹å­—æ®µå’Œæ„é€ å™¨è¿æ¥ç‚¹\nä¸å¯ä»¥æ‹¦æˆªå¯¹è±¡å­—æ®µçš„ä¿®æ”¹ æ— æ³•åœ¨beanåˆ›å»ºæ—¶æ‹¦æˆª AspectJ å’Œ JBoss é™¤äº†æ–¹æ³•åˆ‡ç‚¹ï¼Œè¿˜æ”¯æŒå­—æ®µå’Œæ„é€ å™¨\nç¼–å†™åˆ‡é¢ SpringAOP ä»…æ”¯æŒéƒ¨åˆ†AspectæŒ‡ç¤ºå™¨ Spring AOP æ”¯æŒçš„æŒ‡ç¤ºå™¨ï¼š arg()\né™åˆ¶è¿æ¥ç‚¹çš„åŒ¹é…å‚æ•°ä¸ºä¸ºæŒ‡å®šç±»å‹çš„æ‰§è¡Œæ–¹æ³•\n@args()\né™åˆ¶è¿æ¥ç‚¹åŒ¹é…å‚æ•°ç”±æŒ‡å®šæ³¨è§£æ ‡æ³¨çš„æ‰§è¡Œæ–¹æ³•\nexecution()\nç”¨äºåŒ¹é…æ˜¯è¿æ¥ç‚¹çš„æ‰§è¡Œæ–¹æ³•\nthis()\né™åˆ¶è¿æ¥ç‚¹åŒ¹é… AOPä»£ç†çš„beanå¼•ç”¨ä¸ºæŒ‡å®šç±»å‹çš„ç±»\ntarget\né™åˆ¶è¿æ¥ç‚¹åŒ¹é…ç›®æ ‡å¯¹è±¡ä¸ºæŒ‡å®šç±»å‹çš„ç±»\n@target()\né™åˆ¶è¿æ¥ç‚¹åŒ¹é…ç‰¹å®šçš„æ‰§è¡Œå¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡å¯¹åº”çš„ç±»è¦æœ‰æŒ‡å®šç±»å‹çš„æ³¨è§£\nwithin()\né™åˆ¶è¿æ¥ç‚¹åŒ¹é…æŒ‡å®šçš„ç±»å‹\n@within()\né™åˆ¶è¿æ¥ç‚¹åŒ¹é…æ³¨è§£æ‰€æ ‡æ³¨çš„ç±»å‹\n@annotation\né™å®šåŒ¹é… å¸¦æœ‰æŒ‡å®šæ³¨è§£çš„è¿æ¥ç‚¹\nbean()\né™å®šbeanId\nå½“åœ¨Spring ä¸­ä½¿ç”¨å…¶ä»–æŒ‡ç¤ºå™¨æ—¶ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸\nåªæœ‰ execution æŒ‡ç¤ºå™¨æ˜¯å®é™…æ‰§è¡ŒåŒ¹é…çš„ï¼Œå…¶ä»–éƒ½æ˜¯é™åˆ¶åŒ¹é…çš„\nåˆ‡å…¥ç‚¹çš„ç¼–å†™è§„åˆ™ ç¤ºä¾‹ï¼š\nä¸ within() é…åˆ\nåœ¨åˆ‡ç‚¹ä¸­é€‰æ‹©bean\n","date":"2022-11-27T15:06:05Z","permalink":"https://dccmmtop.github.io/posts/%E9%9D%A2%E5%90%91%E5%88%87%E9%9D%A2%E7%9A%84spring/","section":"posts","tags":["spring"],"title":"é¢å‘åˆ‡é¢çš„Spring"},{"categories":null,"contents":"ä»€ä¹ˆæ˜¯å¾ªç¯ä¾èµ– A ç±»ä¸­æœ‰ä¸€ä¸ªå±æ€§ B ï¼Œä¹Ÿå°±æ˜¯è¯´ A ä¾èµ– Bï¼ŒåŒæ—¶ B ç±»ä¸­æœ‰ä¸€ä¸ªå±æ€§ A, ä¹Ÿå°±æ˜¯è¯´ B ä¾èµ– A. ä»–ä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»å½¢æˆäº†ç¯ã€‚å°±æ˜¯æˆ‘ä»¬è¯´çš„å¾ªç¯ä¾èµ–ï¼Œå¦‚ä¸‹å›¾ï¼š\nå¾ªç¯ä¾èµ–ç¤ºä¾‹ public class CircularDependenciesDemo { public static void main(String[] args) { new A1(); } } class A1 { private B1 b1; public A1() { this.b1 = new B1(); } } class B1 { private A1 a1; public B1() { this.a1 = new A1(); } } ç»“æœï¼š\nException in thread \u0026#34;main\u0026#34; java.lang.StackOverflowError at io.dc.B1.\u0026lt;init\u0026gt;(CircularDependenciesDemo.java:23) at io.dc.A1.\u0026lt;init\u0026gt;(CircularDependenciesDemo.java:16) at io.dc.B1.\u0026lt;init\u0026gt;(CircularDependenciesDemo.java:24) å¦‚ä¸Šæ‰€ç¤ºï¼Œå‘ç”Ÿ æ ˆæº¢å‡ºé”™è¯¯ã€‚ä¸‹é¢æˆ‘ä»¬è¯•ç€è§£å†³è¿™ç§å¾ªç¯ä¾èµ–\nè§£å†³å¾ªç¯ä¾èµ– public class CircularDependenciesDemo { // å®ä¾‹ç¼“å­˜æ±  public static Map\u0026lt;String, Object\u0026gt; existsObject = new HashMap\u0026lt;\u0026gt;(); public static Object loadObject (String objectName) { if(existsObject.containsKey(objectName)) { return existsObject.get(objectName); } if(\u0026#34;A1\u0026#34;.equals(objectName)) { A1 a1 = new A1(); // å…ˆå°†ç©ºç™½çš„å®ä¾‹æ”¾å…¥ç¼“å­˜ existsObject.put(\u0026#34;A1\u0026#34;,a1); // ç„¶åå°†å¯¹è¯¥ç©ºç™½å®ä¾‹è¿›è¡Œå±æ€§èµ‹å€¼ a1.setB1((B1)loadObject(\u0026#34;B1\u0026#34;)); return a1; } if (\u0026#34;B1\u0026#34;.equals(objectName)) { B1 b1 = new B1(); existsObject.put(\u0026#34;B1\u0026#34;,b1); b1.setA1((A1)loadObject(\u0026#34;A1\u0026#34;)); return b1; } return null; } public static void main(String[] args) { A1 a1 = (A1)loadObject(\u0026#34;A1\u0026#34;); a1.getB1().sayHello(); } } class A1 { private B1 b1; public B1 getB1() { return b1; } public void setB1(B1 b1) { this.b1 = b1; } } class B1 { private A1 a1; public A1 getA1() { return a1; } public void setA1(A1 a1) { this.a1 = a1; } public void sayHello(){ System.out.println(\u0026#34;æˆ‘æ˜¯ B1 , ä½ å¥½\u0026#34;); } } ç»“æœï¼š\næˆ‘æ˜¯ B1 , ä½ å¥½ æœ¬æ¥ç”±æ„é€ æ–¹æ³•æ¥æ„é€  A1 ä¸­çš„ B1. ç°åœ¨åˆ†æˆä¸¤æ­¥ï¼š\nå…ˆè°ƒç”¨æ— å‚æ„é€ å™¨ç”Ÿæˆä¸€ä¸ªç©ºç™½å®ä¾‹ å†è°ƒç”¨ set æ–¹æ³•ï¼Œä¸ºç©ºç™½å®ä¾‹èµ‹å€¼ ä¸ºäº†è§£å†³å¾ªç¯ä¾èµ–ï¼Œè®¾ç½®äº†ä¸€ä¸ªå®ä¾‹ç¼“å­˜æ± ï¼ŒexistsObject. ç”¨æ¥å­˜æ”¾å·²ç»ç”Ÿæˆçš„å®ä¾‹ã€‚ä½†æ˜¯è¿™ä¸ªå®ä¾‹æ± ä¼šå­˜æ”¾ç©ºç™½å¯¹è±¡çš„çŠ¶æ€ã€‚åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œä¼šå–åˆ°ä¸€ä¸ªç©ºç™½å®ä¾‹ã€‚ä¹Ÿå°±æ˜¯å¯¹è±¡ä¸­çš„å­—æ®µéƒ½æ˜¯ null, å¼•å‘ç¨‹åºé”™è¯¯ã€‚æˆ‘ä»¬å¯ä»¥å†æ·»åŠ ä¸€å±‚äºŒçº§ç¼“å­˜ï¼ŒäºŒçº§ç¼“å­˜ä¸­å­˜æ”¾ç©ºç™½å®ä¾‹ã€‚ä¸€çº§ç¼“å­˜ä¸­åªæ”¾å®Œæ•´å®ä¾‹ã€‚\nçº¯å‡€çš„ç¼“å­˜ public class CircularDependenciesDemo { // ä¸€çº§ç¼“å­˜ï¼Œåªå­˜æ”¾å®Œæ•´çš„å¯¹è±¡ public static Map\u0026lt;String, Object\u0026gt; existsObject = new HashMap\u0026lt;\u0026gt;(); // äºŒçº§ç¼“å­˜ï¼ŒåŒ…å«ç©ºç™½çš„å¯¹è±¡ public static Map\u0026lt;String, Object\u0026gt; blankObject = new HashMap\u0026lt;\u0026gt;(); // åŠ è½½å¯¹è±¡ public static Object loadObject (String objectName) { // å…ˆä»ä¸€çº§ç¼“å­˜å– if(existsObject.containsKey(objectName)) { return existsObject.get(objectName); } // å†ä»äºŒçº§ç¼“å­˜å– if(blankObject.containsKey(objectName)) { return blankObject.get(objectName); } if(\u0026#34;A1\u0026#34;.equals(objectName)) { A1 a1 = new A1(); // å…ˆå°†ç©ºç™½çš„å®ä¾‹æ”¾å…¥äºŒçº§ç¼“å­˜ blankObject.put(\u0026#34;A1\u0026#34;,a1); // ç„¶åå°†å¯¹è¯¥ç©ºç™½å®ä¾‹è¿›è¡Œå±æ€§èµ‹å€¼ a1.setB1((B1)loadObject(\u0026#34;B1\u0026#34;)); // å†æ”¾å…¥ä¸€çº§ç¼“å­˜ existsObject.put(\u0026#34;A1\u0026#34;,a1); return a1; } if (\u0026#34;B1\u0026#34;.equals(objectName)) { B1 b1 = new B1(); blankObject.put(\u0026#34;B1\u0026#34;,b1); b1.setA1((A1)loadObject(\u0026#34;A1\u0026#34;)); existsObject.put(\u0026#34;B1\u0026#34;,b1); return b1; } return null; } public static void main(String[] args) { A1 a1 = (A1)loadObject(\u0026#34;A1\u0026#34;); a1.getB1().sayHello(); B1 b1 = (B1) loadObject(\u0026#34;B1\u0026#34;); b1.getA1().sayHello(); } } class A1 { private B1 b1; public B1 getB1() { return b1; } public void setB1(B1 b1) { this.b1 = b1; } public void sayHello(){ System.out.println(\u0026#34;æˆ‘æ˜¯ A1 , ä½ å¥½\u0026#34;); } } class B1 { private A1 a1; public A1 getA1() { return a1; } public void setA1(A1 a1) { this.a1 = a1; } public void sayHello(){ System.out.println(\u0026#34;æˆ‘æ˜¯ B1 , ä½ å¥½\u0026#34;); } } é€šè¿‡æ·»åŠ äºŒçº§ç¼“å­˜ï¼ŒæŠŠç©ºç™½å¯¹è±¡å’Œå®Œæ•´å¯¹è±¡å‰¥ç¦»äº†ã€‚å½“ä»ä¸€çº§ç¼“å­˜ä¸­å–å®ä¾‹æ—¶ï¼Œè¦ä¹ˆæ‹¿åˆ°çš„æ˜¯å®Œæ•´å¯¹è±¡ï¼Œè¦ä¹ˆæ‹¿åˆ°çš„æ˜¯ null, è€Œä¸ä¼šè·å–åˆ°ç©ºç™½çš„å¯¹è±¡ï¼Œå¼•å‘é”™è¯¯ã€‚\nä½†æ˜¯ä¸Šé¢çš„ä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œå½“å®ä¾‹æœªåˆå§‹åŒ–å®Œï¼Œå¹¶ä¸”åœ¨åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹,ä»ç„¶ä¼šå–åˆ°ä¸å®Œæ•´å¯¹è±¡ï¼Œå¦‚ä¸‹:\né‚£ä¹ˆå•å•åªåŠ äºŒçº§ç¼“å­˜å¹¶ä¸èƒ½è§£å†³è¿™ä¸ªå¹¶å‘é—®é¢˜ï¼ŒåŒæ—¶è¿˜è¦åŠ é”ï¼š\npublic static Object loadObject (String objectName) { // å…ˆä»ä¸€çº§ç¼“å­˜å–,å› ä¸ºå¯ä»¥ç¡®ä¿ä¸€çº§ç¼“å­˜ä¸­åªæœ‰å®Œæ•´çš„å¯¹è±¡ if(existsObject.containsKey(objectName)) { return existsObject.get(objectName); } synchronized (existsObject) { // ç¬¬äºŒæ¬¡åˆ¤æ–­ä¸€çº§ç¼“å­˜æ˜¯å¦æœ‰,å› ä¸ºæœ‰å¯èƒ½åœ¨ç­‰å¾…é”çš„æ—¶å€™ï¼Œå·²ç»æœ‰å…¶ä»–çº¿ç¨‹æŠŠå®ä¾‹æ”¾å…¥ä¸€çº§ç¼“å­˜ä¸­ if(existsObject.containsKey(objectName)) { return existsObject.get(objectName); } // å†ä»äºŒçº§ç¼“å­˜å– if(blankObject.containsKey(objectName)) { return blankObject.get(objectName); } if(\u0026#34;A1\u0026#34;.equals(objectName)) { A1 a1 = new A1(); // å…ˆå°†ç©ºç™½çš„å®ä¾‹æ”¾å…¥äºŒçº§ç¼“å­˜ blankObject.put(\u0026#34;A1\u0026#34;,a1); // ç„¶åå°†å¯¹è¯¥ç©ºç™½å®ä¾‹è¿›è¡Œå±æ€§èµ‹å€¼ a1.setB1((B1)loadObject(\u0026#34;B1\u0026#34;)); // å†æ”¾å…¥ä¸€çº§ç¼“å­˜ existsObject.put(\u0026#34;A1\u0026#34;,a1); // ç„¶åç§»é™¤äºŒçº§ç¼“å­˜ä¸­çš„ A1 blankObject.remove(\u0026#34;A1\u0026#34;); return a1; } if (\u0026#34;B1\u0026#34;.equals(objectName)) { B1 b1 = new B1(); blankObject.put(\u0026#34;B1\u0026#34;,b1); b1.setA1((A1)loadObject(\u0026#34;A1\u0026#34;)); existsObject.put(\u0026#34;B1\u0026#34;,b1); blankObject.remove(\u0026#34;B1\u0026#34;); return b1; } } return null; } åˆ°æ­¤æˆ‘ä»¬æ‰å®Œæ•´çš„è§£å†³äº†å¾ªç¯ä¾èµ–ï¼Œå¹¶ä¸”ä¿è¯ä¸ä¼šå–åˆ°ä¸å®Œæ•´çš„å®ä¾‹.\nå…¶å® spring ä¹Ÿæ˜¯è¿™æ ·æ¥è§£å†³beanå¾ªç¯ä¾èµ–çš„ï¼Œä¸è¿‡ spring è¿˜æ·»åŠ åŠ¨æ€ä»£ç†beançš„åŠŸèƒ½ï¼Œä¸ºäº†è§£è€¦ï¼Œè¿˜æ·»åŠ äº†ä¸‰çº§ç¼“å­˜ï¼Œä¿è¯ä»£ç æ•´æ´ï¼Œä¼˜é›…ã€‚\nspring æ˜¯å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–çš„ ç”±äº spring åœ¨å¤„ç†å¾ªç¯ä¾èµ–æ—¶è€ƒè™‘å¾ˆå¤šå…¶ä»–åŠŸèƒ½ï¼Œä»£ç éå¸¸å¤æ‚ï¼Œä¸ºäº†ä¾¿äºå±•ç¤ºï¼Œè¿™é‡Œåªæ¨¡ä»¿æ ¸å¿ƒåŠŸèƒ½ï¼š\nè¯¦ç»†è¯´æ˜å·²åœ¨æ³¨é‡Šä¸­\n// ä¸»ç±» public class MainStart { // æœ¬åº”è¯¥ä½¿ç”¨ ConcurrentHashMap ç±»å‹ï¼Œä½†æ˜¯ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œç¡®ä¿å…ˆå®ä¾‹åŒ–Aï¼Œä½¿ç”¨äº†æœ‰åºHashMap private static Map\u0026lt;String, BeanDefinition\u0026gt; beanDefinitionMap = new LinkedHashMap\u0026lt;\u0026gt;(256); /** * è¯»å–beanå®šä¹‰ï¼Œå½“ç„¶åœ¨springä¸­è‚¯å®šæ˜¯æ ¹æ®é…ç½® åŠ¨æ€æ‰«ææ³¨å†Œ */ public static void loadBeanDefinitions() { RootBeanDefinition aBeanDefinition=new RootBeanDefinition(InstanceA.class); RootBeanDefinition bBeanDefinition=new RootBeanDefinition(InstanceB.class); beanDefinitionMap.put(\u0026#34;instanceA\u0026#34;,aBeanDefinition); beanDefinitionMap.put(\u0026#34;instanceB\u0026#34;,bBeanDefinition); } public static void main(String[] args) throws Exception { // åŠ è½½äº†BeanDefinition loadBeanDefinitions(); // å¾ªç¯åˆ›å»ºBean for (String key : beanDefinitionMap.keySet()){ // å…ˆåˆ›å»ºA getBean(key); } IApi instanceA = (IApi) getBean(\u0026#34;instanceA\u0026#34;); instanceA.say(); } // ä¸€çº§ç¼“å­˜ public static Map\u0026lt;String,Object\u0026gt; singletonObjects=new ConcurrentHashMap\u0026lt;\u0026gt;(); // äºŒçº§ç¼“å­˜ï¼š ä¸ºäº†å°† æˆç†ŸBeanå’Œçº¯å‡€Beanåˆ†ç¦»ï¼Œé¿å…è¯»å–åˆ°ä¸å®Œæ•´å¾—Bean public static Map\u0026lt;String,Object\u0026gt; earlySingletonObjects=new ConcurrentHashMap\u0026lt;\u0026gt;(); // ä¸‰çº§ç¼“å­˜ public static Map\u0026lt;String,ObjectFactory\u0026gt; singletonFactories=new ConcurrentHashMap\u0026lt;\u0026gt;(); // å¾ªç¯ä¾èµ–æ ‡è¯† public static Set\u0026lt;String\u0026gt; singletonsCurrennlyInCreation=new HashSet\u0026lt;\u0026gt;(); // å‡è®¾A ä½¿ç”¨äº†Aop @PointCut(\u0026#34;execution(* *..InstanceA.*(..))\u0026#34;) è¦ç»™Aåˆ›å»ºåŠ¨æ€ä»£ç† // è·å–Bean public static Object getBean(String beanName) throws Exception { Object singleton = getSingleton(beanName); if(singleton!=null){ return singleton; } Object instanceBean = null; synchronized (singletonObjects) { // ç¬¬äºŒæ¬¡åˆ¤æ–­ if(singletonObjects.containsKey(beanName)) { return singletonObjects.get(beanName); } // æ ‡è®°æ­£åœ¨åˆ›å»º,è€Œä¸æ˜¯ç”¨äºŒçº§ç¼“å­˜æ˜¯å¦åŒ…å« beanName æ¥åˆ¤æ–­ if(!singletonsCurrennlyInCreation.contains(beanName)){ singletonsCurrennlyInCreation.add(beanName); } // å®ä¾‹åŒ– RootBeanDefinition beanDefinition = (RootBeanDefinition) beanDefinitionMap.get(beanName); // è·å– class å¯¹è±¡ Class\u0026lt;?\u0026gt; beanClass = beanDefinition.getBeanClass(); // é€šè¿‡æ— å‚æ„é€ å‡½æ•°,æ„é€ ä¸€ä¸ªç©ºç™½å¯¹è±¡ instanceBean = beanClass.newInstance(); // åˆ›å»ºåŠ¨æ€ä»£ç† // åªåœ¨å¾ªç¯ä¾èµ–çš„æƒ…å†µä¸‹åœ¨å®ä¾‹åŒ–ååˆ›å»ºproxy åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯å¾ªç¯ä¾èµ– Object finalInstanceBean = instanceBean; // è¿™æ˜¯ä¸€ä¸ªä¸‰çº§ç¼“å­˜ï¼Œä¸‰çº§ç¼“å­˜æ”¾çš„ä¸æ˜¯ bean, è€Œæ˜¯ä¸€ä¸ªå¯ä»¥åˆ›å»ºåŠ¨æ€ä»£ç†beançš„å‡½æ•°ã€‚ï¼ˆlambda è¡¨è¾¾å¼ã€‚å…³é”®è¯ï¼š å‡½æ•°æ¥å£ï¼‰ // ä¸ºä»€ä¹ˆä¸ç›´æ¥åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡æ”¾å…¥äºŒçº§ç¼“å­˜ä¸­ï¼Œè€Œæ˜¯å…ˆæŠŠ lambda è¡¨è¾¾å¼æ”¾å…¥ä¸‰çº§ç¼“å­˜ï¼Œ // è€Œåé¢å†è°ƒç”¨è¿™ä¸ªè¡¨è¾¾å¼å»ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œç„¶åæ”¾å…¥äºŒçº§ç¼“å­˜ï¼ˆgetSingleton æ–¹æ³•ï¼‰ // æˆ‘è®¤ä¸ºæ˜¯æ˜¯ä¸ºäº†é€»è¾‘ä¸Šçš„ç»Ÿä¸€ï¼ŒgetSingletonæ–¹æ³•è´Ÿè´£åˆ›å»ºæˆ–è¿”å›å¯¹è±¡ï¼Œè€Œä¸æ˜¯åœ¨è¿™é‡Œã€‚ singletonFactories.put(beanName, () -\u0026gt; new JdkProxyBeanPostProcessor().getEarlyBeanReference(finalInstanceBean,beanName)); // å±æ€§èµ‹å€¼ Field[] declaredFields = beanClass.getDeclaredFields(); for (Field declaredField : declaredFields) { Autowired annotation = declaredField.getAnnotation(Autowired.class); // è¯´æ˜å±æ€§ä¸Šé¢æœ‰Autowired if(annotation!=null){ declaredField.setAccessible(true); String name = declaredField.getName(); Object fileObject= getBean(name); declaredField.set(instanceBean,fileObject); } } // ç”±äºé€’å½’å®ŒåA è¿˜æ˜¯åŸå®ä¾‹ï¼Œï¼Œ æ‰€ä»¥è¦ä»äºŒçº§ç¼“å­˜ä¸­æ‹¿åˆ°proxy ã€‚ if(earlySingletonObjects.containsKey(beanName)){ instanceBean=earlySingletonObjects.get(beanName); } // æ·»åŠ åˆ°ä¸€çº§ç¼“å­˜ A singletonObjects.put(beanName,instanceBean); // remove äºŒçº§ç¼“å­˜å’Œä¸‰çº§ç¼“å­˜ earlySingletonObjects.remove(beanName); singletonFactories.remove(beanName); } return instanceBean; } public static Object getSingleton(String beanName){ // å…ˆä»ä¸€çº§ç¼“å­˜ä¸­æ‹¿ Object bean = singletonObjects.get(beanName); synchronized (singletonObjects) { // è¯´æ˜æ˜¯å¾ªç¯ä¾èµ– if(bean==null \u0026amp;\u0026amp; singletonsCurrennlyInCreation.contains(beanName)){ bean=earlySingletonObjects.get(beanName); // å¦‚æœäºŒçº§ç¼“å­˜æ²¡æœ‰å°±ä»ä¸‰çº§ç¼“å­˜ä¸­æ‹¿ if(bean==null) { // ä»ä¸‰çº§ç¼“å­˜ä¸­æ‹¿ ObjectFactory factory = singletonFactories.get(beanName); if (factory != null) { // æ‹¿åˆ°åŠ¨æ€ä»£ç† // ä¸ºä»€ä¹ˆéœ€è¦åŠ¨æ€ä»£ç†å¯¹è±¡ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬è‡ªå·±åŸæ¥çš„bean. // å› ä¸ºåŸå§‹beançš„ä»£ç†å¯¹è±¡æ‰©å±•äº†åŠŸèƒ½ï¼ŒåŒæ—¶è¿˜å’ŒåŸå§‹ bean æœ‰ç›¸åŒçš„ç±»å‹ã€‚å› ä¸ºå®ƒä»¬ç»§æ‰¿äº†åŒä¸€ä¸ªæ¥å£ // æˆ–è€… ä»£ç†å¯¹è±¡ç»§æ‰¿äº†åŸå§‹bean. (è¯¦æƒ…å¯ä»¥æœç´¢ JDKåŠ¨æ€ä»£ç†,cglib ä»£ç†) bean=factory.getObject(); // å°†ä»£ç†å¯¹è±¡æ”¾å…¥äºŒçº§ç¼“å­˜ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡ä»ç„¶æ˜¯ç©ºç™½å¯¹è±¡ // æ‰€ä»¥è¿™ä¸ªæ–¹æ³•å¦‚æœä¸åŠ é”ä»ç„¶å¯èƒ½ä¼šè¿”å›ä¸€ä¸ªç©ºç™½å¯¹è±¡ earlySingletonObjects.put(beanName, bean); } } } } return bean; } } // InstanceA æ¥å£ï¼Œ ä¸ºäº†åŠ¨æ€ä»£ç†ä½¿ç”¨ public interface IApi { void say(); } // InstanceA @Component public class InstanceA implements IApi { @Autowired private InstanceB instanceB; public InstanceB getInstanceB() { return instanceB; } public void setInstanceB(InstanceB instanceB) { this.instanceB = instanceB; } public InstanceA(InstanceB instanceB) { this.instanceB = instanceB; } public InstanceA() { System.out.println(\u0026#34;InstanceAå®ä¾‹åŒ–\u0026#34;); } @Override public void say() { System.out.println(\u0026#34;I\u0026#39;m A\u0026#34;); } } // InstanceB @Component public class InstanceB { @Autowired private InstanceA instanceA; public InstanceA getInstanceA() { return instanceA; } public void setInstanceA(InstanceA instanceA) { this.instanceA = instanceA; } public InstanceB(InstanceA instanceA) { this.instanceA = instanceA; } public InstanceB() { System.out.println(\u0026#34;InstanceBå®ä¾‹åŒ–\u0026#34;); } } // JDK åŠ¨æ€ä»£ç†ä½¿ç”¨ public class JdkDynimcProxy implements InvocationHandler { private Object target; public JdkDynimcProxy(Object target) { this.target = target; } public \u0026lt;T\u0026gt; T getProxy() { return (T) Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), this); } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { System.out.println(\u0026#34;æµ‹è¯•\u0026#34;); return method.invoke(target,args); } } // @Component public class JdkProxyBeanPostProcessor implements SmartInstantiationAwareBeanPostProcessor { public Object getEarlyBeanReference(Object bean, String beanName) throws BeansException { // å‡è®¾:A è¢«åˆ‡ç‚¹å‘½ä¸­ éœ€è¦åˆ›å»ºä»£ç† @PointCut(\u0026#34;execution(* *..InstanceA.*(..))\u0026#34;) if(bean instanceof InstanceA) { JdkDynimcProxy jdkDynimcProxy = new JdkDynimcProxy(bean); return jdkDynimcProxy.getProxy(); } return bean; } } ä¸ºä»€ä¹ˆéœ€è¦ä¸‰çº§ç¼“å­˜ï¼Œè€Œä¸æ˜¯ä¸¤çº§ç¼“å­˜ æˆ‘è®¤ä¸ºä¸¤çº§ç¼“å­˜å®Œå…¨å¯ä»¥è§£å†³å¾ªç¯ä¾èµ–ï¼Œå®Œå…¨å¯ä»¥å…ˆåˆ›å»º beançš„åŠ¨æ€ä»£ç†æ”¾å…¥äºŒçº§ç¼“å­˜ä¸­ï¼Œè€Œä¸æ˜¯åœ¨ getSingleton æ–¹æ³•ä¸­å»¶è¿Ÿè°ƒç”¨ä¸‰çº§ç¼“å­˜ä¸­çš„ lambda è¡¨è¾¾å¼å†å»ç”ŸæˆåŠ¨æ€ä»£ç†ã€‚\næˆ‘è®¤ä¸ºä¸‰çº§ç¼“å­˜ä½œç”¨ä¹‹ä¸€æ˜¯ä¸ºäº†ä»£ç è§£è€¦ï¼Œé€»è¾‘ç»Ÿä¸€ã€‚\nspring å¦‚ä½•é¿å…æ‹¿åˆ°ä¸å®Œæ•´çš„bean spring å®¹å™¨åŠ è½½å®Œæˆåï¼Œå› ä¸ºè§£å†³äº†å¾ªç¯ä¾èµ–ä¸ä¼šå­˜åœ¨ä¸å®Œæ•´çš„beanï¼Œ åœ¨ spring å®¹å™¨åŠ è½½è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡åŠ é”çš„æ–¹å¼å¯ä»¥é¿å…å–åˆ°ä¸å®Œæ•´çš„bean spring æ²¡æœ‰è§£å†³çš„å¾ªç¯ä¾èµ– æ²¡æœ‰è§£å†³æ„é€ å‡½æ•°çš„å¾ªç¯ä¾èµ–\næ‰€ä»¥ä¸å»ºè®®æ„é€ å‡½æ•°æ³¨å…¥æ–¹å¼ æ²¡æœ‰è§£å†³å¤šä¾‹ä¸‹çš„å¾ªç¯ä¾èµ–\nå¥½åƒä¹Ÿæ— æ³•è§£å†³ï¼Œæ²¡æœ‰å¿…è¦ ","date":"2022-11-19T18:14:12Z","permalink":"https://dccmmtop.github.io/posts/spring%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96/","section":"posts","tags":["java","spring"],"title":"spring å¦‚ä½•è§£å†³å¾ªç¯ä¾èµ–"},{"categories":null,"contents":"è·å–ç³»ç»Ÿä¸­æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ã€‚å’Œå¹³å°æ— å…³\nimport ( ps \u0026#34;github.com/mitchellh/go-ps\u0026#34; ) func running() bool { processList, err := ps.Processes() if err != nil { fmt.Printf(\u0026#34;err %v\\n\u0026#34;,err); return false } var process ps.Process num := 0 for x := range processList { process = processList[x] if process.Executable() == \u0026#34;test.exe\u0026#34; { num ++ if num \u0026gt;= 2 { fmt.Println(\u0026#34;on running\u0026#34;) return true } } } return false } ","date":"2022-11-09T13:10:41Z","permalink":"https://dccmmtop.github.io/posts/%E8%8E%B7%E5%8F%96%E6%AD%A3%E5%9C%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E8%BF%9B%E7%A8%8B/","section":"posts","tags":["go"],"title":"è·å–æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹"},{"categories":null,"contents":"æœ¬æ–‡ä»æºç å±‚é¢ç®€è¦ä»‹ç»ä¸€ä¸‹ Spring IoC åŠ è½½è¿‡ç¨‹ï¼Œä»¥åŠè¿™ä¸ªè¿‡ç¨‹é‡åˆ°çš„é‡ç‚¹æ–¹æ³•ï¼Œé‡ç‚¹ç±»ã€‚\nnew AnnotationConfigApplicationContext() ä¸€åˆ‡çš„æ ¹æºéƒ½è¦ä» new AnnotationConfigApplicationContext() æ–¹æ³•å¼€å§‹ï¼Œè¿™æ˜¯ Spring å¯åŠ¨çš„å…¥å£ï¼Œå…ˆå‡†å¤‡å¦‚ä¸‹ä»£ç ï¼š\npublic class ContextDemo { public static void main(String[] args) { AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(Config.class); context.getBean(\u0026#34;car\u0026#34;,Car.class); } } @Configuration @ComponentScan(basePackageClasses = {Car.class}) class Config{ @Bean public User1 user(){ return new User1(10, \u0026#34;dc1\u0026#34;); } } @Component class Car { private int color; private String name; } class User1 { private int age; private String name; } è¿›å…¥ new AnnotationConfigApplicationContext(Config.class); æ–¹æ³•å¯è§å¦‚ä¸‹ï¼š\npublic AnnotationConfigApplicationContext(Class\u0026lt;?\u0026gt;... annotatedClasses) { this(); register(annotatedClasses); refresh(); } å†è¿›å…¥ this() æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š\npublic AnnotationConfigApplicationContext() { this.reader = new AnnotatedBeanDefinitionReader(this); this.scanner = new ClassPathBeanDefinitionScanner(this); } å‘ç°è°ƒç”¨çš„ AnnotationConfigApplicationContext æ— å‚æ„é€ å™¨ï¼Œ å†è°ƒç”¨ä¸€ä¸ªç±»çš„æ— å‚æ„é€ å™¨æ—¶ï¼Œä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„æ— å‚æ„é€ å™¨ï¼Œ åŒæ—¶å‘ç°è¿™ä¸ªç±»çš„çˆ¶ç±»æ„é€ å™¨å¦‚ä¸‹ï¼š\npublic GenericApplicationContext() { this.beanFactory = new DefaultListableBeanFactory(); } æ–¹æ³•å¾ˆç®€å•ï¼Œåªæ˜¯ new äº†ä¸€ä¸ª beanFactory, ä»åç§°æ¥çœ‹ï¼Œè¿™ä¸ªå±æ€§æ˜¯ bean å·¥å‚ã€‚ç°åœ¨åªçŸ¥é“ AnnotationConfigApplicationContext ä¸­æœ‰ä¸€ä¸ª beanFactory çš„å­—æ®µï¼Œè¿™ä¸ªå­—æ®µæ˜¯ä»çˆ¶ç±»ç»§æ‰¿æ¥çš„ã€‚\nçˆ¶ç±»çš„æ„é€ æ–¹æ³•å·²ç»ç»“æŸï¼Œæ¥ç€å¾€ä¸‹çœ‹ï¼Œ this.reader = new AnnotatedBeanDefinitionReader(this);, this.scanner = new ClassPathBeanDefinitionScanner(this); ã€‚åˆå§‹åŒ– reader å’Œ scanner.\næ‰¾åˆ° reader å±æ€§ï¼Œä¼šå‘ç°å®ƒæ˜¯ AnnotatedBeanDefinitionReader ç±»å‹ã€‚çœ‹ä¸€ä¸‹è¿™ä¸ªç±»å‹çš„æ³¨é‡Šè¯´æ˜ï¼š /** * Convenient adapter for programmatic registration of annotated bean classes. * This is an alternative to {@link ClassPathBeanDefinitionScanner}, applying * the same resolution of annotations but for explicitly registered classes only. * * @author Juergen Hoeller * @author Chris Beams * @author Sam Brannen * @author Phillip Webb * @since 3.0 * @see AnnotationConfigApplicationContext#register */ public class AnnotatedBeanDefinitionReader {....} ç¿»è¯‘ä¸€ä¸‹ï¼š\nç®€ä¾¿çš„é€‚é…å™¨ï¼Œç”¨äºæ³¨è§£ bean ç±»çš„æ³¨å†Œã€‚è¿™æ˜¯ ClassPathBeanDefinitionScanner çš„æ›¿ä»£æ–¹æ¡ˆï¼Œåº”ç”¨ç›¸åŒçš„æ³¨è§£ï¼Œä½†ä»…é€‚ç”¨äºæ˜¾å¼æ³¨å†Œçš„ç±»ã€‚\næ„æ€å°±æ˜¯å¯ä»¥æ›¿ä»£ ClassPathBeanDefinitionScanner ä½¿ç”¨ï¼Œä½†æ˜¯å®ƒåªèƒ½ç”¨äºæˆ‘ä»¬æ‰‹åŠ¨æ³¨å†Œçš„ç±»ã€‚\næ‰¾åˆ°scanner å±æ€§ï¼Œå‘ç°å®ƒæ­£æ˜¯ ClassPathBeanDefinitionScanner ç±»å‹ã€‚å†çœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„æ³¨é‡Šè¯´æ˜ï¼š /** * A bean definition scanner that detects bean candidates on the classpath, * registering corresponding bean definitions with a given registry ({@code BeanFactory} * or {@code ApplicationContext}). * * \u0026lt;p\u0026gt;Candidate classes are detected through configurable type filters. The * default filters include classes that are annotated with Spring\u0026#39;s * {@link org.springframework.stereotype.Component @Component}, * {@link org.springframework.stereotype.Repository @Repository}, * {@link org.springframework.stereotype.Service @Service}, or * {@link org.springframework.stereotype.Controller @Controller} stereotype. * * \u0026lt;p\u0026gt;Also supports Java EE 6\u0026#39;s {@link javax.annotation.ManagedBean} and * JSR-330\u0026#39;s {@link javax.inject.Named} annotations, if available. * * @author Mark Fisher * @author Juergen Hoeller * @author Chris Beams * @since 2.5 * @see AnnotationConfigApplicationContext#scan * @see org.springframework.stereotype.Component * @see org.springframework.stereotype.Repository * @see org.springframework.stereotype.Service * @see org.springframework.stereotype.Controller */ public class ClassPathBeanDefinitionScanner extends ClassPathScanningCandidateComponentProvider {...} ç¿»è¯‘ä¸€ä¸‹ï¼š\nä¸€ä¸ª bean å®šä¹‰æ‰«æå™¨ï¼Œç”¨äºæ£€æµ‹ç±»è·¯å¾„ä¸Šçš„ bean çš„å€™é€‰è€…ï¼Œå°†ç›¸åº”çš„ bean å®šä¹‰æ³¨å†Œåˆ°ç»™å®šçš„æ³¨å†Œè¡¨ï¼ˆ BeanFactory æˆ– ApplicationContext ï¼‰ã€‚\né€šè¿‡å¯é…ç½®çš„ç±»å‹è¿‡æ»¤å™¨æ£€æµ‹å€™é€‰ç±»ã€‚é»˜è®¤è¿‡æ»¤å™¨åŒ…æ‹¬ä½¿ç”¨ Spring çš„@Component ã€ @Repository ã€ @Service æˆ–@Controller åŸå‹æ³¨é‡Šçš„ç±»ã€‚\nå¦‚æœå¯ç”¨ï¼Œè¿˜æ”¯æŒ Java EE 6 çš„ javax.annotation.ManagedBean å’Œ JSR-330 çš„ javax.inject.Named æ³¨é‡Šã€‚\nå®ƒçš„æ„æ€è¯´ï¼ŒæŠŠç±»è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»è¿›è¡Œæ‰«æã€‚æŠŠç±»ä¸­é…ç½®çš„ bean æ”¾åˆ°æ³¨å†Œè¡¨ï¼Œ æ³¨å†Œè¡¨å¯èƒ½æ˜¯ BeanFactory æˆ–è€… ApplicationContext\nåˆ°è¿™é‡Œå¯ä»¥çŸ¥é“ï¼Œ AnnotationConfigApplicationContext é™¤äº†ç»§æ‰¿çˆ¶ç±»çš„å±æ€§å¤–ï¼Œè¿˜åˆå§‹åŒ–äº† 1. bean å®šä¹‰è¯»å–å™¨ (reader) 2. bean å®šä¹‰æ‰«æå™¨ (scanner)\nä¸‹é¢çœ‹ä¸€ä¸‹å¦‚ä½•åˆå§‹åŒ–çš„ï¼š\nåˆå§‹åŒ– AnnotatedBeanDefinitionReader ä¸€å±‚å±‚è¿›å…¥ new AnnotatedBeanDefinitionReader(this), æœ€ç»ˆæ‰¾åˆ°æ–¹æ³•ï¼š\n/** * Register all relevant annotation post processors in the given registry. * @param registry the registry to operate on * @param source the configuration source element (already extracted) * that this registration was triggered from. May be {@code null}. * @return a Set of BeanDefinitionHolders, containing all bean definitions * that have actually been registered by this call */ public static Set\u0026lt;BeanDefinitionHolder\u0026gt; registerAnnotationConfigProcessors( BeanDefinitionRegistry registry, @Nullable Object source) { DefaultListableBeanFactory beanFactory = unwrapDefaultListableBeanFactory(registry); if (beanFactory != null) { if (!(beanFactory.getDependencyComparator() instanceof AnnotationAwareOrderComparator)) { beanFactory.setDependencyComparator(AnnotationAwareOrderComparator.INSTANCE); } if (!(beanFactory.getAutowireCandidateResolver() instanceof ContextAnnotationAutowireCandidateResolver)) { beanFactory.setAutowireCandidateResolver(new ContextAnnotationAutowireCandidateResolver()); } } Set\u0026lt;BeanDefinitionHolder\u0026gt; beanDefs = new LinkedHashSet\u0026lt;\u0026gt;(8); if (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) { RootBeanDefinition def = new RootBeanDefinition(ConfigurationClassPostProcessor.class); def.setSource(source); beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)); } if (!registry.containsBeanDefinition(AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)) { RootBeanDefinition def = new RootBeanDefinition(AutowiredAnnotationBeanPostProcessor.class); def.setSource(source); beanDefs.add(registerPostProcessor(registry, def, AUTOWIRED_ANNOTATION_PROCESSOR_BEAN_NAME)); } // .... çœç•¥å¾ˆå¤šä»£ç  return beanDefs; } å…ˆç¿»è¯‘ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„æ³¨é‡Šï¼Œä»¥åŠå‚æ•°å’Œè¿”å›å€¼ï¼š\næ³¨é‡Šï¼š\nåœ¨ç»™å®šçš„æ³¨å†Œè¡¨ä¸­æ³¨å†Œæ‰€æœ‰ç›¸å…³çš„æ³¨è§£åå¤„ç†å™¨\nå‚æ•°ï¼š\nç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ï¼š register, è¿™ä¸ªæ˜¯ä»æœ€å¼€å§‹ä¼ å…¥çš„ AnnotationConfigApplicationContext å¯¹è±¡ ç¬¬äºŒä¸ªå‚æ•°æ˜¯ï¼šObject source è¿™ä¸ªä¼ å…¥çš„ null, æš‚ä¸å…³å¿ƒå®ƒ è¿”å›å€¼ï¼š\nè¿”å›çš„æ˜¯ Set\u0026lt;BeanDefinitionHolder\u0026gt; é›†åˆï¼Œåˆ°è¿™é‡Œå…ˆæš‚åœä¸€ä¸‹ï¼Œéœ€è¦çœ‹ BeanDefinitionHolder æ˜¯ä»€ä¹ˆï¼Œå®ƒé‡Œé¢éƒ½æ˜¯ä»€ä¹ˆå±æ€§ï¼Œä»¥åŠå¹²å˜›ç”¨çš„ï¼š\nBeanDefinition è¿›å…¥è¿™ä¸ªç±»ï¼ŒæŸ¥çœ‹å®ƒçš„æ³¨é‡Šå’Œå†…éƒ¨ç»“æ„ï¼š\né€šè¿‡æ³¨é‡Šå¯ä»¥çŸ¥é“å®ƒæ˜¯ å…·æœ‰åç§°å’Œåˆ«åçš„ BeanDefinition çš„æŒæœ‰è€…\nç”±æ­¤å¯çŸ¥é“å…³é”®ä¿¡æ¯ä¸åœ¨å®ƒï¼Œè€Œæ˜¯ BeanDefinition, BeanDefinitionHolder åªæ˜¯ BeanDefinition çš„æŒæœ‰è€…ï¼Œåªæ¯” BeanDefinition å¤šäº† beanName ä»¥åŠåˆ«åå±æ€§ã€‚ä¸ºçš„æ˜¯å¯ä»¥æœ‰ä¸€ä¸ªå…·ä½“çš„åç§°æ¥æè¿° BeanDefinition. æ‰€ä»¥è¦æ¥ç€çœ‹ BeanDefinitionï¼š\nå…ˆçœ‹ç¿»è¯‘ä¸‹ BeanDefinition çš„æ³¨é‡Šï¼š\nBeanDefinition æè¿°äº†ä¸€ä¸ª bean å®ä¾‹ï¼Œå®ƒå…·æœ‰å±æ€§å€¼ã€æ„é€ å‡½æ•°å‚æ•°å€¼ä»¥åŠå…·ä½“å®ç°æä¾›çš„æ›´å¤šä¿¡æ¯ã€‚ è¿™åªæ˜¯ä¸€ä¸ªæœ€å°æ¥å£ï¼šä¸»è¦ç›®çš„æ˜¯å…è®¸åƒ PropertyPlaceholderConfigurer è¿™æ ·çš„ BeanFactoryPostProcessor å†…çœå’Œä¿®æ”¹å±æ€§å€¼å’Œå…¶ä»– bean å…ƒæ•°æ®ã€‚\nå®ƒè¯´ BeanDefinition æè¿°äº† bean çš„å®ä¾‹ã€‚ä¹Ÿå°±æ˜¯å»ºç­‘å›¾çº¸å’Œå»ºç­‘ç‰©çš„å…³ç³»ï¼ŒBeanDefinition ä¼šå­˜æœ‰ æŸä¸ª bean çš„å­—æ®µï¼Œæ„é€ æ–¹æ³•ç­‰ç­‰ã€‚å¯ä»¥æ ¹æ® BeanDefinition æ„é€ å‡ºåº”çš„ beanã€‚å°±å¦‚åŒå¯ä»¥é€šè¿‡å»ºç­‘å›¾çº¸è¿˜åŸå‡ºå»ºç­‘ç‰©ä¸€æ ·ã€‚\nè¿™é‡Œå°±éå¸¸å·§å¦™äº†ï¼Œä¸€ä¸ªç³»ç»Ÿä¸­çš„æœ‰å„å¼å„æ ·çš„ beanï¼ŒåŠŸèƒ½ä¸åŒï¼Œç±»å‹ä¸åŒã€‚ç”¨ä¸€ä¸ªç›¸åŒçš„ä¸œè¥¿å»æè¿°ï¼Œæ“ä½œè¿™äº› beanï¼Œæ˜¯ä¸€ä¸ªéå¸¸æœ‰åˆ©çš„è½¬æ¢ã€‚å› ä¸ºå®ƒä»¬éƒ½æ˜¯å¯¹è±¡ï¼Œæ˜¯å¯¹è±¡å°±ä¼šæœ‰æ–¹æ³•ï¼Œå­—æ®µï¼Œç±»å‹ã€‚æŠŠè¿™äº›æ–¹æ³•ï¼Œå­—æ®µï¼Œç±»å‹å†æŠ½è±¡ï¼Œèšåˆå°±å½¢æˆäº† BeanDefinition.\nçœ‹ä¸€ä¸‹ BeanDefinition å†…éƒ¨ç»“æ„ï¼š\nå†…å®¹å¾ˆå¤šï¼Œéƒ½æ˜¯è®¾ç½®ï¼Œè·å– æŸä¸ªå¯¹è±¡ç±»å‹ä¿¡æ¯çš„ï¼ŒæŒ‘å‡ ä¸ªçœ‹ä¸€ä¸‹ï¼š\npublic interface BeanDefinition extends AttributeAccessor, BeanMetadataElement { // æ ‡å‡†å•ä¾‹èŒƒå›´çš„èŒƒå›´æ ‡è¯†ç¬¦ï¼šâ€œå•ä¾‹â€ã€‚ String SCOPE_SINGLETON = ConfigurableBeanFactory.SCOPE_SINGLETON; // æ ‡å‡†åŸå‹èŒƒå›´çš„èŒƒå›´æ ‡è¯†ç¬¦ï¼šâ€œåŸå‹â€ã€‚ String SCOPE_PROTOTYPE = ConfigurableBeanFactory.SCOPE_PROTOTYPE; // ... // æŒ‡å®šæ­¤ bean å®šä¹‰çš„ bean ç±»åã€‚ // ç±»åå¯ä»¥åœ¨ bean å·¥å‚åæœŸå¤„ç†æœŸé—´ä¿®æ”¹ï¼Œé€šå¸¸ç”¨å®ƒçš„è§£æå˜ä½“æ›¿æ¢åŸå§‹ç±»åã€‚ void setBeanClassName(@Nullable String beanClassName); // è¦†ç›–æ­¤ bean çš„ç›®æ ‡èŒƒå›´ï¼ŒæŒ‡å®šä¸€ä¸ªæ–°çš„èŒƒå›´åç§° void setScope(@Nullable String scope); //è®¾ç½®è¿™ä¸ª bean æ˜¯å¦åº”è¯¥è¢«å»¶è¿Ÿåˆå§‹åŒ–ã€‚ //å¦‚æœä¸º false ï¼Œåˆ™ bean å°†åœ¨å¯åŠ¨æ—¶ç”±æ‰§è¡Œå•ä¾‹é¢„åˆå§‹åŒ–çš„ bean å·¥å‚å®ä¾‹åŒ–ã€‚ void setLazyInit(boolean lazyInit); //è¿”å›æ­¤ bean æ˜¯å¦åº”è¯¥å»¶è¿Ÿåˆå§‹åŒ–ï¼Œå³åœ¨å¯åŠ¨æ—¶ä¸æ€¥åˆ‡åœ°å®ä¾‹åŒ–ã€‚ä»…é€‚ç”¨äºå•ä¾‹ beanã€‚ boolean isLazyInit(); // .... } å¥½äº†ï¼Œå¯¹ BeanDefinition çš„äº†è§£æš‚æ—¶åˆ°æ­¤ã€‚ä¸å†æ·±å…¥äº†ã€‚ç»§ç»­ä¸Šé¢çš„ registerAnnotationConfigProcessorsæ–¹æ³•ï¼š\nç¬¬ä¸€è¡Œï¼š DefaultListableBeanFactory beanFactory = unwrapDefaultListableBeanFactory(registry); è¿›å…¥æ–¹æ³•åï¼Œå‘ç°æ²¡æœ‰åšå¤ªå¤šçš„æ˜¯äº‹æƒ…ï¼Œå°±æ˜¯æŠŠæ³¨å†Œå™¨çš„ beanFactory åŒ…è£…ä¸€ä¸‹ï¼Œå†è¿”å›ã€‚è¿™é‡Œçš„ register å°±æ˜¯æœ€å¼€å§‹ main æ–¹æ³•ä¸­çš„ AnnotationConfigApplicationContext å¯¹è±¡ã€‚\næ¥ç€çœ‹ä¸‹é¢ï¼š\nif (beanFactory != null) { if (!(beanFactory.getDependencyComparator() instanceof AnnotationAwareOrderComparator)) { beanFactory.setDependencyComparator(AnnotationAwareOrderComparator.INSTANCE); } if (!(beanFactory.getAutowireCandidateResolver() instanceof ContextAnnotationAutowireCandidateResolver)) { beanFactory.setAutowireCandidateResolver(new ContextAnnotationAutowireCandidateResolver()); } } å¯¹ beanFactory æ·»åŠ  ä¾èµ–æ¯”è¾ƒå™¨ å’Œ Autowire å€™é€‰è§£æå™¨ æš‚æ—¶ä¸çŸ¥é“è®¾ä¹ˆä½œç”¨ï¼Œè·³è¿‡ã€‚ç»§ç»­ï¼š\nSet\u0026lt;BeanDefinitionHolder\u0026gt; beanDefs = new LinkedHashSet\u0026lt;\u0026gt;(8); if (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) { RootBeanDefinition def = new RootBeanDefinition(ConfigurationClassPostProcessor.class); def.setSource(source); beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)); } å…ˆæ„é€ äº†ä¸€ä¸ª BeanDefinitionHolder çš„é›†åˆï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªæ–¹æ³•è¦è¿”å›çš„é›†åˆï¼Œif è¯­å¥ä¸­ï¼Œ åˆ¤æ–­æ³¨å†Œå™¨æ˜¯å¦åŒ…å«æŸä¸ª BeanDefinition, è¿›å»çœ‹ä¸€ä¸‹æ€ä¹ˆåˆ¤æ–­çš„ï¼š\n// åœ¨ DefaultListableBeanFactory ç±»ä¸‹é¢ @Override public boolean containsBeanDefinition(String beanName) { Assert.notNull(beanName, \u0026#34;Bean name must not be null\u0026#34;); return this.beanDefinitionMap.containsKey(beanName); } æœ€ç»ˆä¼šè¿›å…¥ DefaultListableBeanFactory ç±»ä¸­çš„ containsBeanDefinition æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ–¹æ³•ä¸æ˜¯æ³¨å†Œå™¨æä¾›çš„ï¼Œè€Œæ˜¯å®ƒçš„ beanFactory å±æ€§æä¾›çš„ã€‚å¹¶ä¸”åœ¨ beanFactory ä¸­æœ‰ä¸€ä¸ª Map\u0026lt;String, BeanDefinition\u0026gt; beanDefinitionMapï¼›é€šè¿‡åå­—å°±å¯ä»¥çŸ¥é“ï¼Œå­˜æ”¾çš„æ˜¯ BeanDefinition, åˆ¤æ–­æ³¨å†Œå™¨æ˜¯å¦åŒ…å·²ç»åŒ…å«æŸä¸ª BeanDefinition, å°±æ˜¯çœ‹è¿™ä¸ª map æ˜¯å¦åŒ…å«ç›¸åº”çš„ key äº†ã€‚è¿™ä¸ªåŠŸèƒ½æ˜¯ç”±å®ƒæ‰€è¾–çš„ beanFactory å®ç°çš„ã€‚è¿™ä¹Ÿæ¯”è¾ƒç¬¦åˆå¸¸ç†ï¼š bean å·¥å‚å»ç®¡ç† bean å®šä¹‰ã€‚åˆ°è¿™é‡Œå°±å¯ä»¥çŒœæµ‹å‡ºæ³¨å†Œ bean æ—¶ï¼Œä¹Ÿæ˜¯æ”¾å…¥è¿™ä¸ª Map, å–å‡º bean æ—¶ï¼Œä¹Ÿæ˜¯ä»è¿™ä¸ª Map ä¸­è·å–ã€‚\nå†çœ‹ä¸€ä¸‹ä¼ å…¥çš„ key æ˜¯ä»€ä¹ˆï¼š\nCONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME æ˜¯å†™æ­»åœ¨æºç ä¸­çš„å¸¸é‡ï¼šorg.springframework.context.annotation.internalConfigurationAnnotationProcessor æŸä¸ªç±»çš„å…¨åç§°ã€‚ç»§ç»­å‘ä¸‹çœ‹\nRootBeanDefinition def = new RootBeanDefinition(ConfigurationClassPostProcessor.class); def.setSource(source); beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)); å°† ConfigurationClassPostProcessor.class ä½œä¸ºå‚æ•°ï¼Œæ„é€ äº†ä¸€ä¸ª RootBeanDefinition , æŸ¥çœ‹ç±»å…³ç³»ï¼Œå‘ç° RootBeanDefinition æ˜¯ BeanDefinition çš„ä¸€ä¸ªå®ç°ç±»ã€‚è¿™é‡Œåªéœ€æ˜ç™½æŠŠä¸€ä¸ª class è½¬æˆäº† BeanDefinition å°±è¡Œäº†ã€‚è‡³äºæ€ä¹ˆè½¬çš„ï¼Œå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹\ndef.setSource(source) åˆšåˆšè¯´è¿‡ source å‚æ•°æ˜¯ null, å…ˆè·³è¿‡ã€‚ä¸æ·±ç©¶å®ƒæ˜¯ä»€ä¹ˆæ„æ€ã€‚\nå†çœ‹ registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME) è¿™ä¸€è¡Œï¼Œæ–¹æ³•åæ˜¯ æ³¨å†Œåç½®å¤„ç†å™¨ï¼Œ æŠŠæ³¨å†Œå™¨ï¼ŒBeanDefinition, å’Œ ç±»å…¨åä½œä¸ºå‚æ•°ä¼ å…¥æ–¹æ³•ï¼Œå†ä¸€è·¯è·Ÿè¸ªä¸‹å»å‘ç°æœ€åè¿˜æ˜¯è¿›å…¥äº† DefaultListableBeanFactory ç±»ã€‚æ‰§è¡Œçš„æ˜¯ registerBeanDefinition æ–¹æ³•ï¼š\n@Override public void registerBeanDefinition(String beanName, BeanDefinition beanDefinition) throws BeanDefinitionStoreException { Assert.hasText(beanName, \u0026#34;Bean name must not be empty\u0026#34;); Assert.notNull(beanDefinition, \u0026#34;BeanDefinition must not be null\u0026#34;); // çœç•¥å¾ˆå¤šæ ¡éªŒæ€§ä»£ç  BeanDefinition existingDefinition = this.beanDefinitionMap.get(beanName); if (existingDefinition != null) { // çœç•¥å¾ˆå¤šæ ¡éªŒæ€§ä»£ç  this.beanDefinitionMap.put(beanName, beanDefinition); } else { // æ£€æŸ¥è¿™ä¸ªå·¥å‚çš„ bean åˆ›å»ºé˜¶æ®µæ˜¯å¦å·²ç»å¼€å§‹ï¼Œå³åœ¨æ­¤æœŸé—´æ˜¯å¦æœ‰ä»»ä½• bean è¢«æ ‡è®°ä¸ºå·²åˆ›å»ºã€‚ if (hasBeanCreationStarted()) { //... çœç•¥æš‚ä¸ä¼šæ‰§è¡Œçš„ä»£ç  } else { // Still in startup registration phase: ä»å¤„äºå¯åŠ¨æ³¨å†Œé˜¶æ®µ // beanName ä½œä¸º key, beanDefinition æ˜¯ value, è¿™äº›éƒ½æ˜¯å‚æ•°ä¼ å…¥çš„ this.beanDefinitionMap.put(beanName, beanDefinition); // bean å·¥å‚è¿˜ç»´æŠ¤äº†æ‰€æœ‰çš„ beanNameï¼Œæœ‰åºçš„ this.beanDefinitionNames.add(beanName); // ä¸æ‡‚ï¼Œå…ˆè·³è¿‡ this.manualSingletonNames.remove(beanName); } // ä¸æ‡‚ã€‚å…ˆè·³è¿‡ this.frozenBeanDefinitionNames = null; } // çœç•¥åç½®ä»£ç ï¼Œå…ˆè·³è¿‡ } ä»ä¸Šé¢ä»£ç å¯çŸ¥ï¼Œæ³¨å†Œ BeanDefinition ä¹Ÿæ˜¯æœ‰æ³¨å†Œå™¨çš„ beanFactory å®ç°çš„ã€‚è¿˜è®°å¾— AnnotatedBeanDefinitionReader è¿™ä¸ªç±»çš„æ³¨é‡Šè¯´é“ï¼šç”¨äºæ³¨è§£ bean ç±»çš„ç¼–ç¨‹æ³¨å†Œã€‚è¿™æ˜¯ ClassPathBeanDefinitionScanner çš„æ›¿ä»£æ–¹æ¡ˆï¼Œåº”ç”¨ç›¸åŒçš„æ³¨è§£ï¼Œä½†ä»…é€‚ç”¨äºæ˜¾å¼æ³¨å†Œçš„ç±». æ˜¾ç¤ºæ³¨å†Œ å°±æ˜¯æ‰‹åŠ¨æŠŠäº‹å…ˆå®šä¹‰å¥½çš„ç±»æ·»åŠ åˆ° beanDefinitionMapã€‚ é‚£ä¹ˆçŒœæµ‹ä¸€ä¸‹ ClassPathBeanDefinitionScanner æ˜¯ä¸æ˜¯è‡ªåŠ¨æ‰«ææˆ‘ä»¬ç³»ç»Ÿè‡ªå®šä¹‰çš„ç±»ï¼Œç„¶åæŠŠæˆ‘ä»¬è‡ªå®šä¹‰ç±»è‡ªåŠ¨æ·»åŠ åˆ° beanDefinitionMap ä¸­çš„ã€‚æ¯”å¦‚è¢« @Service @Controller @Bean ä¿®é¥°çš„ç±»ã€‚æˆ‘ä»¬ä½¿ç”¨ Spring æ—¶ï¼Œå¯æ²¡æœ‰æŠŠè¿™äº›ç±»å‘ bean å·¥å‚æ‰‹åŠ¨æ³¨å†Œ\nè¿™ä¸ªæ–¹æ³•çš„åé¢è¿˜æ³¨å†Œäº†å¾ˆå¤šå…¶ä»–å†…ç½®çš„ç±»ã€‚å°±ä¸ä¸€ä¸€ç½—åˆ—äº†ã€‚ä¹‹åè¿™ä¸ªæ–¹æ³•å°±ç»“æŸäº†ã€‚\næ€»ç»“ä¸€ä¸‹ this.reader = new AnnotatedBeanDefinitionReader(this); éƒ½å¹²äº†å“ªäº›äº‹æƒ…ï¼š\nnew ä¸€ä¸ª AnnotatedBeanDefinitionReader Bean å®šä¹‰è¯»å–ç±» åœ¨ new çš„è¿‡ç¨‹ä¸­ï¼ŒæŠŠ spring å†…ç½®çš„å„ç§ç±»æ³¨å†Œåˆ° beanDefinitionMap ä¸­ã€‚ ä»è¿™ä¸ªæ–¹æ³•ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š\nAnnotationConfigApplicationContext ä¸­æœ‰ AnnotatedBeanDefinitionReader ç±»å‹çš„å±æ€§ BeanDefinition æ˜¯ç”¨æ¥æè¿°å„ç§ bean çš„ç±»ï¼Œç±»ä¼¼å»ºç­‘å›¾çº¸å’Œå»ºç­‘ç‰©çš„å…³ç³» BeanDefinitionHolder åªæ˜¯ BeanDefinition çš„æŒæœ‰è€…ï¼Œç›¸å½“äºä¸º BeanDefinition å¢åŠ äº†åç§°å’Œåˆ«å AnnotationConfigApplicationContext ä¸­æœ‰ beanFactory, beanDefinition çš„æ³¨å†Œéƒ½æ˜¯ç”± beanFactory å®Œæˆçš„ã€‚ BeanFactory ä¸­æœ‰ beanDefinitionMap, ç”¨æ¥å­˜æ”¾ beanDefinition. BeanFactory ä¸­è¿˜æœ‰ beanDefinitionNames, å­˜æ”¾æ‰€æœ‰çš„ beanDefinition çš„åç§° ç›®å‰ä¸ºæ­¢æˆ‘ä»¬åªçŸ¥é“å‘æ³¨å†Œå™¨ä¸­æ³¨å†Œäº†ä¸€å †å†…ç½®çš„ç±»ã€‚è¿˜æ²¡æœ‰çœ‹åˆ°è¿™äº›ç±»çš„ç”¨æ³•ï¼Œ å¤§èƒ†çŒœæµ‹ä¸€ä¸‹ï¼Œè¿™äº›å†…ç½®ç±»æ˜¯ä¸€äº›åˆ›ä¸–çºªçš„ç±»ï¼Œåé¢ç”¨åˆ°çš„ç±»æ‰«æï¼Œå±æ€§æ³¨å…¥ï¼Œåˆ‡é¢ç­‰ï¼Œå¯èƒ½éƒ½æ˜¯ç”±è¿™äº›ç±»å®ç°çš„ã€‚\nåˆå§‹åŒ– ClassPathBeanDefinitionScanner è¿™é‡Œä¸»è¦æ˜¯åˆå§‹åŒ–ä¸€ä¸ªæ‰«æå™¨ï¼Œæ‰«æå™¨çš„ä½œç”¨å°±æ˜¯æŠŠæŸä¸ªè·¯å¾„ä¸‹çš„ class æ–‡ä»¶åŠ è½½ jvm ä¸­ï¼Œç„¶åæ‰¾åˆ°è¿™äº›ç±»ä¸­å¯ä»¥ä½¿ç”¨çš„ Bean, æŠŠè¿™äº› bean æ³¨å†Œè¿›æ¥ã€‚\nåˆå§‹åŒ– reader åï¼Œæ¥ç€å°±æ˜¯åˆå§‹åŒ– scanner å­—æ®µäº†ï¼š\nthis.scanner = new ClassPathBeanDefinitionScanner(this); ä¸€å±‚å±‚è¿›å…¥æ–¹æ³•åï¼Œä¼šåˆ°è¾¾è¿™ä¸ªåœ°æ–¹ï¼š\npublic ClassPathBeanDefinitionScanner(BeanDefinitionRegistry registry, boolean useDefaultFilters, Environment environment, @Nullable ResourceLoader resourceLoader) { Assert.notNull(registry, \u0026#34;BeanDefinitionRegistry must not be null\u0026#34;); this.registry = registry; if (useDefaultFilters) { registerDefaultFilters(); } setEnvironment(environment); setResourceLoader(resourceLoader); } è¿™æ˜¯ä¸€ä¸ªæ„é€ å™¨ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯register, å’Œ reader ä¸€æ ·ï¼Œæ˜¯ AnnotationConfigApplicationContext çš„å¯¹è±¡ï¼Œç¬¬äºŒå‚æ•°é»˜è®¤ä¼ çš„ trueï¼Œ ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ç¯å¢ƒç›¸å…³ä¿¡æ¯ï¼Œç¬¬å››ä¸ªå‚æ•°æ˜¯ä¸€ä¸ª resourceLoader, è¿™é‡Œä¼ å…¥çš„ä¹Ÿæ˜¯ AnnotationConfigApplicationContext.\nå…¶ä¸­ registerDefaultFilters(); æ˜¯ä¸€ä¸ªé»˜è®¤çš„è¿‡æ»¤å™¨ï¼Œå…¶æ–¹æ³•å®ç°æ˜¯ï¼š\nprotected void registerDefaultFilters() { // é¦–å…ˆæŠŠ Component æ³¨è§£åŠ å…¥ this.includeFilters.add(new AnnotationTypeFilter(Component.class)); // è·å–ç±»åŠ è½½å™¨ ClassLoader cl = ClassPathScanningCandidateComponentProvider.class.getClassLoader(); try { // æƒ³æŠŠ javax.annotation.ManagedBean åŠ è½½åˆ° jvm ä¸­ï¼Œå¦‚æœç³»ç»Ÿä¸­æ²¡æœ‰è¿™ä¸ªåŒ…ï¼Œå°±ä¼šå¼‚å¸¸ this.includeFilters.add(new AnnotationTypeFilter( ((Class\u0026lt;? extends Annotation\u0026gt;) ClassUtils.forName(\u0026#34;javax.annotation.ManagedBean\u0026#34;, cl)), false)); logger.debug(\u0026#34;JSR-250 \u0026#39;javax.annotation.ManagedBean\u0026#39; found and supported for component scanning\u0026#34;); } catch (ClassNotFoundException ex) { // JSR-250 1.1 API (as included in Java EE 6) not available - simply skip. } try { // æƒ³æŠŠ javax.inject.Named åŠ è½½åˆ° jvm ä¸­ï¼Œå¦‚æœç³»ç»Ÿä¸­æ²¡æœ‰è¿™ä¸ªåŒ…ï¼Œå°±ä¼šå¼‚å¸¸ this.includeFilters.add(new AnnotationTypeFilter( ((Class\u0026lt;? extends Annotation\u0026gt;) ClassUtils.forName(\u0026#34;javax.inject.Named\u0026#34;, cl)), false)); logger.debug(\u0026#34;JSR-330 \u0026#39;javax.inject.Named\u0026#39; annotation found and supported for component scanning\u0026#34;); } catch (ClassNotFoundException ex) { // JSR-330 API not available - simply skip. } } è¿™ä¸ªæ–¹æ³•æƒ³æŠŠ @Component ã€@ManagedBeanã€ @Named æ³¨è§£åŠ å…¥è¿‡æ»¤å™¨ä¸­ï¼Œä½†æ˜¯ç”±äºç³»ç»Ÿæ²¡æœ‰åé¢ä¸¤ä¸ªåŒ…ï¼Œä¼šèµ°åˆ°å¼‚å¸¸å¤„ç†å—ã€‚æ‰€ä»¥è¿‡æ»¤å™¨ä¸­åªä¼šæœ‰ @Component.\nç„¶åä¸‹é¢å°±æ˜¯ä¸ºæ‰«æå™¨è®¾ç½®ç¯å¢ƒä¿¡æ¯ï¼Œå’Œèµ„æºåŠ è½½ä¿¡æ¯äº†ã€‚è¿™æ—¶å€™å¹¶æ²¡æœ‰å¼€å§‹æ‰«æåŒ…ã€‚åªæ˜¯å®Œæˆäº†æ‰«æå™¨çš„åˆå§‹åŒ–ã€‚åˆ°æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“æ‰«æå™¨ scanner ä¸­æœ‰ä¸‹é¢å‡ ä¸ªå±æ€§ï¼š\né»˜è®¤è¿‡æ»¤å™¨ï¼Œç”¨æ¥åˆ¤æ–­å“ªäº› bean åº”è¯¥æ³¨å†Œåˆ°å·¥å‚ä¸­ ä¸€äº›ç¯å¢ƒä¿¡æ¯ã€‚æš‚æ—¶ä¸æ·±ç©¶ èµ„æºåŠ è½½å™¨ çŒœæµ‹åº”è¯¥æ˜¯ä½¿ç”¨èµ„æºåŠ è½½å™¨æŠŠæŸä¸ªåŒ…ä¸‹çš„æ‰€æœ‰ class åŠ è½½åˆ° jvm ä¸­ï¼Œç„¶åæ ¹æ®åå°„éå†æ¯ä¸ª class çš„ä¿¡æ¯ï¼Œçœ‹çœ‹ç±»ä¸Šçš„æ³¨è§£æ˜¯å¦åœ¨é»˜è®¤çš„è¿‡æ»¤å™¨ä¸­ï¼Œå¦‚æœåœ¨å°±æ³¨å†Œåˆ° bean å·¥å‚ä¸­ã€‚ æˆ‘ä»¬è¿˜éœ€è¦äº†è§£ä¸€ä¸‹èµ„æºåŠ è½½å™¨æ˜¯ä»€ä¹ˆï¼Ÿ\nResourceLoader è¿›å…¥ setResourceLoader æ–¹æ³•ï¼Œæœ€åä¼šè¿›å…¥ PathMatchingResourcePatternResolver ç±»ã€‚è¿™ä¸ªç±»çš„æ ¹æ˜¯ ResourceLoader. è¿›å…¥è¿™ä¸ªæ¥å£çœ‹ä¸€ä¸‹ä»–éƒ½æœ‰å“ªäº›æ–¹æ³•ï¼š\npublic interface ResourceLoader { /** Pseudo URL prefix for loading from the class path: \u0026#34;classpath:\u0026#34; */ String CLASSPATH_URL_PREFIX = ResourceUtils.CLASSPATH_URL_PREFIX; Resource getResource(String location); @Nullable ClassLoader getClassLoader(); } å°±åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ°è¿™é‡Œå°±æ¯”è¾ƒæ˜æ˜¾äº†ï¼Œä¸åŒçš„ ResourceLoader å®ç°ç±»éƒ½ä¼šå®ç°ç‰¹å®šçš„ getResource æ–¹æ³•ï¼ŒåŠŸèƒ½å°±æ˜¯æ ¹æ®ä¸€ä¸ªä½ç½®ï¼Œè·å–ä¸€ä¸ª Resource. è¿›å…¥ Resource ç±»ä¸­å¯çŸ¥ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå’Œæ–‡ä»¶ç›¸å…³çš„æ–¹æ³•ã€‚å®ƒä¿å­˜ç€ä¸€ä¸ªæ–‡ä»¶çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”å¦‚ æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„ï¼Œæ–‡ä»¶çš„ File å¯¹è±¡ç­‰ç­‰ã€‚å¯ä»¥ç†è§£ä¸º ResourceLoader æŠŠæŸä¸ªè·¯å¾„çš„ä¸‹çš„ class æ–‡ä»¶å°è£…æˆäº† Resource å¯¹è±¡ã€‚\nè€Œ PathMatchingResourcePatternResolver æ­£æ˜¯ ResourceLoader çš„ä¸€ä¸ªå®ç°ï¼Œä»è¿™ä¸ªç±»çš„æ³¨é‡Šå¯çŸ¥å®ƒèƒ½å¤Ÿå°†æŒ‡å®šçš„èµ„æºä½ç½®è·¯å¾„è§£æä¸ºä¸€ä¸ªæˆ–å¤šä¸ªåŒ¹é…çš„èµ„æºã€‚æºè·¯å¾„å¯ä»¥æ˜¯ä¸ç›®æ ‡ Resource ä¸€å¯¹ä¸€æ˜ å°„çš„ç®€å•è·¯å¾„ï¼Œæˆ–è€…å¯ä»¥åŒ…å«ç‰¹æ®Šçš„â€œ classpath*: â€å‰ç¼€å’Œ/æˆ–å†…éƒ¨ Ant æ ·å¼çš„æ­£åˆ™è¡¨è¾¾å¼\nåˆ°è¿™é‡Œå·²ç»çŸ¥é“ ResourceLoader æ˜¯ä»€ä¹ˆäº†ï¼Œæš‚ä¸å‘ä¸‹æ·±ç©¶äº†ã€‚\nå·²ç»æµè§ˆå®Œ AnnotationConfigApplicationContext æ— å‚æ„é€ å™¨ä¸­çš„åŠŸèƒ½äº†ã€‚æ¥ç€å¾€ä¸‹çœ‹ï¼š\npublic AnnotationConfigApplicationContext(Class\u0026lt;?\u0026gt;... annotatedClasses) { this(); // ç»“æŸäº† register(annotatedClasses); // è¯¥å®ƒäº† refresh(); } é€šè¿‡ this() è¿™ä¸ªæ„é€ æ–¹æ³•ï¼Œæ³¨å†Œå™¨ AnnotationConfigApplicationContext ä¸­æœ‰äº† reader, scanner, bean å·¥å‚ä¸­æœ‰äº†ä¸€äº›å†…ç½®ç±»çš„ beanDefinition. scanner ä¸­æœ‰äº†èµ„æºåŠ è½½å™¨ã€‚\næ³¨å†Œé…ç½®ç±» è¿›å…¥ register(annotatedClasses) :\npublic void register(Class\u0026lt;?\u0026gt;... annotatedClasses) { Assert.notEmpty(annotatedClasses, \u0026#34;At least one annotated class must be specified\u0026#34;); // ä½¿ç”¨ reader æ³¨å†Œé…ç½®ç±» this.reader.register(annotatedClasses); } ä¸Šé¢å·²ç»è¯´è¿‡ï¼Œreader æ˜¯ç”¨æ¥æ˜¾å¼æ³¨å†Œ beanDefinition çš„ã€‚è¿™é‡Œè¿˜æ˜¯æŒ‡å®šä¸€ä¸ªå…·ä½“çš„ class æ¥æ³¨å†Œï¼Œå±äºæ˜¾å¼æ³¨å†Œï¼Œæ‰€ä»¥ç”¨ reader ä¸­çš„æ³¨å†Œæ–¹æ³•ï¼Œæ²¡æ¯›ç—…ã€‚è¿›å…¥æ–¹æ³•ï¼š\n//ä»ç»™å®šçš„ bean ç±»æ³¨å†Œä¸€ä¸ª beanï¼Œä»ç±»å£°æ˜çš„æ³¨é‡Šä¸­æ´¾ç”Ÿå…¶å…ƒæ•°æ®ã€‚ //å‚æ•°ï¼š //annotatedClass â€“ bean çš„ç±» //instanceSupplier â€“ åˆ›å»º bean å®ä¾‹çš„å›è°ƒï¼ˆå¯èƒ½ä¸º null ï¼‰ //name â€“ bean çš„æ˜¾å¼åç§° //qualifiers â€“ é™¤äº† bean ç±»çº§åˆ«çš„é™å®šç¬¦ä¹‹å¤–ï¼Œè¦è€ƒè™‘çš„ç‰¹å®šé™å®šç¬¦æ³¨é‡Šï¼ˆå¦‚æœæœ‰ï¼‰ //definitionCustomizers â€“ ä¸€ä¸ªæˆ–å¤šä¸ªç”¨äºè‡ªå®šä¹‰å·¥å‚ BeanDefinition çš„å›è°ƒï¼Œä¾‹å¦‚è®¾ç½®æƒ°æ€§åˆå§‹åŒ–æˆ–ä¸»æ ‡å¿— \u0026lt;T\u0026gt; void doRegisterBean(Class\u0026lt;T\u0026gt; annotatedClass, @Nullable Supplier\u0026lt;T\u0026gt; instanceSupplier, @Nullable String name, @Nullable Class\u0026lt;? extends Annotation\u0026gt;[] qualifiers, BeanDefinitionCustomizer... definitionCustomizers) { // æŠŠ class è½¬æ¢æˆä¸€ä¸ª BeanDefinition, è€Œè¿™ä¸ª BeanDefinition è¿˜ä¿ç•™äº†æ³¨è§£ä¿¡æ¯ AnnotatedGenericBeanDefinition abd = new AnnotatedGenericBeanDefinition(annotatedClass); // å¦‚æœè¿™ä¸ªç±»æœ‰ @Condition æ³¨è§£ï¼Œé‚£ä¹ˆå°±ä¼šåˆ¤æ–­æ˜¯å¦åº”è¯¥è·³è¿‡ if (this.conditionEvaluator.shouldSkip(abd.getMetadata())) { return; } // çœç•¥ã€‚... // æ³¨å†Œ BeanDefinition BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, this.registry); } è¿™é‡Œå·²ç»æŠŠé…ç½®ç±»æ³¨å†Œåˆ°å·¥å‚ä¸­äº†ã€‚ è¿™é‡Œä»…ä»…æ˜¯æŠŠç³»ç»Ÿä¸­çš„é…ç½®ç±»è¿›è¡Œæ³¨å†Œï¼Œå¹¶æ²¡æœ‰å¼€å§‹æ‰«æé…ç½®ç±»ä¸­çš„ä»£ç ã€‚æ¥ä¸‹æ¥å°±æ˜¯ refresh æ–¹æ³•äº†ï¼š\nrefresh @Override public void refresh() throws BeansException, IllegalStateException { synchronized (this.startupShutdownMonitor) { // åˆ·æ–°å‰åšä¸€äº›å‡†å¤‡ï¼Œè®°å½•å¼€å§‹æ—¶é—´ç­‰ prepareRefresh(); // è·å– bean å·¥å‚ ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory(); // å¯¹ bean å·¥å‚åšä¸€äº›é¢„å¤„ç†ã€å…ˆä¸å±•å¼€ prepareBeanFactory(beanFactory); try { // è¿™ä¸ªç±»æ˜¯ä¸€ä¸ªæ¨¡æ¿æ–¹æ³•ï¼Œç»™å­ç±»ç•™äº†ä¸€ä¸ªæ¥å£ï¼Œå¯ä»¥åšä¸€äº›äº‹æƒ… // å½“å‰ç±»å¹¶æ²¡æœ‰åšä»€ä¹ˆäº‹æƒ… æ˜¯ä¸€ä¸ªç©ºæ–¹æ³• postProcessBeanFactory(beanFactory); // Invoke factory processors registered as beans in the context. // è°ƒç”¨ bean å·¥å‚ä¸­æ‰€æœ‰ å®ç°äº† BeanFactoryPostProcessor å’Œ // BeanDefinitionRegistryPostProcessor æ¥å£çš„ bean çš„ postProcessBeanFactory æ–¹æ³•ï¼Œæˆ–è€… postProcessBeanDefinitionRegistry æ–¹æ³•ï¼Œ invokeBeanFactoryPostProcessors(beanFactory); // Register bean processors that intercept bean creation. registerBeanPostProcessors(beanFactory); // Initialize message source for this context. initMessageSource(); // Initialize event multicaster for this context. initApplicationEventMulticaster(); // Initialize other special beans in specific context subclasses. onRefresh(); // Check for listener beans and register them. registerListeners(); // Instantiate all remaining (non-lazy-init) singletons. finishBeanFactoryInitialization(beanFactory); // Last step: publish corresponding event. finishRefresh(); } catch (BeansException ex) { if (logger.isWarnEnabled()) { logger.warn(\u0026#34;Exception encountered during context initialization - \u0026#34; + \u0026#34;cancelling refresh attempt: \u0026#34; + ex); } // Destroy already created singletons to avoid dangling resources. destroyBeans(); // Reset \u0026#39;active\u0026#39; flag. cancelRefresh(ex); // Propagate exception to caller. throw ex; } finally { // Reset common introspection caches in Spring\u0026#39;s core, since we // might not ever need metadata for singleton beans anymore... resetCommonCaches(); } } } invokeBeanFactoryPostProcessors è¿›å…¥ invokeBeanFactoryPostProcessors(beanFactory) ï¼š\n// ç¬¬ä¸€ä¸ªå‚æ•° bean å·¥å‚ // ç¬¬äºŒå‚æ•°æ˜¯ BeanFactoryPostProcessor çš„å®ç°ç±»ã€‚ è¿™é‡Œæ˜¯ç©ºé›†åˆ public static void invokeBeanFactoryPostProcessors( ConfigurableListableBeanFactory beanFactory, List\u0026lt;BeanFactoryPostProcessor\u0026gt; beanFactoryPostProcessors) { // Invoke BeanDefinitionRegistryPostProcessors first, if any. Set\u0026lt;String\u0026gt; processedBeans = new HashSet\u0026lt;\u0026gt;(); if (beanFactory instanceof BeanDefinitionRegistry) { BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory; List\u0026lt;BeanFactoryPostProcessor\u0026gt; regularPostProcessors = new ArrayList\u0026lt;\u0026gt;(); List\u0026lt;BeanDefinitionRegistryPostProcessor\u0026gt; registryProcessors = new ArrayList\u0026lt;\u0026gt;(); // è¿™ä¸ªé›†åˆæ˜¯ç©ºçš„ï¼Œä¸ä¼šèµ°è¿™ä¸ªå¾ªç¯ .. çœç•¥ for (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) { // .... çœç•¥äº† } // Do not initialize FactoryBeans here: We need to leave all regular beans // uninitialized to let the bean factory post-processors apply to them! // Separate between BeanDefinitionRegistryPostProcessors that implement // PriorityOrdered, Ordered, and the rest. List\u0026lt;BeanDefinitionRegistryPostProcessor\u0026gt; currentRegistryProcessors = new ArrayList\u0026lt;\u0026gt;(); // First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered. // è¿™é‡Œæ˜¯ä¸ªé‡ç‚¹ï¼Œé€šè¿‡ bean å·¥å‚è·å–æ‰€æœ‰ç±»å‹ä¸º BeanDefinitionRegistryPostProcessor // çš„ beanï¼Œ ä¹Ÿå°±æ˜¯è¯´åªè¦ bean å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œéƒ½ä¼šè¢«è·å–åˆ° String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); // éå†æ‰€æœ‰çš„ BeanDefinitionRegistryPostProcessor ç±»å‹çš„ bean for (String ppName : postProcessorNames) { // å¦‚æœè¿™ä¸ª bean è¿˜å®ç°äº† PriorityOrdered æ¥å£ if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) { // æŠŠè¿™ä¸ª bean å•ç‹¬æ”¾åˆ° currentRegistryProcessors é›†åˆä¸­ // æ³¨æ„çœ‹è¿™é‡Œï¼Œå·²ç»ä½¿ç”¨ getBean æ–¹æ³•ï¼ŒæŠŠè¯¥ BeanDefinition è¿›è¡Œå®ä¾‹åŒ–äº† // å®ä¾‹åŒ– bean æ—¶è¿˜è¦éµå¾ª bean çš„ç”Ÿå‘½å‘¨æœŸã€‚ä¸‹é¢ä¼šè®²åˆ° currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); // åŒæ—¶æŠŠ bean æ·»åŠ åˆ° processedBeans é›†åˆä¸­ processedBeans.add(ppName); } } // æŠŠè¿™äº›æœ‰ä¼˜å…ˆçº§çš„ bean æ’åº sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); // å…ˆè°ƒç”¨è¿™äº›æœ‰ä¼˜å…ˆçº§çš„ bean ä¸­çš„ postProcessBeanDefinitionRegistry æ–¹æ³• invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry); // æ¸…ç©ºæœ‰ä¼˜å…ˆ bean é›†åˆï¼Œæ³¨æ„ registryProcessors å¹¶æ²¡æœ‰æ¸…ç©º currentRegistryProcessors.clear(); // Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered. // å†ä¸€æ¬¡è·å– è·å–æ‰€æœ‰ç±»å‹ä¸º BeanDefinitionRegistryPostProcessor // çš„ beanï¼Œ å› ä¸ºä¸Šé¢æ‰§è¡Œäº† postProcessBeanDefinitionRegistry æ–¹æ³• // å¯èƒ½æœ‰æ–°çš„ bean è¢«æ³¨å†Œ postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); // éå† for (String ppName : postProcessorNames) { // å¦‚æœæ²¡æœ‰åœ¨é›†åˆä¸­ï¼Œå¹¶ä¸”å±äº Ordered ç±»å‹ï¼Œä¹Ÿå°±æ˜¯è¯´ bean è¿˜å®ç°äº† Ordered æ¥å£ if (!processedBeans.contains(ppName) \u0026amp;\u0026amp; beanFactory.isTypeMatch(ppName, Ordered.class)) { // æŠŠæœ‰æ’åºçš„ bean åŠ å…¥ currentRegistryProcessors é›†åˆ currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); // åŒæ—¶åŠ å…¥ processedBeans é›†åˆ processedBeans.add(ppName); } } // æ’åº sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); // å†è°ƒç”¨è¿™äº›æœ‰æ’åºçš„ bean ä¸­çš„ postProcessBeanDefinitionRegistry æ–¹æ³• invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry); // æ¸…ç©º currentRegistryProcessors.clear(); // Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear. // åŒä¸Šï¼Œç»§ç»­æŸ¥æ‰¾æ™®é€šçš„ BeanDefinitionRegistryPostProcessor çš„ bean. ç›´åˆ°æ²¡æœ‰å‡ºç°æ–°çš„äº† boolean reiterate = true; while (reiterate) { reiterate = false; postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, true, false); for (String ppName : postProcessorNames) { if (!processedBeans.contains(ppName)) { currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class)); processedBeans.add(ppName); // è¿˜æœ‰æ–°çš„ bean è¢«åŠ å…¥ï¼Œå°±ä¸èƒ½ç»ˆæ­¢ï¼Œå¯èƒ½å› ä¸ºè¿™ä¸ªæ–°çš„ bean ä¼šå¼•å…¥æ›´å¤šçš„ bean reiterate = true; } } sortPostProcessors(currentRegistryProcessors, beanFactory); registryProcessors.addAll(currentRegistryProcessors); invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry); currentRegistryProcessors.clear(); } // Now, invoke the postProcessBeanFactory callback of all processors handled so far. invokeBeanFactoryPostProcessors(registryProcessors, beanFactory); invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory); } else { // Invoke factory processors registered with the context instance. invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory); } // æ‰€æœ‰ BeanDefinitionRegistryPostProcessor ç±»å‹çš„ bean çš„ postProcessBeanDefinitionRegistry æ”¾æ³•æ‰§è¡Œå®Œå // å†æ‰§è¡Œæ‰€æœ‰ BeanFactoryPostProcessor ç±»å‹çš„ bean çš„ postProcessBeanFactory æ–¹æ³• // Do not initialize FactoryBeans here: We need to leave all regular beans // uninitialized to let the bean factory post-processors apply to them! // è·å–æ‰€æœ‰ BeanFactoryPostProcessor ç±»å‹çš„ bean // å› ä¸º BeanDefinitionRegistryPostProcessor ç»§æ‰¿äº† BeanFactoryPostProcessor // æ‰€ä»¥è¿™é‡Œè¿˜ä¼šè·å–åˆ°æ‰€æœ‰ BeanDefinitionRegistryPostProcessor çš„ bean // å½“ç„¶è¿™äº› bean å·²ç»å¤„ç†è¿‡äº†ï¼Œä¸‹é¢ä¼šè·³è¿‡å·²ç»å¤„ç†è¿‡çš„ bean String[] postProcessorNames = beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, true, false); // Separate between BeanFactoryPostProcessors that implement PriorityOrdered, // Ordered, and the rest. // åŒä¸Šï¼Œåˆ†åˆ«è·å–æœ‰ä¼˜å…ˆçº§çš„ï¼Œæœ‰æ’åºçš„ï¼Œæ™®é€šçš„ bean // ç„¶åè°ƒç”¨ä»–ä»¬çš„ postProcessBeanFactory æ–¹æ³• List\u0026lt;BeanFactoryPostProcessor\u0026gt; priorityOrderedPostProcessors = new ArrayList\u0026lt;\u0026gt;(); List\u0026lt;String\u0026gt; orderedPostProcessorNames = new ArrayList\u0026lt;\u0026gt;(); List\u0026lt;String\u0026gt; nonOrderedPostProcessorNames = new ArrayList\u0026lt;\u0026gt;(); for (String ppName : postProcessorNames) { // è·³è¿‡å·²ç»å¤„ç†è¿‡çš„ bean if (processedBeans.contains(ppName)) { // skip - already processed in first phase above } // ä¼˜å…ˆçº§ else if (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) { priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class)); } // æœ‰æ’åº else if (beanFactory.isTypeMatch(ppName, Ordered.class)) { orderedPostProcessorNames.add(ppName); } else { // æ™®é€šçš„ bean nonOrderedPostProcessorNames.add(ppName); } } // First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered. sortPostProcessors(priorityOrderedPostProcessors, beanFactory); invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory); // Next, invoke the BeanFactoryPostProcessors that implement Ordered. List\u0026lt;BeanFactoryPostProcessor\u0026gt; orderedPostProcessors = new ArrayList\u0026lt;\u0026gt;(); for (String postProcessorName : orderedPostProcessorNames) { orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class)); } sortPostProcessors(orderedPostProcessors, beanFactory); invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory); // Finally, invoke all other BeanFactoryPostProcessors. List\u0026lt;BeanFactoryPostProcessor\u0026gt; nonOrderedPostProcessors = new ArrayList\u0026lt;\u0026gt;(); for (String postProcessorName : nonOrderedPostProcessorNames) { nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class)); } invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory); // Clear cached merged bean definitions since the post-processors might have // modified the original metadata, e.g. replacing placeholders in values... beanFactory.clearMetadataCache(); } refresh æ–¹æ³•ä¸­çš„ invokeBeanFactoryPostProcessors() ä½œç”¨æ˜¯ï¼š\næ‰¾åˆ°æ‰€æœ‰å®ç°äº† BeanDefinitionRegistryPostProcessor æ¥å£çš„ beanï¼Œç„¶åè°ƒç”¨ä»–ä»¬çš„ postProcessBeanDefinitionRegistry æ–¹æ³•ã€‚ æ‰¾åˆ°æ‰€æœ‰å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ beanï¼Œç„¶åè°ƒç”¨ä»–ä»¬çš„ postProcessBeanFactory æ–¹æ³•ã€‚ è¿˜è®°å¾—åœ¨åˆå§‹åŒ– reader æ—¶ï¼Œæ³¨å†Œäº†å¾ˆå¤šå†…ç½®ç±»åˆ° bean å·¥å‚ä¸­å—ï¼Ÿå…¶ä¸­ç¬¬ä¸€ä¸ªæ³¨å†Œçš„å°±æ˜¯ï¼š\nif (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) { RootBeanDefinition def = new RootBeanDefinition(ConfigurationClassPostProcessor.class); def.setSource(source); beanDefs.add(registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)); } è€Œ ConfigurationClassPostProcessor æ­£æ˜¯å®ç°äº† BeanDefinitionRegistryPostProcessor æ¥å£ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨è¿™ä¸ªç±»çš„ postProcessBeanDefinitionRegistry æ–¹æ³•ï¼š\n/** * Build and validate a configuration model based on the registry of * {@link Configuration} classes. */ public void processConfigBeanDefinitions(BeanDefinitionRegistry registry) { //.... } ç¿»è¯‘ä¸€ä¸‹æ³¨é‡Šï¼š\nåŸºäº Configuration ç±»çš„æ³¨å†Œè¡¨æ„å»ºå’ŒéªŒè¯é…ç½®æ¨¡å‹ã€‚\nä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ–¹æ³•ä¼šè§£ææˆ‘ä»¬ä¼ å…¥çš„é…ç½®ç±»ï¼Œå¦‚æœé…ç½®ç±»ä¸Šæœ‰ @ComponentScan æ³¨è§£ï¼Œè¿˜ä¼šæ‰«æç»™å®šçš„åŒ…ä¸‹çš„æ‰€æœ‰ class, æ‰¾åˆ°æ‰€æœ‰éœ€è¦æ³¨å†Œçš„ bean. ä¹Ÿå°±æ˜¯åœ¨è¿™é‡Œä¼šæŠŠç³»ç»Ÿä¸­æˆ‘ä»¬å®šä¹‰çš„ bean æ³¨å†Œæˆ BeanDefinition åˆ°å·¥å‚ä¸­ã€‚å…·ä½“çš„æ‰«æåŠ¨ä½œåœ¨ ClassPathBeanDefinitionScanner ç±»ä¸­çš„ doScan() æ–¹æ³•ï¼š\nBeanFactoryPostProcessor ä¸Šé¢æˆ‘ä»¬è¯´äº†ã€‚ spring IoC å®¹å™¨åœ¨åŠ è½½è¿‡ç¨‹ä¸­ä¼šæ‰¾åˆ°æ‰€æœ‰å®ç°äº† BeanFactoryPostProcessor æ¥å£çš„ beanï¼Œç„¶åè°ƒç”¨ä»–ä»¬çš„ postProcessBeanFactory æ–¹æ³•ã€‚è€Œè¿™ä¸ªæ—¶æœºæ˜¯åœ¨ bean å®šä¹‰æ³¨å†Œåˆ°å·¥å‚ä¹‹åï¼Œbean å®ä¾‹ç”Ÿæˆä¹‹å‰ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬è‡ªå·±çš„ bean æƒ³åœ¨ bean é€šè¿‡ bean å·¥å‚åšä¸€äº›äº‹æƒ…çš„æ—¶å€™ï¼Œå¯ä»¥å®ç°è¿™ä¸ªæ¥å£ï¼Œåšä¸€äº›ç‰¹æ®Šçš„æ“ä½œï¼šä¸‹é¢æ˜¯å¯¹åŠ å¯†çš„é…ç½®è¿›è¡Œè§£å¯†ï¼Œ\næ•°æ®åº“é…ç½®ï¼š\nmysql.host=127.0.0.1 mysql.port=13306 # å¯†ç æ˜¯åŠ å¯†çš„ mysql.password=SM@jfajoadajdfa ä»£ç ï¼š\npublic class ContxtDemo { public static void main(String[] args) { AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(Config.class); // è·å–è§£å¯†åçš„å¯†ç  System.out.println(context.getEnvironment().getProperty(\u0026#34;mysql.password\u0026#34;)); } } @Configuration @ComponentScan(basePackageClasses = {Config.class}) @PropertySource(\u0026#34;classpath:/app.properties\u0026#34;) class Config{ } /** * è¿˜å®ç°äº† EnvironmentAware æ¥å£ï¼Œå¯ä»¥è·å¾— Environment ä¿¡æ¯ */ @Component class DecryptConfig implements EnvironmentAware,BeanFactoryPostProcessor { private ConfigurableEnvironment environment; @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException { MutablePropertySources propertySources = environment.getPropertySources(); // è·å–æ‰€æœ‰ PropertySource for (org.springframework.core.env.PropertySource\u0026lt;?\u0026gt; propertySource : propertySources) { Map\u0026lt;String,String\u0026gt; map = (Map)propertySource.getSource(); // éå†æ‰€æœ‰é…ç½®ä¿¡æ¯ï¼Œ // å¦‚æœå€¼æ˜¯ SM@ å¼€å¤´çš„ï¼Œè¯´æ˜æ˜¯åŠ å¯†ä¿¡æ¯ï¼Œéœ€è¦è§£å¯† map.forEach((k,v) -\u0026gt; { if(v.indexOf(\u0026#34;SM@\u0026#34;) == 0){ String ciphertext = v.substring(3) + \u0026#34;è§£å¯†å\u0026#34;; map.put(k,ciphertext); } }); } } @Override public void setEnvironment(Environment environment) { // å¾—åˆ°ç¯å¢ƒä¿¡æ¯ this.environment = (ConfigurableEnvironment)environment; } } ç»“æœ\njfajoadajdfa è§£å¯†å finishBeanFactoryInitialization(beanFactory); å®ä¾‹åŒ–å‰©ä½™éæ‡’åŠ è½½çš„ bean, ä¸ºä»€ä¹ˆè¯´æ˜¯å‰©ä½™çš„ï¼Ÿ å› ä¸ºåœ¨å‰é¢çš„ invokeBeanFactoryPostProcessors æ–¹æ³•ä¸­ï¼Œå¯èƒ½æœ‰çš„ bean å·²ç»è°ƒç”¨ getBean() æ–¹æ³•è¿›è¡Œå®ä¾‹åŒ–äº†ã€‚\nè¿™é‡Œä¼šçœ‹åˆ° bean å®ä¾‹åŒ–è¿‡ç¨‹ä¼šæ‰§è¡Œç•™ç»™ç”¨æˆ·çš„æ‰©å±•ç‚¹ã€‚ä¸‹é¢åˆ—å‡ºè¿‡ç¨‹é‡è¦çš„æ­¥éª¤ï¼š\n1. å®ä¾‹åŒ– bean instanceWrapper = createBeanInstance(beanName, mbd, args);//åˆ›å»º bean çš„å®ä¾‹ã€‚æ ¸å¿ƒ 2. å¡«å……å±æ€§ opulateBean(beanName, mbd, instanceWrapper);//å¡«å……å±æ€§ï¼Œé‡è¦ 3. Aware ç³»åˆ—æ¥å£çš„å›è°ƒ aware ç³»åˆ—æ¥å£çš„å›è°ƒä½äº initializeBean ä¸­çš„ invokeAwareMethods æ–¹æ³•ï¼š\nprotected Object initializeBean(final String beanName, final Object bean, @Nullable RootBeanDefinition mbd) { if (System.getSecurityManager() != null) { AccessController.doPrivileged((PrivilegedAction\u0026lt;Object\u0026gt;) () -\u0026gt; { invokeAwareMethods(beanName, bean); return null; }, getAccessControlContext()); } else { // aware ç³»åˆ—æ¥å£å›è°ƒ invokeAwareMethods(beanName, bean); } Object wrappedBean = bean; if (mbd == null || !mbd.isSynthetic()) { // BeanPostProcessor æ–¹æ³•å›è°ƒ wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName); } try { // initMethods æ–¹æ³•å›è°ƒ invokeInitMethods(beanName, wrappedBean, mbd); } catch (Throwable ex) { throw new BeanCreationException( (mbd != null ? mbd.getResourceDescription() : null), beanName, \u0026#34;Invocation of init method failed\u0026#34;, ex); } if (mbd == null || !mbd.isSynthetic()) { // BeanPostProcessorsAfterInitialization æ–¹æ³•å›è°ƒ wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName); } return wrappedBean; } ä¸‹é¢æ˜¯ aware æ–¹æ³•ï¼š\nprivate void invokeAwareMethods(final String beanName, final Object bean) { if (bean instanceof Aware) { if (bean instanceof BeanNameAware) { ((BeanNameAware) bean).setBeanName(beanName); } if (bean instanceof BeanClassLoaderAware) { ClassLoader bcl = getBeanClassLoader(); if (bcl != null) { ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl); } } if (bean instanceof BeanFactoryAware) { ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.this); } } } 4. postProcessBeforeInitialization public Object applyBeanPostProcessorsBeforeInitialization(Object existingBean, String beanName) throws BeansException { Object result = existingBean; for (BeanPostProcessor processor : getBeanPostProcessors()) { Object current = processor.postProcessBeforeInitialization(result, beanName); if (current == null) { return result; } result = current; } return result; } 5. afterPropertiesSet å’Œ init-method åœ¨ invokeInitMethods æ–¹æ³•ä¸­åˆæ‰äº†ä¸¤ä¸ªå›è°ƒæ–¹æ³•ï¼š\nprotected void invokeInitMethods(String beanName, final Object bean, @Nullable RootBeanDefinition mbd) throws Throwable { boolean isInitializingBean = (bean instanceof InitializingBean); if (isInitializingBean \u0026amp;\u0026amp; (mbd == null || !mbd.isExternallyManagedInitMethod(\u0026#34;afterPropertiesSet\u0026#34;))) { if (logger.isDebugEnabled()) { logger.debug(\u0026#34;Invoking afterPropertiesSet() on bean with name \u0026#39;\u0026#34; + beanName + \u0026#34;\u0026#39;\u0026#34;); } if (System.getSecurityManager() != null) { try { AccessController.doPrivileged((PrivilegedExceptionAction\u0026lt;Object\u0026gt;) () -\u0026gt; { ((InitializingBean) bean).afterPropertiesSet(); return null; }, getAccessControlContext()); } catch (PrivilegedActionException pae) { throw pae.getException(); } } else { // å›è°ƒ afterPropertiesSet æ–¹æ³• ((InitializingBean) bean).afterPropertiesSet(); } } if (mbd != null \u0026amp;\u0026amp; bean.getClass() != NullBean.class) { String initMethodName = mbd.getInitMethodName(); if (StringUtils.hasLength(initMethodName) \u0026amp;\u0026amp; !(isInitializingBean \u0026amp;\u0026amp; \u0026#34;afterPropertiesSet\u0026#34;.equals(initMethodName)) \u0026amp;\u0026amp; !mbd.isExternallyManagedInitMethod(initMethodName)) { // å›è°ƒ init æ–¹æ³• invokeCustomInitMethod(beanName, bean, mbd); } } } 6. postProcessAfterInitialization public Object applyBeanPostProcessorsAfterInitialization(Object existingBean, String beanName) throws BeansException { Object result = existingBean; for (BeanPostProcessor processor : getBeanPostProcessors()) { // å›è°ƒ postProcessAfterInitialization æ–¹æ³• Object current = processor.postProcessAfterInitialization(result, beanName); if (current == null) { return result; } result = current; } return result; } Spring Bean çš„ç”Ÿå‘½å‘¨æœŸ å®ä¾‹åŒ– Bean å¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™ Bean çš„å¯¹è±¡æ˜¯éå¸¸ä½çº§çš„ï¼ŒåŸºæœ¬ä¸èƒ½å¤Ÿè¢«æˆ‘ä»¬ä½¿ç”¨ï¼Œå› ä¸ºè¿æœ€åŸºæœ¬çš„å±æ€§éƒ½æ²¡æœ‰è®¾ç½®ï¼Œå¯ä»¥ç†è§£ä¸º è¿ Autowired æ³¨è§£éƒ½æ˜¯æ²¡æœ‰è§£æçš„ï¼› å¡«å……å±æ€§ï¼Œå½“åšå®Œè¿™ä¸€æ­¥ï¼ŒBean å¯¹è±¡åŸºæœ¬æ˜¯å®Œæ•´çš„äº†ï¼Œå¯ä»¥ç†è§£ä¸º Autowired æ³¨è§£å·²ç»è§£æå®Œæ¯•ï¼Œä¾èµ–æ³¨å…¥å®Œæˆäº†ï¼› å¦‚æœ Bean å®ç°äº† BeanNameAware æ¥å£ï¼Œåˆ™è°ƒç”¨ setBeanName æ–¹æ³•ï¼› å¦‚æœ Bean å®ç°äº† BeanClassLoaderAware æ¥å£ï¼Œåˆ™è°ƒç”¨ setBeanClassLoader æ–¹æ³•ï¼› å¦‚æœ Bean å®ç°äº† BeanFactoryAware æ¥å£ï¼Œåˆ™è°ƒç”¨ setBeanFactory æ–¹æ³•ï¼› è°ƒç”¨ BeanPostProcessor çš„ postProcessBeforeInitialization æ–¹æ³•ï¼› å¦‚æœ Bean å®ç°äº† InitializingBean æ¥å£ï¼Œè°ƒç”¨ afterPropertiesSet æ–¹æ³•ï¼› å¦‚æœ Bean å®šä¹‰äº† init-method æ–¹æ³•ï¼Œåˆ™è°ƒç”¨ Bean çš„ init-method æ–¹æ³•ï¼› è°ƒç”¨ BeanPostProcessor çš„ postProcessAfterInitialization æ–¹æ³•ï¼›å½“è¿›è¡Œåˆ°è¿™ä¸€æ­¥ï¼ŒBean å·²ç»è¢«å‡†å¤‡å°±ç»ªäº†ï¼Œä¸€ç›´åœç•™åœ¨åº”ç”¨çš„\nä¸Šä¸‹æ–‡ä¸­ï¼Œç›´åˆ°è¢«é”€æ¯ï¼› å¦‚æœåº”ç”¨çš„ä¸Šä¸‹æ–‡è¢«é”€æ¯äº†ï¼Œå¦‚æœ Bean å®ç°äº† DisposableBean æ¥å£ï¼Œåˆ™è°ƒç”¨ destroy æ–¹æ³•ï¼Œå¦‚æœ Bean å®šä¹‰äº† destory-method\nå£°æ˜äº†é”€æ¯æ–¹æ³•ä¹Ÿä¼šè¢«è°ƒç”¨ã€‚ å†™ä¸ªç¨‹åºéªŒè¯ä¸€ä¸‹ï¼š\npublic class ContxtDemo { public static void main(String[] args) { AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(Config.class); } } @Configuration @ComponentScan(basePackageClasses = {Config.class}) @PropertySource(\u0026#34;classpath:/app.properties\u0026#34;) class Config{ @Bean(initMethod = \u0026#34;init\u0026#34;, destroyMethod = \u0026#34;des\u0026#34;, name=\u0026#34;car\u0026#34;) public Car car(){ return new Car(); } } class Car implements BeanPostProcessor, InitializingBean, BeanNameAware, BeanFactoryAware, BeanClassLoaderAware, DisposableBean { int age; public Car() { System.out.println(\u0026#34;æ„é€ æ–¹æ³•\u0026#34;); } @Override public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException { if(\u0026#34;tank\u0026#34;.equals(beanName)) { System.out.println(\u0026#34;postProcessBeforeInitialization\u0026#34;); } return bean; } public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException { if(\u0026#34;tank\u0026#34;.equals(beanName)) { System.out.println(\u0026#34;postProcessAfterInitialization\u0026#34;); } return bean; } @Override public void afterPropertiesSet() throws Exception { System.out.println(\u0026#34;afterPropertiesSet\u0026#34;); } @Override public void setBeanClassLoader(ClassLoader classLoader) { System.out.println(\u0026#34;setBeanClassLoader\u0026#34;); } @Override public void setBeanFactory(BeanFactory beanFactory) throws BeansException { System.out.println(\u0026#34;setBeanFactory\u0026#34;); } @Override public void setBeanName(String name) { System.out.println(\u0026#34;setBeanName\u0026#34;); } @Override public void destroy() throws Exception { System.out.println(\u0026#34;destroy\u0026#34;); } private void init() { System.out.println(\u0026#34;initMe\u0026#34;); } private void des() { System.out.println(\u0026#34;desM\u0026#34;); } } @Component class Tank { } ç»“æœ:\næ„é€ æ–¹æ³• setBeanName setBeanClassLoader setBeanFactory afterPropertiesSet initMe postProcessBeforeInitialization postProcessAfterInitialization ","date":"2022-11-08T14:48:39Z","permalink":"https://dccmmtop.github.io/posts/springioc%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E7%AE%80%E8%A6%81%E4%BB%8B%E7%BB%8D/","section":"posts","tags":["java","spring"],"title":"spring IOC åŠ è½½è¿‡ç¨‹ç®€è¦ä»‹ç»"},{"categories":null,"contents":"æˆ‘ä»¬å…ˆä¸ç²˜è´´å®˜æ–¹çš„æ™¦æ¶©å®šä¹‰ï¼Œé€šè¿‡ä¸€ä¸ªä¾‹å­æ¥ä¸€æ­¥ä¸€æ­¥çš„å¼•å‡º IoC æ€æƒ³ï¼ŒçœŸæ­£çš„ä½“ä¼šåˆ° IoC æ€æƒ³å¯¹æˆ‘ä»¬ç¼–ç¨‹å¸¦æ¥çš„ç›Šå¤„ã€‚\nè½¦ï¼Œå¼•æ“ï¼Œè½®èƒ ä¸€ä¸ªæ±½è½¦éœ€è¦å¼•æ“å’Œè½®èƒï¼Œæœ‰ä¸‹é¢æ¨¡å‹ï¼š\n/** * ä¸œé£æ±½è½¦ */ class NissanCar{ private Engine engine; private Tyre tyre; public NissanCar() { this.engine = new EngineV1(); this.tyre = new TyreV1(); } } /** * å¤§ä¼—æ±½è½¦ */ class VolkswagenCar{ private Engine engine; private Tyre tyre; public VolkswagenCar() { this.engine = new EngineV1(); this.tyre = new TyreV1(); } } // .... è¿˜æœ‰å‡ åç§å…¶ä»–å“ç‰Œçš„è½¦ã€‚ç”¨çš„éƒ½æ˜¯ V1 å¼•æ“ /** * å¼•æ“æ¥å£ï¼Œè¾“å‡ºåŠ¨åŠ› */ interface Engine { void outputPower(); } class EngineV1 implements Engine { public void outputPower() { } } /** * è½®èƒæ¥å£ï¼Œå¯ä»¥è½¬åŠ¨ */ interface Tyre { void turn(); } class TyreV1 implements Tyre { public void turn() { } } æ— è®ºä»€ä¹ˆæ±½è½¦éƒ½éœ€è¦å¼•æ“å’Œè½®èƒï¼Œæˆ‘ä»¬æ„é€ ä¸€ä¸ªæ±½è½¦æ—¶ï¼Œå¿…é¡»åŒæ—¶æ„é€ ä¸€ä¸ªå¼•æ“å’Œè½®èƒçš„å¯¹è±¡ï¼Œè¿™æ ·çš„æ±½è½¦æ‰èƒ½æ­£å¸¸å·¥ä½œï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬æ­£å¸¸çš„ç¼–ç æ–¹å¼ï¼Œä¸€åˆ‡éƒ½å¾ˆç¾å¥½ã€‚ç›´åˆ°æœ‰ä¸€å¤©ï¼Œå‘ç”Ÿäº†ä¸€èµ·ä¸¥é‡çš„äº¤é€šäº‹æ•…ï¼ŒæŸäººæ­£åœ¨å¼€ç€æ±½è½¦ï¼Œçªç„¶åŠ é€Ÿï¼Œæ— æ³•æ§åˆ¶ã€‚ç›´åˆ°æ’ä¸Šäº†å…¶ä»–æ±½è½¦æ‰åœä¸‹æ¥ï¼ŒåŒæ—¶ä¹Ÿå—äº†éå¸¸ä¸¥é‡çš„ä¼¤ã€‚æ±½è½¦å‚å•†çš„å·¥ç¨‹å¸ˆæ’æŸ¥å¾ˆä¹…å‘ç°æ˜¯å¼•æ“å‡ºäº†é—®é¢˜ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¼šçªç„¶ä¸å—æ§åˆ¶ï¼Œä»¥æœ€å¤§é©¬åŠ›è½¬åŠ¨ã€‚\nç”Ÿäº§å¼•æ“çš„å‚å•†å¾ˆå¿«ä¿®å¤äº†è¿™ä¸ªé—®é¢˜ï¼Œå¹¶æ¨å‡ºäº† v2 ç‰ˆæœ¬çš„å¼•æ“ã€‚åªè¦æ‰€æœ‰çš„è½¦éƒ½æ¢äº†æœ€æ–°çš„å¼•æ“å°±å½»åº•è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚.. è¿™ä¸ªç°è±¡å¯¹åº”åˆ°æˆ‘ä»¬ä¸Šé¢çš„æ¨¡å‹ï¼Œå°±æ˜¯ï¼š\nclass EngineV2 implements Engine { public void outputPower() { } } ç„¶åæ‰€æœ‰æ±½è½¦çš„æ„é€ æ–¹æ³•ä¸­ï¼Œéƒ½è¦ä¿®æ”¹æˆï¼šthis.engine = new EngineV2()ã€‚ çœ‹èµ·æ¥ä¹Ÿä¸æ˜¯ä»€ä¹ˆå¤§é—®é¢˜ï¼Œæˆ‘ä»¬å€ŸåŠ©ç¼–è¾‘å™¨ï¼Œæ¥ä¸ªå…¨å±€æ›¿æ¢ä¸å°±è¡Œäº†ã€‚\nç­‰ç­‰ï¼Œåˆ«å¿˜äº†æˆ‘ä»¬ç¼–å†™çš„è¿™ç¨‹åºåªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œéå¸¸éå¸¸ç®€å•ï¼Œå®é™…åº”ç”¨ä¸­æˆ‘ä»¬ä¸å¯èƒ½æœ‰è¿™ä¹ˆç®€å•çš„åº”ç”¨ï¼Œè¿™ä¹ˆæ¸…æ™°æ˜äº†çš„ä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬åº”ç”¨ä¸­çš„ç”¨æˆ·ä¾èµ–æ±½è½¦ï¼Œæ±½è½¦ä¾èµ–å¼•æ“ï¼Œä¾èµ–è½®èƒï¼Œä¾èµ–åº§æ¤…ï¼Œä¾èµ–å˜é€Ÿç³»ç»Ÿï¼Œåˆ¹è½¦ç³»ç»Ÿï¼Œè€Œå˜é€Ÿç³»ç»Ÿå¯èƒ½ä¼šå’Œå¼•æ“æœ‰äº¤äº’ï¼Œåˆ¹è½¦ç³»ç»Ÿä¹Ÿå¯èƒ½å’Œå¼•æ“æœ‰äº¤äº’ç­‰ç­‰ï¼Œéå¸¸å¤æ‚çš„ä¾èµ–å…³ç³»ã€‚å¯ä¸æ•¢å…¨å±€æ›¿æ¢åç›´æ¥æäº¤åˆ°ç”Ÿäº§è¿è¡Œã€‚æˆ‘ä»¬å¿…é¡»è¦åšè¯¦å°½çš„æµ‹è¯•ï¼Œ\næˆ‘ä»¬çš„ç¨‹åºä¸å¯èƒ½æ˜¯å†™å®Œåå°±ä¸€å±‚ä¸å˜çš„ï¼Œæˆ‘ä»¬çš„ç¨‹åºå°±æ˜¯ä¸ºäº†è§£å†³ç°å®ç”Ÿæ´»ä¸­çš„é—®é¢˜ï¼Œè€Œç°å®ç”Ÿæ´»æœ€ä¸ç¼ºçš„å°±æ˜¯å˜åŒ–ï¼Œå¦‚æœéœ€æ±‚å˜åŒ–ï¼Œæˆ‘ä»¬çš„ç¨‹åºéƒ½è¦å‘ç”Ÿå¦‚æ­¤ä¹‹å¤§çš„æ”¹åŠ¨ï¼Œå¯¹ç¨‹åºå‘˜æ¥è¯´ç®€ç›´æ˜¯ç§ƒé¡¶ä¹‹ç¾ã€‚å¿…é¡»å¯»æ±‚è§£å†³ä¹‹é“ã€‚\nå·¥å‚æ–¹æ³• ç¾éš¾å‘ç”Ÿçš„åŸå› å°±åœ¨ä¸åº•å±‚çš„å¼•æ“å‘ç”Ÿäº†å˜åŒ–ï¼Œè€Œå¼•æ“è¢«ä¼—å¤šæ±½è½¦ä¾èµ–ï¼Œæ±½è½¦ä¹Ÿå°±å¿…é¡»å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœä¼—æ±½è½¦å‚å•†åœ¨ç”Ÿäº§æ±½è½¦çš„æ—¶å€™ï¼Œä¸è¦ä¸»åŠ¨çš„å»åˆ›å»ºæŸç§ç±»å‹çš„å¼•æ“ï¼Œè€Œæ˜¯å‘Šè¯‰å¼•æ“å·¥å‚ï¼šç»™æˆ‘ä¸€ä¸ªå¼•æ“ã€‚å¦‚æœä»¥ååœ¨éœ€è¦æ›´æ¢å¼•æ“çš„æ—¶å€™ï¼Œä¼—å¤šæ±½è½¦å‚å•†ä¸å†åšä»€ä¹ˆæ”¹åŠ¨ï¼Œä»æ˜¯å‘Šè¯‰å¼•æ“å·¥å‚ï¼šç»™æˆ‘ä¸€ä¸ªå¼•æ“ï¼Œå¼•æ“å·¥å‚è‡ªä¼šæŠŠåˆé€‚å¼•æ“è¿”å›ç»™æ±½è½¦å‚å•†ï¼Œå¦‚ä¸‹ï¼š\n/** * ä¸œé£æ±½è½¦ */ class NissanCar{ private Engine engine; private Tyre tyre; public NissanCar() { this.engine = EngineFactory.get(); this.tyre = TyreFactory.get(); } } /** * å¤§ä¼—æ±½è½¦ */ class VolkswagenCar{ private Engine engine; private Tyre tyre; public VolkswagenCar() { this.engine = EngineFactory.get(); this.tyre = TyreFactory.get(); } } // .... è¿˜æœ‰å‡ åç§å…¶ä»–å“ç‰Œçš„è½¦ã€‚ç”¨çš„éƒ½æ˜¯ V1 å¼•æ“ /** * å¼•æ“å·¥å‚ */ class EngineFactory { public static Engine get(){ return new EngineV2(); } } /** * è½®èƒå·¥å‚ */ class TyreFactory { public static Tyre get(){ return new TyreV1(); } } ä»åŸæ¥æ±½è½¦å‚å•†è‡ªå·±æ„é€ å¼•æ“ï¼Œç„¶åç»„è£…åˆ°è½¦ä¸Šï¼ˆèµ‹å€¼åŠ¨ä½œï¼‰, ç®€åŒ–åˆ°ç›´æ¥ç»„è£…å¼•æ“å³å¯ï¼Œä¸å†å…³æ³¨å¼•æ“å¦‚ä½•åˆ¶é€ äº†ã€‚å†å‡çº§å¼•æ“æ—¶ï¼Œé‚£å°±æ˜¯å¼•æ“å·¥å‚çš„äº‹äº†ï¼Œå’Œæ±½è½¦å‚å•†æ— å…³ï¼Œè€Œå¼•æ“å·¥å‚åªæœ‰ä¸€ä¸ªï¼Œå‡çº§çš„å·¥ä½œé‡ä¹Ÿæ¯”è¾ƒå°‘ã€‚ä»£ç æ”¹åŠ¨å°‘ï¼Œé‚£ä¹ˆå¯¹æ•´ä½“ç³»ç»Ÿçš„å½±å“å°±æ¯”è¾ƒå°ã€‚ä¸–ç•Œåˆå†æ¬¡ç¾å¥½äº†ã€‚ ä½†æ˜¯åˆšåˆšè¯´è¿‡ï¼Œè¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ç¨‹åºï¼Œä¾èµ–å…³ç³»æ¯”è¾ƒæ¸…æ™°ï¼ŒçœŸå®ä¸–ç•Œä¸­ï¼Œä¸€è¾†è½¦ä¸å¯èƒ½åªæœ‰å¼•æ“ï¼Œè½®èƒï¼Œè¿˜ä¼šæœ‰åº§æ¤…ï¼Œæ–¹å‘ç›˜ï¼Œç¯ï¼Œåˆ¹è½¦ï¼Œå˜é€Ÿç®±ç­‰ç­‰ã€‚å¯èƒ½ä¼šè§‰å¾—ï¼Œé‚£å°±ç»§ç»­æ·»åŠ å·¥å‚å‘—ï¼Œç»™æ¯ä¸ªé›¶ä»¶éƒ½æ·»åŠ ä¸€ä¸ªå·¥å‚æ–¹æ³•ã€‚ç»„è£…æ±½è½¦éœ€è¦çš„é›¶ä»¶éƒ½ä»å·¥å‚æ–¹æ³•ä¸­è·å–ï¼Œä¸è¦è‡ªå·± new å¯¹è±¡å‡ºæ¥ã€‚å—¯ï¼Œè¿™æ ·å½“ç„¶å¯ä»¥ï¼Œä½†æ˜¯ä¸€è¾†è½¦è‡³å°‘éœ€è¦ä¸Šç™¾ä¸Šåƒä¸ªé›¶ä»¶ï¼Œæˆ‘ä»¬éƒ½è¦è‡ªå·±å»å»ºå·¥å‚æ–¹æ³•ï¼Œç„¶åç»„è£…å—ï¼Ÿè¿™æ ·å¤ªç´¯äº†ã€‚\næˆ‘ä»¬å†çœ‹ä¸€ä¸‹æ„é€ æ±½è½¦éƒ½åšäº†å“ªäº›å·¥ä½œï¼Ÿ\nå£°æ˜éœ€è¦çš„é…ä»¶ï¼ˆå®šä¹‰å±æ€§ï¼š å¦‚ï¼šprivate Engine engine) è·å–é…ä»¶ï¼ˆåœ¨æ„é€ æ–¹æ³•ä¸­è°ƒç”¨é…ä»¶çš„å·¥å‚æ–¹æ³•ï¼Œå¦‚ï¼š EngineFactory.get()) ç»„è£…é…ä»¶ï¼ˆåœ¨æ„é€ æ–¹æ³•ä¸­èµ‹å€¼ï¼Œå¦‚ this.engine = EngineFactory.get()) ä¸ç®¡æ˜¯æ±½è½¦å‚å•†è‡ªå·±æ„é€ é…ä»¶ï¼Œè¿˜æ˜¯é€šè¿‡å·¥å‚æ–¹æ³•æ„é€ ï¼Œéƒ½æ˜¯æˆ‘ä»¬è‡ªå·± new å‡ºæ¥çš„é…ä»¶å¯¹è±¡ï¼ˆæ­¥éª¤ 2)ï¼Œç„¶åç”±è‡ªå·±æŠŠé…ä»¶å¯¹è±¡èµ‹å€¼ç»™æ±½è½¦ï¼Œè§£å†³æ±½è½¦ä¸é…ä»¶çš„ä¾èµ–å…³ç³»ï¼ˆæ­¥éª¤ 3), æˆ‘ä»¬å†æ·±å…¥æ€è€ƒä¸€ä¸‹ï¼Œå¯ä»¥ä¸å¯ä»¥åˆ¶ä½œä¸€ä¸ªæ™ºèƒ½çš„æ±½è½¦ç”Ÿäº§è½¦é—´ï¼Œæˆ‘ä»¬æŠŠå®šä¹‰å¥½çš„æ±½è½¦æ¨¡å‹å’Œæ‰€æœ‰é…ä»¶æ¨¡å‹å‘Šè¯‰è¿™ä¸ªç”Ÿäº§è½¦é—´ï¼ˆæ­¥éª¤ 1)ï¼Œ ç„¶åç”Ÿäº§è½¦é—´ä¼šæ ¹æ®å·²ç»å®šä¹‰å¥½çš„é…ä»¶æ¨¡å‹å’Œæ±½è½¦æ¨¡å‹è‡ªå·±ç”Ÿäº§é…ä»¶ï¼ˆæ­¥éª¤ 2)ï¼ŒæŠŠé…ä»¶ç»„è£…åˆ°æ±½è½¦ä¸­ï¼ˆæ­¥éª¤ 3)ã€‚\nå…¶å®è¿™æ˜¯å®Œå…¨å¯ä»¥çš„ï¼Œç¨‹åºå‘˜å·²ç»æŠŠæ‰€æœ‰çš„ç±»å®šä¹‰å¥½äº†ï¼Œç±»ä¸­æ‰€ä¾èµ–å…¶ä»–å¯¹è±¡ä¹Ÿæ˜¯æ˜ç¡®çš„ï¼Œåƒè‡ªåŠ¨ new å¯¹è±¡ä»¥åŠä¸ºå¯¹è±¡å±æ€§èµ‹å€¼è¿™ç§æœºæ¢°åŠ¨ä½œå°±å¯ä»¥ç”±æŸä¸ªç¨‹åºè‡ªåŠ¨åŒ–æ‰§è¡Œã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•åˆ¶é€ è¿™ç§â€œè½¦é—´â€\nè½¦é—´ é¦–å…ˆç”Ÿæˆä¸€ä¸ªå¼•æ“å¯¹è±¡ï¼Œè½®èƒå¯¹è±¡æ”¾å…¥ä¸€ä¸ªæ± ä¸­ã€‚ è§£ææ±½è½¦éœ€è¦çš„æ‰€æœ‰é…ä»¶ å»æ± ä¸­æŸ¥æ‰¾é…ä»¶ï¼ŒæŠŠæ‰¾åˆ°çš„é…ä»¶èµ‹å€¼ä¸ºæ±½è½¦å¯¹åº”çš„å±æ€§,æ„é€ å‡ºä¸€è¾†æ–°æ±½è½¦ æŠŠæ„é€ å¥½çš„æ±½è½¦å¯¹è±¡æ”¾å…¥æ± ä¸­ è¿™é‡Œåšäº†ä¸€äº›ç®€åŒ–ï¼š\nè½¦é—´çŸ¥é“è¦å…ˆæ„å»ºå¼•æ“å¯¹è±¡,è½®èƒå¯¹è±¡ï¼Œç„¶åå†æ„å»ºæ±½è½¦å¯¹è±¡ å¼•æ“ä¸ä¾èµ–å…¶ä»–é…ä»¶ å¦‚æœå¼•æ“ä¾èµ–å¦å¤–çš„Aé…ä»¶ï¼Œè€ŒAé…ä»¶åˆä¾èµ–å¦å¤–çš„Bé…ä»¶ã€‚æˆ‘ä»¬æ˜¯ä¸æ˜¯è¦å…ˆæ„å»ºBé…ä»¶ï¼Œç„¶åå†æ„å»ºAé…ä»¶ï¼Œå†æ„å»ºå¼•æ“ã€‚æŒ‰ç…§è¿™ä¸ªå›ºå®šé¡ºåºæ‰å¯ä»¥æ­£å¸¸å·¥ä½œã€‚å¦‚æœçœŸæ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆè¿™ä¸ªè½¦é—´å¤ªè„†å¼±äº†ï¼Œå¤ªæ­»æ¿äº†ã€‚å¯ä»¥è®©è½¦é—´æ™ºèƒ½ä¸€ç‚¹ï¼Œåœ¨æ„å»ºæ±½è½¦å¯¹è±¡æ—¶ï¼Œå‘ç°æ±½è½¦ä¾èµ–å¼•æ“ï¼Œå°±å…ˆè®©æ±½è½¦ç­‰ä¸€ç­‰ï¼Œå…ˆæŠŠå¼•æ“æ„å»ºå‡ºæ¥ï¼Œåœ¨æ„å»ºå¼•æ“æ—¶ï¼Œå‘ç°å¼•æ“ä¾èµ–Aé…ä»¶ï¼Œå°±è®©å¼•æ“ç­‰ä¸€ç­‰ï¼Œå…ˆå»æ„å»ºAé…ä»¶ã€‚æ¯æ„é€ å‡ºä¸€ä¸ªå®Œæ•´çš„é…ä»¶ï¼Œå°±æŠŠè¿™ä¸ªé…ä»¶æ”¾å…¥æ± ä¸­ï¼Œä¸‹æ¬¡éœ€è¦æ—¶ç›´æ¥ä½¿ç”¨ã€‚\nä¸Šè¿°æ­¥éª¤å¯¹åº”åˆ°ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°±éœ€è¦è·å–ç±»ä¸­æœ‰å“ªäº›å­—æ®µï¼Œå­—æ®µçš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Œè¿™äº›éƒ½éœ€è¦é åå°„å®ç°ï¼Œå¦‚ä¸‹å®Œæ•´ç¤ºä¾‹:\n/** * ä¸œé£æ±½è½¦ */ class NissanCar{ private Engine engine; private Tyre tyre; void run(){ this.engine.outputPower(); this.tyre.turn(); System.out.println(\u0026#34;ä¸œé£æ±½è½¦å¼€è·‘\u0026#34;); } } /** * å¤§ä¼—æ±½è½¦ */ class VolkswagenCar{ private Engine engine; private Tyre tyre; void run(){ this.engine.outputPower(); this.tyre.turn(); System.out.println(\u0026#34;å¤§ä¼—æ±½è½¦å¼€è·‘\u0026#34;); } } // .... è¿˜æœ‰å‡ åç§å…¶ä»–å“ç‰Œçš„è½¦ã€‚ç”¨çš„éƒ½æ˜¯ V1 å¼•æ“ class EngineFactory { public static Engine get(){ return new EngineV2(); } } class TyreFactory { public static Tyre get(){ return new TyreV1(); } } /** * å¼•æ“æ¥å£ï¼Œè¾“å‡ºåŠ¨åŠ› */ interface Engine { void outputPower(); } class EngineV1 implements Engine { @Override public void outputPower() { System.out.println(\u0026#34;æˆ‘æ˜¯ Engine1\u0026#34;); } } class EngineV2 implements Engine { @Override public void outputPower() { System.out.println(\u0026#34;æˆ‘æ˜¯ Engine2\u0026#34;); } } /** * è½®èƒæ¥å£,å¯ä»¥è½¬åŠ¨j */ interface Tyre { void turn(); } class TyreV1 implements Tyre { @Override public void turn() { System.out.println(\u0026#34;æˆ‘æ˜¯ Tyre1\u0026#34;); } } /** * Author: dc * Date: 2022/11/4 16:03 **/ public class IocDemo { /** * å­˜æ”¾å®ä¾‹åŒ–çš„å¯¹è±¡ï¼Œkey ç±»ç±»åï¼Œvalue æ˜¯å¯¹è±¡ */ public static Map\u0026lt;String,Object\u0026gt; objectPool = new HashMap\u0026lt;\u0026gt;(); public static void buildObjectPool() throws InstantiationException, IllegalAccessException { // å°†å¾…å®ä¾‹åŒ–çš„ç±»æ·»åŠ åˆ°é›†åˆä¸­ // è¿™ä¸€æ­¥å¯ä»¥å†™ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£å®ç°ï¼ŒæŠŠæ‰€æœ‰éœ€è¦è‡ªåŠ¨åŒ–å®ä¾‹çš„ç±»ä¸Šé¢æ·»åŠ æˆ‘ä»¬è‡ªå®šä¹‰æ³¨è§£, ç„¶åæ‰«ææ‰€æœ‰ç±»ï¼ŒæŠŠåŒ…å«è¿™ä¸ªæ³¨è§£çš„ç±»æ·»åŠ åˆ°é›†åˆä¸­ List\u0026lt;Class\u0026lt;?\u0026gt;\u0026gt; classList = new ArrayList\u0026lt;\u0026gt;(); classList.add(NissanCar.class); classList.add(VolkswagenCar.class); classList.add(EngineV1.class); classList.add(EngineV2.class); classList.add(TyreV1.class); // æ‰€æœ‰ç±»æ˜¯å¦éƒ½å·²ç»å®ä¾‹åŒ– boolean okFlag = false; // éå†æ‰€æœ‰å¾…å®ä¾‹åŒ–çš„é›†åˆï¼Œé€ä¸€å®ä¾‹åŒ– // å¹¶ä¸èƒ½ä¸€æ¬¡å¾ªç¯å°±å¯ä»¥å…¨éƒ¨å®ä¾‹åŒ–å®Œæ¯•ï¼Œå‡å¦‚Aä¾èµ–B, ä½†æ˜¯Bè¿˜æ²¡æœ‰å®ä¾‹åŒ–ï¼Œæ‰€ä»¥Aæš‚æ—¶ä¹Ÿä¸èƒ½å®ä¾‹åŒ–ï¼Œç­‰ä¸‹ä¸€æ¬¡å¾ªç¯ï¼ŒB å®ä¾‹åŒ–åï¼Œå†å®ä¾‹åŒ–A // å¦‚æœ A ä¾èµ–B, B ä¾èµ–A, é‚£ä¹ˆåœ¨è¿™ä¸ªå¾ªç¯æ°¸è¿œä¸èƒ½ç»“æŸã€‚äº§ç”Ÿäº†å¾ªç¯ä¾èµ–ï¼Œè¿™é‡Œä»…åšç¤ºä¾‹ã€‚ä¸è€ƒè™‘å¾ªç¯ä¾èµ– while(!okFlag){ okFlag = true; for (Class\u0026lt;?\u0026gt; klass : classList) { // å¦‚æœè¿˜æ²¡æœ‰è¢«å®ä¾‹åŒ– if(!objectPool.containsKey(klass.getName())){ // åˆ©ç”¨åå°„ï¼Œå®ä¾‹åŒ–è¯¥ç±»ã€‚ å¦‚æœklassæœ‰å…¶ä»–æœªå®ä¾‹åŒ–çš„ä¾èµ–ï¼Œo ç­‰äº null Object o = getInstance(klass); if(o != null){ // ç±»åä½œä¸º key objectPool.put(klass.getSimpleName(), o); // å¦‚æœè¯¥ç±»å®ç°äº†ä¸€äº›æ¥å£ï¼Œé‚£ä¹ˆæ¥å£å¯¹åº”çš„å®ä¾‹ä¹Ÿæ˜¯è¯¥ç±»çš„å®ä¾‹ for (Class\u0026lt;?\u0026gt; klassInterface : klass.getInterfaces()) { objectPool.put(klassInterface.getSimpleName(), o); } }else{ // è¿˜å­˜åœ¨æ²¡æœ‰å®ä¾‹åŒ–çš„ç±»ï¼Œä¸èƒ½ç»“æŸ okFlag = false; } } } } } private static Object getInstance(Class\u0026lt;?\u0026gt; klass) throws IllegalAccessException, InstantiationException { // new ä¸€ä¸ªç©ºå¯¹è±¡ Object o = klass.newInstance(); String beanName = \u0026#34;\u0026#34;; // ä¸ºå¯¹è±¡ä¸­çš„æ‰€æœ‰å­—æ®µèµ‹å€¼ for (Field field : klass.getDeclaredFields()) { // è·å–å­—æ®µçš„ç±»å‹ beanName = field.getType().getSimpleName(); // æ‰€ä¾èµ–çš„å­—æ®µçš„å®ä¾‹æš‚æ—¶åœ¨å¯¹è±¡æ± ä¸­æ‰¾ä¸åˆ°,æš‚ä¸å®ä¾‹åŒ– if(!objectPool.containsKey(beanName)){ return null; } // è®¾ç½®ç§æœ‰å˜é‡å¯ä»¥è®¿é—® field.setAccessible(true); // ä»å¯¹è±¡æ± ä¸­è·å–è¯¥å­—æ®µçš„å®ä¾‹ Object value = objectPool.get(beanName); // ä¸ºå­—æ®µèµ‹å€¼ field.set(o,value); } return o; } public static void main(String[] args) throws InstantiationException, IllegalAccessException { buildObjectPool(); /** * é€šè¿‡ç±»å‹å‘å®¹å™¨ä¸­å–å¯¹è±¡ï¼Œå¯¹è±¡ä¸­çš„æ‰€æœ‰ä¾èµ–å·²ç»è‡ªåŠ¨å¤„ç†å®Œæ¯•ã€‚ */ NissanCar nissanCar = (NissanCar)objectPool.get(\u0026#34;NissanCar\u0026#34;); nissanCar.run(); VolkswagenCar volkswagenCar = (VolkswagenCar) objectPool.get(\u0026#34;VolkswagenCar\u0026#34;); volkswagenCar.run(); } } ç»“æœ:\næˆ‘æ˜¯ Engine2 æˆ‘æ˜¯ Tyre1 ä¸œé£æ±½è½¦å¼€è·‘ æˆ‘æ˜¯ Engine2 æˆ‘æ˜¯ Tyre1 å¤§ä¼—æ±½è½¦å¼€è·‘ åœ¨ mainæ–¹æ³•ä¸­ï¼Œä»¥åŠå„ç§carç±»ä¸­ï¼Œéƒ½æ²¡æœ‰ä½¿ç”¨newå…³é”®è¯æ„å»ºå¯¹è±¡ï¼Œè€Œæ˜¯é åå°„æŠ€æœ¯ï¼Œè‡ªåŠ¨è§£æå„ç±»ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œèµ‹å€¼ã€‚ä»è€ŒæŠŠä¸€ä¸ªä¸ªå®Œæ•´å¯¹è±¡æ”¾å…¥å¯¹è±¡æ± ã€‚\nä¸Šé¢çš„ä»£ç åªæ˜¯ç®€å•çš„ç¤ºä¾‹ï¼Œå¾ˆå¤šé—®é¢˜æ²¡æœ‰è§£å†³ï¼Œå¦‚ å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œå®ä¾‹å†²çªé—®é¢˜(ä¸€ä¸ªæ¥å£å¤šä¸ªå®ç°ç±»çš„)ã€‚è™½ç„¶æ¯”è¾ƒç®€é™‹ï¼Œä½†æ˜¯ä¹Ÿè¶³ä»¥å±•ç°è‡ªåŠ¨åŒ–é…ç½®çš„æ€è·¯äº†ã€‚\nå†è°ˆIoC åœ¨æœ€å¼€å§‹ï¼Œç›´æ¥åœ¨æ±½è½¦çš„æ„é€ æ–¹æ³•ä¸­ new å‡ºæ¥æ‰€æœ‰ä¾èµ–çš„é…ä»¶ï¼Œè¿™æ˜¯æ±½è½¦ä¸»åŠ¨æ„å»ºé…ä»¶ï¼Œå¦‚æœæŸä¸ªé…ä»¶å‘ç”Ÿå˜åŒ–ï¼Œæ‰€æœ‰æ±½è½¦éƒ½åœ¨åšå‡ºæ”¹å˜ã€‚\nåæ¥æŠŠæ±½è½¦ä¸»åŠ¨æ„å»ºé…ä»¶æ­¥éª¤äº¤ç»™ä¸€ä¸ªä¸ªçš„é…ä»¶å·¥å‚ï¼Œå¦‚æœæŸä¸ªé…ä»¶å‘ç”Ÿå˜åŒ–ï¼Œç›´æ¥æ”¹åŠ¨å¯¹åº”çš„å·¥å‚å°±è¡Œäº†ã€‚\nä¸Šé¢è¿™ä¸¤ç§æ–¹æ³•éƒ½ä¼šéšç€é…ä»¶çš„å¢åŠ ï¼Œå¯¼è‡´æ¨¡æ¿ä»£ç è¶Šæ¥è¶Šå¤šã€‚å¦‚æœæœ‰ä¸Šåƒä¸ªé…ä»¶ï¼Œå¯¹äº1ï¼šè¦åœ¨æ„é€ æ–¹æ³•ä¸­ä¸€ä¸ªä¸ªæ„é€ å‡ºé…ä»¶ï¼Œç„¶åèµ‹å€¼ç»™æ±½è½¦å¯¹åº”çš„å­—æ®µã€‚å¯¹äº2: è™½ç„¶æŠŠé…ä»¶çš„æ„é€ æ­¥éª¤è½¬ç§»åˆ°å·¥å‚æ–¹æ³•ä¸­ï¼Œé¿å…äº†å¤§æ‰¹é‡æ”¹åŠ¨ä»£ç çš„é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬è¦å†™å¾ˆå¤šä¸ªå·¥å‚æ–¹æ³•ï¼Œå·¥å‚æ–¹æ³•å†…å®¹éƒ½å·®ä¸å¤šã€‚ å¦‚æœæˆ‘ä»¬å†å¼€å‘å…¶ä»–ç³»ç»Ÿï¼Œæ±½è½¦ç³»ç»Ÿä¸­æ‰€æœ‰å·¥å‚æ–¹æ³•éƒ½ä¸èƒ½å¤ç”¨ã€‚\næœ€åæˆ‘ä»¬åˆ¶é€ äº†ä¸€ä¸ªæ™ºèƒ½è½¦é—´(buildObjectPool)ï¼Œåªéœ€æŠŠæ‰€æœ‰æ±½è½¦ï¼Œé…ä»¶çš„ç±»å‘Šè¯‰è¿™ä¸ªè½¦é—´ï¼Œè½¦é—´å°±ä¼šè‡ªåŠ¨ç»´æŠ¤ä»–ä»¬çš„ä¾èµ–å…³ç³»ï¼Œåˆ›å»ºå¥½å„ä¸ªå¯¹è±¡æ”¾å…¥æ± ä¸­(objectPool)ï¼Œç­‰å¾…æˆ‘ä»¬ä½¿ç”¨ã€‚åŒæ—¶è¿™ä¸ªè½¦é—´æ²¡æœ‰ä»»ä½•ç±»å‹ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒä¸åŠ æ”¹åŠ¨çš„ç”¨äºä»»ä½•ç³»ç»Ÿã€‚ æŠŠ1ã€2 å’Œ 3 è¿›è¡Œæ¯”è¾ƒï¼Œå‘ç°æœ€å¤§çš„ä¸åŒåœ¨äºï¼šå¯¹è±¡çš„ä¾èµ–å…³ç³»æœ¬æ¥ç”±å¯¹è±¡è‡ªå·±è§£å†³å˜æˆäº†ç”±å¤–éƒ¨å·¥å…·è§£å†³\nè¿™å°±æ˜¯ IoC çš„æ€æƒ³, ä¸Šé¢æˆ‘ä»¬å†™çš„ buildObjectPool å·¥å…·ï¼Œå°±æ˜¯ IoC æ€æƒ³çš„ç®€å•å®ç°ï¼Œ æ›´å‡ºåçš„ä¸€ä¸ªIoCæ€æƒ³çš„æŠ€æœ¯å®ç°æ˜¯â€”â€”ä¾èµ–æ³¨å…¥(DI)\nåˆ‡è®° IoC ä¸æ˜¯æŠ€æœ¯ï¼Œ å®ƒæ˜¯ä¸€ç§æ€æƒ³ï¼Œä¸€ä¸ªé‡è¦çš„é¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ³•åˆ™ï¼Œå®ƒèƒ½æŒ‡å¯¼æˆ‘ä»¬å¦‚ä½•è®¾è®¡å‡ºæ¾è€¦åˆã€æ›´ä¼˜è‰¯çš„ç¨‹åºã€‚ä¼ ç»Ÿåº”ç”¨ç¨‹åºéƒ½æ˜¯ç”±æˆ‘ä»¬åœ¨ç±»å†…éƒ¨ä¸»åŠ¨åˆ›å»ºä¾èµ–å¯¹è±¡ï¼Œä»è€Œå¯¼è‡´ç±»ä¸ç±»ä¹‹é—´é«˜è€¦åˆï¼Œéš¾äºæµ‹è¯•ï¼›æœ‰äº†IoCå®¹å™¨åï¼ŒæŠŠåˆ›å»ºå’ŒæŸ¥æ‰¾ä¾èµ–å¯¹è±¡çš„æ§åˆ¶æƒäº¤ç»™äº†å®¹å™¨ï¼Œç”±å®¹å™¨è¿›è¡Œæ³¨å…¥ç»„åˆå¯¹è±¡ï¼Œæ‰€ä»¥å¯¹è±¡ä¸å¯¹è±¡ä¹‹é—´æ˜¯æ¾æ•£è€¦åˆï¼Œè¿™æ ·ä¹Ÿæ–¹ä¾¿æµ‹è¯•ï¼Œåˆ©äºåŠŸèƒ½å¤ç”¨ï¼Œæ›´é‡è¦çš„æ˜¯ä½¿å¾—ç¨‹åºçš„æ•´ä¸ªä½“ç³»ç»“æ„å˜å¾—éå¸¸çµæ´»ã€‚\nå…¶å®IoCå¯¹ç¼–ç¨‹å¸¦æ¥çš„æœ€å¤§æ”¹å˜ä¸æ˜¯ä»ä»£ç ä¸Šï¼Œè€Œæ˜¯ä»æ€æƒ³ä¸Šï¼Œå‘ç”Ÿäº†â€œä¸»ä»æ¢ä½â€çš„å˜åŒ–ã€‚åº”ç”¨ç¨‹åºåŸæœ¬æ˜¯è€å¤§ï¼Œè¦è·å–ä»€ä¹ˆèµ„æºéƒ½æ˜¯ä¸»åŠ¨å‡ºå‡»ï¼Œä½†æ˜¯åœ¨IoC/DIæ€æƒ³ä¸­ï¼Œåº”ç”¨ç¨‹åºå°±å˜æˆè¢«åŠ¨çš„äº†ï¼Œè¢«åŠ¨çš„ç­‰å¾…IoCå®¹å™¨æ¥åˆ›å»ºå¹¶æ³¨å…¥å®ƒæ‰€éœ€è¦çš„èµ„æºäº†ã€‚\nIoCå¾ˆå¥½çš„ä½“ç°äº†é¢å‘å¯¹è±¡è®¾è®¡æ³•åˆ™ä¹‹ä¸€â€”â€” å¥½è±åæ³•åˆ™ï¼šâ€œåˆ«æ‰¾æˆ‘ä»¬ï¼Œæˆ‘ä»¬æ‰¾ä½ â€ï¼›å³ç”±IoCå®¹å™¨å¸®å¯¹è±¡æ‰¾ç›¸åº”çš„ä¾èµ–å¯¹è±¡å¹¶æ³¨å…¥ï¼Œè€Œä¸æ˜¯ç”±å¯¹è±¡ä¸»åŠ¨å»æ‰¾ã€‚\nå…³äºæ›´å¤šçš„ IoC æ¦‚å¿µï¼Œå‚è€ƒ:\nç»´åŸºç™¾ç§‘ ç™¾åº¦ç™¾ç§‘ ","date":"2022-11-04T15:49:47Z","permalink":"https://dccmmtop.github.io/posts/ioc%E6%80%9D%E6%83%B3%E8%AE%B2%E8%A7%A3%E5%92%8C%E5%AE%9E%E7%8E%B0/","section":"posts","tags":["java"],"title":"IoC æ€æƒ³å’Œå®ç°"},{"categories":null,"contents":"æ³¨è§£ä¹Ÿè¢«ç§°ä¸ºå…ƒæ•°æ®ï¼Œå®ƒä¸ºæˆ‘ä»¬åœ¨ä»£ç ä¸­æ·»åŠ ä¿¡æ¯æä¾›äº†ä¸€ç§å½¢å¼åŒ–çš„æ–¹æ³•ï¼Œä½¿æˆ‘ä»¬å¯ä»¥åœ¨ç¨åæŸä¸ªæ—¶åˆ»éå¸¸æ–¹ä¾¿çš„ä½¿ç”¨è¿™äº›æ•°æ®ã€‚\næ³¨è§£æ˜¯å—c#å¯å‘ï¼Œåœ¨ javaSE5 ä¸­å¼•å…¥çš„ï¼Œè™½ç„¶javaSE5 é¢„å…ˆå®šä¹‰äº†ä¸€äº›æ³¨è§£ï¼Œä½†ä¸€èˆ¬æ¥è¯´ï¼Œä¸»è¦è¿˜æ˜¯ç¨‹åºå‘˜æ·»åŠ æ–°çš„æ³¨è§£ï¼Œå¹¶æŒ‰è‡ªå·±çš„æ–¹å¼ä½¿ç”¨ä»–ä»¬ã€‚\nå†…ç½®æ³¨è§£ java SE5 å†…ç½®äº†ä¸‰ç§æ³¨è§£ï¼š\n@Override, è¡¨ç¤ºå½“å‰çš„æ–¹æ³•è¦†ç›–è¶…ç±»ä¸­çš„æ–¹æ³•ã€‚å¦‚æœæ‹¼å†™é”™è¯¯ï¼Œæˆ–è€…æ–¹æ³•ç­¾åå¯¹ä¸ä¸Šè¢«è¦†ç›–çš„æ–¹æ³•ï¼Œç¼–è¯‘å™¨å°±ä¼šå‘å‡ºé”™è¯¯æç¤ºï¼Œ @Deprecated, æ ‡è®°æ–¹æ³•è¢«å¼ƒç”¨äº†ï¼Œå¦‚æœä½¿ç”¨äº†è¢«å®ƒæ ‡è®°çš„å…ƒç´ ï¼Œç¼–è¯‘å™¨ä¼šå‘å‡ºè­¦å‘Šä¿¡æ¯ @SuppressWarnings, å…³é—­ä¸å½“çš„ç¼–è¯‘å™¨è­¦å‘Šä¿¡æ¯ã€‚ ä¹‹å¤–ï¼Œjavaè¿˜æä¾›äº†å››ç§æ³¨è§£ï¼Œä¸“é—¨è´Ÿè´£æ–°æ³¨è§£çš„åˆ›å»ºï¼Œä¹Ÿè¢«ç§°ä¸ºå…ƒæ³¨è§£ã€‚\nå…ƒæ³¨è§£ @Target ç”¨æ¥å®šä¹‰ä½ çš„æ³¨è§£å°†ç”¨äºä»€ä¹ˆåœ°æ–¹ï¼Œä¾‹å¦‚ç”¨åœ¨æ–¹æ³•ä¸Šï¼Œç±»ä¸Š è¿˜æ˜¯å­—æ®µä¸Šç­‰ï¼Œ ä½¿ç”¨æ–¹å¼ï¼š @Target(ElementType.METHOD), å…¶ä¸­ ElementType çš„å–å€¼æœ‰ä¸‹é¢å‡ ç§:\nCONSTRUCTOR æ„é€ å™¨ FIELD åŸŸï¼Œ åŒ…æ‹¬ enum çš„å®ä¾‹ LOCAL_VARIABLE å±€éƒ¨å˜é‡ METHOD æ–¹æ³•ä¸Š PACKAGE åŒ… PAEAMETER å‚æ•° TYPE ç±»ï¼Œ æ¥å£ï¼ŒåŒ…æ‹¬æ³¨è§£ç±»å‹ æˆ– enum @Retention è¡¨ç¤ºåœ¨ä»€ä¹ˆçº§åˆ«ä¿å­˜è¯¥æ³¨è§£çš„ä¿¡æ¯ï¼Œä¾‹å¦‚æºç ä¸­ï¼Œç±»æ–‡ä»¶ä¸­ï¼Œæˆ–è€…è¿è¡Œæ—¶ï¼Œä½¿ç”¨æ–¹å¼ï¼š @Retention(RetentionPolicy.RUNTIME), å…¶ä¸­ RetentionPolicy çš„å–å€¼æœ‰ï¼š\nSOURCE æ³¨è§£å°†è¢«ç¼–è¯‘å™¨ä¸¢å¼ƒ CLASS æ³¨è§£åœ¨classæ–‡ä»¶ä¸­å¯ç”¨ï¼Œä½†ä¼šè¢« JVM ä¸¢å¼ƒ RUNTIME JVM åœ¨è¿è¡ŒæœŸä¹Ÿä¿ç•™æ³¨è§£ï¼Œå› æ­¤å¯ä»¥é€šè¿‡åå°„æœºåˆ¶è¯»å–æ³¨è§£ä¿¡æ¯ @Documented å°†æ­¤æ³¨è§£åŒ…å«åœ¨ javadocä¸­\n@Inherited å…è®¸å­ç±»ç»§æ‰¿çˆ¶ç±»ä¸­çš„æ³¨è§£\nç¼–å†™æ³¨è§£ ä¸€ä¸ªæ³¨è§£å¾—ä»¥å·¥ä½œè¦æœ‰ä¸‰ä¸ªè¦ç´ ï¼š\nå®šä¹‰æ³¨è§£ ä½¿ç”¨æ³¨è§£ æ³¨è§£å¤„ç†å™¨ ä¸‹é¢ç”¨ä¸€ä¸ªå¯¹è±¡/å…³ç³»æ˜ å°„åŠŸèƒ½ ORMçš„ç®€å•ä¾‹å­æ¥å±•ç°å¦‚ä½•ç¼–å†™è‡ªå®šä¹‰æ³¨è§£ï¼š\n@DBTable å°†æ­¤æ³¨è§£ç”¨äº JavaBean ä¸Šï¼Œä»¥ä¾¿ç”Ÿæˆä¸€ä¸ªæ•°æ®åº“è¡¨ @Constrainsæ­¤æ³¨è§£ç”¨äºå­—æ®µä¸Šï¼Œæè¿°è¯¥å­—æ®µæœ‰ä¸€äº›çº¦æŸï¼Œæ¯”å¦‚ä¸èƒ½ä¸ºç©ºï¼Œè¦å”¯ä¸€ç­‰ @SQLString å°†æ­¤æ³¨è§£ç”¨äºå­—æ®µä¸Šï¼Œä¼šç”Ÿæˆä¸€ä¸ª varchar ç±»å‹çš„åˆ— @SQLInt å°†æ­¤æ³¨è§£ç”¨äºå­—æ®µä¸Šï¼Œä¼šç”Ÿæˆä¸€ä¸ª int ç±»å‹çš„åˆ— å®šä¹‰æ³¨è§£ /** * æ³¨è§£å®šä¹‰ */ @Target(ElementType.TYPE) @Retention(RetentionPolicy.RUNTIME) public @interface DBTable{ // è¡¨å, è§„å®šï¼šå¿…é¡»è¦æœ‰ä¸€ä¸ªé»˜è®¤å€¼ï¼Œ String name() default \u0026#34;\u0026#34;; } /** * å­—æ®µçš„çº¦æŸ */ @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) public @interface Constraints{ // æ˜¯å¦æ˜¯ä¸»é”® boolean primary() default false; // æ˜¯å¦å¯ä»¥ä¸ºç©º boolean allowNull() default true; // æ˜¯å¦å”¯ä¸€ boolean unique() default false; } /** * ç”Ÿæˆ varchar ç±»å‹çš„åˆ— */ @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) public @interface SQLString{ /** * è®©valueä»£è¡¨ varcharçš„é•¿åº¦ï¼Œvalue æ˜¯ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„åå­—ï¼Œåœ¨ä½¿ç”¨è¯¥æ³¨è§£çš„æ—¶å€™ï¼Œ * å¦‚æœè¯¥å…ƒç´ æ˜¯å”¯ä¸€éœ€è¦èµ‹å€¼çš„å…ƒç´ ã€‚é‚£ä¹ˆå¯ä»¥ç®€å†™ï¼Œæ— éœ€ä½¿ç”¨ åâ€”â€”â€”å€¼ è¯­æ³•ï¼Œè€Œæ˜¯ * @SQLString(30) */ int value() default 0; // åˆ—çš„åå­— String name() default \u0026#34;\u0026#34;; } /** * ç”Ÿæˆ int ç±»å‹çš„åˆ— */ @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) public @interface SQLInt{ // åˆ—çš„åå­— String name() default \u0026#34;\u0026#34;; } æ³¨è§£çš„ä½¿ç”¨ /** * æ³¨è§£ä½¿ç”¨ */ @DBTable(name = \u0026#34;users\u0026#34;)// è¡¨åæ˜¯useres public class User { /** * è®¾ç½®idæ˜¯ä¸»é”®ï¼Œå”¯ä¸€ï¼Œ ä¸èƒ½ä¸ºç©º */ @Constraints(primary = true, allowNull = false, unique = true) @SQLInt private int id; @SQLInt private int age; @SQLString(20) private String name; public int getId() { return id; } public void setId(int id) { this.id = id; } public int getAge() { return age; } public void setAge(int age) { this.age = age; } public String getName() { return name; } public void setName(String name) { this.name = name; } } æ³¨è§£å¤„ç†å™¨ /** * æ³¨è§£å¤„ç†å™¨ */ public class TableCreator{ public String createTableSQLString(Class\u0026lt;?\u0026gt; cl) { // è·å–ç±»ä¸Šçš„ DBTable æ³¨è§£ DBTable table = cl.getAnnotation(DBTable.class); if(table == null) { return \u0026#34;\u0026#34;; } // è·å– DBTable æ³¨è§£ä¸­çš„ name å‚æ•° String tableName = table.name(); // ä¿å­˜æ‰€æœ‰åˆ—å List\u0026lt;String\u0026gt; columnNameList = new ArrayList\u0026lt;String\u0026gt;(); // åå°„çš„æ–¹å¼éå†ç±»ä¸­çš„å­—æ®µ for (Field field : cl.getDeclaredFields()) { // åˆ—å String columnName = \u0026#34;\u0026#34;; // éå†å­—æ®µä¸Šçš„æ³¨è§£ for (Annotation annotation : field.getAnnotations()) { // å¦‚æœåŒ…å« SQLInt æ³¨è§£ if(annotation instanceof SQLInt) { SQLInt sint = (SQLInt) annotation; if(sint.name().length() == 0) { columnName = field.getName().toLowerCase(); }else{ // å¦‚æœæ²¡æœ‰è®¾ç½®nameå±æ€§ï¼Œå°±ç”¨å­—æ®µåä½œä¸ºåˆ—å columnName = sint.name(); } columnName += \u0026#34; INT\u0026#34;; // è·å–å­—æ®µä¸Šçš„çº¦æŸç±»å‹çš„æ³¨è§£ Constraints con = field.getAnnotation(Constraints.class); columnName += buildConstraints(con); // å¦åˆ™æ£€æŸ¥æ˜¯å¦åŒ…å« @SQLString æ³¨è§£ }else if(annotation instanceof SQLString) { SQLString sString = (SQLString) annotation; if(sString.name().length() == 0) { columnName = field.getName().toLowerCase(); }else{ // å¦‚æœæ²¡æœ‰è®¾ç½®nameå±æ€§ï¼Œå°±ç”¨å­—æ®µåä½œä¸ºåˆ—å columnName = sString.name(); } // è·å–å­—æ®µé•¿åº¦å±æ€§ columnName += \u0026#34; VARCHAR(\u0026#34; + sString.value() + \u0026#34;)\u0026#34;; // è·å–å­—æ®µä¸Šçš„çº¦æŸç±»å‹çš„æ³¨è§£ Constraints con = field.getAnnotation(Constraints.class); columnName += buildConstraints(con); } } columnNameList.add(columnName); } StringBuilder createConmmand = new StringBuilder(\u0026#34;\u0026#34;); createConmmand.append(\u0026#34;CREATE TABLE \u0026#34;).append(tableName).append(\u0026#34;(\u0026#34;); int length = columnNameList.size(); for (int i = 0; i \u0026lt; length; i ++) { createConmmand.append(\u0026#34;\\n \u0026#34;).append(columnNameList.get(i)); if(i != length -1){ createConmmand.append(\u0026#34;,\u0026#34;); } } createConmmand.append(\u0026#34;);\u0026#34;); return createConmmand.toString(); } public String buildConstraints(Constraints con){ if(con == null) { return \u0026#34;\u0026#34;; } if(!con.allowNull()){ return \u0026#34; NOT NULL\u0026#34;; } if(con.primary()){ return \u0026#34; PRIMARY KEY\u0026#34;; } if(con.unique()) { return \u0026#34; UNIQUE\u0026#34;; } return \u0026#34;\u0026#34;; } } public class AnnotationDemo { public static void main(String[] args) throws ClassNotFoundException { Class\u0026lt;?\u0026gt; userClass = Class.forName(\u0026#34;io.dc.User\u0026#34;); String sql = new TableCreator().createTableSQLString(userClass); // ç›´æ¥ä¸‹é¢çš„ä¹Ÿè¡Œ // String sql = new TableCreator().createTableSQLString(User.class); System.out.println(sql); } } æ³¨è§£ä½¿ç”¨æ³¨æ„ ä¸åŒæ³¨è§£å¯ä»¥ç»„åˆä½¿ç”¨ï¼Œä½†åŒç±»å‹çš„æ³¨è§£ä¸èƒ½é‡å¤ä½¿ç”¨ ç›®å‰æ³¨è§£ä¸æ”¯æŒç»§æ‰¿ æ³¨è§£ä¸­çš„å±æ€§ä¸èƒ½ä¸º null, æœ¬ä¾‹ä¸­çš„ @SQLString name() ä¸èƒ½ä¸º null, å¿…é¡»è®¾ç½® default æ³¨è§£å…ƒç´ åªèƒ½ä¸€ä¸‹å‡ ç§,å¦åˆ™ç¼–è¯‘å™¨ä¼šæŠ¥é”™ æ‰€æœ‰åŸºæœ¬ç±»å‹(int, float, boolean ç­‰) String Class enum Annotation ä»¥ä¸Šç±»å‹çš„æ•°ç»„ å®Œæ•´ä»£ç  ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼ŒæŠŠæ‰€æœ‰ç±»éƒ½æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­äº†ï¼š\npackage io.dc; import java.lang.annotation.*; import java.lang.reflect.Field; import java.util.ArrayList; import java.util.List; /** * æ³¨è§£å®šä¹‰ */ @Target(ElementType.TYPE) @Retention(RetentionPolicy.RUNTIME) @interface DBTable{ // è¡¨å, è§„å®šï¼šå¿…é¡»è¦æœ‰ä¸€ä¸ªé»˜è®¤å€¼ï¼Œ String name() default \u0026#34;\u0026#34;; } /** * å­—æ®µçš„çº¦æŸ */ @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) @interface Constraints{ // æ˜¯å¦æ˜¯ä¸»é”® boolean primary() default false; // æ˜¯å¦å¯ä»¥ä¸ºç©º boolean allowNull() default true; // æ˜¯å¦å”¯ä¸€ boolean unique() default false; } /** * ç”Ÿæˆ varchar ç±»å‹çš„åˆ— */ @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) @interface SQLString{ /** * è®©valueä»£è¡¨ varcharçš„é•¿åº¦ï¼Œvalue æ˜¯ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„åå­—ï¼Œåœ¨ä½¿ç”¨è¯¥æ³¨è§£çš„æ—¶å€™ï¼Œ * å¦‚æœè¯¥å…ƒç´ æ˜¯å”¯ä¸€éœ€è¦èµ‹å€¼çš„å…ƒç´ ã€‚é‚£ä¹ˆå¯ä»¥ç®€å†™ï¼Œæ— éœ€ä½¿ç”¨ åâ€”â€”â€”å€¼ è¯­æ³•ï¼Œè€Œæ˜¯ * @SQLString(30) */ int value() default 0; // åˆ—çš„åå­— String name() default \u0026#34;\u0026#34;; } /** * ç”Ÿæˆ int ç±»å‹çš„åˆ— */ @Target(ElementType.FIELD) @Retention(RetentionPolicy.RUNTIME) @interface SQLInt{ // åˆ—çš„åå­— String name() default \u0026#34;\u0026#34;; } /** * æ³¨è§£ä½¿ç”¨ */ @DBTable(name = \u0026#34;users\u0026#34;)// è¡¨åæ˜¯useres class User { /** * è®¾ç½®idæ˜¯ä¸»é”®ï¼Œå”¯ä¸€ï¼Œ ä¸èƒ½ä¸ºç©º */ @Constraints(primary = true, allowNull = false, unique = true) @SQLInt private int id; @SQLInt private int age; @SQLString(20) private String name; public int getId() { return id; } public void setId(int id) { this.id = id; } public int getAge() { return age; } public void setAge(int age) { this.age = age; } public String getName() { return name; } public void setName(String name) { this.name = name; } } /** * æ³¨è§£å¤„ç†å™¨ */ class TableCreator{ public String createTableSQLString(Class\u0026lt;?\u0026gt; cl) { // è·å–ç±»ä¸Šçš„ DBTable æ³¨è§£ DBTable table = cl.getAnnotation(DBTable.class); if(table == null) { return \u0026#34;\u0026#34;; } // è·å– DBTable æ³¨è§£ä¸­çš„ name å‚æ•° String tableName = table.name(); // ä¿å­˜æ‰€æœ‰åˆ—å List\u0026lt;String\u0026gt; columnNameList = new ArrayList\u0026lt;String\u0026gt;(); // åå°„çš„æ–¹å¼éå†ç±»ä¸­çš„å­—æ®µ for (Field field : cl.getDeclaredFields()) { // åˆ—å String columnName = \u0026#34;\u0026#34;; // éå†å­—æ®µä¸Šçš„æ³¨è§£ for (Annotation annotation : field.getAnnotations()) { // å¦‚æœåŒ…å« SQLInt æ³¨è§£ if(annotation instanceof SQLInt) { SQLInt sint = (SQLInt) annotation; if(sint.name().length() == 0) { columnName = field.getName().toLowerCase(); }else{ // å¦‚æœæ²¡æœ‰è®¾ç½®nameå±æ€§ï¼Œå°±ç”¨å­—æ®µåä½œä¸ºåˆ—å columnName = sint.name(); } columnName += \u0026#34; INT\u0026#34;; // è·å–å­—æ®µä¸Šçš„çº¦æŸç±»å‹çš„æ³¨è§£ Constraints con = field.getAnnotation(Constraints.class); columnName += buildConstraints(con); // å¦åˆ™æ£€æŸ¥æ˜¯å¦åŒ…å« @SQLString æ³¨è§£ }else if(annotation instanceof SQLString) { SQLString sString = (SQLString) annotation; if(sString.name().length() == 0) { columnName = field.getName().toLowerCase(); }else{ // å¦‚æœæ²¡æœ‰è®¾ç½®nameå±æ€§ï¼Œå°±ç”¨å­—æ®µåä½œä¸ºåˆ—å columnName = sString.name(); } // è·å–å­—æ®µé•¿åº¦å±æ€§ columnName += \u0026#34; VARCHAR(\u0026#34; + sString.value() + \u0026#34;)\u0026#34;; // è·å–å­—æ®µä¸Šçš„çº¦æŸç±»å‹çš„æ³¨è§£ Constraints con = field.getAnnotation(Constraints.class); columnName += buildConstraints(con); } } columnNameList.add(columnName); } StringBuilder createConmmand = new StringBuilder(\u0026#34;\u0026#34;); createConmmand.append(\u0026#34;CREATE TABLE \u0026#34;).append(tableName).append(\u0026#34;(\u0026#34;); int length = columnNameList.size(); for (int i = 0; i \u0026lt; length; i ++) { createConmmand.append(\u0026#34;\\n \u0026#34;).append(columnNameList.get(i)); if(i != length -1){ createConmmand.append(\u0026#34;,\u0026#34;); } } createConmmand.append(\u0026#34;);\u0026#34;); return createConmmand.toString(); } public String buildConstraints(Constraints con){ if(con == null) { return \u0026#34;\u0026#34;; } if(!con.allowNull()){ return \u0026#34; NOT NULL\u0026#34;; } if(con.primary()){ return \u0026#34; PRIMARY KEY\u0026#34;; } if(con.unique()) { return \u0026#34; UNIQUE\u0026#34;; } return \u0026#34;\u0026#34;; } } public class AnnotationDemo { public static void main(String[] args) throws ClassNotFoundException { Class\u0026lt;?\u0026gt; userClass = Class.forName(\u0026#34;io.dc.User\u0026#34;); String sql = new TableCreator().createTableSQLString(userClass); // ç›´æ¥ä¸‹é¢çš„ä¹Ÿè¡Œ // String sql = new TableCreator().createTableSQLString(User.class); System.out.println(sql); } } ç»“æœ:\nCREATE TABLE users( id INT NOT NULL, age INT, name VARCHAR(20)); Process finished with exit code 0 ","date":"2022-11-03T10:56:39Z","permalink":"https://dccmmtop.github.io/posts/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3/","section":"posts","tags":["java"],"title":"è‡ªå®šä¹‰æ³¨è§£"},{"categories":null,"contents":"ä»£ç†æ˜¯åŸºæœ¬çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œä½¿ç”¨ä»£ç†å¯¹è±¡ä»£æ›¿çœŸå®å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ï¼Œå¯ä»¥æ‰©å±•çœŸå®å¯¹è±¡æŸäº›æ–¹æ³•çš„åŠŸèƒ½ã€‚\nåœ¨ java ä¸­åˆåˆ†ä¸ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†, å…ˆçœ‹é™æ€ä»£ç†:\né™æ€ä»£ç† public class DynamicDemo { public static void main(String[] args) { /** * é™æ€ä»£ç†ç¤ºä¾‹ */ System.out.println(\u0026#34;=======é™æ€ä»£ç†========\u0026#34;); // user çœŸå®å¯¹è±¡ Save user = new UserDAO(); // userTransaction æ˜¯ä»£ç†å¯¹è±¡ Save userTransaction = new UserTransaction(user); // ä½¿ç”¨ä»£ç†å¯¹è±¡æ‰§è¡Œæ–¹æ³• userTransaction.save(\u0026#34;dc1\u0026#34;); } } interface Save { /** * ä¿å­˜ */ void save(String name); /** * åˆ é™¤ * @param name */ void delete(String name); } class UserDAO implements Save { public void save(String name) { System.out.println(\u0026#34;çœŸå®å¯¹è±¡æ‰§è¡Œ save æ–¹æ³•\u0026#34;); } public void delete(String name) { System.out.println(\u0026#34;çœŸå®å¯¹è±¡æ‰§è¡Œ delete æ–¹æ³•\u0026#34;); } } /** * æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±» */ class UserTransaction implements Save { /** * çœŸå®å¯¹è±¡ */ private Save realObject; UserTransaction(Save save) { this.realObject = save; } /** * åœ¨çœŸå®å¯¹è±¡å‰ååšä¸€äº›æ“ä½œ */ public void save(String name) { System.out.println(\u0026#34;é™æ€ä»£ç†ï¼š åœ¨çœŸå®å¯¹è±¡åšäº‹ä¹‹å‰ï¼Œä»£ç†è¦åšçš„äº‹æƒ…\u0026#34;); // çœŸå®å¯¹è±¡å¼€å§‹æ‰§è¡Œsaveæ–¹æ³• realObject.save(name); System.out.println(\u0026#34;é™æ€ä»£ç†ï¼š åœ¨çœŸå®å¯¹è±¡åšäº‹ä¹‹åï¼Œä»£ç†è¦åšçš„äº‹æƒ…\u0026#34;); } public void delete(String name) { /** * ä»€ä¹ˆéƒ½ä¸åšï¼Œç›´æ¥æ‰§è¡ŒçœŸå®å¯¹è±¡çš„ delete æ–¹æ³•ã€‚ * è¿™é‡Œå°±ä½“ç°äº†é™æ€ä»£ç†æ–¹å¼çš„å¼Šç«¯ï¼Œå“ªæ€•æˆ‘åªæƒ³ä»£ç†ä¸€ä¸ªæ–¹æ³•ï¼Œä¹Ÿéœ€è¦å®ç°æ‰€æœ‰æ–¹æ³•ã€‚ * åªç”¨çœŸå®å¯¹è±¡ä»£ç†ã€‚æœ‰å¾ˆå¤šæ— æ„ä¹‰çš„ä»£ç  */ realObject.save(name); } } é€šè¿‡ä»¥ä¸Šä»£ç å¯ä»¥çŸ¥é“javaä¸­çš„é™æ€ä»£ç†æœ‰å‡ ä¸ªå…³é”®çš„åœ°æ–¹ï¼š\nä»£ç†å¯¹è±¡å’ŒçœŸå®å¯¹è±¡å®ç°äº†ç›¸åŒçš„æ¥å£ï¼Œæˆ–è€…ç»§æ‰¿åŒä¸€ä¸ªç±»ã€‚æ¢å¥è¯è¯´å°±æ˜¯å¯ä»¥å‘ä¸Šè½¬å‹ä¸ºç›¸åŒçš„å¯¹è±¡ çœŸå®å¯¹è±¡è¦ä½œä¸ºä»£ç†å¯¹è±¡ä¸­ä¸€ä¸ªå±æ€§ã€‚æ–¹ä¾¿çœŸå®å¯¹è±¡è°ƒç”¨æ–¹æ³• æœ‰æ—¶æˆ‘ä»¬åªæƒ³æ‰©å±•åŸå¯¹è±¡çš„æŸä¸ªæ–¹æ³•ï¼Œç»™è¿™ä¸ªæ–¹æ³•æ·»åŠ ä¸€äº›åŠŸèƒ½ã€‚ä½†æ˜¯æˆ‘ä»¬ä»è¦ç¼–å†™ä¸€ä¸ªä»£ç†ç±»ï¼Œå®ç°çœŸå®ç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚å¯¼è‡´å¾ˆå¤šå†—ä½™ä»£ç ï¼Œ java ä¸­çš„åŠ¨æ€ä»£ç†å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜\nåŠ¨æ€ä»£ç† å…ˆçœ‹ä»£ç :\npublic class DynamicDemo { public static void main(String[] args) { /** * åŠ¨æ€ä»£ç†ç¤ºä¾‹ */ System.out.println(\u0026#34;======åŠ¨æ€ä»£ç†======\u0026#34;); // åŠ¨æ€ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡ Save saveProxy = (Save) Proxy.newProxyInstance( // çœŸå®å¯¹è±¡çš„ç±»åŠ è½½å™¨ user.getClass().getClassLoader(), // è¦ä»£ç†çš„æ¥å£ï¼Œæ•°ç»„ new Class[]{ Save.class}, // å°† user çœŸå®å¯¹è±¡ä¼ å…¥ä»£ç†å¤„ç†ç±» new DynamicHandler(user) ); // ä»£ç†å¯¹è±¡æ‰§è¡Œæ–¹æ³•ï¼Œå†…éƒ¨ä¼šè°ƒç”¨çœŸå®å¯¹è±¡æ‰§è¡Œå¯¹åº”æ–¹æ³• saveProxy.save(\u0026#34;dc1\u0026#34;); } } interface Save { /** * ä¿å­˜ */ void save(String name); /** * åˆ é™¤ * @param name */ void delete(String name); } class UserDAO implements Save { public void save(String name) { System.out.println(\u0026#34;çœŸå®å¯¹è±¡æ‰§è¡Œ save æ–¹æ³•\u0026#34;); } public void delete(String name) { System.out.println(\u0026#34;çœŸå®å¯¹è±¡æ‰§è¡Œ delete æ–¹æ³•\u0026#34;); } } /** * ä»£ç†å¯¹è±¡è¦æ‰§è¡Œçš„æ–¹æ³• */ class DynamicHandler implements InvocationHandler { private Object realObject; public DynamicHandler(Object real) { this.realObject = real; } public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { System.out.println(\u0026#34;ä»£ç†å¯¹è±¡ç±»:\u0026#34; + proxy.getClass()); System.out.println(\u0026#34;è¦ä»£ç†çš„æ–¹æ³•æ˜¯: \u0026#34; + method.getName() ); System.out.println(\u0026#34;å‚æ•°æ˜¯:\u0026#34;); for (Object arg : args) { System.out.printf(arg + \u0026#34; \u0026#34;); } System.out.println(\u0026#34;\u0026#34;); if(method.getName().equals(\u0026#34;delete\u0026#34;)){ System.out.println(\u0026#34;æ‰§è¡Œäº† delete æ–¹æ³•\u0026#34;); } /** * è¿™é‡Œçš„æ“ä½œä½“ç°äº†åŠ¨æ€ä»£ç†çš„ä¼˜ç‚¹ï¼š åœ¨éœ€è¦ä»£ç†çš„æ–¹æ³•å‰åç¼–å†™åŠŸèƒ½ */ if(method.getName().equals(\u0026#34;save\u0026#34;)){ System.out.println(\u0026#34;æ‰§è¡Œäº† save æ–¹æ³•\u0026#34;); System.out.println(\u0026#34;çœŸå®å¯¹è±¡æ‰§è¡Œsaveæ–¹æ³•å‰\u0026#34;); } // çœŸå®å¯¹è±¡æ‰§è¡Œæ–¹æ³• method.invoke(this.realObject,args); if(method.getName().equals(\u0026#34;save\u0026#34;)){ System.out.println(\u0026#34;çœŸå®å¯¹è±¡æ‰§è¡Œsaveæ–¹æ³•å\u0026#34;); } return null; } } ä»ä¸Šé¢ä»£ç ä¸­å¯ä»¥å‘ç°ï¼Œå®ç°åŠ¨æ€ä»£ç†çš„å…³é”®ç‚¹ï¼š\nInvocationHandler çš„å®ç°ç±»ï¼Œinvoke æ–¹æ³•ä¸­ç¼–å†™ä½ è¦æ‰©å±•çš„åŠŸèƒ½ InvocationHandler çš„å®ç°ç±»ä¸­è¦æœ‰ä¸€ä¸ªå±æ€§ä¿å­˜çœŸå®å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯ä¾‹ä¸­çš„ realObject, ä»¥ä¾¿çœŸå®å¯¹è±¡è°ƒç”¨æ–¹æ³•ï¼Œå¦‚æœä¸éœ€è¦çœŸå®å¯¹è±¡è°ƒç”¨æ–¹æ³•ï¼Œé‚£ä¹ˆä¹Ÿå°±ä¸éœ€è¦è¿™ä¸ªçœŸå®å¯¹è±¡äº†ã€‚ ä½¿ç”¨ Proxy.newProxyInstance æ–¹æ³•åˆ›å»ºä»£ç†å¯¹è±¡ã€‚ åŠ¨æ€ä»£ç†å®é™…ä¸Šæ˜¯JVMåœ¨è¿è¡ŒæœŸåŠ¨æ€åˆ›å»ºclasså­—èŠ‚ç å¹¶åŠ è½½çš„è¿‡ç¨‹ï¼Œå®ƒå¹¶æ²¡æœ‰ä»€ä¹ˆé»‘é­”æ³•ã€‚å®ƒåˆ›å»ºçš„å­—èŠ‚ç å°±æ˜¯æˆ‘ä»¬åœ¨é™æ€ä»£ç†ä¸­ç¼–å†™çš„ä»£ç†ç±»ã€‚åªä¸è¿‡ä¸ç”¨æˆ‘ä»¬æ‰‹åŠ¨ç¼–å†™äº†è€Œå·²ã€‚\n","date":"2022-11-02T16:57:07Z","permalink":"https://dccmmtop.github.io/posts/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8E%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86/","section":"posts","tags":["java"],"title":"åŠ¨æ€ä»£ç†ä¸é™æ€ä»£ç†"},{"categories":null,"contents":"@ComponentScan å¯ç”¨ç»„ä»¶æ‰«æ é»˜è®¤æ‰«æä¸é…ç½®ç±»ç›¸åŒçš„åŒ…ä»¥åŠå­åŒ… å¦‚ä½•æ‰«ææŒ‡å®šçš„åŒ… @ComponentScan(\u0026ldquo;åŒ…å\u0026rdquo;) æ‰«æä¸€ç»„åŒ…ï¼š @ComponentScan(basePackages={\u0026quot;xxx\u0026quot;,\u0026quot;xxx\u0026quot;}) è¿™ç§ä¸¤ç§æ–¹å¼éƒ½æ˜¯ä¼ å…¥å­—ç¬¦ä¸²ï¼Œæ— æ³•æ–¹ä¾¿çš„é‡æ„ã€‚å› ä¸ºæˆ‘ä»¬çš„ç¼–è¾‘å™¨ä¸€èˆ¬ä¸ä¼šè§£æä½ çš„å­—ç¬¦ä¸²å€¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢æ–¹å¼ï¼š\næ‰«æç±»å’Œæ¥å£ï¼š @ComponentScan(basePackageClasses={xxx.class, xxxx.class}) è¿™äº›ç±»æ‰€åœ¨çš„åŒ…ä¼šä½œä¸ºç»„ä»¶æ‰«æçš„åŸºç¡€åŒ…ï¼Œå¯ä»¥ä¸ºéœ€è¦æ‰«æçš„åŒ…ä¸­æ·»åŠ ä¸€ä¸ªç©ºæ¥å£ï¼Œæ ‡è®°è¯¥åŒ…éœ€è¦æ‰«æï¼Œè¿™ç§æ–¹å¼é¿å…äº†ä¼ å…¥å­—ç¬¦ä¸²ï¼Œæ–¹ä¾¿é‡æ„ä¿®æ”¹ @ContextConfiguration(classes=xxx.class) éœ€è¦åœ¨ xxx.class ä¸­åŠ è½½é…ç½®\n@Component å‘å®¹å™¨ä¸­æ³¨å†Œç»„ä»¶\nbean çš„åå­—é»˜è®¤æ˜¯ç±»åé¦–å­—æ¯å°å†™ ä¹Ÿå¯ä»¥æŒ‡å®šï¼š @Component(\u0026ldquo;xxx\u0026rdquo;) @Named å¯ä»¥æ›¿ä»£ @Component @Autowired ç”¨åœ¨æ„é€ å™¨ä¸Š å½“ Spring å»åˆ›å»ºè¯¥ç±»çš„ bean æ—¶ï¼Œä¼šè°ƒç”¨è¿™ä¸ªæ„é€ æ–¹æ³•ï¼ŒåŒæ—¶ä¼ å…¥ä¸€ä¸ª æ»¡è¶³å‚æ•°çš„ bean\nClass User { private Car car; // ä¼šä½¿ç”¨è¿™ä¸ªæ–¹æ³•å»æ„é€  bean, è€Œä¸æ˜¯æ—  å‚æ„é€ å™¨ @Autowired public User(Car car){ this.car = car; } } ç”¨åœ¨ Setter æ–¹æ³•ä¸Š\nå…¶å®å¯ä»¥ç”¨åœ¨ç±»çš„ä»»ä½•æ–¹æ³•ä¸Šï¼ŒSpring å°è¯•æ»¡è¶³æ–¹æ³•å‚æ•°ä¸Šå£°æ˜çš„ä¾èµ–ï¼Œå¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„ bean å°±ä¼šæŠ›å‡ºå¼‚å¸¸\n@Autowired(required=false) å³ä½¿æ²¡æ‰¾åˆ°ä¹Ÿä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä¼šä¼ å…¥ Null. å¯èƒ½ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸\nå¦‚æœæœ‰å¤šä¸ª bean éƒ½èƒ½æ»¡è¶³ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸\nå¯ä»¥ä½¿ç”¨ Inject æ›¿æ¢ï¼ŒInject æ˜¯ java ä¸­ä¾èµ–æ³¨å…¥è§„èŒƒ\n@Bean æ˜¾ç¤ºé…ç½® Bean, å¯ä»¥æŠŠç¬¬ä¸‰æ–¹å¯¹è±¡è®¾ç½®æˆ Beanï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ç›´æ¥åœ¨ç¬¬ä¸‰æ–¹ç±»ä¸Šæ·»åŠ @Component æ³¨è§£ bean Id é»˜è®¤æ˜¯æ–¹æ³•åï¼Œå¯ä»¥æŒ‡å®šï¼š@Bean(\u0026quot;xxx\u0026quot;) @Configuration @ComponentScan public class AutowiredDemoConfig { /** * User æ˜¯å¼•å…¥çš„ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œæ— æ³•ä¿®æ”¹ User ç±»ï¼Œåœ¨ç±»åä¸ŠåŠ  @Component æ³¨è§£ */ @Bean public User user(){ return new User(10,\u0026#34;dc1\u0026#34;); } } @Profile(\u0026ldquo;dev\u0026rdquo;) å’Œ@Bean ä¸€èµ·ä½¿ç”¨ï¼Œå½“ dev ç¯å¢ƒä¸Šæ‰ä¼šåˆ›å»º bean é…ç½®\nspring.profiles.default=dev æˆ–è€… spring.profiles.active=dev æ¿€æ´» dev ç¯å¢ƒï¼Œå¦‚æœæ²¡æœ‰æ¿€æ´»çš„ç¯å¢ƒï¼Œåªä¼šåˆ›å»ºé‚£äº›æ²¡æœ‰å®šä¹‰åœ¨ profile ä¸­çš„ bean ä» Spring 4 å¼€å§‹ï¼Œä¾èµ– @Conditional æ³¨è§£ @Conditional Since 4.0 æ¡ä»¶åŒ–çš„ bean ç”¨åˆ°å¸¦æœ‰@Bean çš„æ³¨è§£çš„æ–¹æ³•ä¸Š ç»™å®šæ¡ä»¶çš„ç»“æœä¸º true æ—¶ï¼Œåˆ›å»º bean å¦åˆ™ä¸åˆ›å»º éœ€è¦å®ç° Conditional æ¥å£ä¸­çš„ matches æ–¹æ³• @Primary å¤„ç†è‡ªåŠ¨è£…é…çš„æ­§ä¹‰\nå¦‚æœä¸€ä¸ª Bean æ˜¯æ¥å£ï¼Œç³»ç»Ÿä¸­æœ‰å¤šä¸ªå®ç°ç±»ã€‚æ³¨å…¥æ—¶å°±ä¼šæœ‰æ­§ä¹‰ï¼ŒæŠ›å‡ºå¼‚å¸¸\n@Primary ç”¨åœ¨ Bean ä¸Šï¼Œæ ‡è®°è¿™ä¸ª bean æ˜¯é¦–é€‰çš„ï¼Œå‘ç”Ÿæ­§ä¹‰æ—¶é¦–é€‰å®ƒï¼Œ ä¸ä¼šæŠ¥é”™\nç¼ºç‚¹ï¼š åªèƒ½ä½¿ç”¨å…¶ä¸­ä¸€ä¸ª beanï¼Œæ— æ³•æŒ‡å®šæ³¨å…¥å“ªä¸ªï¼Œ@Qualifier è§£å†³è¿™ä¸ªé—®é¢˜\nç¤ºä¾‹ï¼š\n@RunWith(SpringJUnit4ClassRunner.class) @ContextConfiguration(classes = AutowiredDemoConfig.class) public class QualifierDemo { @Autowired private Dessert dessert; @Test public void eat(){ dessert.getName(); } } /** * Cake IceCream éƒ½å®ç°äº† Dessert */ interface Dessert{ String getName(); } @Component @Primary // ä¼šä¼˜å…ˆæ³¨å…¥ Cake class Cake implements Dessert { public String getName() { String name = \u0026#34;Cake\u0026#34;; System.out.println(name); return name; } } @Component class IceCream implements Dessert{ public String getName() { String name = \u0026#34;IceCream\u0026#34;; System.out.println(name); return name; } } @Qualifier(\u0026ldquo;xxx bean name\u0026rdquo;) ä¸ @Autowired ä¸€èµ·ä½¿ç”¨æ—¶ç›´æ¥æŒ‡å®š bean çš„åå­—è¿›è¡Œè£…é…ï¼š ä¸ @Component ä¸€èµ·ä½¿ç”¨ï¼Œå¯ä»¥è®¾ç½® bean çš„åå­— ä¸ @Bean ä¸€èµ·ä½¿ç”¨ï¼Œå¯ä»¥è®¾ç½® bean çš„åå­— @Scope bean çš„ä½œç”¨åŸŸ é»˜è®¤æ‰€æœ‰çš„ bean éƒ½æ˜¯å•ä¾‹çš„ã€‚Spring å®šä¹‰äº†å¤šç§ä½œç”¨åŸŸï¼ŒåŒ…æ‹¬ï¼š\nå•ä¾‹ (Singleton): æ•´ä¸ªåº”ç”¨ä¸­åªåˆ›å»ºä¸€ä¸ª bean å®ä¾‹ åŸå‹ (Prototype): æ¯æ¬¡æ³¨å…¥æˆ–è€…é€šè¿‡ Spring åº”ç”¨ä¸Šä¸‹æ–‡è·å–çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ beanã€‚ ä¼šè¯ (Session): åœ¨ Web åº”ç”¨ä¸­ï¼Œä¸ºæ¯ä¸ªä¼šè¯åˆ›å»ºä¸€ä¸ªå®ä¾‹ è¯·æ±‚ (Request): åœ¨ Web åº”ç”¨ä¸­ï¼Œä¸ºæ¯ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªå®ä¾‹ ç¤ºä¾‹ ä½¿ç”¨ @Scope æ³¨è§£ï¼Œæ”¹å˜beançš„ä½œç”¨åŸŸ\n@RunWith(SpringJUnit4ClassRunner.class) @ComponentScan @ContextConfiguration(classes = ScopeDemo.class) public class ScopeDemo { @Autowired @Qualifier(\u0026#34;singleSTU\u0026#34;) private Student s1; @Autowired @Qualifier(\u0026#34;singleSTU\u0026#34;) private Student s2; @Autowired @Qualifier(\u0026#34;prototypeSTU\u0026#34;) private Student s3; @Autowired @Qualifier(\u0026#34;prototypeSTU\u0026#34;) private Student s4; @Test public void scopeDemo(){ Assert.assertEquals(\u0026#34;s1 s2 æ˜¯å•ä¾‹ä½œç”¨åŸŸï¼Œä¸¤è€…åº”è¯¥ç›¸ç­‰:\u0026#34;, s1.hashCode(), s2.hashCode()); Assert.assertNotEquals(\u0026#34;s3 s4 æ˜¯åŸå‹ä½œç”¨åŸŸï¼Œä¸¤è€…åº”è¯¥ä¸ç›¸ç­‰:\u0026#34;, s3.hashCode(), s4.hashCode()); } } @Configuration class Student { private int age; /** * é»˜è®¤æ˜¯å•ä¾‹ä½œç”¨åŸŸ * @return */ @Bean(\u0026#34;singleSTU\u0026#34;) public Student stu(){ Random random = new Random(); Student s1 = new Student(); s1.setAge(random.nextInt(100)); return s1; } /** * è®¾ç½®åŸå‹ä½œç”¨åŸŸ * @return */ @Bean(\u0026#34;prototypeSTU\u0026#34;) @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE) public Student stu1(){ Random random = new Random(); Student s1 = new Student(); s1.setAge(random.nextInt(100)); return s1; } public int getAge() { return age; } public void setAge(int age) { this.age = age; } } è¿è¡Œæ—¶æ³¨å…¥å¤–éƒ¨å€¼ æŠŠé…ç½®æ–‡ä»¶ä¸­çš„å­—æ®µæ³¨å…¥åˆ°å¯¹è±¡ä¸­\nEnviroment é€šè¿‡æ³¨è§£@PropertySource(\u0026ldquo;xxx\u0026rdquo;)è®²é…ç½®æ–‡ä»¶ä¸­çš„ä¿¡æ¯æ³¨å…¥åˆ°Enviorment å¯¹è±¡ä¸­:\n@RunWith(SpringJUnit4ClassRunner.class) @ComponentScan @ContextConfiguration(classes = EnviromentDemo.class) public class EnviromentDemo { @Autowired private Mysql mysql; @Test public void testDataSource(){ System.out.println(mysql.getPort()); } } @Configuration @PropertySource(\u0026#34;classpath:/app.properties\u0026#34;)// å°†é…ç½®æ–‡ä»¶ä¸­çš„å­—æ®µåŠ è½½åˆ° Environment ä¸­ï¼Œç¨åå¯ä»¥é€šè¿‡ Environment å¯¹è±¡è·å– class DataSource { @Autowired Environment env; @Bean public Mysql mysql(){ // è·å–å¯¹åº”çš„å­—æ®µå€¼ï¼ŒgetProperty æ›´å¤šç”¨æ³•å‚è€ƒæºç  return new Mysql(env.getProperty(\u0026#34;mysql.port\u0026#34;, Integer.class), env.getProperty(\u0026#34;mysql.host\u0026#34;)); } } class Mysql { private int port; private String host; public Mysql(int port, String host) { this.port = port; this.host = host; } public int getPort() { return port; } public void setPort(int port) { this.port = port; } public String getHost() { return host; } public void setHost(String host) { this.host = host; } } é€šè¿‡å±æ€§å ä½ç¬¦è£…é… è¿˜å¯ä»¥é€šè¿‡ ${} å ä½ç¬¦è¯»å–é…ç½®æ–‡ä»¶ä¸­çš„å­—æ®µï¼Œæ³¨å…¥åˆ°å­—æ®µä¸­ï¼› å¦‚ä¸‹:\n@RunWith(SpringJUnit4ClassRunner.class) @ComponentScan @ContextConfiguration(classes = ValueDemo.class) public class ValueDemo { @Autowired private Mysql1 mysql; @Test public void testDataSource(){ System.out.println(mysql.getPort()); } } @Configuration class DataSource1 { @Autowired Environment env; @Bean // è¿™ä¸ªbean æ˜¯å¿…é¡»çš„ã€‚å¯ä»¥è§£æå ä½ç¬¦,è‡ªåŠ¨æŸ¥æ‰¾ public static PropertySourcesPlaceholderConfigurer propertySourcesPlaceholderConfigurer(){ return new PropertySourcesPlaceholderConfigurer(); } @Bean // ${} å ä½ç¬¦æ–¹å¼æ³¨å…¥ public Mysql1 mysql(@Value(\u0026#34;${mysql.port}\u0026#34;) int port,@Value(\u0026#34;${mysql.host}\u0026#34;) String host){ // è·å–å¯¹åº”çš„å­—æ®µå€¼ï¼ŒgetProperty æ›´å¤šç”¨æ³•å‚è€ƒæºç  return new Mysql1(port, host); } } class Mysql1 { private int port; private String host; public Mysql1(int port, String host) { this.port = port; this.host = host; } public int getPort() { return port; } public void setPort(int port) { this.port = port; } public String getHost() { return host; } public void setHost(String host) { this.host = host; } } ","date":"2022-11-01T16:05:53Z","permalink":"https://dccmmtop.github.io/posts/bean%E8%A3%85%E9%85%8D%E7%9B%B8%E5%85%B3%E6%B3%A8%E8%A7%A3/","section":"posts","tags":["spring"],"title":"Beanè£…é…ç›¸å…³æ³¨è§£"},{"categories":null,"contents":"1.ä»å¯ä¸Šç½‘çš„å¤–éƒ¨ç”µè„‘ä¸‹è½½éœ€è¦çš„jaråŒ…ï¼Œè‡ªè¡Œä¼ åˆ°å†…éƒ¨ç”µè„‘mavenä»“åº“å¯¹åº”æ–‡ä»¶å¤¹ï¼Œæ¯”å¦‚\ncom.alibaba.easyExcelï¼Œã€æ³¨æ„æœ‰äº›åŒ…ä¼šæœ‰å…¶ä»–çš„ä¾èµ–jaråŒ…ï¼Œéœ€è¦ä¸€åŒä¸‹è½½ã€‘\n2.IDEAä¸­æ·»åŠ jaråŒ…çš„mavenä¾èµ–ï¼Œæ¯”å¦‚\n\u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.alibaba\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;easyexcel\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.1.2-beta4\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; 3.è®¾ç½®IDEAçš„mavenä¸ºç¦»çº¿æ¨¡å¼ï¼Œæ‰“å‹¾ã€‚\n4.æ›´æ”¹mavençš„setting.xmlä¸ºç¦»çº¿æ¨¡å¼\n\u0026lt;offline\u0026gt;true\u0026lt;/offline\u0026gt; æ›´æ”¹æº \u0026lt;mirrors\u0026gt; \u0026lt;mirror\u0026gt; \u0026lt;id\u0026gt;central\u0026lt;/id\u0026gt; \u0026lt;mirrorOf\u0026gt;*\u0026lt;/mirrorOf\u0026gt; \u0026lt;name\u0026gt;central\u0026lt;/name\u0026gt; \u0026lt;url\u0026gt;file://D:\\MyRepository\u0026lt;/url\u0026gt; \u0026lt;/mirror\u0026gt; \u0026lt;/mirrors\u0026gt; å®Œæˆä»¥ä¸Šé…ç½®ï¼Œä¸ä¼šåœ¨çº¿ä¸‹è½½ä¾èµ–äº†ï¼Œå®Œå…¨èµ°æœ¬åœ°ã€‚\n","date":"2022-10-31T12:18:31Z","permalink":"https://dccmmtop.github.io/posts/maven%E5%AE%8C%E5%85%A8%E4%BE%9D%E8%B5%96%E6%9C%AC%E5%9C%B0%E5%BA%93/","section":"posts","tags":["maven"],"title":"mavenå®Œå…¨ä¾èµ–æœ¬åœ°åº“"},{"categories":null,"contents":"ä¸ºä»€ä¹ˆéœ€è¦ Callable æ— è®ºæ˜¯ç»§æ‰¿ Thread ç±»ï¼Œè¿˜æ˜¯å®ç° Runnale æ¥å£ï¼Œæˆ–è€…ä½¿ç”¨çº¿ç¨‹æ± çš„ execute æ–¹æ³•å»æ‰§è¡Œä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œéƒ½æ— æ³•å°†è¿™ä¸ªä»»åŠ¡çš„è¿”å›å€¼å¸¦å‡ºæ¥ï¼Œä»¥ Runnale æ¥å£ä¸ºä¾‹ï¼š\n/** * @since JDK1.0 */ @FunctionalInterface public interface Runnable { public abstract void run(); } å¯ä»¥çœ‹åˆ° run() æ–¹æ³•æ²¡æœ‰å‚æ•°ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œå› æ­¤ä¸èƒ½é€‚ç”¨äºé‚£äº›éœ€è¦å¼‚æ­¥ä»»åŠ¡è¿”å›å€¼å¾—åœºæ™¯ï¼Œç”±æ­¤å°±è¯ç”Ÿäº†å¯ä»¥è·å–å¼‚æ­¥ä»»åŠ¡ç»“æœçš„å·¥å…·ï¼š Callable\nCallable åˆæ˜¯ Doug Lea å¤§å¸ˆ\n/** * @see Executor * @since 1.5 * @author Doug Lea * @param \u0026lt;V\u0026gt; the result type of method {@code call} */ @FunctionalInterface public interface Callable\u0026lt;V\u0026gt; { V call() throws Exception; } Callable æ˜¯ä¸€ä¸ªæ³›å‹æ¥å£ï¼Œé‡Œé¢åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œcall(), å¯ä»¥è¿”å›æ³›å‹å€¼V, Cacheable ä¸ Runnable æ¥å£å¾ˆæ˜¯ç›¸ä¼¼ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹ä»–ä»¬ä¹‹é—´çš„åŒºåˆ«\nCallable VS Runnable ä¸¤ä¸ªæ¥å£éƒ½æ˜¯ç”¨äºå¤šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„ï¼Œä½†æ˜¯ä»–ä»¬çš„ä½¿ç”¨åœºæ™¯çš„å·®åˆ«è¿˜æ˜¯å¾ˆå¤§çš„ã€‚\næ‰§è¡Œæœºåˆ¶ä¸Šçš„å·®åˆ« Runnable å¯ä»¥ç”¨åœ¨Threadç±»ä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨ ExecutorService ä¸­é…åˆçº¿ç¨‹æ± ä½¿ç”¨ï¼Œä½†æ˜¯ Callable åªèƒ½ç”¨äº ExecutorService ä¸­ï¼ŒThread ç±»ä¸­æ²¡æœ‰ Cacheable çš„èº«å½±ï¼š\nå¼‚å¸¸å¤„ç†çš„å·®åˆ« Runnable æ¥å£ä¸­çš„ run æ–¹æ³•ç­¾åä¸Šæ²¡æœ‰ throws, è‡ªç„¶ä¹Ÿä¸èƒ½å‘ä¸Šä¼ æ’­å—æ£€å¼‚å¸¸ã€‚è€Œ Callable æ¥å£ä¸­çš„ call fæ–¹æ³•å¯ä»¥å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ã€‚\nåŒºåˆ«æ€»ç»“å¦‚ä¸‹ï¼š\nCallable åœ¨çº¿ç¨‹æ± ä¸­çš„åº”ç”¨ ä¸Šé¢è¯´è¿‡ï¼ŒCallable æ¥å£åªèƒ½åœ¨ ExecutorService ä¸­ä½¿ç”¨ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨çš„\nå¯ä»¥çœ‹åˆ°åœ¨ submit æ–¹æ³•ä¸­å¯ä»¥æ¥æ”¶ä¸€ä¸ªå®ç°äº† Callable æ¥å£çš„ä»»åŠ¡ï¼Œ è¿”å›çš„æ˜¯ Future ç±»å‹ã€‚è€Œ execute æ–¹æ³•æ— è¿”å›å€¼ã€‚ é‚£ä¹ˆ Future æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ å¦‚ä½•é€šè¿‡ Future æ‹¿åˆ°è¿”å›å€¼å‘¢ï¼Ÿ\nFuture Future æ˜¯ä¸€ä¸ªæ¥å£ï¼Œé€šè¿‡æ–¹æ³•åå°±å¯ä»¥çœ‹å‡ºä»–ä»¬çš„ç”¨é€”ï¼š\n// å–æ¶ˆä»»åŠ¡ boolean cancel(boolean mayInterruptIfRunning); // è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ V get() throws InterruptedException, ExecutionException; // è·å–ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå¸¦æœ‰è¶…æ—¶æ—¶é—´é™åˆ¶ V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException; // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»å–æ¶ˆ boolean isCancelled(); // åˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»ç»“æŸ boolean isDone(); çœ‹ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ï¼š\npublic class FutureDemo { public static void main(String[] args) throws InterruptedException, ExecutionException { ExecutorService executorService = Executors.newSingleThreadExecutor(); // ä½¿ç”¨ Callable ï¼Œå¯ä»¥è·å–è¿”å›å€¼ Callable\u0026lt;String\u0026gt; callable = () -\u0026gt; { System.out.println(\u0026#34;è¿›å…¥ Callable çš„ call æ–¹æ³•\u0026#34;); // æ¨¡æ‹Ÿå­çº¿ç¨‹ä»»åŠ¡ï¼Œåœ¨æ­¤ç¡çœ  2sï¼Œ // å°ç»†èŠ‚ï¼šç”±äº call æ–¹æ³•ä¼šæŠ›å‡º Exceptionï¼Œè¿™é‡Œä¸ç”¨åƒä½¿ç”¨ Runnable çš„run æ–¹æ³•é‚£æ · try/catch äº† Thread.sleep(5000); return \u0026#34;Hello from Callable\u0026#34;; }; System.out.println(\u0026#34;æäº¤ Callable åˆ°çº¿ç¨‹æ± \u0026#34;); Future\u0026lt;String\u0026gt; future = executorService.submit(callable); System.out.println(\u0026#34;ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ\u0026#34;); System.out.println(\u0026#34;ä¸»çº¿ç¨‹ç­‰å¾…è·å– Future ç»“æœ\u0026#34;); // //æ£€æŸ¥ä»»åŠ¡æ˜¯å¦åšå®Œ // while(!future.isDone()) { // System.out.println(\u0026#34;Task is still not done...\u0026#34;); // Thread.sleep(1000); // } // Future.get() blocks until the result is available String result = future.get(); System.out.println(\u0026#34;ä¸»çº¿ç¨‹è·å–åˆ° Future ç»“æœ: \u0026#34; + result); executorService.shutdown(); } } ç»“æœå¦‚ä¸‹:\næäº¤ Callable åˆ°çº¿ç¨‹æ±  ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œ ä¸»çº¿ç¨‹ç­‰å¾…è·å– Future ç»“æœ è¿›å…¥ Callable çš„ call æ–¹æ³• ä¸»çº¿ç¨‹è·å–åˆ° Future ç»“æœ: Hello from Callable Process finished with exit code 0 å¦‚æœå­ç¨‹åºè¿è¡Œæ—¶é—´è¿‡é•¿ï¼Œæˆ–è€…å…¶ä»–åŸå› ï¼Œæˆ‘ä»¬æƒ³ cancel å­ç¨‹åºçš„è¿è¡Œï¼Œåˆ™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Future æä¾›çš„ cancel æ–¹æ³•ï¼Œç»§ç»­å¯¹ç¨‹åºåšä¸€äº›ä¿®æ”¹\nwhile(!future.isDone()) { System.out.println(\u0026#34;å­çº¿ç¨‹ä»»åŠ¡è¿˜æ²¡æœ‰ç»“æŸ...\u0026#34;); Thread.sleep(1000); double elapsedTimeInSec = (System.nanoTime() - startTime)/1000000000.0; // å¦‚æœç¨‹åºè¿è¡Œæ—¶é—´å¤§äº 1sï¼Œåˆ™å–æ¶ˆå­çº¿ç¨‹çš„è¿è¡Œ if(elapsedTimeInSec \u0026gt; 1) { future.cancel(true); } } ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä½¿ç”¨ cancel æ–¹æ³•å–æ¶ˆäº†ä»»åŠ¡ï¼Œ get() æ–¹æ³•ä¼šæŠ›å‡ºä¸€ä¸ª CancellationException å¼‚å¸¸ã€‚\nåˆ°è¿™é‡Œå·²ç»çŸ¥é“å’Œé…åˆä½¿ç”¨ Cacheable å’Œ Future æ¥è·å–å¼‚æ­¥ä»»åŠ¡çš„è¿”å›å€¼äº†ã€‚æ€»ç»“å°±åªæœ‰3ç‚¹ï¼š\nå¾…æ‰§è¡Œçš„ä»»åŠ¡è¦å®ç° Callable æ¥å£ä¸­çš„ ä½¿ç”¨çº¿ç¨‹æ± ä¸­çš„submit æ–¹æ³• é€šè¿‡ Future è·å–ä»»åŠ¡çš„è¿”å›å€¼ åˆšåˆšæˆ‘ä»¬çœ‹ ExecutorService ä¸­çš„ submit æ–¹æ³•è¿”å›çš„æ˜¯ Future æ¥å£ï¼Œç„¶åé€šè¿‡æ¥å£ä¸­çš„get æ–¹æ³•è·å–ä»»åŠ¡çš„è¿”å›å€¼ï¼Œå…¶å® submit è¿”å›çš„æ˜¯ Future çš„å®ç°ç±»ï¼š FutureTask, è‡³äº FutureTask æ˜¯å¦‚ä½•é…åˆçº¿ç¨‹æ± æ‹¿åˆ°ä»»åŠ¡çš„è¿”å›å€¼ï¼Œå°±éœ€è¦æ·±å…¥æºç æŸ¥çœ‹åº•å±‚å®ç°äº†ï¼Œè¿™ä¸ªä»¥åå†æ–°å†™ä¸€éåšå®¢è®²è§£ã€‚\nå‚è€ƒ http://www.lllpan.top/article/102\n","date":"2022-10-29T17:15:31Z","permalink":"https://dccmmtop.github.io/posts/callable%E4%B8%8Efuture%E7%9A%84%E5%BA%94%E7%94%A8/","section":"posts","tags":["java"],"title":"Callableä¸Futureçš„åº”ç”¨"},{"categories":null,"contents":"ä»€ä¹ˆæ˜¯ Fork/Join æ¡†æ¶ Fork/Join æ˜¯ä» java7 å¼€å§‹æä¾›çš„å¹¶è¡Œæ‰§è¡Œä»»åŠ¡çš„æ¡†æ¶ï¼Œæ˜¯ä¸€ä¸ªæŠŠå¤§ä»»åŠ¡åˆ†å‰²æˆè‹¥å¹²ä¸ªå°ä»»åŠ¡ï¼Œæœ€ç»ˆæ±‡æ€»æ¯ä¸ªå°ä»»åŠ¡çš„ç»“æœï¼Œå¾—åˆ°å¤§ä»»åŠ¡ç»“æœçš„æ¡†æ¶.\nå¦‚ä¸‹å›¾ï¼š\nFork/Join çš„ç‰¹æ€§ ForJoinPool ä¸æ˜¯ä¸ºäº†æ›¿ä»£ ExecutorService, è€Œæ˜¯å®ƒçš„è¡¥å……ï¼Œåœ¨ä¸€äº›å¯åˆ†å‰²çš„å¤§ä»»åŠ¡åœºæ™¯ä¸‹ï¼Œæ€§èƒ½ä¼šæ›´å¥½ã€‚ ForJoinPool ä¸»è¦åˆ©ç”¨â€œåˆ†è€Œæ²»ä¹‹â€çš„ç®—æ³•æ€æƒ³ ForJoinPool æœ€é€‚åˆè®¡ç®—å‹å¯†é›†çš„ä»»åŠ¡ å·¥ä½œçªƒå–ç®—æ³• æŒ‡çš„æ˜¯æŸä¸ªçº¿ç¨‹ä»å…¶ä»–çº¿ç¨‹é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡æ¥æ‰§è¡Œã€‚è¿™ä¹Ÿæ˜¯ Fork/Join æ¡†æ¶æ‰§è¡Œä»»åŠ¡çš„æ ¸å¿ƒæœºåˆ¶\nå½“æˆ‘ä»¬éœ€è¦åšä¸€æ¯”è¾ƒå¤§çš„ä»»åŠ¡æ—¶ï¼Œ æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªä»»åŠ¡åˆ†æˆè‹¥å¹²ä¸ªä¸äº’ç›¸ä¾èµ–çš„å­ä»»åŠ¡ï¼ŒæŠŠè¿™äº›å­ä»»åŠ¡æ”¾åœ¨ä¸åŒçš„é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸ºä¸åŒçš„é˜Ÿåˆ—ç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œçº¿ç¨‹å’Œé˜Ÿåˆ—æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ä½†æ˜¯æœ‰çš„çº¿ç¨‹å¹²æ´»æ¯”è¾ƒå¿«ï¼ŒæŠŠè‡ªå·±é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰§è¡Œå®Œäº†ï¼Œä¸ä¼šå¹²ç­‰ç€ï¼Œè€Œæ˜¯å»å¸®å…¶ä»–çº¿ç¨‹å¹²æ´»ï¼Œå°±æ˜¯å–å…¶ä»–é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ¥æ‰§è¡Œã€‚ è¿™æ ·çš„è¯å°±ä¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¼šå‘ç”Ÿèµ„æºæŠ¢å é—®é¢˜ï¼Œäºæ˜¯ï¼ŒæŠŠè¿™ä¸ªé˜Ÿåˆ—è®¾è®¡æˆåŒç«¯é˜Ÿåˆ—ï¼Œ ä»é˜Ÿåˆ—å°¾éƒ¨å·ä»»åŠ¡æ‰§è¡Œï¼Œä¸å’ŒåœŸè‘—çº¿ç¨‹æŠ¢é˜Ÿå¤´ã€‚è¿™æ ·å°±å‡å°‘äº†èµ„æºæŠ¢å çš„æœºä¼šã€‚\nå·¥ä½œçªƒå–ç®—æ³•ä¼˜ç‚¹æ˜¯ï¼Œå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU å¹¶è¡Œè®¡ç®—ï¼Œå¹¶å‡å°‘äº†çº¿ç¨‹é—´çš„ç«äº‰ï¼Œç¼ºç‚¹æ˜¯ï¼Œå¹¶æ²¡æœ‰å®Œå…¨é¿å…ç«äº‰ï¼Œä¾‹å¦‚é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶ï¼ŒåŒæ—¶æ¶ˆè€—äº†æ›´å¤šçš„ç³»ç»Ÿèµ„æºã€‚\nForkJoinPool ä»»åŠ¡æ‰§è¡Œæ­¥éª¤ ForJoinPool ä¸­çš„æ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆWorkQueueï¼‰, è¿™æ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ— (Deque), é˜Ÿåˆ—ä¸­åªèƒ½å­˜æ”¾ ForkJoinTask å­ç±»å‹çš„ä»»åŠ¡ çº¿ç¨‹åœ¨å·¥ä½œä¸­äº§ç”Ÿçš„æ–°ä»»åŠ¡æ—¶ï¼ˆé€šå¸¸æ˜¯è°ƒç”¨äº† fork() æ–¹æ³•ï¼‰, ä¼šæ”¾å…¥é˜Ÿå°¾ï¼Œå¹¶ä¸”çº¿ç¨‹åœ¨å¤„ç†ä»»åŠ¡æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ LIFO æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ä»é˜Ÿå°¾å–å‡ºä»»åŠ¡æ‰§è¡Œã€‚ æ¯ä¸ªçº¿ç¨‹åœ¨å¤„ç†è‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—çš„åŒæ—¶ï¼Œä¼šå°è¯•çªƒå–ä¸€ä¸ªä»»åŠ¡ï¼ˆåˆšæäº¤åˆ°çº¿ç¨‹æ± çš„ä»»åŠ¡ï¼Œæˆ–è€…å…¶ä»–çº¿ç¨‹é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼‰, çªƒå–çš„ä»»åŠ¡ä½äºå…¶ä»–çº¿ç¨‹é˜Ÿåˆ—çš„é˜Ÿå¤´ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹åœ¨çªƒå–ä»»åŠ¡æ—¶ï¼Œé‡‡å–çš„æ˜¯ FIFO çš„æ–¹å¼ã€‚ é‡åˆ° join() æ–¹æ³•æ—¶ï¼Œå¦‚æœéœ€è¦ join() çš„ä»»åŠ¡å°šæœªå®Œæˆï¼Œåˆ™ä¼šå…ˆå¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œå¹¶ç­‰å¾…è¿™ä¸ªä»»åŠ¡å®Œæˆã€‚ æ—¢æ²¡æœ‰è‡ªå·±çš„ä»»åŠ¡ï¼Œä¹Ÿæ²¡æœ‰å¯çªƒå–çš„ä»»åŠ¡æ—¶ï¼Œè¿›å…¥ä¼‘çœ  ForkJoinPool çš„ä½¿ç”¨ ForkJoin æ¡†æ¶è¦æ±‚ä»»åŠ¡å¿…é¡»æ˜¯ ForkJoinTask çš„å­ç±»ï¼Œé€šå¸¸æƒ…å†µä¸‹ä¸éœ€è¦ç›´æ¥ç»§æ‰¿ ForkJoinTask, è€Œæ˜¯ç»§æ‰¿å®ƒçš„å­ç±»ï¼ŒRecursiveAction å’Œ RecursiveTaskã€‚\nRecursiveAction ç”¨äºæ²¡æœ‰è¿”å›å€¼çš„ä»»åŠ¡ï¼Œå¿…é¡»è®²æ•°æ®å†™åˆ°ç£ç›˜ï¼Œå¯ä»¥æŠŠæ•°æ®åˆ†å—ï¼Œå¤šçº¿ç¨‹å»å†™å…¥\nRecursiveTask ç”¨äºæœ‰è¿”å›å€¼çš„ä»»åŠ¡\nä½¿ç”¨ç¤ºä¾‹ æ•°ç»„ä¸­çš„æ•°å­—ç´¯åŠ \n/** *æœ‰è¿”å›å€¼ç±»å‹çš„å¯æ‹†åˆ†ä»»åŠ¡ */ class SumTask extends RecursiveTask\u0026lt;Integer\u0026gt; { /** * æ§åˆ¶æœ€å°ä»»åŠ¡çš„ç²’åº¦ */ private final static int THRESHOLD = 20; private int[] arr; private int start; private int end; public SumTask(int[] arr, int start, int end){ this.arr = arr; // å°†æ•°ç»„åˆ†å‰²æˆå¼€å§‹ä¸‹è¡¨ä¸º startï¼Œ ç»“æŸä¸‹æ ‡ä¸º end çš„å°æ•°ç»„ this.start = start; this.end = end; } /** * åªè®¡ç®—æŸæ®µçš„å’Œ */ private int subTotal(){ int sum = 0; for(int i = start; i \u0026lt; end; i ++){ sum += arr[i]; } return sum; } @Override protected Integer compute() { // è¾¾åˆ°æœ€å°ç²’åº¦æ—¶ï¼Œå¼€å§‹è®¡ç®— if(end - start \u0026lt; THRESHOLD){ return subTotal(); } // å¦åˆ™ç»§ç»­æ‹†åˆ†æˆä¸¤ä¸ªå°ä»»åŠ¡ int middle = (start + end) /2; SumTask leftSum = new SumTask(arr, start, middle); SumTask right = new SumTask(arr, middle, end); // æäº¤æ–°ä»»åŠ¡ leftSum.fork(); right.fork(); // è®¡ç®—ä¸¤ä¸ªå°ä»»åŠ¡çš„å’Œ return leftSum.join() + right.join(); } } public class ForkJoinTaskDemo { public static void main(String[] args) { int size = 1000000; int[] arr = new int[size]; // ç”Ÿæˆæ•°ç»„ for(int i = 0; i\u0026lt; size ; i++){ arr[i] = i + 1; } ForkJoinPool pool = new ForkJoinPool(); // æäº¤ä¸€ä¸ªå¤§ä»»åŠ¡ç»™çº¿ç¨‹æ±  ForkJoinTask\u0026lt;Integer\u0026gt; result = pool.submit(new SumTask(arr,0, size)); // æ‰§è¡Œ System.out.println(\u0026#34;pool ç»“æœï¼š\u0026#34; + result.invoke()); pool.shutdown(); } } ä¸Šé¢æ–¹æ³•å¯ä»¥ç”¨ä¸‹å›¾è¯´æ˜:\né‡è¦æ–¹æ³•è§£é‡Š æ„é€ æ–¹æ³• å®Œæ•´çš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š\nprivate ForkJoinPool(int parallelism, ForkJoinWorkerThreadFactory factory, UncaughtExceptionHandler handler, int mode, String workerNamePrefix) å‚æ•°è§£é‡Šï¼š\nparallelism ä½¿ç”¨çº¿ç¨‹çš„ä¸ªæ•°ï¼Œé»˜è®¤ä½¿ç”¨ç­‰åŒå¤„ç†å™¨ä¸ªæ•°çš„çº¿ç¨‹ factory åˆ›å»ºçº¿ç¨‹çš„å·¥å‚ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ ForkJoinWorkerThreadFactory handler çº¿ç¨‹å¼‚å¸¸æ—¶çš„å¤„ç†å™¨ï¼Œé»˜è®¤ null mode è¡¨ç¤ºå·¥ä½œçº¿ç¨‹å†…çš„ä»»åŠ¡é˜Ÿåˆ—æ˜¯é‡‡ç”¨ä½•ç§æ–¹å¼è¿›è¡Œè°ƒåº¦ï¼Œå¯ä»¥æ˜¯å…ˆè¿›å…ˆå‡º FIFOï¼Œä¹Ÿå¯ä»¥æ˜¯åè¿›å…ˆå‡º LIFOã€‚å¦‚æœä¸º trueï¼Œåˆ™çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹åˆ™ä½¿ç”¨å…ˆè¿›å…ˆå‡ºæ–¹å¼è¿›è¡Œä»»åŠ¡è°ƒåº¦ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ falseã€‚ workerNamePrefix çº¿ç¨‹åå­—å‰ç¼€ã€‚ fork æ–¹æ³• fork() åšçš„å·¥ä½œåªæœ‰ä¸€ä»¶äº‹ï¼šæŠŠä»»åŠ¡æ¨å…¥å½“å‰å·¥ä½œçº¿ç¨‹çš„å·¥ä½œé˜Ÿåˆ—é‡Œï¼Œæºç å¦‚ä¸‹ï¼š\npublic final ForkJoinTask\u0026lt;V\u0026gt; fork() { Thread t; if ((t = Thread.currentThread()) instanceof ForkJoinWorkerThread) ((ForkJoinWorkerThread)t).workQueue.push(this); else ForkJoinPool.common.externalPush(this); return this; } join æ–¹æ³• join() çš„å·¥ä½œåˆ™å¤æ‚å¾—å¤šï¼Œä¹Ÿæ˜¯ join() å¯ä»¥ä½¿å¾—çº¿ç¨‹å…äºè¢«é˜»å¡çš„åŸå› â€”â€”ä¸åƒåŒåçš„ Thread.join()\næ£€æŸ¥è°ƒç”¨ join() æ–¹æ³•çš„çº¿ç¨‹æ˜¯ä¸æ˜¯ ForkJoinThread çº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œæ¯”å¦‚ï¼šmain çº¿ç¨‹ï¼Œåˆ™é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä¸é˜»å¡ æŸ¥çœ‹ä»»åŠ¡å®ŒæˆçŠ¶æ€ï¼Œå¦‚æœå·²ç»å®Œæˆï¼Œåˆ™ç›´æ¥è¿”å›ç»“æœï¼Œå¦‚æœæ²¡æœ‰å®Œæˆï¼Œè€Œä¸”å¤„äºè‡ªå·±çš„å·¥ä½œé˜Ÿåˆ—å†…ï¼Œåˆ™å®Œæˆå®ƒ å¦‚æœä»»åŠ¡å·²ç»è¢«å…¶ä»–çš„å·¥ä½œçº¿ç¨‹å·èµ°ï¼Œåˆ™çªƒå–è¿™ä¸ªå°å·çš„å·¥ä½œé˜Ÿåˆ—å†…çš„ä»»åŠ¡ï¼ˆä»¥ FIFO æ–¹å¼ï¼‰ï¼Œæ‰§è¡Œï¼Œä»¥æœŸå¸®åŠ©å®ƒæ—©æ—¥å®Œæˆæ¬²\njoin çš„ä»»åŠ¡ã€‚ å¦‚æœå·èµ°ä»»åŠ¡çš„å°å·ä¹Ÿå·²ç»æŠŠè‡ªå·±çš„ä»»åŠ¡å…¨éƒ¨åšå®Œï¼Œæ­£åœ¨ç­‰å¾…éœ€è¦ join çš„ä»»åŠ¡æ—¶ï¼Œåˆ™æ‰¾åˆ°å°å·çš„å°å·ï¼Œå¸®åŠ©å®ƒå®Œæˆå®ƒçš„ä»»åŠ¡ã€‚ é€’å½’åœ°æ‰§è¡Œç¬¬ 4 æ­¥ã€‚ submit æ–¹æ³• ForJoinPool è‡ªè®¤æ‹¥æœ‰å·¥ä½œé˜Ÿåˆ—ï¼Œç”¨æ¥æ¥æ”¶å¤–éƒ¨çº¿ç¨‹(é ForkJoinThread)æäº¤è¿‡æ¥çš„ä»»åŠ¡,è¿™ä¸ªå·¥ä½œé˜Ÿåˆ—è¢«ç§°ä¸º submitting queue, submit() æ–¹æ³•å’Œ fork() æ–¹æ³•æ²¡æœ‰æœ¬è´¨åŒºåˆ«ï¼Œ åªä¸ä»»åŠ¡çš„ç›®çš„åœ°æ˜¯ submitting queue. submitting queue å’Œ work queue ä¸€æ ·ï¼Œä¹Ÿæ˜¯è¢«çªƒå–çš„å¯¹è±¡ã€‚å› æ­¤å½“ä¸€ä¸ªä»»åŠ¡è¢«æˆåŠŸçªƒå–æ—¶ï¼Œå°±æ„å‘³ç€è¢«æäº¤çš„ä»»åŠ¡çœŸæ­£å¼€å§‹è¿›å…¥æ‰§è¡Œé˜¶æ®µã€‚\ninvoke æ–¹æ³• å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœå¿…è¦ï¼Œç­‰å¾…è®¡ç®—å®Œæˆã€‚\nå‚è€ƒèµ„æ–™ https://www.cnblogs.com/cjsblog/p/9078341.html\nhttps://note.youdao.com/ynoteshare/index.html?id=43491d79e1e5735d39b34b8f7a20c5c7\u0026amp;type=note\u0026amp;_time=1667033251690\n","date":"2022-10-29T15:24:32Z","permalink":"https://dccmmtop.github.io/posts/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bforkjoin%E6%A1%86%E6%9E%B6/","section":"posts","tags":["java"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹ ForkJoin æ¡†æ¶"},{"categories":null,"contents":"ç”¨ideaå·¥å…·è‡ªå¸¦çš„é…ç½®å¯¼å…¥å¯¼å‡ºåŠŸèƒ½åªèƒ½ä½œç”¨äºé…ç½®æ–‡ä»¶ï¼Œä¸èƒ½æŠŠæ’ä»¶ä¹Ÿå¯¼å‡º, å¯ä»¥æ‰¾åˆ°ideaçš„é…ç½®ç›®å½•ï¼ŒæŠŠé…ç½®ç›®å½•è¦†ç›–çš„æ–°çš„æœºå™¨ä¸Šï¼Œé…ç½®ç›®å½•æŸ¥æ‰¾æ–¹æ³•ï¼š\næŠŠè¯¥ç›®å½•æ‰“åŒ…ç§»åŠ¨åˆ°æ–°çš„æœºå™¨ä¸Šï¼Œç”¨åŒæ ·çš„æ–¹æ³•æ‰¾åˆ°æ–°æœºå™¨ä¸Šideaçš„é…ç½®è·¯å¾„ï¼Œè¦†ç›–å³å¯\n","date":"2022-10-24T10:01:07Z","permalink":"https://dccmmtop.github.io/posts/idea%E9%85%8D%E7%BD%AE%E5%92%8C%E6%8F%92%E4%BB%B6%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA%E7%9A%84%E6%96%B9%E6%B3%95/","section":"posts","tags":["idea"],"title":"ideaé…ç½®å’Œæ’ä»¶å¯¼å…¥å¯¼å‡ºçš„æ–¹æ³•"},{"categories":null,"contents":"åœ¨ çº¿ç¨‹æ± çš„åº”ç”¨ ä¸€æ–‡ä¸­ï¼Œè®²è§£äº†å¸¸è§å‡ ç§çº¿ç¨‹æ± çš„ä½¿ç”¨æ–¹æ³•ä¸å·®åˆ«ï¼Œä»Šå¤©å†æ·±å…¥å­¦ä¸€ä¸‹å…¶ä¸­å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± çš„ç”¨æ³•å’ŒåŸç†ã€‚\nå®šæ—¶ä»»åŠ¡çº¿ç¨‹æ±  public class User { public static void main(String[] args) { // åˆ›å»ºä¸€ä¸ªå®šæ—¶ä»»åŠ¡çº¿ç¨‹æ±  ScheduledExecutorService executor =Executors.newScheduledThreadPool(1); // æäº¤ä»»åŠ¡ï¼Œ1 ç§’åå¼€å§‹æ‰§è¡Œ executor.schedule(new Task(2), 1000,TimeUnit.MILLISECONDS); // å…³é—­çº¿ç¨‹æ± ï¼Œä¸å†æ¥å—æ–°ä»»åŠ¡ executor.shutdown(); } } // ä»»åŠ¡ class Task implements Runnable { int i; public Task(int i ) { this.i = i; } @Override public void run() { System.out.println(new Date() + \u0026#34;:\u0026#34;+ i + \u0026#34;:\u0026#34; + Thread.currentThread().getName()); try { // æ¨¡æ‹Ÿä»»åŠ¡è¦æ‰§è¡Œ 4 ç§’é’Ÿ Thread.sleep(4000); } catch (InterruptedException e) { e.printStackTrace(); } } } ç»“æœ\næäº¤ä»»åŠ¡çš„æ—¶é—´æ˜¯ï¼šMon Oct 24 10:30:41 CST 2022 å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼šMon Oct 24 10:30:42 CST 2022:2:pool-1-thread-1 ä»»åŠ¡æ‰§è¡Œç»“æŸï¼šMon Oct 24 10:30:46 CST 2022 Process finished with exit code 0 å¯ä»¥çœ‹åˆ°ä»»åŠ¡ä¸€ç§’åå¼€å§‹æ‰§è¡Œ\nè¿™å°±æ˜¯å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± çš„ä½¿ç”¨ï¼Œ ä¸‹é¢çœ‹ä¸€ä¸‹å®šæ—¶ + å‘¨æœŸä»»åŠ¡çš„ä½¿ç”¨æ–¹æ³•\nå‘¨æœŸä»»åŠ¡ scheduleAtFixedRate public class User { public static void main(String[] args) { ScheduledExecutorService executor =Executors.newScheduledThreadPool(1); System.out.println(\u0026#34;æäº¤ä»»åŠ¡çš„æ—¶é—´æ˜¯ï¼š\u0026#34; + (new Date())); // å‚æ•°åˆ†åˆ«æ˜¯ï¼š ä»»åŠ¡ï¼Œ å¤šä¹…åå¼€å§‹æ‰§è¡Œï¼Œ æ¯éš”å¤šä¹…æ‰§è¡Œä¸€æ¬¡ï¼ˆå‘¨æœŸï¼‰ï¼Œæ—¶é—´å•ä½ executor.scheduleAtFixedRate(new Task(1), 1000,2000, TimeUnit.MILLISECONDS); } } class Task implements Runnable { int i; public Task(int i ) { this.i = i; } @Override public void run() { System.out.println(\u0026#34;å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼š\u0026#34; + new Date() + \u0026#34;:\u0026#34;+ i + \u0026#34;:\u0026#34; + Thread.currentThread().getName()); try { Thread.sleep(4000); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\u0026#34;ä»»åŠ¡æ‰§è¡Œç»“æŸï¼š\u0026#34; + new Date()); } } è®¾ç½®ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´æ˜¯ 4 ç§’ï¼Œ ä½†å‘¨æœŸæ˜¯ 2 ç§’ï¼Œä¹Ÿå°±æ˜¯è¯´ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œç»“æŸï¼Œå°±è¦å¼€å§‹æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚ ä½†æ˜¯çº¿ç¨‹æ± æ˜¯ä¸ä¼šè¿™æ ·åšçš„ï¼Œè€Œæ˜¯ç­‰åˆ°å½“å‰ä»»åŠ¡æ‰§è¡Œç»“æŸï¼Œå¦‚æœå·²ç»è¶…è¿‡äº†å‘¨æœŸï¼Œä¼šç«‹åˆ»å¼€å§‹æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚\nç»“æœ\næäº¤ä»»åŠ¡çš„æ—¶é—´æ˜¯ï¼šMon Oct 24 10:34:01 CST 2022 å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼šMon Oct 24 10:34:02 CST 2022:1:pool-1-thread-1 // å»¶è¿Ÿ 1s æ‰å¼€å§‹æ‰§è¡Œä»»åŠ¡ ä»»åŠ¡æ‰§è¡Œç»“æŸï¼šMon Oct 24 10:34:06 CST 2022 // ä»»åŠ¡æ‰§è¡Œäº† 4s å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼šMon Oct 24 10:34:06 CST 2022:1:pool-1-thread-1 // åˆç«‹åˆ»å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡ ä»»åŠ¡æ‰§è¡Œç»“æŸï¼šMon Oct 24 10:34:10 CST 2022 å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼šMon Oct 24 10:34:10 CST 2022:1:pool-1-thread-1 ä»»åŠ¡æ‰§è¡Œç»“æŸï¼šMon Oct 24 10:34:14 CST 2022 ä¿®æ”¹ä¸€ä¸‹ï¼š ä»»åŠ¡æ‰§è¡Œæ—¶é—´æ˜¯ 1 ç§’ï¼Œ å‘¨æœŸæ˜¯ 3 ç§’ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š\næäº¤ä»»åŠ¡çš„æ—¶é—´æ˜¯ï¼šMon Oct 24 11:21:53 CST 2022 å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼šMon Oct 24 11:21:54 CST 2022:1:pool-1-thread-1 // å»¶è¿Ÿ 1s å¼€å§‹æ‰§è¡Œ ä»»åŠ¡æ‰§è¡Œç»“æŸï¼šMon Oct 24 11:21:55 CST 2022 // ä»»åŠ¡æ‰§è¡Œäº† 1s å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼šMon Oct 24 11:21:57 CST 2022:1:pool-1-thread-1 // 54 + 3 , 3 ç§’åå¼€å§‹æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ ä»»åŠ¡æ‰§è¡Œç»“æŸï¼šMon Oct 24 11:21:58 CST 2022 å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼šMon Oct 24 11:22:00 CST 2022:1:pool-1-thread-2 ä»»åŠ¡æ‰§è¡Œç»“æŸï¼šMon Oct 24 11:22:01 CST 2022 scheduleWithFixedDelay å›ºå®šå»¶è¿Ÿæ—¶é—´ï¼Œåœ¨ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œç»“æŸåï¼Œå›ºå®šå»¶è¿Ÿè®¾ç½®çš„æ—¶é—´ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡\npublic class User { public static void main(String[] args) { ScheduledExecutorService executor =Executors.newScheduledThreadPool(4); System.out.println(\u0026#34;æäº¤ä»»åŠ¡çš„æ—¶é—´æ˜¯ï¼š\u0026#34; + (new Date())); executor.scheduleWithFixedDelay(new Task(2), 1000,3000, TimeUnit.MILLISECONDS); } } class Task implements Runnable { int i; public Task(int i ) { this.i = i; } @Override public void run() { System.out.println(\u0026#34;å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼š\u0026#34; + new Date() + \u0026#34;:\u0026#34;+ i + \u0026#34;:\u0026#34; + Thread.currentThread().getName()); try { Thread.sleep(2000); } catch (InterruptedException e) { e.printStackTrace(); } System.out.println(\u0026#34;ä»»åŠ¡æ‰§è¡Œç»“æŸï¼š\u0026#34; + new Date()); } } è®¾ç½®æ¯ä¸ªä»»åŠ¡æ‰§è¡Œçš„é—´éš”æ˜¯ 3sï¼ˆä¸Šä¸ªä»»åŠ¡ç»“æŸåˆ°ä¸‹ä¸ªä»»åŠ¡å¼€å§‹çš„é—´éš”ï¼‰ï¼Œä»»åŠ¡æ‰§è¡Œæ—¶é—´éœ€è¦ 2sï¼Œçœ‹ä¸‹ç»“æœï¼š\næäº¤ä»»åŠ¡çš„æ—¶é—´æ˜¯ï¼šMon Oct 24 11:32:41 CST 2022 å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼šMon Oct 24 11:32:42 CST 2022:2:pool-1-thread-1 // å»¶è¿Ÿ 1s æ‰å¼€å§‹æ‰§è¡Œä»»åŠ¡ ä»»åŠ¡æ‰§è¡Œç»“æŸï¼šMon Oct 24 11:32:44 CST 2022 // ä»»åŠ¡æ‰§è¡Œäº† 2s // 44 + 3 = 47, å›ºå®šå»¶è¿Ÿ 3 ç§’å¼€å§‹æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼šMon Oct 24 11:32:47 CST 2022:2:pool-1-thread-1 ä»»åŠ¡æ‰§è¡Œç»“æŸï¼šMon Oct 24 11:32:49 CST 2022 å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼šMon Oct 24 11:32:52 CST 2022:2:pool-1-thread-2 ä»»åŠ¡æ‰§è¡Œç»“æŸï¼šMon Oct 24 11:32:54 CST 2022 å‘¨æœŸæ€§ä»»åŠ¡çº¿ç¨‹æ± åº”ç”¨åœºæ™¯ redis é”ç»­å‘½ å½“æˆ‘ä»¬ä½¿ç”¨ redis ä½œä¸ºåˆ†å¸ƒå¼é”æ—¶ï¼Œéœ€è¦ç»™è¿™ä¸ªé”è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œé¿å…å› ä¸ºç¨‹åºå‡ºé”™è€Œç”¨ä¸é‡Šæ”¾é”ï¼Œä½†æ˜¯è¿™ä¸ªè¶…æ—¶æ—¶é—´ä¸å¥½ä¼°é‡ï¼Œè®¾ç½®çš„çŸ­äº†ï¼Œä»»åŠ¡è¿˜æ²¡ç»“æŸå°±é‡Šæ”¾é”äº†ï¼Œè®¾ç½®çš„è¿‡é•¿ï¼Œç¨‹åºå¼‚å¸¸æƒ…å†µä¸‹ä¼šé•¿æ—¶é—´æŒæœ‰é”ï¼Œå½±å“ç¨‹åºæ€§èƒ½ã€‚å¯ä»¥åœ¨è·å–é”ä¹‹åä½¿ç”¨ä¸€ä¸ªå‘¨æœŸæ€§ä»»åŠ¡æ¯ç§’æ£€æŸ¥é”æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœæ‰”å­˜åœ¨ï¼Œå°±ç»™è¿™ä¸ªé”å»¶é•¿æ—¶é—´ï¼Œè¿™æ ·åªéœ€æŠŠé”çš„è¶…æ—¶æ—¶é—´è®¾ç½®ä¸€ä¸ªæ¯”è¾ƒçŸ­çš„æ—¶é—´ï¼Œåé¢ä¾èµ–å‘¨æœŸæ€§ä»»åŠ¡ç»­å‘½å³å¯ã€‚\nå¾®æœåŠ¡æ³¨å†Œä¸­å¿ƒ å„ä¸ªå¾®æœåŠ¡éœ€è¦å®šæ—¶å‘æ³¨å†Œä¸­å¿ƒä¸ŠæŠ¥è‡ªå·±çš„ä¿¡æ¯ï¼Œç¡®ä¿è¯¥æœåŠ¡åœ¨æ­£å¸¸è¿è¡Œ\nä¸ Timer çš„åŒºåˆ« Timer ä¹Ÿå¯ä»¥å®ç°å‘¨æœŸæ€§ä»»åŠ¡ï¼Œä½†æ˜¯ä»–æ˜¯å•çº¿ç¨‹çš„ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œçº¿ç¨‹ä¼šç»ˆæ­¢ï¼Œæ— æ³•å†æ¬¡æ·»åŠ ä»»åŠ¡ã€‚ ScheduledThreadPool åœ¨ä»»åŠ¡å‘ç”Ÿå¼‚å¸¸åï¼Œä¹Ÿä¼šç»“æŸæ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œä½†ç´§æ¥ç€ä¼šå†åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å»ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œä½†æ˜¯è¿™ä¸ªå‘ç”Ÿå¼‚å¸¸çš„ä»»åŠ¡å°±ä»é˜Ÿåˆ—ä¸­ç§»é™¤äº†ï¼Œæ— æ³•å†å‘¨æœŸæ€§æ‰§è¡Œã€‚è¿™ä¹Ÿæ˜¯ç‰¹åˆ«éœ€è¦æ³¨æ„çš„åœ°æ–¹ã€‚åœ¨ä¸€ç‚¹åœ¨ çº¿ç¨‹æ± åŸç† è®²è¿‡ å»¶è¿Ÿä»»åŠ¡çº¿ç¨‹æ± çš„å®ç°åŸç† ä¸Šè¿°çš„å»¶è¿Ÿä»»åŠ¡çº¿ç¨‹æ± åº•å±‚é‡‡ç”¨DelayQueueå­˜å‚¨ç­‰å¾…çš„ä»»åŠ¡\nDelayQueue å†…éƒ¨å°è£…äº†ä¸€ä¸ª PriorityQueueï¼Œå®ƒä¼šæ ¹æ® time çš„å…ˆåæ—¶é—´æ’åºï¼Œè‹¥ time ç›¸åŒåˆ™æ ¹æ® sequenceNumber æ’åºï¼› DelayQueue ä¹Ÿæ˜¯ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ï¼› å·¥ä½œçº¿ç¨‹æ‰§è¡Œçš„è¿‡ç¨‹ï¼š å·¥ä½œçº¿ç¨‹ä¼šä» DelayQueue å–å·²ç»åˆ°æœŸçš„ä»»åŠ¡å»æ‰§è¡Œï¼› æ‰§è¡Œç»“æŸåé‡æ–°è®¾ç½®ä»»åŠ¡çš„åˆ°æœŸæ—¶é—´ï¼Œå†æ¬¡æ”¾å› DelayQueue ä¸‹é¢ä»æºç å±‚é¢çœ‹ä¸€ä¸‹å¤§ä½“æµç¨‹ï¼š\næ–°å»ºçº¿ç¨‹æ±  public ScheduledThreadPoolExecutor(int corePoolSize) { super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS, new DelayedWorkQueue()); } å¯ä»¥çœ‹å‡ºåº•å±‚è¿˜æ˜¯è°ƒç”¨ ThreadPoolExecutor ç±»ï¼Œé»˜è®¤ä½¿ç”¨å»¶æ—¶é˜Ÿåˆ—å½“åšä»»åŠ¡é˜Ÿåˆ—ã€‚\nä¸‹é¢çœ‹ä¸€ä¸‹ä»»åŠ¡æ˜¯å¦‚ä½•æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„ï¼Œä»¥åŠå¦‚ä½•æ‰§è¡Œçš„\næ·»åŠ ä»»åŠ¡ åœ¨æ–‡ç« å‰åŠéƒ¨åˆ†çš„åº”ç”¨ç¤ºä¾‹ä¸­executor.scheduleWithFixedDelay(new Task(2), 1000,3000, TimeUnit.MILLISECONDS); å°±æ˜¯æäº¤ä»»åŠ¡çš„å…¥å£äº†ã€‚è¿›ä¸€æ­¥æŸ¥çœ‹æºç ï¼š\npublic ScheduledFuture\u0026lt;?\u0026gt; scheduleWithFixedDelay(Runnable command, long initialDelay, long delay, TimeUnit unit) { if (command == null || unit == null) throw new NullPointerException(); if (delay \u0026lt;= 0) throw new IllegalArgumentException(); // å°†ä»»åŠ¡åŒ…è£…æˆ ScheduledFutureTask ç±»å‹ ScheduledFutureTask\u0026lt;Void\u0026gt; sft = new ScheduledFutureTask\u0026lt;Void\u0026gt;(command, null, triggerTime(initialDelay, unit), unit.toNanos(-delay)); // å†æ¬¡è£…é¥°ä»»åŠ¡ï¼Œå¯ä»¥å¤å†™ decorateTask æ–¹æ³•ï¼Œå®šåˆ¶åŒ–ä»»åŠ¡ RunnableScheduledFuture\u0026lt;Void\u0026gt; t = decorateTask(command, sft); sft.outerTask = t; // æ”¾å…¥å»¶æ—¶é˜Ÿåˆ—ä¸­ï¼ŒScheduledFutureTask æ˜¯æ¥å£ RunnableScheduledFuture çš„ä¸€ä¸ªå®ç°ç±» // æ‰€ä»¥æ”¾å…¥é˜Ÿåˆ—è¿˜æ˜¯ ScheduledFutureTask ç±»å‹çš„ delayedExecute(t); return t; } å°†ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼š\nå–å‡ºä»»åŠ¡ å› ä¸ºæŠŠä»»åŠ¡æ”¾åœ¨äº†å»¶è¿Ÿé˜Ÿåˆ—ä¸­ï¼Œåœ¨å–å‡ºä»»åŠ¡çš„æ—¶å€™ä¸èƒ½å†å’Œæ™®é€šçš„é˜»å¡é˜Ÿåˆ—é‚£æ ·ï¼šåªè¦æœ‰ä»»åŠ¡å°±å¯ä»¥å–å‡ºæ¥ã€‚\nå»¶è¿Ÿé˜Ÿåˆ—ä¸­çš„æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªåˆ°æœŸæ—¶é—´ï¼Œåªæœ‰åˆ°æœŸçš„ä»»åŠ¡æ‰å¯ä»¥è¢«å–å‡ºï¼Œå¦åˆ™å–å‡ºåŠ¨ä½œä¼šè¢«é˜»å¡ã€‚è¿™é‡Œä¸ç»†è®²å»¶è¿Ÿé˜Ÿåˆ—çš„å®ç°æ–¹å¼ï¼Œåªéœ€çŸ¥é“å»¶è¿Ÿé˜Ÿåˆ—ä¸­çš„å…ƒç´ è¦å®ç° Delayed æ¥å£ä¸­çš„ getDelayed() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›äº†è¯¥ä»»åŠ¡è¿˜æœ‰å¤šä¹…åˆ°æœŸã€‚æºç å¦‚ä¸‹ï¼š\npublic long getDelay(TimeUnit unit) { // ä¸‹æ¬¡è¦æ‰§è¡Œçš„æ—¶é—´ - å½“å‰æ—¶é—´ return unit.convert(time - now(), NANOSECONDS); } å¦‚æœ getDelay è¿”å›çš„å€¼å°äºç­‰äº 0ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ‰§è¡Œè¯¥ä»»åŠ¡äº†ã€‚ time å±æ€§æ˜¯ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œçš„æ—¶é—´ï¼Œä¸‹é¢ä¼šè®²åˆ°ã€‚\næ‰§è¡Œä»»åŠ¡ é€šè¿‡ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œå¤šåŠæ˜¯è°ƒç”¨è¿™ä¸ªä»»åŠ¡çš„ run() æ–¹æ³•ï¼Œç°åœ¨çœ‹ä¸€ä¸‹ ScheduledFutureTask çš„å®ç°ï¼š\npublic void run() { boolean periodic = isPeriodic(); // å¦‚æœçº¿ç¨‹å·²ç»ä¸æ”¯æŒæ‰§è¡Œä»»åŠ¡ï¼Œåˆ™å–æ¶ˆä»»åŠ¡ if (!canRunInCurrentRunState(periodic)) cancel(false); // å¦‚æœè¯¥ä»»åŠ¡ä¸æ˜¯å‘¨æœŸæ€§çš„ï¼Œç›´æ¥æ‰§è¡Œ run æ–¹æ³•ï¼Œç„¶åç»“æŸ else if (!periodic) ScheduledFutureTask.super.run(); // å¦‚æœéœ€è¦å‘¨æœŸæ‰§è¡Œï¼Œé‚£ä¹ˆå…ˆæ‰§è¡Œï¼Œç„¶åè®¾ç½®ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ else if (ScheduledFutureTask.super.runAndReset()) { // è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œè¯¥ä»»åŠ¡çš„æ—¶é—´ setNextRunTime(); // å†æ¬¡å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œé‡å¤æ‰§è¡Œ reExecutePeriodic(outerTask); } } è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ å·²ç»è®²è¿‡ï¼Œæœ‰ä¸¤ç§æ‰§è¡Œä»»åŠ¡çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯å‘¨æœŸæ€§çš„ä»»åŠ¡ï¼Œåœ¨åº•å±‚æ˜¯è¿™æ ·åŒºåˆ†çš„\nå·§å¦™åœ°åˆ©ç”¨æ­£è´Ÿä½œä¸ºä¸€ä¸ªä»»åŠ¡ç±»å‹çš„æ ‡è¯†ï¼Œåœ¨åé¢çš„åˆ¤æ–­ä¸­å°±å¯ä»¥åˆ©ç”¨æ­£è´Ÿå·åŒºåˆ†ï¼Œè®¡ç®—æ—¶ï¼ŒæŠŠè´Ÿæ•°è½¬æˆæ­£æ•°å³å¯\nå¦‚ä¸‹ï¼š\n// è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ private void setNextRunTime() { long p = period; // å›ºå®šå‘¨æœŸå‹ä»»åŠ¡ if (p \u0026gt; 0) time += p; else // å›ºå®šé—´éš”å‹ä»»åŠ¡ï¼Œç»†èŠ‚ä¸å†å±•å¼€ time = triggerTime(-p); } æˆ‘ä»¬å·²ç»çœ‹äº†ä»»åŠ¡çš„æ·»åŠ ï¼Œä»¥åŠä»»åŠ¡çš„æ‰§è¡Œ\nå»¶æ—¶é˜Ÿåˆ—çš„ç‰¹æ€§ ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ªå‘¨æœŸæ€§ä»»åŠ¡æ‰§è¡Œçš„å…¨éƒ¨äº†ã€‚ä½†æ˜¯æ²¡æœ‰è¯´é˜Ÿåˆ—ä¸­å¦‚æœå­˜åœ¨å¤šä¸ªä»»åŠ¡æ€ä¹ˆåŠï¼Ÿ\nä»»åŠ¡çš„æ’åº å¦‚æœé˜Ÿåˆ—ä¸­åŒ…å«å¤šä¸ªä»»åŠ¡ï¼Œå»¶è¿Ÿé˜Ÿåˆ—è¿˜ä¼šæŠŠä»»åŠ¡ä»¥åˆ°æœŸæ—¶é—´æ’åºï¼Œå¯¹å¤´æ°¸è¿œæ˜¯æœ€å…ˆåˆ°æœŸçš„é‚£ä¸ªä»»åŠ¡ï¼Œå¦‚æœåˆ°æœŸæ—¶é—´ç›¸åŒï¼Œåˆ™æŒ‰è¿›å…¥é˜Ÿåˆ—çš„é¡ºåºæ’ã€‚\n\u0026ldquo;å»¶è¿Ÿé˜Ÿåˆ—è¿˜ä¼šæŠŠä»»åŠ¡ä»¥åˆ°æœŸæ—¶é—´æ’åº\u0026rdquo;, è¿™å…¶å®å¹¶ä¸æ˜¯å»¶æ—¶é˜Ÿåˆ—å®ç°çš„åŠŸèƒ½ï¼Œè€Œæ˜¯è°ƒç”¨äº†é˜Ÿåˆ—ä¸­ä»»åŠ¡çš„ compareTo æ–¹æ³•æ¥æ’åºçš„ï¼Œè¿™å°±è¦æ±‚é˜Ÿåˆ—ä¸­çš„å…ƒç´ å®ç° Comparable æ¥å£ä¸­çš„ compareTo æ–¹æ³•ã€‚ æ˜¯çš„ï¼Œ ScheduledFutureTask æ­£æ˜¯å®ç°äº†è¿™ä¸ªæ–¹æ³•ï¼š\npublic int compareTo(Delayed other) { if (other == this) // compare zero if same object return 0; if (other instanceof ScheduledFutureTask) { ScheduledFutureTask\u0026lt;?\u0026gt; x = (ScheduledFutureTask\u0026lt;?\u0026gt;)other; // æ¯”è¾ƒåˆ°æœŸæ—¶é—´ long diff = time - x.time; if (diff \u0026lt; 0) // å½“å‰ä»»åŠ¡å°ï¼Œ return -1; else if (diff \u0026gt; 0) // å½“å‰ä»»åŠ¡å¤§ return 1; else if (sequenceNumber \u0026lt; x.sequenceNumber) // å¦‚æœç›¸ç­‰ï¼ŒæŒ‰ sequenceNumber æ’åºï¼Œå°çš„åœ¨å‰ return -1; else return 1; } long diff = getDelay(NANOSECONDS) - other.getDelay(NANOSECONDS); return (diff \u0026lt; 0) ? -1 : (diff \u0026gt; 0) ? 1 : 0; } æ¯æ¬¡åªæ˜¯ä»å¯¹å¤´è·å–å…ƒç´ ï¼Œæ‰€ä»¥åªéœ€ä¿è¯å¯¹å¤´çš„å…ƒç´ æ˜¯æœ€å°çš„å³å¯ã€‚åº•å±‚å¹¶æ²¡æœ‰æŠŠæ•´ä¸ªé˜Ÿåˆ—ä¸­çš„å…ƒç´ åšå…¨æ’åºï¼Œè€Œæ˜¯ç»´æŠ¤äº†ä¸€ä¸ªå †çš„é€»è¾‘æ•°æ®ç»“æ„ä¿è¯å¯¹å¤´å…ƒç´ æ°¸è¿œæ˜¯æœ€å°çš„ã€‚å…³äºå †çš„ä»‹ç»ï¼Œåç»­ä¼šå†™ç¯‡åšå®¢å•ç‹¬ä»‹ç»\nè¿™ç¯‡æ–‡ç« å¹¶æ²¡æœ‰å¤ªè¿‡è¯¦ç»†çš„è®²è§£çº¿ç¨‹æ± æ›´åº•å±‚çš„é€»è¾‘ï¼Œåªæ˜¯ä»‹ç»äº†å‡ ä¸ªé‡ç‚¹æ–¹æ³•ï¼Œå› ä¸ºå¤§è‡´æ€æƒ³å’Œä¹‹å‰è®²çš„ AQS å·®ä¸å¤ªå¤šï¼Œéœ€è¦è€ƒè™‘å¾ˆå¤šå¹¶å‘çš„åœºæ™¯ï¼ŒåŠ å…¥å¾ˆå¤šé™åˆ¶\n","date":"2022-10-24T08:55:22Z","permalink":"https://dccmmtop.github.io/posts/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%92%8C%E5%91%A8%E6%9C%9F%E6%80%A7%E4%BB%BB%E5%8A%A1%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%BA%94%E7%94%A8%E5%8F%8A%E5%8E%9F%E7%90%86/","section":"posts","tags":["java","hidden"],"title":"å®šæ—¶ä»»åŠ¡å’Œå‘¨æœŸæ€§ä»»åŠ¡çº¿ç¨‹æ± çš„åº”ç”¨åŠåŸç†"},{"categories":null,"contents":"ThreadPoolExecute ä½¿ç”¨ç¤ºä¾‹ public class User { public static void main(String[] args) { ThreadPoolExecutor executor = new ThreadPoolExecutor(2,10,60, TimeUnit.SECONDS,new ArrayBlockingQueue\u0026lt;Runnable\u0026gt;(10)); for(int i =0 ;i \u0026lt; 20; i ++){ executor.execute(new Task(i)); } executor.shutdown(); } } class Task implements Runnable { int i; public Task(int i ) { this.i = i; } @Override public void run() { System.out.println(new Date() + \u0026#34;:\u0026#34;+ i + \u0026#34;:\u0026#34; + Thread.currentThread().getName()); try { Thread.sleep(2000); } catch (InterruptedException e) { e.printStackTrace(); } } } å…ˆä½¿ç”¨æ„é€ æ–¹æ³•ç”Ÿæˆä¸€ä¸ªçº¿ç¨‹æ± å¯¹è±¡ï¼Œç„¶åä½¿ç”¨ execute æ–¹æ³•å°†ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± \né‡è¦å±æ€§ private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));\nprivate static final int COUNT_BITS = Integer.SIZE - 3;\nprivate static final int CAPACITY = (1 \u0026lt;\u0026lt; COUNT_BITS) - 1;\nctl æ˜¯å¯¹çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€å’Œçº¿ç¨‹æ± ä¸­æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡è¿›è¡Œæ§åˆ¶çš„ä¸€ä¸ªå­—æ®µï¼Œå®ƒåŒ…å«ä¸¤éƒ¨åˆ†çš„ä¿¡æ¯ï¼šçº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ (runState) å’Œçº¿ç¨‹æ± å†…æœ‰æ•ˆçº¿ç¨‹çš„æ•°é‡ (workerCount)ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨äº† Integer ç±»å‹æ¥ä¿å­˜ï¼Œé«˜ 3 ä½ä¿å­˜ runStateï¼Œä½ 29 ä½ä¿å­˜workerCountã€‚COUNT_BITS å°±æ˜¯ 29ï¼ŒCAPACITY å°±æ˜¯ 1 å·¦ç§» 29 ä½å‡ 1ï¼ˆ29 ä¸ª 1ï¼‰ï¼Œè¿™ä¸ªå¸¸é‡è¡¨ç¤ºworkerCountçš„ä¸Šé™å€¼ï¼Œå¤§çº¦æ˜¯ 5 äº¿ã€‚\nctl ç›¸å…³æ–¹æ³•ï¼Œä¸ç”¨è¿‡äºçº ç»“å¦‚ä½•è®¡ç®—çš„ï¼ŒçŸ¥é“å³å¯\n// è·å–è¿è¡ŒçŠ¶æ€ï¼› private static int runStateOf(int c) { return c \u0026amp; ~CAPACITY; } //è·å–æ´»åŠ¨çº¿ç¨‹æ•°ï¼› private static int workerCountOf(int c) { return c \u0026amp; CAPACITY; } //è·å–è¿è¡ŒçŠ¶æ€å’Œæ´»åŠ¨çº¿ç¨‹æ•°çš„å€¼ã€‚clt è®°å½•ç€ runState å’Œ workerCount private static int ctlOf(int rs, int wc) { return rs | wc; } çº¿ç¨‹æ± çŠ¶æ€è§£é‡Š RUNNING çŠ¶æ€è¯´æ˜ï¼šçº¿ç¨‹æ± å¤„åœ¨ RUNNING çŠ¶æ€æ—¶ï¼Œèƒ½å¤Ÿæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä»¥åŠå¯¹å·²æ·»åŠ çš„ä»»åŠ¡è¿›è¡Œå¤„ç†ã€‚ çŠ¶æ€åˆ‡æ¢ï¼šçº¿ç¨‹æ± çš„åˆå§‹åŒ–çŠ¶æ€æ˜¯ RUNNINGã€‚æ¢å¥è¯è¯´ï¼Œçº¿ç¨‹æ± è¢«ä¸€æ—¦è¢«åˆ›å»ºï¼Œå°±å¤„äº RUNNING çŠ¶æ€ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡æ•°ä¸º 0ï¼ SHUTDOWN çŠ¶æ€è¯´æ˜ï¼šçº¿ç¨‹æ± å¤„åœ¨ SHUTDOWN çŠ¶æ€æ—¶ï¼Œä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†èƒ½å¤„ç†å·²æ·»åŠ çš„ä»»åŠ¡ã€‚ çŠ¶æ€åˆ‡æ¢ï¼šè°ƒç”¨çº¿ç¨‹æ± çš„ shutdown() æ¥å£æ—¶ï¼Œçº¿ç¨‹æ± ç”± RUNNING -\u0026gt; SHUTDOWNã€‚ STOP çŠ¶æ€è¯´æ˜ï¼šçº¿ç¨‹æ± å¤„åœ¨ STOP çŠ¶æ€æ—¶ï¼Œä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¸å¤„ç†å·²æ·»åŠ çš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä¼šä¸­æ–­æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ã€‚ çŠ¶æ€åˆ‡æ¢ï¼šè°ƒç”¨çº¿ç¨‹æ± çš„shutdownNow()æ¥å£æ—¶ï¼Œçº¿ç¨‹æ± ç”± (RUNNING or SHUTDOWN ) -\u0026gt; STOPã€‚ TIDYING çŠ¶æ€è¯´æ˜ï¼šå½“æ‰€æœ‰çš„ä»»åŠ¡å·²ç»ˆæ­¢ï¼Œctlè®°å½•çš„â€ä»»åŠ¡æ•°é‡â€ä¸º 0ï¼Œçº¿ç¨‹æ± ä¼šå˜ä¸º TIDYING çŠ¶æ€ã€‚å½“çº¿ç¨‹æ± å˜ä¸º TIDYING çŠ¶æ€æ—¶ï¼Œä¼šæ‰§è¡Œé’©å­å‡½æ•° terminated()ã€‚terminated() åœ¨ ThreadPoolExecutorç±»ä¸­æ˜¯ç©ºçš„ï¼Œè‹¥ç”¨æˆ·æƒ³åœ¨çº¿ç¨‹æ± å˜ä¸º TIDYING æ—¶ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼›å¯ä»¥é€šè¿‡é‡è½½ terminated() å‡½æ•°æ¥å®ç°ã€‚\nçŠ¶æ€åˆ‡æ¢ï¼šå½“çº¿ç¨‹æ± åœ¨ SHUTDOWN çŠ¶æ€ä¸‹ï¼Œé˜»å¡é˜Ÿåˆ—ä¸ºç©ºå¹¶ä¸”çº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡ä¹Ÿä¸ºç©ºæ—¶ï¼Œå°±ä¼šç”± SHUTDOWN -\u0026gt; TIDYINGã€‚å½“çº¿ç¨‹æ± åœ¨ STOP çŠ¶æ€ä¸‹ï¼Œçº¿ç¨‹æ± ä¸­æ‰§è¡Œçš„ä»»åŠ¡ä¸ºç©ºæ—¶ï¼Œå°±ä¼šç”± STOP -\u0026gt; TIDYINGã€‚\nTERMINATED çŠ¶æ€è¯´æ˜ï¼šçº¿ç¨‹æ± å½»åº•ç»ˆæ­¢ï¼Œå°±å˜æˆ TERMINATED çŠ¶æ€ã€‚\nçŠ¶æ€åˆ‡æ¢ï¼šçº¿ç¨‹æ± å¤„åœ¨ TIDYING çŠ¶æ€æ—¶ï¼Œæ‰§è¡Œå®Œ terminated() ä¹‹åï¼Œå°±ä¼šç”± TIDYING -\u0026gt; TERMINATEDã€‚\nè¿›å…¥ TERMINATED çš„æ¡ä»¶å¦‚ä¸‹ï¼š\nçº¿ç¨‹æ± ä¸æ˜¯ RUNNING çŠ¶æ€ï¼› çº¿ç¨‹æ± çŠ¶æ€ä¸æ˜¯ TIDYING çŠ¶æ€æˆ– TERMINATED çŠ¶æ€ï¼› å¦‚æœçº¿ç¨‹æ± çŠ¶æ€æ˜¯ SHUTDOWN å¹¶ä¸”workerQueueä¸ºç©ºï¼› workerCount ä¸º0ï¼› è®¾ç½® TIDYING çŠ¶æ€æˆåŠŸã€‚ execute æ–¹æ³• åœ¨ çº¿ç¨‹æ± åº”ç”¨ ä¸­è®²è¿‡çº¿ç¨‹çš„æ‰§è¡Œé¡ºåºï¼š\nå½“çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œåˆ›å»ºçº¿ç¨‹ã€‚\nå½“çº¿ç¨‹æ•°å¤§äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¸”ä»»åŠ¡é˜Ÿåˆ—æœªæ»¡æ—¶ï¼Œå°†ä»»åŠ¡æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚\nå½“çº¿ç¨‹æ•°å¤§äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¸”ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼š\nè‹¥çº¿ç¨‹æ•°å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ›å»ºçº¿ç¨‹ã€‚\nè‹¥çº¿ç¨‹æ•°ç­‰äºæœ€å¤§çº¿ç¨‹æ•°ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œæ‹’ç»ä»»åŠ¡ã€‚\nä¼˜å…ˆçº§ï¼š æ ¸å¿ƒçº¿ç¨‹æ•° \u0026gt; ä»»åŠ¡é˜Ÿåˆ— \u0026gt; æœ€å¤§çº¿ç¨‹æ•° \u0026gt; æ‹’ç»ä»»åŠ¡\næˆ‘ä»¬ç°åœ¨æ¥çœ‹ä¸€ä¸‹æ˜¯å¦‚ä½•å®ç°è¿™ä¸ªè§„åˆ™çš„\npublic void execute(Runnable command) { if (command == null) throw new NullPointerException(); int c = ctl.get(); //è·å–çº¿ç¨‹æ± çš„çŠ¶æ€å’Œæ•°é‡ if (workerCountOf(c) \u0026lt; corePoolSize) { // å¦‚æœçº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•° // ç¬¬äºŒä¸ªå‚æ•°æ˜¯ trueï¼Œä»£è¡¨å°†åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹ ä¸º false æ—¶åˆ›å»ºçš„æ˜¯éæ ¸å¿ƒçº¿ç¨‹ // ä»¥æ­¤æ¥åˆ¤æ–­çº¿ç¨‹æ•°æ˜¯è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°è¿˜æ˜¯è¶…è¿‡äº†æœ€å¤§çº¿ç¨‹æ•° if (addWorker(command, true)) // åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å¹¶æ‰§è¡Œ return; // ç»“æŸ c = ctl.get(); } // å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜çº¿ç¨‹æ•° \u0026gt; æ ¸å¿ƒçº¿ç¨‹æ•° if (isRunning(c) \u0026amp;\u0026amp; workQueue.offer(command)) { // å¦‚æœå…¥é˜ŸæˆåŠŸ int recheck = ctl.get(); // å†æ¬¡æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± æ²¡æœ‰åœ¨è¿è¡Œç”±äºä¹‹å‰å·²ç»æŠŠ command æ·»åŠ åˆ° workQueue ä¸­äº†ï¼Œ è¿™æ—¶éœ€è¦ç§»é™¤è¯¥ command if (! isRunning(recheck) \u0026amp;\u0026amp; remove(command)) reject(command); // æ ¹æ®æ‹’ç»ç­–ç•¥æ‹’ç»ä»»åŠ¡ else if (workerCountOf(recheck) == 0) // å¼‚å¸¸æƒ…å†µ addWorker(null, false); // ç¬¬ä¸€ä¸ªå‚æ•°ä¸º nullï¼Œè¡¨ç¤ºåœ¨çº¿ç¨‹æ± ä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä½†ä¸å»å¯åŠ¨ï¼› } // æ‰§è¡Œåˆ°è¿™é‡Œï¼Œå…¥é˜Ÿå¤±è´¥ï¼Œè¯´æ˜é˜Ÿåˆ—å·²æ»¡ else if (!addWorker(command, false))// æ–°å¢éæ ¸å¿ƒçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ reject(command); // å¦‚æœå·²è¾¾åˆ°æœ€å¤§æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæ‹’ç»ä»»åŠ¡ } æµç¨‹å›¾è¡¨ç¤ºå¦‚ä¸‹ï¼š\naddWorker æ–¹æ³• è¯¥æ–¹æ³•ä¼šæ¥æ”¶ä¸€ä¸ªå¯è¿è¡Œçš„ä»»åŠ¡ï¼Œå’Œä¸€ä¸ªæ ‡è¯†ç¬¦ coreï¼Œå¦‚æœ core ä¸º true, åˆ¤æ–­å½“å‰çº¿ç¨‹æ•°æ˜¯è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚å¦‚æœ core ä¸º falseï¼Œå°±åˆ¤æ–­å½“å‰çº¿ç¨‹æ•°æ˜¯å¦è¶…è¿‡äº†æœ€å¤§æ ¸å¿ƒæ•°\naddWorker æ–¹æ³•ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå¹¶å¼€å§‹æ‰§è¡Œæºå¸¦çš„ä»»åŠ¡â€”â€”firstTask, è¯¥ä»»åŠ¡æ‰§è¡Œç»“æŸåï¼Œä¼šæ­»å¾ªç¯çš„ä»é˜»å¡ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–æ–°ä»»åŠ¡ï¼Œå¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œè¯¥çº¿ç¨‹å°±ä¼šé˜»å¡ã€‚æºç å¦‚ä¸‹ï¼š\nprivate boolean addWorker(Runnable firstTask, boolean core) { retry: for (;;) { int c = ctl.get(); int rs = runStateOf(c); // çº¿ç¨‹æ± çŠ¶æ€ // Check if queue empty only if necessary. if (rs \u0026gt;= SHUTDOWN \u0026amp;\u0026amp; ! (rs == SHUTDOWN \u0026amp;\u0026amp; firstTask == null \u0026amp;\u0026amp; ! workQueue.isEmpty())) // çº¿ç¨‹æ± çŠ¶æ€åˆ¤æ–­ï¼Œå‚æ•°æ ¡éªŒ return false; for (;;) { int wc = workerCountOf(c); // è·å–çº¿ç¨‹æ•° // ä½¿ç”¨ core æ ‡è¯†ç¬¦åˆ¤æ–­ï¼Œçº¿ç¨‹æ•°é‡çš„ä¸Šé™æ˜¯å“ªä¸ªï¼Œä½†æ€»å…±ä¸èƒ½è¶…è¿‡æœ€å¤§å®¹é‡ if (wc \u0026gt;= CAPACITY || wc \u0026gt;= (core ? corePoolSize : maximumPoolSize)) return false; // cas æ–¹å¼å¢åŠ çº¿ç¨‹æ•°é‡ï¼Œå¦‚æœå¤±è´¥ï¼Œ if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) // è€ƒè™‘åˆ°å¹¶å‘åœºæ™¯ï¼Œå†è¯»ä¸€æ¬¡ continue retry; // else CAS failed due to workerCount change; retry inner loop } } boolean workerStarted = false; boolean workerAdded = false; Worker w = null; try { // å°†ä»»åŠ¡åŒ…è£…æˆä¸€ä¸ª worker, worker æ˜¯åŒ…å«ä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªä»»åŠ¡çš„ç»“æ„ï¼Œä¸‹é¢ä¼šä»‹ç» w = new Worker(firstTask); final Thread t = w.thread; if (t != null) { final ReentrantLock mainLock = this.mainLock; mainLock.lock(); //å› ä¸ºéœ€è¦çº¿ç¨‹æ± çŠ¶æ€åšä¸€äº›åˆ¤æ–­ï¼Œçº¿ç¨‹æ± çŠ¶æ€æ˜¯å…±æœ‰çš„èµ„æºï¼Œéœ€è¦åŠ é” try { // Recheck while holding lock. // Back out on ThreadFactory failure or if // shut down before lock acquired. int rs = runStateOf(ctl.get()); if (rs \u0026lt; SHUTDOWN || (rs == SHUTDOWN \u0026amp;\u0026amp; firstTask == null)) { if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); workers.add(w); // è®°å½•è¯¥ worker, workers æ˜¯ä¸€ä¸ª HashSet int s = workers.size(); // largestPoolSize è®°å½•ç€çº¿ç¨‹æ± ä¸­å‡ºç°è¿‡çš„æœ€å¤§çº¿ç¨‹æ•°é‡ if (s \u0026gt; largestPoolSize) largestPoolSize = s; workerAdded = true; } } finally { mainLock.unlock(); } if (workerAdded) { // å¯åŠ¨ woker ä¸­çš„çº¿ç¨‹ï¼Œå¼€å§‹æ‰§è¡Œä»»åŠ¡äº† t.start(); workerStarted = true; } } } finally { if (! workerStarted) addWorkerFailed(w); } return workerStarted; } Worker worker æ˜¯ä¸€ä¸ªåŒ…å«äº†å¯æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå’Œç”¨æ¥æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ï¼Œå®ƒå®ç°äº†Runnable æ¥å£ï¼Œæœ¬èº«ä¹Ÿå¯ä»¥å½“ä½œä¸€ä¸ªä»»åŠ¡è¿è¡Œã€‚éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š\nprivate final class Worker extends AbstractQueuedSynchronizer implements Runnable { /** Thread this worker is running in. Null if factory fails. */ final Thread thread; /** Initial task to run. Possibly null. */ Runnable firstTask; /** Per-thread task counter */ volatile long completedTasks; // è®°å½•çº¿ç¨‹å®Œæˆçš„ä»»åŠ¡çš„ä¸ªæ•° /** * Creates with given first task and thread from ThreadFactory. * @param firstTask the first task (null if none) */ // æ„é€  worker Worker(Runnable firstTask) { setState(-1); // inhibit interrupts until runWorker this.firstTask = firstTask; this.thread = getThreadFactory().newThread(this); // ç”Ÿæˆæ–°çš„çº¿ç¨‹ } /** Delegates main run loop to outer runWorker */ // çœŸæ­£æ‰§è¡Œä»»åŠ¡çš„åœ°æ–¹ public void run() { runWorker(this); } // ... çœç•¥ // è·å–é” protected boolean tryAcquire(int unused) { if (compareAndSetState(0, 1)) { setExclusiveOwnerThread(Thread.currentThread()); return true; } return false; } } Worker ç»§æ‰¿äº† AQSï¼Œä½¿ç”¨ AQS æ¥å®ç°ç‹¬å é”çš„åŠŸèƒ½ã€‚ä¸ºä»€ä¹ˆä¸ä½¿ç”¨ReentrantLockæ¥å®ç°å‘¢ï¼Ÿå¯ä»¥çœ‹åˆ°tryAcquireæ–¹æ³•ï¼Œå®ƒæ˜¯ä¸å…è®¸é‡å…¥çš„ï¼Œè€Œ ReentrantLock æ˜¯å…è®¸é‡å…¥çš„ï¼š\nlock æ–¹æ³•ä¸€æ—¦è·å–äº†ç‹¬å é”ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œä»»åŠ¡ä¸­ï¼› å¦‚æœæ­£åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™ä¸åº”è¯¥ä¸­æ–­çº¿ç¨‹ï¼› å¦‚æœè¯¥çº¿ç¨‹ç°åœ¨ä¸æ˜¯ç‹¬å é”çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ç©ºé—²çš„çŠ¶æ€ï¼Œè¯´æ˜å®ƒæ²¡æœ‰åœ¨å¤„ç†ä»»åŠ¡ï¼Œè¿™æ—¶å¯ä»¥å¯¹è¯¥çº¿ç¨‹è¿›è¡Œä¸­æ–­ï¼› çº¿ç¨‹æ± åœ¨æ‰§è¡Œ shutdown æ–¹æ³•æˆ– tryTerminate æ–¹æ³•æ—¶ä¼šè°ƒç”¨ interruptIdleWorkers æ–¹æ³•æ¥ä¸­æ–­ç©ºé—²çš„çº¿ç¨‹ï¼ŒinterruptIdleWorkers æ–¹æ³•ä¼šä½¿ç”¨ tryLock æ–¹æ³•æ¥åˆ¤æ–­çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦æ˜¯ç©ºé—²çŠ¶æ€ï¼› ä¹‹æ‰€ä»¥è®¾ç½®ä¸ºä¸å¯é‡å…¥ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›ä»»åŠ¡åœ¨è°ƒç”¨åƒ setCorePoolSize è¿™æ ·çš„çº¿ç¨‹æ± æ§åˆ¶æ–¹æ³•æ—¶é‡æ–°è·å–é”ã€‚å¦‚æœä½¿ç”¨ ReentrantLockï¼Œå®ƒæ˜¯å¯é‡å…¥çš„ï¼Œè¿™æ ·å¦‚æœåœ¨ä»»åŠ¡ä¸­è°ƒç”¨äº†å¦‚ setCorePoolSize è¿™ç±»çº¿ç¨‹æ± æ§åˆ¶çš„æ–¹æ³•ï¼Œä¼šä¸­æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ã€‚ æ‰€ä»¥ï¼ŒWorker ç»§æ‰¿è‡ª AQSï¼Œç”¨äºåˆ¤æ–­çº¿ç¨‹æ˜¯å¦ç©ºé—²ä»¥åŠæ˜¯å¦å¯ä»¥è¢«ä¸­æ–­ã€‚\næ­¤å¤–ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­æ‰§è¡Œäº† setState(-1);ï¼ŒæŠŠ state å˜é‡è®¾ç½®ä¸º-1ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿæ˜¯å› ä¸º AQS ä¸­é»˜è®¤çš„ state æ˜¯ 0ï¼Œå¦‚æœåˆšåˆ›å»ºäº†ä¸€ä¸ª Worker å¯¹è±¡ï¼Œè¿˜æ²¡æœ‰æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œè¿™æ—¶å°±ä¸åº”è¯¥è¢«ä¸­æ–­ï¼Œ tryAcquire æ–¹æ³•æ˜¯æ ¹æ® state æ˜¯å¦æ˜¯ 0 æ¥åˆ¤æ–­çš„ï¼Œæ‰€ä»¥ï¼ŒsetState(-1); å°† state è®¾ç½®ä¸º-1 æ˜¯ä¸ºäº†ç¦æ­¢åœ¨æ‰§è¡Œä»»åŠ¡å‰å¯¹çº¿ç¨‹è¿›è¡Œä¸­æ–­ã€‚\næ­£å› ä¸ºå¦‚æ­¤ï¼Œåœ¨ runWorker æ–¹æ³•ä¸­ä¼šå…ˆè°ƒç”¨ Worker å¯¹è±¡çš„ unlock æ–¹æ³•å°† state è®¾ç½®ä¸º 0ã€‚\nä»ä¸Šé¢æºç ä¸­æ‹¿å‡ºï¼Œæœ€ç»ˆè°ƒç”¨ runWorker æ–¹æ³•å»æ‰§è¡Œä»»åŠ¡ï¼Œ runnerWorker æºç å¦‚ä¸‹ï¼š\nrunWorker final void runWorker(Worker w) { Thread wt = Thread.currentThread(); Runnable task = w.firstTask; w.firstTask = null; w.unlock(); // å…è®¸ä¸­æ–­ boolean completedAbruptly = true; try { // å¾ªç¯è·å–ä»»åŠ¡ while (task != null || (task = getTask()) != null) { w.lock(); // å¦‚æœçº¿ç¨‹æ± æ­£åœ¨åœæ­¢ï¼Œé‚£ä¹ˆè¦ä¿è¯å½“å‰çº¿ç¨‹æ˜¯ä¸­æ–­çŠ¶æ€ï¼› // å¦‚æœä¸æ˜¯çš„è¯ï¼Œåˆ™è¦ä¿è¯å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸­æ–­çŠ¶æ€ï¼› if ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() \u0026amp;\u0026amp; runStateAtLeast(ctl.get(), STOP))) \u0026amp;\u0026amp; !wt.isInterrupted()) wt.interrupt(); try { // æ‰§è¡Œä»»åŠ¡ä¹‹å‰åšä¸€äº›äº‹æƒ…ï¼Œç±»ä¼¼äºå›è°ƒ beforeExecute(wt, task); Throwable thrown = null; try { // å¼€å§‹è¿è¡Œä»»åŠ¡ task.run(); } catch (RuntimeException x) { // è®°å½•å¼‚å¸¸ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸è·³å‡ºå¾ªç¯ï¼Œä¸‹åŒ thrown = x; throw x; } catch (Error x) { thrown = x; throw x; } catch (Throwable x) { thrown = x; throw new Error(x); } finally { // æ— è®ºæ˜¯å¦å‘ç”Ÿå¼‚å¸¸ï¼Œéƒ½è¦æ‰§è¡Œè¿™é‡Œ // ä»»åŠ¡æ‰§è¡Œç»“æŸè¦åšçš„äº‹æƒ…ï¼Œç±»ä¼¼äºå›è°ƒ afterExecute(task, thrown); } } finally { task = null; // è®°å½•å·²ç»å®Œæˆä»»åŠ¡çš„ä¸ªæ•° w.completedTasks++; w.unlock(); } } // æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æœªå‘ç”Ÿå¼‚å¸¸ completedAbruptly = false; } finally { processWorkerExit(w, completedAbruptly); } } å…³äºç¬¬ä¸€ä¸ª if è¯­å¥ï¼šè¿™é‡Œè¦è€ƒè™‘åœ¨æ‰§è¡Œè¯¥ if è¯­å¥æœŸé—´å¯èƒ½ä¹Ÿæ‰§è¡Œäº† shutdownNow æ–¹æ³•ï¼ŒshutdownNow æ–¹æ³•ä¼šæŠŠçŠ¶æ€è®¾ç½®ä¸º STOPï¼Œå›é¡¾ä¸€ä¸‹ STOP çŠ¶æ€ï¼š\nä¸èƒ½æ¥å—æ–°ä»»åŠ¡ï¼Œä¹Ÿä¸å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¼šä¸­æ–­æ­£åœ¨å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ã€‚åœ¨çº¿ç¨‹æ± å¤„äº RUNNING æˆ– SHUTDOWN çŠ¶æ€æ—¶ï¼Œè°ƒç”¨ shutdownNow() æ–¹æ³•ä¼šä½¿çº¿ç¨‹æ± è¿›å…¥åˆ°è¯¥çŠ¶æ€ã€‚ STOP çŠ¶æ€è¦ä¸­æ–­çº¿ç¨‹æ± ä¸­çš„æ‰€æœ‰çº¿ç¨‹ï¼Œè€Œè¿™é‡Œä½¿ç”¨ Thread.interrupted() æ¥åˆ¤æ–­æ˜¯å¦ä¸­æ–­æ˜¯ä¸ºäº†ç¡®ä¿åœ¨ RUNNING æˆ–è€… SHUTDOWN çŠ¶æ€æ—¶çº¿ç¨‹æ˜¯éä¸­æ–­çŠ¶æ€çš„ï¼Œå› ä¸º Thread.interrupted() æ–¹æ³•ä¼šå¤ä½ä¸­æ–­çš„çŠ¶æ€ã€‚\nå½“ä»»1ä¸‹é¢æƒ…å†µå‘ç”Ÿæ—¶ï¼Œå°±é€€å‡ºå¾ªç¯\nå½“ä»é˜Ÿåˆ—ä¸­è·å–çš„ä»»åŠ¡ä¸ºç©ºæ—¶ï¼Œé€€å‡ºå¾ªç¯ å‘ç”Ÿå¼‚å¸¸æ—¶\né€€å‡ºå¾ªç¯åè¿˜ä¼šæ‰§è¡Œä¸€ä¸ª processWorkerExit æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆ: processWorkerExit private void processWorkerExit(Worker w, boolean completedAbruptly) { // å¦‚æœç¨‹åºæ˜¯å‘ç”Ÿäº†å¼‚å¸¸ç»ˆæ­¢çš„ï¼Œéœ€è¦å¯¹çº¿ç¨‹æ•°å‡ä¸€æ“ä½œ,ä¸ºä»€ä¹ˆæ­£å¸¸æƒ…å†µé€€å‡ºï¼Œè€Œä¸éœ€è¦å‡ä¸€æ“ä½œäº†å‘¢ï¼Ÿ // å› ä¸ºåœ¨ getTask æ–¹æ³•ä¸­é’ˆå¯¹è¿™ç§æ­£å¸¸æƒ…å†µå·²ç»åšäº†å¤„ç†ã€‚ if (completedAbruptly) decrementWorkerCount(); final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try { // ç»Ÿè®¡å®Œæˆçš„ä»»åŠ¡æ•°ç›® completedTaskCount += w.completedTasks; // åˆ é™¤çº¿ç¨‹ workers.remove(w); } finally { mainLock.unlock(); } // åˆ¤æ–­æ˜¯å¦éœ€è¦ç»“æŸçº¿ç¨‹æ±  tryTerminate(); /* * å½“çº¿ç¨‹æ± æ˜¯RUNNINGæˆ–SHUTDOWNçŠ¶æ€æ—¶ï¼Œå¦‚æœworkeræ˜¯å¼‚å¸¸ç»“æŸï¼Œé‚£ä¹ˆä¼šç›´æ¥addWorkerï¼› * å¦‚æœallowCoreThreadTimeOut=trueï¼Œå¹¶ä¸”ç­‰å¾…é˜Ÿåˆ—æœ‰ä»»åŠ¡ï¼Œè‡³å°‘ä¿ç•™ä¸€ä¸ªworkerï¼› * å¦‚æœallowCoreThreadTimeOut=falseï¼ŒworkerCountä¸å°‘äºcorePoolSizeã€‚ */ int c = ctl.get(); if (runStateLessThan(c, STOP)) { if (!completedAbruptly) { int min = allowCoreThreadTimeOut ? 0 : corePoolSize; if (min == 0 \u0026amp;\u0026amp; ! workQueue.isEmpty()) min = 1; if (workerCountOf(c) \u0026gt;= min) return; // replacement not needed } addWorker(null, false); } } æ‰€ä»¥ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç»“æŸåå¯èƒ½éœ€è¦åšçš„äº‹æƒ…ï¼š\nå†æ¬¡æ·»åŠ ä¸€ä¸ªçº¿ç¨‹ ç»“æŸçº¿ç¨‹æ±  ä¸‹é¢çœ‹ä¸€ä¸‹ getTask æ–¹æ³•\ngetTask æ–¹æ³• private Runnable getTask() { // è¡¨ç¤ºä¸Šæ¬¡ä»ä»é˜»å¡é˜Ÿåˆ—ä¸­å–å€¼æ˜¯å¦è¶…æ—¶ boolean timedOut = false; // Did the last poll() time out? for (;;) { int c = ctl.get(); int rs = runStateOf(c); /* * å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ rs \u0026gt;= SHUTDOWNï¼Œä¹Ÿå°±æ˜¯é RUNNING çŠ¶æ€ï¼Œå†è¿›è¡Œä»¥ä¸‹åˆ¤æ–­ï¼š * 1. rs \u0026gt;= STOPï¼Œçº¿ç¨‹æ± æ˜¯å¦æ­£åœ¨ stopï¼› * 2. é˜»å¡é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºã€‚ * å¦‚æœä»¥ä¸Šæ¡ä»¶æ»¡è¶³ï¼Œåˆ™å°† workerCount å‡ 1 å¹¶è¿”å› nullã€‚ * å› ä¸ºå¦‚æœå½“å‰çº¿ç¨‹æ± çŠ¶æ€çš„å€¼æ˜¯ SHUTDOWN æˆ–ä»¥ä¸Šæ—¶ï¼Œä¸å…è®¸å†å‘é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ ä»»åŠ¡ã€‚ */ if (rs \u0026gt;= SHUTDOWN \u0026amp;\u0026amp; (rs \u0026gt;= STOP || workQueue.isEmpty())) { // å‡ä¸€ decrementWorkerCount(); return null; } int wc = workerCountOf(c); // æ ‡è®°æ˜¯å¦éœ€è¦è¿›è¡Œè¶…æ—¶å¤„ç† // alloCoreThreadTimeOut é»˜è®¤ä¸ºfalseï¼Œä¹Ÿå°±æ˜¯æ ¸å¿ƒçº¿ç¨‹é»˜è®¤ä¸å…è®¸è¶…æ—¶ // wc \u0026gt; corePoolSize, å·²ç»è¿›å…¥åˆ°éæ ¸å¿ƒçº¿ç¨‹çš„çŠ¶æ€ï¼Œå…è®¸è¶…æ—¶å¤„ç† boolean timed = allowCoreThreadTimeOut || wc \u0026gt; corePoolSize; // wc \u0026gt; maximumPoolSizeçš„æƒ…å†µæ˜¯å› ä¸ºå¯èƒ½åœ¨æ­¤æ–¹æ³•æ‰§è¡Œé˜¶æ®µåŒæ—¶æ‰§è¡Œäº†setMaximumPoolSizeæ–¹æ³•ï¼› // (timed \u0026amp;\u0026amp; timeout) è¡¨ç¤ºéœ€è¦è¶…æ—¶å¤„ç†ï¼Œå¹¶ä¸”ä¸Šæ¬¡è·å–ä»»åŠ¡è¶…æ—¶äº† // (wc \u0026gt; 1 || é˜Ÿåˆ—ä¸ºç©º) çº¿ç¨‹æ± ä¸­é™¤äº†å½“å‰çº¿ç¨‹è¿˜æœ‰å…¶ä»–å·¥ä½œçš„çº¿ç¨‹ æˆ–è€… ä»»åŠ¡é˜Ÿåˆ—å·²ç»ç©ºäº† // ç»ˆä¸Šæ‰€è¿°ï¼Œ1. å½“è·å–ä»»åŠ¡è¶…æ—¶ï¼ˆå¼‚å¸¸æˆ–è€…é˜Ÿåˆ—ä¸ºç©ºï¼‰ï¼Œå¹¶ä¸”è¿˜æœ‰å…¶ä»–çº¿ç¨‹å¯ä»¥ç»§ç»­å·¥ä½œï¼Œä¸ä¼šå‡ºç°æœ‰ä»»åŠ¡ä½†æ²¡çº¿ç¨‹çš„æƒ…å†µï¼Œå½“å‰çº¿ç¨‹å°±å¯ä»¥æ”¾å¿ƒé€€å‡ºäº†ï¼Œ // 2. å½“è·å–ä»»åŠ¡è¶…æ—¶ï¼ˆå¼‚å¸¸æˆ–è€…é˜Ÿåˆ—ä¸ºç©ºï¼‰ï¼Œå¹¶ä¸”æœ‰ä»»åŠ¡å¯ä»¥åšäº†ï¼Œå½“å‰çº¿ç¨‹å°±å¯ä»¥æ”¾å¿ƒçš„é€€å‡ºäº†ï¼Œ if ((wc \u0026gt; maximumPoolSize || (timed \u0026amp;\u0026amp; timedOut)) \u0026amp;\u0026amp; (wc \u0026gt; 1 || workQueue.isEmpty())) { // return äº†ï¼Œçº¿ç¨‹è¦ç»“æŸç”Ÿå‘½äº†ï¼ŒæŠŠçº¿ç¨‹æ•°é‡å‡ä¸€ã€‚å¦‚æœå‡å¤±è´¥äº†ï¼Œä¸‹æ¬¡å†å°è¯• if (compareAndDecrementWorkerCount(c)) return null; continue; } // æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è·å–ä»»åŠ¡, å°±å¼€å§‹å‡†å¤‡è·å–ä»»åŠ¡äº† // å¦‚æœè·å–å¤±è´¥ï¼Œæ‰“ä¸Šè¶…æ—¶çš„æ ‡è®°ï¼Œå¼€å§‹ä¸‹æ¬¡å¾ªç¯ï¼Œèµ°ä¸Šé¢çš„é€»è¾‘ï¼Œå¯èƒ½ä¼šç»“æŸè¿™ä¸ªçº¿ç¨‹ // å¦‚æœè·å–æˆåŠŸï¼Œç›´æ¥è¿”å›è¯¥ä»»åŠ¡ï¼Œåœ¨ runWork ä¸­æ‰§è¡Œäº†ã€‚ try { // ä¸‹é¢æ˜¯2ä¸­æ–¹å¼ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼Œæ ¹æ®çº¿ç¨‹æ•°é‡ï¼Œé‡‡ç”¨ä¸åŒçš„æ–¹å¼, è¯¦æƒ…å¯ä»¥æœç´¢é˜»å¡é˜Ÿåˆ— // 1. pool(time, unit): åªç­‰å¾…å›ºå®šçš„æ—¶é—´ï¼Œè¶…è¿‡å°±è¿”å›ç©º // 2. take(): æ— é™ç­‰å¾… Runnable r = timed ? workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take(); if (r != null) return r; // æ‰“ä¸Šè¶…æ—¶çš„æ ‡è®° timedOut = true; } catch (InterruptedException retry) { timedOut = false; } } } æ‰€ä»¥çº¿ç¨‹æ± ä¸­çš„ä¸€ä¸ªçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç»è¿‡ä¸‹é¢å‡ ä¸ªé‡ç‚¹æ–¹æ³•:\nexecute æ˜¯å…¥å£ï¼Œå†³å®šä»»åŠ¡æ˜¯åº”è¯¥ç«‹å³æ‰§è¡Œï¼Œè¿˜æ˜¯åŠ å…¥é˜Ÿåˆ—ä¸­ç­‰å¾…,æˆ–è€…æ‹’ç»ä»»åŠ¡ addWorker, æ–°å¢ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ runWorker: å¾ªç¯ä»é˜Ÿåˆ—è·å–ä»»åŠ¡ï¼Œæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœæœªè·å–åˆ°ä»»åŠ¡ï¼Œæˆ–è€…ä»»åŠ¡æ‰§è¡Œå¤±è´¥ï¼Œè·³å‡ºå¾ªç¯ï¼Œè¿›å…¥çº¿ç¨‹ç»ˆæ­¢æ–¹æ³• getTask è·å–ä»»åŠ¡,æ— æ³•è·å–åˆ°ä»»åŠ¡æ—¶ï¼Œå†³å®šç›´æ¥è¿”å›ç©ºï¼Œè¿˜æ˜¯ç»§ç»­ç­‰å¾…ä»»åŠ¡åˆ°æ¥ processWorkerExit, çº¿ç¨‹é€€å‡ºé˜¶æ®µï¼Œä¼šåšä¸€äº›çº¿ç¨‹çš„ç»Ÿè®¡å’Œè¡¥å¿å·¥ä½œï¼Œä»¥åŠæ›´æ”¹çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± è¿è¡Œä¸­ï¼Œä¸”è¿™ä¸ªçº¿ç¨‹æ˜¯å› ä¸ºå¼‚å¸¸é€€å‡ºçš„ï¼Œå°±é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„çº¿ç¨‹ï¼Œç»§ç»­å·¥ä½œã€‚ æµç¨‹å›¾å¦‚ä¸‹ï¼š\n","date":"2022-10-20T09:52:20Z","permalink":"https://dccmmtop.github.io/posts/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8E%9F%E7%90%86/","section":"posts","tags":["java"],"title":"çº¿ç¨‹æ± åŸç†"},{"categories":null,"contents":"java ä¸­çš„çº¿ç¨‹ çº¿ç¨‹æ˜¯è°ƒåº¦ CPU èµ„æºçš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ¨¡å‹åˆ†ä¸º KLT æ¨¡å‹ä¸ ULT æ¨¡å‹ï¼ŒJVM ä½¿ç”¨çš„ KLT æ¨¡\nå‹ï¼ŒJava çº¿ç¨‹ä¸ OS çº¿ç¨‹ä¿æŒ 1:1 çš„æ˜ å°„å…³ç³»ï¼Œä¹Ÿå°±æ˜¯è¯´æœ‰ä¸€ä¸ª java çº¿ç¨‹ä¹Ÿä¼šåœ¨æ“ä½œç³»ç»Ÿé‡Œæœ‰ä¸€ä¸ªå¯¹åº”çš„çº¿ç¨‹ã€‚\nJava çº¿ç¨‹æœ‰å¤šç§ç”Ÿå‘½çŠ¶æ€ ï¼š\nNEW, æ–°å»º RUNNABLE, è¿è¡Œ BLOCKED, é˜»å¡ WAITING, ç­‰å¾… TIMED_WAITING, è¶…æ—¶ç­‰å¾… TERMINATEDï¼Œç»ˆç»“ æ± åŒ–æ€æƒ³ æ± åŒ–æŠ€æœ¯æŒ‡çš„æ˜¯æå‰å‡†å¤‡ä¸€äº›èµ„æºï¼Œåœ¨éœ€è¦æ—¶å¯ä»¥é‡å¤ä½¿ç”¨è¿™äº›é¢„å…ˆå‡†å¤‡çš„èµ„æºã€‚è€Œè¿™ç§èµ„æºåˆ›å»ºçš„æˆæœ¬æ¯”è¾ƒé«˜ï¼Œä¾‹å¦‚çº¿ç¨‹ï¼Œå¤§å¯¹è±¡ï¼Œæ•°æ®åº“è¿æ¥ç­‰ã€‚\næ‰€ä»¥æ± åŒ–æŠ€æœ¯çš„å…³é”®æ˜¯ï¼š\nè¢«æ± åŒ–çš„å¯¹è±¡åˆ›å»ºæˆæœ¬é«˜ æå‰å‡†å¤‡ é‡å¤ä½¿ç”¨ çº¿ç¨‹æ±  çº¿ç¨‹æ± â€ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ç¼“å­˜ï¼Œçº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœè¢«æ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œå› æ­¤ Java ä¸­æä¾›çº¿ç¨‹æ± å¯¹çº¿ç¨‹è¿›è¡Œç»Ÿä¸€åˆ†é…ã€è°ƒä¼˜å’Œç›‘æ§\nä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº¿ç¨‹æ± ï¼Ÿ å•ä¸ªä»»åŠ¡å¤„ç†æ—¶é—´æ¯”è¾ƒçŸ­ éœ€è¦å¤„ç†çš„ä»»åŠ¡æ•°é‡å¾ˆå¤§ çº¿ç¨‹æ± ä¼˜åŠ¿ é‡ç”¨å­˜åœ¨çš„çº¿ç¨‹ï¼Œå‡å°‘çº¿ç¨‹åˆ›å»ºï¼Œæ¶ˆäº¡çš„å¼€é”€ï¼Œæé«˜æ€§èƒ½ æé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦çš„ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚ æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ çº¿ç¨‹æ± çš„ä½¿ç”¨ æœ‰å¸¸è§çš„ 5 ç§åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ï¼Œè¯´æ˜¯ 5 ç§ï¼Œå…¶å®å°± 2 ç§ã€‚ä¸€ç§æ˜¯é€šè¿‡ Executors å·¥å‚ç±»æä¾›çš„æ–¹æ³•ï¼Œè¯¥ç±»æä¾›äº† 4 ç§ä¸åŒçš„çº¿ç¨‹æ± å¯ä¾›ä½¿ç”¨ã€‚å¦ä¸€ç±»æ˜¯é€šè¿‡ ThreadPoolExecutor ç±»è¿›è¡Œè‡ªå®šä¹‰åˆ›å»ºã€‚\nnewCachedThreadPool ä¼šåˆ›å»ºä¸€ä¸ªå¯ç¼“å†²çš„çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ•°ä¸å¤Ÿæ—¶ï¼Œä¼šä¸€ç›´å¢åŠ åˆ°æœ€å¤§å€¼(Integer.MAXVALUE)ï¼Œå¦‚æœçº¿ç¨‹è¿‡å¤šï¼Œç”¨ä¸åˆ°äº†ï¼Œä¼šç¼“å­˜ 60 ç§’åé”€æ¯\nprivate static void createCachedThreadPool() { ExecutorService executorService = Executors.newCachedThreadPool(); for (int i = 0; i \u0026lt; 10; i++) { final int index = i; executorService.execute(() -\u0026gt; { System.out.println(System.currentMillions + \u0026#34;:\u0026#34; + Thread.currentThread().getName() + \u0026#34;:\u0026#34; + index); sleep(2000); }); } } newFixedThreadPool åˆ›å»ºä¸€ä¸ªå›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ± ï¼Œå¤„ç†ä¸è¿‡æ¥çš„ä»»åŠ¡ä¼šæ”¾åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™ä¸ªé˜Ÿåˆ—æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œæ²¡æœ‰å¤§å°\nprivate static void createFixedThreadPool() { ExecutorService executorService = Executors.newFixedThreadPool(3); for (int i = 0; i \u0026lt; 10; i++) { final int index = i; executorService.execute(() -\u0026gt; { System.out.println(Thread.currentThread().getName() + \u0026#34; \u0026#34; + index); sleep(2000); }); } } newScheduledThreadPool åˆ›å»ºä¸€ä¸ªå‘¨æœŸæ€§çš„çº¿ç¨‹æ± ï¼Œå¯ä»¥å®šæ—¶å‘¨æœŸæ€§çš„æ‰§è¡Œä»»åŠ¡ï¼Œåº•å±‚åˆ©ç”¨çš„æ˜¯å»¶æ—¶é˜Ÿåˆ—\nprivate static void createScheduledThreadPool() { ScheduledExecutorService executorService = Executors.newScheduledThreadPool(3); System.out.println(DateUtil.now() + \u0026#34; æäº¤ä»»åŠ¡\u0026#34;); for (int i = 0; i \u0026lt; 10; i++) { final int index = i; executorService.schedule(() -\u0026gt; { System.out.println(DateUtil.now() + \u0026#34; \u0026#34; + Thread.currentThread().getName() + \u0026#34; \u0026#34; + index); sleep(2000); }, 3, TimeUnit.SECONDS); } } newSingleThreadExcutor åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± \nprivate static void createSingleThreadPool() { ExecutorService executorService = Executors.newSingleThreadExecutor(); for (int i = 0; i \u0026lt; 10; i++) { final int index = i; executorService.execute(() -\u0026gt; { System.out.println(DateUtil.now() + \u0026#34; \u0026#34; + Thread.currentThread().getName() + \u0026#34; \u0026#34; + index); sleep(2000); }); } } ä¸Šé¢å››ç§æ˜¯ java ä¸ºæˆ‘ä»¬æä¾›çš„å‡ ä¸ªä¾¿æ·æ–¹æ³•ï¼Œæ¥åˆ›å»ºä¸åŒç”¨é€”çš„çº¿ç¨‹æ± ï¼Œè™½ç„¶æ¯”è¾ƒä¾¿æ·ï¼Œå‚æ•°å¾ˆå°‘ï¼Œå‡è½»å¼€å‘è€…çš„è´Ÿæ‹…ï¼Œä½†æ˜¯ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™æ ·ï¼Œå¹¶ä¸èƒ½å¾ˆå¥½çš„ä½¿ç”¨ä¸å®é™…ç”Ÿäº§ç¯å¢ƒï¼Œæ¯”å¦‚ newFixedThreadPool ï¼Œä½¿ç”¨çš„æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œè¿™åœ¨ç”Ÿäº§ä¸­æ˜¯ä¸å…è®¸çš„ã€‚é˜¿é‡Œå·´å·´ java å¼€å‘è§„èŒƒä¸­æ˜ç¡®ç¦æ­¢ä½¿ç”¨ä¸Šé¢å››ç§æ–¹å¼åˆ›å»ºçº¿ç¨‹æ± ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸‹é¢è‡ªå®šä¹‰çº¿ç¨‹æ± çš„æ–¹å¼ã€‚\nThreadPoolExecutor è‡ªå®šä¹‰çº¿ç¨‹æ±  public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue\u0026lt;Runnable\u0026gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) { } å‚æ•°è§£é‡Š å…± 7 ä¸ªå‚æ•°å¦‚ä¸‹ï¼š\ncorePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± ä¸­å§‹ç»ˆå­˜æ´»çš„çº¿ç¨‹æ•°ã€‚ maximumPoolSize: æœ€å¤§çº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚ keepAliveTime: å­˜æ´»æ—¶é—´ï¼Œçº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ‰§è¡Œæ—¶æœ€å¤šä¿æŒå¤šä¹…æ—¶é—´ä¼šç»ˆæ­¢ã€‚ unit: å•ä½ï¼Œå‚æ•° keepAliveTime çš„æ—¶é—´å•ä½ï¼Œ7 ç§å¯é€‰ã€‚ TimeUnit.DAYS å¤© TimeUnit.HOURS å°æ—¶ TimeUnit.MINUTES åˆ† TimeUnit.SECONDS ç§’ TimeUnit.MILLISECONDS æ¯«ç§’ TimeUnit.MICROSECONDS å¾®å¦™ TimeUnit.NANOSECONDS çº³ç§’ workQueue: ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œç”¨æ¥å­˜å‚¨ç­‰å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå‡ä¸ºçº¿ç¨‹å®‰å…¨ï¼Œ7 ç§ï¼š ArrayBlockingQueue ä¸€ä¸ªç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ LinkedBlockingQueue ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ SynchronousQueue ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œå³ç›´æ¥æäº¤ç»™çº¿ç¨‹ä¸ä¿æŒå®ƒä»¬ã€‚ PriorityBlockingQueue ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ DelayQueue ä¸€ä¸ªä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ï¼Œåªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»ä¸­æå–å…ƒç´ ã€‚ LinkedTransferQueue ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ä¸ SynchronousQueue ç±»ä¼¼ï¼Œè¿˜å«æœ‰éé˜»å¡æ–¹æ³•ã€‚ LinkedBlockingDeque ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ— è¾ƒå¸¸ç”¨çš„æ˜¯ LinkedBlockingQueue å’Œ Synchronousã€‚çº¿ç¨‹æ± çš„æ’é˜Ÿç­–ç•¥ä¸ BlockingQueue æœ‰å…³\nthreadFactory: çº¿ç¨‹å·¥å‚ï¼Œä¸»è¦ç”¨æ¥åˆ›å»ºçº¿ç¨‹ï¼Œé»˜åŠæ­£å¸¸ä¼˜å…ˆçº§ã€éå®ˆæŠ¤çº¿ç¨‹ã€‚\nhandlerï¼šæ‹’ç»ç­–ç•¥ï¼Œæ‹’ç»å¤„ç†ä»»åŠ¡æ—¶çš„ç­–ç•¥ï¼Œ4 ç§å¯é€‰ï¼Œé»˜è®¤ä¸º AbortPolicoy\nAbortPolicy ` æ‹’ç»å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ CallerRunsPolicy é‡è¯•æäº¤å½“å‰çš„ä»»åŠ¡ï¼Œå³å†æ¬¡è°ƒç”¨è¿è¡Œè¯¥ä»»åŠ¡çš„ execute()æ–¹æ³•ã€‚ DiscardOldestPolicy æŠ›å¼ƒé˜Ÿåˆ—å¤´éƒ¨ï¼ˆæœ€æ—§ï¼‰çš„ä¸€ä¸ªä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡ã€‚ DiscardPolicy æŠ›å¼ƒå½“å‰ä»»åŠ¡ã€‚ çº¿ç¨‹æ‰§è¡Œçš„é¡ºåº å½“çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°æ—¶ï¼Œåˆ›å»ºçº¿ç¨‹ã€‚ å½“çº¿ç¨‹æ•°å¤§äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¸”ä»»åŠ¡é˜Ÿåˆ—æœªæ»¡æ—¶ï¼Œå°†ä»»åŠ¡æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚ å½“çº¿ç¨‹æ•°å¤§äºç­‰äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¸”ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼š è‹¥çº¿ç¨‹æ•°å°äºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ›å»ºçº¿ç¨‹ã€‚ è‹¥çº¿ç¨‹æ•°ç­‰äºæœ€å¤§çº¿ç¨‹æ•°ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œæ‹’ç»ä»»åŠ¡ã€‚ ä¼˜å…ˆçº§ï¼š æ ¸å¿ƒçº¿ç¨‹æ•° \u0026gt; ä»»åŠ¡é˜Ÿåˆ— \u0026gt; æœ€å¤§çº¿ç¨‹æ•° \u0026gt; æ‹’ç»ä»» j åŠ¡\nä¸åŒçº¿ç¨‹æ± æºç çš„å·® j å¼‚ Executors å·¥ç¨‹ç±»æä¾›çš„å››ç§æ–¹æ³•å…¶å®åº•å±‚è¿˜æ˜¯è°ƒç”¨äº† ThreadPollExecutor, åªä¸è¿‡æ˜¯å‚æ•°ä¸åŒç½¢äº†\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ 4 ä¸­æ–¹æ³•åº•å±‚çš„ä»£ç :\nnewCachedThreadPool public static ExecutorService newCachedThreadPool() { return new ThreadPoolExecutor(0, Integer.MAX_VALUE, 60L, TimeUnit.SECONDS, new SynchronousQueue\u0026lt;Runnable\u0026gt;()); } æ ¸å¿ƒæ•°ä¸º 0ï¼Œæœ€å¤§çº¿ç¨‹æ•°ä¸ºæ•´å‹æœ€å¤§å€¼ï¼Œå…è®¸æœ€å¤§ç©ºé—²æ—¶é—´ 60s, SynchronousQueue æ˜¯ BlockingQueue çš„ä¸€ç§ï¼Œæ‰€ä»¥ SynchronousQueue æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚SynchronousQueue å’Œå…¶ä»–çš„ BlockingQueue ä¸åŒçš„æ˜¯ SynchronousQueue çš„ capacity æ˜¯ 0ã€‚å³ SynchronousQueue ä¸å­˜å‚¨ä»»ä½•å…ƒç´ ã€‚å³æ¥ä¸€ä¸ªä»»åŠ¡åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚\nnewFixedThreadPool public static ExecutorService newFixedThreadPool(int nThreads) { return new ThreadPoolExecutor(nThreads, nThreads, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue\u0026lt;Runnable\u0026gt;()); } æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°ä¸€æ ·ï¼Œå…è®¸çº¿ç¨‹æ°¸ä¹…ç­‰å¾…ï¼Œå³æ²¡æœ‰è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œ é˜Ÿåˆ—ä½¿ç”¨çš„æ˜¯ LinkedBlockingQueue æ— ç•Œé˜Ÿåˆ—ã€‚\nnewScheduledThreadPool public static ScheduledExecutorService newScheduledThreadPool(int corePoolSize) { return new ScheduledThreadPoolExecutor(corePoolSize); } public ScheduledThreadPoolExecutor(int corePoolSize) { super(corePoolSize, Integer.MAX_VALUE, 0, NANOSECONDS, new DelayedWorkQueue()); } æŒ‡å®šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæœ€å¤§çº¿ç¨‹æ•°æ˜¯ MX_VALUE, ä¸è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œ ä»»åŠ¡é˜Ÿåˆ—æ˜¯å»¶æ—¶é˜Ÿåˆ—\nnewSingleThreadExecutor public static ExecutorService newSingleThreadExecutor() { return new FinalizableDelegatedExecutorService (new ThreadPoolExecutor(1, 1, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue\u0026lt;Runnable\u0026gt;())); } æ ¸å¿ƒçº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°éƒ½æ˜¯1ï¼Œ ä¸è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä½¿ç”¨æ— ç•Œé˜Ÿåˆ—å­˜æ”¾ä»»åŠ¡ã€‚\né€šè¿‡æŸ¥çœ‹ä»¥ä¸Šæºç å‘ç°ï¼Œè¿™4ä¸­ç‰¹å®šçš„çº¿ç¨‹æ± éƒ½æ˜¯ä»¥ä¸åŒå‚æ•°è°ƒç”¨äº† ThreadPoolExecutor æ¥å®ç°çš„ã€‚\n","date":"2022-10-19T20:19:52Z","permalink":"https://dccmmtop.github.io/posts/%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%9A%84%E5%BA%94%E7%94%A8/","section":"posts","tags":["java"],"title":"çº¿ç¨‹æ± çš„åº”ç”¨ä¸åŸç†"},{"categories":null,"contents":"ArrayList ArrayList çš„ä¿æŠ¤æœºåˆ¶ for(String str : list){ if(str.equals(\u0026#34;123\u0026#34;)){ list.remove(str); //æŠ›å‡ºå¼‚å¸¸ } } è¿™é‡Œçš„ foreach è¯­æ³•ç³–å®é™…ä¸Šè°ƒç”¨äº† ArrayList çš„è¿­ä»£å™¨ç±»ã€‚å¦‚ä¸‹ï¼š\nå¦‚æœåœ¨å¼€å§‹è¿­ä»£çš„æ—¶å€™æ•°ç»„ä¸­æœ‰ 5 ä¸ªå…ƒç´ ï¼Œä½†æ˜¯åœ¨è¿­ä»£ä¸­ç§»é™¤äº†ä¸€ä¸ªå…ƒç´ ï¼Œæ•°ç»„å®é™…ä¸Šè¿˜æœ‰ 4 ä¸ªå…ƒç´ ï¼Œä½†æ˜¯è¿˜æ˜¯ä¼šéå†ç¬¬äº”ä¸ªå…ƒç´ ï¼Œè¿™å°±å¯¼è‡´äº†ä¸‹æ ‡è¶Šç•Œé”™è¯¯ï¼ŒArrayList ä¸å…è®¸è¿™ç§å¼‚å¸¸å‘ç”Ÿã€‚è¿˜æœ‰åœ¨å¤šçº¿ç¨‹ä¸‹åœºæ™¯ä¸‹ï¼Œä¸€ä¸ªçº¿ç¨‹éå†è¿™ä¸ª ArrayList , å¦ä¸€ä¸ªçº¿ç¨‹ç§»é™¤æ•°ç»„ä¸­çš„æŸä¸ªå…ƒç´ ï¼Œä¹Ÿä¼šå‘ç”Ÿ ConcurrentModificationException å¼‚å¸¸ã€‚\nfail-Fast æœºåˆ¶ è¿™ä¸ªæœºåˆ¶å°±æ˜¯ fail-Fast æœºåˆ¶ï¼Œå¿«é€Ÿå¤±è´¥ç³»ç»Ÿï¼Œé€šå¸¸è®¾è®¡ç”¨äºåœæ­¢æœ‰ç¼ºé™·çš„è¿‡ç¨‹ï¼Œè¿™æ˜¯ä¸€ç§ç†å¿µï¼Œåœ¨è¿›è¡Œç³»ç»Ÿè®¾è®¡æ—¶ä¼˜å…ˆè€ƒè™‘å¼‚å¸¸æƒ…å†µï¼Œä¸€æ—¦å‘ç”Ÿå¼‚å¸¸ï¼Œç›´æ¥åœæ­¢å¹¶ä¸ŠæŠ¥ã€‚\npublic int divide(int divisor, int dividend){ if (dividend == 0) { throw new RuntimeException(\u0026#34;è¢«é™¤æ•°ä¸èƒ½ä¸º 0\u0026#34;); //è¿™é‡Œå°±æ˜¯ fail-fast çš„ä½“ç° } return divisor / dividend; } ä¿æŠ¤æœºåˆ¶çš„å®ç°åŸç† åœ¨ ArrayList ä¸­æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ï¼š modCount, å®ƒæ˜¯ä» AbstractList ç»§æ‰¿æ¥çš„ï¼Œ modCount è®°å½•æ•°ç»„æ¯æ¬¡å†™æ“ä½œçš„æ¬¡æ•°ã€‚å½“åƒæ•°ç»„å¢åŠ æˆ–ç§»é™¤ä¸€ä¸ªå…ƒç´ ï¼Œå…¶å€¼åŠ  1ï¼Œåˆå§‹å€¼ä¸º 0ï¼Œåœ¨å¼€å§‹éå†çš„æ—¶å€™ï¼Œä¼šè®°å½•å½“ä¸‹æ•°ç»„çš„ modCount å€¼ä¸º expectedModCountï¼Œéå†æ¯ä¸ªå…ƒç´ æ—¶éƒ½ä¼šæ¯”è¾ƒ modCount å’Œ expectedModCount ä¸¤ä¸ªå€¼ï¼Œå¦‚æœä¸åŒï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä»£è¡¨ç€åœ¨éå†çš„æ—¶å€™ä¿®æ”¹äº†æ•°ç»„ã€‚å¦‚ä¸‹ï¼š\næ€ä¹ˆæ ·æ‰å¯ä»¥åœ¨å¾ªç¯ä¸­ä¿®æ”¹æ•°ç»„ï¼Ÿ å¦‚æœæˆ‘ä»¬æ¯æ¬¡å‘æ•°ç»„ä¸­æ·»åŠ æˆ–åˆ é™¤å…ƒç´ æ—¶ï¼ŒåŒæ­¥ä¿®æ”¹ exceptedModCount å°±ä¸ä¼šæŠ›å‡ºå¼‚å¸¸äº†ï¼ŒArrayList æ²¡æœ‰ç›´æ¥æä¾›è¿™ç§æ–¹æ³•ï¼Œè€Œæ˜¯æŠŠè¿™ç§æ–¹æ³•å§”æ‰˜ç»™è¿­ä»£å™¨äº†ï¼š\næ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š\nIterator \u0026lt;String\u0026gt; iterator = list.iterator(); while(iterator.hasNext()){ String str = iterator.next(); iterator.remove(); //æ­£ç¡®åšæ³• } CopyOnWriteArrayList CopyOnWriteArrayList æ˜¯ ArrayList çš„çº¿ç¨‹å®‰å…¨ç‰ˆæœ¬ï¼Œè¯»å–æ— é”ï¼Œå†™æ—¶æœ‰é”ã€‚é€‚ç”¨äº å†™å°‘è¯»å¤šçš„åœºæ™¯ï¼Œä¼šæœ‰ä¸ä¸€è‡´çš„ç°è±¡\nå®ç°åŸç† è§åçŸ¥æ„â€”â€” å†™æ—¶å¤åˆ¶ï¼Œ å½“çº¿ç¨‹åœ¨æ•°ç»„ä¸Šç§»é™¤ï¼Œæ·»åŠ å…ƒç´ æ—¶ï¼Œå…ˆåŠ é”ï¼Œå°†åŸæ•°ç»„å¤åˆ¶ä¸€ä»½ï¼Œç„¶ååŸºäºå‰¯æœ¬æ“ä½œï¼Œæœ€åå°†å·²ç»æ›´æ”¹çš„å‰¯æœ¬è¦†ç›–å…ƒæ•°ç»„ï¼Œé‡Šæ”¾é”ã€‚\nå…¶å†…éƒ¨æœ‰ä¸€ä¸ª ReentranLock æ¥æ§åˆ¶é”çš„è·å–å’Œé‡Šæ”¾ã€‚\nå…ˆçœ‹ä¸€ä¸‹å†…éƒ¨ç»“æ„å›¾ï¼š\nget æ–¹æ³• å¯ä»¥çœ‹åˆ°getæ–¹æ³•éå¸¸ç®€å•ï¼Œç›´æ¥è·å–å†…éƒ¨æ•°ç»„ç¬¬iä¸ªå…ƒç´ ï¼Œæ²¡æœ‰å…¶ä»–åŠ é”çš„æ“ä½œ\nadd æ–¹æ³• ä¸€äº›å…¶ä»–æ–¹æ³•éƒ½æ˜¯è¿™ç§å¥—è·¯ï¼Œä¸å†ä¸€ä¸€ç½—åˆ—ã€‚\nå­˜åœ¨çš„é—®é¢˜ åˆ©ç”¨äº†ç©ºé—´æ¢æ—¶é—´çš„æ€æƒ³æé«˜æ€§èƒ½ï¼Œå› ä¸ºåœ¨æ¯ä¸€æ­¥çš„å†™æ“ä½œéƒ½å¤åˆ¶äº†ä¸€ä¸ªå‰¯æœ¬ï¼Œå¦‚æœæ•°ç»„æ¯”è¾ƒå¤§ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜å ç”¨æ€¥å‰§å¢åŠ ï¼Œå¼•å‘é¢‘ç¹ full GC,ä»è€Œå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚\nå¦‚ä½•è§£å†³ æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ ReenTranLock è‡ªå®šä¹‰ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ArrayList, åˆ†åˆ«å®šä¹‰ä¸€ä¸ª è¯»é”å’Œå†™é”ï¼Œè¯»å†™ã€å†™å†™ äº’æ–¥ã€‚ è¯»è¯»ä¸äº’æ–¥ã€‚é¿å…è¿™ç§æ•°ç»„çš„æ‹·è´\n","date":"2022-10-18T17:08:33Z","permalink":"https://dccmmtop.github.io/posts/arraylist%E5%92%8Ccopyonwritearraylist/","section":"posts","tags":["java"],"title":"ArrayListå’ŒCopyOnWriteArrayList"},{"categories":null,"contents":"HashTable æ˜¯ä»€ä¹ˆï¼Ÿ ä¹‹å‰è¯¦ç»†ä»‹ç»è¿‡ HashMap çš„åŸç†ï¼ŒHashTable ä¸ HashMap ç”¨æ³•ä¸€æ ·ï¼Œéƒ½æ˜¯ key-value ç»“æ„ï¼Œåº•å±‚çš„å®ç°éƒ½å·®ä¸å¤šï¼Œæœ€å¤§çš„åŒºåˆ«æ˜¯ï¼Œ HashTable æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒHashMap ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚\nä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹å®‰å…¨ï¼Ÿ æˆ‘ä»¬çŸ¥é“ï¼ŒHashMap çš„åº•å±‚æ•°æ®ç»“æ„æ˜¯æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘ï¼Œå½“ä¸¤ä¸ªå…ƒç´ éƒ½è½åœ¨æ•°ç»„çš„åŒä¸€ä¸ªä½ç½®æ—¶ï¼Œä¼šå½¢æˆé“¾è¡¨ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹åˆ†åˆ«åŒæ—¶ put è¿™ä¸ªå…ƒç´ ï¼Œä¸€ä¸ªå…ƒç´ æŠŠå¦ä¸€ä¸ªå…ƒç´ è¦†ç›–äº†ï¼Œå°±ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½ put å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹å®‰å…¨ã€‚\nHashTable å¦‚ä½•è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ï¼Ÿ HashTable è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜éå¸¸ç®€å•ç²—æš´ï¼Œå°±æ˜¯åœ¨æ–¹æ³•å‰åŠ  synchronize å…³é”®è¯ï¼ŒHasTable ä¸ä»…ç»™å†™æ“ä½œåŠ é” put remove clone ç­‰ï¼Œè¿˜ç»™è¯»æ“ä½œåŠ äº†é” get, å¦‚ä¸‹ï¼š\npublic synchronized V get(Object key) public synchronized V put(K key, V value) public synchronized boolean remove(Object key, Object value) è™½ç„¶å®ç°èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä½†æ•ˆç‡ä¸é«˜ã€‚æˆ‘ä»¬ä¸€èˆ¬é€‰ç”¨ ConcurrentHashMap.\nä¸ºä»€ä¹ˆ ConcurrentHashMap çš„æ•ˆç‡é«˜ ConcurrentHashMap æ²¡æœ‰å¤§é‡ä½¿ç”¨ synchronsize è¿™ç§é‡é‡çº§é”ã€‚è€Œæ˜¯åœ¨ä¸€äº›å…³é”®ä½ç½®ä½¿ç”¨ä¹è§‚é”(CAS), çº¿ç¨‹å¯ä»¥æ— é˜»å¡çš„è¿è¡Œã€‚ è¯»æ–¹æ³•æ²¡æœ‰åŠ é” æ‰©å®¹æ—¶è€æ•°æ®çš„è½¬ç§»æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œè¿™æ ·æ‰©å®¹çš„æ•ˆç‡æ›´é«˜ã€‚ Java8 ä¸­ ConcurrentHashMap åŸºäºåˆ†æ®µé”+CAS ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œåˆ†æ®µé”åŸºäº synchronized å®ç°ï¼Œå®ƒä»…ä»…é”ä½æŸä¸ªæ•°ç»„çš„æŸä¸ªæ§½ä½ï¼Œè€Œä¸æ˜¯æ•´ä¸ªæ•°ç»„\nCAS åˆ†æ®µé” ConcurrentHashMap é‡ç‚¹æˆå‘˜å˜é‡ LOAD_FACTOR: è´Ÿè½½å› å­, é»˜è®¤ 75%, å½“ table ä½¿ç”¨ç‡è¾¾åˆ° 75%æ—¶, ä¸ºå‡å°‘ table çš„ hash ç¢°æ’, tabel é•¿åº¦å°†æ‰©å®¹ä¸€å€ã€‚è´Ÿè½½å› å­è®¡ç®—: å…ƒç´ æ€»ä¸ªæ•°%table.lengh\nTREEIFY_THRESHOLD: é»˜è®¤ 8, å½“é“¾è¡¨é•¿åº¦è¾¾åˆ° 8 æ—¶, å°†ç»“æ„è½¬å˜ä¸ºçº¢é»‘æ ‘ã€‚\nUNTREEIFY_THRESHOLD: é»˜è®¤ 6, çº¢é»‘æ ‘è½¬å˜ä¸ºé“¾è¡¨çš„é˜ˆå€¼ã€‚\nMIN_TRANSFER_STRIDE: é»˜è®¤ 16, table æ‰©å®¹æ—¶, æ¯ä¸ªçº¿ç¨‹æœ€å°‘è¿ç§» table çš„æ§½ä½ä¸ªæ•°ã€‚\nMOVED: å€¼ä¸º-1, å½“ Node.hash ä¸º MOVED æ—¶, ä»£è¡¨ç€ table æ­£åœ¨æ‰©å®¹\nTREEBIN, ç½®ä¸º-2, ä»£è¡¨æ­¤å…ƒç´ åæ¥çº¢é»‘æ ‘ã€‚\nnextTable: table è¿ç§»è¿‡ç¨‹ä¸´æ—¶å˜é‡, åœ¨è¿ç§»è¿‡ç¨‹ä¸­å°†å…ƒç´ å…¨éƒ¨è¿ç§»åˆ° nextTable ä¸Šã€‚\nsizeCtl: ç”¨æ¥æ ‡å¿— table åˆå§‹åŒ–å’Œæ‰©å®¹çš„, ä¸åŒçš„å–å€¼ä»£è¡¨ç€ä¸åŒçš„å«ä¹‰:\n0: table è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ– -1: table æ­£åœ¨åˆå§‹åŒ– å°äº-1: å®é™…å€¼ä¸º resizeStamp(n) \u0026laquo;RESIZE_STAMP_SHIFT+2, è¡¨æ˜ table æ­£åœ¨æ‰©å®¹ å¤§äº 0: åˆå§‹åŒ–å®Œæˆå, ä»£è¡¨ table æœ€å¤§å­˜æ”¾å…ƒç´ çš„ä¸ªæ•°, é»˜è®¤ä¸º 0.75*n transferIndex: table å®¹é‡ä» n æ‰©åˆ° 2n æ—¶, æ˜¯ä»ç´¢å¼• n-\u0026gt;1 çš„å…ƒç´ å¼€å§‹è¿ç§»,\ntransferIndex ä»£è¡¨å½“å‰å·²ç»è¿ç§»çš„å…ƒç´ ä¸‹æ ‡\nForwardingNode: ä¸€ä¸ªç‰¹æ®Šçš„ Node èŠ‚ç‚¹, å…¶ hashcode=MOVED, ä»£è¡¨ç€æ­¤æ—¶ table æ­£åœ¨åšæ‰©å®¹æ“ä½œã€‚æ‰©å®¹æœŸé—´, è‹¥ table æŸä¸ªå…ƒç´ ä¸º null, é‚£ä¹ˆè¯¥å…ƒç´ è®¾ç½®ä¸º ForwardingNode, å½“ä¸‹ä¸ªçº¿ç¨‹å‘è¿™ä¸ªå…ƒç´ æ’å…¥æ•°æ®æ—¶, æ£€æŸ¥ hashcode=MOVED, å°±ä¼šå¸®ç€æ‰©å®¹\nConcurrentHashMap é‡ç‚¹æ–¹æ³•è§£é‡Š åˆå§‹åŒ– put æ•°æ® cas é”å®šå•ä¸ªæ§½ä½ é”ä½æŸä¸ªé“¾è¡¨ ååŠ©æ‰©å®¹ ä¸Šå›¾åªæ˜¯ååŠ©æ‰©å®¹çš„æ—¶æœºï¼Œè‡³äºååŠ©æ‰©å®¹å†…éƒ¨æ‰§è¡Œçš„è¯¦ç»†æ­¥éª¤æ¯”è¾ƒå¤æ‚ï¼Œç‰µæ¶‰ä¸€äº›ä½è¿ç®—ï¼Œä¸å†è¯¦ç»†æ¢ç©¶äº†ï¼Œå¤§è‡´åšäº†ä¸€ä¸‹å‡ ä»¶äº‹ï¼š\nå®šçº¿ç¨‹æ¯è½®è¿ç§»å…ƒç´ çš„ä¸ªæ•° stride, æ¯”å¦‚è¿›æ¥ä¸€ä¸ªçº¿ç¨‹, ç¡®å®šæ‰©å®¹ table ä¸‹æ ‡ä¸º (a,b]ä¹‹é—´å…ƒç´ , ä¸‹ä¸€ä¸ªçº¿ç¨‹æ‰©å®¹(b,c]ã€‚è¿™é‡Œå¯¹ b-a æˆ–è€… c-b ä¹Ÿæ˜¯ç”±æœ€å°å€¼ 16 é™åˆ¶çš„ã€‚ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªçº¿ç¨‹æœ€å°‘æ‰©å®¹è¿ç»­ 16 ä¸ª table çš„å…ƒç´ ã€‚è€Œæ ‡å¿—å½“å‰è¿ç§»çš„ä¸‹æ ‡ä¿å­˜åœ¨ transferIndex é‡Œé¢ã€‚ æ£€æŸ¥ nextTab æ˜¯å¦å®Œæˆåˆå§‹åŒ–, è‹¥æ²¡æœ‰çš„è¯, è¯´æ˜æ˜¯ç¬¬ä¸€ä¸ªè¿ç§»çš„çº¿ç¨‹, å…ˆåˆå§‹åŒ– nextTab, size æ˜¯ä¹‹å‰ table çš„ 2 å€ã€‚ è¿›å…¥ while å¾ªç¯æŸ¥æ‰¾æœ¬è½®è¿ç§»çš„ table ä¸‹æ ‡å…ƒç´ åŒºé—´, ä¿å­˜åœ¨(bound, i]ä¸­, æ³¨æ„è¿™é‡Œæ˜¯åŠå¼€åŠé—­åŒºé—´ã€‚ ä»i -\u0026gt; boundå¼€å§‹éå†tableä¸­æ¯ä¸ªå…ƒç´ , è¿™é‡Œæ˜¯ä»å¤§åˆ°å°éå†çš„: è‹¥è¯¥å…ƒç´ ä¸ºç©º, åˆ™å‘è¯¥å…ƒç´ æ ‡å†™å…¥ForwardingNode, ç„¶åæ£€æŸ¥ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚ å½“åˆ« çš„çº¿ç¨‹å‘è¿™ä¸ªå…ƒç´ æ’å…¥æ•°æ®æ—¶, æ ¹æ®è¿™ä¸ªæ ‡å¿—ç¬¦çŸ¥é“äº†tableæ­£åœ¨è¢«åˆ«çš„çº¿ç¨‹è¿ç§», åœ¨ putValä¸­å°±ä¼šè°ƒç”¨helpTransferå¸®ç€è¿ç§»ã€‚ è‹¥è¯¥å…ƒç´ çš„hash=MOVED, ä»£è¡¨æ¬¡tableæ­£åœ¨å¤„äºè¿ç§»ä¹‹ä¸­, è·³è¿‡ã€‚ æŒ‰é“ç†ä¸ä¼šè·‘ç€è¿™é‡Œçš„ã€‚ å¦åˆ™è¯´æ˜è¯¥å…ƒç´ è·Ÿç€çš„æ˜¯ä¸€ä¸ªé“¾è¡¨æˆ–è€…æ˜¯ä¸ªçº¢é»‘æ ‘ç»“æ„, è‹¥hash\u0026gt;0, åˆ™è¯´æ˜æ˜¯ä¸ªé“¾ è¡¨, è‹¥f instanceof TreeBin, åˆ™è¯´æ˜æ˜¯ä¸ªçº¢é»‘æ ‘ç»“æ„ã€‚ é“¾è¡¨è¿ç§»åŸç†å¦‚ä¸‹: éå†é“¾è¡¨æ¯ä¸ªèŠ‚ç‚¹ã€‚ è‹¥èŠ‚ç‚¹çš„(f.hash\u0026amp;n == 0) æˆç«‹, åˆ™å°†èŠ‚ ç‚¹æ”¾åœ¨i, å¦åˆ™, åˆ™å°†èŠ‚ç‚¹æ”¾åœ¨n+iä¸Šé¢, è¿™ä¸€ç‚¹å’Œä¹‹å‰è®²è§£çš„ HashMap æ²¡æœ‰å˜åŒ– ","date":"2022-10-18T15:10:48Z","permalink":"https://dccmmtop.github.io/posts/concurrenthashmap%E4%B8%8Ehashtable/","section":"posts","tags":["java"],"title":"ConcurrentHashMapä¸HashTable"},{"categories":null,"contents":"åœ¨ JDK 1.8 ç‰ˆæœ¬ä¹‹å‰ï¼ŒHashMap åº•å±‚çš„æ•°æ®ç»“æ„æ˜¯æ•°ç»„ + é“¾è¡¨ï¼Œå¦‚ä¸‹å›¾ï¼š\nåœ¨ 1.8 åŠä»¥åæ˜¯æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘\né‡è¦çš„å‡ ä¸ªå˜é‡ DEFAULT_INITIAL_CAPACITY = 1 \u0026laquo; 4; Hash è¡¨é»˜è®¤åˆå§‹å®¹é‡ MAXIMUM_CAPACITY = 1 \u0026laquo; 30; æœ€å¤§ Hash è¡¨å®¹é‡ DEFAULT_LOAD_FACTOR = 0.75fï¼›é»˜è®¤åŠ è½½å› å­ TREEIFY_THRESHOLD = 8ï¼›é“¾è¡¨è½¬çº¢é»‘æ ‘é˜ˆå€¼ UNTREEIFY_THRESHOLD = 6ï¼›çº¢é»‘æ ‘è½¬é“¾è¡¨é˜ˆå€¼ MIN_TREEIFY_CAPACITY = 64ï¼›é“¾è¡¨è½¬çº¢é»‘æ ‘æ—¶ hash è¡¨æœ€å°å®¹é‡é˜ˆå€¼ï¼Œè¾¾ä¸åˆ°ä¼˜å…ˆæ‰©å®¹ å­˜æ”¾æ•°æ® Map \u0026lt;String,Employee\u0026gt; map = new HashMap \u0026lt;\u0026gt; (); Employee e0 = new Employee(\u0026#34;zhangshan\u0026#34;); map.put(\u0026#34;zhangshan\u0026#34;, e0); ä¼šå¯¹ \u0026ldquo;zhangshan\u0026rdquo; è¿›è¡Œä¸€æ¬¡ hash è¿ç®—, æŠŠ â€œzhangshanâ€ è¿™ä¸ªå­—ç¬¦ä¸²æ˜ å°„æˆä¸€ä¸ªå°äºæ•°ç»„é•¿åº¦çš„æ•´å‹å€¼ã€‚å°±åƒä¸‹é¢è¿™æ ·:\nint i = hash(\u0026quot;zhangshan\u0026quot;) å‡å¦‚ i ç­‰äº 1ï¼Œå°±ä¼šæŠŠ e0 æ„é€ æˆä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ”¾å…¥æ•°ç»„ä¸‹æ ‡ä¸º 1 çš„ä½ç½®ã€‚æ•°ç»„å­˜æ”¾çš„æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹æœ‰æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆ next, å¦‚ä¸‹ï¼š\nstatic class Node\u0026lt;K,V\u0026gt; implements Map.Entry\u0026lt;K,V\u0026gt; { final int hash; final K key; V value; Node \u0026lt;K,V\u0026gt; next; } int i = hash(\u0026quot;zhangshan\u0026quot;) æŠŠå­—ç¬¦ä¸²æ˜ å°„æˆä¸€ä¸ªæ•´å‹ï¼Œä¸åŒçš„å­—ç¬¦ä¸²å¯èƒ½æ˜ å°„æˆç›¸åŒçš„ä½ç½®ï¼Œæœ‰ä¸‹é¢è¿™ç§å¯èƒ½ï¼š\nhash(\u0026#34;zhangshan\u0026#34;) == hash(\u0026#34;lisi\u0026#34;) è¿™å°±æ˜¯ hash ç¢°æ’ï¼Œå‡ºç°ç¢°æ’åï¼Œä¼šä»¥é“¾è¡¨çš„æ–¹å¼è¿½åŠ åœ¨åé¢ï¼Œå°±å½¢æˆäº†ä¸Šå›¾ä¸­çš„ç»“æ„ã€‚\nå¦‚ä½•ç¡®å®š key åœ¨æ•°ç»„ä¸­çš„ä½ç½® å…ˆçœ‹ jdk 1.7 ä¸­çš„å®ç°:\npublic V put(K key, V value) { if (table == EMPTY_TABLE) { inflateTable(threshold); } if (key == null) return putForNullKey(value); // è·å– key å¯¹åº”çš„æ•´å‹ hashå€¼ int hash = hash(key); // å†å°†è¿™ä¸ªhashå€¼è½¬æ¢ä¸ºå°äºè¿™ä¸ªæ•°ç»„çš„æ•´å‹å€¼ iï¼Œç„¶åå°†èŠ‚ç‚¹æ’å…¥æ•°ç»„iä½ç½® int i = indexFor(hash, table.length); for (Entry\u0026lt;K,V\u0026gt; e = table[i]; e != null; e = e.next) { Object k; if (e.hash == hash \u0026amp;\u0026amp; ((k = e.key) == key || key.equals(k))) { V oldValue = e.value; e.value = value; e.recordAccess(this); return oldValue; } } modCount++; addEntry(hash, key, value, i); return null;} å…¶ä¸­ hash æ–¹æ³•å¦‚ä¸‹ï¼š\nfinal int hash(Object k) { int h = hashSeed; if (0 != h \u0026amp;\u0026amp; k instanceof String) { return sun.misc.Hashing.stringHash32((String) k); } h ^= k.hashCode(); // This function ensures that hashCodes that differ only by // constant multiples at each bit position have a bounded // number of collisions (approximately 8 at default load factor). h ^= (h \u0026gt;\u0026gt;\u0026gt; 20) ^ (h \u0026gt;\u0026gt;\u0026gt; 12); return h ^ (h \u0026gt;\u0026gt;\u0026gt; 7) ^ (h \u0026gt;\u0026gt;\u0026gt; 4); } æˆ‘ä»¬æ— éœ€å…³æ³¨å®ç°ç»†èŠ‚ï¼Œåªéœ€çŸ¥é“è¿™ä¸ª hash æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªå°½é‡åˆ†æ•£çš„æ•´å‹å€¼ K. ä¸‹é¢ä¸€ä¸ªå…³é”®æ­¥éª¤æ˜¯å¦‚ä½•æŠŠ k è½¬æ¢ä¸ºä¸€ä¸ªå°äºæ•°ç»„é•¿åº¦çš„å€¼å‘¢ï¼Ÿ æˆ‘ä»¬æƒ³åˆ°æœ€ç›´æ¥çš„æ–¹æ³•æ˜¯å–ä½™è¿ç®— %, å³ï¼š K % table.length , æ˜¯çš„ã€‚è¿™æ ·ç»“æœå®Œå…¨æ²¡é—®é¢˜ï¼Œä½†æ˜¯æ€§èƒ½æœ‰é—®é¢˜ï¼Œåœ¨æˆ‘ä»¬å¸¸è§çš„ + - * / % è¿ç®—ä¸­ï¼Œ % æ•ˆç‡æ˜¯æœ€ä½çš„ã€‚è€Œ HashMap ä½œä¸ºä¸€ä¸ª java å†…ç½®çš„æ•°æ®ç»“æ„ï¼Œä¼šæœ‰å¤§é‡çš„åœºæ™¯ä½¿ç”¨ã€‚å¯¹æ€§èƒ½çš„è¦æ±‚å°±æ¯”è¾ƒé«˜ï¼Œè‡ªç„¶è¿™é‡Œçš„ indexFor æ–¹æ³•ç”¨çš„ä¸æ˜¯å–ä½™è¿ç®—ï¼Œè€Œæ˜¯ \u0026amp; è¿ç®—, å¦‚ä¸‹:\n/** * Returns index for hash code h. * */ static int indexFor(int h, int length) { // assert Integer.bitCount(length) == 1 : \u0026#34;length must be a non-zero power of 2\u0026#34;; return h \u0026amp; (length-1); } è¿™æ®µä»£ç ä¸­çš„æ³¨é‡Šè¯´ã€‚length å¿…é¡»æ˜¯ 2 çš„ N æ¬¡æ–¹ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™æ˜¯ä¸ºä»€ä¹ˆ\n\u0026amp; è¿ç®—çš„è§„åˆ™æ˜¯ï¼ŒåŒæ—¶ä¸º 1ï¼Œç»“æœæ‰æ˜¯ 1ï¼Œå¦åˆ™æ˜¯ 0ï¼Œå³ 1 \u0026amp; 1 == 1 1 \u0026amp; 0 ==0 0 \u0026amp; 0 == 0\nè€Œ 2 çš„ N æ¬¡æ–¹å‡ä¸€ï¼Œçš„äºŒè¿›åˆ¶ä¸€å®šæ˜¯å…¨ä¸º 1ï¼Œæ¯”å¦‚ 3 ï¼Œ 7 ï¼Œ 15 çš„äºŒè¿›åˆ¶æ˜¯ 11 111 1111 ã€‚æ­£å› ä¸ºæ˜¯è¿™ç§ç»“æ„ï¼Œ r = h \u0026amp; ( 2 ^ n -1) çš„ç»“æœ r ä¸€å®šå°äº n, ä¸” r å–å†³äº h çš„å€¼ï¼Œç”±æ­¤å¯ä»¥ä»£æ›¿å–ä½™è¿ç®—ï¼Œåƒè¿™ç§äºŒè¿›åˆ¶çš„ \u0026amp; | ! ^ è¿ç®—æ˜¯æœ€æ¥è¿‘è®¡ç®—æœºåº•å±‚çš„ï¼Œè¿ç®—é€Ÿåº¦è¿œè¿œé«˜äº % è¿ç®—ï¼Œæˆ‘ç®€å•æµ‹è¯•ä¸€ä¸‹ï¼Œå¤§çº¦ç›¸å·® 10 å€ã€‚\nHashMap çš„å®¹é‡ ä½†æ˜¯è¦ä¿è¯ä¸Šè¿°è¿ç®—çš„å‡†ç¡®æ€§å’Œæ•ˆç‡ï¼Œå…¶ä¸­æ•°ç»„çš„é•¿åº¦ length å¿…é¡»æ˜¯ 2 çš„ N æ¬¡æ–¹ã€‚é‚£ä¹ˆæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­çš„è¿™ç§ä»£ç ï¼šnew HashMap\u0026lt;\u0026gt;(13) , æ•°ç»„çš„é•¿åº¦æ˜¯ 13 å—ï¼Ÿ å½“ç„¶ä¸æ˜¯ï¼Œè€Œæ˜¯ä»¥ç¬¬ä¸€ä¸ªå¤§äº 13 ä¸”æ˜¯ 2 çš„ N æ¬¡æ–¹çš„æ•° 16, ä½œä¸ºæ•°ç»„çš„é•¿åº¦ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ JDK 1.7 ä»£ç ï¼š\npublic V put(K key, V value) { // å¦‚æœæ•°ç»„ä¸ºç©ºï¼Œåˆå§‹åŒ–æ•°ç»„ï¼Œè€Œä¸æ˜¯åœ¨HashMapçš„æ„é€ æ–¹æ³•ä¸­è¿›è¡Œçš„çš„ if (table == EMPTY_TABLE) { inflateTable(threshold); } if (key == null) return putForNullKey(value); int hash = hash(key); int i = indexFor(hash, table.length); for (Entry\u0026lt;K,V\u0026gt; e = table[i]; e != null; e = e.next) { Object k; if (e.hash == hash \u0026amp;\u0026amp; ((k = e.key) == key || key.equals(k))) { V oldValue = e.value; e.value = value; e.recordAccess(this); return oldValue; } } modCount++; addEntry(hash, key, value, i); return null; } åˆå§‹åŒ–æ–¹æ³•ï¼š\nprivate void inflateTable(int toSize) { // æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äº toSize çš„ 2çš„ Næ¬¡æ–¹çš„å€¼ int capacity = roundUpToPowerOf2(toSize); threshold = (int) Math.min(capacity * loadFactor, MAXIMUM_CAPACITY + 1); table = new Entry[capacity]; initHashSeedAsNeeded(capacity); } private static int roundUpToPowerOf2(int number) { // assert number \u0026gt;= 0 : \u0026#34;number must be non-negative\u0026#34;; return number \u0026gt;= MAXIMUM_CAPACITY ? MAXIMUM_CAPACITY : (number \u0026gt; 1) ? Integer.highestOneBit((number - 1) \u0026lt;\u0026lt; 1) : 1; } // å·§å¦™çš„é€šè¿‡æˆ–è¿ç®—å’Œä½ç§»è¿ç®—å¾—å‡ºç¬¬ä¸€ä¸ªå¤§äºiçš„ 2 çš„ N çš„æ•°å€¼ public static int highestOneBit(int i) { // HD, Figure 3-1 i |= (i \u0026gt;\u0026gt; 1); i |= (i \u0026gt;\u0026gt; 2); i |= (i \u0026gt;\u0026gt; 4); i |= (i \u0026gt;\u0026gt; 8); i |= (i \u0026gt;\u0026gt; 16); return i - (i \u0026gt;\u0026gt;\u0026gt; 1); } å…³äºè¿™ä¸ªè¿ç®—åŸç†çš„è®²è§£å‚è€ƒï¼š https://segmentfault.com/a/1190000039392972\nåœ¨åç»­çš„æ•°ç»„æ‰©å®¹ä¸­ï¼Œæ–°çš„æ•°ç»„å®¹é‡ä¹Ÿè¦éµå¾ªè¿™ä¸ªè§„åˆ™ï¼Œè¿™ä¸€ç‚¹ï¼Œ JDK 1.8 å’Œ 1.8 ä¹‹å‰çš„æ ¸å¿ƒå®ç°å·®ä¸å¤šã€‚\nHashMap çš„æ‰©å®¹ å¹¶ä¸æ˜¯ç­‰åˆ°èŠ‚ç‚¹æ•°é‡è¾¾åˆ°å®¹é‡åæ‰è¿›è¡Œçš„æ‰©å®¹ï¼Œè€Œæ˜¯è®¾ç½®äº†ä¸€ä¸ªé˜ˆå€¼ï¼Œé˜ˆå€¼å°äºç­‰äºå®¹é‡ã€‚å½“èŠ‚ç‚¹æ•°é‡è¾¾åˆ°é˜ˆå€¼åå°±å¼€å§‹æ‰©å®¹ï¼Œå®¹é‡å˜ä¸ºåŸæ¥çš„ 2 å€ï¼Œåœ¨ 1.8 ä¹‹å‰ï¼Œé˜ˆå€¼ = å®¹é‡ * åŠ è½½å› å­ã€‚è€Œåœ¨ 1.8 ä¸­ï¼Œé˜ˆå€¼ä¹Ÿæ˜¯åŸæ¥çš„ 2 å€ï¼›å¦‚ä¸‹ï¼š\nå®¹é‡å’Œé˜ˆå€¼çš„å¢é•¿ 1.8\n1.7\nèŠ‚ç‚¹çš„ç§»åŠ¨æ–¹å¼ åœ¨åº•å±‚æ•°ç»„çš„æ‰©å®¹æ–¹æ³•ä¸Šï¼Œ1.8 ç‰ˆæœ¬å’Œ 1.8 ä¹‹å‰çš„ç‰ˆæœ¬ç›¸å·®æœ€å¤§ï¼Œå…¶ä¸­ 1.8 ä¹‹å‰ï¼ŒHashMap çš„æ‰©å®¹åœ¨å¤šçº¿ç¨‹ä¸‹ä¼šäº§ç”Ÿæ­»å¾ªç¯çš„é—®é¢˜ã€‚\næˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ 1.7 ç‰ˆæœ¬çš„æ‰©å®¹ ï¼š\n1.7ç‰ˆæœ¬ èŠ‚ç‚¹ç§»åŠ¨æ­¥éª¤ /** * Transfers all entries from current table to newTable. */ void transfer(Entry[] newTable, boolean rehash) { int newCapacity = newTable.length; // éå†æ—§æ•°ç»„ for (Entry\u0026lt;K,V\u0026gt; e : table) { // éå†é“¾è¡¨ while(null != e) { Entry\u0026lt;K,V\u0026gt; next = e.next; if (rehash) { e.hash = null == e.key ? 0 : hash(e.key); } // é‡æ–°è®¡ç®—å½“å‰èŠ‚ç‚¹åœ¨æ–°æ•°ç»„ä¸­çš„ä½ç½® int i = indexFor(e.hash, newCapacity); // ä¿®æ”¹èŠ‚ç‚¹çš„æŒ‡å‘ e.next = newTable[i]; newTable[i] = e; // ä¸‹ä¸€æ¬¡å¾ªç¯ e = next; } } } 1.7 ç‰ˆæœ¬æ‰©å®¹çš„æ ¸å¿ƒæ–¹æ³•åªæœ‰ä¸Šé¢ä¸€æ®µï¼Œç†è§£èµ·æ¥ä¹Ÿä¸éš¾ï¼Œä¸»è¦æœ‰ä¸‹å‡ ä¸ªæ­¥éª¤:\nå¤–å±‚éå†æ•°ç»„ï¼Œå‡è®¾å½“å‰å…ƒç´ : e0 å†…å±‚éå†æ•°ç»„æŒ‡å‘çš„é“¾è¡¨ï¼Œå³ e0 ä¸ºå¤´èŠ‚ç‚¹çš„é“¾è¡¨ æ‰«æé“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œé‡æ–°è®¡ç®—èŠ‚ç‚¹çš„åœ¨æ–°æ•°ç»„çš„ä½ç½®ï¼Œå°†èŠ‚ç‚¹ç§»åŠ¨åˆ°æ–°æ•°ç»„ä¸­å¯¹åº”çš„ä½ç½®ï¼Œä»¥å¤´æ’æ³•çš„æ–¹å¼å¤„ç†æœ‰ Hash å†²çªçš„èŠ‚ç‚¹ã€‚ ä¸€å›¾èƒœåƒè¨€:\nç”¨å¤´æ’æ³•ä¼šå¯¼è‡´é“¾è¡¨çš„é¡ºåºå‘ç”Ÿå˜åŒ–ã€‚å…¶ä¸­æ¯ä¸€æ­¥ä¸å†è¯¦è§£ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹è¿™ç§æ‰©å®¹æ–¹æ³•åœ¨å¤šçº¿ç¨‹ä¸‹çš„é—®é¢˜\nå¹¶å‘å¯¼è‡´çš„æ­»å¾ªç¯é—®é¢˜ ç»è¿‡å‡ æ¬¡å¾ªç¯å½¢æˆäº†ç¯ï¼ŒThread1 çº¿ç¨‹åé¢åœ¨è¿›è¡Œ Put æ•°æ®æ—¶ï¼Œå¦‚æœæŸä¸ªkey è½åœ¨äº†è¿™ä¸ªæœ‰ç¯èŠ‚ç‚¹ä½ç½®ï¼Œå°±ä¼šå‘ç”Ÿæ­»å¾ªç¯ã€‚å¦‚ä¸‹:\npublic V put(K key, V value) { if (table == EMPTY_TABLE) { inflateTable(threshold); } if (key == null) return putForNullKey(value); int hash = hash(key); int i = indexFor(hash, table.length); // å› ä¸ºå½¢æˆäº†ç¯ï¼Œå¯¼è‡´ e != null æ°¸è¿œæˆç«‹ã€‚æ­»å¾ªç¯ for (Entry\u0026lt;K,V\u0026gt; e = table[i]; e != null; e = e.next) { Object k; if (e.hash == hash \u0026amp;\u0026amp; ((k = e.key) == key || key.equals(k))) { V oldValue = e.value; e.value = value; e.recordAccess(this); return oldValue; } } modCount++; addEntry(hash, key, value, i); return null; } ä¸‹é¢æˆ‘ä»¬å¯¹æ¯”çœ‹ä¸€ä¸‹ 1.8 ç‰ˆæœ¬æ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚\n1.8ç‰ˆæœ¬ èŠ‚ç‚¹ç§»åŠ¨æ­¥éª¤ åœ¨1.8ç‰ˆæœ¬ä¸­ä»ä¿ç•™äº† æ•°ç»„+é“¾è¡¨çš„ç»“æ„ï¼Œåªæœ‰å½“HashMapä¸­çš„å®¹é‡å¤§äºæŸä¸ªå€¼æ—¶ï¼Œæ‰ä¼šæŠŠé“¾è¡¨è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼Œæé«˜æ£€ç´¢æ•ˆç‡ã€‚ç°åœ¨æˆ‘ä»¬åªå…³æ³¨æ‰©å®¹éƒ¨åˆ†ã€‚\næ‰©å®¹çš„å…³é”®ä»£ç ï¼š\nfinal Node\u0026lt;K,V\u0026gt;[] resize() { Node\u0026lt;K,V\u0026gt;[] oldTab = table; int oldCap = (oldTab == null) ? 0 : oldTab.length; int oldThr = threshold; int newCap, newThr = 0; if (oldCap \u0026gt; 0) { if (oldCap \u0026gt;= MAXIMUM_CAPACITY) { threshold = Integer.MAX_VALUE; return oldTab; } else if ((newCap = oldCap \u0026lt;\u0026lt; 1) \u0026lt; MAXIMUM_CAPACITY \u0026amp;\u0026amp; oldCap \u0026gt;= DEFAULT_INITIAL_CAPACITY) newThr = oldThr \u0026lt;\u0026lt; 1; // double threshold } else if (oldThr \u0026gt; 0) // initial capacity was placed in threshold newCap = oldThr; else { // zero initial threshold signifies using defaults newCap = DEFAULT_INITIAL_CAPACITY; newThr = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY); } if (newThr == 0) { float ft = (float)newCap * loadFactor; newThr = (newCap \u0026lt; MAXIMUM_CAPACITY \u0026amp;\u0026amp; ft \u0026lt; (float)MAXIMUM_CAPACITY ? (int)ft : Integer.MAX_VALUE); } threshold = newThr; @SuppressWarnings({\u0026#34;rawtypes\u0026#34;,\u0026#34;unchecked\u0026#34;}) Node\u0026lt;K,V\u0026gt;[] newTab = (Node\u0026lt;K,V\u0026gt;[])new Node[newCap]; table = newTab; if (oldTab != null) { for (int j = 0; j \u0026lt; oldCap; ++j) { Node\u0026lt;K,V\u0026gt; e; if ((e = oldTab[j]) != null) { oldTab[j] = null; if (e.next == null) newTab[e.hash \u0026amp; (newCap - 1)] = e; else if (e instanceof TreeNode) ((TreeNode\u0026lt;K,V\u0026gt;)e).split(this, newTab, j, oldCap); else { // preserve order // å®šä¹‰äº†å››ä¸ªæŒ‡é’ˆ Node\u0026lt;K,V\u0026gt; loHead = null, loTail = null; Node\u0026lt;K,V\u0026gt; hiHead = null, hiTail = null; Node\u0026lt;K,V\u0026gt; next; // å¼€å§‹æ‰©å®¹ do { next = e.next; // èŠ‚ç‚¹çš„hashå€¼ä¸ æ—§æ•°ç»„çš„å®¹é‡ç›¸ä¸ï¼ŒoldCap æ˜¯2çš„Næ¬¡æ–¹ // ä¸€ä¸ªæ•°å’Œ 2çš„Næ¬¡æ–¹ç›¸ä¸æ—¶ï¼Œç»“æœåªèƒ½æ˜¯0æˆ– oldCap if ((e.hash \u0026amp; oldCap) == 0) { if (loTail == null) // æŒ‡å®šå¤´æŒ‡é’ˆçš„ä½ç½® loHead = e; else // å‰ä¸€ä¸ªæŒ‡é’ˆçš„åç»§èŠ‚ç‚¹æ˜¯å½“å‰èŠ‚ç‚¹ loTail.next = e; // å°¾æŒ‡é’ˆé”šå®šå½“å‰èŠ‚ç‚¹ loTail = e; } else { if (hiTail == null) hiHead = e; else hiTail.next = e; hiTail = e; } } while ((e = next) != null); // ä½ä½èŠ‚ç‚¹çš„ä¸‹æ ‡ä¸å˜ if (loTail != null) { loTail.next = null; newTab[j] = loHead; } // é«˜ä½èŠ‚ç‚¹ä¸‹æ ‡å¢åŠ  oldCap if (hiTail != null) { hiTail.next = null; newTab[j + oldCap] = hiHead; } } } } } return newTab; } è¿™é‡Œå®šä¹‰äº†å››ä¸ªæŒ‡é’ˆï¼Œå°†æŸä¸ªé“¾è¡¨åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œé“¾è¡¨èŠ‚ç‚¹å’Œæ•°ç»„é•¿åº¦ç›¸ä¸çš„ç»“æœä½œä¸ºåˆ†éš”ï¼Œç­‰äº0çš„æ”¾åœ¨ä»¥loHeadä¸ºå¤´èŠ‚ç‚¹çš„é“¾è¡¨ä¸­ï¼Œç­‰1çš„æ”¾åœ¨ä»¥hiHeadä¸ºå¤´èŠ‚ç‚¹çš„é“¾è¡¨ä¸­ã€‚å¦‚ä¸‹å›¾:\nå¦‚ä¸Šæ‰€ç¤ºã€‚è¿™ç§ç§»åŠ¨æ–¹å¼æ²¡æœ‰æ”¹å˜èŠ‚ç‚¹å…³ç³»çš„æ–¹å‘ï¼Œæ‰€ä»¥å¹¶å‘ä¹‹ä¸‹ä¹Ÿæ²¡æœ‰é—®é¢˜\næ‰©å®¹å› å­ä¸ºä»€ä¹ˆæ˜¯0.75 1.8ç‰ˆæœ¬é“¾è¡¨ä¸çº¢é»‘æ ‘çš„è½¬æ¢ é“¾è¡¨é•¿åº¦ \u0026gt; 8 å®¹é‡ \u0026gt; 64 æ€§èƒ½æå‡çš„ä¸æ˜¯å¾ˆé«˜ï¼Œåœ¨å¤§é‡æ•°æ®ä¸‹ï¼Œå¯èƒ½ä¼šæå‡5% ~10%, æ•°æ®é‡ä¸å¤§æ—¶ã€‚æ²¡æœ‰ä»€ä¹ˆåŒºåˆ« çº¢é»‘æ ‘ ","date":"2022-10-15T11:15:24Z","permalink":"https://dccmmtop.github.io/posts/hashmap%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/","section":"posts","tags":["java"],"title":"HashMapåº•å±‚åŸç†"},{"categories":null,"contents":"åŸå­æ“ä½œ åŸå­ï¼ˆatomï¼‰æœ¬æ„æ˜¯â€œä¸èƒ½è¢«è¿›ä¸€æ­¥åˆ†å‰²çš„æœ€å°ç²’å­â€ï¼Œè€ŒåŸå­æ“ä½œï¼ˆatomic operationï¼‰æ„ä¸ºâ€ä¸å¯è¢«ä¸­æ–­çš„ä¸€ä¸ªæˆ–ä¸€ç³»åˆ—æ“ä½œâ€ ã€‚åœ¨å¤šå¤„ç†å™¨ä¸Šå®ç°åŸå­æ“ä½œå°±å˜å¾—æœ‰ç‚¹å¤æ‚\nå¤„ç†å™¨ä¼šä¿è¯åŸºæœ¬å†…å­˜æ“ä½œçš„åŸå­æ€§ å¤„ç†å™¨ä¿è¯ä»ç³»ç»Ÿå†…å­˜å½“ä¸­è¯»å–æˆ–è€…å†™å…¥ä¸€ä¸ªå­—èŠ‚æ˜¯åŸå­çš„ï¼Œæ„æ€æ˜¯å½“ä¸€ä¸ªå¤„ç†å™¨è¯»å–ä¸€ä¸ªå­—èŠ‚æ—¶ï¼Œå…¶ä»–å¤„ç†å™¨ä¸èƒ½è®¿é—®è¿™ä¸ªå­—èŠ‚çš„å†…å­˜åœ°å€ã€‚å¥”è…¾ 6 å’Œæœ€æ–°çš„å¤„ç†å™¨èƒ½è‡ªåŠ¨ä¿è¯å•å¤„ç†å™¨å¯¹åŒä¸€ä¸ªç¼“å­˜è¡Œé‡Œè¿›è¡Œ 16/32/64 ä½çš„æ“ä½œæ˜¯åŸå­çš„ï¼Œä½†æ˜¯å¤æ‚çš„å†…å­˜æ“ä½œå¤„ç†å™¨ä¸èƒ½è‡ªåŠ¨ä¿è¯å…¶åŸå­æ€§ï¼Œæ¯”å¦‚è·¨æ€»çº¿å®½åº¦ï¼Œè·¨å¤šä¸ªç¼“å­˜è¡Œï¼Œè·¨é¡µè¡¨çš„è®¿é—®ã€‚ä½†æ˜¯å¤„ç†å™¨æä¾›æ€»çº¿é”å®šå’Œç¼“å­˜é”å®šä¸¤ä¸ªæœºåˆ¶æ¥ä¿è¯å¤æ‚å†…å­˜æ“ä½œçš„åŸå­æ€§ã€‚\nJava ä¸­å¦‚ä½•å®ç°åŸå­æ“ä½œ java ä¸­å¯ä»¥é€šè¿‡é”å’Œå¾ªç¯ CASçš„æ–¹å¼å®ç°åŸå­æ“ä½œ\nCAS æ“ä½œå°±æ˜¯åˆ©ç”¨ä¸Šæ–‡è¯´çš„å¤„ç†å™¨æä¾›çš„ CMPXCHG æŒ‡ä»¤å®ç°çš„ï¼Œæ˜¯ç¡¬ä»¶åŸè¯­ã€‚è‡ªæ—‹ CAS å°±æ˜¯ä»¥ä¸€ç›´è¿›è¡Œ CAS æ“ä½œç›´åˆ° CAS æˆåŠŸä¸ºæ­¢ã€‚ java æä¾›äº† atomic åŒ…è¿›è¡Œä¸€ç³»åˆ—çš„åŸå­æ“ä½œã€‚\nAtomic åœ¨ atomic åŒ…ä¸­ä¸€å…± you æœ‰ 12 ä¸ªç±»ï¼Œ4 ä¸­åŸå­æ›´æ–°æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯ï¼š\nåŸå­æ›´æ–°åŸºæœ¬ç±»å‹ åŸå­æ›´æ–°æ•°ç»„ åŸå­æ›´æ–°å¼•ç”¨ åŸå­æ›´æ–°å­—æ®µ åŸå­æ›´æ–°åŸºæœ¬ç±»å‹ç±» AtomicBoolean ï¼šåŸå­æ›´æ–°å¸ƒå°”ç±»å‹ã€‚ AtomicInteger ï¼šåŸå­æ›´æ–°æ•´å‹ã€‚ AtomicLong ï¼šåŸå­æ›´æ–°é•¿æ•´å‹ã€‚ AtomicInteger AtomicInteger çš„å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š\nint addAndGet(int delta) ï¼šä»¥åŸå­æ–¹å¼å°†è¾“å…¥çš„æ•°å€¼ä¸å®ä¾‹ä¸­çš„å€¼ï¼ˆAtomicInteger é‡Œçš„ valueï¼‰ç›¸åŠ ï¼Œå¹¶è¿”å›ç»“æœ boolean compareAndSet(int expect, int update) ï¼šå¦‚æœè¾“å…¥çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥çš„å€¼ã€‚ int getAndIncrement() ï¼šä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ  1ï¼Œæ³¨æ„ï¼šè¿™é‡Œè¿”å›çš„æ˜¯è‡ªå¢å‰çš„å€¼ã€‚ void lazySet(int newValue) ï¼šæœ€ç»ˆä¼šè®¾ç½®æˆ newValueï¼Œä½¿ç”¨ lazySet è®¾ç½®å€¼åï¼Œå¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨ä¹‹åçš„ä¸€å°æ®µæ—¶é—´å†…è¿˜æ˜¯å¯ä»¥è¯»åˆ°æ—§çš„å€¼ã€‚ int getAndSet(int newValue) ï¼šä»¥åŸå­æ–¹å¼è®¾ç½®ä¸º newValue çš„å€¼ï¼Œå¹¶è¿”å›æ—§å€¼ã€‚ Atomic åŒ…æä¾›äº†ä¸‰ç§åŸºæœ¬ç±»å‹çš„åŸå­æ›´æ–°ï¼Œä½†æ˜¯ Java çš„åŸºæœ¬ç±»å‹é‡Œè¿˜æœ‰ charï¼Œfloat å’Œ double ç­‰ã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚ä½•åŸå­çš„æ›´æ–°å…¶ä»–çš„åŸºæœ¬ç±»å‹å‘¢ï¼ŸAtomic åŒ…é‡Œçš„ç±»åŸºæœ¬éƒ½æ˜¯ä½¿ç”¨ Unsafe å®ç°çš„ï¼ŒUnsafe åªæä¾›äº†ä¸‰ç§ CAS æ–¹æ³•ï¼ŒcompareAndSwapObjectï¼ŒcompareAndSwapInt å’Œ compareAndSwapLongï¼Œå†çœ‹ AtomicBoolean æºç ï¼Œå‘ç°å…¶æ˜¯å…ˆæŠŠ Boolean è½¬æ¢æˆæ•´å‹ï¼Œå†ä½¿ç”¨ compareAndSwapInt è¿›è¡Œ CASï¼Œæ‰€ä»¥åŸå­æ›´æ–° double ä¹Ÿå¯ä»¥ç”¨ç±»ä¼¼çš„æ€è·¯æ¥å®ç°ã€‚\nåŸå­æ›´æ–°æ•°ç»„ç±» ä»¥åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„æŸä¸ªå…ƒç´ ï¼Œæä¾›ä¸€ä¸‹ 3 ä¸ªç±»\nAtomicIntegerArray ï¼šåŸå­æ›´æ–°æ•´å‹æ•°ç»„é‡Œçš„å…ƒç´ ã€‚ AtomicLongArray ï¼šåŸå­æ›´æ–°é•¿æ•´å‹æ•°ç»„é‡Œçš„å…ƒç´ ã€‚ AtomicReferenceArray ï¼šåŸå­æ›´æ–°å¼•ç”¨ç±»å‹æ•°ç»„é‡Œçš„å…ƒç´ ã€‚ AtomicIntegerArray ç±»ä¸»è¦æ˜¯æä¾›åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„é‡Œçš„æ•´å‹ï¼Œå…¶å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹\nint addAndGet(int i, int delta) ï¼šä»¥åŸå­æ–¹å¼å°†è¾“å…¥å€¼ä¸æ•°ç»„ä¸­ç´¢å¼• i çš„å…ƒç´ ç›¸åŠ ã€‚ boolean compareAndSet(int i, int expect, int update) ï¼šå¦‚æœå½“å‰å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†æ•°ç»„ä½ç½® i çš„å…ƒç´ è®¾ç½®æˆ update å€¼ã€‚ åŸå­æ›´æ–°å­—æ®µç±» å¦‚æœæˆ‘ä»¬åªéœ€è¦æŸä¸ªç±»é‡Œçš„æŸä¸ªå­—æ®µï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨åŸå­æ›´æ–°å­—æ®µç±»ï¼ŒAtomic åŒ…æä¾›äº†ä»¥ä¸‹ä¸‰ä¸ªç±»ï¼š\nAtomicIntegerFieldUpdater ï¼šåŸå­æ›´æ–°æ•´å‹çš„å­—æ®µçš„æ›´æ–°å™¨ã€‚ AtomicLongFieldUpdater ï¼šåŸå­æ›´æ–°é•¿æ•´å‹å­—æ®µçš„æ›´æ–°å™¨ã€‚ AtomicStampedReference ï¼šåŸå­æ›´æ–°å¸¦æœ‰ç‰ˆæœ¬å·çš„å¼•ç”¨ç±»å‹ã€‚è¯¥ç±»å°†æ•´æ•°å€¼ä¸å¼•ç”¨å…³è”èµ·æ¥ï¼Œå¯ç”¨äºåŸå­çš„æ›´æ•°æ®å’Œæ•°æ®çš„ç‰ˆæœ¬å·ï¼Œå¯ä»¥è§£å†³ä½¿ç”¨ CAS è¿›è¡ŒåŸå­æ›´æ–°æ—¶ï¼Œå¯èƒ½å‡ºç°çš„ ABA é—®é¢˜ã€‚ åŸå­æ›´æ–°å­—æ®µç±»éƒ½æ˜¯æŠ½è±¡ç±»ï¼Œæ¯æ¬¡ä½¿ç”¨éƒ½æ—¶å€™å¿…é¡»ä½¿ç”¨é™æ€æ–¹æ³• newUpdater åˆ›å»ºä¸€ä¸ªæ›´æ–°å™¨ã€‚åŸå­æ›´æ–°ç±»çš„å­—æ®µçš„å¿…é¡»ä½¿ç”¨ public volatile ä¿®é¥°ç¬¦ã€‚\nUnsafe æ­£å¦‚å…¶åï¼ŒUnsafe æä¾›ä¸€äº›ä¸å®‰å…¨çš„æ“ä½œæ–¹æ³•ï¼Œå¦‚ç›´æ¥è®¿é—®ç³»ç»Ÿå†…å­˜èµ„æºï¼Œè‡ªä¸»ç®¡ç†ç³»ç»Ÿå†…å­˜èµ„æºï¼Œè¿™äº›æ–¹æ³•åœ¨æé«˜ java è¿è¡Œæ•ˆç‡ï¼Œå¢å¼º java åº•å±‚èµ„æºçš„æ“ä½œèƒ½åŠ›å‘æŒ¥äº†å¾ˆå¤§ä½œç”¨ã€‚ä½†ç”±äº Unsafe ç±»ä½¿ Java è¯­è¨€æ‹¥æœ‰äº†ç±»ä¼¼ C è¯­è¨€æŒ‡é’ˆä¸€æ ·æ“ä½œå†…å­˜ç©ºé—´çš„èƒ½åŠ›ï¼Œè¿™æ— ç–‘ä¹Ÿå¢åŠ äº†ç¨‹åºå‘ç”Ÿç›¸å…³æŒ‡é’ˆé—®é¢˜çš„é£é™©ã€‚åœ¨ç¨‹åºä¸­è¿‡åº¦ã€ä¸æ­£ç¡®ä½¿ç”¨ Unsafe ç±»ä¼šä½¿å¾—ç¨‹åºå‡ºé”™çš„æ¦‚ç‡å˜å¤§ï¼Œä½¿å¾— Java è¿™ç§å®‰å…¨çš„è¯­è¨€å˜å¾—ä¸å†â€œå®‰å…¨â€ï¼Œå› æ­¤å¯¹ Unsafe çš„ä½¿ç”¨ä¸€å®šè¦æ…é‡ã€‚\nå¦‚ä½•ä½¿ç”¨ Unsafe ç±» Unsafe ç±»ä¸ºä¸€å•ä¾‹å®ç°ï¼Œæä¾›é™æ€æ–¹æ³• getUnsafe è·å– Unsafe å®ä¾‹ï¼Œå½“ä¸”ä»…å½“è°ƒç”¨ getUnsafe æ–¹æ³•çš„ç±»ä¸ºå¼•å¯¼ç±»åŠ è½½å™¨æ‰€åŠ è½½æ—¶æ‰åˆæ³•ï¼Œå¦åˆ™æŠ›å‡º SecurityException å¼‚å¸¸\næˆ‘ä»¬è‡ªå·±å†™çš„åº”ç”¨ç¨‹åºæ— æ³•ç›´æ¥ä½¿ç”¨ Unsafe ç±»ï¼Œå¯ä»¥é€šè¿‡åå°„æ–¹å¼ä½¿ç”¨ï¼š\npublic class UnsafeInstance { public static Unsafe reflectGetUnsafe() { try { Field field = Unsafe.class.getDeclaredField(\u0026#34;theUnsafe\u0026#34;); field.setAccessible(true); return (Unsafe) field.get(null); } catch (Exception e) { e.printStackTrace(); } return null; } } Unsafe åŠŸèƒ½ä»‹ç» Unsafe æä¾›çš„ API å¤§è‡´å¯åˆ†ä¸ºå†…å­˜æ“ä½œã€CASã€Class ç›¸å…³ã€å¯¹è±¡æ“ä½œã€çº¿ç¨‹è°ƒåº¦ã€ç³»ç»Ÿä¿¡æ¯è·å–ã€å†…å­˜å±éšœã€æ•°ç»„æ“ä½œç­‰å‡ ç±»ï¼Œä¸‹é¢è¿›è¡Œç®€å•ä»‹ç»ï¼š\nå†…å­˜æ“ä½œ åˆ†é…å†…å­˜, ç›¸å½“äº C++çš„ malloc å‡½æ•°\npublic native long allocateMemory(long bytes);\næ‰©å……å†…å­˜\npublic native long reallocateMemory(long address, long bytes);\né‡Šæ”¾å†…å­˜\npublic native void freeMemory(long address);\nåœ¨ç»™å®šçš„å†…å­˜å—ä¸­è®¾ç½®å€¼\npublic native void setMemory(Object o, long offset, long bytes, byte value);\nå†…å­˜æ‹·è´\npublic native void copyMemory(Object srcBase, long srcOffset, Object destBase, long destOffset, long bytes);\nè·å–ç»™å®šåœ°å€å€¼ï¼Œå¿½ç•¥ä¿®é¥°é™å®šç¬¦çš„è®¿é—®é™åˆ¶ã€‚ä¸æ­¤ç±»ä¼¼æ“ä½œè¿˜æœ‰: getIntï¼ŒgetDoubleï¼ŒgetLongï¼ŒgetChar ç­‰\npublic native Object getObject(Object o, long offset);\nä¸ºç»™å®šåœ°å€è®¾ç½®å€¼ï¼Œå¿½ç•¥ä¿®é¥°é™å®šç¬¦çš„è®¿é—®é™åˆ¶ï¼Œä¸æ­¤ç±»ä¼¼æ“ä½œè¿˜æœ‰: putInt,putDoubleï¼ŒputLongï¼ŒputChar ç­‰\npublic native void putObject(Object o, long offset, Object x);\npublic native byte getByte(long address);\nä¸ºç»™å®šåœ°å€è®¾ç½® byte ç±»å‹çš„å€¼ï¼ˆå½“ä¸”ä»…å½“è¯¥å†…å­˜åœ°å€ä¸º allocateMemory åˆ†é…æ—¶ï¼Œæ­¤æ–¹æ³•ç»“æœæ‰æ˜¯ç¡®å®šçš„ï¼‰\npublic native void putByte(long address, byte x);\nä¸ºä»€ä¹ˆä¼šç”¨åˆ°å †å¤–å†…å­˜ é€šå¸¸æˆ‘ä»¬ä½¿ç”¨ new å…³é”®è¯æ„é€ çš„å¯¹è±¡å ç”¨çš„éƒ½æ˜¯ jvm å †å†…çš„ç©ºé—´ï¼Œç”± jvm ç»Ÿä¸€ç®¡ç†ã€‚ä¸ä¹‹ç›¸å¯¹çš„å°±æ˜¯å †å¤–å†…å­˜ï¼Œjvm æ— æ³•ç®¡ç†ï¼Œå›æ”¶ã€‚ä½¿ç”¨ Unsafe æä¾›çš„æ–¹æ³•å¯ä»¥å¯¹å †å¤–çš„å†…å­˜è¿›è¡Œç®¡ç†ã€‚é‚£ä¹ˆæˆ‘ä»¬ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šä½¿ç”¨å †å¤–å†…å­˜å‘¢ï¼Ÿ\næ”¹å–„åƒåœ¾å›æ”¶æ€§èƒ½ ç”±äºå †å¤–å†…å­˜æ˜¯ç”±æ“ä½œç³»ç»Ÿç®¡ç†ï¼Œè€Œä¸æ˜¯ jvmï¼Œå½“æˆ‘ä»¬ä½¿ç”¨å †å¤–å†…å­˜æ—¶ï¼Œå¯ä»¥ä¿æŒé™ä½å †å†…å†…å­˜çš„ä½¿ç”¨ï¼Œå‡å°‘åƒåœ¾å›æ”¶åœé¡¿å †åº”ç”¨çš„å½±å“ï¼Œæ¯”å¦‚åœ¨ä¸Šä¼ å¤§æ–‡ä»¶æ—¶ï¼Œå¯ä»¥æŠŠæ–‡ä»¶å¯¹è±¡åˆ†é…åˆ°å †å¤–å†…å­˜ã€‚\næå‡ç¨‹åº I/O æ“ä½œçš„æ€§èƒ½ é€šå¸¸åœ¨ IO é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œå­˜åœ¨å †å†…å†…å­˜åˆ°å †å¤–å†…å­˜çš„æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œ- å¯¹äºéœ€è¦é¢‘ç¹è¿›è¡Œå†…å­˜é—´æ•°æ®æ‹·è´ä¸”ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­çš„æš‚å­˜æ•°æ®ï¼Œéƒ½å»ºè®®å­˜å‚¨åˆ°å †å¤–å†…å­˜ã€‚\nCAS ç›¸å…³ å¦‚ä¸‹æºä»£ç ï¼š\n* CAS * @param o åŒ…å«è¦ä¿®æ”¹fieldçš„å¯¹è±¡ * @param offset å¯¹è±¡ä¸­æŸfieldçš„åç§»é‡ * @param expected æœŸæœ›å€¼ * @param update æ›´æ–°å€¼ * @return true | false */ public final native boolean compareAndSwapObject(Object var1, long var2, Object var4, Object var5); public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5); public final native boolean compareAndSwapLong(Object var1, long var2, long var4, long var6); åº”ç”¨åœºæ™¯ atomic åŒ…ä¸­å„ç±»åŸå­æ“ä½œï¼Œéƒ½æ˜¯å¯¹ CAS çš„åº”ç”¨\nçº¿ç¨‹è°ƒåº¦ åŒ…æ‹¬çº¿ç¨‹æŒ‚èµ·ã€æ¢å¤ã€é”æœºåˆ¶ç­‰æ–¹æ³•ã€‚\n//å–æ¶ˆé˜»å¡çº¿ç¨‹ public native void unpark(Object thread); //é˜»å¡çº¿ç¨‹ public native void park(boolean isAbsolute, long time); //è·å¾—å¯¹è±¡é”ï¼ˆå¯é‡å…¥é”ï¼‰ @Deprecated public native void monitorEnter(Object o); //é‡Šæ”¾å¯¹è±¡é” @Deprecated public native void monitorExit(Object o); //å°è¯•è·å–å¯¹è±¡é” @Deprecated public native boolean tryMonitorEnter(Object o); æ–¹æ³• parkã€unpark å³å¯å®ç°çº¿ç¨‹çš„æŒ‚èµ·ä¸æ¢å¤ï¼Œå°†ä¸€ä¸ªçº¿ç¨‹è¿›è¡ŒæŒ‚èµ·æ˜¯é€šè¿‡ park æ–¹æ³•å®ç°çš„ï¼Œè°ƒç”¨ park æ–¹æ³•åï¼Œçº¿ç¨‹å°†ä¸€ç›´é˜»å¡ç›´åˆ°è¶…æ—¶æˆ–è€…ä¸­æ–­ç­‰æ¡ä»¶å‡ºç°ï¼›unpark å¯ä»¥ç»ˆæ­¢ä¸€ä¸ªæŒ‚èµ·çš„çº¿ç¨‹ï¼Œä½¿å…¶æ¢å¤æ­£å¸¸ã€‚\nåº”ç”¨åœºæ™¯ Java é”å’ŒåŒæ­¥å™¨æ¡†æ¶çš„æ ¸å¿ƒç±» AbstractQueuedSynchronizerï¼Œå°±æ˜¯é€šè¿‡è°ƒç”¨ LockSupport.park() å’Œ LockSupport.unpark() å®ç°çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’çš„ï¼Œè€Œ LockSupport çš„ parkã€unpark æ–¹æ³•å®é™…æ˜¯è°ƒç”¨ Unsafe çš„ parkã€unpark æ–¹å¼æ¥å®ç°ã€‚\nå†…å­˜å±éšœ åœ¨ Java 8 ä¸­å¼•å…¥ï¼Œç”¨äºå®šä¹‰å†…å­˜å±éšœï¼ˆä¹Ÿç§°å†…å­˜æ …æ ï¼Œå†…å­˜æ …éšœï¼Œå±éšœæŒ‡ä»¤ç­‰ï¼Œæ˜¯ä¸€ç±»åŒæ­¥å±éšœæŒ‡ä»¤ï¼Œæ˜¯ CPU æˆ–ç¼–è¯‘å™¨åœ¨å¯¹å†…å­˜éšæœºè®¿é—®çš„æ“ä½œä¸­çš„ä¸€ä¸ªåŒæ­¥ç‚¹ï¼Œä½¿å¾—æ­¤ç‚¹ä¹‹å‰çš„æ‰€æœ‰è¯»å†™æ“ä½œéƒ½æ‰§è¡Œåæ‰å¯ä»¥å¼€å§‹æ‰§è¡Œæ­¤ç‚¹ä¹‹åçš„æ“ä½œï¼‰ï¼Œé¿å…ä»£ç é‡æ’åº\n","date":"2022-10-11T11:03:04Z","permalink":"https://dccmmtop.github.io/posts/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Batomic%E5%92%8Cunsafe%E9%AD%94%E6%B3%95%E7%B1%BB/","section":"posts","tags":["java"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹Atomicå’ŒUnsafeé­”æ³•ç±»"},{"categories":null,"contents":"Semaphore Semaphore æ˜¯ä¿¡å·é‡çš„æ„æ€ï¼Œå®ƒçš„ä½œç”¨æ˜¯æ§åˆ¶è®¿é—®ç‰¹å®šèµ„æºçš„çº¿ç¨‹æ•°ç›®ï¼Œåº•å±‚ä¾èµ– AQS çš„çŠ¶æ€ Stateï¼Œæ˜¯åœ¨ç”Ÿäº§å½“ä¸­æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ä¸ªå·¥å…·ç±»ã€‚\nå¯ä»¥ç†è§£ä¸ºè®¸å¯è¯ï¼Œæˆ–è€…ä»¤ç‰Œã€‚çº¿ç¨‹æƒ³è¦è®¿é—®æŸéƒ¨åˆ†èµ„æºæ—¶ï¼Œå¿…é¡»å…ˆè·å–ä¸€ä¸ªè®¸å¯è¯ï¼Œæ‰èƒ½è®¿é—®ï¼Œå¦åˆ™ç­‰å¾…ï¼Œä¸€ä¸ªç»å…¸çš„åº”ç”¨åœºæ™¯æ˜¯æœåŠ¡é™æµ(Hystrix é‡Œé™æµå°±æœ‰åŸºäºä¿¡å·é‡æ–¹å¼)ï¼Œ\né‡è¦æ–¹æ³• æ„é€ æ–¹æ³• // æ„é€ æ–¹æ³•1 // permits è®¸å¯è¯çš„æ•°é‡ï¼Œé»˜è®¤æ˜¯éå…¬å¹³çš„æ–¹å¼æŠ¢å è®¸å¯è¯ï¼Œè®¸å¯è¯ç”¨å®Œä¹‹åï¼Œ // å†æ¥çš„çº¿ç¨‹è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹é‡Šæ”¾è®¸å¯è¯ public Semaphore(int permits) { sync = new NonfairSync(permits); } // æ„é€ æ–¹æ³•2 // åŒä¸Šï¼Œå¯ä»¥æŒ‡å®šå…¬å¹³è¿˜æ˜¯éå…¬å¹³ public Semaphore(int permits, boolean fair) { sync = fair ? new FairSync(permits) : new NonfairSync(permits); } è·å–è®¸å¯è¯ acquire() æ­¤è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…è®¸å¯è¯ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹ä»»æ„ä¸€ä»¶äº‹ï¼š\nå½“å‰çº¿ç¨‹è·å–äº† 1 ä¸ªå¯ç”¨çš„è®¸å¯è¯ï¼Œåˆ™ä¼šåœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œã€‚ å½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™ä¼šæŠ›å‡º InterruptedException å¼‚å¸¸ï¼Œå¹¶åœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œã€‚ acquire(int permits) æ­¤è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…è®¸å¯è¯ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹ä»»æ„ä¸€ä»¶äº‹ï¼š\nå½“å‰çº¿ç¨‹è·å–äº† n ä¸ªå¯ç”¨çš„è®¸å¯è¯ï¼Œåˆ™ä¼šåœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œã€‚ å½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™ä¼šæŠ›å‡º InterruptedException å¼‚å¸¸ï¼Œå¹¶åœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œ acquireUninterruptibly(int permits) æ­¤è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…è®¸å¯è¯ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹ä»»æ„ä¸€ä»¶äº‹ï¼š\nå½“å‰çº¿ç¨‹è·å–äº† 1 ä¸ªå¯ç”¨çš„è®¸å¯è¯ï¼Œåˆ™ä¼šåœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œã€‚ ä¸å‰ä¸¤ä¸ªçš„åŒºåˆ«æ˜¯ï¼Œå®ƒä¸ç†ä¼šä¸­æ–­\nacquireUninterruptibly(int permits) æ­¤è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…è®¸å¯è¯ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹ä»»æ„ä¸€ä»¶äº‹ï¼š\nå½“å‰çº¿ç¨‹è·å–äº† n ä¸ªå¯ç”¨çš„è®¸å¯è¯ï¼Œåˆ™ä¼šåœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œã€‚\nå®ƒä¸ç†ä¼šä¸­æ–­ tryAcquire() å½“å‰çº¿ç¨‹å°è¯•å»è·å– 1 ä¸ªè®¸å¯è¯ã€‚\næ­¤è¿‡ç¨‹æ˜¯éé˜»å¡çš„ï¼Œå®ƒåªæ˜¯åœ¨æ–¹æ³•è°ƒç”¨æ—¶è¿›è¡Œä¸€æ¬¡å°è¯•ã€‚å¦‚æœå½“å‰çº¿ç¨‹è·å–äº† 1 ä¸ªå¯ç”¨çš„è®¸å¯è¯ï¼Œåˆ™ä¼šåœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œï¼Œå¹¶è¿”å› trueã€‚å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰è·å¾—è¿™ä¸ªè®¸å¯è¯ï¼Œä¹Ÿä¼šåœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œï¼Œå¹¶è¿”å› falseã€‚\ntryAcquire(int permits) å½“å‰çº¿ç¨‹å°è¯•å»è·å– permits ä¸ªè®¸å¯è¯ã€‚\næ­¤è¿‡ç¨‹æ˜¯éé˜»å¡çš„ï¼Œå®ƒåªæ˜¯åœ¨æ–¹æ³•è°ƒç”¨æ—¶è¿›è¡Œä¸€æ¬¡å°è¯•ã€‚å¦‚æœå½“å‰çº¿ç¨‹è·å–äº† permits ä¸ªå¯ç”¨çš„è®¸å¯è¯ï¼Œåˆ™ä¼šåœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œï¼Œå¹¶è¿”å› trueã€‚å¦‚æœå½“å‰çº¿ç¨‹æ²¡æœ‰è·å¾— permits ä¸ªè®¸å¯è¯ï¼Œä¹Ÿä¼šåœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œï¼Œå¹¶è¿”å› falseã€‚\ntryAcquire(long timeout, TimeUnit unit) å½“å‰çº¿ç¨‹åœ¨é™å®šæ—¶é—´å†…ï¼Œé˜»å¡çš„å°è¯•å»è·å– 1 ä¸ªè®¸å¯è¯ã€‚\næ­¤è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…è®¸å¯è¯ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹ä»»æ„ä¸€ä»¶äº‹ï¼š\nå½“å‰çº¿ç¨‹è·å–äº†å¯ç”¨çš„è®¸å¯è¯ï¼Œåˆ™ä¼šåœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œï¼Œå¹¶è¿”å› trueã€‚ å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´ timeout è¶…æ—¶ï¼Œåˆ™ä¼šåœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œï¼Œå¹¶è¿”å› falseã€‚ å½“å‰çº¿ç¨‹åœ¨ timeout æ—¶é—´å†…è¢«ä¸­æ–­ï¼Œåˆ™ä¼šæŠ›å‡º InterruptedException ä¸€æ¬¡ï¼Œå¹¶åœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œã€‚ tryAcquire(int, long, TimeUnit) å½“å‰çº¿ç¨‹åœ¨é™å®šæ—¶é—´å†…ï¼Œé˜»å¡çš„å°è¯•å»è·å– permits ä¸ªè®¸å¯è¯ã€‚\næ­¤è¿‡ç¨‹æ˜¯é˜»å¡çš„ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…è®¸å¯è¯ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹ä»»æ„ä¸€ä»¶äº‹ï¼š\nå½“å‰çº¿ç¨‹è·å–äº†å¯ç”¨çš„ permits ä¸ªè®¸å¯è¯ï¼Œåˆ™ä¼šåœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œï¼Œå¹¶è¿”å› trueã€‚ å½“å‰çº¿ç¨‹ç­‰å¾…æ—¶é—´ timeout è¶…æ—¶ï¼Œåˆ™ä¼šåœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œï¼Œå¹¶è¿”å› falseã€‚ å½“å‰çº¿ç¨‹åœ¨ timeout æ—¶é—´å†…è¢«ä¸­æ–­ï¼Œåˆ™ä¼šæŠ›å‡º InterruptedException ä¸€æ¬¡ï¼Œå¹¶åœæ­¢ç­‰å¾…ï¼Œç»§ç»­æ‰§è¡Œã€‚ drainPermits() å½“å‰çº¿ç¨‹è·å¾—å‰©ä½™çš„æ‰€æœ‰å¯ç”¨è®¸å¯è¯\né‡Šæ”¾è®¸å¯è¯ release() å½“å‰çº¿ç¨‹é‡Šæ”¾ä¸€ä¸ªè®¸å¯è¯\nrelease(int) å½“å‰çº¿ç¨‹é‡Šæ”¾ n ä¸ªè®¸å¯è¯\nç¤ºä¾‹ import java.util.Date; import java.util.concurrent.Semaphore; public class SemaphoreRunner { public static void main(String[] args) { Semaphore semaphore = new Semaphore(2); for (int i = 0; i \u0026lt; 10; i++) { new Thread(new Task(semaphore, \u0026#34;ä»»åŠ¡:\u0026#34; + i)).start(); } } static class Task extends Thread { Semaphore semaphore; public Task(Semaphore semaphore, String tname) { this.semaphore = semaphore; this.setName(tname); } @Override public void run() { try { semaphore.acquire(); System.out.println(this.getName() + \u0026#34;è·å¾—è®¸å¯è¯ at time:\u0026#34; + new Date()); Thread.sleep(3000); semaphore.release(); } catch (InterruptedException e) { e.printStackTrace(); } } } } ç»“æœ:\nä»»åŠ¡:0è·å¾—è®¸å¯è¯ at time:Mon Oct 10 11:42:33 CST 2022 ä»»åŠ¡:1è·å¾—è®¸å¯è¯ at time:Mon Oct 10 11:42:33 CST 2022 ä»»åŠ¡:3è·å¾—è®¸å¯è¯ at time:Mon Oct 10 11:42:36 CST 2022 ä»»åŠ¡:2è·å¾—è®¸å¯è¯ at time:Mon Oct 10 11:42:36 CST 2022 ä»»åŠ¡:4è·å¾—è®¸å¯è¯ at time:Mon Oct 10 11:42:39 CST 2022 ä»»åŠ¡:5è·å¾—è®¸å¯è¯ at time:Mon Oct 10 11:42:39 CST 2022 ä»»åŠ¡:7è·å¾—è®¸å¯è¯ at time:Mon Oct 10 11:42:42 CST 2022 ä»»åŠ¡:6è·å¾—è®¸å¯è¯ at time:Mon Oct 10 11:42:42 CST 2022 ä»»åŠ¡:9è·å¾—è®¸å¯è¯ at time:Mon Oct 10 11:42:45 CST 2022 ä»»åŠ¡:8è·å¾—è®¸å¯è¯ at time:Mon Oct 10 11:42:45 CST 2022 å¯ä»¥çœ‹å‡ºå½“è®¾ç½® 2 ä¸ªè®¸å¯è¯æ—¶ï¼ŒåŒæ—¶åªæœ‰ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œ\nCountDownLatch ä¸ CyclicBarrier CountDownLatch è¿™ä¸ªç±»èƒ½å¤Ÿä½¿ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆå„è‡ªçš„å·¥ä½œåå†æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œåº”ç”¨ç¨‹åºçš„ä¸»çº¿ç¨‹å¸Œæœ›åœ¨è´Ÿè´£å¯åŠ¨æ¡†æ¶æœåŠ¡çš„çº¿ç¨‹å·²ç»å¯åŠ¨æ‰€æœ‰çš„æ¡†æ¶æœåŠ¡ä¹‹åå†æ‰§è¡Œ, å®ƒå¼ºè°ƒçš„æ˜¯ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶ä»–å¤šä¸ªçº¿ç¨‹\nCountDownLatch å…¶å®å¯ä»¥æŠŠå®ƒçœ‹ä½œä¸€ä¸ªè®¡æ•°å™¨ï¼Œåªä¸è¿‡è¿™ä¸ªè®¡æ•°å™¨çš„æ“ä½œæ˜¯åŸå­æ“ä½œï¼ŒåŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å»æ“ä½œè¿™ä¸ªè®¡æ•°å™¨ï¼Œä¹Ÿå°±æ˜¯åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å»å‡è¿™ä¸ªè®¡æ•°å™¨é‡Œé¢çš„å€¼ã€‚å¯ä»¥å‘ CountDownLatch å¯¹è±¡è®¾ç½®ä¸€ä¸ªåˆå§‹çš„æ•°å­—ä½œä¸ºè®¡æ•°å€¼ï¼Œä»»ä½•è°ƒç”¨è¿™ä¸ªå¯¹è±¡ä¸Šçš„ await()æ–¹æ³•éƒ½ä¼šé˜»å¡ï¼Œç›´åˆ°è¿™ä¸ªè®¡æ•°å™¨çš„è®¡æ•°å€¼è¢«å…¶ä»–çš„çº¿ç¨‹å‡ä¸º 0 ä¸ºæ­¢ã€‚æ‰€ä»¥åœ¨å½“å‰è®¡æ•°åˆ°è¾¾é›¶ä¹‹å‰ï¼Œawait æ–¹æ³•ä¼šä¸€ç›´å—é˜»å¡ã€‚ä¹‹åï¼Œä¼šé‡Šæ”¾æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ï¼Œawait çš„æ‰€æœ‰åç»­è°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ã€‚è¿™ç§ç°è±¡åªå‡ºç°ä¸€æ¬¡â€”â€”è®¡æ•°æ— æ³•è¢«é‡ç½®\nCyclicBarrier å…è®¸ä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°åˆ°è¾¾æŸä¸ªå…¬å…±å±éšœç‚¹ (common barrier point)ã€‚åœ¨æ¶‰åŠä¸€ç»„å›ºå®šå¤§å°çš„çº¿ç¨‹çš„ç¨‹åºä¸­ï¼Œè¿™äº›çº¿ç¨‹å¿…é¡»ä¸æ—¶åœ°äº’ç›¸ç­‰å¾…ï¼Œæ­¤æ—¶ CyclicBarrier å¾ˆæœ‰ç”¨ã€‚å› ä¸ºè¯¥ barrier åœ¨é‡Šæ”¾ç­‰å¾…çº¿ç¨‹åå¯ä»¥é‡ç”¨ï¼Œæ‰€ä»¥ç§°å®ƒä¸ºå¾ªç¯çš„ barrierï¼Œ CyclicBarrier å¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿå¹¶å‘ï¼Œç±»ä¼¼äº Jmeter, åªæœ‰å¤šä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾è¦å¹¶å‘çš„ä½ç½®æ—¶ï¼Œå†ç»Ÿä¸€å¼€å§‹æ‰§è¡Œï¼Œå°±åƒå¤šä¸ªçº¿ç¨‹è¿è¡Œåˆ°ä¸€ä¸ªæ …æ å‰ç­‰å¾…ï¼Œç„¶åæŠŠæ …æ ç§»é™¤ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œã€‚ç§»é™¤çš„æ—¶æœºæ˜¯å¤šä¸ªçº¿ç¨‹å…¨éƒ¨åˆ°è¾¾æ …æ å‰\nåŒºåˆ« é‡è¦æ–¹æ³• CountDownLatch\npublic void await() throws InterruptedException { //è°ƒç”¨await()æ–¹æ³•çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œå®ƒä¼šç­‰å¾…ç›´åˆ°countå€¼ä¸º0æ‰ç»§ç»­æ‰§è¡Œ } public boolean await(long timeout, TimeUnit unit) throws InterruptedException { //å’Œawait()ç±»ä¼¼ï¼Œåªä¸è¿‡ç­‰å¾…ä¸€å®šçš„æ—¶é—´åcountå€¼è¿˜æ²¡å˜ä¸º0çš„è¯å°±ä¼šç»§ç»­æ‰§è¡Œ } public void countDown() { //å°†countå€¼å‡1 } ä½¿ç”¨ç¤ºä¾‹\npublic class CountDownlatchRunner { public static void main(String[] args) throws InterruptedException { CountDownLatch countDownLatch = new CountDownLatch(5); for(int i=0;i\u0026lt;5;i++){ new Thread(new ReadNum(i,countDownLatch)).start(); } // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ countDownLatch.await(); System.out.println(\u0026#34;çº¿ç¨‹æ‰§è¡Œç»“æŸã€‚ã€‚ã€‚ã€‚\u0026#34;); } static class ReadNum implements Runnable{ private int id; private CountDownLatch latch; public ReadNum(int id,CountDownLatch latch){ this.id = id; this.latch = latch; } @Override public void run() { synchronized (this){ System.out.println(\u0026#34;id:\u0026#34;+id); latch.countDown(); System.out.println(\u0026#34;çº¿ç¨‹ç»„ä»»åŠ¡\u0026#34;+id+\u0026#34;ç»“æŸï¼Œå…¶ä»–ä»»åŠ¡ç»§ç»­\u0026#34;); } } } } CyclicBarrier\næä¾›äº†ä¸¤ä¸ªæ„é€ å™¨\n// æŒ‡å®šäº†Nä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾… public CyclicBarrier(int parties) { } // æŒ‡å®šNä¸ªçº¿ç¨‹åœ¨ä»»åŠ¡ barrierAction å¤„äº’ç›¸ç­‰å¾… public CyclicBarrier(int parties, Runnable barrierAction) { } ç­‰å¾…æ–¹æ³•:\npublic int await() throws InterruptedException, BrokenBarrierException { //æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œç›´è‡³æ‰€æœ‰çº¿ç¨‹éƒ½åˆ°è¾¾barrierçŠ¶æ€å†åŒæ—¶æ‰§è¡Œåç»­ä»»åŠ¡ï¼› } public int await(long timeout, TimeUnit unit)throws InterruptedException,BrokenBarrierException,TimeoutException { //è®©è¿™äº›çº¿ç¨‹ç­‰å¾…è‡³ä¸€å®šçš„æ—¶é—´ï¼Œå¦‚æœè¿˜æœ‰çº¿ç¨‹æ²¡æœ‰åˆ°è¾¾barrierçŠ¶æ€ //å°±ç›´æ¥è®©åˆ°è¾¾barrierçš„çº¿ç¨‹æ‰§è¡Œåç»­ä»»åŠ¡ } ç¤ºä¾‹\npublic class CyclicBarrierTest { public static void main(String[] args) throws InterruptedException { CyclicBarrier cyclicBarrier = new CyclicBarrier(5, new Runnable() { @Override public void run() { System.out.println(\u0026#34;çº¿ç¨‹ç»„æ‰§è¡Œç»“æŸ\u0026#34;); } }); for (int i = 0; i \u0026lt; 5; i++) { new Thread(new ReadNum(i,cyclicBarrier)).start(); } //CyclicBarrier å¯ä»¥é‡å¤åˆ©ç”¨ï¼Œ // è¿™ä¸ªæ˜¯CountDownLatchåšä¸åˆ°çš„ // for (int i = 11; i \u0026lt; 16; i++) { // new Thread(new readNum(i,cyclicBarrier)).start(); // } } static class ReadNum implements Runnable{ private int id; private CyclicBarrier cyc; public readNum(int id,CyclicBarrier cyc){ this.id = id; this.cyc = cyc; } @Override public void run() { synchronized (this){ System.out.println(\u0026#34;id:\u0026#34;+id); try { // çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°5å„çº¿ç¨‹éƒ½è¿è¡Œåˆ°è¿™é‡Œå†ä¸€èµ·æ‰§è¡Œ cyc.await(); System.out.println(\u0026#34;çº¿ç¨‹ç»„ä»»åŠ¡\u0026#34; + id + \u0026#34;ç»“æŸï¼Œå…¶ä»–ä»»åŠ¡ç»§ç»­\u0026#34;); } catch (Exception e) { e.printStackTrace(); } } } } } ","date":"2022-10-10T10:40:28Z","permalink":"https://dccmmtop.github.io/posts/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B9%8Bsemaphore%E5%92%8Ccountdownlatch%E7%9A%84%E7%94%A8%E6%B3%95/","section":"posts","tags":["java"],"title":"å¹¶å‘ç¼–ç¨‹ä¹‹Semaphoreå’ŒCountDownLatchçš„ç”¨æ³•"},{"categories":null,"contents":"JDK1.5ä»¥å‰åªæœ‰synchronizedåŒæ­¥é”ï¼Œå¹¶ä¸”æ•ˆç‡éå¸¸ä½ï¼Œå¤§ç¥Doug Leaè‡ªå·±å†™äº†ä¸€å¥—å¹¶å‘æ¡†æ¶ï¼Œè¿™å¥—æ¡†æ¶çš„æ ¸å¿ƒå°±åœ¨äºAbstractQueuedSynchronizerç±»ï¼ˆå³AQSï¼‰ï¼Œæ€§èƒ½éå¸¸é«˜ï¼Œæ‰€ä»¥è¢«å¼•å…¥JDKåŒ…ä¸­ï¼Œå³JUCã€‚é‚£ä¹ˆAQSæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæœ¬ç¯‡å°±æ˜¯å¯¹AQSåŠå…¶ç›¸å…³ç»„ä»¶è¿›è¡Œåˆ†æï¼Œäº†è§£å…¶åŸç†ã€‚\nAQS çš„åº”ç”¨ æˆ‘ä»¬ç»å¸¸ä½¿ç”¨å¹¶å‘åŒ…ä¸­çš„é˜»å¡é˜Ÿåˆ—(ArrayBlockingQueue), å¯é‡å…¥é”ï¼ˆReentrantLockï¼‰ï¼Œçº¿ç¨‹æ …æ ï¼ˆCountDownLatchï¼‰ç­‰ä¸€äº›å·¥å…·åº•å±‚éƒ½æ˜¯ç”±AQSå®ç°çš„\nAQS å¤§è‡´ç»“æ„ ReentrantLock å®ç°åŸç† ReentrantLock ä½¿ç”¨ç®€å•ï¼Œæˆ‘ä»¬å°±ä»¥è¿™ä¸ªç±»ä¸ºåˆ‡å…¥å£ï¼Œå­¦ä¹ ä¸€ä¸‹å¦‚ä½•åˆ©ç”¨ AQS å®ç°åŠ é”é‡Šæ”¾é”çš„åŠŸèƒ½ï¼Œä»¥åŠå…¬å¹³å’Œéå…¬å¹³é”å®ç°çš„å·®åˆ«.\nåŠ é” æŸ¥çœ‹ ReentrantLock çš„æ„é€ æ–¹æ³•ï¼š\n// æ— å‚æ„é€ å™¨é»˜è®¤æ„é€ ä¸€ä¸ªéå…¬å¹³é” public ReentrantLock() { sync = new NonfairSync(); } // å¯ä»¥æŒ‡å®šä½¿ç”¨å…¬å¹³é”è¿˜æ˜¯éå…¬å¹³é” public ReentrantLock(boolean fair) { sync = fair ? new FairSync() : new NonfairSync(); } ç”±æ­¤å¯çŸ¥ï¼ŒReentrantLock çš„å…¬å¹³é”å’Œéå…¬å¹³é”åˆ†åˆ«æ˜¯ç”± FairSync å’Œ NonfairSyncå®ç°çš„ï¼Œ\nç”±ä¸‹é¢çš„ç»“æ„å›¾å¯çŸ¥ï¼ŒFairSync å’Œ NonfairSync éƒ½æ˜¯ç»§æ‰¿è‡³ Sync ,è€Œ Sync åˆæ˜¯ç»§æ‰¿ AQS\néå…¬å¹³é”åŠ é”çš„ä»£ç :\n// éå…¬å¹³é” static final class NonfairSync extends Sync { private static final long serialVersionUID = 7316153563782823691L; // è·å–é” final void lock() { // å‡è®¾t1 çº¿ç¨‹æ­£åœ¨å°è¯•è·å–é”ã€‚ // CASç®—æ³•ï¼ŒæŠŠ state ä»0ä¿®æ”¹ä¸º1ï¼Œstate è¡¨ç¤ºå½“å‰è¢«åŠ é”çš„æ¬¡æ•° // ä»0å˜æˆ1ï¼Œè¡¨ç¤ºt1ç¬¬ä¸€æ¬¡å°è¯•è·å–é” if (compareAndSetState(0, 1)) // å¦‚æœä¿®æ”¹æˆåŠŸï¼Œå°±æŠŠt1è®¾ç½®æˆæ­£åœ¨æŒæœ‰é”çš„çº¿ç¨‹ setExclusiveOwnerThread(Thread.currentThread()); else // æœªè·å–åˆ°é”... acquire(1); } } accquire(1) å®ç°:\npublic final void acquire(int arg) { // tryAcquire(arg)ï¼šå°è¯•æŠ¢é” // addWaiter(Node.EXCLUSIVE)ï¼Œå°†å½“å‰çº¿ç¨‹æ„é€ æˆä¸€ä¸ªé˜Ÿåˆ—èŠ‚ç‚¹ï¼Œå¹¶å…¥é˜Ÿ // acquireQueuedï¼ˆ...ï¼‰ å°†çº¿ç¨‹æŒ‚èµ·ï¼Œç»´æŠ¤çº¿ç¨‹èŠ‚ç‚¹çš„çŠ¶æ€ if (!tryAcquire(arg) \u0026amp;\u0026amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt(); } å¤§è‡´æ„æ€å°±æ˜¯ï¼Œçº¿ç¨‹å†æŠ¢ä¸€æ¬¡é”ï¼Œå¦‚æœå¤±è´¥äº†ï¼Œå°±æ„é€ ä¸€ä¸ªçº¿ç¨‹èŠ‚ç‚¹ï¼Œç„¶åæŠŠèŠ‚ç‚¹æ”¾å…¥é˜Ÿåˆ—ï¼Œå°†çº¿ç¨‹æŒ‚èµ·ï¼Œç­‰å¾…è¢«å”¤é†’\nå†æ¬¡æŠ¢é”ä»£ç : tryAcquire(arg):\n// éå…¬å¹³é”å°è¯•è·å–é” final boolean nonfairTryAcquire(int acquires) { final Thread current = Thread.currentThread(); // è·å–å·²ç»åŠ é”çš„æ¬¡æ•° int c = getState(); // æ²¡æœ‰çº¿ç¨‹æŒæœ‰é” if (c == 0) { // ç›´æ¥æŠ¢é”ã€‚æ²¡æœ‰åˆ¤æ–­é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰çº¿ç¨‹æ’é˜Ÿï¼Œæ’é˜Ÿï¼Œä¸å…¬å¹³ if (compareAndSetState(0, acquires)) { // æŠ¢é”æˆåŠŸ setExclusiveOwnerThread(current); return true; } } // æ­£åœ¨æœ‰çº¿ç¨‹æŒæœ‰é”ï¼Œå¹¶ä¸”è¿™ä¸ªçº¿ç¨‹æ˜¯è‡ªå·±(t1) else if (current == getExclusiveOwnerThread()) { // t1 å·²ç»è·å–åˆ°é”ï¼Œæ— éœ€å†æ¬¡è·å–é”ï¼Œåªéœ€æŠŠé”çš„æ¬¡æ•°å¢åŠ å³å¯ int nextc = c + acquires; if (nextc \u0026lt; 0) // overflow throw new Error(\u0026#34;Maximum lock count exceeded\u0026#34;); // è®¾ç½®é”çš„æ¬¡æ•° setState(nextc); return true; } return false; } å…¬å¹³é”çš„å®ç° protected final boolean tryAcquire(int acquires) { final Thread current = Thread.currentThread(); int c = getState(); if (c == 0) { // hasQueuedPredecessorsï¼š å½“çº¿ç¨‹å°è¯•è·å–é”æ—¶ï¼Œä¸æ˜¯ç›´æ¥å»æŠ¢ï¼Œ // è€Œæ˜¯å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨é˜Ÿåˆ—ï¼Œå¦‚æœå­˜åœ¨å°±ä¸æŠ¢äº†ï¼Œè¿”å›æŠ¢é”å¤±è´¥ if (!hasQueuedPredecessors() \u0026amp;\u0026amp; compareAndSetState(0, acquires)) { setExclusiveOwnerThread(current); return true; } } else if (current == getExclusiveOwnerThread()) { int nextc = c + acquires; if (nextc \u0026lt; 0) throw new Error(\u0026#34;Maximum lock count exceeded\u0026#34;); setState(nextc); return true; } return false; } // æ˜¯å¦å­˜åœ¨é˜Ÿåˆ—å¹¶ä¸”(ä¸‹ä¸€ä¸ªå¾…å”¤é†’çš„çº¿ç¨‹ä¸æ˜¯æœ¬çº¿ç¨‹(å‡†å¤‡é‡å…¥é”)) public final boolean hasQueuedPredecessors() { // The correctness of this depends on head being initialized // before tail and on head.next being accurate if the current // thread is first in queue. Node t = tail; // Read fields in reverse initialization order Node h = head; Node s; return h != t \u0026amp;\u0026amp; ((s = h.next) == null || s.thread != Thread.currentThread()); } äºéå…¬å¹³é”ç›¸æ¯”ï¼Œåªæœ‰tryAcquire æ–¹æ³•çš„åŒºåˆ«ï¼Œ\nä¸ºä»€ä¹ˆéœ€è¦å†æ¬¡æŠ¢é”? å› ä¸ºæŠ¢é”å¤±è´¥æœ‰ä¸¤ç§åŸå› ï¼Œ1æ˜¯å½“å‰çº¿ç¨‹ç¡®å®æ²¡æœ‰è·å–åˆ°é”ã€‚2æ˜¯å½“å‰çº¿ç¨‹ä¹‹å‰å·²ç»è·å–åˆ°é”äº†ï¼Œè¿˜æƒ³å†è·å–ä¸€æ¬¡ã€‚\nå¯¹äº1è¿™ç§æƒ…å†µï¼Œè®©çº¿ç¨‹å†æŠ¢ä¸€æ¬¡ï¼Œå¯èƒ½ä¼šæŠ¢åˆ°é”ï¼Œå°±ä¸ç”¨è°ƒç”¨ç³»ç»ŸapiæŠŠçº¿ç¨‹æŒ‚èµ·ï¼Œæé«˜æ€§èƒ½\nå¯¹äº2ï¼Œ åªéœ€æ”¹å˜åŠ é”çš„æ¬¡æ•°ï¼Œå°±å¯ä»¥æ ‡è®°å½“å‰çº¿ç¨‹å·²ç»åŠ é”çš„æ¬¡æ•°äº†ï¼Œå†é‡Šæ”¾é”æ—¶ï¼Œå¯¹åº”çš„å‡æˆ0å°±å¯ä»¥è®¤ä¸ºå½“å‰çº¿ç¨‹å·²ç»å®Œå…¨é‡Šæ”¾é”äº†ï¼Œè¿™å°±æ˜¯å¯é‡å…¥é”çš„å®ç°åŸç†\næ„é€ é˜Ÿåˆ—èŠ‚ç‚¹åŠå…¥é˜Ÿ ä¸‹é¢çœ‹ä¸€ä¸‹æ„é€ çº¿ç¨‹èŠ‚ç‚¹çš„å®ç°:\naddWaiter()\nprivate Node addWaiter(Node mode) { // ä»¥å½“å‰çº¿ç¨‹ä¸ºå‚æ•°ï¼Œæ„é€ ä¸€ä¸ªæ–°çš„ nodeï¼Œè®°ä½œå½“å‰çº¿ç¨‹èŠ‚ç‚¹ Node node = new Node(Thread.currentThread(), mode); // åœ¨æœ€å¼€å§‹ï¼Œtail å’Œ pred è‚¯å®šéƒ½æ˜¯null, Node pred = tail; // æœ€å¼€å§‹ä¸ä¼šè¿›å…¥ä¸‹é¢ï¼Œåªæœ‰é˜Ÿåˆ—ä¸ä¸ºç©ºæ—¶ï¼Œæ‰ä¼šè¿›å…¥ if (pred != null) { node.prev = pred; // å°†èŠ‚ç‚¹åŠ å…¥é˜Ÿå°¾ if (compareAndSetTail(pred, node)) { pred.next = node; return node; } } // è€Œæ˜¯ç”± enq(node) æ„é€ èŠ‚ç‚¹ enq(node); return node; } private Node enq(final Node node) { // å¼€å§‹äº†å¾ªç¯ for (;;) { Node t = tail; // æœ€å¼€å§‹é˜Ÿåˆ—æ˜¯ç©ºçš„ã€‚åªæœ‰ç¬¬ä¸€æ¬¡å¾ªç¯ä¼šè¿›å…¥ if (t == null) { // Must initialize // æ„é€ äº†ä¸€ä¸ªç©ºçš„nodeèŠ‚ç‚¹å½“ä½œé˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ if (compareAndSetHead(new Node())) tail = head; } else { // ç¬¬äºŒæ¬¡åŠåé¢çš„å¾ªç¯ä¼šèµ°åˆ°è¿™é‡Œ // å…ˆè®¾ç½®å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯ é˜Ÿå°¾èŠ‚ç‚¹ã€‚ node.prev = t; // ç”¨CASç®—æ³•æŠŠå½“å‰èŠ‚ç‚¹ è®¾ç½®æˆé˜Ÿå°¾ if (compareAndSetTail(t, node)) { // è¿™æ ·ä¸Šä¸€æ¬¡çš„é˜Ÿå°¾tå°±ä¸æ˜¯é˜Ÿå°¾äº†ï¼Œt å°±æœ‰äº†åç»§èŠ‚ç‚¹node t.next = node; return t; } } } } ç»è¿‡addWaiter(Node node) æ–¹æ³•åï¼Œé˜Ÿåˆ—ä¸­è‡³å°‘å­˜åœ¨ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œç¬¬ä¸€ä¸ªå°±æ˜¯å¿…é¡»çš„ç©ºèŠ‚ç‚¹ï¼Œä¸åŒ…å«çº¿ç¨‹ä¿¡æ¯ï¼Œç¬¬äºŒä¸ªæ‰æ˜¯çœŸæ­£å¾…æ‰§è¡Œçš„çº¿ç¨‹èŠ‚ç‚¹ï¼Œä½œè€…ä¸ºä»€ä¹ˆè¿™ä¹ˆåšå‘¢ï¼Ÿ\næˆ‘è®¤ä¸ºï¼Œé˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä¸ä»…æ˜¯å¾…å”¤é†’çš„çº¿ç¨‹èŠ‚ç‚¹ï¼Œè€Œæ˜¯æ‰€æœ‰ç­‰å¾…è¿è¡Œå’Œæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹èŠ‚ç‚¹ï¼Œå› ä¸ºå·²ç»æ‹¿åˆ°é”çš„æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ä¸éœ€è¦è¢«å”¤é†’ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸éœ€è¦å­˜å‚¨çº¿ç¨‹ä¿¡æ¯äº†ã€‚å¹¶ä¸”è¿™ä¸ªæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹èŠ‚ç‚¹æ˜¯é˜Ÿåˆ—ä¸­çš„å¤´èŠ‚ç‚¹\nçº¿ç¨‹æŒ‚èµ· ä¸‹é¢å°±è¦çœ‹acquireQueued æ–¹æ³•äº†\nfinal boolean acquireQueued(final Node node, int arg) { boolean failed = true; try { boolean interrupted = false; // å¼€å§‹å¾ªç¯æŠ¢é” for (;;) { // è·å–å½“å‰æ¥èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ final Node p = node.predecessor(); // å¦‚æœå‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ï¼Œå¹¶ä¸”æŠ¢é”æˆåŠŸ if (p == head \u0026amp;\u0026amp; tryAcquire(arg)) { // æŠŠå½“å‰èŠ‚ç‚¹è®¾ç½®æˆå¤´èŠ‚ç‚¹ï¼ŒsetHeadä¼šæ¸…ç©ºnodeä¸­çš„çº¿ç¨‹ä¿¡æ¯ï¼Œå’Œåˆå§‹åŒ–æ—¶è®¾ç½®çš„ç©ºå¤´èŠ‚ç‚¹ä¸€æ · setHead(node); // æ–­å¼€å‰é©±èŠ‚ç‚¹ï¼Œæ—§çš„ head ä¼šè¢«åƒåœ¾å›æ”¶ p.next = null; // help GC failed = false; return interrupted; } //èµ°åˆ°è¿™é‡Œè¯´æ˜ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œæˆ–è€…æŠ¢é”å¤±è´¥ // shouldParkAfterFailedAcquire(p, node): // æ£€æŸ¥ node æ˜¯å¦æ˜¯å¯å”¤é†’çš„ï¼ˆwaitStatus == -1ï¼‰,å¦‚æœæ˜¯ï¼Œè¿”å›true // å¦‚æœnodeä¸æ˜¯å¯å”¤é†’çš„ï¼Œå¹¶ä¸”nodeæ²¡æœ‰è¢«å–æ¶ˆæ‰ï¼Œåˆ™å°†nodeè®¾ç½®è®¾ç½®ä¸ºå¯å”¤é†’ï¼Œè¿”å›false, // ä¸‹ä¸€æ¬¡å¾ªç¯æ—¶å°±ä¼šè¿”å›false // parkAndCheckInterrupt(): æŒ‚èµ·çº¿ç¨‹ if (shouldParkAfterFailedAcquire(p, node) \u0026amp;\u0026amp; parkAndCheckInterrupt()) interrupted = true; } } finally { // è¿™ä¸ªåˆ¤æ–­ä¸ä¼šèµ°ï¼Œå¯ä»¥è®¤ä¸º failed å’Œ interrupted æ ‡è¯†è¿™é‡Œæ— ç”¨ã€‚ // ç¨‹åºèƒ½èµ°åˆ°è¿™é‡Œï¼Œè¯´æ˜ (p ==head \u0026amp;\u0026amp; tryQcquire(arg)) ä¸ºtrueï¼Œé‚£ä¹ˆ failed å’Œ interupted æ’ä¸ºfalse // å¦åˆ™å°±ä¼šé™·åœ¨å¾ªç¯ä¸­ï¼Œæ— æ³•åˆ° finally ä¸­ã€‚ if (failed) cancelAcquire(node); } } // æŠŠnodeè®¾ç½®ä¸ºé˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ private void setHead(Node node) { head = node; // æ¸…ç©ºäº†çº¿ç¨‹ä¿¡æ¯ node.thread = null; node.prev = null; } shouldParkAfterFailedAcquire(Node pred, Node node)\n// æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œä¸€ä¸ªæ˜¯å½“å‰èŠ‚ç‚¹ /** * è¿™é‡Œä½¿ç”¨å‰é©±èŠ‚ç‚¹ä¸­çš„waitStatusçŠ¶æ€æ¥åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦å¯ä»¥è¢«å”¤é†’ã€‚ */ private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) { // å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ int ws = pred.waitStatus; // å¦‚æœæ˜¯å¯å”¤é†’çš„ï¼Œç›´æ¥è¿”å›true if (ws == Node.SIGNAL) return true; if (ws \u0026gt; 0) { // æ ‡è¯†å‰é©±èŠ‚ç‚¹å·²ç»å–æ¶ˆé”ç«äº‰ï¼Œè·³è¿‡è¿™ä¸ªå‰é©±èŠ‚ç‚¹ï¼Œç»§ç»­å‘å‰æŸ¥æ‰¾ do { // ä¸€ç›´å‘å‰æ‰¾ node.prev = pred = pred.prev; } while (pred.waitStatus \u0026gt; 0); // åˆ°ä¸æ˜¯å·²å–æ¶ˆçš„èŠ‚ç‚¹ä¸ºæ­¢ // è®¾ç½®æœ‰æ•ˆçš„å‰é©±èŠ‚ç‚¹ pred.next = node; } else { // å°†å‰é©±èŠ‚ç‚¹çš„ ws è®¾ç½®å¯å”¤é†’çš„ compareAndSetWaitStatus(pred, ws, Node.SIGNAL); } return false; } é‡Šæ”¾é” é‡Šæ”¾é”çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œ\nå‡å°‘åŠ é”çš„æ¬¡æ•°(state)ï¼Œå¦‚æœstate == 0, ä»£è¡¨å½“å‰çº¿ç¨‹å¯ä»¥é‡Šæ”¾é”ï¼Œç„¶åæŠŠæŒæœ‰é”çš„çº¿ç¨‹æ ‡è®°ä¸ºç©º å”¤é†’é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªå¾…è¿è¡Œçš„çº¿ç¨‹ä¹Ÿå°±æ˜¯ç¬¬äºŒä¸ªèŠ‚ç‚¹ï¼Œå› ä¸ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å½“å‰å·²è·å–åˆ°é”æ­£åœ¨è¿è¡Œçº¿ç¨‹ public final boolean release(int arg) { // é‡Šæ”¾é” if (tryRelease(arg)) { Node h = head; // å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œä¸”å¤´èŠ‚ç‚¹çš„waitStatusä¸æ˜¯é»˜è®¤çŠ¶æ€ if (h != null \u0026amp;\u0026amp; h.waitStatus != 0) //ä¼ å…¥çš„æ˜¯å¤´èŠ‚ç‚¹ unparkSuccessor(h); return true; } return false; } // é‡Šæ”¾é” protected final boolean tryRelease(int releases) { int c = getState() - releases; if (Thread.currentThread() != getExclusiveOwnerThread()) throw new IllegalMonitorStateException(); boolean free = false; if (c == 0) { free = true; setExclusiveOwnerThread(null); } setState(c); return free; } private void unparkSuccessor(Node node) { int ws = node.waitStatus; if (ws \u0026lt; 0) // å†æ¬¡å°†ws ç½®ä¸º0ï¼Œè¿™é‡Œæš‚æ—¶ä¸æ¸…æ¥šä¸ºä»€ä¹ˆé‡ç½®çŠ¶æ€ compareAndSetWaitStatus(node, ws, 0); // è·å–ä¼ å…¥èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ Node s = node.next; if (s == null || s.waitStatus \u0026gt; 0) { s = null; for (Node t = tail; t != null \u0026amp;\u0026amp; t != node; t = t.prev) if (t.waitStatus \u0026lt;= 0) s = t; } // å”¤é†’åç»§èŠ‚ç‚¹ if (s != null) LockSupport.unpark(s.thread); } è·å–é”çš„æµç¨‹å›¾ é˜Ÿåˆ—ä¸­èŠ‚ç‚¹çŠ¶æ€ ","date":"2022-10-06T15:14:59Z","permalink":"https://dccmmtop.github.io/posts/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8Baqs%E5%8E%9F%E7%90%86/","section":"posts","tags":["java"],"title":"å¹¶å‘ç¼–ç¨‹AQSåŸç†"},{"categories":null,"contents":"import ( \u0026#34;fmt\u0026#34; \u0026#34;github.com/spf13/viper\u0026#34; \u0026#34;os\u0026#34; \u0026#34;path/filepath\u0026#34; ) type Config struct { DesDir string SourceFiles []string } func loadConfig()(con Config){ home := os.Getenv(\u0026#34;HOME\u0026#34;) viper.SetConfigFile(filepath.Join(home,\u0026#34;config\u0026#34;,\u0026#34;syncFile.yml\u0026#34;)) viper.SetConfigType(\u0026#34;yml\u0026#34;) err := viper.ReadInConfig() checkErr(err) err = viper.Unmarshal(\u0026amp;con) checkErr(err) fmt.Printf(\u0026#34;config: %v\\n\u0026#34;, con) return con } func checkErr(err error){ if err != nil { panic(err) } } ","date":"2022-09-29T14:42:32Z","permalink":"https://dccmmtop.github.io/posts/yml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96/","section":"posts","tags":["go"],"title":"ymlé…ç½®æ–‡ä»¶è¯»å–"},{"categories":null,"contents":"æ–°å»ºstart.batæ–‡ä»¶ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š\nSet ws = CreateObject(\u0026#34;Wscript.Shell\u0026#34;) ws.run \u0026#34;cmd /c D:/1.exe\u0026#34;,vbhide ","date":"2022-09-22T14:32:14Z","permalink":"https://dccmmtop.github.io/posts/bat%E8%84%9A%E6%9C%AC%E5%90%8E%E5%8F%B0%E8%BF%90%E8%A1%8Cexe/","section":"posts","tags":["win"],"title":"batè„šæœ¬åå°è¿è¡Œexe"},{"categories":null,"contents":"å¯¹äº java åº”ç”¨æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›é…ç½®æŠŠç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­çš„ gc æ—¥å¿—å…¨éƒ¨æ‰“å°å‡ºæ¥ï¼Œç„¶ååˆ†æ gc æ—¥å¿—å¾—åˆ°å…³é”®æ€§æŒ‡æ ‡ï¼Œåˆ†æ GC åŸå› ï¼Œè°ƒä¼˜ JVM å‚æ•°ï¼š\nå¼€å¯ GC æ—¥å¿—ç›¸å…³å‚æ•° java -jar â€Xloggc:./gcâ€%t.log â€XX:+PrintGCDetails â€XX:+PrintGCDateStamps â€XX:+PrintGCTimeStamps â€XX:+PrintGCCause â€XX:+UseGCLogFileRotation â€XX:NumberOfGCLogFiles=10 â€XX:GCLogFileSize=100M main.jar gc-%t.log æ—¥å¿—æ–‡ä»¶å¸¦æ—¶é—´ +PrintGCDetails æ‰“å°è¯¦ç»†ä¿¡æ¯ +PrintGCDateStamps æ‰“å°æ—¥æœŸ +PrintGCTimeStamps æ‰“å°æ—¶é—´ +PrintGCCause æ‰“å° GC åŸå›  +UseGCLogFileRotation å¼€å¯æ—¥å¿—è½®æ¢ NumberOfGCLogFiles GC æ—¥å¿—ä¿ç•™ä¸ªæ•° GCLogFileSize æ¯ä¸ªæ—¥å¿—æ–‡ä»¶çš„å¤§å° æŸ¥çœ‹jvmæ‰€æœ‰å‚æ•° java -XX:+PrintFlagsInitial è¡¨ç¤ºæ‰“å°å‡ºæ‰€æœ‰å‚æ•°é€‰é¡¹çš„é»˜è®¤å€¼ java -XX:+PrintFlagsFinal è¡¨ç¤ºæ‰“å°å‡ºæ‰€æœ‰å‚æ•°é€‰é¡¹åœ¨è¿è¡Œç¨‹åºæ—¶ç”Ÿæ•ˆçš„å€¼ GC æ—¥å¿—åˆ†æ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å›¾ä¸­ç¬¬ä¸€è¡Œçº¢æ¡†ï¼Œæ˜¯é¡¹ç›®çš„é…ç½®å‚æ•°ã€‚è¿™é‡Œä¸ä»…é…ç½®äº†æ‰“å° GC æ—¥å¿—ï¼Œè¿˜æœ‰ç›¸å…³çš„ VM å†…å­˜å‚æ•°ã€‚\nç¬¬äºŒè¡Œçº¢æ¡†ä¸­çš„æ˜¯åœ¨è¿™ä¸ª GC æ—¶é—´ç‚¹å‘ç”Ÿ GC ä¹‹åç›¸å…³ GC æƒ…å†µã€‚\nå¯¹äº 2.909ï¼š è¿™æ˜¯ä» jvm å¯åŠ¨å¼€å§‹è®¡ç®—åˆ°è¿™æ¬¡ GC ç»è¿‡çš„æ—¶é—´ï¼Œå‰é¢è¿˜æœ‰å…·ä½“çš„å‘ç”Ÿæ—¶é—´æ—¥æœŸã€‚ Full GC(Metadata GC Threshold)æŒ‡è¿™æ˜¯ä¸€æ¬¡ full gcï¼Œæ‹¬å·é‡Œæ˜¯ gc çš„åŸå› ï¼Œ PSYoungGen æ˜¯å¹´è½»ä»£çš„ GCï¼Œ ParOldGen æ˜¯è€å¹´ä»£çš„ GCï¼ŒMetaspace æ˜¯å…ƒç©ºé—´çš„ GC 6160K-\u0026gt;0K(141824K)ï¼Œè¿™ä¸‰ä¸ªæ•°å­—åˆ†åˆ«å¯¹åº” GC ä¹‹å‰å ç”¨å¹´è½»ä»£çš„å¤§å°ï¼ŒGC ä¹‹åå¹´è½»ä»£å ç”¨ï¼Œä»¥åŠæ•´ä¸ªå¹´è½»ä»£çš„å¤§å°ã€‚ 112K-\u0026gt;6056K(95744K)ï¼Œè¿™ä¸‰ä¸ªæ•°å­—åˆ†åˆ«å¯¹åº” GC ä¹‹å‰å ç”¨è€å¹´ä»£çš„å¤§å°ï¼ŒGC ä¹‹åè€å¹´ä»£å ç”¨ï¼Œä»¥åŠæ•´ä¸ªè€å¹´ä»£çš„å¤§å°ã€‚ 6272K-\u0026gt;6056K(237568K)ï¼Œè¿™ä¸‰ä¸ªæ•°å­—åˆ†åˆ«å¯¹åº” GC ä¹‹å‰å ç”¨å †å†…å­˜çš„å¤§å°ï¼ŒGC ä¹‹åå †å†…å­˜å ç”¨ï¼Œä»¥åŠæ•´ä¸ªå †å†…å­˜çš„å¤§å°ã€‚ 20516K-\u0026gt;20516K(1069056K)ï¼Œè¿™ä¸‰ä¸ªæ•°å­—åˆ†åˆ«å¯¹åº” GC ä¹‹å‰å ç”¨å…ƒç©ºé—´å†…å­˜çš„å¤§å°ï¼ŒGC ä¹‹åå…ƒç©ºé—´å†…å­˜å ç”¨ï¼Œä»¥åŠæ•´ä¸ªå…ƒç©ºé—´å†…å­˜çš„å¤§å°ã€‚ 0.0209707 æ˜¯è¯¥æ—¶é—´ç‚¹ GC æ€»è€—è´¹æ—¶é—´ ä»æ—¥å¿—å¯ä»¥å‘ç°å‡ æ¬¡fullgcéƒ½æ˜¯ç”±äºå…ƒç©ºé—´ä¸å¤Ÿå¯¼è‡´çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†å…ƒç©ºé—´è°ƒå¤§ç‚¹ï¼š\nâ€XX:MetaspaceSize=256M â€XX:MaxMetaspaceSize=256M GCæ—¥æ—¥å¿—åˆ†æå·¥å…· GC æ—¥å¿—å¤ªå¤šï¼Œäººå·¥æ— æ³•å¾ˆå¥½çš„åˆ†æå‡ºåŸå› ï¼Œå¯ä»¥åˆ©ç”¨ä¸€äº›å·¥å…·ï¼š\ngceasy https://gceasy.io/\nä»¥å›¾å½¢çš„æ–¹å¼å±•ç°å†…å­˜å˜åŒ–ç­‰ï¼Œè¿˜ä¼šç»™å‡ºä¸€äº› jvm å‚æ•°ä¼˜åŒ–çš„å»ºè®®ï¼Œç›®å‰è¿™ä¸ªåŠŸèƒ½åº”è¯¥æ”¶è´¹äº† GCæ—¥å¿—å¯¹æ€§èƒ½çš„å½±å“ å…¶å®GCæ—¥å¿—å°±æ˜¯ jvm æ‰§è¡ŒæœŸé—´é‚£äº› C++ ä»£ç æ‰“å°çš„æ—¥å¿—è€Œå·²ï¼Œå’Œæˆ‘ä»¬åº”ç”¨ä¸­çš„æ—¥å¿—æ²¡æœ‰å·®åˆ«ï¼Œåªè¦ç³»ç»Ÿæ²¡æœ‰éå¸¸é¢‘ç¹çš„å‘ç”ŸGC ä¼šå¯¼è‡´æ—¥å¿—å¤ªå¤§ï¼Œå¯¹åº”ç”¨é€ æˆçš„æ€§èƒ½å½±å“å¯ä»¥å¿½ç•¥\n","date":"2022-09-17T09:58:27Z","permalink":"https://dccmmtop.github.io/posts/gc%E6%97%A5%E5%BF%97%E8%AF%A6%E8%A7%A3/","section":"posts","tags":["java"],"title":"GCæ—¥å¿—è¯¦è§£"},{"categories":null,"contents":"Classå¸¸é‡æ±  Classå¸¸é‡æ± å¯ä»¥ç†è§£ä¸ºclassæ–‡ä»¶ä¸­çš„èµ„æºä»“åº“ï¼Œclass æ–‡ä»¶ä¸­é™¤äº†åŒ…å«ç±»ä¿¡æ¯ï¼Œæ–¹æ³•ï¼Œå­—æ®µï¼Œæ¥å£ä¿¡æ¯ä¹‹å¤–è¿˜æœ‰å¸¸é‡æ± ä¿¡æ¯ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚\nå¦‚ä¸‹:\nå¸¸é‡æ± ä¸»è¦åŒ…å«ä¸¤å¤§ç±»å¸¸é‡: å­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚\nå­—é¢é‡ å­—é¢é‡å°±æ˜¯æœ‰å­—ç¬¦ä¸²å’Œæ•°å­—ç­‰æ„æˆçš„å¸¸é‡ã€‚\nå­—é¢é‡åªèƒ½ä»¥å³å€¼å‡ºç°ï¼Œint a = 1, a æ˜¯å·¦å€¼ï¼Œ1 æ˜¯å³å€¼\nint a =1; int b =2; String c= \u0026#34;abc\u0026#34;ï¼› String d= \u0026#34;abc\u0026#34;ï¼› 1 2 \u0026ldquo;abc\u0026rdquo; éƒ½æ˜¯å¸¸é‡\nç¬¦å·å¼•ç”¨ ç¬¦å·å¼•ç”¨æ˜¯ç¼–è¯‘åŸç†ä¸­æ¦‚å¿µï¼Œæ˜¯ç›¸å¯¹äºç›´æ¥å¼•ç”¨æ¥è¯´çš„ï¼Œä¸»è¦åŒ…æ‹¬ä¸€ä¸‰ç±»å¸¸é‡:\nç±»å’Œæ¥å£çš„å…¨é™å®šå å­—æ®µçš„åç§°å’Œæè¿°ç¬¦ æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦ ä¸Šé¢çš„ a bå°±æ˜¯å­—æ®µå ï¼Œæ˜¯ç¬¦å·å¼•ç”¨ã€‚ è¿˜æœ‰åŒ…å+ç±»å ç»„æˆçš„ç±»çš„å…¨é™å®šåï¼Œæ–¹æ³•åï¼Œä»¥åŠ() éƒ½æ˜¯ç¬¦å·å¼•ç”¨\nè¿è¡Œå¸¸é‡æ±  å­˜åœ¨class æ–‡ä»¶çš„å¸¸é‡éƒ½æ˜¯é™æ€ä¿¡æ¯ï¼Œåªæœ‰åˆ°è¿è¡Œæ—¶è¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¿™äº›ç¬¦å·æ‰æœ‰å…·ä½“çš„å†…å­˜åœ°å€ï¼Œè¿™äº›å¸¸é‡ä¸€æ—¦è¢«åŠ è½½å†…å­˜ä¸­ï¼Œå°±å˜æˆè¿è¡Œå¸¸é‡æ± ï¼Œå¯¹åº”çš„ç¬¦å·å¼•ç”¨åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œä¼šè¢«åŠ è½½åˆ°å†…å­˜åŒºåŸŸçš„ä»£ç ç›´æ¥å¼•ç”¨ï¼Œä¹Ÿå°±æˆ‘ä»¬è¯´çš„åŠ¨æ€é“¾æ¥ï¼Œä¾‹å¦‚ï¼š compute() è¿™ä¸ªç¬¦å·å¼•ç”¨åœ¨è¿è¡Œæ—¶å°±ä¼šè¢«è½¬åŒ–æˆcompute()æ–¹æ³•å…·ä½“ä»£ç åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œ\nå­—ç¬¦ä¸²å¸¸é‡æ±  åœ¨å†…å­˜ä¸­ä¸“é—¨å­˜æ”¾å­—ç¬¦ä¸²å­—é¢é‡çš„åŒºåŸŸç§°ä½œå­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œé‚£ä¹ˆé™¤äº†æŠŠå¯¹è±¡æ”¾å…¥å †ä¸­ä¹‹å¤–ã€‚è¿˜éœ€è¦ç‹¬ç«‹çš„åŒºåŸŸå­˜æ”¾å­—ç¬¦ä¸²å­—é¢é‡å‘¢ï¼Ÿ\nä¸»è¦æ˜¯ä¸ºäº†æ€§èƒ½ï¼š\nå­—ç¬¦ä¸²çš„åˆ†é…å’Œå…¶ä»–å¯¹è±¡åˆ†é…ä¸€æ ·ï¼Œè€—è´¹é«˜æ˜‚çš„æ—¶é—´ä¸ç©ºé—´ä»£ä»·ï¼Œä½œä¸ºæœ€åŸºç¡€çš„æ•°æ®ç±»å‹ï¼Œéœ€è¦å¤§é‡é¢‘ç¹çš„åˆ›å»ºï¼Œæå¤§å½±å“äº†ç¨‹åºçš„æ€§èƒ½ JVM ä¸ºäº†æé«˜æ€§èƒ½å’Œå‡å°‘å†…å­˜å¼€é”€ï¼Œåœ¨å®ä¾‹åŒ–å­—ç¬¦ä¸²å¸¸é‡çš„æ—¶å€™è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–ï¼š\nä¸ºå­—ç¬¦ä¸²å¼€è¾Ÿä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡æ± ï¼Œç±»ä¼¼äºç¼“å­˜ åˆ›å»ºå­—ç¬¦ä¸²å¸¸é‡æ—¶ï¼Œé¦–å…ˆæŸ¥è¯¢å­—ç¬¦ä¸²å¸¸é‡æ± æ˜¯å¦å·²ç»å­˜åœ¨ è‹¥å­˜åœ¨è¯¥å­—ç¬¦ä¸²ï¼Œç›´æ¥è¿”å›å¼•ç”¨ç¤ºä¾‹ï¼Œä¸å­˜åœ¨ï¼Œå®ä¾‹åŒ–è¯¥å­—ç¬¦ä¸²å¹¶æ”¾å…¥æ± ä¸­ ä»€ä¹ˆæ—¶å€™ä¼šæŠŠå­—ç¬¦ä¸²å¸¸é‡æ”¾å…¥å¸¸é‡æ±  ç›´æ¥èµ‹å€¼å­—ç¬¦ä¸² String s = \u0026#34;hello\u0026#34;ï¼› è¿™ç§æ–¹å¼åˆ›å»ºçš„å­—ç¬¦ä¸²åªä¼šåœ¨å¸¸é‡æ± ä¸­ï¼Œä¸ä¼šåœ¨å †ä¸­é¢å¤–åˆ›å»ºä¸€ä¸ªå¯¹è±¡\nå½“å†æ¬¡åˆ›å»ºå­—ç¬¦ä¸² String s1 = \u0026quot;hello\u0026quot; æ—¶ï¼Œå…ˆå»å¸¸é‡æ± ä¸­é€šè¿‡ equals(key) æ–¹æ³•åˆ¤æ–­æ˜¯å¦æœ‰ç›¸åŒçš„å¯¹è±¡ï¼Œå¦‚æœæœ‰ç›´æ¥è¿”å›å¯¹è±¡åœ¨å¸¸é‡æ± çš„å¼•ç”¨ã€‚å¦‚æœæ²¡æœ‰ä¼šåœ¨å¸¸é‡æ± æ–°æ–°å»ºå¯¹è±¡ï¼Œå†è¿”å›å¼•ç”¨\næ‰€ä»¥æœ‰å¦‚ä¸‹ç»“æœ:\nString s = \u0026#34;hello\u0026#34;ï¼› String s1 = \u0026#34;hello\u0026#34;ï¼› System.out.println( s == 1) // true. s å’Œ s1 åœ°å€ä¸€æ · new String() String s = new String(\u0026#34;hello\u0026#34;); è¿™ä¸­æ–¹å¼åˆ›å»ºå­—ç¬¦ä¸²ä¼šä¿è¯å¸¸é‡æ± ä¸­å’Œå †ä¸­éƒ½æœ‰è¿™ä¸ªå¯¹è±¡ï¼Œæœ€åè¿”å›å †ä¸­çš„åœ°å€:\nintern æ–¹æ³• String s = new String(\u0026#34;hello\u0026#34;)ï¼› String s1 = s.intern(); System.out.println(s == s1) // false String intern æ–¹æ³•æ˜¯ä¸€ä¸ª native æ–¹æ³•ï¼Œå¦‚æœæ± ä¸­å·²ç»åŒ…å«ä¸€ä¸ªç­‰äºæ­¤ String å¯¹è±¡çš„å­—ç¬¦ä¸²ï¼Œåˆ™è¿”å›æ± ä¸­çš„å­—ç¬¦ä¸²ï¼Œå¦åˆ™å°†intern è¿”å›çš„å¼•ç”¨æŒ‡å‘å½“å‰å­—ç¬¦ä¸²ï¼ˆåœ¨ jdk 1.6 ä¸­ï¼Œéœ€è¦å°†s1å­—ç¬¦ä¸²å¤åˆ¶åˆ°å¸¸é‡æ± ä¸­ï¼‰\nåœ¨ç¬¬ä¸€ç§æƒ…å†µï¼ŒString s = \u0026quot;hello\u0026quot; ä¼šå°† hello æ”¾å…¥å¸¸é‡æ± ä¸­ï¼Œ ç¬¬äºŒç§æƒ…å†µ String s = new String(\u0026quot;hello\u0026quot;) ä¹Ÿä¼šå°† hello æ”¾å…¥å¸¸é‡æ± ä¸­ï¼Œé‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹å¸¸é‡æ± ä¼šæ²¡æœ‰æˆ‘ä»¬è¦å–çš„å­—ç¬¦ä¸²å‘¢ï¼Ÿ\nå¸¸é‡æ± å­˜æ”¾çš„ä¸€å®šæ˜¯ä¸å¯å˜çš„å­—é¢é‡, æ— è®ºæ˜¯ String s = \u0026quot;hello\u0026quot; è¿˜æ˜¯ String s = new String(\u0026quot;hello\u0026quot;) éƒ½æœ‰ä¸€ä¸ªæ˜ç¡®çš„å­—é¢é‡: hello å¦‚æœæ˜¯ä¸‹é¢è¿™ç§æƒ…å†µ:\nString s = new String(\u0026#34;hello\u0026#34;) + new String(\u0026#34;World\u0026#34;) String s1 = \u0026#34;helloWorld\u0026#34;ï¼› System.out.println(s == s1) // false System.out.println(s == s.intern()) // true å¸¸é‡æ± ä¸­æœ‰ hello å’Œ World ä½†æ˜¯æ²¡æœ‰ helloWorldï¼Œ å› ä¸ºåœ¨ä»£ç ä¸­æ²¡æœ‰æ˜ç¡®çš„helloWorldå­—é¢é‡ï¼Œæ‰€ä»¥ s != s1, å¸¸é‡æ± ä¸­æ²¡æœ‰ helloWorld å­—é¢é‡ï¼Œæ‰€ä»¥ s.intern() è¿”å›çš„æ˜¯å †ä¸­çš„åœ°å€ï¼Œæ•…è€Œ s == s.intern()\nå†çœ‹ä¸‹é¢ä¸€ç§æƒ…å†µ:\nString s = \u0026#34;hello\u0026#34; + \u0026#34;World\u0026#34;ï¼› String s1 = \u0026#34;helloWorld\u0026#34;ï¼› System.out.println(s == s1) // true ä»£ç ä¸­ä¹Ÿæ²¡æœ‰æ˜ç¡®çš„helloWorld å­—é¢é‡ï¼Œ ä¸ºä»€ä¹ˆ s == s1 å‘¢ï¼Œ å› ä¸º hello å’Œ World éƒ½æ˜¯ä¸å¯å˜çš„å­—é¢é‡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œåœ¨ String s = \u0026quot;hello\u0026quot; + \u0026quot;World\u0026quot; æ—¶ï¼Œ ç¼–è¯‘å™¨å¯ä»¥ä¼˜åŒ–æˆ s = \u0026quot;helloWorld\u0026quot; ï¼Œ æ‰€ä»¥ s == s1 ï¼Œé‚£ä¸ºä»€ä¹ˆ String s = new String(\u0026quot;hello\u0026quot;) + new String(\u0026quot;World\u0026quot;) ä¸ä¼šè¢«ç¼–è¯‘å™¨ä¼˜åŒ–å‘¢ï¼Ÿ å› ä¸º new String(\u0026quot;hello\u0026quot;) æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿”å›çš„æ˜¯å¼•ç”¨ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸ä¼šå˜åŒ–çš„å­—é¢é‡ï¼Œåé¢è¿™ä¸ªå¼•ç”¨åœ°å€å¯èƒ½ä¼šæŒ‡å‘å…¶ä»–çš„å¯¹è±¡ï¼Œä¼˜åŒ–åå¯èƒ½ä¼šå‡ºç°é”™è¯¯ã€‚åŒç†ï¼š\nString s = \u0026#34;hello\u0026#34;; String s1 = \u0026#34;World\u0026#34;ï¼› String s2 = s + s1; // ä¸ä¼šç¼–è¯‘å™¨ä¼˜åŒ–æˆ \u0026#34;helloWorld\u0026#34; String s3 = \u0026#34;helloWorld\u0026#34;; System.out.println(s3 == s2); // false ä½†æ˜¯è¢« final ä¿®é¥°çš„å˜é‡å¯ä»¥è¢«ä¼˜åŒ–ï¼Œå› ä¸ºå®ƒä¸ä¼šå‘ç”Ÿå˜åŒ–äº†ï¼š\nfinal String s = \u0026#34;hello\u0026#34;; // s ä¸ä¼šå†è¢«é‡æ–°èµ‹å€¼ final String s1 = \u0026#34;World\u0026#34;ï¼› String s2 = s + s1; // ç¼–è¯‘å™¨ä¼˜åŒ–æˆ \u0026#34;helloWorld\u0026#34; String s3 = \u0026#34;helloWorld\u0026#34;; System.out.println(s3 == s2); // true å†çœ‹ä¸‹é¢ä¸€ç§æƒ…å†µï¼š\nfinal String s = getHello(); // s è™½ç„¶ä¸èƒ½å†è¢«é‡æ–°èµ‹å€¼ï¼Œä½†getHello() æ–¹æ³•è¿”å›çš„å€¼å¯èƒ½ä¼šæ”¹å˜ final String s1 = \u0026#34;World\u0026#34;ï¼› String s2 = s + s1; // ä¸ä¼šç¼–è¯‘å™¨ä¼˜åŒ–æˆ \u0026#34;helloWorld\u0026#34; String s3 = \u0026#34;helloWorld\u0026#34;; System.out.println(s3 == s2); // false public String getHello(){ return \u0026#34;hello\u0026#34; } s çš„å€¼æ— æ³•å†ç¼–è¯‘å™¨ç¡®å®šï¼Œæ‰€ä»¥æ— æ³•ä¼˜åŒ–æˆå­—é¢é‡\nå†çœ‹æœ€åä¸€ä¸ªä¾‹å­ï¼š\nString s1 = new String(\u0026#34;hello\u0026#34;) + new String(\u0026#34;World\u0026#34;)ï¼› System.out.println(s1 == s1.intern()) // true String s = new String(\u0026#34;ja\u0026#34;) + new String(\u0026#34;va\u0026#34;)ï¼› System.out.println(s == s.intern()) // false ä¸ºä»€ä¹ˆåŒæ ·çš„å†™æ³•ï¼Œç»“æœå´ä¸ä¸€æ ·å‘¢ï¼Ÿ\nintern() æ–¹æ³•ä¼˜å…ˆè¿”å›å¸¸é‡æ± ä¸­çš„åœ°å€, å¸¸é‡æ± ä¸å­˜åœ¨æ—¶ï¼Œå†è¿”å›å †ä¸­çš„åœ°å€ï¼Œ ç¬¬ä¸€ä¸ª s1 != s1.intern() æ˜¯ç¬¦åˆæˆ‘ä»¬ç›´è§‰çš„ï¼Œå› ä¸ºå¸¸é‡æ± ä¸­æ²¡æœ‰ helloWorld , ä½†æ˜¯ç¬¬äºŒä¸ª s == s.intern() ä¸ºfalse å°±è¯´ä¸é€šäº†ï¼Œéš¾é“å¸¸é‡æ± å·²ç»æœ‰ java è¿™ä¸ªå­—é¢é‡äº†å—ï¼Ÿ æ˜¯çš„ï¼Œ java è¿™ä¸ªå…³é”®è¯ï¼Œåœ¨jvm å¯åŠ¨æˆ–ç±»åŠ è½½æœŸé—´è‚¯å®šæœ‰ java è¿™ä¸ªå­—ç¬¦ä¸²å·²ç»æ”¾å…¥åˆ°å¸¸é‡æ± ä¸­äº†ï¼Œ s.inern() è¿”å›çš„æ˜¯å¸¸é‡æ± ä¸­çš„åœ°å€.\nå…«ç§åŸºæœ¬ç±»å‹çš„åŒ…è£…ç±»å’Œå¯¹è±¡æ±  javaä¸­åŸºæœ¬ç±»å‹çš„åŒ…è£…ç±»çš„å¤§éƒ¨åˆ†éƒ½å®ç°äº†å¸¸é‡æ± æŠ€æœ¯(ä¸¥æ ¼æ¥è¯´åº”è¯¥å«å¯¹è±¡æ± ï¼Œåœ¨å †ä¸Š)ï¼Œè¿™äº›ç±»æ˜¯ Byte,Short,Integer,Long,Character,Boolean,å¦å¤–ä¸¤ç§æµ®ç‚¹æ•°ç±»å‹çš„åŒ…è£…ç±»åˆ™æ²¡æœ‰å®ç°ã€‚å¦å¤– Byte,Short,Integer,Long,Characterè¿™5ç§æ•´å‹çš„åŒ…è£…ç±»ä¹Ÿåªæ˜¯åœ¨å¯¹åº”å€¼å°äºç­‰äº127æ—¶æ‰å¯ä½¿ç”¨å¯¹è±¡æ± ï¼Œä¹Ÿå³å¯¹è±¡ä¸è´Ÿè´£åˆ›å»ºå’Œç®¡ç†oå¤§äº127çš„è¿™äº›ç±»çš„å¯¹è±¡ã€‚å› ä¸ºä¸€èˆ¬è¿™ç§æ¯”è¾ƒå°çš„æ•°ç”¨åˆ°çš„æ¦‚ç‡ç›¸å¯¹è¾ƒå¤§\npublic class Test { public static void main(String[] args) { //5ç§æ•´å½¢çš„åŒ…è£…ç±»Byte,Short,Integer,Long,Characterçš„å¯¹è±¡ï¼Œ //åœ¨å€¼å°äº127æ—¶å¯ä»¥ä½¿ç”¨å¯¹è±¡æ±  Integer i1 = 127; //è¿™ç§è°ƒç”¨åº•å±‚å®é™…æ˜¯æ‰§è¡Œçš„Integer.valueOf(127)ï¼Œé‡Œé¢ç”¨åˆ°äº†IntegerCacheå¯¹è±¡æ±  Integer i2 = 127; System.out.println(i1 == i2);//è¾“å‡ºtrue //å€¼å¤§äº127æ—¶ï¼Œä¸ä¼šä»å¯¹è±¡æ± ä¸­å–å¯¹è±¡ Integer i3 = 128; Integer i4 = 128; System.out.println(i3 == i4);//è¾“å‡ºfalse //ç”¨newå…³é”®è¯æ–°ç”Ÿæˆå¯¹è±¡ä¸ä¼šä½¿ç”¨å¯¹è±¡æ±  Integer i5 = new Integer(127); Integer i6 = new Integer(127); System.out.println(i5 == i6);//è¾“å‡ºfalse //Booleanç±»ä¹Ÿå®ç°äº†å¯¹è±¡æ± æŠ€æœ¯ Boolean bool1 = true; Boolean bool2 = true; System.out.println(bool1 == bool3);//è¾“å‡ºtrue //æµ®ç‚¹ç±»å‹çš„åŒ…è£…ç±»æ²¡æœ‰å®ç°å¯¹è±¡æ± æŠ€æœ¯ Double d1 = 1.0; Double d2 = 1.0; System.out.println(d1 == d2);//è¾“å‡ºfalse } } ","date":"2022-09-15T10:05:51Z","permalink":"https://dccmmtop.github.io/posts/java%E5%B8%B8%E9%87%8F%E6%B1%A0/","section":"posts","tags":["java"],"title":"javaå¸¸é‡æ± "},{"categories":null,"contents":"javaå†…å­˜æ¨¡å‹ ï¼ˆJMMï¼‰ è¿™ç§æ¨¡å‹å’Œ jvm ä¸­çš„å †ä¸åŒï¼Œ JMM æ˜¯æŠ½è±¡æ¦‚å¿µï¼Œä¸çœŸå®å­˜åœ¨ã€‚å®ƒæ˜¯ä¸€ç§è§„èŒƒï¼ŒæŒ‡å®šäº†ç¨‹åºä¸­çš„å„å˜é‡çš„è®¿é—®æ–¹å¼\nä¸»å†…å­˜ JMM è§„å®šæ‰€æœ‰å˜é‡éƒ½å­˜æ”¾åœ¨ä¸»å†…å­˜ï¼Œä¸»å†…å­˜æ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ï¼Œä½†æ˜¯çº¿ç¨‹çš„æ“ä½œåœ¨çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œå…ˆä»ä¸»å†…å­˜è¯»å–åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œç„¶åæ‰§è¡Œæ“ä½œï¼Œå†å°†å·¥ä½œå†…å­˜ä¸­çš„å€¼å†™å…¥ä¸»å†…å­˜ä¸­ã€‚çº¿ç¨‹ä¸èƒ½ç›´æ¥æ“ä½œä¸»å†…å­˜ä¸­çš„æ•°æ®\nå·¥ä½œå†…å­˜ å·¥ä½œå†…å­˜æ˜¯çº¿ç¨‹ç‹¬æœ‰çš„ï¼Œä¸åŒçš„çº¿ç¨‹æ— æ³•è®¿é—®åˆ°å¯¹æ–¹çš„å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹é—´çš„é€šä¿¡å¿…é¡»é€šè¿‡ä¸»å†…å­˜ä¼ å€¼è¿›è¡Œ\nJMM æè¿°çš„æ˜¯å˜é‡åœ¨å…±äº«åŒºåŸŸå’Œç§æœ‰åŒºåŸŸçš„è®¿é—®æ–¹å¼ï¼Œå˜é‡çš„è®¿é—®åœ¨å¤šçº¿ç¨‹ä¸‹ä¼šæœ‰ å¯è§æ€§ï¼ŒåŸå­æ€§ï¼Œå¯è§æ€§ä¸‰å¤§é—®é¢˜\nå¯è§æ€§é—®é¢˜ å› ä¸ºæœ‰å·¥ä½œå†…å­˜çš„åˆ’åˆ†ï¼Œä¸€ä¸ªçº¿ç¨‹æ“ä½œä¿®æ”¹æŸå˜é‡çš„å€¼ï¼Œæ²¡æœ‰åŒæ­¥åˆ°ä¸»å†…å­˜å‰ï¼Œå…¶ä»–çº¿ç¨‹æ˜¯æ— æ³•è¯»å–åˆ°è¯¥å˜é‡æœ€æ–°çš„å€¼ï¼Œå°±å¯¼è‡´äº†å˜é‡åœ¨å¦å¤–çš„çº¿ç¨‹ä¸å¯è§ã€‚\nç¤ºä¾‹:\npublic class CodeVisibility { private static boolean initFlag = false; // private volatile static boolean initFlag = false; private static int counter = 0; public static void refresh() { System.out.println(\u0026#34;refresh data.......\u0026#34;); initFlag = true; System.out.println(\u0026#34;refresh data success.......\u0026#34;); } public static void main(String[] args) { Thread threadA = new Thread(() -\u0026gt; { while (!initFlag) { counter++; } System.out.println(\u0026#34;çº¿ç¨‹ï¼š\u0026#34; + Thread.currentThread().getName() + \u0026#34;å½“å‰çº¿ç¨‹å—…æ¢åˆ°initFlagçš„çŠ¶æ€çš„æ”¹å˜, counter: \u0026#34; + counter); }, \u0026#34;threadA\u0026#34;); threadA.start(); try { Thread.sleep(500); } catch (InterruptedException e) { e.printStackTrace(); } Thread threadB = new Thread(() -\u0026gt; { refresh(); }, \u0026#34;threadB\u0026#34;); threadB.start(); } } ç»“æœ:\nå¯è§çœ‹åˆ°çº¿ç¨‹Aä¹…ä¹…ä¸èƒ½ç»“æŸï¼Œè™½ç„¶çº¿ç¨‹Bæ­¤æ—¶å·²ç»ä¿®æ”¹äº† initFlag çš„å€¼ï¼Œä½†æ˜¯çº¿ç¨‹Aæ— æ³•è¯»å–åˆ°æœ€æ–°å€¼ï¼Œå› ä¸ºä¸€ç›´æ²¡æœ‰å’Œä¸»å†…å­˜åŒæ­¥\nvolatile è¿™ä¸ªå…³é”®è¯å¯ä»¥è®©å˜é‡è¢«ä¿®æ”¹åç«‹åˆ»ä½¿å…¶ä»–çº¿ç¨‹ä¸­çš„å‰¯æœ¬å¯è§ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­ï¼ŒæŠŠç¬¬3è¡Œæ³¨é‡Šï¼Œç¬¬4è¡Œå–æ¶ˆæ³¨é‡Šåå†è¿è¡Œ:\nå¯ä»¥çœ‹åˆ°çº¿ç¨‹Aå¯ä»¥ç«‹å³ç»“æŸ\nvolatile åŸç† ä½¿ç”¨ volatile å…³é”®å­—ä¼šå¼ºåˆ¶å°†åœ¨æŸä¸ªçº¿ç¨‹ä¸­ä¿®æ”¹çš„å…±äº«å˜é‡çš„å€¼ç«‹å³å†™å…¥ä¸»å†…å­˜ã€‚ ä½¿ç”¨ volatile å…³é”®å­—ï¼Œ å½“çº¿ç¨‹ 2 è¿›è¡Œä¿®æ”¹æ—¶ï¼Œ ä¼šå¯¼è‡´çº¿ç¨‹ 1 çš„å·¥ä½œå†…å­˜ä¸­å˜é‡çš„ç¼“å­˜è¡Œæ— æ•ˆï¼ˆåæ˜ åˆ°ç¡¬ä»¶å±‚çš„è¯ï¼Œ å°±æ˜¯ CPU çš„ L1æˆ–è€… L2 ç¼“å­˜ä¸­å¯¹åº”çš„ç¼“å­˜è¡Œæ— æ•ˆ); ç”±äºçº¿ç¨‹ 1 çš„å·¥ä½œå†…å­˜ä¸­å˜é‡çš„ç¼“å­˜è¡Œæ— æ•ˆï¼Œæ‰€ä»¥çº¿ç¨‹1å†æ¬¡è¯»å–å˜é‡çš„å€¼æ—¶ä¼šå»ä¸»å­˜è¯»å–ã€‚ ç‰¹æ€§ åªèƒ½æ§åˆ¶å˜é‡çš„å¯è§æ€§ ä¸èƒ½è§£å†³åŸå­æ€§é—®é¢˜ è¿˜å¯ä»¥ç¦æ­¢CPUæŒ‡ä»¤é‡æ’ï¼ˆè§ä¸‹ï¼‰ volatile ç•ªå¤– å¦‚æœä¸å¯¹ initFlag æ·»åŠ  volatile æ ‡è¯†ï¼Œçº¿ç¨‹Aå°±æ°¸è¿œæ— æ³•è¯»å–åˆ°initFlagçš„æœ€æ–°å€¼å—ï¼Ÿ\nä¸ä¸€å®šï¼Œ åœ¨åˆ¤æ–­ initFlag çš„å€¼æ—¶ï¼ŒCPU å…ˆä»ç¼“å­˜ä¸­å–å€¼ï¼Œåªè¦ç¼“å­˜å¤±æ•ˆï¼Œå°±ä¼šé‡æ–°åœ¨ä»å†…å­˜ä¸­åŠ è½½ã€‚é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ç¼“å­˜ä¼šå¤±æ•ˆå‘¢ï¼Ÿ å¯¹äºCPUç¼“å­˜æ¥è¯´ï¼Œåˆ†ä¸º L1 L2 L3 ä¸‰çº§ç¼“å­˜ï¼Œä¹Ÿå°±æ˜¯ç¦»CPUæœ€è¿‘çš„é‚£äº›å¯„å­˜å™¨ï¼Œä»–ä»¬çš„é€Ÿåº¦ä¾æ¬¡é€’å‡ï¼Œå®¹é‡ä¾æ¬¡é€’å¢ã€‚è€Œæ¯æ¬¡CPUç¼“å­˜çš„æœ€å°å•ä½ä¸æ˜¯æŸä¸ªå˜é‡æ‰€å çš„ç©ºé—´å¤§å°ï¼Œè€Œæ˜¯å›ºå®šçš„å­—èŠ‚ ï¼Œè¿™æ ·å°±èƒ½å‡å°‘CPUå’Œå†…å­˜äº¤äº’çš„æ¬¡æ•°ï¼Œæ›´å¥½çš„åˆ©ç”¨ç©ºé—´å±€éƒ¨åŸç†å’Œæ—¶é—´å±€éƒ¨æ€§åŸç†ã€‚å…·ä½“ç»†èŠ‚å¯ä»¥æœç´¢ CPUç¼“å­˜ç›¸å…³ä¿¡æ¯\nå› ä¸ºCPUä¸€æ¬¡ä¼šè®©ä¸€æ‰¹ç¼“å­˜å¤±æ•ˆï¼Œæœ‰å¯èƒ½ initFlag çš„ç¼“å­˜ä¼šéšç€å…¶ä»–å€¼å¤±æ•ˆè€Œé‡æ–°ä»å†…å­˜åŠ è½½æœ€æ–°å€¼ã€‚å¦‚ä¸‹ä¾‹å­:\npublic class CodeVisibility { // initFlag ä¸å†ç”¨ volatile ä¿®é¥° private static boolean initFlag = false; // è¿™é‡Œ counter ç±»å‹ä» int ä¿®æ”¹æˆ Integer private static Integer counter = 0; public static void refresh() { System.out.println(\u0026#34;refresh data.......\u0026#34;); initFlag = true; System.out.println(\u0026#34;refresh data success.......\u0026#34;); } public static void main(String[] args) { Thread threadA = new Thread(() -\u0026gt; { while (!initFlag) { counter++; } // çº¿ç¨‹ä»ç„¶å¯ä»¥å¾ˆå¿«çš„ç»“æŸï¼Œå› ä¸º counter ä¼šå¯¼è‡´ cpu ç¼“å­˜å¤±æ•ˆï¼Œé‡æ–°ä»ä¸»å†…å­˜åŠ è½½æœ€æ–°æ•°æ® System.out.println(\u0026#34;çº¿ç¨‹ï¼š\u0026#34; + Thread.currentThread().getName() + \u0026#34;å½“å‰çº¿ç¨‹å—…æ¢åˆ°initFlagçš„çŠ¶æ€çš„æ”¹å˜, counter: \u0026#34; + counter); }, \u0026#34;threadA\u0026#34;); threadA.start(); try { Thread.sleep(500); } catch (InterruptedException e) { e.printStackTrace(); } Thread threadB = new Thread(() -\u0026gt; { refresh(); }, \u0026#34;threadB\u0026#34;); threadB.start(); } } ç»“æœ:\né‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œä¸ºä»€ä¹ˆç”¨ int ä¸ä¼š å¯¼è‡´ cpu ç¼“å­˜å¤±æ•ˆå‘¢ï¼Ÿ\nä¸ªäººæ¨æµ‹å¯èƒ½ä½¿å› ä¸º int æ¯” Integer æ‰€å ç”¨çš„å†…å­˜æ›´å°ï¼ŒCPUç¼“å­˜æ”¾å¾—ä¸‹ï¼Œä¸€ç›´æ²¡æœ‰è§¦å‘ç¼“å­˜å¤±æ•ˆã€‚\næœ‰åºæ€§é—®é¢˜ å…ˆçœ‹ä¸€ä¸ªä¾‹å­:\npublic class VolatileReOrderSample { //å®šä¹‰å››ä¸ªé™æ€å˜é‡ private static int x=0,y=0; private static int a=0,b=0; public static void main(String[] args) throws InterruptedException { int i=0; while (true){ i++; x=0;y=0;a=0;b=0; //å¼€ä¸¤ä¸ªçº¿ç¨‹ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œa=1;x=b;ç¬¬äºŒä¸ªçº¿ç¨‹æ‰§è¡Œb=1;y=a Thread thread1=new Thread(new Runnable() { @Override public void run() { //çº¿ç¨‹1ä¼šæ¯”çº¿ç¨‹2å…ˆæ‰§è¡Œï¼Œå› æ­¤ç”¨nanoTimeè®©çº¿ç¨‹1ç­‰å¾…çº¿ç¨‹2 0.01æ¯«ç§’ shortWait(10000); a=1; x=b; } }); Thread thread2=new Thread(new Runnable() { @Override public void run() { b=1; y=a; } }); thread1.start(); thread2.start(); thread1.join(); thread2.join(); //ç­‰ä¸¤ä¸ªçº¿ç¨‹éƒ½æ‰§è¡Œå®Œæ¯•åæ‹¼æ¥ç»“æœ String result=\u0026#34;ç¬¬\u0026#34;+i+\u0026#34;æ¬¡æ‰§è¡Œx=\u0026#34;+x+\u0026#34;y=\u0026#34;+y; //å¦‚æœx=0ä¸”y=0ï¼Œåˆ™è·³å‡ºå¾ªç¯ if (x==0\u0026amp;\u0026amp;y==0){ System.out.println(result); break; }else{ System.out.println(result); } } } //ç­‰å¾…intervalçº³ç§’ private static void shortWait(long interval) { long start=System.nanoTime(); long end; do { end=System.nanoTime(); }while (start+interval\u0026gt;=end); } } å¤åˆ¶ä»£ç  æŒ‰ç…§æ­£å¸¸æ€ç»´ï¼Œæ°¸è¿œä¸ä¼šå‘ç”Ÿ x=0 y=0çš„åœºæ™¯ï¼Œä½†äº‹å®å¹¶éå¦‚æ­¤:\nä¸‹é¢æ˜¯çº¿ç¨‹A B å¯èƒ½çš„æ­£å¸¸æ‰§è¡Œæƒ…å†µ\nçº¿ç¨‹Aæ‰§è¡Œå®Œ çº¿ç¨‹Bæ‰§è¡Œ\nçº¿ç¨‹Bæ‰§è¡Œå®Œ çº¿ç¨‹Aæ‰§è¡Œï¼š\nçº¿ç¨‹A B äº¤å‰æ‰§è¡Œ\nå‘ç”ŸæŒ‡ä»¤é‡æ’çš„æƒ…å†µ\næŒ‡ä»¤é‡æ’ å¤„ç†å™¨ä¸ºäº†ç¨‹åºçš„æ€§èƒ½å¯ä»¥å¯¹ç¨‹åºçš„æ‰§è¡Œé¡ºåºè¿›è¡Œé‡æ’ï¼Œä½†æ˜¯ï¼Œå¿…é¡»æ»¡è¶³é‡æ’åçš„æ‰§è¡Œç»“æœåœ¨å•çº¿ç¨‹ä¸‹ç»“æœä¸èƒ½å‘ç”Ÿæ”¹å˜ è¿™å°±æ˜¯ as-if-serial è¯­ä¹‰\nä¸ºäº†éµå®ˆ as-if-serial è¯­ä¹‰,ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¸ä¼šå¯¹å­˜åœ¨æ•°æ®ä¾èµ–çš„æ“ä½œè¿›è¡Œé‡æ’ï¼Œå› ä¸ºä¼šæ”¹å˜æ‰§è¡Œç»“æœï¼Œå¦‚æœä¸¤ä¸ªæ“ä½œä¸å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œå°±æœ‰å¯èƒ½ä¼šè¢«é‡æ’ï¼Œå°±å…¥ä¸Šé¢çš„ä»£ç ï¼Œåœ¨çº¿ç¨‹Aä¸­a=1;x=bè¿™ä¸¤å„æ“ä½œæ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œå°±æœ‰å¯èƒ½ä¼šé‡æ–°æ’åºæˆx=b;a=1 , çº¿ç¨‹BåŒç†ã€‚\nè¿™ä¸ªæ‰§è¡Œé‡æ’çš„æ“ä½œåœ¨å•çº¿ç¨‹ä¸‹æ²¡æœ‰å…³ç³»ï¼Œå› ä¸ºæ²¡æœ‰å½±å“åˆ°æœ€ç»ˆçš„æ‰§è¡Œçš„ç»“æœï¼Œä½†æ˜¯å¦‚æœæ˜¯å¤šçº¿ç¨‹çš„åœºæ™¯ï¼Œå°±åƒä¸Šé¢çš„é‚£ä¸ªä¾‹å­ï¼Œå°±ä¼šå‘ç”Ÿé”™è¯¯\nå¦‚ä½•ç¦æ­¢æŒ‡ä»¤é‡æ’ volatile volatile å¦ä¸€ä¸ªä½œç”¨æ˜¯ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼Œé¿å…å¤šçº¿ç¨‹ä¸‹å‡ºç°ä¹±åºæ‰§è¡Œçš„æƒ…å†µ\né‡æ’è§„åˆ™è¡¨:\nä»ä¸Šé¢çš„è§„åˆ™å¯ä»¥çœ‹å‡ºï¼š\nå½“ç¬¬äºŒä¸ªæ“ä½œæ˜¯ volatile å†™æ—¶ï¼Œä¸ç®¡ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½å‘ç”Ÿé‡æ’ï¼Œ å½“ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯ volatile è¯»æ—¶ï¼Œä¸ç®¡ç¬¬äºŒä¸ªæ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½å‘ç”Ÿé‡æ’ å½“ç¬¬ä¸€ä¸ªæ“ä½œæ—¶ volatile å†™ï¼Œç¬¬äºŒä¸ªæ“ä½œæ˜¯ volatile è¯»æ—¶ï¼Œä¸èƒ½å‘ç”Ÿé‡æ’ åŠ é”ä¿è¯æœ‰åºæ€§ å¦å¤–è¿˜å¯ä»¥ä½¿ç”¨ synchronize å’Œ lock æ¥ä¿è¯æœ‰åºæ€§ï¼Œå› ä¸ºåŠ é”åï¼Œæ¯æ—¶æ¯åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä»£ç ï¼ŒæŒ‡ä»¤é‡æ’å¯¹å•çº¿ç¨‹æ²¡æœ‰å½±å“\nç¦æ­¢æŒ‡ä»¤é‡æ’çš„ç»å…¸åº”ç”¨ çœ‹ä¸‹æ‡’æ±‰æ¨¡å¼çš„å•ä¾‹çš„é—®é¢˜:\n// æ‡’æ±‰æ¨¡å¼ + synchronized åŒæ­¥é” + double-check public final class Singleton { private static Singleton instance= null;// ä¸å®ä¾‹åŒ– private Singleton(){}// æ„é€ å‡½æ•° public static Singleton getInstance(){// åŠ åŒæ­¥é”ï¼Œé€šè¿‡è¯¥å‡½æ•°å‘æ•´ä¸ªç³»ç»Ÿæä¾›å®ä¾‹ if(null == instance){// ç¬¬ä¸€æ¬¡åˆ¤æ–­ï¼Œå½“ instance ä¸º null æ—¶ï¼Œåˆ™å®ä¾‹åŒ–å¯¹è±¡ï¼Œå¦åˆ™ç›´æ¥è¿”å›å¯¹è±¡ synchronized (Singleton.class){// åŒæ­¥é” if(null == instance){// ç¬¬äºŒæ¬¡åˆ¤æ–­ instance = new Singleton();// å®ä¾‹åŒ–å¯¹è±¡ } } } return instance;// è¿”å›å·²å­˜åœ¨çš„å¯¹è±¡ } } ä¸ºäº†åœ¨å¤šçº¿ç¨‹å¹¶å‘åœºæ™¯ä¸‹å•ä¾‹ä»ç„¶æœ‰æ•ˆï¼ŒåŠ äº†é”ä»¥åŠåŒé‡æ£€æµ‹ï¼Œä½†æ˜¯å°±ä¸‡æ— ä¸€å¤±äº†å—ï¼Ÿ\nåœ¨ç¬¬ä¸€ä¸ªåˆ¤æ–­ if(null == instance) ä¸­ï¼Œä¼šå‡ºå…ˆå˜é‡instanceæœ‰å€¼ï¼Œä½†æ˜¯å†…å­˜åŒºåŸŸæ˜¯ç©ºçš„ï¼ˆæ²¡æœ‰åˆå§‹åŒ– ï¼‰ï¼Œä»è€Œå¯¼è‡´ç¨‹åºå‡ºç°é—®é¢˜ã€‚é€ æˆè¿™ä¸ªé—®é¢˜çš„åŸå› åœ¨äº instance = new Singleton()ï¼Œäº‹å®ä¸Šåˆå§‹åŒ–å¯¹è±¡æ“ä½œä¸æ˜¯åŸå­æ€§çš„ï¼Œå®ƒåŒ…å«ä¸‹é¢ä¸¤ä¸ªåŠ¨ä½œ:\nç»™å¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´ï¼Œ å†…å­˜ç©ºé—´çš„åˆå§‹åŒ– å°†å†…å­˜åœ°å€èµ‹å€¼ç»™å˜é‡ å…¶ä¸­2ï¼Œ3æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œç»è¿‡ ç¼–è¯‘å™¨æˆ–è€…cpuæŒ‡ä»¤é‡æ’åï¼Œå¯èƒ½ä¼šå¯¼è‡´ 2,3é¡ºåºå‘ç”Ÿå˜åŒ–ï¼š\nç»™å¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´ï¼Œ å°†å†…å­˜åœ°å€èµ‹å€¼ç»™å˜é‡ //æ­¤æ—¶å˜é‡å·²ç»ä¸ç­‰äº null, ä½†æ˜¯å˜é‡æŒ‡å‘çš„å†…å­˜åŒºåŸŸè¿˜æ²¡æœ‰åˆå§‹åŒ– å†…å­˜ç©ºé—´çš„åˆå§‹åŒ– å‡è®¾çº¿ç¨‹AæŒ‰ç…§ç¬¬äºŒç§é¡ºåºæ‰§è¡Œï¼Œåœ¨æ‰§è¡Œå®Œæ­¥éª¤3æ—¶ï¼Œè¿˜æ²¡æœ‰æ‰§è¡Œæ­¥éª¤2ï¼Œçº¿ç¨‹Bæ‰§è¡Œåˆ°ç¬¬ä¸€ä¸ªif(null == instance)åˆ¤æ–­ï¼Œå°±ä¼šç›´æ¥è¿”å› instanceã€‚ è¿™æ ·å¯¹äºçº¿ç¨‹Bæ¥è¯´ getInstance() æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªæ²¡æœ‰ç»è¿‡åˆå§‹åŒ–çš„å¯¹è±¡ï¼Œå¯¼è‡´ç¨‹åºå‡ºç°é—®é¢˜\nè§£å†³é—®é¢˜çš„æ–¹æ³•å¾ˆç®€å•ï¼š private volatile static Singleton instance= null; ä½¿ç”¨ volatile å…³é”®è¯ç¦æ­¢ instance å˜é‡è¢«æ‰§è¡ŒæŒ‡ä»¤é‡æ’ä¼˜åŒ–å³å¯\nåŸå­æ€§é—®é¢˜ æŒ‡çš„ä½¿ä¸€ä¸ªæ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ï¼Œå³ä½¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œä¸€æ—¦æ“ä½œå¼€å§‹å°±ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å½±å“\njava ä¸­å¯ä»¥é€šè¿‡ synchronize å’Œ lock ä¿è¯åŸå­æ€§ï¼Œå®ƒä»¬èƒ½ä¿è¯ä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ä»£ç \n","date":"2022-09-15T08:16:56Z","permalink":"https://dccmmtop.github.io/posts/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E4%B8%AD%E7%9A%84%E5%8F%AF%E8%A7%81%E6%80%A7%E5%8E%9F%E5%AD%90%E6%80%A7%E6%9C%89%E5%BA%8F%E6%80%A7%E9%97%AE%E9%A2%98/","section":"posts","tags":["java","hidden"],"title":"å¹¶å‘ç¼–ç¨‹ä¸­çš„å¯è§æ€§,åŸå­æ€§ï¼Œæœ‰åºæ€§é—®é¢˜"},{"categories":null,"contents":"jps æŸ¥çœ‹å¯åŠ¨çš„ java è¿›ç¨‹\njmap å®ä¾‹ä¸ªæ•°ä¸å†…å­˜å ç”¨ çœ‹å†…å­˜ä¿¡æ¯ï¼Œå®ä¾‹ä¸ªæ•°ä»¥åŠå ç”¨å†…å­˜å¤§å°\n[C is a char[]ï¼Œ[S is a short[]ï¼Œ[I is a int[]ï¼Œ[B is a byte[]ï¼Œ[[I is a int[][]\nå †ä¿¡æ¯ jump -heap 17680\nå¯¼å‡ºå †å†…å­˜å ç”¨ä¿¡æ¯ jmap -dump:format=b,file=./j.hprof 17680\nå¯¼å‡ºæ˜¯äºŒè¿›åˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ jdk è‡ªå¸¦çš„ jvisualvm.exe å¯¼å…¥æŸ¥çœ‹\nå†…å­˜æº¢å‡ºæ—¶å¯¼å‡º é€šå¸¸è®¾ç½®å†…å­˜æº¢å‡ºè‡ªåŠ¨å¯¼å‡º dump æ–‡ä»¶(å†…å­˜å¾ˆå¤§çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå¯¼ä¸å‡ºæ¥)\n-XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=å¯¼å‡ºè·¯å¾„ Jstack æŸ¥æ‰¾æ­»é” æœ‰å¦‚ä¸‹ç¤ºä¾‹ä¼šäº§ç”Ÿä¸€ä¸ªæ­»é”:\npackage io.dc; public class DeadLockTest { private static Object lock1 = new Object(); private static Object lock2 = new Object(); public static void main(String[] args) { new Thread(() -\u0026gt; { synchronized (lock1) { try { System.out.println(\u0026#34;thread1 begin\u0026#34;); Thread.sleep(5000); } catch (InterruptedException e) { } synchronized (lock2) { System.out.println(\u0026#34;thread1 end\u0026#34;); } } }).start(); new Thread(() -\u0026gt; { synchronized (lock2) { try { System.out.println(\u0026#34;thread2 begin\u0026#34;); Thread.sleep(5000); } catch (InterruptedException e) { } synchronized (lock1) { System.out.println(\u0026#34;thread2 end\u0026#34;); } } }).start(); System.out.println(\u0026#34;main thread end\u0026#34;); } } å¯ä»¥ä½¿ç”¨ jstack PID æŸ¥çœ‹ï¼š\nç›´æ¥å¯ä»¥å®šä½åˆ°ä»£ç çš„å¤§è‡´ä½ç½®\næ‰¾å‡ºå ç”¨ CPU æœ€é«˜çš„ java çº¿ç¨‹ä¿¡æ¯ æœ‰å¦‚ä¸‹ç¨‹åºä¼šå¯¼è‡´ cpu é£™å‡ï¼š\npublic class Math { public static final int initData = 666; public int compute() { int a = 1; int b = 2; int c = (a + b) * 10; return c; } public static void main(String[] args) { Math math = new Math(); while (true) { // å¯¼è‡´CPUé£™å‡ math.compute(); } } } åœ¨ Linux ä½¿ç”¨ top å‘½ä»¤ï¼Œå‘ç° java è¿›ç¨‹ CPU å ç”¨é«˜:\nä½¿ç”¨ top -p 105654 ï¼Œç„¶åæŒ‰ H , æŸ¥çœ‹è¿™ä¸ªè¿›ç¨‹çš„è¯¦ç»†ä¿¡æ¯:\nå¯ä»¥çœ‹åˆ°çº¿ç¨‹ 105655 å ç”¨èµ„æºæ¯”è¾ƒé«˜ï¼Œå°† 105655 è½¬æ¢æˆ 16 è¿›åˆ¶ï¼š 19cb7\næ‰§è¡Œ jstack 105654 | grep -A 10 \u0026quot;19cb7\u0026quot; æŸ¥çœ‹æ­¤çº¿ç¨‹çš„ç›¸å…³ä¿¡æ¯:\nå¯ä»¥æ‰¾åˆ°é—®é¢˜ä»£ç çš„å¤§è‡´ä½ç½®\njinfo æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„ java ç¨‹åºçš„æ‰©å±•å‚æ•°\næŸ¥çœ‹ jvm ä½¿ç”¨çš„å‚æ•° jinfo -flags 105654 æŸ¥çœ‹ java ç³»ç»Ÿå‚æ•° jinfo -sysprops 105654 jstat å¯ä»¥æŸ¥çœ‹å †å†…å­˜å„éƒ¨åˆ†ä½¿ç”¨é‡ï¼Œä»¥åŠåŠ è½½ç±»çš„æ•°é‡\nä½¿ç”¨æ–¹æ³•:\njstat [-å‘½ä»¤é€‰é¡¹] [vmid] [é—´éš”æ—¶é—´(æ¯«ç§’)] [æŸ¥è¯¢æ¬¡æ•°]\nåƒåœ¾å›æ”¶ç»Ÿè®¡ jstat -gc PID S0Cï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„å¤§å°ï¼Œå•ä½ KB S1Cï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„å¤§å° S0Uï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å° S1Uï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å° ECï¼šä¼Šç”¸å›­åŒºçš„å¤§å° EUï¼šä¼Šç”¸å›­åŒºçš„ä½¿ç”¨å¤§å° OCï¼šè€å¹´ä»£å¤§å° OUï¼šè€å¹´ä»£ä½¿ç”¨å¤§å° MCï¼šæ–¹æ³•åŒºå¤§å°(å…ƒç©ºé—´) MUï¼šæ–¹æ³•åŒºä½¿ç”¨å¤§å° CCSC: å‹ç¼©ç±»ç©ºé—´å¤§å° CCSU: å‹ç¼©ç±»ç©ºé—´ä½¿ç”¨å¤§å° YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•° YGCTï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´ï¼Œå•ä½ s FGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•° FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´ï¼Œå•ä½ s GCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´ï¼Œå•ä½ s å †å†…å­˜ç»Ÿè®¡ jstat -gccapacity PID NGCMNï¼šæ–°ç”Ÿä»£æœ€å°å®¹é‡ NGCMXï¼šæ–°ç”Ÿä»£æœ€å¤§å®¹é‡ NGCï¼šå½“å‰æ–°ç”Ÿä»£å®¹é‡ S0Cï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºå¤§å° S1Cï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„å¤§å° ECï¼šä¼Šç”¸å›­åŒºçš„å¤§å° OGCMNï¼šè€å¹´ä»£æœ€å°å®¹é‡ OGCMXï¼šè€å¹´ä»£æœ€å¤§å®¹é‡ OGCï¼šå½“å‰è€å¹´ä»£å¤§å° OC: å½“å‰è€å¹´ä»£å¤§å° MCMN: æœ€å°å…ƒæ•°æ®å®¹é‡ MCMXï¼šæœ€å¤§å…ƒæ•°æ®å®¹é‡ MCï¼šå½“å‰å…ƒæ•°æ®ç©ºé—´å¤§å° CCSMNï¼šæœ€å°å‹ç¼©ç±»ç©ºé—´å¤§å° CCSMXï¼šæœ€å¤§å‹ç¼©ç±»ç©ºé—´å¤§å° CCSCï¼šå½“å‰å‹ç¼©ç±»ç©ºé—´å¤§å° YGCï¼šå¹´è½»ä»£ gc æ¬¡æ•° FGCï¼šè€å¹´ä»£ GC æ¬¡æ•° æ–°ç”Ÿä»£åƒåœ¾å›æ”¶å™¨æƒ…å†µ jstat -gcnew PID S0Cï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„å¤§å° S1Cï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„å¤§å° S0Uï¼šç¬¬ä¸€ä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å° S1Uï¼šç¬¬äºŒä¸ªå¹¸å­˜åŒºçš„ä½¿ç”¨å¤§å° TT: å¯¹è±¡åœ¨æ–°ç”Ÿä»£å­˜æ´»çš„æ¬¡æ•° MTT: å¯¹è±¡åœ¨æ–°ç”Ÿä»£å­˜æ´»çš„æœ€å¤§æ¬¡æ•° DSS: æœŸæœ›çš„å¹¸å­˜åŒºå¤§å° ECï¼šä¼Šç”¸å›­åŒºçš„å¤§å° EUï¼šä¼Šç”¸å›­åŒºçš„ä½¿ç”¨å¤§å° YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•° YGCTï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´ æ–°ç”Ÿä»£å†…å­˜ç»Ÿè®¡ jstat -gcnewcapacity PID NGCMNï¼šæ–°ç”Ÿä»£æœ€å°å®¹é‡ NGCMXï¼šæ–°ç”Ÿä»£æœ€å¤§å®¹é‡ NGCï¼šå½“å‰æ–°ç”Ÿä»£å®¹é‡ S0CMXï¼šæœ€å¤§å¹¸å­˜ 1 åŒºå¤§å° S0Cï¼šå½“å‰å¹¸å­˜ 1 åŒºå¤§å° S1CMXï¼šæœ€å¤§å¹¸å­˜ 2 åŒºå¤§å° S1Cï¼šå½“å‰å¹¸å­˜ 2 åŒºå¤§å° ECMXï¼šæœ€å¤§ä¼Šç”¸å›­åŒºå¤§å° ECï¼šå½“å‰ä¼Šç”¸å›­åŒºå¤§å° YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•° FGCï¼šè€å¹´ä»£å›æ”¶æ¬¡æ•° è€å¹´ä»£åƒåœ¾ç»Ÿè®¡ jstat -gcold PID MCï¼šæ–¹æ³•åŒºå¤§å° MUï¼šæ–¹æ³•åŒºä½¿ç”¨å¤§å° CCSC: å‹ç¼©ç±»ç©ºé—´å¤§å° CCSU: å‹ç¼©ç±»ç©ºé—´ä½¿ç”¨å¤§å° OCï¼šè€å¹´ä»£å¤§å° OUï¼šè€å¹´ä»£ä½¿ç”¨å¤§å° YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•° FGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•° FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´ GCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´ è€å¹´ä»£å †å†…å­˜ç»Ÿè®¡ jstat -gcoldcapacity PID OGCMNï¼šè€å¹´ä»£æœ€å°å®¹é‡ OGCMXï¼šè€å¹´ä»£æœ€å¤§å®¹é‡ OGCï¼šå½“å‰è€å¹´ä»£å¤§å° OCï¼šè€å¹´ä»£å¤§å° YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•° FGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•° FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´ GCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´ å…ƒç©ºé—´ç»Ÿè®¡ jstat -gcmetacapacity PID MCMN: æœ€å°å…ƒæ•°æ®å®¹é‡ MCMXï¼šæœ€å¤§å…ƒæ•°æ®å®¹é‡ MCï¼šå½“å‰å…ƒæ•°æ®ç©ºé—´å¤§å° CCSMNï¼šæœ€å°å‹ç¼©ç±»ç©ºé—´å¤§å° CCSMXï¼šæœ€å¤§å‹ç¼©ç±»ç©ºé—´å¤§å° CCSCï¼šå½“å‰å‹ç¼©ç±»ç©ºé—´å¤§å° YGCï¼šå¹´è½»ä»£åƒåœ¾å›æ”¶æ¬¡æ•° FGCï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¬¡æ•° FGCTï¼šè€å¹´ä»£åƒåœ¾å›æ”¶æ¶ˆè€—æ—¶é—´ GCTï¼šåƒåœ¾å›æ”¶æ¶ˆè€—æ€»æ—¶é—´ jstat -gcutil PID JVM è¿è¡Œæƒ…å†µé¢„ä¼° çŸ¥é“äº†å¦‚ä½•ç»Ÿè®¡ jvm è¿è¡Œçš„ä¿¡æ¯ï¼Œå°±å¯ä»¥æ ¹æ®ç°æœ‰çš„ä¿¡æ¯é¢„ä¼°ä»¥åç¨‹åºå ç”¨èµ„æºçš„èµ°å‘ï¼Œä»è€Œè°ƒæ•´åˆç†çš„ jvm å‚æ•°ï¼Œæ¯”å¦‚ï¼š å †å†…å­˜å¤§å°ï¼Œå¹´è½»ä»£ï¼Œè€å¹´ä»£å¤§å°ï¼Œ Eden å’Œ Survivor çš„æ¯”ä¾‹ï¼Œå¤§å¯¹è±¡çš„é˜€å€¼ï¼Œè¿›å…¥è€å¹´ä»£å¹´é¾„çš„é˜€å€¼ç­‰\nå¹´è½»ä»£å¯¹è±¡å¢é•¿é€Ÿç‡ å¯ä»¥æ‰§è¡Œ jstat -gc PID 1000 20 è§‚å¯Ÿ EU åŒºä¼°ç®—æ¯ç§’æ–°å¢å¤šå°‘å¯¹è±¡ï¼Œä¸€èˆ¬ç³»ç»Ÿåˆé«˜å³°æœŸå’Œéé«˜å³°æœŸï¼Œéœ€è¦åœ¨ä¸åŒæ—¶é—´æ®µåˆ†åˆ«ç»Ÿè®¡\nYoung GC è§¦å‘é¢‘ç‡å’Œæ¯æ¬¡è€—æ—¶ çŸ¥é“å¹´è½»ä»£å¯¹è±¡çš„å¢é•¿é€Ÿç‡ï¼Œå¯ä»¥é¢„ä¼° Young GC å¤šä¹…è§¦å‘ä¸€æ¬¡ï¼ŒYoung GC çš„å¹³å‡è€—æ—¶å¯ä»¥ YGCT / YGC ç®—å‡ºï¼Œè¿™ä¸¤ä¸ªç»“æœå¯ä»¥çŸ¥é“ç³»ç»Ÿå¤§æ¦‚å¤šä¹…ç³»ç»Ÿä¼šå› ä¸º Young GC å¡é¡¿å¤šä¹…\nYoung GC åï¼Œå­˜æ´»çš„å¯¹è±¡å’Œè¿›å…¥è€å¹´ä»£å¯¹è±¡çš„æ•°é‡ æ¯æ¬¡ GC åï¼ŒEden åŒºä¼šå¤§å¹…åº¦å‡å°‘ï¼Œsurvivor å’Œè€å¹´ä»£éƒ½ä¼šæœ‰å¢é•¿ï¼Œè¿™äº›å¢é•¿çš„å¯¹è±¡å°±æ˜¯ Young GC åå­˜æ´»çš„å¯¹è±¡ï¼ŒåŒæ—¶è¿˜å¯ä»¥çœ‹å‡ºæ¯æ¬¡è¿›å…¥è€å¹´ä»£çš„å¯¹è±¡ï¼Œè¿™å°±æ˜¯è€å¹´ä»£å¯¹è±¡çš„å¢é•¿é€Ÿç‡\nFull GC çš„è§¦å‘é¢‘ç‡å’Œå¹³å‡è€—æ—¶ çŸ¥é“äº†è€å¹´ä»£çš„å¢é•¿é€Ÿç‡ï¼Œå°±å¯ä»¥ä¼°ç®—å‡º Full GC çš„è§¦å‘é¢‘ç‡äº†ï¼Œæ¯æ¬¡è€—æ—¶å¯ä»¥é€šè¿‡ FGCT / FGC ç®—å‡º\nä¼˜åŒ–æ€è·¯ å°½é‡è®©æ¯æ¬¡ Young GC ä¹‹åçš„å­˜æ´»å¯¹è±¡å°äº Survivor åŒºåŸŸçš„ 50%ï¼Œå°½é‡åˆ«è®©å¯¹è±¡è¿›å…¥è€å¹´ä»£ï¼Œå°½é‡å‡å°‘ Full GC çš„é¢‘ç‡ï¼Œé¿å…é¢‘ç¹ Full GC å † jvm æ€§èƒ½çš„å½±å“\nä¸€ç§è§£å†³é¢‘ç¹ Full GC çš„æ€è·¯ ä¸€èˆ¬æ˜¯é¢‘ç¹åˆ›å»ºå¤§å¯¹è±¡ï¼Œå¯¼è‡´è€å¹´ä»£çš„å ç”¨æé€Ÿå¢åŠ ï¼Œè¿™éƒ¨åˆ†ä»£ç å¯èƒ½å ç”¨ CPU æ¯”è¾ƒé«˜ã€‚\nå¯ä»¥é€šè¿‡ jmap æ‰¾åˆ°å®ä¾‹æ•°é‡é å‰çš„å¯¹è±¡ï¼Œåœ¨ä»£ç ä¸­æœç´¢æ–°å»ºè¿™ä¸ªå¯¹è±¡çš„ä½ç½® é€šè¿‡ä¸Šé¢è¯´çš„ top + jstack çš„æ–¹å¼æ‰¾åˆ°å ç”¨ CPU èµ„æºæ¯”è¾ƒå¤šçš„çº¿ç¨‹ï¼Œå†å®šä½å…·ä½“ä½ç½® å†…å­˜æ³„æ¼çš„æ¡ˆä¾‹ ä¸€èˆ¬ç”µå•†æ¶æ„å¯èƒ½ä¼šä½¿ç”¨å¤šçº§ç¼“å­˜æ¶æ„ï¼Œå°±æ˜¯redisåŠ ä¸ŠJVMçº§ç¼“å­˜ï¼Œå¤§å¤šæ•°åŒå­¦å¯èƒ½ä¸ºäº†å›¾æ–¹ä¾¿å¯¹äºJVMçº§ç¼“å­˜å°± ç®€å•ä½¿ç”¨ä¸€ä¸ªhashmapï¼Œäºæ˜¯ä¸æ–­å¾€é‡Œé¢æ”¾ç¼“å­˜æ•°æ®ï¼Œä½†æ˜¯å¾ˆå°‘è€ƒè™‘è¿™ä¸ªmapçš„å®¹é‡é—®é¢˜ï¼Œç»“æœè¿™ä¸ªç¼“å­˜mapè¶Šæ¥è¶Šå¤§ï¼Œä¸€ç›´å ç”¨ç€è€ å¹´ä»£çš„å¾ˆå¤šç©ºé—´ï¼Œæ—¶é—´é•¿äº†å°±ä¼šå¯¼è‡´full gcéå¸¸é¢‘ç¹ï¼Œè¿™å°±æ˜¯ä¸€ç§å†…å­˜æ³„æ¼ï¼Œå¯¹äºä¸€äº›è€æ—§æ•°æ®æ²¡æœ‰åŠæ—¶æ¸…ç†å¯¼è‡´ä¸€ç›´å ç”¨ç€å®è´µçš„å†…å­˜ èµ„æºï¼Œæ—¶é—´é•¿äº†é™¤äº†å¯¼è‡´full gcï¼Œè¿˜æœ‰å¯èƒ½å¯¼è‡´OOMã€‚ è¿™ç§æƒ…å†µå®Œå…¨å¯ä»¥è€ƒè™‘é‡‡ç”¨ä¸€äº›æˆç†Ÿçš„JVMçº§ç¼“å­˜æ¡†æ¶æ¥è§£å†³ï¼Œæ¯”å¦‚ehcacheç­‰è‡ªå¸¦ä¸€äº›LRUæ•°æ®æ·˜æ±°ç®—æ³•çš„æ¡†æ¶æ¥ä½œä¸ºJVMçº§çš„ç¼“å­˜\né«˜çº§å·¥å…· Arthas Arthas æ˜¯ Alibaba åœ¨ 2018 å¹´ 9 æœˆå¼€æºçš„ Java è¯Šæ–­å·¥å…·ã€‚æ”¯æŒ JDK6+ï¼Œ é‡‡ç”¨å‘½ä»¤è¡Œäº¤äº’æ¨¡å¼ï¼Œå¯ä»¥æ–¹ä¾¿çš„å®šä½å’Œè¯Šæ–­ çº¿ä¸Šç¨‹åºè¿è¡Œé—®é¢˜ã€‚Arthas å®˜æ–¹æ–‡æ¡£ååˆ†è¯¦ç»† https://arthas.aliyun.com/doc/manual-install.html?userCode=okjhlpr5\n","date":"2022-09-12T15:50:03Z","permalink":"https://dccmmtop.github.io/posts/jvm%E8%B0%83%E4%BC%98%E5%B7%A5%E5%85%B7/","section":"posts","tags":["java"],"title":"JVMè°ƒä¼˜å·¥å…·"},{"categories":null,"contents":"G1 (Garbage-First) æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡å™¨çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä¸»è¦é’ˆå¯¹å¤šé¢—å¤„ç†å™¨åŠå¤§å®¹é‡å†…å­˜çš„æœºå™¨ï¼Œå…·å¤‡æçŸ­çš„ GC åœé¡¿æ—¶é—´å’Œé«˜ååé‡çš„ç‰¹å¾.\nG1 å †å†…å­˜åˆ’åˆ† G1 ä¸åƒ CMS é‚£æ ·ï¼Œè€å¹´ä»£å’Œå¹´è½»ä»£ä¸å†æœ‰æ˜æ˜¾çš„åŒºåˆ†ã€‚è€Œæ˜¯å°†å†…å­˜åˆ†ä¸ºå¾ˆå¤šå’ŒåŒºåŸŸï¼ˆRegionï¼‰ï¼ŒJVM æœ€å¤šå¯ä»¥æœ‰ 2048 ä¸ªåŒºåŸŸï¼Œä¸€èˆ¬ä¸€ä¸ªåŒºåŸŸçš„å¤§å°ç­‰äºå †å¤§å° / 2048 ï¼Œæ¯”å¦‚å †çš„å¤§å°æ˜¯ 4096ï¼Œé‚£ä¹ˆä¸€å—åŒºåŸŸçš„å¤§å°æœ‰ 2M, ä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®š:-XX:G1HeapRegionSize, ä½†æ˜¯æ¨èé»˜è®¤æ¨¡å¼\nG1 ä¸­çš„å¹´è½»ä»£å’Œè€å¹´ä»£ G1 ä¿ç•™äº†å¹´è½»ä»£å’Œè€å¹´ä»£çš„æ¦‚å¿µï¼Œä½†æ˜¯ä¸å†æœ‰ç‰©ç†ä¸Šçš„éš”é˜‚äº†ï¼Œä»–ä»¬éƒ½æ˜¯ Region ç»„æˆï¼Œå¯ä»¥ä¸è¿ç»­ã€‚\nå¹´è½»ä»£å æ¯” é»˜è®¤å¹´è½»ä»£å å †çš„ 5%ï¼Œå¯ä»¥é€šè¿‡å‚æ•° -XX:G1NewSizePercent è®¾ç½®å¹´è½»ä»£çš„åˆå§‹å æ¯”ï¼Œåœ¨ç³»ç»Ÿè¿è¡Œä¸­ä¼šä¸æ–­çš„å¢åŠ å¹´è½»ä»£çš„ Regionï¼Œä½†æ˜¯æœ€å¤šå¹´è½»ä»£çš„å æ¯”ä¸ä¼šè¶…è¿‡ 60%ï¼Œè¿™ä¸ªæœ€å¤§å€¼å¯ä»¥é€šè¿‡å‚æ•°è®¾ç½®ï¼š -XX:G1MaxNewSizePercent\nå¹´è½»ä»£ä¸­çš„ Eden å’Œ Survivor çš„æ¯”ä¾‹ä¹Ÿæ˜¯ 8 :1: 1 , ä¸€ä¸ª Region ä¹‹å‰æ˜¯å¹´è½»ä»£ï¼Œç»è¿‡åƒåœ¾å›æ”¶åå¯èƒ½å˜æˆè€å¹´ä»£ï¼Œä¹Ÿå°±æ˜¯è¯´ Region åŒºåŸŸåŠŸèƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„\nå¤§å¯¹è±¡åŒºåŸŸ G1 æ”¶é›†å™¨ä¸­å¯¹è±¡ä»€ä¹ˆæ—¶å€™ä¼šè½¬ç§»åˆ°è€å¹´ä»£ï¼Œå’Œä¹‹å‰ CMS, Parallel ä¸€æ ·ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ï¼ŒG1 è®¾ç½®äº†ä¸“é—¨å­˜æ”¾å¤§å¯¹è±¡çš„åŒºåŸŸ: Humongous, è€Œä¸æ˜¯è®©å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚\nåœ¨ G1 ä¸­ï¼Œå½“å¯¹è±¡è¶…è¿‡ä¸€ä¸ª Region çš„ 50% ï¼Œå°±ä¼šåˆ¤å®šä¸ºå¤§å¯¹è±¡ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡å¤ªå¤§ï¼Œä¼šè¿ç»­ä½¿ç”¨å¤šä¸ªåŒºåŸŸå­˜æ”¾ã€‚\nHumongous ä¸“é—¨å­˜æ”¾çŸ­æœŸçš„å¤§å¯¹è±¡ï¼Œä¸ç”¨ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼ŒèŠ‚çœäº†è€å¹´ä»£çš„ç©ºé—´ï¼Œé™ä½äº† GC æ¬¡æ•°ã€‚\nFull GC çš„æ—¶å€™ï¼Œè€å¹´ä»£ï¼Œå¹´è½»ä»£ï¼Œ Humongous ä¼šä¸€å¹¶æ¸…ç†\nG1 è¿è¡Œè¿‡ç¨‹ åˆå§‹æ ‡è®° (Initial Markï¼Œ STW) æš‚åœç”¨æˆ·æ‰€æœ‰çº¿ç¨‹ï¼Œå¹¶æ ‡è®° GC Root æ‰€æœ‰ç›´æ¥å¼•ç”¨çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿«\nå¹¶å‘æ ‡è®° (Concurrent Mark) åŒ CMS çš„å¹¶å‘æ ‡è®°\næœ€ç»ˆæ ‡è®° (Remark, STW) åŒ CMS çš„é‡æ–°æ ‡è®°\nç­›é€‰å›æ”¶ (cleanup, STW) ä¸ä¼šå›æ”¶æ‰€æœ‰çš„è¢«æ ‡è®°çš„ Region, å…ˆå¯¹å„ä¸ª Region å›æ”¶çš„ä»·å€¼å’Œæˆæœ¬è¿›è¡Œæ’åºï¼Œæ ¹æ®ç”¨æˆ·æœŸæœ›çš„ GC åœé¡¿æ—¶é—´æ¥åˆ¶å®šå›æ”¶è®¡åˆ’ã€‚å¯ä»¥é€šè¿‡å‚æ•° -XX:MaxGCPauseMillis å¯ä»¥æŒ‡å®š GC åœé¡¿æ—¶é—´\nå› ä¸º G1 é€šå¸¸è¿è¡Œåœ¨å†…å­˜æ¯”è¾ƒå¤§çš„æœºå™¨ä¸Šï¼Œå¦‚æœå¯¹æ‰€æœ‰è¢«æ ‡è®°çš„ç©ºé—´éƒ½è¿›è¡Œå›æ”¶ï¼ŒåŠ¿å¿…ä¼šèŠ±è´¹å¾ˆå¤šæ—¶é—´ï¼Œæ‰€ä»¥ä»…ä»…å›æ”¶éƒ¨åˆ†åŒºåŸŸï¼Œæ»¡è¶³ç”¨æˆ·å¯¹ GC åœé¡¿æ—¶é—´çš„è¦æ±‚ã€‚\nå›æ”¶ç®—æ³•ä¸»è¦ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œå°†ä¸€ä¸ª Region ä¸­å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦ä¸€ä¸ª Region ä¸­ï¼Œä¸ä¼šåƒ CMS é‚£æ ·å›æ”¶å®Œè¿˜æœ‰å¾ˆå¤šå†…å­˜ç¢ç‰‡è¿›è¡Œæ•´ç†ï¼ŒG1 é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œå‡ ä¹ä¸ä¼šæœ‰å¤ªå¤šçš„ç¢ç‰‡ã€‚\nå•çº¿ç¨‹å›æ”¶\nCMS åœ¨å›æ”¶é˜¶æ®µæ˜¯å¯ä»¥å’Œç”¨æˆ·çº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œä½†æ˜¯ G1 å†…éƒ¨å®ç°å¤ªå¤æ‚ï¼Œæš‚æ—¶æ²¡æœ‰å®ç°å¹¶å‘å›æ”¶ï¼Œåˆ°äº† Shenandoah å®ç°äº†å¹¶å‘æ”¶é›†ï¼Œå¯ä»¥çœ‹åšæ˜¯ G1 çš„å‡çº§ç‰ˆæœ¬\né€‰æ‹©å“ªäº›åŒºåŸŸå›æ”¶ï¼Ÿ\nG1 å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªä¼˜å…ˆçº§åˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®å…è®¸çš„æ”¶é›†æ—¶é—´ï¼Œä¼˜å…ˆé€‰æ‹©å›æ”¶ä»·å€¼æœ€å¤§çš„ Region, è¿™ä¹Ÿæ˜¯å®ƒåå­—çš„ç”±æ¥ Garbage First , æ¯”å¦‚ä¸€ä¸ª Region å›æ”¶éœ€è¦èŠ±è´¹ 200ms, èƒ½é‡Šæ”¾ 10M çš„ç©ºé—´ï¼Œå›æ”¶å¦ä¸€ä¸ª Region éœ€è¦èŠ±è´¹ 50ms, èƒ½é‡Šæ”¾ 20M ç©ºé—´ï¼ŒG1 ä¼šä¼˜å…ˆå›æ”¶åé¢çš„ Region\nç¤ºæ„å›¾\nG1 é‡è¦çš„ç‰¹å¾ å¹¶è¡Œä¸å¹¶å‘ G1 èƒ½å……åˆ†åˆ©ç”¨ CPUã€å¤šæ ¸ç¯å¢ƒä¸‹çš„ç¡¬ä»¶ä¼˜åŠ¿ï¼Œä½¿ç”¨å¤šä¸ª CPUï¼ˆCPU æˆ–è€… CPU æ ¸å¿ƒï¼‰æ¥ç¼©çŸ­ StopThe-World åœé¡¿æ—¶é—´ã€‚éƒ¨åˆ†å…¶ä»–æ”¶é›†å™¨åŸæœ¬éœ€è¦åœé¡¿ Java çº¿ç¨‹æ¥æ‰§è¡Œ GC åŠ¨ä½œï¼ŒG1 æ”¶é›†å™¨ä»ç„¶å¯ä»¥é€šè¿‡å¹¶å‘çš„æ–¹å¼è®© java ç¨‹åºç»§ç»­æ‰§è¡Œã€‚\nåˆ†ä»£æ”¶é›† è™½ç„¶ G1 ä¸éœ€è¦ä¸å…¶å®ƒæ”¶é›†å™¨é…åˆä½¿ç”¨å°±èƒ½ç‹¬è‡ªç®¡ç†æ•´ä¸ªå †ï¼Œä½†è¿˜æ˜¯ä¿ç•™äº†åˆ†ä»£çš„æ¦‚å¿µã€‚\nç©ºé—´æ•´åˆ ä¸ CMS çš„ â€œæ ‡è®°-æ¸…ç†â€ ä¸åŒï¼ŒG1 ä»æ•´ä½“ä¸Šçœ‹ï¼Œé‡‡ç”¨äº†æ ‡è®°-æ•´ç†ç®—æ³•ï¼Œå±€éƒ¨ä½¿ç”¨äº†æ ‡è®°-å¤åˆ¶ç®—æ³•\nå¯é¢„æµ‹çš„åœé¡¿ è¿™æ˜¯ G1 ä¸ CMS å¦å¤–ä¸€ä¸ªå¤§ä¼˜åŠ¿ï¼Œ CMS å’Œ G1 éƒ½ç‰¹åˆ«é‡è§†é™ä½åœé¡¿æ—¶é—´ï¼Œä½†æ˜¯ G1 é™¤äº†è¿½æ±‚é™ä½åœé¡¿æ—¶é—´å¤–ï¼Œè¿˜å¯ä»¥è®©ç”¨æˆ·æŒ‡å®šåœé¡¿æ—¶é—´ï¼Œåœ¨æŒ‡å®šæ—¶é—´å†…å®Œæˆåƒåœ¾æ”¶é›†ï¼š -XX:MaxGCPauseMillis\nè¿™ä½¿å¾— G1 åœ¨ä¸åŒçš„åœºæ™¯ä¸­å¯ä»¥è·å¾—æœ€ä½³çš„åœé¡¿æ—¶é—´å’Œååé‡ã€‚è¿™ä¸ªæœ€ä½³å€¼å¿…é¡»æ˜¯åˆç†çš„ï¼Œä¸èƒ½æ— é™ä½ï¼Œå¦åˆ™æ¯æ¬¡åƒåœ¾å›æ”¶çš„ç©ºé—´å¾ˆå°ï¼Œå›æ”¶çš„é€Ÿåº¦è¿½èµ¶ä¸ä¸Šåƒåœ¾ç”Ÿæˆçš„é€Ÿåº¦ï¼Œæœ€ç»ˆä¹Ÿä¼šé¢‘ç¹ FullGC åè€Œé™ä½æ€§èƒ½ï¼Œé€šå¸¸æŠŠ GC æ—¶é—´è®¾ç½®ä¸º 200~300 ms æ˜¯æ¯”è¾ƒåˆç†çš„\nG1 åƒåœ¾æ”¶é›†åˆ†ç±» YoungGC ä¸æ˜¯è¯´ç°æœ‰çš„ Eden åŒºåŸŸæ”¾æ»¡ä¹‹åä¼šé©¬ä¸Šè§¦å‘ YoungGC , G1 ä¼šè®¡ç®—å›æ”¶ç°åœ¨çš„ Eden åŒºåŸŸéœ€è¦èŠ±è´¹å¤šå°‘æ—¶é—´ï¼Œå¦‚æœè¿™ä¸ªå›æ”¶æ—¶é—´è¿œè¿œå°äº MaxGCPauseMillis å€¼ï¼Œé‚£ä¹ˆå°±ä¼šå¢åŠ å¹´è½»ä»£çš„ Region, ç»§ç»­å­˜æ”¾å¯¹è±¡ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡é¢„ä¼°çš„å›æ”¶æ—¶é—´æ¥è¿‘ MaxGCPauseMillis , æ‰ä¼šè§¦å‘ Young GC\nMixedGC ä¸æ˜¯ Full GC\nä¸æ˜¯ Full GC\nä¸æ˜¯ Full GC\nè€å¹´ä»£å æœ‰ç‡è¾¾åˆ°è®¾å®šå€¼çš„æ—¶å€™ä¼šè§¦å‘ï¼Œå›æ”¶æ‰€æœ‰çš„ Young å’Œéƒ¨åˆ† Oldï¼ˆæ ¹æ®æŒ‡å®šçš„ GC åœé¡¿æ—¶é—´å’Œå›æ”¶ä¼˜å…ˆçº§è¿›è¡Œé€‰æ‹©ï¼‰ï¼Œä¸€èˆ¬ä¼šå…ˆè§¦å‘ Mixed GC, åœ¨ GC è¿‡ç¨‹ä¸­ï¼ŒæŠŠå„ä¸ª Region å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°åˆ«çš„ Region ä¸­ï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ Region å­˜æ”¾å¯¹è±¡ï¼Œå°±ä¼šè§¦å‘ Full GC\nFull GC è¿™ä¸ªè¿‡ç¨‹ä¼šæš‚åœç”¨æˆ·ç¨‹åºï¼Œä½¿ç”¨å•çº¿ç¨‹è¿›è¡Œæ ‡è®°ï¼Œæ¸…ç†ï¼Œå‹ç¼©æ•´ç†ï¼Œä»¥ä¾¿ç©ºé—²å‡ºä¸€æ‰¹ Region ä¾›ä¸‹ä¸€æ¬¡ MixedGC ä½¿ç”¨ï¼Œè¿™ä¸ªè¿‡ç¨‹éå¸¸è€—æ—¶ï¼Œåœ¨ Shenandoah æ—¶ä¼˜åŒ–ä¸ºå¤šçº¿ç¨‹æ”¶é›†äº†\nG1 åƒåœ¾æ”¶é›†å™¨å‚æ•°è®¾ç½® -XX:+UseG1GC ä½¿ç”¨ G1 -XX:ParallelGCthreads GC å·¥ä½œçš„çº¿ç¨‹æ•°é‡ -XX:G1HeapRegionSize æŒ‡å®šåˆ†åŒºå¤§å° (1MB ~ 32 MB), å¿…é¡»æ˜¯ 2 çš„ N æ¬¡å¹‚ï¼Œé»˜è®¤å°†å †åˆ’åˆ†ä¸º 2048 ä¸ªåŒºåŸŸ -XX:MaxGCPauseMillis æŒ‡å®š GC æš‚åœæ—¶é—´ï¼Œé»˜è®¤æ—¶ 200ms -XX:G1NewSizePercent æ–°ç”Ÿä»£åˆå§‹ç©ºé—´ï¼Œé»˜è®¤ 5% -XX:G1MaxNewSizePercent æ–°ç”Ÿä»£æœ€å¤§ç©ºé—´ï¼Œ -XX:TargetSurvivorRatio Survivor åŒºå¡«å……å®¹é‡ï¼Œé»˜è®¤æ—¶ 50%ï¼Œ Survivor åŒºåŸŸä¸­çš„ä¸€æ‰¹å¯¹è±¡ï¼ˆå¹´é¾„ 1+å¹´é¾„ 2+å¹´é¾„ n çš„å¤šä¸ªå¹´é¾„å¯¹è±¡) æ€»å’Œè¶…è¿‡äº† Survivor åŒºåŸŸçš„ 50%ï¼Œæ­¤æ—¶å°±ä¼šæŠŠå¹´é¾„ n (å«) ä»¥ä¸Šçš„å¯¹è±¡éƒ½æ”¾å…¥è€å¹´ä»£ -XX:MaxTenuringThreshold æœ€å¤§å¹´é¾„é˜€å€¼ï¼Œé»˜è®¤ 15 -XX:InitiatingHeapOccupancyPercent è€å¹´ä»£å ç”¨ç©ºé—´è¾¾åˆ°é˜€å€¼æ—¶ (é»˜è®¤ 45%)ï¼Œåˆ™æ‰§è¡Œè€å¹´ä»£å’Œæ–°ç”Ÿä»£çš„æ··åˆæ”¶é›†ï¼ˆMixedGCï¼‰, æ¯”å¦‚æˆ‘ä»¬ä¹‹å‰è¯´çš„å †é»˜è®¤æœ‰ 2048 ä¸ª regionï¼Œå¦‚æœæœ‰æ¥è¿‘ 1000 ä¸ª region éƒ½æ˜¯è€å¹´ä»£çš„ regionï¼Œåˆ™å¯èƒ½å°±è¦è§¦å‘ MixedGC äº† -XX:G1MixedGCLiveThreasholdPercent region ä¸­å­˜æ´»å¯¹è±¡ç©ºé—´å æ¯”ä½äºè¿™ä¸ªå€¼ï¼ˆé»˜è®¤ 85%ï¼‰ï¼Œæ‰ä¼šå›æ”¶è¯¥ Region, å¦‚æœè¶…è¿‡è¿™ä¸ªæ¯”ä¾‹ï¼Œè¯´æ˜è¿™ä¸ª Region ä¸­å­˜æ´»çš„å¯¹è±¡è¿‡å¤šï¼Œå›æ”¶æ„ä¹‰ä¸å¤§ -XX:G1MixedGCCountTarget æŒ‡å®šåœ¨ä¸€æ¬¡å›æ”¶è¿‡ç¨‹ä¸­ï¼Œåšå‡ æ¬¡ç­›é€‰å›æ”¶ï¼ˆé»˜è®¤ 8 æ¬¡ï¼‰ï¼Œåœ¨æœ€åä¸€ä¸ªç­›é€‰å›æ”¶é˜¶æ®µï¼Œå¯ä»¥æš‚åœä¸€ä¼šå†å›æ”¶ï¼Œä¸è‡³äºå•æ¬¡åœé¡¿æ—¶é—´è¿‡é•¿ -XX:G1HeapWastePercent é»˜è®¤ 5%ï¼Œ GC è¿‡ç¨‹ä¸­ç©ºå‡ºæ¥çš„ Region æ˜¯å¦å……è¶³é˜€å€¼ï¼Œåœ¨æ··åˆå›æ”¶çš„æ—¶å€™ï¼Œæ˜¯åŸºäºå¤åˆ¶ç®—æ³•çš„ï¼Œéœ€è¦æŠŠè¦å›æ”¶çš„ Region ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°å…¶ä»–çš„ Region ä¸­ï¼Œç„¶åæŠŠè¿™ä¸ª Region æ¸…ç©ºï¼Œè¿™æ ·åœ¨ GC è¿‡ç¨‹ä¸­å°±ä¸æ–­æœ‰æ–°çš„ Region ç©ºé—²å‡ºæ¥ï¼Œä¸€æ—¦ç©ºé—²çš„æ•°é‡å å †æ€»å†…å­˜çš„ 5%æ—¶ï¼Œå°±ä¼šç»ˆæ­¢ MixedGC G1 æ”¶é›†å™¨ä¼˜åŒ–å»ºè®® å‡è®¾å‚æ•° -XX:MaxGCPauseMills è®¾ç½®çš„å€¼å¾ˆå¤§ï¼Œå¯¼è‡´ç³»ç»Ÿè¿è¡Œå¾ˆä¹…ï¼Œå¹´è½»ä»£å¯èƒ½éƒ½å ç”¨äº†å †å†…å­˜çš„ 60%äº†ï¼Œæ­¤æ—¶æ‰è§¦å‘å¹´è½»ä»£ gcã€‚é‚£ä¹ˆå­˜æ´»ä¸‹æ¥çš„å¯¹è±¡å¯èƒ½å°±ä¼šå¾ˆå¤šï¼Œæ­¤æ—¶å°±ä¼šå¯¼è‡´ Survivor åŒºåŸŸæ”¾ä¸ä¸‹é‚£ä¹ˆå¤šçš„å¯¹è±¡ï¼Œå°±ä¼šè¿›å…¥è€å¹´ä»£ä¸­ã€‚\næˆ–è€…æ˜¯ä½ å¹´è½»ä»£ gc è¿‡åï¼Œå­˜æ´»ä¸‹æ¥çš„å¯¹è±¡è¿‡å¤šï¼Œå¯¼è‡´è¿›å…¥ Survivor åŒºåŸŸåè§¦å‘äº†åŠ¨æ€å¹´é¾„åˆ¤å®šè§„åˆ™ï¼Œè¾¾åˆ°äº† Survivor åŒºåŸŸçš„ 50%ï¼Œä¹Ÿä¼šå¿«é€Ÿå¯¼è‡´ä¸€äº›å¯¹è±¡è¿›å…¥è€å¹´ä»£ä¸­ã€‚\næ‰€ä»¥è¿™é‡Œæ ¸å¿ƒè¿˜æ˜¯åœ¨äºè°ƒèŠ‚ -XX:MaxGCPauseMills è¿™ä¸ªå‚æ•°çš„å€¼ï¼Œåœ¨ä¿è¯ä»–çš„å¹´è½»ä»£ gc åˆ«å¤ªé¢‘ç¹çš„åŒæ—¶ï¼Œè¿˜å¾—è€ƒè™‘æ¯æ¬¡ gc è¿‡åçš„å­˜æ´»å¯¹è±¡æœ‰å¤šå°‘, é¿å…å­˜æ´»å¯¹è±¡å¤ªå¤šå¿«é€Ÿè¿›å…¥è€å¹´ä»£ï¼Œé¢‘ç¹è§¦å‘ mixed gc\né€‚åˆä½¿ç”¨ G1 çš„åœºæ™¯ 50% ä»¥ä¸Šçš„å†…å­˜è¢«å­˜æ´»å¯¹è±¡ä½¿ç”¨ å¯¹è±¡åˆ†é…å’Œæ™‹å‡å˜åŒ–éå¸¸å¤§ åƒåœ¾å›æ”¶æ—¶é—´ç‰¹åˆ«é•¿ï¼Œè¶…è¿‡ 1 ç§’ 8G ä»¥ä¸Šçš„å†…å­˜ï¼Œç»éªŒå€¼ æœŸæœ›åœé¡¿æ—¶é—´åœ¨ 500ms ä»¥å†… æ¯ç§’å‡ åä¸‡å¹¶å‘çš„ç³»ç»Ÿå¦‚ä½•ä¼˜åŒ– JVM Kafka ç±»ä¼¼çš„æ”¯æ’‘é«˜å¹¶å‘æ¶ˆæ¯ç³»ç»Ÿå¤§å®¶è‚¯å®šä¸é™Œç”Ÿï¼Œå¯¹äº kafka æ¥è¯´ï¼Œæ¯ç§’å¤„ç†å‡ ä¸‡ç”šè‡³å‡ åä¸‡æ¶ˆæ¯æ—¶å¾ˆæ­£å¸¸çš„ï¼Œä¸€èˆ¬æ¥è¯´éƒ¨ç½² kafka éœ€è¦ç”¨å¤§å†…å­˜æœºå™¨ (æ¯”å¦‚ 64G)ï¼Œä¹Ÿå°±æ˜¯è¯´å¯ä»¥ç»™å¹´è½»ä»£åˆ†é…ä¸ªä¸‰å››å G çš„å†…å­˜ç”¨æ¥æ”¯æ’‘é«˜å¹¶å‘å¤„ç†ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°ä¸€ä¸ªé—®é¢˜äº†ï¼Œæˆ‘ä»¬ä»¥å‰å¸¸è¯´çš„å¯¹äº eden åŒºçš„ younggc æ˜¯å¾ˆå¿«çš„ï¼Œè¿™ç§æƒ…å†µä¸‹å®ƒçš„æ‰§è¡Œè¿˜ä¼šå¾ˆå¿«å—ï¼Ÿå¾ˆæ˜¾ç„¶ï¼Œä¸å¯èƒ½ï¼Œå› ä¸ºå†…å­˜å¤ªå¤§ï¼Œå¤„ç†è¿˜æ˜¯è¦èŠ±ä¸å°‘æ—¶é—´çš„ï¼Œå‡è®¾ä¸‰å››å G å†…å­˜å›æ”¶å¯èƒ½æœ€å¿«ä¹Ÿè¦å‡ ç§’é’Ÿï¼ŒæŒ‰ kafka è¿™ä¸ªå¹¶å‘é‡æ”¾æ»¡ä¸‰å››å G çš„ eden åŒºå¯èƒ½ä¹Ÿå°±ä¸€ä¸¤åˆ†é’Ÿå§ï¼Œé‚£ä¹ˆæ„å‘³ç€æ•´ä¸ªç³»ç»Ÿæ¯è¿è¡Œä¸€ä¸¤åˆ†é’Ÿå°±ä¼šå› ä¸º younggc å¡é¡¿å‡ ç§’é’Ÿæ²¡æ³•å¤„ç†æ–°æ¶ˆæ¯ï¼Œæ˜¾ç„¶æ˜¯ä¸è¡Œçš„ã€‚é‚£ä¹ˆå¯¹äºè¿™ç§æƒ…å†µå¦‚ä½•ä¼˜åŒ–äº†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ G1 æ”¶é›†å™¨ï¼Œè®¾ç½®-XX:MaxGCPauseMills ä¸º 50msï¼Œå‡è®¾ 50ms èƒ½å¤Ÿå›æ”¶ä¸‰åˆ°å››ä¸ª G å†…å­˜ï¼Œç„¶å 50ms çš„å¡é¡¿å…¶å®å®Œå…¨èƒ½å¤Ÿæ¥å—ï¼Œç”¨æˆ·å‡ ä¹æ— æ„ŸçŸ¥ï¼Œé‚£ä¹ˆæ•´ä¸ªç³»ç»Ÿå°±å¯ä»¥åœ¨å¡é¡¿å‡ ä¹æ— æ„ŸçŸ¥çš„æƒ…å†µä¸‹ä¸€è¾¹å¤„ç†ä¸šåŠ¡ä¸€è¾¹æ”¶é›†åƒåœ¾ã€‚\nG1 å¤©ç”Ÿå°±é€‚åˆè¿™ç§å¤§å†…å­˜æœºå™¨çš„ JVM è¿è¡Œï¼Œå¯ä»¥æ¯”è¾ƒå®Œç¾çš„è§£å†³å¤§å†…å­˜åƒåœ¾å›æ”¶æ—¶é—´è¿‡é•¿çš„é—®é¢˜\nå®‰å…¨ç‚¹ä¸å®‰å…¨åŒºåŸŸ å®‰å…¨ç‚¹å°±æ˜¯æŒ‡ä»£ç ä¸­ä¸€äº›ç‰¹å®šçš„ä½ç½®, å½“çº¿ç¨‹è¿è¡Œåˆ°è¿™äº›ä½ç½®æ—¶å®ƒçš„çŠ¶æ€æ˜¯ç¡®å®šçš„, è¿™æ · JVM å°±å¯ä»¥å®‰å…¨çš„è¿›è¡Œä¸€äº›æ“ä½œ, æ¯”å¦‚ GC ç­‰ï¼Œæ‰€ä»¥ GC ä¸æ˜¯æƒ³ä»€ä¹ˆæ—¶å€™åšå°±ç«‹å³è§¦å‘çš„ï¼Œæ˜¯éœ€è¦ç­‰å¾…æ‰€æœ‰çº¿ç¨‹è¿è¡Œåˆ°å®‰å…¨ç‚¹åæ‰èƒ½è§¦å‘ã€‚\nè¿™äº›ç‰¹å®šçš„å®‰å…¨ç‚¹ä½ç½®ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§:\næ–¹æ³•è¿”å›ä¹‹å‰ è°ƒç”¨æŸä¸ªæ–¹æ³•ä¹‹å æŠ›å‡ºå¼‚å¸¸çš„ä½ç½® å¾ªç¯çš„æœ«å°¾ å¤§ä½“å®ç°æ€æƒ³æ˜¯å½“åƒåœ¾æ”¶é›†éœ€è¦ä¸­æ–­çº¿ç¨‹çš„æ—¶å€™ï¼Œä¸ç›´æ¥å¯¹çº¿ç¨‹æ“ä½œï¼Œä»…ä»…ç®€å•åœ°è®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½ï¼Œå„ä¸ªçº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹æ—¶ä¼šä¸åœåœ°ä¸»åŠ¨å»è½®è¯¢è¿™ä¸ªæ ‡å¿—ï¼Œä¸€æ—¦å‘ç°ä¸­æ–­æ ‡å¿—ä¸ºçœŸæ—¶å°±è‡ªå·±åœ¨æœ€è¿‘çš„å®‰å…¨ç‚¹ä¸Šä¸»åŠ¨ä¸­æ–­æŒ‚èµ·ã€‚è½®è¯¢æ ‡å¿—çš„åœ°æ–¹å’Œå®‰å…¨ç‚¹æ˜¯é‡åˆçš„ã€‚\nå®‰å…¨åŒºåŸŸåˆæ˜¯ä»€ä¹ˆï¼Ÿ Safe Point æ˜¯å¯¹æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹è®¾å®šçš„ã€‚\nå¦‚æœä¸€ä¸ªçº¿ç¨‹å¤„äº Sleep æˆ–ä¸­æ–­çŠ¶æ€ï¼Œå®ƒå°±ä¸èƒ½å“åº” JVM çš„ä¸­æ–­è¯·æ±‚ï¼Œå†è¿è¡Œåˆ° Safe Point ä¸Šã€‚å› æ­¤ JVM å¼•å…¥äº† Safe Regionã€‚\nSafe Region æ˜¯æŒ‡åœ¨ä¸€æ®µä»£ç ç‰‡æ®µä¸­ï¼Œå¼•ç”¨å…³ç³»ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚åœ¨è¿™ä¸ªåŒºåŸŸå†…çš„ä»»æ„åœ°æ–¹å¼€å§‹ GC éƒ½æ˜¯å®‰å…¨çš„\n","date":"2022-09-10T08:58:04Z","permalink":"https://dccmmtop.github.io/posts/g1%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E5%99%A8/","section":"posts","tags":["java"],"title":"G1åƒåœ¾æ”¶é›†å™¨"},{"categories":null,"contents":"åƒåœ¾æ”¶é›†ç®—æ³• æ•´ä½“å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ç®—æ³•ï¼š\næ ‡è®°å¤åˆ¶ç®—æ³• æ ‡è®°æ•´ç†ç®—æ³• æ ‡è®°æ¸…é™¤ç®—æ³• åˆ†ä»£æ”¶é›†ç†è®º ç›®å‰çš„è™šæ‹Ÿæœºçš„åƒåœ¾å›æ”¶å™¨éƒ½æ˜¯é‡‡ç”¨åˆ†ä»£æ”¶é›†ç®—æ³•ï¼Œä¸€èˆ¬æ ¹æ®å¯¹è±¡å­˜æ´»å‘¨æœŸçš„ä¸åŒï¼Œå°†å†…å­˜åˆ†ä¸ºå‡ å—ï¼Œä¸€èˆ¬å°†javaå †åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€å¹´ä»£ï¼Œç„¶åæ ¹æ®å„ä»£çš„ç‰¹ç‚¹é€‰æ‹©ä¸åŒçš„åƒåœ¾å›æ”¶å™¨ç®—æ³•\næ¯”å¦‚åœ¨æ–°ç”Ÿä»£ï¼Œæ¯æ¬¡æ”¶é›†éƒ½ä¼šæœ‰å¤§é‡çš„å¯¹è±¡æ­»å»ï¼ˆè¿‘ 99% ï¼‰ï¼Œæ‰€ä»¥é€‰æ‹©å¤åˆ¶ç®—æ³•ï¼Œåªéœ€å¤åˆ¶å°‘é‡å¯¹è±¡å°±å¯ä»¥å®Œæˆåƒåœ¾å›æ”¶ï¼Œæˆæœ¬è¾ƒä½ã€‚ è€Œè€å¹´ä»£å¯¹è±¡å­˜æ´»å‡ ç‡æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œä¹Ÿæ²¡æœ‰é¢å¤–çš„ç©ºé—´ç»™æ‹…ä¿ï¼Œæ‰€ä»¥è¦é€‰æ‹©æ ‡è®°æ¸…é™¤æˆ–æ ‡è®°æ•´ç†ç®—æ³•ï¼Œè¿™ä¸¤ç§ç®—æ³•æ¯”å¤åˆ¶ç®—æ³•æ…¢10å€ä»¥ä¸Š\næ ‡è®°å¤åˆ¶ç®—æ³• å°†å†…å­˜åˆ†ä¸ºå¤§å°ç›¸åŒçš„ä¸¤ä¸ªå—ï¼ŒåªæŠŠå¯¹è±¡åˆ†é…åˆ°å…¶ä¸­ä¸€ä¸ªå—ä¸Šï¼Œå½“è¿™ä¸ªå—çš„ç©ºé—´ä¸è¶³æ—¶ï¼Œå°±å°†è¿˜å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°å¦å¤–ä¸€å—ä¸Šå»ï¼Œç„¶åæŠŠä½¿ç”¨è¿‡é‚£å—ç©ºé—´æ¸…ç†æ‰ã€‚æ¯æ¬¡éƒ½æ˜¯å¯¹å†…å­˜ç©ºé—´çš„ä¸€åŠè¿›è¡Œå›æ”¶\næ ‡è®°æ¸…é™¤ç®—æ³• åˆ†ä¸ºä¸¤æ­¥\næ ‡è®°å­˜æ´»çš„å¯¹è±¡ æ¸…ç†æ²¡æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ ä¸€èˆ¬é€‰æ‹©è¿™ç§ï¼Œä¹Ÿå¯ä»¥åè¿‡æ¥ï¼Œæ ‡è®°éœ€è¦å›æ”¶çš„å¯¹è±¡ï¼Œç„¶åæ¸…ç†æ‰€æœ‰è¢«æ ‡è®°çš„å¯¹è±¡\nç¼ºç‚¹:\næ•ˆç‡ä½ï¼Œï¼ˆè¦æ ‡è®°çš„å¯¹è±¡å¯èƒ½å¾ˆå¤šï¼‰ å†…å­˜ç¢ç‰‡å¤šï¼ˆä¼šäº§ç”Ÿå¤§é‡çš„ä¸è¿ç»­ä¸‹ç©ºé—´ï¼Œæ— æ³•åˆ©ç”¨ï¼‰\nå¦‚å›¾:\næ ‡è®°æ•´ç†ç®—æ³• æ ¹æ®è€å¹´ä»£çš„ç‰¹ç‚¹ä¸“é—¨åˆ¶å®šçš„æ¸…é™¤æ–¹æ¡ˆï¼Œä¸æ ‡è®°æ¸…é™¤ä¸€æ ·ï¼Œéœ€è¦å…ˆæ ‡è®°å­˜æ´»å¯¹è±¡ï¼Œä¸åŒçš„æ˜¯ï¼Œåç»­æ²¡æœ‰ç›´æ¥å›æ”¶åƒåœ¾ï¼Œè€Œæ˜¯å°†å­˜æ´»çš„å¯¹è±¡ç»Ÿä¸€å‘ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åæ¸…ç†æ‰è¾¹ç•Œä»¥å¤–çš„å†…å­˜\nåƒåœ¾å›æ”¶å™¨ ä¸Šè¿°å‡ ä¸ªç®—æ³•æ˜¯ç†è®ºï¼Œå®ç°åƒåœ¾å›æ”¶ç®—æ³•çš„å«åšåƒåœ¾æ”¶é›†å™¨\nåƒåœ¾å›æ”¶å™¨æ²¡æœ‰æœ€å¥½çš„ï¼Œåªæœ‰æœ€åˆé€‚çš„\næ¦‚è§ˆ Serial æ”¶é›†å™¨ -XX:+UseSerialGC å¼€å¯å¹´è½»ä»£ä½¿ç”¨\n-XX:+UseSerialOldGC å¼€å¯è€å¹´ä»£ä½¿ç”¨\nSerialï¼ˆä¸²è¡Œï¼‰æ”¶é›†å™¨æ˜¯æœ€åŸºæœ¬ã€å†å²æœ€æ‚ ä¹…çš„åƒåœ¾æ”¶é›†å™¨äº†ã€‚çœ‹åå­—å°±çŸ¥é“è¿™ä¸ªæ”¶é›†å™¨æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨äº†ã€‚å®ƒçš„ â€œå•çº¿ç¨‹â€ çš„æ„ä¹‰ä¸ä»…ä»…æ„å‘³ç€å®ƒåªä¼šä½¿ç”¨ä¸€æ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†å·¥ä½œï¼Œæ›´é‡è¦çš„æ˜¯å®ƒåœ¨è¿›è¡Œåƒåœ¾æ”¶é›†å·¥ä½œçš„æ—¶å€™å¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼ˆ \u0026ldquo;Stop The World\u0026rdquo; ï¼‰ï¼Œç›´åˆ°å®ƒæ”¶é›†ç»“æŸã€‚\næ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚\nç¤ºæ„å›¾ï¼š\nSerial Old æ”¶é›†å™¨æ˜¯Serialæ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬ï¼Œå®ƒåŒæ ·æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ”¶é›†å™¨ã€‚\nå®ƒä¸»è¦æœ‰ä¸¤å¤§ç”¨é€”ï¼š\nåœ¨JDK1.5ä»¥åŠä»¥å‰çš„ç‰ˆæœ¬ä¸­ä¸Parallel Scavengeæ”¶é›†å™¨æ­é…ä½¿ç”¨ ä½œä¸ºCMSæ”¶é›†å™¨çš„åå¤‡æ–¹æ¡ˆã€‚ å®ç°ç®€å•ï¼Œå•çº¿ç¨‹çš„æ”¶é›†æ•ˆç‡é«˜\nParallel Scavenge æ”¶é›†å™¨ JK8 é»˜è®¤çš„åƒåœ¾å›æ”¶å™¨\n-XX:+UseParallelGC(å¹´è½»ä»£)ï¼Œ é‡‡ç”¨å¤åˆ¶ç®—æ³•\n-XX:+UseParallelOldGC(è€å¹´ä»£) æ ‡è®°æ•´ç†ç®—æ³•\nParallel å…¶å®å°±æ˜¯ Serial çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œé»˜è®¤çš„æ”¶é›†çº¿ç¨‹æ•°ä¸CPUæ ¸å¿ƒæ•°ç›¸åŒï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å‚æ•° -XX:ParallelGCThreads æŒ‡å®šæ”¶é›†çº¿ç¨‹æ•°ï¼Œä½†æ˜¯ä¸€èˆ¬ä¸æ¨èä¿®æ”¹ã€‚\nParallel Scavenge æ³¨é‡çš„æ˜¯æ”¶é›†æ•ˆç‡ï¼Œåé¢è¦ä»‹ç»çš„ CMSï¼ŒG1 æ”¶é›†å™¨ æ›´æ³¨é‡ç”¨æˆ·ä½“éªŒï¼Œç¼©çŸ­ STW çš„æ—¶é•¿ã€‚ä½†æ˜¯ä»–ä¸èƒ½ä¸ CMS æ”¶é›†å™¨é…åˆä½¿ç”¨\nç¤ºæ„å›¾:\nParNew æ”¶é›†å™¨ ParNew æ”¶é›†å™¨å’Œ Parallel å¾ˆç±»ä¼¼ï¼Œä¸»è¦åŒºåˆ«åœ¨äºï¼Œä»–å¯ä»¥ä¸ CMS é…åˆä½¿ç”¨ï¼Œæ–°ç”Ÿä»£é‡‡ç”¨å¤åˆ¶ç®—æ³•ï¼Œè€å¹´ä»£é‡‡ç”¨æ ‡è®°-æ•´ç†ç®—æ³•ã€‚\nåªæœ‰ Serial ,ParNew å¯ä»¥ä¸ CMS é…åˆä½¿ç”¨ ï¼Œ ParNew æ˜¯å¾ˆå¤šè™šæ‹Ÿæœºçš„é¦–è¦é€‰æ‹©ã€‚\nCMS æ”¶é›†å™¨ -XX:+UseConcMarkSweepGC(old)\nCMS(ConcurrentMarkSweep) æ˜¯ä¸€ç§è¿½æ±‚çŸ­ STW ä¸ºç›®æ ‡çš„æ”¶é›†å™¨ï¼Œæ³¨é‡ç”¨æˆ·ä½“éªŒï¼Œä»–æ˜¯ HotSpot è™šæ‹Ÿæœºç¬¬ä¸€æ¬¾çœŸæ­£æ„ä¹‰ä¸Šçš„æ”¶é›†å™¨ï¼Œç¬¬ä¸€æ¬¡å®ç°äº†è®©ç”¨æˆ·çº¿ç¨‹å’Œæ”¶é›†çº¿ç¨‹åŒæ—¶å·¥ä½œ\nä»åå­—å°±å¯ä»¥çœ‹å‡ºæ¥ï¼ŒMark: æ ‡è®°ï¼ŒSweep: æ¸…é™¤ï¼Œ å®ƒé‡‡ç”¨æ ‡è®°æ¸…ç†ç®—æ³•ï¼Œ ä»–çš„å·¥ä½œæµç¨‹æ›´å¤æ‚ï¼Œä¸»è¦åˆ†ä¸‹é¢5ä¸ªæ­¥éª¤:\nåˆå§‹æ ‡è®°: æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œæ ‡è®°GC Root ç›´æ¥å¼•ç”¨ çš„å¯¹è±¡ï¼Œé€Ÿåº¦å¾ˆå¿« å¹¶å‘æ ‡è®°ï¼š ä»ç¬¬ä¸€æ­¥æ ‡è®°çš„å¯¹è±¡å¼€å§‹éå†æ‰€æœ‰å¼•ç”¨å¯¹è±¡ï¼Œè¿‡ç¨‹è€—æ—¶å¾ˆé•¿ï¼Œä½†æ˜¯ä¸éœ€è¦æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œå› ä¸ºæœ‰ç”¨æˆ·çº¿ç¨‹çš„å¹²æ‰°ï¼Œå¯èƒ½ä¼šä¿®æ”¹å·²ç»æ ‡è®°çš„å¯¹è±¡ï¼Œäº§ç”Ÿé—®é¢˜ é‡æ–°æ ‡è®°ï¼šä¸ºäº†ä¿®æ­£å¹¶å‘æ ‡è®°æ—¶äº§ç”Ÿçš„é—®é¢˜ï¼Œäº§ç”Ÿé—®é¢˜çš„å¯¹è±¡æ¯”ä¾‹å°ï¼Œæ‰€ä»¥é€Ÿåº¦å¾ˆå¿«ã€‚æ­¤è¿‡ç¨‹ä¼šSTW å¹¶å‘æ¸…ç†ï¼š æ¸…ç†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œæ¸…ç†æ‰æ²¡æœ‰æ ‡è®°çš„å¯¹è±¡ï¼Œå¦‚æœæ­¤æ—¶æœ‰æ–°å¢çš„å¯¹è±¡è™½ç„¶æ²¡æœ‰è¢«æ ‡è®°ï¼Œç»Ÿä¸€ä¼šå½“ä½œå­˜æ´»å¯¹è±¡ï¼Œä¸ä¼šè¯¯æ¸…ç† å¹¶å‘é‡ç½®ï¼š é‡ç½®æœ¬æ¬¡GCè¢«æ ‡è®°çš„æ•°æ® ä¼˜ç‚¹:\nå¹¶å‘æ”¶é›† çŸ­åœé¡¿ ç¼ºç‚¹:\nå’Œç”¨æˆ·çº¿ç¨‹æŠ¢å CPUèµ„æº æ— æ³•å¤„ç†æµ®åŠ¨åƒåœ¾ ç”±äºæ—¶æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œå¯ä»¥é€šè¿‡å‚æ•°: -XX:+UseCMSCompactAtFullCollection æ§åˆ¶æ˜¯å¦åšç©ºé—´æ•´ç† ç”±äºå…è®¸ç”¨æˆ·çº¿ç¨‹åŒæ—¶è¿è¡Œï¼Œä¼šé€ æˆåœ¨GCè¿‡ç¨‹ä¸­ä¸æ–­çš„æœ‰å¯¹è±¡è¿›å…¥å†…å­˜ï¼Œå½“å‰GCæ²¡æœ‰å®Œæˆï¼Œç©ºé—´æ²¡æœ‰é‡Šæ”¾ï¼Œå¯èƒ½å¯¼è‡´æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´æ”¾æ–°è¿›æ¥çš„å¯¹è±¡ï¼Œæ­¤æ—¶ä¼šå¯¼è‡´ STW,ç„¶åé€€åŒ–æˆ serial æ”¶é›†å™¨è¿›è¡Œåƒåœ¾å›æ”¶ CMSçš„ç›¸å…³æ ¸å¿ƒå‚æ•° -XX:+UseConcMarkSweepGCï¼šå¯ç”¨cmsÂ -XX:ConcGCThreadsï¼šå¹¶å‘çš„GCçº¿ç¨‹æ•° -XX:+UseCMSCompactAtFullCollectionï¼šFullGCä¹‹ååšå‹ç¼©æ•´ç†ï¼ˆå‡å°‘ç¢ç‰‡ï¼‰ -XX:CMSFullGCsBeforeCompactionï¼šå¤šå°‘æ¬¡FullGCä¹‹åå‹ç¼©ä¸€æ¬¡ï¼Œé»˜è®¤æ˜¯0ï¼Œä»£è¡¨æ¯æ¬¡FullGCåéƒ½ä¼šå‹ç¼©ä¸€æ¬¡ -XX:CMSInitiatingOccupancyFraction: å½“è€å¹´ä»£ä½¿ç”¨è¾¾åˆ°è¯¥æ¯”ä¾‹æ—¶ä¼šè§¦å‘FullGCï¼ˆé»˜è®¤æ˜¯92ï¼Œè¿™æ˜¯ç™¾åˆ†æ¯”ï¼‰ -XX:+UseCMSInitiatingOccupancyOnlyï¼šåªä½¿ç”¨è®¾å®šçš„å›æ”¶é˜ˆå€¼(-XX:CMSInitiatingOccupancyFractionè®¾å®šçš„å€¼)ï¼Œå¦‚æœä¸æŒ‡å®šï¼ŒJVMä»…åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨è®¾å®šå€¼ï¼Œåç»­åˆ™ä¼šè‡ªåŠ¨è°ƒæ•´ -XX:+CMSScavengeBeforeRemarkï¼šåœ¨CMS GCå‰å¯åŠ¨ä¸€æ¬¡minor gcï¼Œé™ä½CMS GCæ ‡è®°é˜¶æ®µ(ä¹Ÿä¼šå¯¹å¹´è½»ä»£ä¸€èµ·åšæ ‡è®°ï¼Œå¦‚æœåœ¨minor gcå°±å¹²æ‰äº†å¾ˆå¤šå¯¹åƒåœ¾å¯¹è±¡ï¼Œæ ‡è®°é˜¶æ®µå°±ä¼šå‡å°‘ä¸€äº›æ ‡è®°æ—¶é—´)æ—¶çš„å¼€é”€ï¼Œä¸€èˆ¬CMSçš„GCè€—æ—¶ 80%éƒ½åœ¨æ ‡è®°é˜¶æ®µ -XX:+CMSParallellnitialMarkEnabledï¼šè¡¨ç¤ºåœ¨åˆå§‹æ ‡è®°çš„æ—¶å€™å¤šçº¿ç¨‹æ‰§è¡Œï¼Œç¼©çŸ­STW -XX:+CMSParallelRemarkEnabledï¼šåœ¨é‡æ–°æ ‡è®°çš„æ—¶å€™å¤šçº¿ç¨‹æ‰§è¡Œï¼Œç¼©çŸ­STW; ä¸‰è‰²æ ‡è®° åˆå§‹æ ‡è®° å¹¶å‘æ ‡è®° å¹¶å‘æ ‡è®°äº§ç”Ÿçš„é—®é¢˜çš„åŸå›  å‡ºç°é—®é¢˜çš„åæœ é—®é¢˜çš„è§£å†³åŠæ³• å‡ºç°æ¼æ ‡çš„ä¸¤ä¸ªå¿…è¦æ¡ä»¶:\næœ‰å¯¹è±¡çš„å¼•ç”¨å…³ç³»è¢«åˆ é™¤ åˆ é™¤çš„å¯¹è±¡åˆè¢«é‡æ–°å¼•ç”¨ è§ä¸Šå›¾\nç ´ç¯ä»»æ„æ­¥éª¤ï¼Œå³å¯é¿å…æ¼æ ‡çš„ç°è±¡ã€‚æœ‰ä»¥ä¸‹ä¸¤ç§è§£å†³æ–¹æ¡ˆ:\nå¢é‡æ›´æ–°\nå› ä¸ºé‡æ–°æ ‡è®°æ—¶ï¼Œè¦å†æ¬¡ä»é»‘è‰²å¯¹è±¡å‡ºå‘ï¼Œæ·±åº¦æ‰«ææ‰€æœ‰å¼•ç”¨ï¼Œæ•ˆç‡æ²¡æœ‰åŸå§‹å¿«ç…§é«˜ ä¼˜ç‚¹: ä¸ä¼šäº§ç”Ÿæµ®åŠ¨åƒåœ¾ ç¼ºç‚¹: æ•ˆç‡ä½ åŸå§‹å¿«ç…§\nå†å¼•ç”¨è¢«åˆ é™¤æ—¶ï¼Œè®°å½•å…³ç³»ï¼Œé‡æ–°æ‰«ææ—¶ï¼Œå°†è¢«å¼•ç”¨çš„å¯¹è±¡æ ‡è®°ä¸ºéåƒåœ¾ï¼Œå¦‚æœåç»­æ²¡æœ‰å†æ¬¡å¼•è¯¥å¯¹è±¡ï¼Œé‚£ä¹ˆè¯¥å¯¹è±¡å°±ä¼šå˜æˆæµ®åŠ¨åƒåœ¾ ç¼ºç‚¹: å¯èƒ½ä¼šäº§ç”Ÿæµ®åŠ¨åƒåœ¾ ä¼˜ç‚¹: ä¸è¦é‡æ–°æ‰«æï¼Œæ•ˆç‡é«˜ é‚£é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æ²¡æœ‰æ²¡æœ‰å…¶ä»–å¯èƒ½é‡æ–°å¼•ç”¨å¯¹è±¡å‘¢ï¼Ÿç­”æ¡ˆåªæœ‰ä¸€ä¸ªï¼Œ new ä¸€ä¸ªæ–°å¯¹è±¡ã€‚åœ¨GCæœŸé—´ï¼Œæœ‰æ–°çš„å¯¹è±¡è¿›æ¥æ—¶ï¼Œç»Ÿä¸€è¢«å½“æˆé»‘è‰²å¤„ç†ï¼Œä¸ä¼šè¢«å›æ”¶\né‚£ä¹ˆä¸Šå›¾ä¸­çš„ brand ä¼šä¸ä¼šè¢«é‡æ–°å¼•ç”¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ä¸ä¼šï¼å› ä¸ºå·²ç»æ‰¾ä¸åˆ°å¼•ç”¨ brand å¯¹è±¡çš„å˜é‡äº†ï¼Œåœ¨å¼•ç”¨ç¨‹åºä¸­æ— æ³•å†æ¬¡å¼•ç”¨è¿™ä¸ªåƒåœ¾å¯¹è±¡\nä¸Šå›¾ä¸­è¯´åˆ°ï¼Œåœ¨å¯¹è±¡è¢«å¼•ç”¨ä¸Šï¼Œåˆ é™¤å¯¹è±¡å¼•ç”¨æ˜¯ï¼Œè®°å½•è¿™ä¸ªå¼•ç”¨å…³ç³»ï¼Œä»è€Œæ–¹ä¾¿åç»­çš„é‡æ–°ç¼–è¾‘ï¼Œé‚£ä¹ˆè¿™ä¸ªè®°å½•çš„åŠ¨ä½œæ˜¯å¦‚ä½•å‘ç”Ÿçš„ï¼Ÿ è¿™æ—¶å°±è¦å¼•å…¥å†™å±éšœçš„æŠ€æœ¯äº†ã€‚\nä»¥ä¸Šæ— è®ºæ˜¯å¯¹å¼•ç”¨å…³ç³»è®°å½•çš„æ’å…¥è¿˜æ˜¯åˆ é™¤ï¼Œ è™šæ‹Ÿæœºçš„è®°å½•æ“ä½œéƒ½æ˜¯é€šè¿‡å†™å±éšœå®ç°çš„ã€‚\nå†™å±éšœ ç±»ä¼¼äºåˆ‡é¢ï¼Œåœ¨èµ‹å€¼åŠ¨ä½œçš„å‰ååšä¸€äº›äº‹æƒ…ã€‚\nvoid oop_field_store(oop* field, oop new_value) { pre_write_barrier(field); // å†™å±éšœ-å†™å‰æ“ä½œ *field = new_value; post_write_barrier(field, value); // å†™å±éšœ-å†™åæ“ä½œ } å†™å±éšœå®ç°SATB å½“å¯¹è±¡Bçš„æˆå‘˜å˜é‡çš„å¼•ç”¨å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ¯”å¦‚å¼•ç”¨æ¶ˆå¤±ï¼ˆa.b.d = nullï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å†™å±éšœï¼Œå°†BåŸæ¥æˆå‘˜å˜é‡çš„å¼•ç”¨å¯¹è±¡Dè®°å½•ä¸‹æ¥ï¼š\nvoid pre_write_barrier(oop* field) { oop old_value = *field; // è·å–æ—§å€¼ remark_set.add(old_value); // è®°å½•åŸæ¥çš„å¼•ç”¨å¯¹è±¡ } å†™å±éšœå®ç°å¢é‡æ›´æ–° å½“å¯¹è±¡Açš„æˆå‘˜å˜é‡çš„å¼•ç”¨å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ¯”å¦‚æ–°å¢å¼•ç”¨ï¼ˆa.d = dï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å†™å±éšœï¼Œå°†Aæ–°çš„æˆå‘˜å˜é‡å¼•ç”¨å¯¹è±¡Dè®°å½•ä¸‹æ¥ï¼š\nvoid post_write_barrier(oop* field, oop new_value) { remark_set.add(new_value); // è®°å½•æ–°å¼•ç”¨çš„å¯¹è±¡ } è¯»å±éšœ ä¸å†™å±éšœç±»ä¼¼\né‡æ–°æ ‡è®° å¹¶å‘æ¸…ç† å¹¶å‘é‡ç½® ä»¥ä¸Šå°±æ˜¯ä¸‰è‰²æ ‡è®°çš„å¤§ä½“æµç¨‹äº†\nä¸åŒåƒåœ¾å›æ”¶å™¨å¯¹ä¸‰è‰²æ ‡è®°çš„é€‰æ‹© CMS å†™å±éšœ + å¢é‡æ›´æ–° G1 ,Shenandoahï¼š å†™å±éšœ + STAB ZGC: è¯»å±éšœ ä¸ºä»€ä¹ˆ G1 é‡‡ç”¨ STABï¼Œ CMS é‡‡ç”¨ å¢é‡æ›´æ–° ä¸ªäººç†è§£ï¼š G1 ä¸€èˆ¬ç”¨äºå¤§å†…å­˜çš„æœºå™¨ï¼Œå†…å­˜ 8G è‡³ç™¾Gçº§åˆ«, å­˜æ”¾çš„å¯¹è±¡æ›´å¤šï¼Œè‡ªç„¶è¦æ‰«æçš„å¯¹è±¡æ›´å¤šï¼Œå¦‚æœé‡‡ç”¨æ•ˆç‡ä½çš„å¢é‡æ›´æ–°æ–¹å¼ï¼Œæ•ˆç‡ä¸‹é™çš„æ›´ä¸¥é‡ï¼Œæ‰€ä»¥é‡‡ç”¨æ•ˆç‡è¾ƒé«˜çš„ STAB,è™½ç„¶ä¼šäº§ç”Ÿä¸€äº›æµ®åŠ¨åƒåœ¾ï¼Œä½†æ˜¯å¯¹äºå¤§å†…å­˜æœºå™¨æ¥è¯´ï¼Œå½±å“ä¸å¤§ã€‚\nCMS é€‚ç”¨äºå†…å­˜è¾ƒå°çš„æœºå™¨,å¤šç”¨äº 4G åˆ° 8G çš„æœºå™¨ä¸Šï¼Œæ— è®ºé‡‡ç”¨ STAB è¿˜æ˜¯ CMS, æ•ˆç‡ä¸Šæ— æ³•æ‹‰å¼€æ˜æ˜¾å·®è·ï¼Œè€Œå¢é‡æ›´æ–°ä¸ä¼šäº§ç”Ÿæµ®åŠ¨åƒåœ¾ï¼Œå¯¹å†…å­˜æ›´å°çš„æœºå™¨æ¥è¯´ï¼Œå†…å­˜çš„ä½¿ç”¨æ›´æ•æ„Ÿï¼Œè‡ªç„¶é‡‡ç”¨å¢é‡æ›´æ–°çš„æ–¹å¼\nè®°å¿†é›†ä¸å¡è¡¨ è¿™ä¸¤ä¸ªç»“æ„æ˜¯ä¸ºäº†åƒåœ¾å™¨åœ¨è·¨ä»£è®¿é—®æ—¶æé«˜é€Ÿåº¦çš„ã€‚\nåœ¨æ–°ç”Ÿä»£åšGCRootså¯è¾¾æ€§æ‰«æè¿‡ç¨‹ä¸­å¯èƒ½ä¼šç¢°åˆ°è·¨ä»£å¼•ç”¨çš„å¯¹è±¡ï¼Œè¿™ç§å¦‚æœåˆå»å¯¹è€å¹´ä»£å†å»æ‰«æï¼Œç”šè‡³è€å¹´ä»£å†…å­˜åœ¨å¾ˆå¤šå¯¹è±¡çš„é—´æ¥å¼•ç”¨ï¼Œè¿™ç§æ•ˆç‡å°±å¤ªä½äº†ï¼Œå¤§å¤§çš„å»¶é•¿äº† Minor GC çš„æ—¶é—´ã€‚\nä¸ºæ­¤ï¼Œåœ¨æ–°ç”Ÿä»£å¯ä»¥å¼•å…¥è®°å½•é›†ï¼ˆRemember Setï¼‰çš„æ•°æ®ç»“æ„ï¼ˆè®°å½•ä»éæ”¶é›†åŒºåˆ°æ”¶é›†åŒºçš„æŒ‡é’ˆé›†åˆï¼‰ï¼Œé¿å…æŠŠæ•´ä¸ªè€å¹´ä»£åŠ å…¥GCRootsæ‰«æèŒƒå›´ã€‚äº‹å®ä¸Šå¹¶ä¸åªæ˜¯æ–°ç”Ÿä»£ã€ è€å¹´ä»£ä¹‹é—´ä¹Ÿæœ‰è·¨ä»£å¼•ç”¨çš„é—®é¢˜ï¼Œ æ‰€æœ‰æ¶‰åŠéƒ¨åˆ†åŒºåŸŸæ”¶é›†ï¼ˆPartial GCï¼‰ è¡Œä¸ºçš„åƒåœ¾æ”¶é›†å™¨ï¼Œ å…¸å‹çš„å¦‚G1ã€ ZGCå’ŒShenandoahæ”¶é›†å™¨ï¼Œ éƒ½ä¼šé¢ä¸´ç›¸åŒçš„é—®é¢˜ã€‚\nåƒåœ¾æ”¶é›†åœºæ™¯ä¸­ï¼Œæ”¶é›†å™¨åªéœ€é€šè¿‡è®°å¿†é›†åˆ¤æ–­å‡ºæŸä¸€å—éæ”¶é›†åŒºåŸŸæ˜¯å¦å­˜åœ¨æŒ‡å‘æ”¶é›†åŒºåŸŸçš„æŒ‡é’ˆå³å¯ï¼Œæ— éœ€äº†è§£è·¨ä»£å¼•ç”¨æŒ‡é’ˆçš„å…¨éƒ¨ç»†èŠ‚ã€‚\nhotspotä½¿ç”¨ä¸€ç§å«åšâ€œå¡è¡¨â€(Cardtable)çš„æ–¹å¼å®ç°è®°å¿†é›†ï¼Œä¹Ÿæ˜¯ç›®å‰æœ€å¸¸ç”¨çš„ä¸€ç§æ–¹å¼ã€‚å…³äºå¡è¡¨ä¸è®°å¿†é›†çš„å…³ç³»ï¼Œ å¯ä»¥ç±»æ¯”ä¸ºJavaè¯­è¨€ä¸­HashMapä¸Mapçš„å…³ç³»ã€‚\nå¡è¡¨æ˜¯ä½¿ç”¨ä¸€ä¸ªå­—èŠ‚æ•°ç»„å®ç°ï¼šCARD_TABLE[ ]ï¼Œæ¯ä¸ªå…ƒç´ å¯¹åº”ç€å…¶æ ‡è¯†çš„å†…å­˜åŒºåŸŸä¸€å—ç‰¹å®šå¤§å°çš„å†…å­˜å—ï¼Œç§°ä¸ºâ€œå¡é¡µâ€ã€‚\nhotSpotä½¿ç”¨çš„å¡é¡µæ˜¯2^9å¤§å°ï¼Œå³512å­—èŠ‚\nä¸€ä¸ªå¡é¡µä¸­å¯åŒ…å«å¤šä¸ªå¯¹è±¡ï¼Œåªè¦æœ‰ä¸€ä¸ªå¯¹è±¡çš„å­—æ®µå­˜åœ¨è·¨ä»£æŒ‡é’ˆï¼Œå…¶å¯¹åº”çš„å¡è¡¨çš„å…ƒç´ æ ‡è¯†å°±å˜æˆ1ï¼Œè¡¨ç¤ºè¯¥å…ƒç´ å˜è„ï¼Œå¦åˆ™ä¸º0.\nGCæ—¶ï¼Œåªè¦ç­›é€‰æœ¬æ”¶é›†åŒºçš„å¡è¡¨ä¸­å˜è„çš„å…ƒç´ åŠ å…¥GCRootsé‡Œã€‚\nå¡è¡¨çš„ç»´æŠ¤\nå¡è¡¨å˜è„ä¸Šé¢å·²ç»è¯´äº†ï¼Œä½†æ˜¯éœ€è¦çŸ¥é“å¦‚ä½•è®©å¡è¡¨å˜è„ï¼Œå³å‘ç”Ÿå¼•ç”¨å­—æ®µèµ‹å€¼æ—¶ï¼Œå¦‚ä½•æ›´æ–°å¡è¡¨å¯¹åº”çš„æ ‡è¯†ä¸º1ã€‚\nHotspotä½¿ç”¨å†™å±éšœç»´æŠ¤å¡è¡¨çŠ¶æ€ã€‚\n","date":"2022-09-02T15:37:30Z","permalink":"https://dccmmtop.github.io/posts/cms%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E4%B8%8E%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0%E7%AE%97%E6%B3%95/","section":"posts","tags":["java"],"title":"CMSåƒåœ¾å›æ”¶å™¨ä¸ä¸‰è‰²æ ‡è®°ç®—æ³•"},{"categories":null,"contents":"å¥åº·ä¿¡æ¯ å‘½ä»¤ curl-X GET\u0026#34;localhost:9200/_cluster/health\u0026#34; ç»“æœ ","date":"2022-08-31T16:25:06Z","permalink":"https://dccmmtop.github.io/posts/%E6%9F%A5%E7%9C%8Bes%E9%9B%86%E7%BE%A4%E4%BF%A1%E6%81%AF/","section":"posts","tags":["ES"],"title":"æŸ¥çœ‹ESé›†ç¾¤ä¿¡æ¯"},{"categories":null,"contents":"å¯¹è±¡åˆ†é…è¿‡ç¨‹ç®€ç•¥æµç¨‹å›¾ å¯¹è±¡æ ˆä¸Šåˆ†é… æˆ‘ä»¬éƒ½çŸ¥é“å¯¹è±¡åˆ†é…åœ¨å †ä¸Šï¼Œå½“å¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨æ—¶å°±ä¼šå½“æˆåƒåœ¾å›æ”¶ï¼Œå¦‚æœå¯¹è±¡æ•°é‡æ¯”è¾ƒå¤šï¼Œä¼šç»™GCå¸¦æ¥è¾ƒå¤§çš„å‹åŠ›ï¼Œå½±å“æ€§èƒ½ï¼Œä¸ºäº†å‡å°‘ä¸´æ—¶å¯¹è±¡åœ¨å †å†…çš„åˆ†é…æ¬¡æ•°ï¼ŒJVM é€šè¿‡é€ƒé€¸åˆ†æï¼Œç¡®å®šè¯¥å¯¹è±¡ä¸ä¼šè¢«å¤–éƒ¨è®¿é—®ã€‚å¦‚æœä¸ä¼šé€ƒé€¸ï¼Œå¯ä»¥å°†è¯¥å¯¹è±¡åœ¨æ ˆä¸Šåˆ†é…ã€‚è¯¥å¯¹è±¡æ‰€å ç”¨çš„ç©ºé—´å°±å¯ä»¥éšç€æ ˆå¸§å‡ºæ ˆè€Œé”€æ¯ï¼Œå‡è½»äº†GCçš„å‹åŠ›\né€ƒé€¸åˆ†æ public User test1() { User user = new User(); user.setId(1); user.setName(\u0026#34;zhuge\u0026#34;); //TODO ä¿å­˜åˆ°æ•°æ®åº“ return user; } public void test2() { User user = new User(); user.setId(1); user.setName(\u0026#34;zhuge\u0026#34;); //TODO ä¿å­˜åˆ°æ•°æ®åº“ } test1 æ–¹æ³•å°† user è¿”å›äº†ï¼Œæœ‰å¯èƒ½è¢«å¤–éƒ¨å¯¹è±¡å¼•ç”¨ï¼Œå…¶ä½œç”¨åŸŸèŒƒå›´ä¸ç¡®å®šï¼Œ test2 æ–¹æ³•æ²¡æœ‰å°† user å¯¹è±¡è¿”å›ï¼Œå…¶ä½œç”¨åŸŸä»…ä»…åœ¨æ–¹æ³•å†…éƒ¨ï¼Œæ²¡æœ‰é€ƒå‡ºæ–¹æ³•èŒƒå›´ï¼Œå¯ä»¥æŠŠ user è¿›è¡Œæ ˆå†…åˆ†é…ã€‚\nJVM å¯ä»¥é€šè¿‡å‚æ•° -XX:DoEscapeAnalysis å¼€å¯é€ƒé€¸åˆ†æï¼ŒJDK7 ä¹‹åé»˜è®¤å¼€å¯\næ ‡é‡æ›¿æ¢ å°†å¯¹è±¡è¿›è¡Œæ ˆå†…åˆ†é…æ—¶ä¹Ÿä¸æ˜¯å°†æ•´ä¸ªå¯¹è±¡å…¨éƒ¨æ”¾åˆ°æ ˆä¸­ï¼ŒJVM ä¸ä¼šåˆ›å»ºå¯¹è±¡ï¼Œ è€Œæ˜¯æŠŠå¯¹è±¡æ‹†å¼€ï¼Œå°†å¯¹è±¡ä¸­çš„æˆå‘˜å˜é‡æ”¾åˆ°æ ˆä¸­ï¼Œè¿™æ ·å°±ä¸ä¼šå› ä¸ºæ²¡æœ‰ä¸€å¤§å—è¿ç»­çš„ç©ºé—´å¯¼è‡´å¯¹è±¡å†…å­˜ä¸å¤Ÿåˆ†é…\nå¼€å¯æ ‡é‡æ›¿æ¢å‚æ•°: -XX:+EliminateAllocationsï¼ŒJDK7ä¹‹åé»˜è®¤å¼€å¯ã€‚ å¦‚ä¸‹é¢çš„ä¾‹å­:\npublic class EscapeAnalysis { public Person p; /** * å‘ç”Ÿé€ƒé€¸ï¼Œå¯¹è±¡è¢«è¿”å›åˆ°æ–¹æ³•ä½œç”¨åŸŸä»¥å¤–ï¼Œè¢«æ–¹æ³•å¤–éƒ¨ï¼Œçº¿ç¨‹å¤–éƒ¨éƒ½å¯ä»¥è®¿é—® */ public void escape(){ p = new Person(26, \u0026#34;TomCoding escape\u0026#34;); } /** * ä¸ä¼šé€ƒé€¸ï¼Œå¯¹è±¡åœ¨æ–¹æ³•å†…éƒ¨ */ public String noEscape(){ Person person = new Person(26, \u0026#34;TomCoding noEscape\u0026#34;); return person.name; } } static class Person { public int age; public String name; ... // çœç•¥æ„é€ æ–¹æ³• } æ¯”å¦‚ä¸Šè¿°noEscape()æ–¹æ³•ä¸­personå¯¹è±¡åªä¼šåœ¨æ–¹æ³•å†…éƒ¨ï¼Œé€šè¿‡æ ‡é‡æ›¿æ¢æŠ€æœ¯å¾—åˆ°å¦‚ä¸‹ä¼ªç ï¼š\n/** * ä¸ä¼šé€ƒé€¸ï¼Œå¯¹è±¡åœ¨æ–¹æ³•å†…éƒ¨ */ public String noEscape(){ int age = 26; String name = \u0026#34;TomCoding noEscape\u0026#34;; return name; } æ ‡é‡å’Œèšåˆé‡ æ ‡é‡å³ä¸å¯è¢«è¿›ä¸€æ­¥åˆ†è§£çš„é‡ï¼Œè€ŒJAVAçš„åŸºæœ¬æ•°æ®ç±»å‹å°±æ˜¯æ ‡é‡ï¼ˆå¦‚ï¼šintï¼Œlongç­‰åŸºæœ¬æ•°æ®ç±»å‹ä»¥åŠreferenceç±»å‹ç­‰ï¼‰ï¼Œæ ‡é‡çš„å¯¹ç«‹å°±æ˜¯å¯ä»¥è¢«è¿›ä¸€æ­¥åˆ†è§£çš„é‡ï¼Œè€Œè¿™ç§é‡ç§°ä¹‹ä¸ºèšåˆé‡ã€‚è€Œåœ¨JAVAä¸­å¯¹è±¡å°±æ˜¯å¯ä»¥è¢«è¿›ä¸€æ­¥åˆ†è§£çš„èšåˆé‡\næ ˆä¸Šåˆ†é…ç¤ºä¾‹ /** * æ ˆä¸Šåˆ†é…ï¼Œæ ‡é‡æ›¿æ¢ * ä»£ç è°ƒç”¨äº†1äº¿æ¬¡alloc()ï¼Œå¦‚æœæ˜¯åˆ†é…åˆ°å †ä¸Šï¼Œå¤§æ¦‚éœ€è¦1GBä»¥ä¸Šå †ç©ºé—´ï¼Œå¦‚æœå †ç©ºé—´å°äºè¯¥å€¼ï¼Œå¿…ç„¶ä¼šè§¦å‘GCã€‚ * * ä½¿ç”¨å¦‚ä¸‹å‚æ•°ä¸ä¼šå‘ç”ŸGC * -Xmx15m -Xms15m -XX:+DoEscapeAnalysis -XX:+PrintGC -XX:+EliminateAllocations * ä½¿ç”¨å¦‚ä¸‹å‚æ•°éƒ½ä¼šå‘ç”Ÿå¤§é‡GC * -Xmx15m -Xms15m -XX:-DoEscapeAnalysis -XX:+PrintGC -XX:+EliminateAllocations * -Xmx15m -Xms15m -XX:+DoEscapeAnalysis -XX:+PrintGC -XX:-EliminateAllocations */ public class AllotOnStack { public static void main(String[] args) { long start = System.currentTimeMillis(); for (int i = 0; i \u0026lt; 100000000; i++) { alloc(); } long end = System.currentTimeMillis(); System.out.println(end - start); } private static void alloc() { User user = new User(); user.setId(1); user.setName(\u0026#34;user1\u0026#34;); } } å¯ä»¥æ ¹æ®æ‰“å°çš„GCæ—¥å¿—æ˜æ˜¾çœ‹å‡ºå¼€å¯äº†æ ˆå†…åˆ†é…æ—¶ï¼ŒGC æ¬¡æ•°è¿œè¿œå°äºä¸å¼€å¯ç«™å†…åˆ†é…\nåœ¨EDENåŒºåˆ†é… è™½ç„¶jvmå¯ä»¥é€šè¿‡é€ƒé€¸åˆ†ææ¥å°†ä¸€éƒ¨åˆ†å¯¹è±¡è¿›è¡Œæ ˆä¸Šåˆ†é…ï¼Œä½†æ˜¯åœ¨å®é™…ä»£ç ä¸­ï¼Œä¸é€ƒé€¸çš„å¯¹è±¡è¿˜æ˜¯å å°‘é‡çš„ï¼Œå¤§éƒ¨åˆ†ä»å¯¹è±¡ç„¶åˆ†é…åœ¨å †ä¸Šçš„ EDEN åŒº\nå½“EdenåŒºæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´æ—¶å°†è§¦å‘ä¸€æ¬¡ Minor GC\nä¸ºä»€ä¹ˆ Eden ä¸ Survivor çš„æ¯”ä¾‹æ˜¯ 8:1:1 å¤§é‡å¯¹è±¡è¢«åˆ†é…åœ¨ Eden åŒºï¼ŒEden æ»¡äº†ä¹‹åä¼šè§¦å‘Minor GC, å¯èƒ½æœ‰99% ä»¥ä¸Šçš„å¯¹è±¡è¢«å½“ä½œåƒåœ¾å›æ”¶ï¼Œå‰©ä½™çš„å­˜æ´»å¯¹è±¡è¢«æŒªåˆ°ä¸ºç©ºçš„ survivor åŒºï¼Œä¸‹ä¸€æ¬¡Edenæ»¡äº†ä¹‹åï¼Œåˆä¼šè§¦å‘MinorGC ,æŠŠ Eden å’Œ Survivor å¯¹è±¡å›æ”¶ï¼ŒæŠŠå‰©ä½™çš„å¯¹è±¡ä¸€æ¬¡æ€§æŒªåˆ°å¦ä¸€å—ä¸ºç©ºçš„ Survivor åŒºã€‚å› ä¸ºæ–°ç”Ÿå¯¹è±¡å¤§éƒ¨åˆ†å¯¿å‘½è¾ƒçŸ­ï¼Œæ‰€ä»¥ JVM é»˜è®¤çš„æ¯”ä¾‹ 8:1:1 æ˜¯éå¸¸åˆé€‚çš„ï¼Œè®© Eden è¶³å¤Ÿå¤§ã€‚ Survivor å¤Ÿç”¨å³å¯ã€‚\nJVMé»˜è®¤æœ‰è¿™ä¸ªå‚æ•°-XX:+UseAdaptiveSizePolicy(é»˜è®¤å¼€å¯)ï¼Œä¼šå¯¼è‡´è¿™ä¸ª8:1:1æ¯”ä¾‹è‡ªåŠ¨å˜åŒ–ï¼Œå¦‚æœä¸æƒ³è¿™ä¸ªæ¯”ä¾‹æœ‰å˜åŒ–å¯ä»¥è®¾ç½®å‚æ•°-XX:-UseAdaptiveSizePolicy\næå‰è¿›å…¥è€å¹´ä»£ åœ¨å‘ç”ŸMinorGC åï¼ŒEdenåŒºçš„å¯¹è±¡åœ¨å‘ Survivor åŒºè½¬ç§»æ—¶ï¼Œå¦‚æœ Survivor åŒºæ”¾ä¸ä¸‹è¿™ä¸ªå¯¹è±¡ã€‚é‚£ä¹ˆè¿™ä¸ªå¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£\nç›¸å½“äºè¿™ä¸ªå¤§å¯¹è±¡è·³è¿‡äº† Survivor åŒºï¼Œç›´æ¥è¿›å…¥ç©ºé—´æ›´å¤§çš„è€å¹´ä»£åŒº\nç›´æ¥è¿›å…¥è€å¹´ä»£çš„åœºæ™¯ åœ¨ Serial å’Œ ParNew åƒåœ¾å›æ”¶å™¨ä¸‹ï¼Œå¤§å¯¹è±¡ä¼šç›´æ¥è¿›åˆ†é…åˆ°è€å¹´ä»£ä¸­ï¼Œä¸ç»è¿‡ Eden å’Œ Survivor åŒºã€‚ å¤§å¯¹è±¡å°±æ˜¯éœ€è¦è¿ç»­å¤§å†…å­˜çš„å¯¹è±¡,æ¯”å¦‚å­—ç¬¦ä¸²ï¼Œæ•°ç»„ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥é¿å…ä¸ºå¤§å¯¹è±¡åˆ†é…å†…å­˜æ—¶çš„å¤åˆ¶æ“ä½œé™ä½æ•ˆç‡\nå¯ä»¥é€šè¿‡å‚æ•°è°ƒèŠ‚å¤§å¯¹è±¡çš„é˜€å€¼: -XX:PretenureSizeThreshold\nä¾‹å­: -XX:PretenureSizeThreshold=1000000 (å•ä½æ˜¯å­—èŠ‚) -XX:+UseSerialGC\né•¿æœŸå­˜æ´»çš„å¯¹è±¡ä¼šè¿›å…¥è€å¹´ä»£ å¦‚æœå¯¹è±¡åœ¨ Eden å‡ºç”Ÿå¹¶ç»è¿‡ç¬¬ä¸€æ¬¡ Minor GC åä»ç„¶èƒ½å¤Ÿå­˜æ´»ï¼Œå¹¶ä¸”èƒ½è¢« Survivor å®¹çº³çš„è¯ï¼Œå°†è¢«ç§»åŠ¨åˆ° Survivor ç©ºé—´ä¸­ï¼Œå¹¶å°†å¯¹è±¡å¹´é¾„è®¾ä¸º1ã€‚å¯¹è±¡åœ¨ Survivor ä¸­æ¯ç†¬è¿‡ä¸€æ¬¡ MinorGCï¼Œå¹´é¾„å°±å¢åŠ 1å²ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°ä¸€å®šç¨‹åº¦ ï¼ˆé»˜è®¤ä¸º15å²ï¼ŒCMSæ”¶é›†å™¨é»˜è®¤6å²ï¼Œä¸åŒçš„åƒåœ¾æ”¶é›†å™¨ä¼šç•¥å¾®æœ‰ç‚¹ä¸åŒï¼‰ï¼Œå°±ä¼šè¢«æ™‹å‡åˆ°è€å¹´ä»£ä¸­ã€‚å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œå¯ä»¥é€šè¿‡å‚æ•° -XX:MaxTenuringThreshold æ¥è®¾ç½®ã€‚\nåŠ¨æ€åˆ¤æ–­å¯èƒ½ä¸ºé•¿æœŸå¯¹è±¡ é™¤äº†ä¸Šè¿°çš„å¯¹è±¡å¹´é¾„ç¨³æ­¥å¢åŠ åˆ° 15 åä¼šç§»åˆ°è€å¹´ä»£ä¹‹å¤–ã€‚è¿˜æœ‰ä¸€ç§åŠ¨æ€è®¡ç®—å¹´é¾„çš„æ–¹æ³•:\nå½“å‰æ”¾å¯¹è±¡çš„SurvivoråŒºåŸŸé‡Œ(å…¶ä¸­ä¸€å—åŒºåŸŸï¼Œæ”¾å¯¹è±¡çš„é‚£å—såŒº)ï¼Œä¸€æ‰¹å¯¹è±¡çš„æ€»å¤§å°å¤§äºè¿™å—SurvivoråŒºåŸŸå†…å­˜å¤§å°çš„50%(-XX:TargetSurvivorRatioå¯ä»¥æŒ‡å®š)ï¼Œé‚£ä¹ˆæ­¤æ—¶å¤§äºç­‰äºè¿™æ‰¹å¯¹è±¡å¹´é¾„æœ€å¤§å€¼çš„å¯¹è±¡ï¼Œå°±å¯ä»¥ç›´æ¥è¿›å…¥è€å¹´ä»£äº†ï¼Œä¾‹å¦‚SurvivoråŒºåŸŸé‡Œç°åœ¨æœ‰ä¸€æ‰¹å¯¹è±¡ï¼Œå¹´é¾„1+å¹´é¾„2+å¹´é¾„nçš„å¤šä¸ªå¹´é¾„å¯¹è±¡æ€»å’Œè¶…è¿‡äº†SurvivoråŒºåŸŸçš„50%ï¼Œæ­¤æ—¶å°±ä¼šæŠŠå¹´é¾„n(å«)ä»¥ä¸Šçš„å¯¹è±¡éƒ½æ”¾å…¥è€å¹´ä»£ã€‚è¿™ä¸ªè§„åˆ™å…¶å®æ˜¯å¸Œæœ›é‚£äº›å¯èƒ½æ˜¯é•¿æœŸå­˜æ´»çš„å¯¹è±¡ï¼Œå°½æ—©è¿›å…¥è€å¹´ä»£ã€‚å¯¹è±¡åŠ¨æ€å¹´é¾„åˆ¤æ–­æœºåˆ¶ä¸€èˆ¬æ˜¯åœ¨minor gcä¹‹åè§¦å‘çš„\nåƒåœ¾å›æ”¶å™¨å¦‚ä½•å·¥ä½œ å¼•ç”¨è®¡æ•°æ³•(å·®) ç»™å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œæ¯å½“æœ‰ä¸€ä¸ªåœ°æ–¹å¼•ç”¨å®ƒï¼Œè®¡æ•°å™¨å°±åŠ 1ï¼›å½“å¼•ç”¨å¤±æ•ˆï¼Œè®¡æ•°å™¨å°±å‡1ï¼›ä»»ä½•æ—¶å€™è®¡æ•°å™¨ä¸º0çš„å¯¹è±¡å°±æ˜¯ä¸å¯èƒ½å†è¢«ä½¿ç”¨çš„ã€‚\nè¿™ç§æ–¹æ³•å®ç°ç®€å•ï¼Œæ•ˆç‡é«˜ï¼Œå½“æ—¶ç›®å‰ä¸»æµçš„è™šæ‹Ÿæœºå¹¶æ²¡æœ‰é€‰æ‹©è¿™ç§ç®—æ³•ï¼Œä¸»è¦ä»–å­˜åœ¨å¾ªç¯å¼•ç”¨çš„é—®é¢˜:\næ‰€è°“å¯¹è±¡ä¹‹é—´çš„ç›¸äº’å¼•ç”¨é—®é¢˜ï¼Œé™¤äº†å¯¹è±¡objA å’Œ objB ç›¸äº’å¼•ç”¨ç€å¯¹æ–¹ä¹‹å¤–ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡ä¹‹é—´å†æ— ä»»ä½•å¼•ç”¨ã€‚ä½†æ˜¯ä»–ä»¬å› ä¸ºäº’ç›¸å¼•ç”¨å¯¹æ–¹ï¼Œå¯¼è‡´å®ƒä»¬çš„å¼•ç”¨è®¡æ•°å™¨éƒ½ä¸ä¸º0ï¼Œäºæ˜¯å¼•ç”¨è®¡æ•°ç®—æ³•æ— æ³•é€šçŸ¥ GC å›æ”¶å™¨å›æ”¶ä»–ä»¬\nå¯è¾¾æ€§åˆ†æç®—æ³• å°† GC Roots å¯¹è±¡ä½œä¸ºèµ·ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢å¼•ç”¨çš„å¯¹è±¡ï¼Œæ‰¾åˆ°çš„å¯¹è±¡éƒ½æ ‡è®°ä¸ºéåƒåœ¾å¯¹è±¡ï¼Œå…¶ä½™æœªæ ‡è®°çš„å¯¹è±¡éƒ½æ˜¯åƒåœ¾å¯¹è±¡\nGC Roots å¯¹è±¡å¼•ç”¨çš„æ ¹èŠ‚ç‚¹: çº¿ç¨‹æ ˆçš„æœ¬åœ°å˜é‡ã€é™æ€å˜é‡ã€æœ¬åœ°æ–¹æ³•æ ˆçš„å˜é‡ç­‰ç­‰\nå¸¸è§çš„å¼•ç”¨ç±»å‹ javaçš„å¼•ç”¨ç±»å‹ä¸€èˆ¬åˆ†ä¸ºå››ç§ï¼šå¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨ã€è™šå¼•ç”¨\nå¼ºå¼•ç”¨ æ™®é€šçš„å˜é‡å¼•ç”¨\npublic static User user = new User(); è½¯å¼•ç”¨ å°†å¯¹è±¡ç”¨SoftReferenceè½¯å¼•ç”¨ç±»å‹çš„å¯¹è±¡åŒ…è£¹ï¼Œæ­£å¸¸æƒ…å†µä¸ä¼šè¢«å›æ”¶ï¼Œä½†æ˜¯GCåšå®Œåå‘ç°é‡Šæ”¾ä¸å‡ºç©ºé—´å­˜æ”¾\næ–°çš„å¯¹è±¡ï¼Œåˆ™ä¼šæŠŠè¿™äº›è½¯å¼•ç”¨çš„å¯¹è±¡å›æ”¶æ‰ã€‚è½¯å¼•ç”¨å¯ç”¨æ¥å®ç°å†…å­˜æ•æ„Ÿçš„é«˜é€Ÿç¼“å­˜ã€‚\npublic static SoftReference\u0026lt;User\u0026gt; user = new SoftReference\u0026lt;User\u0026gt;(new User()); è½¯å¼•ç”¨åœ¨å®é™…ä¸­æœ‰é‡è¦çš„åº”ç”¨ï¼Œä¾‹å¦‚æµè§ˆå™¨çš„åé€€æŒ‰é’®ã€‚æŒ‰åé€€æ—¶ï¼Œè¿™ä¸ªåé€€æ—¶æ˜¾ç¤ºçš„ç½‘é¡µå†…å®¹æ˜¯é‡æ–°è¿›è¡Œè¯·æ±‚è¿˜æ˜¯ä»\nç¼“å­˜ä¸­å–å‡ºå‘¢ï¼Ÿè¿™å°±è¦çœ‹å…·ä½“çš„å®ç°ç­–ç•¥äº†ã€‚\nï¼ˆ1ï¼‰å¦‚æœä¸€ä¸ªç½‘é¡µåœ¨æµè§ˆç»“æŸæ—¶å°±è¿›è¡Œå†…å®¹çš„å›æ”¶ï¼Œåˆ™æŒ‰åé€€æŸ¥çœ‹å‰é¢æµè§ˆè¿‡çš„é¡µé¢æ—¶ï¼Œéœ€è¦é‡æ–°æ„å»º\nï¼ˆ2ï¼‰å¦‚æœå°†æµè§ˆè¿‡çš„ç½‘é¡µå­˜å‚¨åˆ°å†…å­˜ä¸­ä¼šé€ æˆå†…å­˜çš„å¤§é‡æµªè´¹ï¼Œç”šè‡³ä¼šé€ æˆå†…å­˜æº¢å‡º\nå¼±å¼•ç”¨ å°†å¯¹è±¡ç”¨WeakReferenceè½¯å¼•ç”¨ç±»å‹çš„å¯¹è±¡åŒ…è£¹ï¼Œå¼±å¼•ç”¨è·Ÿæ²¡å¼•ç”¨å·®ä¸å¤šï¼ŒGCä¼šç›´æ¥å›æ”¶æ‰ï¼Œå¾ˆå°‘ç”¨\npublic static WeakReference\u0026lt;User\u0026gt; user = new WeakReference\u0026lt;User\u0026gt;(new User()); è™šå¼•ç”¨ è™šå¼•ç”¨ä¹Ÿç§°ä¸ºå¹½çµå¼•ç”¨æˆ–è€…å¹»å½±å¼•ç”¨ï¼Œå®ƒæ˜¯æœ€å¼±çš„ä¸€ç§å¼•ç”¨å…³ç³»ï¼Œå‡ ä¹ä¸ç”¨\næ–¹æ³•åŒºçš„å›æ”¶ æ–¹æ³•åŒºä¸»è¦å›æ”¶çš„æ˜¯æ— ç”¨çš„ç±»ï¼Œé‚£ä¹ˆå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªç±»æ˜¯æ— ç”¨çš„ç±»çš„å‘¢ï¼Ÿ\nç±»éœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢3ä¸ªæ¡ä»¶æ‰èƒ½ç®—æ˜¯ â€œæ— ç”¨çš„ç±»â€ ï¼š\nè¯¥ç±»æ‰€æœ‰çš„å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ Java å †ä¸­ä¸å­˜åœ¨è¯¥ç±»çš„ä»»ä½•å®ä¾‹ã€‚ åŠ è½½è¯¥ç±»çš„ ClassLoader å·²ç»è¢«å›æ”¶ã€‚ è¯¥ç±»å¯¹åº”çš„ java.lang.Class å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚ ","date":"2022-08-28T22:27:11Z","permalink":"https://dccmmtop.github.io/posts/jvm%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E4%B8%8E%E5%9B%9E%E6%94%B6/","section":"posts","tags":["java"],"title":"jvmå¯¹è±¡çš„å†…å­˜åˆ†é…ä¸å›æ”¶"},{"categories":null,"contents":"\n1. ç±»åŠ è½½æ£€æŸ¥ è™šæ‹Ÿæœºé‡åˆ°ä¸€æ¡ new æŒ‡ä»¤æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥è¿™ä¸ªæŒ‡ä»¤çš„å‚æ•°èƒ½å¦åœ¨å¸¸é‡æ± ä¸­æ‰¾åˆ°ä¸€ä¸ªç±»ç¬¦å·å¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•ç”¨ä»£è¡¨çš„ç±»æ˜¯å¦å·²ç»è¢«åŠ è½½ï¼Œè§£æï¼Œåˆå§‹åŒ–è¿‡ã€‚å¦‚æœæ²¡æœ‰å¿…é¡»å…ˆæ‰§è¡Œç±»çš„åŠ è½½åˆå§‹åŒ–è¿‡ç¨‹ã€‚\n2. åˆ†é…å†…å­˜ åœ¨ç±»åŠ è½½æ£€æŸ¥é€šè¿‡åï¼Œæ¥ç€å°±å¯ä»¥ä¸ºæ–°ç”Ÿå¯¹è±¡åˆ’åˆ†å†…å­˜äº†ï¼Œå¯¹è±¡å ç”¨å†…å­˜çš„å¤§å°åœ¨ç±»åŠ è½½åå°±å¯ä»¥å®Œå…¨ç¡®å®šã€‚ä¸ºå¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´å°±ç›¸å½“äºæŠŠä¸€å—ç¡®å®šå¤§å°çš„å†…å­˜ä»javaå †ä¸­åˆ’åˆ†å‡ºæ¥\nå¦‚ä½•åˆ’åˆ†å†…å­˜å‘¢ å†…å­˜æ˜¯å¦‚ä½•åˆ’åˆ†çš„å‘¢ï¼Ÿé«˜å¹¶å‘çš„åœºæ™¯ä¸‹å¦‚ä½•ä¿è¯åŒä¸€å—ç©ºé—´ä¸ä¼šåˆ†ç»™ä¸¤ä¸ªå¯¹è±¡çš„å‘¢ï¼Ÿ\næŒ‡é’ˆç¢°æ’ Bump the pointer (é»˜è®¤) å¦‚æœè™šæ‹Ÿæœºå †ä¸­å†…å­˜æ˜¯ç»å¯¹è§„æ•´çš„ï¼Œç”¨è¿‡å’Œæ²¡ç”¨è¿‡çš„å„å ä¸€å—å®Œæ•´çš„å†…å­˜ï¼Œä¸­é—´æ”¾ç€ä¸€ä¸ªæŒ‡é’ˆä½œä¸ºåˆ†ç•Œç‚¹çš„æŒ‡ç¤ºå™¨ï¼Œåœ¨è¿›è¡Œå†…å­˜åˆ†é…æ—¶ï¼Œåªéœ€æŠŠæŒ‡é’ˆå‘ç©ºé—²åŒºåŸŸç§»åŠ¨ä¸€æ®µè·ç¦»ï¼Œä»¥æ”¾ä¸‹æ–°å¯¹è±¡ã€‚\nç©ºé—²åˆ—è¡¨ Free List å¦‚æœè™šæ‹Ÿæœºå †ä¸­çš„å†…å­˜ä¸æ˜¯è§„æ•´çš„ï¼Œç”¨è¿‡çš„å’Œæ²¡æœ‰ç”¨è¿‡çš„äº’ç›¸äº¤é”™ï¼Œå°±æ²¡æœ‰åŠæ³•ä½¿ç”¨æŒ‡é’ˆç¢°æ’çš„æ–¹æ³•ï¼›äº†ã€‚è™šæ‹Ÿæœºå¿…é¡»ç»´æŠ¤ä¸€ä¸ªåˆ—è¡¨ï¼Œæ¥è®°å½•é˜Ÿä¸­æœ‰å“ªäº›åŒºåŸŸæ˜¯ç©ºé—²çš„ã€‚åœ¨åˆ†é…å†…å­˜çš„æ—¶å€™æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—´åˆ†é…ç»™å¯¹è±¡ï¼Œå¹¶æ›´æ–°åˆ—è¡¨è®°å½•\nè§£å†³å¹¶å‘ CAS ï¼ˆcompare and swapï¼‰ è™šæ‹Ÿæœºé‡‡ç”¨CASé…ä¸Šå¤±è´¥é‡è¯•çš„æ–¹å¼ä¿è¯æ›´æ–°æ“ä½œçš„åŸå­æ€§æ¥å¯¹åˆ†é…å†…å­˜ç©ºé—´çš„åŠ¨ä½œè¿›è¡ŒåŒæ­¥å¤„ç†ã€‚\nCAS é€šå¸¸æŒ‡çš„æ˜¯è¿™æ ·ä¸€ç§åŸå­æ“ä½œï¼šé’ˆå¯¹ä¸€ä¸ªå˜é‡ï¼Œé¦–å…ˆæ¯”è¾ƒå®ƒçš„å†…å­˜å€¼ä¸æŸä¸ªæœŸæœ›å€¼æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒï¼Œå°±ç»™å®ƒèµ‹ä¸€ä¸ªæ–°å€¼ã€‚CAS æŒ‡ä»¤ä½œä¸ºä¸€ç§ç¡¬ä»¶åŸè¯­ï¼Œæœ‰ç€å¤©ç„¶çš„åŸå­æ€§ï¼Œè¿™ä¹Ÿæ­£æ˜¯ CAS çš„ä»·å€¼æ‰€åœ¨ã€‚\næœ¬åœ°çº¿ç¨‹åˆ†é…ç¼“å†²ï¼ˆThread Local Allocation Buffer TLABï¼‰ æ¯ä¸ªçº¿ç¨‹é¢„å…ˆåœ¨jvmå †ä¸­åˆ†é…ä¸€å—å†…å­˜ç©ºé—´ï¼Œçº¿ç¨‹å£°æ˜å‘¨æœŸå†…çš„å¯¹è±¡åˆ†é…éƒ½åœ¨è¿™å®ç°åˆ†é…çš„ç©ºé—´ä¸­è¿›è¡Œ\n-XX: +UseTLAB è®¾ç½®è™šæ‹Ÿæœºä½¿ç”¨TALAB -XX:-UseTLAB ä¸ä½¿ç”¨\n-XX:TLABSize æŒ‡å®šTALB çš„å¤§å°\n3. åˆå§‹åŒ– å†…å­˜åˆ†é…å®Œæˆåï¼Œè™šæ‹Ÿæœºéœ€è¦å°†åˆ†é…åˆ°çš„å†…å­˜ç©ºé—´éƒ½åˆå§‹åŒ–ä¸ºé›¶å€¼ï¼Œï¼ˆä¸åŒ…æ‹¬å¯¹è±¡å¤´ï¼‰ï¼Œè¿™ä¸€æ­¥æ“ä½œä¿è¯äº†å¯¹è±¡çš„å®ä¾‹å­—æ®µåœ¨javaä»£ç ä¸­å¯ä»¥ä¸èµ‹åˆå§‹å€¼å°±èƒ½ç›´æ¥ä½¿ç”¨ï¼Œå¦‚æœæ˜¯TLAB æ–¹å¼ï¼Œè¿™ä¸€æ­¥éª¤å°†æå‰åˆ°TLABåˆ†é…æ—¶è¿›è¡Œ\n4. è®¾ç½®å¯¹è±¡å¤´ åˆå§‹é›¶å€¼ä¹‹åï¼Œè¦è™šæ‹Ÿæœºè¦å¯¹å¯¹è±¡è¿›è¡Œä¸€äº›å¿…è¦çš„è®¾ç½®ï¼Œæ¯”å¦‚ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ï¼Œå¦‚ä½•æ‰èƒ½æ‰¾åˆ°ç±»çš„ä¸€äº›å…ƒä¿¡æ¯ï¼Œå¯¹è±¡çš„å“ˆå¸Œç ï¼Œå¯¹è±¡çš„GCåˆ†ä»£å¹´é¾„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å­˜æ”¾åœ¨å¯¹è±¡å¤´ Object-Header ä¸­ã€‚\nåœ¨HotSpotè™šæ‹Ÿæœºä¸­ï¼Œå¯¹è±¡åœ¨å†…å­˜ä¸­åˆ†å¸ƒå¯ä»¥åˆ3å„éƒ¨åˆ†ç¥–æˆï¼Œå¯¹è±¡å¤´ï¼Œå®ä¾‹æ•°æ®ï¼Œå¯¹é½å¡«å……ã€‚\nå¯¹è±¡å¤´ HotSpot è™šæ‹Ÿæœºçš„å¯¹è±¡å¤´åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†\n4.1 è‡ªèº«çš„è¿è¡Œæ•°æ® å“ˆå¸Œç  GCåˆ†ä»£å¹´é¾„ é”çŠ¶æ€æ ‡è¯† çº¿ç¨‹æŒæœ‰é” åå‘é”ID åå‘æ—¶é—´æˆ³ç­‰ å®ä¾‹æ•°æ® å­˜æ”¾å¯¹è±¡çš„å®é™…æ•°æ®\nå¯¹é½å¡«å…… ä¸æ˜¯å¿…ç„¶å­˜åœ¨ï¼Œä¹Ÿæ²¡æœ‰ç‰¹åˆ«çš„å«ä¹‰ï¼Œåªæ˜¯èµ·ç€å ä½ç¬¦çš„ä½œç”¨ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸€éƒ¨åˆ†çš„æ•°æ®å‘¢ï¼Ÿ\nè¿™å°±éœ€è¦äº†è§£ä¸€äº›è®¡ç®—æœºç»„æˆåŸç†çš„çŸ¥è¯†äº†ã€‚\nCPU ä½æ•° æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„CPU æœ‰32 ä½å’Œ64 ä½\n32ä½æ¶æ„çš„CPUæ•°æ®æ€»çº¿å®½åº¦æ˜¯32ä½ï¼Œæ¯æ¬¡å¯ä»¥ä¼ è¾“32ä½æ•°æ®ï¼Œå¯ä»¥è®¡ç®—4ä¸ªå­—èŠ‚ã€‚\n64ä½æ¶æ„çš„CPUæ•°æ®æ€»çº¿å®½åº¦æ˜¯64ä½ï¼Œæ¯æ¬¡å¯ä»¥ä¼ è¾“64ä½æ•°æ®ï¼Œå¯ä»¥è®¡ç®—8ä¸ªå­—èŠ‚ã€‚\nCPU å¯»å€ CPU åœ¨å·¥ä½œæ—¶ï¼Œä»å†…å­˜ä¸­çš„æŸä¸ªåœ°å€å–æ•°æ®ï¼Œç„¶åè¿›è¡Œè®¡ç®—ã€‚æ•°æ®æœ€å°çš„ä¿å­˜å•ä½æ—¶ ä½ (bit), ä¸ºäº†å‡å°‘CPUä¸å†…å­˜é€šä¿¡çš„æ¬¡æ•°ï¼Œè§„å®šCPUä¸€æ¬¡ä»å†…å­˜ä¸­å–8ä½æ•°æ®ï¼Œä¹Ÿå°±æ˜¯1å­—èŠ‚ã€‚å†…å­˜ä¸­æ¯ä¸€ä½ï¼ˆbitï¼‰ éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åœ°å€ã€‚\nå¯¹äº32ä½çš„CPUï¼Œåœ¨å‘å†…å­˜å–æ•°æ®æ—¶ï¼Œæ‰€èƒ½æè¿°çš„æœ€å¤§åœ°å€æ˜¯ç¬¬ 2^32 å­—èŠ‚ï¼ˆCPUä¸€æ¬¡æœ€å°‘å–1ä¸ªå­—èŠ‚ï¼Œä¸æ˜¯1ä½ï¼‰ï¼Œ2^32å­—èŠ‚ çº¦ç­‰äº 4Gï¼Œ å†…å­˜å†å¤§ï¼ŒCPU ä¹Ÿæ— æ³•è®¿é—®åˆ°ï¼Œæ‰€ä»¥32ä½çš„CPU æœ€å¤§æ”¯æŒçº¦4Gçš„å†…å­˜äº†ã€‚ åŒç†ï¼Œ64 ä½çš„CPU æ”¯æŒ 2^64 å­—èŠ‚å†…å­˜ï¼Œç­‰äº 17179869184 Tb\nJavaå¯¹è±¡æœ€å°å ç”¨ç©ºé—´ ç”±äº64 ä½çš„CPUä¸€æ¬¡èƒ½å¤„ç† 64 ä½æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯8ä¸ªå­—èŠ‚çš„æ•°æ®ï¼ŒJVM ä¹Ÿéµå¾ªè¿™ä¸ªè§„åˆ™ï¼Œè®©å¯¹è±¡çš„å†…å­˜å ç”¨æ˜¯8å­—èŠ‚çš„çš„æ•´æ•°å€ï¼ŒCPU å¤„ç†æ›´é«˜æ•ˆã€‚é‚£ä¹ˆå¦‚ä½•ä¿è¯ java å¯¹è±¡å ç”¨çš„ç©ºé—´æ°¸è¿œæ˜¯8å­—èŠ‚çš„æ•´æ•°å€å‘¢ï¼Ÿ ç­”æ¡ˆå°±æ˜¯å†…å­˜å¯¹é½ï¼Œä¸è¶³8å­—èŠ‚çš„æ•´æ•°å€ï¼Œæœ«å°¾è¡¥å……ç©ºç™½å ç”¨ç¬¦ã€‚\nJavaå¯¹è±¡çš„æŒ‡é’ˆå‹ç¼© ä¸Šè¿°çš„å†…å­˜å¯¹é½ï¼Œç›¸å½“äºæŠŠå¯¹è±¡çš„å ç”¨çš„ç©ºé—´æ‰©å¤§äº†ï¼Œä¸ä¹‹å¯¹åº”çš„ï¼ŒJVM è¿˜æœ‰å†…å­˜å‹ç¼©æœºåˆ¶ï¼š\njdk1.6 update14å¼€å§‹ï¼Œåœ¨64bitæ“ä½œç³»ç»Ÿä¸­ï¼ŒJVMæ”¯æŒæŒ‡é’ˆå‹ç¼© å¯ç”¨æŒ‡é’ˆå‹ç¼©:\u0026ndash;XX:+UseCompressedOops(é»˜è®¤å¼€å¯)ï¼Œç¦æ­¢æŒ‡é’ˆå‹ç¼©:\u0026ndash;XX:-UseCompressedOops æŒ‡é’ˆå‹ç¼©çš„å¥½å¤„ åœ¨64ä½å¹³å°çš„HotSpotä¸­ä½¿ç”¨32ä½æŒ‡é’ˆï¼Œå†…å­˜ä½¿ç”¨ä¼šå¤šå‡º1.5å€å·¦å³ï¼Œä½¿ç”¨è¾ƒå¤§æŒ‡é’ˆåœ¨ä¸»å†…å­˜å’Œç¼“å­˜ä¹‹é—´ç§»åŠ¨æ•°æ®ï¼Œå ç”¨è¾ƒå¤§å®½å¸¦ï¼ŒåŒæ—¶GCä¹Ÿä¼šæ‰¿å—è¾ƒå¤§å‹åŠ› ä¸ºäº†å‡å°‘64ä½å¹³å°ä¸‹å†…å­˜çš„æ¶ˆè€—ï¼Œå¯ç”¨æŒ‡é’ˆå‹ç¼©åŠŸèƒ½ åœ¨jvmä¸­ï¼Œ32ä½åœ°å€æœ€å¤§æ”¯æŒ4Gå†…å­˜(2çš„32æ¬¡æ–¹)ï¼Œå¯ä»¥é€šè¿‡å¯¹å¯¹è±¡æŒ‡é’ˆçš„å‹ç¼©ç¼–ç ã€è§£ç æ–¹å¼è¿›è¡Œä¼˜åŒ–ï¼Œä½¿å¾—jvmåªç”¨32ä½åœ°å€å°±å¯ä»¥æ”¯æŒæ›´å¤§çš„å†…å­˜é…ç½®(å°äºç­‰äº32G) æŒ‡é’ˆå‹ç¼©çš„æ³¨æ„ç‚¹ å †å†…å­˜å°äº4Gæ—¶ï¼Œä¸éœ€è¦å¯ç”¨æŒ‡é’ˆå‹ç¼©ï¼Œjvmä¼šç›´æ¥å»é™¤é«˜32ä½åœ°å€ï¼Œå³ä½¿ç”¨ä½è™šæ‹Ÿåœ°å€ç©ºé—´ å †å†…å­˜å¤§äº32Gæ—¶ï¼Œå‹ç¼©æŒ‡é’ˆä¼šå¤±æ•ˆï¼Œä¼šå¼ºåˆ¶ä½¿ç”¨64ä½(å³8å­—èŠ‚)æ¥å¯¹javaå¯¹è±¡å¯»å€ï¼Œè¿™å°±ä¼šå‡ºç°1çš„é—®é¢˜ï¼Œæ‰€ä»¥å †å†…å­˜ä¸è¦å¤§äº32Gä¸ºå¥½ 4.2 ç±»å‹æŒ‡é’ˆ å¯¹è±¡æŒ‡å‘ä»–ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹\n5. æ‰§è¡Œ\u0026lt;init\u0026gt;æ–¹æ³• æ‰§è¡Œ\u0026lt;init\u0026gt; æ–¹æ³•ï¼Œå°±æ˜¯æŒ‰ç…§ç¨‹åºå‘˜çš„æ„æ„¿è¿›è¡Œåˆå§‹åŒ–ï¼Œå¯¹åº”åˆ°è¯­è¨€å±‚é¢ä¸Šå°±æ˜¯ä¸ºå±æ€§èµ‹å€¼ï¼Œå’Œæ‰§è¡Œæ„é€ æ–¹æ³•\n","date":"2022-08-28T09:34:49Z","permalink":"https://dccmmtop.github.io/posts/jvm%E4%B8%AD%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B/","section":"posts","tags":["java"],"title":"jvmä¸­å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹"},{"categories":null,"contents":"\n","date":"2022-08-24T07:30:17Z","permalink":"https://dccmmtop.github.io/posts/jvm%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D/","section":"posts","tags":["java"],"title":"jvmå†…å­˜åˆ†é…"},{"categories":null,"contents":"\nçº¿ç¨‹å…±äº« æ¯ä¸ªçº¿ç¨‹å¼€å¯çš„æ—¶å€™éƒ½ä¼šåˆ’åˆ†å‡ å—å†…å­˜ç©ºé—´ï¼Œçº¿ç¨‹æ ˆï¼Œç¨‹åºè®¡æ•°å™¨ï¼Œæœ¬åœ°æ–¹æ³•æ ˆã€‚è¿™å‡ ä¸ªå†…å­˜ç©ºé—´æ˜¯ä¾é™„äºçº¿ç¨‹çš„ï¼Œçº¿ç¨‹ç»“æŸåï¼Œè¿™äº›ç©ºé—´ä¹Ÿä¼šé‡Šæ”¾\næ‰€æœ‰çº¿ç¨‹å…±äº« é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å †ï¼Œæ–¹æ³•åŒºï¼Œç±»åŠ è½½å­ç³»ç»Ÿï¼Œå­—èŠ‚ç æ‰§è¡Œå¼•æ“ã€‚è¿™äº›æ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„\næœ¬åœ°æ–¹æ³•æ ˆ æœ¬åœ°æ–¹æ³•\nç®€å•åœ°è®²ï¼Œä¸€ä¸ªNative Methodå°±æ˜¯ä¸€ä¸ªJavaè°ƒç”¨éJavaä»£ç çš„æ¥å›—ã€‚è¯¥æ–¹æ³•çš„å®ç°ç”±éJavaè¯­è¨€å®ç°ï¼Œæ¯”å¦‚Cã€‚è¿™ä¸ªç‰¹å¾å¹¶éJavaæ‰€ç‰¹æœ‰ï¼Œå¾ˆå¤šå…¶å®ƒçš„ç¼–ç¨‹è¯­è¨€éƒ½æœ‰è¿™ä¸€æœºåˆ¶ï¼Œæ¯”å¦‚åœ¨C++ä¸­ï¼Œä½ å¯ä»¥ç”¨extern \u0026ldquo;C\u0026rdquo; å‘ŠçŸ¥C++ç¼–è¯‘å™¨å»è°ƒç”¨ä¸€ä¸ªCçš„å‡½æ•°ã€‚ åœ¨å®šä¹‰ä¸€ä¸ªnative methodæ—¶ï¼Œå¹¶ä¸æä¾›å®ç°ä½“ï¼ˆæœ‰äº›åƒå®šä¹‰ä¸€ä¸ªJava interfaceï¼‰ï¼Œå› ä¸ºå…¶å®ç°ä½“æ˜¯ç”±éjavaè¯­è¨€åœ¨å¤–é¢å®ç°çš„ã€‚\nä¾‹å¦‚java.lang.Objectä¸­çš„public final native Class\u0026lt;?\u0026gt; getClass()æ–¹æ³•ï¼›åˆå¦‚java.lang.Threadä¸­çš„private native void start0()æ–¹æ³•\u0026hellip; \u0026hellip;\næœ¬åœ°æ¥å£çš„ä½œç”¨æ˜¯èåˆä¸åŒçš„ç¼–ç¨‹è¯­è¨€ä¸ºJavaæ‰€ç”¨ï¼Œå®ƒçš„åˆè¡·æ˜¯èåˆC/C++ç¨‹åºã€‚\næœ¬åœ°æ–¹æ³•æ ˆ\nJavaè™šæ‹Ÿæœºæ ˆäºç®¡ç†Javaæ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œæœ¬åœ°æ–¹æ³•æ ˆï¼ˆNative Method Stackï¼‰ç”¨äºç®¡ç†æœ¬åœ°æ–¹æ³•çš„è°ƒç”¨ã€‚\næœ¬åœ°æ–¹æ³•æ ˆï¼Œä¹Ÿæ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚ ç¨‹åºè®¡æ•°å™¨(PC) åœ¨ä»‹ç»jvmä¸­çš„ç¨‹åºè®¡æ•°å™¨(ä¸‹é¢ç®€ç§°PC)ä¹‹å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹CPU ä¸­çš„ PC:\nCPU ä¸­çš„ PC\næˆ‘ä»¬ç”¨é«˜çº§è¯­è¨€ç¼–å†™çš„å¤æ‚çš„ç¨‹åºæœ€åéƒ½ä¼šè½¬æ¢æˆ CPU å¯æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œå½“ç¨‹åºè¿è¡Œçš„çº¿ç¨‹è¢«ä¸­æ–­çš„æ—¶å€™ï¼Œéœ€è¦ç”¨ç¨‹åºè®¡æ•°å™¨è®°å½•å½“å‰æ‰§è¡Œåˆ°å“ªä¸€æ¡æŒ‡ä»¤äº†ï¼Œä¹‹åç­‰å¾…æ¢å¤çš„æ—¶å€™å†ä»ç¨‹åºè®¡æ•°å™¨ä¸­è·å–åˆ°è¢«ä¸­æ–­æ—¶æ‰§è¡Œçš„ä½ç½®ã€‚ä¹Ÿå°±æ˜¯ä¸º ä¸­æ–­â€”â€”æ¢å¤ æä¾›ä¸€ä¸ªè®°å½• CPUä¸­çš„PCæ˜¯ä¸€ä¸ªå¤§å°ä¸ºä¸€ä¸ªå­—çš„å­˜å‚¨è®¾å¤‡ï¼ˆå¯„å­˜å™¨ï¼‰ï¼Œåœ¨ä»»ä½•æ—¶å€™ï¼ŒPCä¸­å­˜å‚¨çš„éƒ½æ˜¯å†…å­˜åœ°å€ï¼ˆæ˜¯ä¸æ˜¯æœ‰ç‚¹åƒæŒ‡é’ˆï¼Ÿï¼‰ï¼Œè€ŒCPUå°±æ ¹æ®PCä¸­çš„å†…å­˜åœ°å€ï¼Œåˆ°ç›¸åº”çš„å†…å­˜å–å‡ºæŒ‡ä»¤ç„¶åæ‰§è¡Œå¹¶ä¸”åœ¨æ›´æ–°PCçš„å€¼ã€‚åœ¨è®¡ç®—æœºé€šç”µåè¿™ä¸ªè¿‡ç¨‹ä¼šä¸€ç›´ä¸æ–­çš„åå¤è¿›è¡Œã€‚è®¡ç®—æœºçš„æ ¸å¿ƒä¹Ÿåœ¨äºæ­¤ã€‚\nJVM ä¸­çš„ PC åœ¨CPUä¸­PCæ˜¯ä¸€ä¸ªç‰©ç†è®¾å¤‡ï¼Œè€Œjavaä¸­PCåˆ™æ˜¯ä¸€ä¸ªä¸€å—æ¯”è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå®ƒæ˜¯å½“å‰çº¿ç¨‹å­—èŠ‚ç æ‰§è¡Œçš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚åœ¨javaçš„æ¦‚å¿µæ¨¡å‹ä¸­ï¼Œå­—èŠ‚ç è§£é‡Šå™¨å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨ä¸­çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤çš„ï¼Œå®ƒçš„ç¨‹åºæ§åˆ¶æµçš„æŒ‡ç¤ºå™¨ï¼Œåˆ†æ”¯ï¼Œçº¿ç¨‹æ¢å¤ç­‰åŠŸèƒ½éƒ½ä¾èµ–äºè¿™ä¸ªè®¡æ•°å™¨ã€‚\næˆ‘ä»¬çŸ¥é“å¤šçº¿ç¨‹çš„å®ç°æ˜¯å¤šä¸ªçº¿ç¨‹è½®æµå ç”¨CPUè€Œå®ç°çš„ï¼Œè€Œåœ¨çº¿ç¨‹åˆ‡æ¢çš„æ—¶å€™å°±éœ€è¦ä¿å­˜å½“å‰çº¿ç¨‹çš„æ‰§è¡ŒçŠ¶æ€ï¼Œè¿™æ ·åœ¨è¿™ä¸ªçº¿ç¨‹é‡æ–°å ç”¨CPUçš„æ—¶å€™æ‰èƒ½æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€ï¼Œè€Œåœ¨JVMçŠ¶æ€çš„ä¿å­˜æ˜¯ä¾èµ–äºPCå®ç°çš„ï¼Œæ‰€ä»¥PCæ˜¯çº¿ç¨‹æ‰€ç§æœ‰çš„å†…å­˜åŒºåŸŸï¼Œè¿™ä¸ªåŒºåŸŸä¹Ÿæ˜¯javaè¿è¡Œæ—¶æ•°æ®åŒºåŸŸå”¯ä¸€ä¸ä¼šå‘ç”ŸOOMçš„åŒºåŸŸ\njvm æŒ‡ä»¤æ¦‚è§ˆ éšä¾¿æ‰¾ä¸€ä¸ªclass æ–‡ä»¶ï¼Œ æ‰§è¡Œä¸‹mainå‘½ä»¤å¯ä»¥è§£æ class æ–‡ä»¶\njavap -v App.class è¾“å‡º:\nClassfile /F:/code/java/io/dc/App.class Last modified 2022-8-19; size 1229 bytes MD5 checksum debb75f708cef09b6b1bf483b3e345ec Compiled from \u0026#34;App.java\u0026#34; public class io.dc.App minor version: 0 major version: 52 flags: ACC_PUBLIC, ACC_SUPER Constant pool: #1 = Methodref #18.#31 // java/lang/Object.\u0026#34;\u0026lt;init\u0026gt;\u0026#34;:()V #2 = Class #32 // io/dc/App$MyClassLoader #3 = String #33 // F:/code/java1 #4 = Methodref #2.#34 // io/dc/App$MyClassLoader.\u0026#34;\u0026lt;init\u0026gt;\u0026#34;:(Ljava/lang/String;)V #5 = String #35 // io.dc.User #6 = Methodref #2.#36 // io/dc/App$MyClassLoader.loadClass:(Ljava/lang/String;)Ljava/lang/Class; #7 = Methodref #37.#38 // java/lang/Class.newInstance:()Ljava/lang/Object; .... çœç•¥ public static void main(java.lang.String[]) throws java.lang.Exception; descriptor: ([Ljava/lang/String;)V flags: ACC_PUBLIC, ACC_STATIC Code: stack=3, locals=9, args_size=1 0: new #2 // class io/dc/App$MyClassLoader 3: dup 4: ldc #3 // String F:/code/java1 6: invokespecial #4 // Method io/dc/App$MyClassLoader.\u0026#34;\u0026lt;init\u0026gt;\u0026#34;:(Ljava/lang/String;)V 9: astore_1 10: aload_1 11: ldc #5 // String io.dc.User 13: invokevirtual #6 // Method io/dc/App$MyClassLoader.loadClass:(Ljava/lang/String;)Ljava/lang/Class; 16: astore_2 17: aload_2 18: invokevirtual #7 // Method java/lang/Class.newInstance:()Ljava/lang/Object; 21: astore_3 22: aload_2 23: ldc #8 // String sout å…¶ä¸­ #1 #2 #3 å°±æ˜¯ç¨‹åºè®¡æ•°å™¨ä¿å­˜çš„å†…å®¹ï¼Œå¯¹åº”æŒ‡ä»¤çš„ä½ç½®\nå¯ä»¥å»å®˜ç½‘æ‰¾åˆ°æ¯æ¡æŒ‡ä»¤çš„å«ä¹‰ï¼Œç¤ºä¾‹å¦‚ä¸‹:\næ ˆçº¿ç¨‹ æ ˆå…·æœ‰å…ˆè¿›åå‡ºçš„ç‰¹æ€§ï¼Œçº¿ç¨‹æ ˆå†…è¿˜æœ‰æ ˆå¸§çš„æ¦‚å¿µï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œæ¯é‡åˆ°ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šå¼€è¾Ÿä¸€ä¸ªæ–°çš„æ ˆå¸§æ¥å­˜æ”¾æ–¹æ³•ç›¸å…³çš„å†…å®¹ï¼Œæ ˆå¸§å†…å­˜æ”¾çš„è¿˜æœ‰å±€éƒ¨å˜é‡è¡¨ï¼Œæ“ä½œæ•°æ ˆï¼ŒåŠ¨æ€é“¾æ¥ï¼Œæ–¹æ³•å‡ºå£\næ ˆçº¿ç¨‹çš„ç©ºé—´å¯ä»¥æŒ‰éœ€è°ƒæ•´ï¼Œæœ‰æ—¶æˆ‘ä»¬ä¼šçœ‹åˆ° StackOverflow æ ˆæº¢å‡ºé”™è¯¯ï¼Œå°±æ˜¯æ ˆå¸§è¿‡å¤šï¼Œç©ºé—´ä¸å¤Ÿç”¨äº†ï¼Œå¾€å¾€å‘ç”Ÿæ— é™åˆ¶çš„é€’å½’è°ƒç”¨ä¸­ã€‚\nå±€éƒ¨å˜é‡è¡¨ é¡¾åæ€ä¹‰å°±æ˜¯å­˜æ”¾å±€éƒ¨å˜é‡çš„ä¸€ä¸ªè¡¨, å­˜æ”¾ç¼–è¯‘å™¨ç”Ÿæˆçš„å„ç§ç±»å‹\nåŸºæœ¬ç±»å‹ï¼ˆboolean,byte,char, short, float,long, doubleï¼‰ å¯¹è±¡çš„å¼•ç”¨ try catch ä¸­çš„å¼‚å¸¸ æ–¹æ³•ä¸­çš„å‚æ•° å±€éƒ¨å˜é‡è¡¨æ˜¯ä»¥æ§½(shot)ä¸ºå•ä½çš„,å…¶ä¸­64ä½é•¿åº¦ï¼ˆlong,doubleï¼‰ç±»å‹æ•°æ®å ç”¨ä¿©ä¸ªå˜é‡æ§½ï¼Œè€Œ32ä½çš„å ä¸€ä¸ªå˜é‡æ§½ã€‚\nç”¨ä¸€ä¸ªç®€å•çš„demo çœ‹ä¸€ä¸‹æ§½çš„ä½¿ç”¨\npublic class Main { public static void main(String[] args){ int a=1; int b=2; System.out.println(a+b); } } åç¼–è¯‘ä¹‹åçš„jvmæŒ‡ä»¤\npublic static void main(java.lang.String[]) throws java.io.IOException; descriptor: ([Ljava/lang/String;)V flags: ACC_PUBLIC, ACC_STATIC Code: stack=3, locals=3, args_size=1 //localå°±æ˜¯å±€éƒ¨å˜é‡è¡¨çš„å¤§å° 0: iconst_1 1: istore_1 //æ ˆé¡¶å…ƒç´ å¼¹å‡ºå­˜å…¥å˜é‡è¡¨çš„æ§½1 2: iconst_2 3: istore_2 //æ ˆé¡¶å…ƒç´ å¼¹å‡ºå­˜å…¥å˜é‡è¡¨çš„æ§½2 4: getstatic #2 // Field java/lang/System.out:Ljava/io/PrintStream; 7: iload_1 8: iload_2 9: iadd 10: invokevirtual #3 // Method java/io/PrintStream.println:(I)V 13: return LineNumberTable: line 18: 0 line 19: 2 line 20: 4 line 21: 13 LocalVariableTable: Start Length Slot Name Signature 0 14 0 args [Ljava/lang/String; 2 12 1 a I 4 10 2 b I Exceptions: throws java.io.IOException ä»ä¸Šé¢çš„å­—èŠ‚ç æ–‡ä»¶ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨javaæºä»£ç è¢«ç¼–è¯‘æˆclassæ–‡ä»¶åæ¯ä¸€ä¸ªæ–¹æ³•çš„å˜é‡è¡¨çš„å¤§å°å°±å·²ç»ç¡®å®šï¼ˆlocalsçš„å€¼ï¼‰ã€‚è€Œä¸”JVMæ˜¯é€šè¿‡ç´¢å¼•æ¥æ“ä½œå˜é‡è¡¨çš„ï¼Œå½“ä½¿ç”¨çš„æ˜¯32ä½æ•°æ®ç±»å‹æ—¶å°±ç´¢å¼•Nä»£è¡¨ä½¿ç”¨ç¬¬Nä¸ªå˜é‡æ§½ã€‚64ä½åˆ™ä»£è¡¨ç¬¬Nå’Œç¬¬N+1ä¸ªå˜é‡æ§½ï¼Œå› ä¸º64ä¸ºå ç”¨ä¸¤ä¸ªå˜é‡æ§½\næ“ä½œæ•°æ ˆ Operand Stackï¼Œå¯ä»¥ç†è§£ä¸ºå­˜æ”¾æ“ä½œæ•°çš„æ ˆã€‚å®ƒçš„å¤§å°ä¹Ÿæ˜¯åœ¨ç¼–è¯‘æœŸå°±å·²ç»ç¡®å®šå¥½äº†çš„ï¼Œå°±æ˜¯ä¸Šé¢åç¼–è¯‘ä»£ç ä¸­å‡ºç°çš„stackï¼Œæ ˆå…ƒç´ å¯ä»¥æ˜¯åŒ…æ‹¬longå’Œdoubleåœ¨å†…çš„ä»»æ„çš„javaæ•°æ®ç±»å‹ã€‚\nå½“ä¸€ä¸ªæ–¹æ³•åˆšå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œæ“ä½œæ•°æ ˆæ˜¯ç©ºçš„ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å­—èŠ‚ç æŒ‡ä»¤ä¼šå¾€æ“ä½œæ•°æ ˆå†…å†™å…¥å’Œå–å‡ºå…ƒç´ ã€‚\npublic static void main(java.lang.String[]) throws java.io.IOException; descriptor: ([Ljava/lang/String;)V flags: ACC_PUBLIC, ACC_STATIC Code: stack=3, locals=3, args_size=1 //æ ˆæ·±åº¦æœ€å¤§ä¸º3ï¼Œ3ä¸ªå˜é‡æ§½ 0: iconst_1 //å¸¸é‡1å‹å…¥æ“ä½œæ•°æ ˆ 1: istore_1 //æ ˆé¡¶å…ƒç´ å‡ºæ ˆå­˜å…¥å˜é‡æ§½1 2: iconst_2 //å¸¸é‡2å‹å…¥æ“ä½œæ•°æ ˆ 3: istore_2 //æ ˆé¡¶å…ƒç´ å‡ºæ ˆå­˜å…¥å˜é‡æ§½2 4: getstatic #2 // Field java/lang/System.out:Ljava/io/PrintStream; //è°ƒç”¨é™æ€æ–¹æ³•main 7: iload_1 //å°†å˜é‡æ§½1ä¸­å€¼å‹å…¥æ“ä½œæ•°æ ˆ 8: iload_2 //å°†å˜é‡æ§½2ä¸­å€¼å‹å…¥æ“ä½œæ•°æ ˆ 9: iadd //ä»æ ˆé¡¶å¼¹å‡ºä¿©ä¸ªå…ƒç´ ç›¸åŠ å¹¶ä¸”å‹å…¥æ“ä½œæ•°æ ˆ 10: invokevirtual #3 // Method java/io/PrintStream.println:(I)V //è°ƒç”¨è™šæ–¹æ³• 13: return //è¿”å› åŠ¨æ€é“¾æ¥ ã€‚ã€‚ã€‚ å¾…ç»­\næ–¹æ³•å‡ºå£ åœ¨æ–¹æ³•è°ƒç”¨ç»“æŸåï¼Œå¿…é¡»è¿”å›åˆ°è¯¥æ–¹æ³•æœ€åˆè¢«è°ƒç”¨æ—¶çš„ä½ç½®ï¼Œç¨‹åºæ‰èƒ½ç»§ç»­è¿è¡Œï¼Œæ‰€ä»¥åœ¨æ ˆå¸§ä¸­è¦ä¿å­˜ä¸€äº›ä¿¡æ¯ï¼Œç”¨æ¥å¸®åŠ©æ¢å¤å®ƒçš„ä¸Šå±‚ä¸»è°ƒæ–¹æ³•çš„æ‰§è¡ŒçŠ¶æ€ã€‚æ–¹æ³•è¿”å›åœ°å€å°±å¯ä»¥æ˜¯ä¸»è°ƒæ–¹æ³•åœ¨è°ƒç”¨è¯¥æ–¹æ³•çš„æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€\nå † JVMä¸­çš„å †æ˜¯ç”¨æ¥å­˜æ”¾å¯¹è±¡çš„å†…å­˜ç©ºé—´ï¼Œå‡ ä¹æ‰€æœ‰çš„Javaå¯¹è±¡ã€æ•°ç»„éƒ½å­˜å‚¨åœ¨JVMçš„å †å†…å­˜ä¸­ã€‚æ¯”å¦‚å½“æˆ‘ä»¬newä¸€ä¸ªå¯¹è±¡æˆ–è€…åˆ›å»ºä¸€ä¸ªæ•°ç»„çš„æ—¶å€™ï¼Œå°±ä¼šåœ¨å †å†…å­˜ä¸­åˆ†é…å‡ºä¸€æ®µç©ºé—´ç”¨æ¥å­˜æ”¾ã€‚ç±»åŠ è½½å™¨è¯»å–äº†ç±»æ–‡ä»¶åï¼Œéœ€è¦æŠŠç±»ã€æ–¹æ³•ã€å¸¸å˜é‡æ”¾åˆ°å †å†…å­˜ä¸­ï¼Œä¿å­˜æ‰€æœ‰å¼•ç”¨ç±»å‹çš„çœŸå®ä¿¡æ¯ï¼Œä¾¿äºåç»­çš„æ‰§è¡Œã€‚\nç‰©ç†ä¸Šå¯ä»¥ä¸æ˜¯è¿ç»­çš„ï¼Œé€»è¾‘ä¸Šæ˜¯è¿ç»­çš„\nå †æ—¶JVMåŒºåŸŸå†…å­˜å ç”¨æœ€å¤§çš„ä¸€å—ï¼Œæ—¶åƒåœ¾å›æ”¶çš„ä¸»è¦å¯¹è±¡\nå †å†…çš„åˆ’åˆ† æ–°ç”Ÿä»£ä¸è€å¹´ä»£çš„é»˜è®¤æ¯”ä¾‹ 1:2 æ–°ç”Ÿä»£åŒºçš„é»˜è®¤æ¯”ä¾‹æ˜¯ 8:1:1 åœ¨ HotSpot ä¸­ï¼ŒEden ç©ºé—´å’Œå¦å¤–ä¸¤ä¸ª SurvIvor ç©ºé—´ç¼ºçœæ‰€å çš„æ¯”ä¾‹æ˜¯ 8:1:1\nåƒåœ¾å›æ”¶ç®€è¿° éšç€ç¨‹åºçš„è¿è¡Œï¼ŒEden åŒºç©ºé—´ä¸è¶³æ—¶ä¼šè§¦å‘ä¸€æ¬¡ Minor GC , æŸ¥æ‰¾æ‰€æœ‰å¯¹ GC Root çš„å¼•ç”¨ï¼ŒåŒ…å«é—´æ¥å¼•ç”¨ã€‚ æ¯ä¸ªå¯¹è±¡éƒ½ä¼šè¢«æ ‡è®°éåƒåœ¾ï¼Œç„¶åå°†éåƒåœ¾å¤åˆ¶åˆ° Survivor S0 ä¸­ï¼ŒåŒæ—¶ç»™è¿™äº›éåƒåœ¾å¯¹è±¡æ‰“ä¸Šä¸€ä¸ªç»å†Minor GC çš„æ¬¡æ•°â€”â€” ä»£æ•°ï¼Œæ¯ç»å†ä¸€æ¬¡ Minor GC ï¼Œå°±åŠ 1, ç„¶åæ¸…ç©º Eden åŒºåŸŸï¼Œç­‰ä¸‹æ¬¡ Eden å†æ¬¡ç©ºé—´ä¸è¶³æ—¶ï¼Œæ‰§è¡Œä¸€æ¬¡ GC,å°† Eden åŒº å’Œ S0 åŒºä¸­çš„éåƒåœ¾å¤åˆ¶åˆ° S1 åŒºï¼Œ å¯¹è±¡çš„ä»£æ•°å¢åŠ 1ï¼Œç„¶åæ¸…ç©º Eden å’Œ S0 åŒºã€‚\nS0 å’Œ S1 è¿™ç§å·¦æ‰‹æ¢å³æ‰‹çš„æ–¹å¼ä¸æ˜¯æ— ä¼‘æ­¢çš„ï¼Œå½“ä»£æ•°å¢åŠ åˆ° 15 ï¼Œå°±ä¼šæŠŠå¯¹è±¡ç§»åˆ°è€å¹´ä»£ï¼Œæˆä¸ºé•¿æœŸå­˜åœ¨çš„å¯¹è±¡ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå³æ˜¯å½“ä»EdenåŒºå¤åˆ¶å†…å®¹åˆ°SurvivoråŒºæ—¶ï¼Œå¤åˆ¶å†…å®¹å¤§å°è¶…è¿‡S0æˆ–S1ä»»ä¸€åŒºåŸŸä¸€åŠå¤§å°ï¼Œä¹Ÿä¼šç›´æ¥è¢«æ”¾å…¥åˆ°è€å¹´ä»£ä¸­ï¼Œæ‰€ä»¥è€å¹´ä»£æ‰ä¼šéœ€è¦é‚£ä¹ˆå¤§çš„åŒºåŸŸ\nè™½ç„¶è€å¹´ä»£ç©ºé—´æ¯”è¾ƒå¤§ï¼Œä½†ç»ˆç©¶ä¹Ÿä¼šæœ‰æ»¡çš„æ—¶å€™ï¼Œå½“è€å¹´ä»£çš„ç©ºé—´ä¹Ÿæ»¡äº†,æ¯”è¾ƒéº»çƒ¦çš„äº‹æƒ…å°±æ¥äº†ï¼Œä¼šå¼•å‘ä¸€æ¬¡ full GCï¼Œåœ¨ full gc æ—¶ï¼Œjvm ä¼šå…ˆè§¦å‘ STW(Stop-The-World),æš‚åœæ‰€æœ‰çº¿ç¨‹ï¼Œå›æ”¶æ•´ä¸ªå†…å­˜æ¨¡å‹ä¸­çš„å†…å­˜èµ„æºï¼Œä»è€Œé€ æˆç”¨æˆ·ç”¨æˆ·å“åº”è¶…æ—¶ï¼Œæˆ–è€…ç³»ç»Ÿæ— å“åº”ï¼Œå¯¹äºå¹¶å‘é«˜çš„ç³»ç»Ÿå½±å“æå¤§ã€‚\né€šè¿‡gcæœºåˆ¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—å‡ºä¸€ä¸ªç®€å•æœ‰æ•ˆçš„JVMä¼˜åŒ–åŠæ³•ï¼Œé‚£å°±æ˜¯å‡å°‘full gcçš„æ¬¡æ•°ï¼Œå¦‚ä½•å‡å°‘å‘¢ï¼Ÿåªéœ€è¦è°ƒæ•´è€å¹´ä»£å’Œå¹´è½»ä»£çš„å†…å­˜ç©ºé—´åˆ†é…ä½¿å¾—åœ¨minor gcçš„è¿‡ç¨‹ä¸­å°½å¯èƒ½çš„æ¶ˆé™¤å¤§éƒ¨åˆ†çš„åƒåœ¾å¯¹è±¡ã€‚\næ¯”å¦‚è¿™ç§`java -Xmx3072 -Xms3072M -Xmn2048M -Xss1M\nGC Rootsï¼šåœ¨ä¸Šé¢çš„gcè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬è¿˜æåˆ°äº†JVMæ˜¯å¦‚ä½•åˆ¤æ–­åƒåœ¾å¯¹è±¡çš„ã€‚ç®€å•åœ°æ¥è¯´ï¼Œå°±æ˜¯ä»gc rootsçš„æ ¹å‡ºå‘ï¼ˆå³å±€éƒ¨å˜é‡è¡¨ä¸­çš„å¼•ç”¨å¯¹è±¡ï¼‰ï¼Œä¸€è·¯æ²¿ç€å¼•ç”¨å…³ç³»æ‰¾ï¼Œå‡¡æ˜¯èƒ½å¤Ÿè¢«æ‰¾åˆ°çš„å¯¹è±¡éƒ½æ˜¯éåƒåœ¾å¯¹è±¡ï¼Œå¹¶ä¸”ä¼šè¢«ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªå®ƒåº”è¯¥å»çš„åŒºåŸŸä¸­ã€‚å‰©ä¸‹çš„å¯¹è±¡ï¼Œä¼šåœ¨åŒºåŸŸæ¸…ç©ºæ—¶ï¼Œä¸€åŒè¢«æ¸…ç†æ‰è€Œæ— é¡»å…³å¿ƒ\njvm å‚æ•°ç®€å•ä»‹ç» â€‹ -Xmx3072Mï¼šè®¾ç½®JVMæœ€å¤§å¯ç”¨å†…å­˜ä¸º3072Mã€‚\nâ€‹ -Xms3072Mï¼šè®¾ç½®JVMåˆå§‹å†…å­˜ä¸º3072Mã€‚æ­¤å€¼å¯ä»¥è®¾ç½®ä¸-Xmxç›¸åŒï¼Œä»¥é¿å…æ¯æ¬¡åƒåœ¾å›æ”¶å®ŒæˆåJVMé‡æ–°åˆ†é…å†…å­˜ã€‚\nâ€‹ -Xmn2048Mï¼šè®¾ç½®å¹´è½»ä»£å¤§å°ä¸º2Gã€‚å¢å¤§å¹´è½»ä»£åï¼Œå°†ä¼šå‡å°å¹´è€ä»£å¤§å°ã€‚ä¸è¿‡æ­¤å€¼å¯¹ç³»ç»Ÿæ€§èƒ½å½±å“è¾ƒå¤§ï¼ŒSunå®˜æ–¹æ¨èé…ç½®ä¸ºæ•´ä¸ªå †çš„3/8ã€‚\nâ€‹ -Xss1Mï¼šè®¾ç½®æ¯ä¸ªçº¿ç¨‹çš„å †æ ˆå¤§å°ã€‚JDK5.0ä»¥åæ¯ä¸ªçº¿ç¨‹å †æ ˆå¤§å°ä¸º1Mï¼Œä»¥å‰æ¯ä¸ªçº¿ç¨‹å †æ ˆå¤§å°ä¸º256Kã€‚æ›´å…·åº”ç”¨çš„çº¿ç¨‹æ‰€éœ€å†…å­˜å¤§å°è¿›è¡Œè°ƒæ•´ã€‚åœ¨ç›¸åŒç‰©ç†å†…å­˜ä¸‹ï¼Œå‡å°è¿™ä¸ªå€¼èƒ½ç”Ÿæˆæ›´å¤šçš„çº¿ç¨‹ã€‚\næ–¹æ³•åŒº æ–¹æ³•åŒºçš„åŸºæœ¬ç†è§£ï¼š\næ–¹æ³•åŒºï¼ˆMethod Area) ä¸ Java å †ä¸€æ ·ï¼Œæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸã€‚ æ–¹æ³•åŒºåœ¨ JVM å¯åŠ¨çš„æ—¶å€™åˆ›å»ºï¼Œå¹¶ä¸”å®ƒçš„å®é™…çš„ç‰©ç†å†…å­˜ç©ºé—´å’Œ Java å †åŒºä¸€æ ·éƒ½å¯ä»¥æ˜¯ä¸è¿ç»­çš„ã€‚ æ–¹æ³•åŒºçš„å¤§å°ï¼Œè·Ÿå †ç©ºé—´ä¸€æ ·ï¼Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°æˆ–è€…å¯æ‰©å±•ã€‚ æ–¹æ³•åŒºçš„å¤§å°å†³å®šäº†ç³»ç»Ÿå¯ä»¥ä¿å­˜å¤šå°‘ä¸ªç±»ï¼Œå¦‚æœç³»ç»Ÿå®šä¹‰äº†å¤ªå¤šçš„ç±»ï¼Œå¯¼è‡´æ–¹æ³•åŒºçš„æº¢å‡ºï¼Œè™šæ‹ŸæœºåŒæ ·ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºé”™è¯¯ï¼š java.lang.OutOfMemoryError:PermGen space æˆ–è€… java.lang.OutOfMemoryError:Metaspace å…³é—­ JVM å°±ä¼šé‡Šæ”¾è¿™ä¸ªå†…å­˜åŒºåŸŸã€‚ æ–¹æ³•åŒºå†…å­˜è®¾ç½®\nå…ƒæ•°æ®å¤§å°å¯ä»¥ä½¿ç”¨å‚æ•° -XX:MetaspaceSize å’Œ -XX:MaxMetaspaceSize æŒ‡å®šã€‚ é»˜è®¤å€¼ä¾èµ–äºå¹³å°ã€‚windows ä¸‹ï¼Œ-XX:MetaspaceSize æ˜¯ 21Mï¼Œ -XX:MaxMetaspaceSize çš„å€¼æ˜¯ -1ï¼Œå³æ²¡æœ‰é™åˆ¶ã€‚ ä¸æ°¸ä¹…ä»£ä¸åŒï¼Œå¦‚æœä¸æŒ‡å®šå¤§å°ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿæœºä¼šè€—å°½æ‰€æœ‰çš„å¯ç”¨ç³»ç»Ÿå†…å­˜ã€‚å¦‚æœå…ƒæ•°æ®å‘ç”Ÿå¼‚å¸¸ï¼Œè™šæ‹Ÿæœºä¸€æ ·ä¼šæŠ›å‡ºå¼‚å¸¸ OutOfMemoryError:Metaspace -XX:MetaspaceSize è®¾ç½®åˆå§‹çš„å…ƒç©ºé—´å¤§å°ã€‚å¯¹äºä¸€ä¸ª 64 ä½çš„æœåŠ¡å™¨ JVM æ¥è¯´ï¼Œå…¶é»˜è®¤çš„ -XX:MetaspaceSize å€¼ä¸º21MB ã€‚è¿™å°±æ˜¯åˆå§‹çš„é«˜æ°´ä½çº¿ï¼Œä¸€æ—¦è§¦åŠè¿™ä¸ªæ°´ä½çº¿ï¼Œ Full GC å°†ä¼šè¢«è§¦å‘å¹¶å¸è½½æ²¡ç”¨çš„ç±»ï¼ˆå³è¿™äº›ç±»å¯¹åº”çš„ç±»åŠ è½½å™¨ä¸å†å­˜æ´»ï¼‰ï¼Œç„¶åè¿™ä¸ªé«˜æ°´ä½çº¿å°†ä¼šé‡ç½®ã€‚æ–°çš„é«˜æ°´ä½çº¿å–å†³äº GC é‡Šæ”¾äº†å¤šå°‘ç©ºé—´ã€‚å¦‚æœé‡Šæ”¾çš„ç©ºé—´ä¸è¶³ï¼Œé‚£ä¹ˆåœ¨ä¸è¶…è¿‡ MaxMetaspaceSizeæ—¶ï¼Œé€‚å½“æé«˜è¯¥å€¼ã€‚å¦‚æœé‡Šæ”¾ç©ºé—´è¿‡å¤šï¼Œåˆ™é€‚å½“é™ä½è¯¥å€¼ã€‚ å¦‚æœåˆå§‹åŒ–çš„é«˜æ°´ä½çº¿è®¾ç½®è¿‡ä½ï¼Œä¸Šè¿°é«˜æ°´ä½çº¿è°ƒæ•´æƒ…å†µä¼šå‘ç”Ÿå¾ˆå¤šæ¬¡ã€‚é€šè¿‡åƒåœ¾å›æ”¶å™¨çš„æ—¥å¿—å¯ä»¥è§‚å¯Ÿåˆ° Full GC å¤šæ¬¡è°ƒç”¨ã€‚ä¸ºäº†é¿å…é¢‘ç¹çš„GC,å»ºè®®å°† -XX:MetaSpaceSize è®¾ç½®ä¸ºä¸€ä¸ªç›¸å¯¹è¾ƒé«˜çš„å€¼ã€‚ å­˜å‚¨å†…å®¹ å®ƒç”¨äºå­˜å‚¨å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜ç­‰ã€‚\nç±»å‹ä¿¡æ¯ å¯¹æ¯ä¸ªåŠ è½½çš„ç±»å‹ï¼ˆç±» classã€æ¥å£ interfaceã€æšä¸¾enumã€æ³¨è§£annotationï¼‰ï¼ŒJVM æ–¹æ³•åŒºä¸­å­˜å‚¨ä»¥ä¸‹ç±»å‹ä¿¡æ¯ï¼š\nè¿™ä¸ªç±»å‹çš„å®Œæ•´æœ‰æ•ˆåç§°ï¼ˆå…¨å=åŒ…å.ç±»åï¼‰ è¿™ä¸ªç±»å‹ç›´æ¥çˆ¶ç±»çš„å®Œæ•´æœ‰æ•ˆåï¼ˆå¯¹äº interface æˆ–æ˜¯ java.lang.Objectï¼Œéƒ½æ²¡æœ‰çˆ¶ç±»ï¼‰ è¿™ä¸ªç±»å‹çš„ä¿®é¥°ç¬¦ï¼ˆpublic,abstract ,final çš„æŸä¸ªå­é›†ï¼‰ è¿™ä¸ªç±»å‹ç›´æ¥æ¥å£çš„ä¸€ä¸ªæœ‰åºåˆ—è¡¨ åŸŸï¼ˆField)ä¿¡æ¯ JVM å¿…é¡»åœ¨æ–¹æ³•åŒºä¸­ä¿å­˜ç±»å‹çš„æ‰€æœ‰åŸŸçš„ç›¸å…³ä¿¡æ¯ä»¥åŠåŸŸçš„å£°æ˜é¡ºåºã€‚ åŸŸçš„ç›¸å…³ä¿¡æ¯åŒ…æ‹¬ï¼šåŸŸåç§°ã€åŸŸç±»å‹ã€åŸŸä¿®é¥°ç¬¦ï¼ˆpublic,private,protected,static,final,volatile,transient çš„æŸä¸ªå­é›†) æ–¹æ³•ä¿¡æ¯ JVM å¿…é¡»ä¿å­˜æ‰€æœ‰æ–¹æ³•çš„ä»¥ä¸‹ä¿¡æ¯ï¼ŒåŒåŸŸä¿¡æ¯ä¸€æ ·åŒ…æ‹¬å£°æ˜é¡ºåº:\n1.æ–¹æ³•åç§°\n2.æ–¹æ³•çš„è¿”å›ç±»å‹\n3.æ–¹æ³•å‚æ•°çš„æ•°é‡å’Œç±»å‹ï¼ˆæŒ‰é¡ºåºï¼‰\n4.æ–¹æ³•çš„ä¿®é¥°ç¬¦ï¼ˆpublic ,private, protected , static ,final, synchronized, native,abstract çš„ä¸€ä¸ªå­é›†ï¼‰\n5.æ–¹æ³•çš„å­—èŠ‚ç ï¼ˆbytecodes)ã€æ“ä½œæ•°æ ˆã€å±€éƒ¨å˜é‡è¡¨åŠå¤§å°ï¼ˆabstract å’Œ nativeæ–¹æ³•é™¤å¤–ï¼‰\n6.å¼‚å¸¸è¡¨ ï¼ˆabstract å’Œ native æ–¹æ³•é™¤å¤–ï¼‰ æ¯ä¸ªå¼‚å¸¸å¤„ç†çš„å¼€å§‹ä½ç½®ã€ç»“æŸä½ç½®ã€ä»£ç å¤„ç†åœ¨ç¨‹åºè®¡æ•°å™¨ä¸­çš„åç§»åœ°å€ã€è¢«æ•è·çš„å¼‚å¸¸ç±»çš„å¸¸é‡æ± ç´¢å¼•\n7.non-final çš„ç±»å˜é‡ é™æ€å˜é‡å’Œç±»å…³è”åœ¨ä¸€èµ·ï¼Œéšç€ç±»çš„åŠ è½½è€ŒåŠ è½½ï¼Œä»–ä»¬æˆä¸ºç±»æ•°æ®åœ¨é€»è¾‘ä¸Šçš„ä¸€éƒ¨åˆ†ã€‚\n8.å…¨å±€å¸¸é‡ï¼šstatic final, è¢«å£°æ˜ä¸º final çš„ç±»å˜é‡çš„å¤„ç†æ–¹æ³•åˆ™ä¸åŒï¼Œæ¯ä¸ªå…¨å±€å¸¸é‡åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ä¼šè¢«åˆ†é…äº†ã€‚\nè¿è¡Œæ—¶å¸¸é‡æ±  vs å¸¸é‡æ±  æ–¹æ³•åŒºä¸­ï¼Œå†…éƒ¨åŒ…å«äº†è¿è¡Œæ—¶å¸¸é‡æ±  å­—èŠ‚ç æ–‡ä»¶ï¼Œå†…éƒ¨åŒ…å«äº†å¸¸é‡æ±  ä¸ºä»€ä¹ˆéœ€è¦å¸¸é‡æ±  ä¸€ä¸ªjavaæºæ–‡ä»¶ä¸­ç±»ã€æ¥å£ã€ç¼–è¯‘åäº§ç”Ÿä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶ã€‚è€ŒJava ä¸­çš„å­—èŠ‚ç éœ€è¦æ•°æ®æ”¯æŒï¼Œé€šå¸¸è¿™ç§æ•°æ®ä¼šå¾ˆå¤§ä»¥è‡³äºä¸èƒ½ç›´æ¥å­˜åˆ°å­—èŠ‚ç é‡Œï¼Œæ¢å¦ä¸€ç§æ–¹å¼ï¼Œå¯ä»¥å­˜åˆ°å¸¸é‡æ± ï¼Œè¿™ä¸ªå­—èŠ‚ç åŒ…å«äº†æŒ‡å‘å¸¸é‡æ± çš„å¼•ç”¨ã€‚åœ¨åŠ¨æ€é“¾æ¥çš„æ—¶å€™ä¼šç”¨åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œæ¯”å¦‚ï¼šå¦‚ä¸‹çš„ä»£ç ï¼š\npublic class SimpleClass{ public void sayHello(){ System.out.println(\u0026#34;hello\u0026#34;); } } è™½ç„¶åªæœ‰ 194 å­—èŠ‚ï¼Œä½†æ˜¯é‡Œé¢å´ä½¿ç”¨äº† Stringã€ Systemã€PrintStreamåŠ Object ç­‰ç»“æ„ã€‚è¿™é‡Œä»£ç é‡å…¶å®å·²ç»å¾ˆå°äº†ã€‚å¦‚æœä»£ç å¤šï¼Œåº”ç”¨åˆ°çš„ç»“æ„ä¼šæ›´å¤šï¼è¿™é‡Œå°±éœ€è¦å¸¸é‡æ± äº†ï¼\nå°ç»“\nå¸¸é‡æ± ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€å¼ è¡¨ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æ ¹æ®è¿™å¼ å¸¸é‡è¡¨æ‰¾åˆ°è¦æ‰§è¡Œçš„ç±»åã€æ–¹æ³•åã€å‚æ•°ç±»å‹ã€å­—é¢é‡ç­‰ç±»å‹ã€‚\nè¿è¡Œæ—¶å¸¸é‡æ±  è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRuntime Constant Pool) æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚ å¸¸é‡æ± è¡¨ï¼ˆConstant Pool Table) æ˜¯ Class æ–‡ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡ä¸ç¬¦å·åº”ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åå­˜æ”¾åˆ°æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ åœ¨åŠ è½½ç±»å’Œæ¥å£åˆ°è™šæ‹Ÿæœºåï¼Œå°±ä¼šåˆ›å»ºå¯¹åº”çš„è¿è¡Œæ—¶å¸¸é‡æ± ã€‚ JVM ä¸ºæ¯ä¸ªå·²åŠ è½½åˆ°ç±»å‹ï¼ˆç±»æˆ–æ¥å£ï¼‰éƒ½ç»´æŠ¤äº†ä¸€ä¸ªå¸¸é‡æ± ã€‚æ± ä¸­çš„æ•°æ®é¡¹åƒæ•°ç»„é¡¹ä¸€æ ·ï¼Œæ˜¯é€šè¿‡ç´¢å¼•è®¿é—®çš„ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± ä¸­åŒ…å«å¤šç§ä¸åŒçš„å¸¸é‡ï¼ŒåŒ…æ‹¬ç¼–è¯‘å™¨å°±å·²ç»æ˜ç¡®çš„æ•°å€¼å­—é¢é‡ï¼Œä¹ŸåŒ…æ‹¬åˆ°è¿è¡ŒæœŸè§£æåæ‰èƒ½å¤Ÿè·å¾—çš„æ–¹æ³•æˆ–è€…å­—æ®µå¼•ç”¨ã€‚æ­¤æ—¶ä¸å†æ˜¯å¸¸é‡æ± ä¸­çš„ç¬¦å·åœ°å€äº†ï¼Œè¿™é‡Œæ¢ä¸ºçœŸå®åœ°å€ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± ï¼Œç›¸å¯¹äº Class æ–‡ä»¶å¸¸é‡æ± çš„å¦ä¸€é‡è¦ç‰¹å¾æ˜¯ï¼šå…·å¤‡åŠ¨æ€æ€§ã€‚ è¿è¡Œæ—¶å¸¸é‡æ± ç±»ä¼¼äºä¼ ç»Ÿç¼–ç¨‹è¯­è¨€ä¸­çš„ç¬¦å·è¡¨ï¼ˆsymbol table),ä½†æ˜¯å®ƒæ‰€åŒ…å«çš„æ•°æ®å´æ¯”ç¬¦å·è¡¨è¦æ›´åŠ ä¸°å¯Œä¸€äº›ã€‚ å½“åˆ›å»ºç±»æˆ–è€…æ¥å£çš„è¿è¡Œæ—¶å¸¸é‡æ± æ—¶ï¼Œå¦‚æœæ„é€ è¿è¡Œæ—¶å¸¸é‡æ± æ‰€éœ€çš„å†…å­˜ç©ºé—´è¶…è¿‡äº†æ–¹æ³•åŒºæ‰€æä¾›çš„æœ€å¤§å€¼ï¼Œåˆ™ JVM ä¼šæŠ› OutOfMemoryError å¼‚å¸¸ã€‚ æ–¹æ³•åŒºä¸­çš„åƒåœ¾å›æ”¶ æ–¹æ³•åŒºå†…å¸¸é‡æ± ä¸­ä¸»è¦å­˜æ”¾çš„ä¸¤å¤§ç±»å¸¸é‡ï¼šå­—é¢é‡å’Œç¬¦å·å¼•ç”¨ã€‚å­—é¢é‡æ¯”è¾ƒæ¥è¿‘ Javaè¯­è¨€å±‚æ¬¡çš„å¸¸é‡æ¦‚å¿µï¼Œå¦‚æ–‡æœ¬å­—ç¬¦ä¸²ã€è¢«å£°æ˜ä¸ºfinalçš„å¸¸é‡å€¼ç­‰ã€‚è€Œç¬¦å·å¼•ç”¨åˆ™å±äºç¼–è¯‘åŸç†æ–¹é¢çš„æ¦‚å¿µï¼ŒåŒ…æ‹¬ä¸‹é¢ä¸‰ç±»å¸¸é‡ï¼š\n1.ç±»å’Œæ¥å£çš„æƒé™å®šå\n2.å­—æ®µçš„åç§°å’Œæè¿°ç¬¦\n3.æ–¹æ³•çš„åç§°å’Œæè¿°ç¬¦\nHotSpot è™šæ‹Ÿæœºå¯¹å¸¸é‡æ± çš„å›æ”¶ç­–ç•¥æ˜¯å¾ˆæ˜ç¡®çš„ï¼Œä¹‹å‰å¸¸é‡æ± ä¸­çš„å¸¸é‡æ²¡æœ‰è¢«ä»»ä½•åœ°æ–¹å¼•ç”¨ï¼Œå°±å¯ä»¥å›æ”¶ã€‚å›æ”¶åºŸå¼ƒå¸¸é‡ä¸å›æ”¶ java å †ä¸­çš„å¯¹è±¡éå¸¸ç±»ä¼¼ã€‚\nåˆ¤å®šä¸€ä¸ªå¸¸é‡æ˜¯å¦â€œåºŸå¼ƒâ€è¿˜æ˜¯ç›¸å¯¹ç®€å•çš„ï¼Œè€Œè¦åˆ¤å®šä¸€ä¸ªç±»å‹æ˜¯å¦å±äºä¸å†è¢«ä½¿ç”¨çš„ç±»çš„æ¡ä»¶å°±æ¯”è¾ƒè‹›åˆ»äº†ã€‚éœ€è¦åŒäº‹æ»¡è¶³ä¸‹é¢ä¸‰ä¸ªæ¡ä»¶ï¼š\nè¯¥ç±»çš„æ‰€æœ‰å®ä¾‹éƒ½å·²ç»è¢«å›æ”¶äº†ï¼Œä¹Ÿå°±æ˜¯ java å †ä¸­ä¸å­˜åœ¨è¯¥ç±»åŠå…¶ä»»ä½•æ´¾ç”Ÿå­ç±»çš„å®ä¾‹ã€‚ åŠ è½½è¯¥ç±»çš„ç±»åŠ è½½å™¨å·²ç»è¢«å›æ”¶ï¼Œè¿™ä¸ªæ¡ä»¶é™¤éæ˜¯ç»è¿‡ç²¾å¿ƒè®¾è®¡çš„å¯æ›¿æ¢ç±»åŠ è½½å™¨çš„åœºæ™¯å¦‚ OSGIã€JSP çš„é‡åŠ è½½ç­‰ï¼Œå¦åˆ™é€šå¸¸æ˜¯å¾ˆéš¾è¾¾æˆçš„ã€‚ è¯¥ç±»å¯¹åº”çš„ java.lang.Class å¯¹è±¡æ²¡æœ‰åœ¨ä»»ä½•åœ°æ–¹è¢«å¼•ç”¨ï¼Œæ— æ³•åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡åå°„è®¿é—®è¯¥ç±»çš„æ–¹æ³•ã€‚ ","date":"2022-08-22T07:58:28Z","permalink":"https://dccmmtop.github.io/posts/jvm%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/","section":"posts","tags":["java"],"title":"jvmå†…å­˜æ¨¡å‹"},{"categories":null,"contents":"ç±»åŠ è½½æ˜¯ä»€ä¹ˆ æŠŠç£ç›˜ä¸­çš„javaæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­çš„è¿‡ç¨‹å«åšç±»åŠ è½½\nå½“æˆ‘ä»¬ç”¨javaå‘½ä»¤è¿è¡ŒæŸä¸ªç±»çš„mainå‡½æ•°å¯åŠ¨ç¨‹åºæ—¶ï¼Œé¦–å…ˆéœ€è¦é€šè¿‡ç±»åŠ è½½å™¨æŠŠä¸»ç±»åŠ è½½åˆ°JVM. æœ‰å¦‚ä¸‹ User ç±»\npackage dc.dccmmtop; public Class User { public static void main(String[] args) { System.out.println(\u0026#34;hello\u0026#34;); } } è¿è¡Œ java dc.dccmmtop.User æ—¶ï¼Œ å…ˆè¦æ‰¾åˆ° User.Class æ–‡ä»¶ï¼ŒæŸ¥æ‰¾å…¨è·¯å¾„å°±æ˜¯ Class_PATH + {{package name}}ï¼Œå¯¹äºUserç±»æ¥è¯´ï¼Œå°±æ˜¯ {$Class_APTH}/dc/dccmmtop.User.Class\nå‡å¦‚ User.java åœ¨F:\\code, å¹¶ä¸”ä¸åœ¨Class_PATH ä¸‹ï¼Œå¯ä»¥é€šè¿‡ java -Classpath \u0026quot;F:\\code\u0026quot; ä¸´æ—¶æŒ‡å®šã€‚\nåŠ è½½ç±»ä¹‹åè¿˜æœ‰åç»­çš„æ­¥éª¤:\néªŒè¯ å‡†å¤‡ è§£æ åˆå§‹åŒ– ä½¿ç”¨ å¸è½½ è¿™ç¯‡æ–‡ç« ä¸»è¦æ¥è®²è®²ç±»åŠ è½½\nç±»åŠ è½½å™¨ ä¸äº†è§£ç±»åŠ è½½æœºåˆ¶çš„ï¼Œå¯èƒ½å°±è®¤ä¸ºï¼Œåªéœ€æ‰¾åˆ°javaæ–‡ä»¶æ‰€åœ¨çš„ç£ç›˜ä½ç½®ï¼Œç„¶åè¿›è¡Œä¸€æ¬¡è¯»æ–‡ä»¶çš„æ“ä½œä¸å°±å®Œæˆäº†åŠ è½½å˜›ï¼Œå…¶å®è¿œéå¦‚æ­¤ã€‚\næ€»æœ‰ä¸€ä¸ªåŠ è½½ç±»çš„å·¥å…·ï¼Œè¿™ä¸ªå·¥å…·å«åšç±»åŠ è½½å™¨ï¼Œåœ¨javaä»£ç ä¸­å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è·å–å½“å‰ç±»çš„ç±»åŠ è½½å™¨æ˜¯ä»€ä¹ˆ\npackage dccmmtop; public Class User { public static void main(String[] args) { System.out.println(\u0026#34;hello\u0026#34;); System.out.println(User.Class.getClassLoader()); } } å¦‚å›¾å¯ä»¥çœ‹åˆ°ç±»åŠ è½½å™¨çš„åå­—å«åš AppClassLoader\næˆ‘ä»¬å…¨å±€æœç´¢ä¸€ä¸‹è¿™ä¸ªç±»ï¼Œä¼šå‘ç°åœ¨ sun.misc.Launcher.java æ–‡ä»¶ä¸­æ‰¾åˆ°ã€‚\né‚£ä¹ˆè¿™ä¸ªAppClassLoader æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª java æ–‡ä»¶ï¼Œå®ƒåˆæ˜¯ä»€ä¹ˆæ—¶å€™è¢«åŠ è½½å¹¶åˆå§‹åŒ–çš„å‘¢ï¼Ÿ\næˆ‘ä»¬æ»šåŠ¨åˆ°æ–‡ä»¶é¡¶éƒ¨ï¼Œçœ‹åˆ° Launcher ç±»çš„æ„é€ æ–¹æ³•éƒ¨åˆ†ï¼š\næ ‡è®°1 å’Œæ ‡è®°2 å®ç°äº†ä¸€ä¸ªå•ä¾‹æ¨¡å¼ï¼Œåœ¨5 å¤„è·å–åˆ°äº† AppClassLoader å®ä¾‹ã€‚ä¹Ÿå°±æ˜¯è¯´åœ¨æŸä¸€ä¸ªåœ°æ–¹é€šè¿‡è°ƒç”¨ Launcher ç±»ä¸­çš„ getLauncher() æ–¹æ³•ï¼Œä¼šå¾—åˆ° AppClassLoader å®ä¾‹ï¼Œ é‚£ä¹ˆ getLauncher() æ–¹æ³•åˆæ˜¯åœ¨å“ªé‡Œè°ƒç”¨çš„å‘¢ï¼Ÿè¿½è¸ªåˆ°è¿™é‡Œå·²ç»æ— æ³•åœ¨javaä»£ç ä¸­æ‰¾åˆ°ä¸Šä¸€æ­¥äº†ï¼Œå…¶å®è¿™ä¸ªæ–¹æ³•æ˜¯jvm (c++å®ç°)è°ƒç”¨çš„ï¼Œå¦‚ä¸‹å›¾:\nä»¥ä¸Šå°±æ˜¯ç±»åŠ è½½çš„ä¸»è¦æ­¥éª¤äº†ã€‚ä¸‹é¢çœ‹ä¸€ä¸‹åŒäº²å§”æ´¾æœºåˆ¶\nåŒäº²å§”æ´¾æœºåˆ¶ æˆ‘ä»¬ç»§ç»­çœ‹AppClassLoader å®ä¾‹åŒ–çš„è¿‡ç¨‹ï¼š\nåœ¨5å¤„ï¼Œå®ä¾‹åŒ–äº†ä¸€ä¸ªAppClassLoaderçš„å¯¹è±¡ï¼ŒåŒæ—¶ä¼ è¿›å»äº†ä¸€ä¸ªå‚æ•° var1, è¿™ä¸ª var1 æ˜¯å¦å¤–ä¸€ä¸ªç±»åŠ è½½å™¨ExtClassLoader , æˆ‘ä»¬åœ¨è¿›å…¥ getAppClassLoader æ–¹æ³•çœ‹ä¸€çœ‹æ˜¯æ€ä¹ˆå®ç°çš„ï¼š\nå…ˆçœ‹ä¸€ä¸‹ å‡ ä¸ªClassLoadçš„ç»§æ‰¿å…³ç³»ï¼š\næœ‰ä¸Šé¢çš„ç»§æ‰¿å…³ç³»å›¾å¯ä»¥çœ‹å‡ºæ¥ï¼ŒAppClassLoader å’Œ ExtClassLoader éƒ½æ˜¯ä» ClassLoader ç»§æ‰¿æ¥çš„ã€‚\nåœ¨ Launcher() ä¸­å¯çŸ¥ï¼Œè°ƒç”¨ AppClassLoader.getAppClassLoader() æ–¹æ³•æ—¶ï¼Œ æŠŠ ExtClassLoader çš„å®ä¾‹ä½œä¸ºå‚æ•°ä¼ é€’è¿›æ¥ï¼Œæœ€ç»ˆåˆ°4è¿™ä¸€æ­¥ï¼Œä½œä¸º var2 å‚æ•°ï¼Œè°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•ï¼Œç»§ç»­è¿½è¸ªçˆ¶ç±»çš„æ„é€ æ–¹æ³•ç›´åˆ° ClassLoader :\nåœ¨ ClassLoader æ„é€ æ–¹æ³•ä¸­ï¼Œç»´æŠ¤äº†ä¸€ä¸ª parent å˜é‡ï¼Œåˆ°æ­¤æˆ‘ä»¬çŸ¥é“äº† AppClassLoader ä¸­ parent å˜é‡ä¿å­˜çš„æ˜¯ ExtClassLoaderçš„å®ä¾‹, å¦‚ä¸‹å›¾è¡¨ç¤º\nç»§ç»­çœ‹Launcher æ„é€ æ–¹æ³•ï¼š\nloadClass() æ–¹æ³•å°† Class æ–‡ä»¶åŠ è½½åˆ°jvmä¸­ï¼Œæˆ‘ä»¬è·Ÿè¸ªä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ï¼Œä¼šå‘ç°æœ€åä¼šè°ƒåˆ° æ ¹ç±»ClassLoader ä¸­ï¼š\nprotected Class\u0026lt;?\u0026gt; loadClass(String name, boolean resolve) throws ClassNotFoundException { synchronized (getClassLoadingLock(name)) { // First, check if the Class has already been loaded Class\u0026lt;?\u0026gt; c = findLoadedClass(name); if (c == null) { long t0 = System.nanoTime(); try { if (parent != null) { c = parent.loadClass(name, false); } else { c = findBootstrapClassOrNull(name); } } catch (ClassNotFoundException e) { // ClassNotFoundException thrown if Class not found // from the non-null parent Class loader } if (c == null) { // If still not found, then invoke findClass in order // to find the Class. long t1 = System.nanoTime(); c = findClass(name); // this is the defining Class loader; record the stats sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0); sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1); sun.misc.PerfCounter.getFindClasses().increment(); } } if (resolve) { resolveClass(c); } return c; } } ä¸Šé¢ä»£ç å—ä¸­çš„å¼Ÿ6è¡Œï¼ŒfindLoadedClass() , å…ˆä»å·²åŠ è½½åˆ°çš„ç±»é›†åˆä¸­æŸ¥æ‰¾æœ‰æ²¡æœ‰è¿™ä¸ªç±»ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œç›´æ¥è¿”å›ï¼Œæ²¡æœ‰å†è¿›è¡Œä¸‹ä¸€æ­¥, findLoadedClass æ–¹æ³•æºç å¦‚ä¸‹\nåˆ° native finnal Class\u0026lt;?\u0026gt; findLoadedClass0(String name); è¿™é‡Œå·²ç»æ— æ³•åœ¨å‘åè¿½è¸ªäº†ï¼Œçœ‹åˆ° naive ,è¦æ˜ç™½ ä½¿ç”¨nativeå…³é”®å­—è¯´æ˜è¿™ä¸ªæ–¹æ³•æ˜¯åŸç”Ÿå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨C/C++è¯­è¨€å®ç°çš„ï¼Œå¹¶ä¸”è¢«ç¼–è¯‘æˆäº†DLLï¼Œç”±javaå»è°ƒç”¨.\næ­¤æ—¶ User.Class æ˜¯ç¬¬ä¸€æ¬¡åŠ è½½ï¼ŒAppClassLoader ä¸­è‚¯å®šæ— æ³•åœ¨å·²åŠ è½½çš„é›†åˆä¸­æ‰¾åˆ°ï¼Œæ‰€ä»¥ç»§ç»­å‘ä¸‹èµ°åˆ°ç¬¬ 10ï¼Œ11 è¡Œ. ä¸Šé¢å·²ç»åˆ†æè¿‡ï¼ŒAppClassLoader ä¸­çš„ parent æ˜¯ ExtClassLoader , æ‰€ä»¥åœ¨11è¡Œç”± ExtClassLoader çš„å®ä¾‹æ‰§è¡Œ laodClass æ–¹æ³•ã€‚ ExtClassLoader æ²¡æœ‰è¦†å†™æ ¹ç±»ClassLoader çš„loaderClass æ–¹æ³•ï¼Œæ‰€ä»¥ä¹Ÿä¼šåˆ°è¿™é‡Œï¼Œåªä¸è¿‡ ExtClassLoader çš„ parent æ˜¯ NUllï¼Œ ä¼šèµ°åˆ°13è¡Œï¼Œè°ƒç”¨findBootstrapClassOrNull() æ–¹æ³•ï¼Œå†çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°:\nä¼šå‘ç°è¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯C++å®ç°çš„ï¼Œè™½ç„¶æˆ‘ä»¬æ— æ³•çœ‹åˆ°æºç ï¼Œä½†æ˜¯æ ¹æ®æ³¨é‡Šå¯ä»¥çŸ¥é“ï¼Œè¿™ä¸ªæ˜¯ä¿å­˜äº†å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½è¿‡çš„ç±»ã€‚\nåˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»è§è¯†è¿‡3ä¸­ä¸åŒçš„ç±»åŠ è½½å™¨äº†ï¼š\nAppClassLoader ExtClassLoader BootStrapClassLoader æˆ‘ä»¬å…ˆä¸ç®¡è¿™ä¸ªåé¢ä¸¤ä¸ªç±»åŠ è½½å™¨æ˜¯ä»€ä¹ˆï¼Œ å‡å®šä»–ä»¬ä¹Ÿæ‰¾ä¸åˆ° User.Class. ç»§ç»­å‘ä¸‹çœ‹ï¼š\næ‰§è¡Œåˆ°ç¬¬21è¡ŒfindClas()è¿™é‡Œï¼Œå†çœ‹æºç \nåœ¨A-2 è¿™ä¸€æ­¥ï¼Œucp å…¶å®ä¿å­˜çš„å°±æ˜¯å½“å‰ ClassLoader çš„ç±»åŠ è½½è·¯å¾„ï¼Œå°±ä¸å†å±•å¼€ã€‚è¦è®°ä½æ­¤æ—¶çš„ ClassLoader æ˜¯ ExtClassLoader, å‡å¦‚ä»ç„¶æ‰¾ä¸åˆ°User.Class ä¼šæ‰§è¡Œåˆ° A-3.ç„¶åè¿”å›åˆ° loadClass æ–¹æ³•ä¸­ï¼Œ æ­¤æ—¶ c æ˜¯ç©ºï¼Œç»§ç»­æ‰§è¡Œåˆ°33è¡Œï¼Œè¿”å›åˆ° AppClassLoader è°ƒç”¨ parent.getAppClassLoader å¤„ï¼Œåœ¨ AppClassLoader å®ä¾‹çš„èŒƒå›´ä¸‹ç»§ç»­å‘åæ‰§è¡Œï¼Œç„¶åå†ç»§ç»­è°ƒç”¨ findClass æ–¹æ³•ï¼Œå¦‚æœåœ¨AppClassLoaderçš„ç±»åŠ è½½è·¯å¾„ä¸­æ‰¾åˆ°User.Class æ–‡ä»¶ï¼Œå°±ä¼š æ‰§è¡Œ defindClass(name,res) æ–¹æ³•å»åŠ è½½ç±»æ–‡ä»¶äº†ã€‚\næ•´ä¸ªè¿‡ç¨‹ç”¨æ–‡å­—æè¿°èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œæ¥å¼ å›¾å°±å¾ˆæ¸…æ¥šäº†ï¼Œä¸ºä»€ä¹ˆå«åšåŒäº²å§”æ´¾ï¼š\næŠŠ loadedClassList é›†åˆç§°ä½œç¼“å­˜\nå…ˆåœ¨ AppClassLoader ä¸­ç¼“å­˜ä¸­æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°å‘ ExtClassLoader æ‰¾ï¼Œå¦‚æœèƒ½æ‰¾åˆ°ï¼Œç›´æ¥è¿”å› åœ¨ ExtClassLoader ä¸­ç¼“å­˜æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°å‘ BootStrapClassLoader æ‰¾ï¼Œå¦‚æœèƒ½æ‰¾åˆ°ï¼Œç›´æ¥è¿”å› åœ¨ BootStrapClassLoader æ‰¾ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼Œ åœ¨ ExtClassLoader ç±»è·¯å¾„é›†åˆä¸­æ‰¾ï¼Œ å¦‚æœåœ¨ ExtClassLoader ç±»è·¯å¾„é›†åˆæ‰¾ä¸åˆ°ï¼Œåœ¨ AppClassLoader ç±»è·¯å¾„é›†åˆæ‰¾ å¦‚æœåœ¨ AppClassLoader ç±»è·¯å¾„é›†åˆä¸­èƒ½æ‰¾åˆ°ï¼ŒåŠ è½½è¯¥ç±»ï¼Œå¹¶æ”¾å…¥ç¼“å­˜ã€‚æ‰¾ä¸åˆ°åˆ™æŠ¥é”™ åŒäº²æŒ‡çš„æ˜¯ ExtClassLoader å’Œ BootStrapClassLoaderï¼Œ AppClassLoader å…ˆä¸åŠ è½½ï¼Œè€Œæ˜¯å‘ä¸Šè®©å…¶â€œçˆ¶â€åŠ è½½ï¼Œçˆ¶åŠ è½½ä¸åˆ°æ—¶ï¼Œè‡ªå·±å†åŠ è½½ã€‚è¿™é‡Œçš„çˆ¶ä¸æ˜¯çˆ¶ç±»ï¼Œè€Œæ˜¯è°ƒç”¨å±‚çº§çš„å…³ç³»ã€‚\næ˜¯æ—¶å€™ä»‹ç»ä¸€ä¸‹ è¿™ä¸‰ä¸ªç±»åŠ è½½å™¨\nBootStrapClassLoader å¼•å¯¼ç±»åŠ è½½å™¨\nè´Ÿè´£åŠ è½½æ”¯æ’‘JVMè¿è¡Œçš„ä½äºJREçš„libç›®å½•ä¸‹çš„æ ¸å¿ƒç±»åº“ï¼Œæ¯”å¦‚ rt.jarã€charsets.jarç­‰\nExtClassLoader æ‰©å±•ç±»åŠ è½½å™¨\nè´Ÿè´£åŠ è½½æ”¯æ’‘JVMè¿è¡Œçš„ä½äºJREçš„libç›®å½•ä¸‹çš„extæ‰©å±•ç›®å½•ä¸­çš„JAR ç±»åŒ…\nAppClassLoader åº”ç”¨ç¨‹åºåŠ è½½å™¨\nè´Ÿè´£åŠ è½½ClassPathè·¯å¾„ä¸‹çš„ç±»åŒ…ï¼Œä¸»è¦å°±æ˜¯åŠ è½½ä½ è‡ªå·±å†™çš„é‚£äº›ç±»\næˆ‘ä»¬å¯ä»¥å†™ä»£ç éªŒè¯ä¸€ä¸‹:\npackage dccmmtop; import sun.misc.Launcher; import java.net.URL; public Class User { public static void main(String[] args) { System.out.println(String.Class.getClassLoader()); // null System.out.println(com.sun.crypto.provider.DESKeyFactory.Class.getClassLoader().getClass().getName()); //sun.misc.Launcher$ExtClassLoader System.out.println(User.Class.getClassLoader().getClass().getName()); // sun.misc.Launcher$AppClassLoader System.out.println(); System.out.println(\u0026#34;bootstrapLoaderåŠ è½½ä»¥ä¸‹æ–‡ä»¶ï¼š\u0026#34;); URL[] urls = Launcher.getBootstrapClassPath().getURLs(); for (int i = 0; i \u0026lt; urls.length; i++) { System.out.println(urls[i]); } System.out.println(); System.out.println(\u0026#34;extClassloaderåŠ è½½ä»¥ä¸‹æ–‡ä»¶ï¼š\u0026#34;); System.out.println(System.getProperty(\u0026#34;java.ext.dirs\u0026#34;)); System.out.println(); System.out.println(\u0026#34;appClassLoaderåŠ è½½ä»¥ä¸‹æ–‡ä»¶ï¼š\u0026#34;); System.out.println(System.getProperty(\u0026#34;java.Class.path\u0026#34;)); } } è¾“å…¥å¦‚ä¸‹:\nnull // å› ä¸ºè°ƒç”¨äº† c++ å®ç°ã€‚æ— æ³•è·å–åˆ°javaå¯¹è±¡ sun.misc.Launcher$ExtClassLoader sun.misc.Launcher$AppClassLoader the bootstrapLoader : null the extClassloader : sun.misc.Launcher$ExtClassLoader@77459877 the appClassLoader : sun.misc.Launcher$AppClassLoader@18b4aac2 bootstrapLoaderåŠ è½½ä»¥ä¸‹æ–‡ä»¶ï¼š file:/C:/Program%20Files/Java/jdk1.8.0_261/jre/lib/resources.jar file:/C:/Program%20Files/Java/jdk1.8.0_261/jre/lib/rt.jar file:/C:/Program%20Files/Java/jdk1.8.0_261/jre/lib/sunrsasign.jar file:/C:/Program%20Files/Java/jdk1.8.0_261/jre/lib/jsse.jar file:/C:/Program%20Files/Java/jdk1.8.0_261/jre/lib/jce.jar file:/C:/Program%20Files/Java/jdk1.8.0_261/jre/lib/charsets.jar file:/C:/Program%20Files/Java/jdk1.8.0_261/jre/lib/jfr.jar file:/C:/Program%20Files/Java/jdk1.8.0_261/jre/Classes extClassloaderåŠ è½½ä»¥ä¸‹æ–‡ä»¶ï¼š C:\\Program Files\\Java\\jdk1.8.0_261\\jre\\lib\\ext;C:\\WINDOWS\\Sun\\Java\\lib\\ext appClassLoaderåŠ è½½ä»¥ä¸‹æ–‡ä»¶ï¼š C:\\Program Files\\Java\\jdk1.8.0_261\\jre\\lib\\charsets.jar;C:\\Program Files\\Java\\jdk1.8.0_261\\jre\\lib\\deploy.jar;C:\\Program Files\\Java\\jdk1.8.0_261\\jre\\lib\\ext\\access-bridge-64.jar;C:\\Program Files\\Java\\jdk1.8.0_261\\jre\\lib\\ext\\cldrdata.jar;C:\\Program Files\\Java\\jdk1.8.0_261\\jre\\lib\\ext\\dnsns.jar;C:\\Program Files\\Java\\jdk1.8.0_261\\jre\\lib\\ext\\jaccess.jar;...çœç•¥ ä¸ºä»€ä¹ˆä½¿ç”¨åŒäº²å§”æ´¾æœºåˆ¶ æ²™ç®±å®‰å…¨æœºåˆ¶ï¼š\nè‡ªå·±å†™çš„java.lang.String.Classç±»ä¸ä¼šè¢«åŠ è½½ï¼Œè¿™æ ·ä¾¿å¯ä»¥é˜²æ­¢æ ¸å¿ƒ APIåº“è¢«éšæ„ç¯¡æ”¹\né¿å…ç±»çš„é‡å¤åŠ è½½ï¼šå½“çˆ¶äº²å·²ç»åŠ è½½äº†è¯¥ç±»æ—¶ï¼Œå°±æ²¡æœ‰å¿…è¦å­ClassLoaderå†åŠ è½½ä¸€ æ¬¡ï¼Œä¿è¯è¢«åŠ è½½ç±»çš„å”¯ä¸€æ€§\nå…¨ç›˜è´Ÿè´£å§”æ‰˜æœºåˆ¶ â€œå…¨ç›˜è´Ÿè´£â€æ˜¯æŒ‡å½“ä¸€ä¸ªClassLoderè£…è½½ä¸€ä¸ªç±»æ—¶ï¼Œé™¤éæ˜¾ç¤ºçš„ä½¿ç”¨å¦å¤–ä¸€ä¸ªClassLoderï¼Œè¯¥ç±»\næ‰€ä¾èµ–åŠå¼•ç”¨çš„ç±»ä¹Ÿç”±è¿™ä¸ªClassLoderè½½å…¥\nè‡ªå®šä¹‰ç±»åŠ è½½å™¨ ä»ä¸Šè¿°æºç çš„æè¿°å¯çŸ¥ï¼Œç±»åŠ è½½å™¨çš„æ ¸å¿ƒæ–¹æ³•æ˜¯ findClass , å’Œ defineClass ã€‚\ndefindClass å°†classæ–‡ä»¶ä»ç£ç›˜åŠ è½½æ–‡ä»¶åˆ°å†…å­˜ï¼ŒdefineClass å¼€å§‹è§£æclassæ–‡ä»¶:\næ‰€ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨åªéœ€ç»§æ‰¿ ClassLoaderï¼Œç„¶åä»å†™ findClass æ–‡ä»¶å°±è¡Œäº†ï¼š\nç›®å½•å¦‚ä¸‹:\nApp.java:\nimport java.io.FileInputStream; import java.lang.reflect.Method; public class App { static class MyClassLoader extends ClassLoader { private String classPath; public MyClassLoader(String classPath) { this.classPath = classPath; } // ä»ç£ç›˜åŠ è½½æ–‡ä»¶ private byte[] loadByte(String name) throws Exception { name = name.replaceAll(\u0026#34;\\\\.\u0026#34;, \u0026#34;/\u0026#34;); FileInputStream fis = new FileInputStream(classPath + \u0026#34;/\u0026#34; + name + \u0026#34;.class\u0026#34;); int len = fis.available(); byte[] data = new byte[len]; fis.read(data); fis.close(); return data; } // é‡å†™ protected Class\u0026lt;?\u0026gt; findClass(String name) throws ClassNotFoundException { try { byte[] data = loadByte(name); // defineClasså°†ä¸€ä¸ªå­—èŠ‚æ•°ç»„è½¬ä¸ºClasså¯¹è±¡ï¼Œè¿™ä¸ªå­—èŠ‚æ•°ç»„æ˜¯classæ–‡ä»¶è¯»å–åæœ€ç»ˆçš„å­—èŠ‚ æ•°ç»„ã€‚ return defieClass(name, data, 0, data.length); } catch (Exception e) { e.printStackTrace(); throw new ClassNotFoundException(); } } } public static void main(String args[]) throws Exception { // åˆå§‹åŒ–è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä¼šå…ˆåˆå§‹åŒ–çˆ¶ç±»ClassLoaderï¼Œå…¶ä¸­ä¼šæŠŠè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½ å™¨è®¾ç½®ä¸ºåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨AppClassLoader MyClassLoader classLoader = new MyClassLoader(\u0026#34;D:/dc_code/java\u0026#34;); // Dç›˜åˆ›å»º // åˆ›å»º io/dc å‡ çº§ç›®å½•ï¼Œå°†Userç±»çš„å¤åˆ¶ç±»User.classä¸¢å…¥è¯¥ç›®å½• Class clazz = classLoader.loadClass(\u0026#34;io.dc.User\u0026#34;); Object obj = clazz.newInstance(); // ä½¿ç”¨åå°„è°ƒç”¨ User ç±»çš„ sout æ–¹æ³• Method method = clazz.getDeclaredMethod(\u0026#34;sout\u0026#34;, null); method.invoke(obj, null); System.out.println(clazz.getClassLoader().getClass().getName()); } } æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ ç»è¿‡ä¸Šé¢çš„æºç åˆ†æå‘ç°ï¼Œä¸»è¦æ˜¯ ClassLoader ç±»ä¸­çš„laodClass æ–¹æ³•æ¥å®ç°çš„åŒäº²å§”æ´¾æœºåˆ¶ï¼Œè‡ªå·±ä¸åŠ è½½è€Œæ˜¯å…ˆè®©å…¶çˆ¶åŠ è½½ã€‚\næ‰€ä»¥ç›´æ¥å¤å†™ loadClass æ–¹æ³•å³å¯ï¼Œä¸å†æŒ‡å®šçˆ¶çº§åŠ è½½ï¼Œå½“å‰ç±»ç›´æ¥åŠ è½½ï¼Œå¦‚ä¸‹:\nimport java.io.FileInputStream; import java.lang.reflect.Method; public class App { static class MyClassLoader extends ClassLoader { private String classPath; public MyClassLoader(String classPath) { this.classPath = classPath; } // ä»ç£ç›˜åŠ è½½æ–‡ä»¶ private byte[] loadByte(String name) throws Exception { name = name.replaceAll(\u0026#34;\\\\.\u0026#34;, \u0026#34;/\u0026#34;); FileInputStream fis = new FileInputStream(classPath + \u0026#34;/\u0026#34; + name + \u0026#34;.class\u0026#34;); int len = fis.available(); byte[] data = new byte[len]; fis.read(data); fis.close(); return data; } protected Class\u0026lt;?\u0026gt; findClass(String name) throws ClassNotFoundException { try { byte[] data = loadByte(name); // defineClasså°†ä¸€ä¸ªå­—èŠ‚æ•°ç»„è½¬ä¸ºClasså¯¹è±¡ï¼Œè¿™ä¸ªå­—èŠ‚æ•°ç»„æ˜¯classæ–‡ä»¶è¯»å–åæœ€ç»ˆçš„å­—èŠ‚ æ•°ç»„ã€‚ return defineClass(name, data, 0, data.length); } catch (Exception e) { e.printStackTrace(); throw new ClassNotFoundException(); } } protected Class\u0026lt;?\u0026gt; loadClass(String name, boolean resolve) throws ClassNotFoundException { synchronized (getClassLoadingLock(name)) { // First, check if the class has already been loaded Class\u0026lt;?\u0026gt; c = findLoadedClass(name); if (c == null) { // If still not found, then invoke findClass in order // to find the class. long t1 = System.nanoTime(); if (name.startsWith(\u0026#34;io.dc\u0026#34;)) { // ç›´æ¥æŸ¥æ‰¾, é™å®šåŒ…å c = findClass(name); } else { // å…¶ä»–åŒ…ä¸­çš„ç±»è¿˜æ˜¯ä½¿ç”¨åŒäº²å§”æ´¾æœºåˆ¶ // å¦åˆ™ä¼šæŠ¥æ‰¾ä¸åˆ° Object ç±» c = this.getParent().loadClass(name); } // this is the defining class loader; record the stats sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1); sun.misc.PerfCounter.getFindClasses().increment(); } if (resolve) { resolveClass(c); } return c; } } } public static void main(String args[]) throws Exception { // åˆå§‹åŒ–è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä¼šå…ˆåˆå§‹åŒ–çˆ¶ç±»ClassLoaderï¼Œå…¶ä¸­ä¼šæŠŠè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½ å™¨è®¾ç½®ä¸ºåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨AppClassLoader MyClassLoader classLoader = new MyClassLoader(\u0026#34;D:/dc_code/java\u0026#34;); // Dç›˜åˆ›å»º // åˆ›å»º io/dc å‡ çº§ç›®å½•ï¼Œå°†Userç±»çš„å¤åˆ¶ç±»User.classä¸¢å…¥è¯¥ç›®å½• Class clazz = classLoader.loadClass(\u0026#34;io.dc.User\u0026#34;); Object obj = clazz.newInstance(); // ä½¿ç”¨åå°„è°ƒç”¨ User ç±»çš„ sout æ–¹æ³• Method method = clazz.getDeclaredMethod(\u0026#34;sout\u0026#34;, null); method.invoke(obj, null); System.out.println(clazz.getClassLoader().getClass().getName()); } } Tomcat ä¸­çš„ç±»åŠ è½½æ–¹å¼ ä¸ºä»€ä¹ˆTomcat éœ€è¦æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ tomcat æ˜¯ä¸€ä¸ªwebå®¹å™¨ã€‚å¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªwebæœåŠ¡ï¼Œæ¯ä¸ªæœåŠ¡å¯èƒ½ä¼šä¾èµ–åŒä¸€ä¸ªç±»çš„ä¸åŒç‰ˆæœ¬ï¼Œä¾‹å¦‚ æœåŠ¡A ä¾èµ– Spring 2.1.1 æœåŠ¡B ä¾èµ– Spring 2.2.2 ,æœåŠ¡A B æ‰€ä¾èµ–çš„åŒ…å + ç±»åè‚¯å®šæœ‰ä¸€æ ·çš„ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“åœ¨åŒäº²å§”æ´¾æœºåˆ¶ä¸­ä¸èƒ½åŒæ—¶å­˜åœ¨æŠ¥åå’Œç±»åä¸€æ ·çš„classæ–‡ä»¶ã€‚æ­¤æ—¶å°±éœ€è¦æ‰“ç ´ webå®¹å™¨ä¹Ÿæœ‰è‡ªå·±ä¾èµ–çš„ç±»åº“ï¼Œä¸èƒ½ä¸åº”ç”¨ç¨‹åºçš„ç±»åº“æ··æ·†ã€‚åŸºäºå®‰å…¨è€ƒè™‘ï¼Œåº”è¯¥è®©å®¹å™¨çš„ ç±»åº“å’Œç¨‹åºçš„ç±»åº“éš”ç¦»å¼€æ¥ã€‚ webå®¹å™¨è¦æ”¯æŒjspçš„ä¿®æ”¹ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œjsp æ–‡ä»¶æœ€ç»ˆä¹Ÿæ˜¯è¦ç¼–è¯‘æˆclassæ–‡ä»¶æ‰èƒ½åœ¨è™šæ‹Ÿæœºä¸­ è¿è¡Œï¼Œä½†ç¨‹åºè¿è¡Œåä¿®æ”¹jspå·²ç»æ˜¯å¸ç©ºè§æƒ¯çš„äº‹æƒ…ï¼Œ webå®¹å™¨éœ€è¦æ”¯æŒ jsp ä¿®æ”¹åä¸ç”¨é‡å¯ã€‚å¦‚æœä½¿ç”¨åŒäº²å§”æ´¾æœºåˆ¶ï¼ŒåŒä¸€ä¸ªç±»åŠ è½½è¿‡ä¸€æ¬¡å°±ä¸ä¼šå†æ¬¡åŠ è½½äº†ã€‚å¾ˆæ˜¾ç„¶ä¸èƒ½æ”¯æŒçƒ­åŠ è½½åŠŸèƒ½ã€‚tomcat æŠŠæ¯ä¸€ä¸ªjsp class æ–‡ä»¶éƒ½ç”¨ä¸€ä¸ªå•ç‹¬çš„åŠ è½½å™¨å»åŠ è½½ã€‚å¦‚æœæ£€æµ‹åˆ° jsp æ–‡ä»¶å‘ç”Ÿå˜åŠ¨ï¼Œç›´æ¥å°†ç°æœ‰çš„ jsp å¯¹åº”çš„ç±»åŠ è½½å™¨å¸è½½æ‰ï¼Œé‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„åŠ è½½å™¨å»åŠ è½½ã€‚ æ¨¡ä»¿tomcat å®ç°å¤šç‰ˆæœ¬å…±å­˜ ç”¨ä¸€ä¸ªç®€å•çš„demoæ¥å®ç° tomcat å¤šç‰ˆæœ¬å…±å­˜åŠŸèƒ½:\næœ‰ä¸¤ä¸ªæŠ¥åå’Œç±»åä¸€æ ·çš„ User ç±»:\njava1 -\u0026gt; User.java :\npackage io.dc; public class User{ public void sout (){ System.out.println(\u0026#34;user\u0026#34;); } public static void main (String[] args){ System.out.println(\u0026#34;user\u0026#34;); } } java2 -\u0026gt; User.java\npackage io.dc; public class User { public void sout() { System.out.println(\u0026#34;user1\u0026#34;); } public static void main(String[] args) { System.out.println(\u0026#34;user1\u0026#34;); } } App.java\npackage io.dc; import java.io.FileInputStream; import java.lang.reflect.Method; public class App { static class MyClassLoader extends ClassLoader { private String classPath; public MyClassLoader(String classPath) { this.classPath = classPath; } // ä»ç£ç›˜åŠ è½½æ–‡ä»¶ private byte[] loadByte(String name) throws Exception { name = name.replaceAll(\u0026#34;\\\\.\u0026#34;, \u0026#34;/\u0026#34;); FileInputStream fis = new FileInputStream(classPath + \u0026#34;/\u0026#34; + name + \u0026#34;.class\u0026#34;); int len = fis.available(); byte[] data = new byte[len]; fis.read(data); fis.close(); return data; } protected Class\u0026lt;?\u0026gt; findClass(String name) throws ClassNotFoundException { try { byte[] data = loadByte(name); // defineClasså°†ä¸€ä¸ªå­—èŠ‚æ•°ç»„è½¬ä¸ºClasså¯¹è±¡ï¼Œè¿™ä¸ªå­—èŠ‚æ•°ç»„æ˜¯classæ–‡ä»¶è¯»å–åæœ€ç»ˆçš„å­—èŠ‚ æ•°ç»„ã€‚ return defineClass(name, data, 0, data.length); } catch (Exception e) { e.printStackTrace(); throw new ClassNotFoundException(); } } protected Class\u0026lt;?\u0026gt; loadClass(String name, boolean resolve) throws ClassNotFoundException { synchronized (getClassLoadingLock(name)) { // First, check if the class has already been loaded Class\u0026lt;?\u0026gt; c = findLoadedClass(name); if (c == null) { // If still not found, then invoke findClass in order // to find the class. long t1 = System.nanoTime(); if (name.startsWith(\u0026#34;io.dc\u0026#34;)) { // ç›´æ¥æŸ¥æ‰¾, é™å®šåŒ…å c = findClass(name); } else { // å…¶ä»–åŒ…ä¸­çš„ç±»è¿˜æ˜¯ä½¿ç”¨åŒäº²å§”æ´¾æœºåˆ¶ // å¦åˆ™ä¼šæŠ¥æ‰¾ä¸åˆ° Object ç±» c = this.getParent().loadClass(name); } // this is the defining class loader; record the stats sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1); sun.misc.PerfCounter.getFindClasses().increment(); } if (resolve) { resolveClass(c); } return c; } } } public static void main(String args[]) throws Exception { // åˆå§‹åŒ–è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œä¼šå…ˆåˆå§‹åŒ–çˆ¶ç±»ClassLoaderï¼Œå…¶ä¸­ä¼šæŠŠè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½ å™¨è®¾ç½®ä¸ºåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨AppClassLoader MyClassLoader classLoader = new MyClassLoader(\u0026#34;F:/code/java1\u0026#34;); // Dç›˜åˆ›å»º // åˆ›å»º io/dc å‡ çº§ç›®å½•ï¼Œå°†Userç±»çš„å¤åˆ¶ç±»User.classä¸¢å…¥è¯¥ç›®å½• Class clazz = classLoader.loadClass(\u0026#34;io.dc.User\u0026#34;); Object obj = clazz.newInstance(); // ä½¿ç”¨åå°„è°ƒç”¨ User ç±»çš„ sout æ–¹æ³• Method method = clazz.getDeclaredMethod(\u0026#34;sout\u0026#34;, null); method.invoke(obj, null); System.out.println(clazz.getClassLoader().getClass().getName()); // ä½¿ç”¨æ–°çš„åŠ è½½å™¨åŠ è½½å¦å¤–ä¸€ä¸ª User.class MyClassLoader classLoader1 = new MyClassLoader(\u0026#34;F:/code/java2\u0026#34;); // Dç›˜åˆ›å»º // åˆ›å»º io/dc å‡ çº§ç›®å½•ï¼Œå°†Userç±»çš„å¤åˆ¶ç±»User.classä¸¢å…¥è¯¥ç›®å½• Class clazz1 = classLoader1.loadClass(\u0026#34;io.dc.User\u0026#34;); Object obj1 = clazz1.newInstance(); // ä½¿ç”¨åå°„è°ƒç”¨ User ç±»çš„ sout æ–¹æ³• Method method1 = clazz1.getDeclaredMethod(\u0026#34;sout\u0026#34;, null); method1.invoke(obj1, null); System.out.println(clazz1.getClassLoader().getClass().getName()); } } ç»“æœï¼š\næ‰€ä»¥ï¼ŒåŒä¸€ä¸ªJVMå†…ï¼Œä¸¤ä¸ªç›¸åŒåŒ…åå’Œç±»åçš„ç±»å¯¹è±¡å¯ä»¥å…±å­˜ï¼Œå› ä¸ºä»–ä»¬çš„ç±»åŠ è½½å™¨å¯ä»¥ä¸ä¸€ æ ·ï¼Œæ‰€ä»¥çœ‹ä¸¤ä¸ªç±»å¯¹è±¡æ˜¯å¦æ˜¯åŒä¸€ä¸ªï¼Œé™¤äº†çœ‹ç±»çš„åŒ…åå’Œç±»åæ˜¯å¦éƒ½ç›¸åŒä¹‹å¤–ï¼Œè¿˜éœ€è¦ä»–ä»¬çš„ç±» åŠ è½½å™¨ä¹Ÿæ˜¯åŒä¸€ä¸ªæ‰èƒ½è®¤ä¸ºä»–ä»¬æ˜¯åŒä¸€ä¸ªã€‚\n","date":"2022-08-14T14:03:08Z","permalink":"https://dccmmtop.github.io/posts/java%E4%B8%AD%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%92%8C%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%9C%BA%E5%88%B6/","section":"posts","tags":["java"],"title":"javaä¸­çš„ç±»åŠ è½½å™¨å’ŒåŒäº²å§”æ´¾æœºåˆ¶"},{"categories":null,"contents":"ç¨‹åºå‘˜éƒ½äº†è§£åˆå§‹åŒ–çš„é‡è¦æ€§ï¼Œä½†æ˜¯ä¼šå¸¸å¸¸å¿˜è®°åŒæ ·é‡è¦çš„æ¸…ç†å·¥ä½œï¼Œjavaæœ‰åƒåœ¾å›æ”¶å™¨è´Ÿè´£å›æ”¶æ— ç”¨å¯¹è±¡å ç”¨çš„å†…å­˜èµ„æºï¼Œä½†æ˜¯ä¹Ÿæœ‰ç‰¹æ®Šæƒ…å†µï¼Œä½ çš„å¯¹è±¡è·å¾—äº†ä¸€å—ç‰¹æ®Šçš„å†…å­˜åŒºåŸŸï¼Œå¹¶ä¸æ˜¯é€šè¿‡ new æ–¹æ³•ï¼Œç”±äºåƒåœ¾å›æ”¶å™¨åªçŸ¥é“é‡Šæ”¾é‚£äº›ç»ç”±newåˆ†é…çš„å†…å­˜ï¼Œ æ‰€ä»¥å®ƒä¸çŸ¥é“å¦‚ä½•é‡Šæ”¾è¿™äº›ç‰¹æ®Šçš„å†…å­˜ã€‚\njava è€ƒè™‘åˆ°è¿™ç§æƒ…å†µï¼Œå…è®¸åœ¨ç±»ä¸­å®šä¹‰ä¸€ä¸ªåä¸º finalize() çš„æ–¹æ³•ã€‚ä»–çš„å·¥ä½œåŸç†æ˜¯è¿™æ ·çš„ï¼šä¸€æ—¦åƒåœ¾å›æ”¶å™¨å‡†å¤‡é‡Šæ”¾å¯¹è±¡å ç”¨çš„å­˜å‚¨ç©ºé—´ï¼Œå°†é¦–å…ˆè°ƒç”¨ finalize() æ–¹æ³•ï¼Œå¹¶åœ¨ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶åŠ¨ä½œå‘ç”Ÿæ—¶ï¼Œæ‰ä¼šçœŸæ­£çš„å›æ”¶å¯¹è±¡å ç”¨çš„å†…å­˜ã€‚å°±åƒä¸ºåƒåœ¾å›æ”¶å™¨æ·»åŠ ä¸€ä¸ªå›è°ƒæ–¹æ³•ä¸€æ ·ã€‚\næ³¨æ„: åƒåœ¾å›æ”¶å¹¶ä¸èƒ½ä¿è¯ä¸€å®šèƒ½å‘ç”Ÿï¼Œä¹Ÿè®¸ä½ ä¼šå‘ç°ï¼Œåªè¦ç¨‹åºæ²¡æœ‰æ¿’ä¸´å­˜å‚¨ç©ºé—´ç”¨å®Œçš„é‚£ä¸€åˆ»ï¼Œå¯¹è±¡å ç”¨çš„ç©ºé—´æ°¸è¿œå¾—ä¸åˆ°é‡Šæ”¾ï¼Œç”šè‡³ç¨‹åºè¿è¡Œç»“æŸ åƒåœ¾å›æ”¶å™¨ä¹Ÿæ²¡æœ‰é‡Šæ”¾ä½ åˆ›å»ºçš„ä»»ä½•å¯¹è±¡çš„å­˜å‚¨ç©ºé—´ï¼Œè€Œæ˜¯éšç€æ“ä½œç¨‹åºçš„é€€å‡ºï¼Œå°†èµ„æºå…¨éƒ¨è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œè¿™ä¸ªç­–ç•¥æ˜¯æ°å½“çš„ï¼Œå› ä¸ºåƒåœ¾å›æ”¶æœ¬èº«ä¹Ÿæœ‰å¼€é”€ï¼Œè¦æ˜¯ä¸å®ç”¨å®ƒï¼Œä¹Ÿå°±ä¸ç”¨æ”¯ä»˜è¿™éƒ¨åˆ†å¼€é”€äº†ã€‚\nfinalize ç”¨æˆ·ä½•åœ¨ åˆ°æ­¤æˆ‘ä»¬åº”è¯¥æ˜ç™½ï¼Œä¸è¯¥å°† finalize () ä½œä¸ºé€šç”¨çš„æ¸…ç†æ–¹æ³•ï¼Œè¯·è®°ä½é‡è¦çš„ä¸€ç‚¹ï¼Œåƒåœ¾å›æ”¶åº”è¯¥åªä¸å†…å­˜æœ‰å…³ã€‚æ‰€ä»¥å’Œåƒåœ¾å›æ”¶æœ‰å…³çš„ä»»ä½•è¡Œä¸ºå°¤å…¶æ˜¯finalize æ–¹æ³•ï¼Œä»–ä»¬ä¹Ÿå¿…é¡»åŒå†…å­˜åŠå…¶å›æ”¶æœ‰å…³\nä¸Šé¢è¯´çš„ç‰¹æ®Šçš„å†…å­˜åŒºåŸŸæ˜¯æ€ä¹ˆåˆ›å»ºå‡ºæ¥çš„å‘¢ï¼Ÿ\nå› ä¸ºjavaä¸­ä¸€åˆ‡éƒ½æ˜¯å¯¹è±¡ï¼Œä»»ä½•åŒºåŸŸä¸­çš„å†…å­˜éƒ½æ˜¯ä¾é™„äºå¯¹è±¡çš„ï¼Œè¿™æ ·å°±å°†è¿™éƒ¨åˆ†åŒºåŸŸé™åˆ¶åˆ°å¾ˆå°‘çš„åœºæ™¯ã€‚é‚£å°±æ˜¯å¯èƒ½åœ¨javaä¸­ä½¿ç”¨äº†ç±»ä¼¼ä¸ Cè¯­è¨€ malloc() æ–¹æ³•æ¥åˆ†é…å†…å­˜ã€‚é€šè¿‡è¿™ç§æ–¹å¼åˆ†é…å†…å­˜ï¼Œåªèƒ½ä½¿ç”¨ free() æ–¹æ³•æ¥é‡Šæ”¾ï¼Œå¦åˆ™å°±ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²ã€‚\nç°åœ¨æˆ‘ä»¬åº”è¯¥æ˜ç™½ï¼Œä¸è¦è¿‡å¤šçš„ä½¿ç”¨ finalize() æ–¹æ³•çš„é“ç†äº†ï¼Œå› ä¸ºä»–ç¡®å®ä¸æ˜¯è¿›è¡Œæ™®é€šçš„æ¸…ç†å·¥ä½œçš„åˆé€‚åœºæ‰€ã€‚\nå‚è€ƒèµ„æ–™\nã€ŠThink in Javaã€‹ ","date":"2022-08-07T20:32:09Z","permalink":"https://dccmmtop.github.io/posts/finalize%E7%9A%84%E6%84%8F%E4%B9%89/","section":"posts","tags":["java"],"title":"finalizeçš„æ„ä¹‰"},{"categories":null,"contents":"ä»‹ç» BufferPool ä¹‹å‰ï¼Œå…ˆæŠ›å‡ºä¸€ä¸ªé—®é¢˜ï¼Œæ¯æ¬¡æ›´æ–°ï¼Œæ–°å¢ï¼Œåˆ é™¤çš„åŠ¨ä½œï¼Œéƒ½ä¼šå»å†™ç£ç›˜å—ï¼Ÿå¦‚æœæ˜¯ï¼Œé‚£æ ·æ•ˆç‡ä¼šä¸ä¼šå¾ˆä½ï¼Œå¦‚æœä¸æ˜¯ï¼Œæ€ä¹ˆä¿è¯æ•°æ®ä¸ä¼šä¸¢å¤±ï¼Ÿ\nä¸ä¼šå®æ—¶å†™å…¥ç£ç›˜ å¦‚æœæ¯æ¬¡å¯¹æ•°æ®çš„æ“ä½œéƒ½è¦å®æ—¶åŒæ­¥åˆ°ç¡¬ç›˜ä¸­,é‚£ä¹ˆå°†è¦äº§ç”Ÿå¤§é‡çš„IOï¼Œå¹¶ä¸”æ˜¯éšæœºIOï¼Œå› ä¸ºæ— æ³•ä¿è¯è¿™å†™è¢«å†™å…¥çš„æ•°æ®æ˜¯åœ¨ç£ç›˜çš„ç›¸é‚»åŒºåŸŸã€‚éšæœºIOçš„æ€§èƒ½æ˜¯éå¸¸å·®çš„ã€‚å½“ç„¶ä¸èƒ½å®æ—¶çš„å†™å…¥ç£ç›˜ï¼Œè€Œæ˜¯æš‚æ—¶æŠŠè¿™äº›æ•°æ®ä¿å­˜åˆ°ä¸€å—å†…å­˜åŒºåŸŸä¸­ï¼Œç­‰ç§¯ç´¯åˆ°ä¸€å®šå¤§å°æˆ–è€…ä¸€å®šæ—¶é—´åï¼Œå†ç»Ÿä¸€å†™å…¥ç£ç›˜ã€‚è¿™ä¸ªæ—¶é—´æ˜¯ä¸ç¡®å®šçš„ï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šã€‚è¿™ä¸ªå†…å­˜åŒºåŸŸå°±æ˜¯MySQL ä¸­çš„BuffrPollï¼Œå¯ä»¥ç†è§£ä¸ºç¼“å­˜ã€‚\næ•°æ®ä¸ä¼šä¸¢å¤± æ—¢ç„¶æ•°æ®æ˜¯å…ˆæ”¾åˆ°å†…å­˜ä¸­çš„ï¼Œç„¶åå®šæœŸçš„å†™å…¥ç£ç›˜ï¼Œå¦‚æœåœ¨æ•°æ®è¿˜æ²¡æœ‰å†™å…¥ç£ç›˜ï¼ŒæœåŠ¡å™¨æ–­ç”µäº†æ€ä¹ˆåŠï¼Ÿé‚£æ ·æ•°æ®ä¸å°±ä¸¢äº†å—ï¼Ÿè¿˜æ€ä¹ˆä¿è¯æŒä¹…æ€§å‘¢ï¼Ÿ\nredo log ç­”æ¡ˆæ˜¯redo logï¼Œ åœ¨æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œredo log ä¼šè®°å½•äº‹åŠ¡ä¸­æ‰€æœ‰çš„å†™æ“ä½œï¼Œå’Œbin_log æ˜¯ä¸€æ ·çš„ï¼Œåªæœ‰äº‹åŠ¡ä¸­çš„å†™æ“ä½œæˆåŠŸè¢«è®°å½•åˆ°redo logä¸­ï¼Œè¯¥äº‹åŠ¡æ‰èƒ½è¢«æäº¤ã€‚å®¢æˆ·ç«¯æ‰ä¼šè®¤ä¸ºè¿™ä¸ªäº‹åŠ¡æ­£å¸¸æ‰§è¡Œäº†ã€‚redo log æ˜¯ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå†™æ“ä½œæ˜¯å®æ—¶è¢«è®°å½•åˆ°è¯¥æ–‡ä»¶ä¸­çš„ï¼Œå¦‚æœåœ¨BufferPoll\nä¸­çš„æ•°æ®æ²¡æœ‰å†™å…¥ç£ç›˜è€Œå‘ç”Ÿäº†æ•…éšœï¼Œç­‰ä¸‹æ¬¡æœåŠ¡å™¨æ¢å¤æ—¶ï¼Œå°±ä¼šå…ˆä»redo logä¸­åŠ è½½æ•°æ®åˆ°Bufferï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶æœºå†™å…¥ç£ç›˜ã€‚\nåŒæ ·éƒ½æ˜¯å®æ—¶å†™å…¥ç£ç›˜ï¼Œä¸ºä»€ä¹ˆredo log å¯ä»¥æ¥å—å‘¢ï¼Ÿ å› ä¸ºå†™å…¥logæ—¶ï¼Œæ˜¯é¡ºåºIOï¼Œæå‰åˆ†é…ä¸€å—ç£ç›˜ç©ºé—´ï¼Œé¡ºåºè¿½åŠ å°±è¡Œäº†ã€‚é¡ºåºIOæ¯”ç£ç›˜IOæ•ˆç‡é«˜å¾ˆå¤š\né¡ºåºIOå’ŒéšæœºIO é¡ºåºIOæ˜¯æŒ‡è¯»å†™æ“ä½œçš„è®¿é—®åœ°å€è¿ç»­ã€‚åœ¨é¡ºåºIOè®¿é—®ä¸­ï¼ŒHDDæ‰€éœ€çš„ç£é“æœç´¢æ—¶é—´æ˜¾ç€å‡å°‘ï¼Œå› ä¸ºè¯»/å†™ç£å¤´å¯ä»¥ä»¥æœ€å°çš„ç§»åŠ¨è®¿é—®ä¸‹ä¸€ä¸ªå—ã€‚æ•°æ®å¤‡ä»½å’Œæ—¥å¿—è®°å½•ç­‰ä¸šåŠ¡æ˜¯é¡ºåºIOä¸šåŠ¡ã€‚\néšæœºIOæ˜¯æŒ‡è¯»å†™æ“ä½œæ—¶é—´è¿ç»­ï¼Œä½†è®¿é—®åœ°å€ä¸è¿ç»­ï¼Œéšæœºåˆ†å¸ƒåœ¨ç£ç›˜çš„åœ°å€ç©ºé—´ä¸­ã€‚äº§ç”ŸéšæœºIOçš„ä¸šåŠ¡æœ‰OLTPæœåŠ¡ï¼ŒSQLï¼Œå³æ—¶æ¶ˆæ¯æœåŠ¡ç­‰ã€‚\nredo log å’Œbin log redo logæ˜¯åœ¨å¼•æ“å±‚ï¼Œ bin_log æ˜¯åœ¨ server å±‚,å’Œå¼•æ“æ— å…³\nredo log æ˜¯ä¸ºäº†ä¿è¯æ•°æ®çš„æŒä¹…æ€§ï¼Œä¸ä¸¢å¤±ï¼Œé…åˆ BufferPollå‘æŒ¥ä½œç”¨\nbin log æ˜¯ä¸ºäº†æ¢å¤æ•°æ®ä½¿ç”¨\nMySQLå†…éƒ¨æ‰§è¡Œæ­¥éª¤ç»†èŠ‚å›¾ ","date":"2022-08-07T17:16:46Z","permalink":"https://dccmmtop.github.io/posts/mysql%E4%B8%AD%E7%9A%84bufferpoll%E4%B8%8Eredolog%E7%9A%84%E4%BD%9C%E7%94%A8/","section":"posts","tags":["MySQL"],"title":"MySQLä¸­çš„BufferPoolä¸RedoLogçš„ä½œç”¨"},{"categories":null,"contents":"MVCCå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶æœºåˆ¶ åœ¨ä¸Šé¢åšå®¢ä¸­ä»‹ç»äº†å¯é‡å¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹ï¼Œæ— æ³•è¯»åˆ°å…¶ä»–äº‹åŠ¡å·²æäº¤çš„æ•°æ®ï¼Œè¿™ä¸ªåŠŸèƒ½å°±æ˜¯MVCC(Multi-Version Concurrency Control)æ¥å®ç°çš„ï¼Œ\nå¯¹ä¸€è¡Œæ•°æ®çš„è¯»å’Œå†™ä¸¤ä¸ªæ“ä½œé»˜è®¤æ˜¯ä¸ä¼šé€šè¿‡åŠ é”äº’æ–¥æ¥ä¿è¯éš”ç¦»æ€§ï¼Œé¿å…äº†é¢‘ç¹åŠ é”äº’æ–¥ï¼Œè€Œåœ¨ä¸²è¡ŒåŒ–éš”ç¦»çº§åˆ«ä¸ºäº†ä¿è¯è¾ƒé«˜çš„éš”ç¦»æ€§æ˜¯é€šè¿‡å°†æ‰€æœ‰æ“ä½œåŠ é”äº’æ–¥æ¥å®ç°çš„ã€‚\nMysqlåœ¨è¯»å·²æäº¤å’Œå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹éƒ½å®ç°äº†MVCCæœºåˆ¶ã€‚\nMVCC çš„åŸç† MVCCä¸»è¦é ä¸¤ä¸ªæŠ€æœ¯æ¥å®ç°çš„ undo log å’Œ readview\nundo log undoæ—¥å¿—ç‰ˆæœ¬é“¾æ˜¯æŒ‡ä¸€è¡Œæ•°æ®è¢«å¤šä¸ªäº‹åŠ¡å¤šæ¬¡ä¿®æ”¹è¿‡åï¼Œåœ¨æ¯ä¸ªäº‹åŠ¡ä¿®æ”¹å®Œåï¼ŒMysqlä¼šä¿ç•™ä¿®æ”¹å‰çš„æ•°æ®undoå›æ»šæ—¥å¿—ï¼Œå¹¶ä¸”ç”¨ä¸¤ä¸ªéšè—å­—æ®µtrx_idå’Œroll_pointeræŠŠè¿™äº›undoæ—¥å¿—ä¸²è”èµ·æ¥å½¢æˆä¸€ä¸ªå†å²è®°å½•ç‰ˆæœ¬é“¾(è§ä¸‹å›¾)\näº‹åŠ¡å·çš„ç”Ÿæˆ\ntrx_id å°±æ˜¯äº‹åŠ¡å·ï¼Œæ¯ä¸ªäº‹åŠ¡å¼€å§‹åï¼Œé‡åˆ°ç¬¬ä¸€ä¸ªæ›´æ–°ï¼Œåˆ é™¤ï¼Œæ–°å¢çš„sqlè¯­å¥ï¼Œä¼šç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„äº‹åŠ¡ç¼–ç ã€‚è¿™ä¸ªç¼–ç æ˜¯é€’å¢çš„ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡ä¸­åªæœ‰æŸ¥è¯¢è¯­å¥ï¼Œæ˜¯ä¸ä¼šç”Ÿæˆäº‹åŠ¡å·çš„ã€‚\nbegin/startÂ transactionÂ å‘½ä»¤å¹¶ä¸æ˜¯ä¸€ä¸ªäº‹åŠ¡çš„èµ·ç‚¹ï¼Œåœ¨æ‰§è¡Œåˆ°å®ƒä»¬ä¹‹åçš„ç¬¬ä¸€ä¸ªä¿®æ”¹æ“ä½œInnoDBè¡¨çš„è¯­å¥ï¼Œäº‹åŠ¡æ‰çœŸæ­£å¯åŠ¨ï¼Œæ‰ä¼šå‘mysqlç”³è¯·äº‹åŠ¡idï¼Œmysqlå†…éƒ¨æ˜¯ä¸¥æ ¼æŒ‰ç…§äº‹åŠ¡çš„å¯åŠ¨é¡ºåºæ¥åˆ†é…äº‹åŠ¡idçš„ã€‚\nroll_pointer æ˜¯æŒ‡å‘æœ¬æ¬¡è¡Œæ•°æ®æ”¹åŠ¨ä¹‹å‰çš„ç‰ˆæœ¬æ ‡è¯†ã€‚\nç°åœ¨æ¥æè¿°ä¸€ä¸‹è¿™ä¸ªç‰ˆæœ¬é“¾æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼š\naccount è¡¨ã€‚å­—æ®µ Id å’Œ name\näº‹åŠ¡80 æ–°å¢ä¸€æ¡è®°å½• id = 1 ï¼Œ name = \u0026rsquo;lilei\u0026rsquo;, undo log ä¸­è®°å½•ä¸€æ¡è¿™æ ·çš„è¡Œæ•°æ®ï¼ŒåŒæ—¶ç»´æŠ¤äº†ä¸¤ä¸ªéšè—çš„åˆ—ï¼Œtrx_id å’Œ roll_pointer , trx_id å°±æ˜¯ 80ï¼Œ ç”±äºè¿™ä¸€è¡Œæ˜¯æ–°å¢çš„ï¼Œæ²¡æœ‰å†å²è®°å½•ï¼Œæ‰€ä»¥ roll_pointer æ˜¯ç©ºçš„, äº‹åŠ¡80æäº¤ã€‚ äº‹åŠ¡300æ›´æ–°è¿™è¡Œæ•°æ®ï¼Œ å°†name æ›´æ–°ä¸º \u0026rsquo;lilei300\u0026rsquo;, undo log åŒæ ·è®°å½•è¿™è¡Œæ•°æ®ï¼Œä¸ºäº†ä¾¿äºè¯´æ˜ï¼Œå‡è®¾ç‰ˆæœ¬è®°å½•ä¸º2 trx_id = 300, roll_pointer çš„å€¼å°±æ˜¯ 1 ç‰ˆæœ¬çš„ä½ç½®ã€‚æ³¨æ„æ­¤æ—¶äº‹åŠ¡ 300 æ²¡æœ‰æäº¤ äº‹åŠ¡100ä¹Ÿä¼šæ›´æ–°è¿™æ¡æ•°æ®ï¼Œå°† name æ›´æ–°ä¸º \u0026rsquo;lilei1\u0026rsquo; , undo log æ·»åŠ æ–°è®°å½•ï¼Œç‰ˆæœ¬è®°å½•3ï¼Œtrx_id= 100 ï¼Œ roll_pointer æŒ‡å‘ç‰ˆæœ¬2 äº‹åŠ¡100 å†æ¬¡æ›´æ–°è¿™è¡Œè®°å½•ï¼Œname = \u0026rsquo;lilei2\u0026rsquo; , undo log æ·»åŠ æ–°çºªå½•ï¼Œç‰ˆæœ¬è®°å½•æ˜¯4ï¼Œ trx_id =100, roll_pointer æŒ‡å‘ç‰ˆæœ¬3 , æ³¨æ„ï¼Œæ­¤æ—¶äº‹åŠ¡100ä»ç„¶æ²¡æœ‰æäº¤ äº‹åŠ¡200æ›´æ–°è¿™æ¡è®°å½•ï¼Œname = \u0026rsquo;lilei3\u0026rsquo;, undo log æ·»åŠ æ–°çºªå½•ï¼Œç‰ˆæœ¬è®°å½•æ˜¯5ï¼Œ trx_id = 200ï¼Œ roll_pointer æŒ‡å‘ç‰ˆæœ¬4 äº‹åŠ¡200æ›´æ–°è¿™æ¡è®°å½•ï¼Œname = \u0026rsquo;lilei4\u0026rsquo;, undo log æ·»åŠ æ–°çºªå½•ï¼Œç‰ˆæœ¬è®°å½•æ˜¯6ï¼Œ trx_id = 200ï¼Œ roll_pointer æŒ‡å‘ç‰ˆæœ¬5, æ³¨æ„æ­¤æ—¶äº‹åŠ¡200 æ²¡æœ‰æäº¤ åœ¨ä¸Šå›¾çš„åŸºç¡€ä¸Šï¼Œå†æœ‰ä¸€ä¸ªäº‹åŠ¡300æ›´æ–°è¿™æ¡è®°å½•ï¼Œname = \u0026rsquo;lilei5\u0026rsquo;, ç‰ˆæœ¬è®°å½•æ˜¯7 ï¼Œtrx_id = 300, roll_pointer æŒ‡å‘ç‰ˆæœ¬6, äº‹åŠ¡300 æœªæäº¤ ç»è¿‡ä¸Šè¿°å‡ ä¸ªæ­¥éª¤ï¼Œæ­¤è¡Œæ•°æ®çš„ç‰ˆæœ¬é“¾å·²ç»å½¢æˆäº†, æ ¹æ®æœ€æ–°è®°å½•ï¼Œå¯ä»¥æ‰¾åˆ°æ‰€æœ‰å†å²è®°å½•\nreadview å‡è®¾ç³»ç»Ÿä¸­æ²¡æœ‰å…¶ä»–äº‹åŠ¡åœ¨è¿è¡Œï¼Œåœ¨æ­¥éª¤7è¿™ä¸€æ—¶åˆ»ï¼Œ æ­£åœ¨è¿è¡Œçš„äº‹åŠ¡æœ‰ 100 200 300\nç°åœ¨æœ‰æ­¥éª¤8å¼€å§‹æ‰§è¡Œ\nåœ¨ä¸€ä¸ªæ–°çš„äº‹åŠ¡Aä¸­å…ˆæ‰§è¡Œä¸€æ¡æŸ¥è¯¢è¯­å¥ select name from account where id = 1; æ‰§è¡Œ8è¿™ä¸ªæŸ¥è¯¢è¯­å¥æ—¶ï¼Œä¼šå…ˆæ‰¾åˆ°è¿™è¡Œæ•°æ®çš„æœ€æ–°ç‰ˆæœ¬ï¼Œç„¶åå¼€å§‹éå†å†å²ç‰ˆæœ¬ï¼Œé‚£ä¹ˆæ ¹æ®ä»€ä¹ˆè§„åˆ™æ¥åˆ¤æ–­åº”è¯¥å–å“ªä¸€ä¸ªç‰ˆæœ¬çš„æ•°æ®å‘¢ï¼Ÿå¦‚ä¸‹ï¼š\nå› ä¸ºäº‹åŠ¡å·åœ¨æ²¡æœ‰é‡åˆ°å†™æ•°æ®çš„æ“ä½œæ—¶ï¼Œæ˜¯ä¸ä¼šç”Ÿæˆäº‹åŠ¡ç¼–ç çš„ã€‚æ‰€ä»¥æ­¤æ—¶ç³»ç»Ÿä¸­æ­£åœ¨è¿è¡Œçš„äº‹åŠ¡è¿˜æ˜¯åªæœ‰ 100 200 300 , ä»¥äº‹åŠ¡ä¸ºå•ä½ï¼Œç¬¬ä¸€æ¡æŸ¥è¯¢å¼€å§‹æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ª readview æ ‡è¯†ï¼Œ è®°å½•æ­¤æ—¶æ­¤åˆ»æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„äº‹åŠ¡idï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæœ‰åºçš„æ•°ç»„ï¼Œå³ï¼š100,200,300 ä¹Ÿå°±æ˜¯è¯´å½“å‰ç³»ç»Ÿä¸­ï¼Œæœ€å°äº‹åŠ¡æ˜¯100ï¼Œ æœ€å¤§äº‹åŠ¡æ˜¯300\nå¯¹äºå½“å‰äº‹åŠ¡Aæ¥è¯´ï¼Œundo log ç‰ˆæœ¬ä¸­ï¼Œ äº‹åŠ¡xå°äº100çš„ï¼Œéƒ½æ˜¯å·²ç»æäº¤çš„ï¼Œåº”è¯¥å¯ä»¥è¢«å½“å‰äº‹åŠ¡Açœ‹åˆ°ç›´æ¥å–äº‹åŠ¡Xæ•°æ®å³å¯ã€‚ è€Œäº‹åŠ¡å·xå¤§äº 300 çš„ï¼Œéƒ½æ˜¯å°†æ¥è¦è¿è¡Œçš„äº‹åŠ¡ï¼Œæœ¬äº‹åŠ¡Aä¸åº”è¯¥çœ‹åˆ°ï¼Œç»§ç»­éå†\nå¦‚æœundo log ç‰ˆæœ¬é“¾ä¸­æœ‰ä¸€æ¡æ•°æ®çš„ç‰ˆæœ¬å·x,å¤„äº 100 \u0026lt;= x \u0026lt;= 300ã€‚ è¿™æ—¶è¿˜è¦åˆ†ä¸ºä¸¤ç§æƒ…å†µ,\nå¦‚æœ x åœ¨100ï¼Œ200ï¼Œ 300 ä¸­å¯ä»¥æ‰¾åˆ°ç›¸åŒçš„ï¼Œå°±æ˜¯è¯´æ˜è¿˜æ²¡æœ‰æäº¤ï¼Œ äº‹åŠ¡A çœ‹ä¸è§äº‹åŠ¡xä¿®æ”¹çš„æ•°æ®ç»§ç»­éå†ã€‚ å¦‚æœæ‰¾ä¸åˆ°ç›¸åŒçš„ï¼Œè¯´æ˜äº‹åŠ¡xå·²ç»æäº¤ï¼Œå¯ä»¥çœ‹åˆ°äº‹åŠ¡Xä¿®æ”¹çš„æ•°æ®ï¼Œå– xç‰ˆæœ¬ã€‚\nè¿™é‡Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªç–‘é—®ï¼Œreadview æ ‡è¯†æ˜¯åœ¨ç¬¬ä¸€æ¡æŸ¥è¯¢è¯­å¥å¼€å§‹çš„æ—¶å€™ç”Ÿæˆçš„ã€‚ä¿å­˜å¯æ‰€æœ‰æœªæäº¤çš„äº‹åŠ¡ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰ x ä¸åœ¨ å…¶ä¸­çš„æƒ…å†µå‘¢ï¼Ÿå› ä¸ºreadview ç”Ÿæˆçš„æ—¶æœºæ˜¯å’Œäº‹åŠ¡çš„éš”ç¦»çº§åˆ«æœ‰å…³çš„ã€‚\nç°åœ¨å¢åŠ å¦‚ä¸‹æ“ä½œ:\n9. äº‹åŠ¡200æäº¤\n10. äº‹åŠ¡Aä¸­å†æ¬¡æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ select name from account where id =1;\nåœ¨å¯é‡å¤è¯»çš„çš„çº§åˆ«ä¸‹ ï¼Œæ•´ä¸ªäº‹åŠ¡ä¸­ï¼Œåªè¦ç¬¬ä¸€æ¡æŸ¥è¯¢è¯­å¥å¼€å§‹çš„æ—¶å€™ï¼Œå°±ç”Ÿæˆäº†ä¸€ä¸ªreadview æ ‡è¯†ã€‚ä»¥åä¸ä¼šå†æ”¹å˜ï¼Œå³ä½¿ 200 è¿™ä¸ªäº‹åŠ¡å·²ç»æäº¤ï¼Œåœ¨æ­¥éª¤10ä¸­ï¼Œ readview ä»ç„¶æ˜¯ 100ï¼Œ200ï¼Œ300 ã€‚æ ¹æ®ä¸Šé¢çš„è§„åˆ™ï¼Œ200 åœ¨ï¼ˆ100ï¼Œ200ï¼Œ300ï¼‰ ä¸­ï¼Œç‰ˆæœ¬6 ï¼Œ5 å±äºä¸å¯è§æ•°æ®ã€‚è¿™æ ·å°±å®ç°äº†å¯é‡å¤è¯»çš„æœºåˆ¶ã€‚åŒæ ·ç‰ˆæœ¬ 4ï¼Œ 3 ï¼Œ 2 ä¹Ÿå±äºä¸å¯è§æ•°æ®ï¼Œæ‰€ä»¥å–ç‰ˆæœ¬1 ï¼Œ name = \u0026rsquo;lilei'\nåœ¨è¯»æäº¤çº§åˆ«ä¸‹ï¼Œæ•´ä¸ªäº‹åŠ¡ä¸­ï¼Œæ¯æ¡æŸ¥è¯¢è¯­å¥éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ readview æ ‡è¯†ã€‚åœ¨ æ­¥éª¤10ï¼Œ readview æ˜¯ (100,300) . 200 ä¸åœ¨å…¶ä¸­ï¼Œæ‰€ä»¥ç‰ˆæœ¬6çš„æ•°æ®å¯è§ï¼Œ name = \u0026rsquo;lilei4'\næ€»ç»“ä¸€ä¸‹ç‰ˆæœ¬å·ä¸readviewçš„å¯¹æ¯”è§„åˆ™:\nå¯¹äºåˆ é™¤çš„æƒ…å†µå¯ä»¥è®¤ä¸ºæ˜¯updateçš„ç‰¹æ®Šæƒ…å†µï¼Œä¼šå°†ç‰ˆæœ¬é“¾ä¸Šæœ€æ–°çš„æ•°æ®å¤åˆ¶ä¸€ä»½ï¼Œç„¶åå°†trx_idä¿®æ”¹æˆåˆ é™¤æ“ä½œçš„trx_idï¼ŒåŒæ—¶åœ¨è¯¥æ¡è®°å½•çš„å¤´ä¿¡æ¯ï¼ˆrecord headerï¼‰é‡Œçš„ï¼ˆdeleted_flagï¼‰æ ‡è®°ä½å†™ä¸Štrueï¼Œæ¥è¡¨ç¤ºå½“å‰è®°å½•å·²ç»è¢«åˆ é™¤ï¼Œåœ¨æŸ¥è¯¢æ—¶æŒ‰ç…§ä¸Šé¢çš„è§„åˆ™æŸ¥åˆ°å¯¹åº”çš„è®°å½•å¦‚æœdelete_flagæ ‡è®°ä½ä¸ºtrueï¼Œæ„å‘³ç€è®°å½•å·²è¢«åˆ é™¤ï¼Œåˆ™ä¸è¿”å›æ•°æ®ã€‚\nMVCCæœºåˆ¶çš„å®ç°å°±æ˜¯é€šè¿‡read-viewæœºåˆ¶ä¸undoç‰ˆæœ¬é“¾æ¯”å¯¹æœºåˆ¶ï¼Œä½¿å¾—ä¸åŒçš„äº‹åŠ¡ä¼šæ ¹æ®æ•°æ®ç‰ˆæœ¬é“¾å¯¹æ¯”è§„åˆ™è¯»å–åŒä¸€æ¡æ•°æ®åœ¨ç‰ˆæœ¬é“¾ä¸Šçš„ä¸åŒç‰ˆæœ¬æ•°æ®\nä»¥ä¸Šå°±MVCCçš„åŸç†äº†ã€‚\nå›æ»š çŸ¥é“äº†undo log æ—¥å¿—æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Œé‚£ä¹ˆå›æ»šçš„åŸç†ä¹Ÿå°±æ˜¾è€Œæ˜“è§äº†ï¼Œåˆ é™¤æœ¬äº‹åŠ¡çš„undo logï¼Œå¹¶æŒ‰é¡ºåºç»´æŠ¤ roll_pointer çš„æŒ‡å‘kã€‚\n","date":"2022-08-07T10:48:12Z","permalink":"https://dccmmtop.github.io/posts/mvcc%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86/","section":"posts","tags":["MySQL"],"title":"MVCCå®ç°åŸç†"},{"categories":null,"contents":"åœ¨MySQLä¸­ï¼Œé€‰æ‹©æ­£ç¡®çš„æ•°æ®ç±»å‹ï¼Œå¯¹äºæ€§èƒ½è‡³å…³é‡è¦ã€‚ä¸€èˆ¬åº”è¯¥éµå¾ªä¸‹é¢ä¸¤æ­¥ï¼š\nï¼ˆ1ï¼‰ç¡®å®šåˆé€‚çš„å¤§ç±»å‹ï¼šæ•°å­—ã€å­—ç¬¦ä¸²ã€æ—¶é—´ã€äºŒè¿›åˆ¶ï¼›\nï¼ˆ2ï¼‰ç¡®å®šå…·ä½“çš„ç±»å‹ï¼šæœ‰æ— ç¬¦å·ã€å–å€¼èŒƒå›´ã€å˜é•¿å®šé•¿ç­‰ã€‚\nåœ¨MySQLæ•°æ®ç±»å‹è®¾ç½®æ–¹é¢ï¼Œå°½é‡ç”¨æ›´å°çš„æ•°æ®ç±»å‹ï¼Œå› ä¸ºå®ƒä»¬é€šå¸¸æœ‰æ›´å¥½çš„æ€§èƒ½ï¼ŒèŠ±è´¹æ›´å°‘çš„ç¡¬ä»¶èµ„æºã€‚å¹¶ä¸”ï¼Œå°½é‡æŠŠå­—æ®µå®šä¹‰ä¸ºNOT NULLï¼Œé¿å…ä½¿ç”¨NULLã€‚\næ•°å€¼ å¦‚æœæ•´å½¢æ•°æ®æ²¡æœ‰è´Ÿæ•°ï¼Œå¦‚IDå·ï¼Œå»ºè®®æŒ‡å®šä¸ºUNSIGNEDæ— ç¬¦å·ç±»å‹ï¼Œå®¹é‡å¯ä»¥æ‰©å¤§ä¸€å€ã€‚ å»ºè®®ä½¿ç”¨TINYINTä»£æ›¿ENUMã€BITENUMã€SETã€‚ é¿å…ä½¿ç”¨æ•´æ•°çš„æ˜¾ç¤ºå®½åº¦(å‚çœ‹æ–‡æ¡£æœ€å)ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸è¦ç”¨INT(10)ç±»ä¼¼çš„æ–¹æ³•æŒ‡å®šå­—æ®µæ˜¾ç¤ºå®½åº¦ï¼Œç›´æ¥ç”¨INTã€‚ DECIMALæœ€é€‚åˆä¿å­˜å‡†ç¡®åº¦è¦æ±‚é«˜ï¼Œè€Œä¸”ç”¨äºè®¡ç®—çš„æ•°æ®ï¼Œæ¯”å¦‚ä»·æ ¼ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨DECIMALç±»å‹çš„æ—¶å€™ï¼Œæ³¨æ„é•¿åº¦è®¾ç½®ã€‚ å»ºè®®ä½¿ç”¨æ•´å½¢ç±»å‹æ¥è¿ç®—å’Œå­˜å‚¨å®æ•°ï¼Œæ–¹æ³•æ˜¯ï¼Œå®æ•°ä¹˜ä»¥ç›¸åº”çš„å€æ•°åå†æ“ä½œã€‚ æ•´æ•°é€šå¸¸æ˜¯æœ€ä½³çš„æ•°æ®ç±»å‹ï¼Œå› ä¸ºå®ƒé€Ÿåº¦å¿«ï¼Œå¹¶ä¸”èƒ½ä½¿ç”¨AUTO_INCREMENTã€‚ æ•°å€¼çš„é•¿åº¦ INTæ˜¾ç¤ºå®½åº¦\næˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨å‘½ä»¤æ¥åˆ›å»ºæ•°æ®è¡¨ï¼Œè€Œä¸”åŒæ—¶ä¼šæŒ‡å®šä¸€ä¸ªé•¿åº¦ï¼Œå¦‚ä¸‹ã€‚ä½†æ˜¯ï¼Œè¿™é‡Œçš„é•¿åº¦å¹¶éæ˜¯TINYINTç±»å‹å­˜å‚¨çš„æœ€å¤§é•¿åº¦ï¼Œè€Œæ˜¯æ˜¾ç¤ºçš„æœ€å¤§é•¿åº¦ã€‚\nCREATE TABLE user ( id TINYINT(2) UNSIGNED );\nè¿™é‡Œè¡¨ç¤ºuserè¡¨çš„idå­—æ®µçš„ç±»å‹æ˜¯TINYINTï¼Œå¯ä»¥å­˜å‚¨çš„æœ€å¤§æ•°å€¼æ˜¯255ã€‚æ‰€ä»¥ï¼Œåœ¨å­˜å‚¨æ•°æ®æ—¶ï¼Œå¦‚æœå­˜å…¥å€¼å°äºç­‰äº255ï¼Œå¦‚200ï¼Œè™½ç„¶è¶…è¿‡2ä½ï¼Œä½†æ˜¯æ²¡æœ‰è¶…å‡ºTINYINTç±»å‹é•¿åº¦ï¼Œæ‰€ä»¥å¯ä»¥æ­£å¸¸ä¿å­˜ï¼›å¦‚æœå­˜å…¥å€¼å¤§äº255ï¼Œå¦‚500ï¼Œé‚£ä¹ˆMySQLä¼šè‡ªåŠ¨ä¿å­˜ä¸ºTINYINTç±»å‹çš„æœ€å¤§å€¼255ã€‚\nåœ¨æŸ¥è¯¢æ•°æ®æ—¶ï¼Œä¸ç®¡æŸ¥è¯¢ç»“æœä¸ºä½•å€¼ï¼Œéƒ½æŒ‰å®é™…è¾“å‡ºã€‚è¿™é‡ŒTINYINT(2)ä¸­2çš„ä½œç”¨å°±æ˜¯ï¼Œå½“éœ€è¦åœ¨æŸ¥è¯¢ç»“æœå‰å¡«å……0æ—¶ï¼Œå‘½ä»¤ä¸­åŠ ä¸ŠZEROFILLå°±å¯ä»¥å®ç°ï¼Œå¦‚ï¼š\nid TINYINT(2) UNSIGNED ZEROFILL\nè¿™æ ·ï¼ŒæŸ¥è¯¢ç»“æœå¦‚æœæ˜¯5ï¼Œé‚£è¾“å‡ºå°±æ˜¯05ã€‚å¦‚æœæŒ‡å®šTINYINT(5)ï¼Œé‚£è¾“å‡ºå°±æ˜¯00005ï¼Œå…¶å®å®é™…å­˜å‚¨çš„å€¼è¿˜æ˜¯5ï¼Œè€Œä¸”å­˜å‚¨çš„æ•°æ®ä¸ä¼šè¶…è¿‡255ï¼Œåªæ˜¯MySQLè¾“å‡ºæ•°æ®æ—¶åœ¨å‰é¢å¡«å……äº†0ã€‚\næ¢å¥è¯è¯´ï¼Œåœ¨MySQLå‘½ä»¤ä¸­ï¼Œå­—æ®µçš„ç±»å‹é•¿åº¦TINYINT(2)ã€INT(11)ä¸ä¼šå½±å“æ•°æ®çš„æ’å…¥ï¼Œåªä¼šåœ¨ä½¿ç”¨ZEROFILLæ—¶æœ‰ç”¨ï¼Œè®©æŸ¥è¯¢ç»“æœå‰å¡«å……0ã€‚\næ—¶é—´ MySQLèƒ½å­˜å‚¨çš„æœ€å°æ—¶é—´ç²’åº¦ä¸ºç§’ã€‚ å»ºè®®ç”¨DATEæ•°æ®ç±»å‹æ¥ä¿å­˜æ—¥æœŸã€‚MySQLä¸­é»˜è®¤çš„æ—¥æœŸæ ¼å¼æ˜¯yyyy-mm-ddã€‚ ç”¨MySQLçš„å†…å»ºç±»å‹DATEã€TIMEã€DATETIMEæ¥å­˜å‚¨æ—¶é—´ï¼Œè€Œä¸æ˜¯ä½¿ç”¨å­—ç¬¦ä¸²ã€‚ å½“æ•°æ®æ ¼å¼ä¸ºTIMESTAMPå’ŒDATETIMEæ—¶ï¼Œå¯ä»¥ç”¨CURRENT_TIMESTAMPä½œä¸ºé»˜è®¤ï¼ˆMySQL5.6ä»¥åï¼‰ï¼ŒMySQLä¼šè‡ªåŠ¨è¿”å›è®°å½•æ’å…¥çš„ç¡®åˆ‡æ—¶é—´ã€‚ TIMESTAMPæ˜¯UTCæ—¶é—´æˆ³ï¼Œä¸æ—¶åŒºç›¸å…³ã€‚ DATETIMEçš„å­˜å‚¨æ ¼å¼æ˜¯ä¸€ä¸ªYYYYMMDD HH:MM:SSçš„æ•´æ•°ï¼Œä¸æ—¶åŒºæ— å…³ï¼Œä½ å­˜äº†ä»€ä¹ˆï¼Œè¯»å‡ºæ¥å°±æ˜¯ä»€ä¹ˆã€‚ é™¤éæœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œä¸€èˆ¬çš„å…¬å¸å»ºè®®ä½¿ç”¨TIMESTAMPï¼Œå®ƒæ¯”DATETIMEæ›´èŠ‚çº¦ç©ºé—´ï¼Œä½†æ˜¯åƒé˜¿é‡Œè¿™æ ·çš„å…¬å¸ä¸€èˆ¬ä¼šç”¨DATETIMEï¼Œå› ä¸ºä¸ç”¨è€ƒè™‘TIMESTAMPå°†æ¥çš„æ—¶é—´ä¸Šé™é—®é¢˜ã€‚ æœ‰æ—¶äººä»¬æŠŠUnixçš„æ—¶é—´æˆ³ä¿å­˜ä¸ºæ•´æ•°å€¼ï¼Œä½†æ˜¯è¿™é€šå¸¸æ²¡æœ‰ä»»ä½•å¥½å¤„ï¼Œè¿™ç§æ ¼å¼å¤„ç†èµ·æ¥ä¸å¤ªæ–¹ä¾¿ï¼Œæˆ‘ä»¬å¹¶ä¸æ¨èå®ƒã€‚ å­—ç¬¦ä¸² å­—ç¬¦ä¸²çš„é•¿åº¦ç›¸å·®è¾ƒå¤§ç”¨VARCHARï¼›å­—ç¬¦ä¸²çŸ­ï¼Œä¸”æ‰€æœ‰å€¼éƒ½æ¥è¿‘ä¸€ä¸ªé•¿åº¦ç”¨CHARã€‚ CHARå’ŒVARCHARé€‚ç”¨äºåŒ…æ‹¬äººåã€é‚®æ”¿ç¼–ç ã€ç”µè¯å·ç å’Œä¸è¶…è¿‡255ä¸ªå­—ç¬¦é•¿åº¦çš„ä»»æ„å­—æ¯æ•°å­—ç»„åˆã€‚é‚£äº›è¦ç”¨æ¥è®¡ç®—çš„æ•°å­—ä¸è¦ç”¨VARCHARç±»å‹ä¿å­˜ï¼Œå› ä¸ºå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›ä¸è®¡ç®—ç›¸å…³çš„é—®é¢˜ã€‚æ¢å¥è¯è¯´ï¼Œå¯èƒ½å½±å“åˆ°è®¡ç®—çš„å‡†ç¡®æ€§å’Œå®Œæ•´æ€§ã€‚ å°½é‡å°‘ç”¨BLOBå’ŒTEXTï¼Œå¦‚æœå®åœ¨è¦ç”¨å¯ä»¥è€ƒè™‘å°†BLOBå’ŒTEXTå­—æ®µå•ç‹¬å­˜ä¸€å¼ è¡¨ï¼Œç”¨idå…³è”ã€‚ BLOBç³»åˆ—å­˜å‚¨äºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œä¸å­—ç¬¦é›†æ— å…³ã€‚TEXTç³»åˆ—å­˜å‚¨éäºŒè¿›åˆ¶å­—ç¬¦ä¸²ï¼Œä¸å­—ç¬¦é›†ç›¸å…³ã€‚ BLOBå’ŒTEXTéƒ½ä¸èƒ½æœ‰é»˜è®¤å€¼ã€‚ ","date":"2022-08-06T11:14:09Z","permalink":"https://dccmmtop.github.io/posts/mysql%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E7%9A%84%E4%BD%BF%E7%94%A8/","section":"posts","tags":["MySQL"],"title":"MySQLæ•°æ®ç±»å‹çš„ä½¿ç”¨"},{"categories":null,"contents":"æ•°æ®åº“ä¸€èˆ¬éƒ½ä¼šå¹¶å‘æ‰§è¡Œå¤šä¸ªäº‹åŠ¡ï¼Œå¤šä¸ªäº‹åŠ¡å¯èƒ½ä¼šå¹¶å‘çš„å¯¹ç›¸åŒçš„ä¸€æ‰¹æ•°æ®è¿›è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œï¼Œå¯èƒ½å°±ä¼šå¯¼è‡´æˆ‘ä»¬è¯´çš„è„å†™ã€è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»è¿™äº›é—®é¢˜ã€‚\nè¿™äº›é—®é¢˜çš„æœ¬è´¨éƒ½æ˜¯æ•°æ®åº“çš„å¤šäº‹åŠ¡å¹¶å‘é—®é¢˜ï¼Œä¸ºäº†è§£å†³å¤šäº‹åŠ¡å¹¶å‘é—®é¢˜ï¼Œæ•°æ®åº“è®¾è®¡äº†äº‹åŠ¡éš”ç¦»æœºåˆ¶ã€é”æœºåˆ¶ã€MVCCå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶éš”ç¦»æœºåˆ¶ï¼Œç”¨ä¸€æ•´å¥—æœºåˆ¶æ¥è§£å†³å¤šäº‹åŠ¡å¹¶å‘é—®é¢˜\näº‹åŠ¡åŠå…¶ACIDå±æ€§ äº‹åŠ¡æ˜¯ç”±ä¸€ç»„SQLè¯­å¥ç»„æˆçš„é€»è¾‘å¤„ç†å•å…ƒ,äº‹åŠ¡å…·æœ‰ä»¥ä¸‹4ä¸ªå±æ€§,é€šå¸¸ç®€ç§°ä¸ºäº‹åŠ¡çš„ACIDå±æ€§ã€‚\nåŸå­æ€§(Atomicity) ï¼šäº‹åŠ¡æ˜¯ä¸€ä¸ªåŸå­æ“ä½œå•å…ƒ,å…¶å¯¹æ•°æ®çš„ä¿®æ”¹,è¦ä¹ˆå…¨éƒ½æ‰§è¡Œ,è¦ä¹ˆå…¨éƒ½ä¸æ‰§è¡Œã€‚ ä¸€è‡´æ€§(Consistent) ï¼šåœ¨äº‹åŠ¡å¼€å§‹å’Œå®Œæˆæ—¶,æ•°æ®éƒ½å¿…é¡»ä¿æŒä¸€è‡´çŠ¶æ€ã€‚è¿™æ„å‘³ç€æ‰€æœ‰ç›¸å…³çš„æ•°æ®è§„åˆ™éƒ½å¿…é¡»åº”ç”¨äºäº‹åŠ¡çš„ä¿®æ”¹,ä»¥ä¿æŒæ•°æ®çš„å®Œæ•´æ€§ã€‚ éš”ç¦»æ€§(Isolation) ï¼šæ•°æ®åº“ç³»ç»Ÿæä¾›ä¸€å®šçš„éš”ç¦»æœºåˆ¶,ä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„â€œç‹¬ç«‹â€ç¯å¢ƒæ‰§è¡Œã€‚è¿™æ„å‘³ç€äº‹åŠ¡å¤„ç†è¿‡ç¨‹ä¸­çš„ä¸­é—´çŠ¶æ€å¯¹å¤–éƒ¨æ˜¯ä¸å¯è§çš„,åä¹‹äº¦ç„¶ã€‚ æŒä¹…æ€§(Durable) ï¼šäº‹åŠ¡å®Œæˆä¹‹å,å®ƒå¯¹äºæ•°æ®çš„ä¿®æ”¹æ˜¯æ°¸ä¹…æ€§çš„,å³ä½¿å‡ºç°ç³»ç»Ÿæ•…éšœä¹Ÿèƒ½å¤Ÿä¿æŒã€‚ å¹¶å‘äº‹åŠ¡å¤„ç†å¸¦æ¥çš„é—®é¢˜\næ›´æ–°ä¸¢å¤±(Lost Update)æˆ–è„å†™ å½“ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹åŠ¡é€‰æ‹©åŒä¸€è¡Œï¼Œç„¶ååŸºäºæœ€åˆé€‰å®šçš„å€¼æ›´æ–°è¯¥è¡Œæ—¶ï¼Œç”±äºæ¯ä¸ªäº‹åŠ¡éƒ½ä¸çŸ¥é“å…¶ä»–äº‹åŠ¡çš„å­˜åœ¨ï¼Œå°±ä¼šå‘ç”Ÿä¸¢å¤±æ›´æ–°é—®é¢˜â€”â€”æœ€åçš„æ›´æ–°è¦†ç›–äº†ç”±å…¶ä»–äº‹åŠ¡æ‰€åšçš„æ›´æ–°ã€‚\nå¯ä»¥ä½¿ç”¨é”æ¥è§£å†³\nè„è¯»ï¼ˆDirty Readsï¼‰ ä¸€ä¸ªäº‹åŠ¡æ­£åœ¨å¯¹ä¸€æ¡è®°å½•åšä¿®æ”¹ï¼Œåœ¨è¿™ä¸ªäº‹åŠ¡å®Œæˆå¹¶æäº¤å‰ï¼Œè¿™æ¡è®°å½•çš„æ•°æ®å°±å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ï¼›è¿™æ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿæ¥è¯»å–åŒä¸€æ¡è®°å½•ï¼Œå¦‚æœä¸åŠ æ§åˆ¶ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡è¯»å–äº†è¿™äº›â€œè„â€æ•°æ®ï¼Œå¹¶æ®æ­¤ä½œè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œå°±ä¼šäº§ç”Ÿæœªæäº¤çš„æ•°æ®ä¾èµ–å…³ç³»ã€‚è¿™ç§ç°è±¡è¢«å½¢è±¡çš„å«åšâ€œè„è¯»â€ã€‚\nä¸€å¥è¯ï¼šäº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bå·²ç»ä¿®æ”¹ä½†å°šæœªæäº¤çš„æ•°æ®ï¼Œè¿˜åœ¨è¿™ä¸ªæ•°æ®åŸºç¡€ä¸Šåšäº†æ“ä½œã€‚æ­¤æ—¶ï¼Œå¦‚æœBäº‹åŠ¡å›æ»šï¼ŒAè¯»å–çš„æ•°æ®æ— æ•ˆï¼Œä¸ç¬¦åˆä¸€è‡´æ€§è¦æ±‚ã€‚\nä¸å¯é‡è¯»ï¼ˆNon-Repeatable Readsï¼‰ ä¸€ä¸ªäº‹åŠ¡åœ¨è¯»å–æŸäº›æ•°æ®åçš„æŸä¸ªæ—¶é—´ï¼Œå†æ¬¡è¯»å–ä»¥å‰è¯»è¿‡çš„æ•°æ®ï¼Œå´å‘ç°å…¶è¯»å‡ºçš„æ•°æ®å·²ç»å‘ç”Ÿäº†æ”¹å˜ã€æˆ–æŸäº›è®°å½•å·²ç»è¢«åˆ é™¤äº†ï¼è¿™ç§ç°è±¡å°±å«åšâ€œä¸å¯é‡å¤è¯»â€ã€‚\nä¸€å¥è¯ï¼šäº‹åŠ¡Aå†…éƒ¨çš„ç›¸åŒæŸ¥è¯¢è¯­å¥åœ¨ä¸åŒæ—¶åˆ»è¯»å‡ºçš„ç»“æœä¸ä¸€è‡´ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§\nå¹»è¯»ï¼ˆPhantom Readsï¼‰ ä¸€ä¸ªäº‹åŠ¡æŒ‰ç›¸åŒçš„æŸ¥è¯¢æ¡ä»¶é‡æ–°è¯»å–ä»¥å‰æ£€ç´¢è¿‡çš„æ•°æ®ï¼Œå´å‘ç°å…¶ä»–äº‹åŠ¡æ’å…¥äº†æ»¡è¶³å…¶æŸ¥è¯¢æ¡ä»¶çš„æ–°æ•°æ®ï¼Œè¿™ç§ç°è±¡å°±ç§°ä¸ºâ€œå¹»è¯»â€ã€‚\nä¸€å¥è¯ï¼šäº‹åŠ¡Aè¯»å–åˆ°äº†äº‹åŠ¡Bæäº¤çš„æ–°å¢æ•°æ®ï¼Œä¸ç¬¦åˆéš”ç¦»æ€§\nè„å†™æ˜¯å¤šä¸ªäº‹åŠ¡å¯¹åŒä¸€è¡Œè®°å½•åŒæ—¶ä¿®æ”¹å¼•èµ·çš„ï¼Œå¯ä»¥é€šè¿‡åŠ é”é¿å…ï¼Œä¸‹é¢çš„è„è¯»ï¼Œä¸å¯é‡å¤è¯»ï¼Œå¹»è¯»ï¼Œéƒ½æ˜¯äº‹åŠ¡çš„éš”ç¦»çº§åˆ«å¼•èµ·çš„ã€‚éœ€è¦è®¾ç½®åˆé€‚çš„éš”ç¦»çº§åˆ«\näº‹åŠ¡éš”ç¦»çº§åˆ« â€œè„è¯»â€ã€â€œä¸å¯é‡å¤è¯»â€å’Œâ€œå¹»è¯»â€,å…¶å®éƒ½æ˜¯æ•°æ®åº“è¯»ä¸€è‡´æ€§é—®é¢˜,å¿…é¡»ç”±æ•°æ®åº“æä¾›ä¸€å®šçš„äº‹åŠ¡éš”ç¦»æœºåˆ¶æ¥è§£å†³ã€‚\næ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»è¶Šä¸¥æ ¼,å¹¶å‘å‰¯ä½œç”¨è¶Šå°,ä½†ä»˜å‡ºçš„ä»£ä»·ä¹Ÿå°±è¶Šå¤§,å› ä¸ºäº‹åŠ¡éš”ç¦»å®è´¨ä¸Šå°±æ˜¯ä½¿äº‹åŠ¡åœ¨ä¸€å®šç¨‹åº¦ä¸Šâ€œä¸²è¡ŒåŒ–â€è¿›è¡Œ,è¿™æ˜¾ç„¶ä¸â€œå¹¶å‘â€æ˜¯çŸ›ç›¾çš„ã€‚\nåŒæ—¶,ä¸åŒçš„åº”ç”¨å¯¹è¯»ä¸€è‡´æ€§å’Œäº‹åŠ¡éš”ç¦»ç¨‹åº¦çš„è¦æ±‚ä¹Ÿæ˜¯ä¸åŒçš„,æ¯”å¦‚è®¸å¤šåº”ç”¨å¯¹â€œä¸å¯é‡å¤è¯»\u0026quot;å’Œâ€œå¹»è¯»â€å¹¶ä¸æ•æ„Ÿ,å¯èƒ½æ›´å…³å¿ƒæ•°æ®å¹¶å‘è®¿é—®çš„èƒ½åŠ›ã€‚\nå¸¸çœ‹å½“å‰æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«: show variables like \u0026rsquo;tx_isolation';\nè®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼šset tx_isolation='REPEATABLE-READ';\nMysqlé»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«æ˜¯å¯é‡å¤è¯»ï¼Œç”¨Springå¼€å‘ç¨‹åºæ—¶ï¼Œå¦‚æœä¸è®¾ç½®éš”ç¦»çº§åˆ«é»˜è®¤ç”¨Mysqlè®¾ç½®çš„éš”ç¦»çº§åˆ«ï¼Œå¦‚æœSpringè®¾ç½®äº†å°±ç”¨å·²ç»è®¾ç½®çš„éš”ç¦»çº§åˆ«\né” é”æ˜¯è®¡ç®—æœºåè°ƒå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å¹¶å‘è®¿é—®æŸä¸€èµ„æºçš„æœºåˆ¶ã€‚\nåœ¨æ•°æ®åº“ä¸­ï¼Œé™¤äº†ä¼ ç»Ÿçš„è®¡ç®—èµ„æºï¼ˆå¦‚CPUã€RAMã€I/Oç­‰ï¼‰çš„äº‰ç”¨ä»¥å¤–ï¼Œæ•°æ®ä¹Ÿæ˜¯ä¸€ç§ä¾›éœ€è¦ç”¨æˆ·å…±äº«çš„èµ„æºã€‚å¦‚ä½•ä¿è¯æ•°æ®å¹¶å‘è®¿é—®çš„ä¸€è‡´æ€§ã€æœ‰æ•ˆæ€§æ˜¯æ‰€æœ‰æ•°æ®åº“å¿…é¡»è§£å†³çš„ä¸€ä¸ªé—®é¢˜ï¼Œé”å†²çªä¹Ÿæ˜¯å½±å“æ•°æ®åº“å¹¶å‘è®¿é—®æ€§èƒ½çš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚\né”çš„åˆ†ç±» ä»æ€§èƒ½ä¸Šåˆ†ä¸ºä¹è§‚é”å’Œæ‚²è§‚é” ä»æ•°æ®åº“æ“ä½œåŠ›åº¦ä¸Šåˆ†ä¸ºè¡¨é”å’Œè¡Œé” ä»å¯¹æ•°æ®åº“æ“ä½œç±»å‹åˆ†ä¸ºè¯»é”å’Œå†™é”ï¼ˆéƒ½å±äºæ‚²è§‚é”ï¼‰ è¯»é” è¯»é”ï¼ˆå…±äº«é”ï¼ŒSé”(Shared)ï¼‰ï¼šé’ˆå¯¹åŒä¸€ä»½æ•°æ®ï¼Œå¤šä¸ªè¯»æ“ä½œå¯ä»¥åŒæ—¶è¿›è¡Œè€Œä¸ä¼šäº’ç›¸å½±å“ï¼Œæ¯”å¦‚ï¼šselect * from T where id=1Â lock in share mode, å•ç‹¬çš„ select æ˜¯ä¸ä¼šåŠ é”çš„ã€‚\nå†™é” å†™é”ï¼ˆæ’å®ƒé”ï¼ŒXé”(eXclusive)ï¼‰ï¼šå½“å‰å†™æ“ä½œæ²¡æœ‰å®Œæˆå‰ï¼Œå®ƒä¼šé˜»æ–­å…¶ä»–å†™é”å’Œè¯»é”ï¼Œæ•°æ®ä¿®æ”¹æ“ä½œéƒ½ä¼šåŠ å†™é”ï¼ŒæŸ¥è¯¢ä¹Ÿå¯ä»¥é€šè¿‡for updateåŠ å†™é”ï¼Œæ¯”å¦‚ï¼š`select * from T where id=1Â for update`\ræ„å‘é” æ„å‘é”ï¼ˆIntention Lockï¼‰ï¼šåˆç§°Ié”ï¼Œé’ˆå¯¹è¡¨é”ï¼Œä¸»è¦æ˜¯ä¸ºäº†æé«˜åŠ è¡¨é”çš„æ•ˆç‡ï¼Œæ˜¯mysqlæ•°æ®åº“è‡ªå·±åŠ çš„ã€‚å½“æœ‰äº‹åŠ¡ç»™è¡¨çš„æ•°æ®è¡ŒåŠ äº†å…±äº«é”æˆ–æ’ä»–é”ï¼ŒåŒæ—¶ä¼šç»™è¡¨è®¾ç½®ä¸€ä¸ªæ ‡è¯†ï¼Œä»£è¡¨å·²ç»æœ‰è¡Œé”äº†ï¼Œå…¶ä»–äº‹åŠ¡è¦æƒ³å¯¹è¡¨åŠ è¡¨é”æ—¶ï¼Œå°±ä¸å¿…é€è¡Œåˆ¤æ–­æœ‰æ²¡æœ‰è¡Œé”å¯èƒ½è·Ÿè¡¨é”å†²çªäº†ï¼Œç›´æ¥è¯»è¿™ä¸ªæ ‡è¯†å°±å¯ä»¥ç¡®å®šè‡ªå·±è¯¥ä¸è¯¥åŠ è¡¨é”ã€‚ç‰¹åˆ«æ˜¯è¡¨ä¸­çš„è®°å½•å¾ˆå¤šæ—¶ï¼Œé€è¡Œåˆ¤æ–­åŠ è¡¨é”çš„æ–¹å¼æ•ˆç‡å¾ˆä½ã€‚è€Œè¿™ä¸ªæ ‡è¯†å°±æ˜¯æ„å‘é”ã€‚\næ„å‘é”ä¸»è¦åˆ†ä¸ºï¼š\næ„å‘å…±äº«é”ï¼ŒISé”ï¼Œå¯¹æ•´ä¸ªè¡¨åŠ å…±äº«é”ä¹‹å‰ï¼Œéœ€è¦å…ˆè·å–åˆ°æ„å‘å…±äº«é”ã€‚ æ„å‘æ’ä»–é”ï¼ŒIXé”ï¼Œå¯¹æ•´ä¸ªè¡¨åŠ æ’ä»–é”ä¹‹å‰ï¼Œéœ€è¦å…ˆè·å–åˆ°æ„å‘æ’ä»–é”ã€‚ è¡¨é” æ¯æ¬¡æ“ä½œé”ä½æ•´å¼ è¡¨ã€‚å¼€é”€å°ï¼ŒåŠ é”å¿«ï¼›ä¸ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦å¤§ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€é«˜ï¼Œå¹¶å‘åº¦æœ€ä½ï¼›ä¸€èˆ¬ç”¨åœ¨æ•´è¡¨æ•°æ®è¿ç§»çš„åœºæ™¯ï¼Œåœæ‰æ‰€æœ‰çš„åº”ç”¨æœåŠ¡å™¨å¹¶ä¸èƒ½ä¿è¯ä¸ä¼šå†å‘è¡¨ä¸­å†™å…¥æ•°æ®äº†ã€‚å¯èƒ½ä¼šæœ‰å…¶ä»–DBAå†æ“ä½œè¯¥è¡¨ã€‚æœ€å¥½åŠ ä¸€ä¸ªè¡¨é”\nè¡¨é”çš„æ“ä½œ æ‰‹åŠ¨å¢åŠ è¡¨é”\nlock table è¡¨åç§° read(write),è¡¨åç§°2 read(write); å¦‚, åŠ è¯»é” lock table employee read\nåŠ å†™é”\nlock table employee write\nå½“å‰sessionå¯¹è¯¥è¡¨çš„å¢åˆ æ”¹æŸ¥éƒ½æ²¡æœ‰é—®é¢˜ï¼Œå…¶ä»–sessionå¯¹è¯¥è¡¨çš„æ‰€æœ‰æ“ä½œè¢«é˜»å¡\næŸ¥çœ‹è¡¨ä¸ŠåŠ è¿‡çš„é”\nshow open tables; åˆ é™¤è¡¨é”\nunlock tables; è¡Œé” æ¯æ¬¡æ“ä½œé”ä½ä¸€è¡Œæ•°æ®ã€‚å¼€é”€å¤§ï¼ŒåŠ é”æ…¢ï¼›ä¼šå‡ºç°æ­»é”ï¼›é”å®šç²’åº¦æœ€å°ï¼Œå‘ç”Ÿé”å†²çªçš„æ¦‚ç‡æœ€ä½ï¼Œå¹¶å‘åº¦æœ€é«˜ã€‚\nInnoDBæ”¯æŒè¡Œçº§é” MYISAMä¸æ”¯æŒ\nInnoDBåœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥SELECTæ—¶(éä¸²è¡Œéš”ç¦»çº§åˆ«)ï¼Œä¸ä¼šåŠ é”ã€‚ä½†æ˜¯updateã€insertã€deleteæ“ä½œä¼šåŠ è¡Œé”ã€‚\nç®€è€Œè¨€ä¹‹ï¼Œå°±æ˜¯è¯»é”ä¼šé˜»å¡å†™ï¼Œä½†æ˜¯ä¸ä¼šé˜»å¡è¯»ã€‚è€Œå†™é”åˆ™ä¼šæŠŠè¯»å’Œå†™éƒ½é˜»å¡ã€‚\näº‹åŠ¡çš„éš”ç¦»çº§åˆ« è¯»æœªæäº¤ set tx_isolation='read-uncommitted';\nA äº‹åŠ¡å¯ä»¥è¯»åˆ°Bäº‹åŠ¡ä¸­ä¿®æ”¹çš„æ•°æ®ï¼Œå°½ç®¡Bäº‹åŠ¡è¿˜æ²¡æœ‰æäº¤ , å¦‚æœBäº‹åŠ¡å›æ»šäº†ï¼Œé‚£ä¹ˆAè¯»çš„å°±æ˜¯è„æ•°æ®ï¼Œå¦‚æœAåŸºäºè¿™ä¸ªæ•°æ®åšæ“ä½œäº†ï¼Œå°±ä¼šå‘ç”Ÿè„å†™\nè¯»å·²æäº¤ set tx_isolation='read-committed';\nå‡å¦‚ ç”¨æˆ·U1 çš„ age = 30 æœ‰å¦‚ä¸‹æ—¶åºçš„æ“ä½œ\nAäº‹åŠ¡å¼€å¯ï¼Œè¯»åˆ°U1 age çš„å€¼ä¸º30 B äº‹åŠ¡å¼€å¯ï¼Œ æ›´æ–°U1 age ä¸º 35 A äº‹åŠ¡ä¸­è¯» age çš„å€¼ä¸º 30 B äº‹åŠ¡æäº¤ A äº‹åŠ¡ä¸­è¯» age çš„å€¼ä¸º 35 A äº‹åŠ¡æäº¤ åœ¨è¿™ç§éš”ç¦»çº§åˆ«ä¸‹ï¼Œè§£å†³äº†è„å†™çš„é—®é¢˜ï¼Œå› ä¸ºæ— æ³•è¯»åˆ°æœªæäº¤çš„æ•°æ®ï¼Œåªèƒ½è¯»åˆ°å·²ç»æäº¤çš„æ•°æ®ï¼Œä½†æ˜¯é—®é¢˜ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œåœ¨ 3 ï¼Œ5 æ­¥éª¤ä¸­ï¼Œå°½ç®¡åœ¨åŒä¸€ä¸ªAäº‹åŠ¡ä¸­ï¼Œè¯»å–åŒä¸€è¡Œæ•°æ®ï¼Œä¸åŒæ—¶é—´å¾—åˆ°çš„ç»“æœä¸ä¸€æ ·ï¼Œæˆ‘ä»¬ä»¥å“ªæ¬¡ç»“æœä¸ºå‡†å‘¢ï¼Ÿåé¢è¿™ä¸ªå€¼ä¼šä¸ä¼šå†æ¬¡å‘ç”Ÿå˜åŒ–å‘¢ï¼Ÿè¿™å°±æ˜¯ä¸å¯é‡å¤è¯»çš„é—®é¢˜\nå¯é‡å¤è¯» set tx_isolation='repeatable-read';\nå‡å¦‚ ç”¨æˆ·U1 çš„ age = 30 æœ‰å¦‚ä¸‹æ—¶åºçš„æ“ä½œ\nAäº‹åŠ¡å¼€å¯ï¼Œè¯»åˆ°U1 age çš„å€¼ä¸º30 B äº‹åŠ¡å¼€å¯ï¼Œ æ›´æ–°U1 age ä¸º 35 A äº‹åŠ¡ä¸­è¯» age çš„å€¼ä¸º 30 Aäº‹åŠ¡æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ select * from employee where age = 40; B äº‹åŠ¡æ–°å¢ä¸€æ¡æ•°æ® U2ï¼Œage = 40ï¼› B äº‹åŠ¡æäº¤ A äº‹åŠ¡ä¸­è¯» age çš„å€¼ä¸º 30 A äº‹åŠ¡æ‰§è¡ŒSQLè¯­å¥ update employee set age = age + 5 where id =1; Aäº‹åŠ¡æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ select * from employee where age = 40; A äº‹åŠ¡æäº¤ åœ¨è¿™ç§çº§åˆ«ä¸‹ï¼Œåœ¨Aäº‹åŠ¡è¯»å–çš„ç»“æœå§‹ç»ˆä¸º 30ï¼Œ æ— è®ºå…¶ä»–äº‹åŠ¡æ˜¯å¦ä¿®æ”¹ï¼Œæ˜¯å¦æäº¤ã€‚\næ³¨æ„ ä½†æ˜¯åœ¨æ‰§è¡Œæ›´æ–°çš„æ—¶å€™ï¼Œæ˜¯ä»¥æ­¤æ—¶æ­¤åˆ»æ•°æ®åº“ä¸­æœ€æ–°çš„æ•°æ®ä¸ºå‡†çš„ï¼ŒAäº‹åŠ¡æäº¤åï¼Œage çš„å€¼æ˜¯ 40ã€‚è€Œä¸æ˜¯35ï¼Œ å› ä¸ºåœ¨æ­¥éª¤8ä¸­ï¼Œå¯¹ age è¿›è¡Œä¿®æ”¹ï¼Œæ˜¯ä»¥å½“å‰ age çš„å€¼ä¸ºå‡†ï¼Œä¹Ÿå°±æ˜¯ 35. å¦‚æœæ˜¯åœ¨å†…å­˜ä¸­è¿›è¡Œçš„ç®—æœ¯è¿ç®—ï¼Œå…ˆå–å‡º age çš„å€¼ï¼Œç„¶åç”¨ç¨‹åºå°† age = age +5, ç„¶åå†å°†ageæ›´æ–°åˆ°æ•°æ®åº“ï¼Œæ­¤æ—¶age å°±æ˜¯35äº†ã€‚å‘ç”Ÿé”™è¯¯ï¼Œè¿™ä¸€ç‚¹è¦æ³¨æ„ã€‚\nè¿™ç§å¯é‡å¤è¯»çš„æœºåˆ¶æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿéš¾é“æ¯ä¸ªäº‹åŠ¡å¼€å¯çš„æ—¶å€™ï¼Œéƒ½ç»™è¡¨è¿›è¡Œå¿«ç…§ä¸€æ¬¡å—ï¼Ÿ\nç­”æ¡ˆæ˜¯ MVCC, MVCC çš„åŸç†è¯·çœ‹ä¸‹ä¸€ç¯‡åšå®¢\nåœ¨æ­¥éª¤4, 9ä¸­ï¼Œ4 æ²¡æœ‰ç»“æœï¼Œ9 èƒ½æŸ¥è¯¢åˆ°ç»“æœï¼Œå°±æ˜¯ B äº‹åŠ¡æ–°å¢çš„é‚£ä¸€æ¡æ•°æ®ï¼Œå‘ç”Ÿäº†å¹»è¯»ï¼Œå¹»è¯»ä¹Ÿæ˜¯ä¸å¯é‡å¤è¯»çš„ä¸€ç§ï¼Œåªä¸è¿‡ä¸å¯é‡å¤è¯»æ˜¯é’ˆå¯¹æ•°æ®çš„æ›´æ–°ï¼Œå¹»è¯»æ˜¯æ•°æ®çš„æ–°å¢æˆ–è€…åˆ é™¤ã€‚\nç”±æ­¤å¯è§ï¼Œå¯é‡å¤è¯»çš„çº§åˆ«ä¹Ÿæ²¡æœ‰å®Œå…¨å°†äº‹åŠ¡éš”ç¦»å¼€ã€‚\nä¸²è¡ŒåŒ– set tx_isolation='serializable';\nåœ¨è¿™ç§çº§åˆ«ä¸‹ï¼Œæ‰€æœ‰çš„æŸ¥è¯¢è¯­å¥å’Œæ›´æ–°è¯­å¥éƒ½ä¼šè¢«åŠ ä¸Šè¡Œé”ã€‚\nè¿™ç§éš”ç¦»çº§åˆ«å¹¶å‘æ€§æä½ï¼Œå¼€å‘ä¸­å¾ˆå°‘ä¼šç”¨åˆ°ã€‚\nå¦‚æœå®¢æˆ·ç«¯Aæ‰§è¡Œçš„æ˜¯ä¸€ä¸ªèŒƒå›´æŸ¥è¯¢ï¼Œé‚£ä¹ˆè¯¥èŒƒå›´å†…çš„æ‰€æœ‰è¡ŒåŒ…æ‹¬æ¯è¡Œè®°å½•æ‰€åœ¨çš„é—´éš™åŒºé—´èŒƒå›´(å°±ç®—è¯¥è¡Œæ•°æ®è¿˜æœªè¢«æ’å…¥ä¹Ÿä¼šåŠ é”ï¼Œè¿™ç§æ˜¯é—´éš™é”)éƒ½ä¼šè¢«åŠ é”ã€‚æ­¤æ—¶å¦‚æœå®¢æˆ·ç«¯Båœ¨è¯¥èŒƒå›´å†…æ’å…¥æ•°æ®éƒ½ä¼šè¢«é˜»å¡ï¼Œæ‰€ä»¥å°±é¿å…äº†å¹»è¯»ã€‚\nå†è°ˆé” çŸ¥é“äº†äº‹åŠ¡çš„éš”ç¦»çº§åˆ«åï¼Œå†çœ‹ä¸‹é¢çš„é”\né—´éš™é” Gap-Lock ä¾‹å­:\næœ‰ employee è¡¨ï¼š\nA äº‹åŠ¡æ‰§è¡Œ select * from employee where age \u0026gt;= 30 and age \u0026lt;= 40; B äº‹åŠ¡æ‰§è¡Œ update employee set age = age + 1 where id = 2;\nC äº‹åŠ¡æ‰§è¡Œ insert into employee(id, name, age) values(5, u5, 37); åœ¨æ­¥éª¤1æ—¶ï¼Œä¼šæœ‰ä¸€ä¸ªé—´éš™é”ï¼Œé”çš„èŒƒå›´æ˜¯ 30 \u0026lt;= age \u0026lt;= 40, B äº‹åŠ¡å’ŒCäº‹åŠ¡éƒ½ä¼šè¢«é˜»å¡ã€‚å°½ç®¡ è¿˜æ²¡æœ‰ age = 37 è¿™æ¡æ•°æ®ã€‚\nå¦‚æœæ­¥éª¤1 æ‰§è¡Œçš„æ˜¯ select * employee where age \u0026gt;= 30 ï¼Œé‚£ä¹ˆé”çš„èŒƒå›´æ˜¯ (30, æ­£æ— ç©·)\nä¸´é”®é”(Next-key Locks) Next-Key Locksæ˜¯è¡Œé”ä¸é—´éš™é”çš„ç»„åˆã€‚\né”å‡çº§ æ— ç´¢å¼•è¡Œé”ä¼šå‡çº§ä¸ºè¡¨é”(RRçº§åˆ«ä¼šå‡çº§ä¸ºè¡¨é”ï¼ŒRCçº§åˆ«ä¸ä¼šå‡çº§ä¸ºè¡¨é”)\né”ä¸»è¦æ˜¯åŠ åœ¨ç´¢å¼•ä¸Šï¼Œå¦‚æœå¯¹éç´¢å¼•å­—æ®µæ›´æ–°ï¼Œè¡Œé”å¯èƒ½ä¼šå˜è¡¨é”\nInnoDBçš„è¡Œé”æ˜¯é’ˆå¯¹ç´¢å¼•åŠ çš„é”ï¼Œä¸æ˜¯é’ˆå¯¹è®°å½•åŠ çš„é”ã€‚å¹¶ä¸”è¯¥ç´¢å¼•ä¸èƒ½å¤±æ•ˆï¼Œå¦åˆ™éƒ½ä¼šä»è¡Œé”å‡çº§ä¸ºè¡¨é”ã€‚\né”å®šæŸä¸€è¡Œè¿˜å¯ä»¥ç”¨lock in share mode(å…±äº«é”) å’Œfor update(æ’å®ƒé”)ï¼Œä¾‹å¦‚ï¼šselect * from test_innodb_lock where a = 2 for update; è¿™æ ·å…¶ä»–sessionåªèƒ½è¯»è¿™è¡Œæ•°æ®ï¼Œä¿®æ”¹åˆ™ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é”å®šè¡Œçš„sessionæäº¤\né”çš„ä¸€äº›æŒ‡æ ‡ é€šè¿‡æ£€æŸ¥innoDB_row_lockçŠ¶æ€å˜é‡æ¥åˆ†æç³»ç»Ÿä¸Šçš„è¡Œé”çš„äº‰å¤ºæƒ…å†µ\nshow status like 'innodb_row_lock%';\nå¯¹å„ä¸ªçŠ¶æ€é‡çš„è¯´æ˜å¦‚ä¸‹ï¼š\nInnodb_row_lock_current_waits: å½“å‰æ­£åœ¨ç­‰å¾…é”å®šçš„æ•°é‡ Innodb_row_lock_time: ä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨é”å®šæ€»æ—¶é—´é•¿åº¦ Innodb_row_lock_time_avg: æ¯æ¬¡ç­‰å¾…æ‰€èŠ±å¹³å‡æ—¶é—´ Innodb_row_lock_time_maxï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨ç­‰å¾…æœ€é•¿çš„ä¸€æ¬¡æ‰€èŠ±æ—¶é—´ Innodb_row_lock_waits: ç³»ç»Ÿå¯åŠ¨ååˆ°ç°åœ¨æ€»å…±ç­‰å¾…çš„æ¬¡æ•° å¯¹äºè¿™5ä¸ªçŠ¶æ€å˜é‡ï¼Œæ¯”è¾ƒé‡è¦çš„ä¸»è¦æ˜¯ï¼š\nInnodb_row_lock_time_avg ï¼ˆç­‰å¾…å¹³å‡æ—¶é•¿ï¼‰ Innodb_row_lock_waits ï¼ˆç­‰å¾…æ€»æ¬¡æ•°ï¼‰ Innodb_row_lock_timeï¼ˆç­‰å¾…æ€»æ—¶é•¿ï¼‰ å°¤å…¶æ˜¯å½“ç­‰å¾…æ¬¡æ•°å¾ˆé«˜ï¼Œè€Œä¸”æ¯æ¬¡ç­‰å¾…æ—¶é•¿ä¹Ÿä¸å°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦åˆ†æç³»ç»Ÿä¸­ä¸ºä»€ä¹ˆä¼šæœ‰å¦‚æ­¤å¤šçš„ç­‰å¾…ï¼Œç„¶åæ ¹æ®åˆ†æç»“æœç€æ‰‹åˆ¶å®šä¼˜åŒ–è®¡åˆ’ã€‚\næŸ¥çœ‹INFORMATION_SCHEMAç³»ç»Ÿåº“é”ç›¸å…³æ•°æ®è¡¨\n-- æŸ¥çœ‹äº‹åŠ¡ select * from INFORMATION_SCHEMA.INNODB_TRX; -- æŸ¥çœ‹é” select * from INFORMATION_SCHEMA.INNODB_LOCKS; -- æŸ¥çœ‹é”ç­‰å¾… select * from INFORMATION_SCHEMA.INNODB_LOCK_WAITS; -- é‡Šæ”¾é”ï¼Œtrx_mysql_thread_idå¯ä»¥ä»INNODB_TRXè¡¨é‡ŒæŸ¥çœ‹åˆ° kill trx_mysql_thread_id -- æŸ¥çœ‹é”ç­‰å¾…è¯¦ç»†ä¿¡æ¯ show engine innodb status ; æ­»é”æ¼”ç¤º set tx_isolation=\u0026#39;repeatable-read\u0026#39;; Session_1æ‰§è¡Œï¼šselect * from account where id=1 for update;\nSession_2æ‰§è¡Œï¼šselect * from account where id=2 for update;\nSession_1æ‰§è¡Œï¼šselect * from account where id=2 for update;\nSession_2æ‰§è¡Œï¼šselect * from account where id=1 for update;\næŸ¥çœ‹è¿‘æœŸæ­»é”æ—¥å¿—ä¿¡æ¯ï¼šshow engine innodb status;\nå¤§å¤šæ•°æƒ…å†µmysqlå¯ä»¥è‡ªåŠ¨æ£€æµ‹æ­»é”å¹¶å›æ»šäº§ç”Ÿæ­»é”çš„é‚£ä¸ªäº‹åŠ¡ï¼Œä½†æ˜¯æœ‰äº›æƒ…å†µmysqlæ²¡æ³•è‡ªåŠ¨æ£€æµ‹æ­»é”\né”ä¼˜åŒ–å»ºè®® å°½å¯èƒ½è®©æ‰€æœ‰æ•°æ®æ£€ç´¢éƒ½é€šè¿‡ç´¢å¼•æ¥å®Œæˆï¼Œé¿å…æ— ç´¢å¼•è¡Œé”å‡çº§ä¸ºè¡¨é” åˆç†è®¾è®¡ç´¢å¼•ï¼Œå°½é‡ç¼©å°é”çš„èŒƒå›´ å°½å¯èƒ½å‡å°‘æ£€ç´¢æ¡ä»¶èŒƒå›´ï¼Œé¿å…é—´éš™é” å°½é‡æ§åˆ¶äº‹åŠ¡å¤§å°ï¼Œå‡å°‘é”å®šèµ„æºé‡å’Œæ—¶é—´é•¿åº¦ï¼Œæ¶‰åŠäº‹åŠ¡åŠ é”çš„sqlå°½é‡æ”¾åœ¨äº‹åŠ¡æœ€åæ‰§è¡Œ å°½å¯èƒ½ä½çº§åˆ«äº‹åŠ¡éš”ç¦» æ€»ç»“ Innodbå­˜å‚¨å¼•æ“ç”±äºå®ç°äº†è¡Œçº§é”å®šï¼Œè™½ç„¶åœ¨é”å®šæœºåˆ¶çš„å®ç°æ–¹é¢æ‰€å¸¦æ¥çš„æ€§èƒ½æŸè€—å¯èƒ½æ¯”è¡¨çº§é”å®šä¼šè¦æ›´é«˜ä¸€ä¸‹ï¼Œä½†æ˜¯åœ¨æ•´ä½“å¹¶å‘å¤„ç†èƒ½åŠ›æ–¹é¢è¦è¿œè¿œä¼˜äºMYISAMçš„è¡¨çº§é”å®šçš„ã€‚å½“ç³»ç»Ÿå¹¶å‘é‡é«˜çš„æ—¶å€™ï¼ŒInnodbçš„æ•´ä½“æ€§èƒ½å’ŒMYISAMç›¸æ¯”å°±ä¼šæœ‰æ¯”è¾ƒæ˜æ˜¾çš„ä¼˜åŠ¿äº†ã€‚\nä½†æ˜¯ï¼ŒInnodbçš„è¡Œçº§é”å®šåŒæ ·ä¹Ÿæœ‰å…¶è„†å¼±çš„ä¸€é¢ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ä¸å½“çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šè®©Innodbçš„æ•´ä½“æ€§èƒ½è¡¨ç°ä¸ä»…ä¸èƒ½æ¯”MYISAMé«˜ï¼Œç”šè‡³å¯èƒ½ä¼šæ›´å·®ã€‚\n","date":"2022-08-03T23:16:55Z","permalink":"https://dccmmtop.github.io/posts/mysql%E4%BA%8B%E5%8A%A1%E5%92%8C%E9%94%81/","section":"posts","tags":["MySQL"],"title":"MySQLäº‹åŠ¡å’Œé”è¯¦è§£"},{"categories":null,"contents":"CREATE TABLE `employees` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(24) NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;å§“å\u0026#39;, `age` int(11) NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;å¹´é¾„\u0026#39;, `position` varchar(20) NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;èŒä½\u0026#39;, `hire_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;å…¥èŒæ—¶é—´\u0026#39;, PRIMARY KEY (`id`), KEY `idx_name_age_position` (`name`,`age`,`position`) USING BTREE ) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COMMENT=\u0026#39;å‘˜å·¥è®°å½•è¡¨\u0026#39;; INSERT INTO employees(name,age,position,hire_time) VALUES(\u0026#39;LiLei\u0026#39;,22,\u0026#39;manager\u0026#39;,NOW()); INSERT INTO employees(name,age,position,hire_time) VALUES(\u0026#39;HanMeimei\u0026#39;, 23,\u0026#39;dev\u0026#39;,NOW()); INSERT INTO employees(name,age,position,hire_time) VALUES(\u0026#39;Lucy\u0026#39;,23,\u0026#39;dev\u0026#39;,NOW()); â€â€ æ’å…¥ä¸€äº›ç¤ºä¾‹æ•°æ® drop procedure if exists insert_emp; delimiter ;; create procedure insert_emp() begin declare i int; set i=1; while(i\u0026lt;=100000)do insert into employees(name,age,position) values(CONCAT(\u0026#39;zhuge\u0026#39;,i),i,\u0026#39;dev\u0026#39;); set i=i+1; end while; end;; delimiter ; call insert_emp(); å¦‚ä¸Šæœ‰ employees è¡¨ï¼Œæœ‰ä¸»é”®ç´¢å¼•å’Œ (name, age, position ) è”åˆç´¢å¼•, çœ‹ä¸‹é¢çš„æŸ¥è¯¢ç¤ºä¾‹:\nè”åˆç´¢å¼•çš„é¦–å­—æ®µç”¨èŒƒå›´æŸ¥è¯¢ EXPLAIN SELECT * FROM employees WHERE name \u0026gt; \u0026#39;LiLei\u0026#39; AND age = 22 AND position =\u0026#39;manager\u0026#39;; ç»“è®ºï¼šè”åˆç´¢å¼•ç¬¬ä¸€ä¸ªå­—æ®µå°±ç”¨èŒƒå›´æŸ¥æ‰¾ä¸ä¼šèµ°ç´¢å¼•ï¼Œmysqlå†…éƒ¨å¯èƒ½è§‰å¾—ç¬¬ä¸€ä¸ªå­—æ®µå°±ç”¨èŒƒå›´ï¼Œç»“æœé›†åº”è¯¥å¾ˆå¤§ï¼Œå›è¡¨æ•ˆç‡ä¸é«˜ï¼Œè¿˜ä¸å¦‚å°±å…¨è¡¨æ‰«æ\nå¼ºåˆ¶èµ°ç´¢å¼• EXPLAIN SELECT * FROM employees force index(idx_name_age_position) WHERE name \u0026gt; \u0026#39;LiLei\u0026#39; AND age = 22 AND position =\u0026#39;manager\u0026#39;; ç»“è®ºï¼šè™½ç„¶ä½¿ç”¨äº†å¼ºåˆ¶èµ°ç´¢å¼•è®©è”åˆç´¢å¼•ç¬¬ä¸€ä¸ªå­—æ®µèŒƒå›´æŸ¥æ‰¾ä¹Ÿèµ°ç´¢å¼•ï¼Œæ‰«æçš„è¡Œrowsçœ‹ä¸Šå»ä¹Ÿå°‘äº†ç‚¹ï¼Œä½†æ˜¯æœ€ç»ˆæŸ¥æ‰¾æ•ˆç‡ä¸ä¸€å®šæ¯”å…¨è¡¨æ‰«æé«˜ï¼Œå› ä¸ºå›è¡¨æ•ˆç‡ä¸é«˜ï¼Œ ä¸€èˆ¬ä¸ä¼šä½¿ç”¨è¿™ä¸ªæ‰‹æ®µï¼Œé™¤éæœ‰è¯æ®èƒ½è¯æ˜å¼ºåˆ¶èµ°ç´¢å¼•åæ•ˆç‡å¤§å¹…åº¦æé«˜\nè¦†ç›–ç´¢å¼•ä¼˜åŒ– EXPLAIN SELECT name,age,position FROM employees WHERE name \u0026gt; \u0026#39;LiLei\u0026#39; AND age = 22 AND position =\u0026#39;manager\u0026#39;; å°† select * ä¿®æ”¹ä¸º select name, age, posiion ï¼Œ åªé€‰æ‹©ç´¢å¼•ä¸­å·²ç»å­˜åœ¨çš„åˆ—ï¼Œå¯ä»¥ä¸ç”¨å›è¡¨ï¼Œæ‰€ä»¥ä¼šåˆ©ç”¨ç´¢å¼•\ninå’Œorä»€ä¹ˆæ—¶å€™ä¼šèµ°ç´¢å¼• åœ¨è¡¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„æƒ…å†µä¼šèµ°ç´¢å¼•ï¼Œæ•°æ®é‡ä¸å¤šçš„æƒ…å†µä¸‹ä¼šé€‰æ‹©å…¨è¡¨æ‰«æ,ç¤ºä¾‹å¦‚ä¸‹:\nin æŸ¥è¯¢\nEXPLAIN SELECT * FROM employees WHERE name in (\u0026#39;LiLei\u0026#39;,\u0026#39;HanMeimei\u0026#39;,\u0026#39;Lucy\u0026#39;) AND age = 22 AND position =\u0026#39;manager\u0026#39;; ç”¨åˆ°å…¨éƒ¨ç´¢å¼•\nor æŸ¥è¯¢\nEXPLAIN SELECT * FROM employees WHERE (name = \u0026#39;LiLei\u0026#39; or name = \u0026#39;HanMeimei\u0026#39;) AND age = 22 AND position =\u0026#39;manager\u0026#39;; ç”¨åˆ°å…¨éƒ¨ç´¢å¼•\nä¸‹é¢æ–°å»ºä¸€å¼  employees_copy è¡¨ï¼Œç»“æ„å’Œ employee ä¸€æ ·ï¼Œä½†æ•°æ®åªæœ‰ä¸‰æ¡, å†æ‰§è¡Œä¸Šé¢ä¸¤ä¸ªæŸ¥è¯¢\nin æŸ¥è¯¢\nEXPLAIN SELECT * FROM employees_copy WHERE name in (\u0026#39;LiLei\u0026#39;,\u0026#39;HanMeimei\u0026#39;,\u0026#39;Lucy\u0026#39;) AND age = 22 AND position =\u0026#39;manager\u0026#39;; å…¨è¡¨æ‰«æ\noræŸ¥è¯¢\nEXPLAIN SELECT * FROM employees_copy WHERE (name = \u0026#39;LiLei\u0026#39; or name = \u0026#39;HanMeimei\u0026#39;) AND age = 22 AND position =\u0026#39;manager\u0026#39;; å…¨è¡¨æ‰«æ\nlike xx% ä¸€èˆ¬éƒ½ä¼šèµ°ç´¢å¼•ï¼Œå’Œæ•°æ®é‡æ— å…³ å¤§è¡¨\nEXPLAIN SELECT * FROM employees WHERE name like \u0026#39;LiLei%\u0026#39; AND age = 22 AND position =\u0026#39;manager\u0026#39;; å°è¡¨\nEXPLAIN SELECT * FROM employees_copy WHERE name like \u0026#39;LiLei%\u0026#39; AND age = 22 AND position =\u0026#39;manager\u0026#39;; å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºè¡¨çš„æ•°æ®é‡å¤§å°ï¼Œéƒ½ä¼šåˆ©ç”¨ç´¢å¼•ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ\nå…¶å® like ç”¨åˆ°äº†ç´¢å¼•ä¸‹æ¨çš„ä¼˜åŒ–\nç´¢å¼•ä¸‹æ¨ å¯¹äºè¾…åŠ©è”åˆç´¢å¼•ï¼Œæ­£å¸¸æƒ…å†µä¸‹æŒ‰ç…§æœ€å·¦å‰ç¼€åŸåˆ™ï¼Œ SELECT * from employees where name like 'LiLei%' and age = 22 and position = 'dev' è¿™ç§æƒ…å†µä¸‹åªä¼šèµ°nameå­—æ®µçš„ç´¢å¼•ï¼Œå› ä¸ºæ ¹æ®nameå­—æ®µè¿‡æ»¤å®Œï¼Œå¾—åˆ°çš„ç´¢å¼•è¡Œé‡Œçš„ageå’Œpositionæ˜¯æ— åºçš„ï¼Œæ— æ³•å¾ˆå¥½çš„åˆ©ç”¨ç´¢å¼•ã€‚\nåœ¨MySQL5.6ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¿™ä¸ªæŸ¥è¯¢åªèƒ½åœ¨è”åˆç´¢å¼•é‡ŒåŒ¹é…åˆ°åå­—æ˜¯ \u0026lsquo;LiLei\u0026rsquo; å¼€å¤´çš„ç´¢å¼•ï¼Œç„¶åæ‹¿è¿™äº›ç´¢å¼•å¯¹åº”çš„ä¸»é”®é€ä¸ªå›è¡¨ï¼Œåˆ°ä¸»é”®ç´¢å¼•ä¸Šæ‰¾å‡ºç›¸åº”çš„è®°å½•ï¼Œå†æ¯”å¯¹ageå’Œpositionè¿™ä¸¤ä¸ªå­—æ®µçš„å€¼æ˜¯å¦ç¬¦åˆã€‚\nMySQL 5.6å¼•å…¥äº†ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–ï¼Œå¯ä»¥åœ¨ç´¢å¼•éå†è¿‡ç¨‹ä¸­ï¼Œå¯¹ç´¢å¼•ä¸­åŒ…å«çš„æ‰€æœ‰å­—æ®µå…ˆåšåˆ¤æ–­ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„è®°å½•ä¹‹åå†å›è¡¨ï¼Œå¯ä»¥æœ‰æ•ˆçš„å‡å°‘å›è¡¨æ¬¡æ•°ã€‚ä½¿ç”¨äº†ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–åï¼Œä¸Šé¢é‚£ä¸ªæŸ¥è¯¢åœ¨è”åˆç´¢å¼•é‡ŒåŒ¹é…åˆ°åå­—æ˜¯ \u0026lsquo;LiLei\u0026rsquo; å¼€å¤´çš„ç´¢å¼•ä¹‹åï¼ŒåŒæ—¶è¿˜ä¼šåœ¨ç´¢å¼•é‡Œè¿‡æ»¤ageå’Œpositionè¿™ä¸¤ä¸ªå­—æ®µï¼Œæ‹¿ç€è¿‡æ»¤å®Œå‰©ä¸‹çš„ç´¢å¼•å¯¹åº”çš„ä¸»é”®idå†å›è¡¨æŸ¥æ•´è¡Œæ•°æ®ã€‚\nç´¢å¼•ä¸‹æ¨ä¼šå‡å°‘å›è¡¨æ¬¡æ•°ï¼Œå¯¹äºinnodbå¼•æ“çš„è¡¨ç´¢å¼•ä¸‹æ¨åªèƒ½ç”¨äºäºŒçº§ç´¢å¼•ï¼Œinnodbçš„ä¸»é”®ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ï¼‰æ ‘å¶å­èŠ‚ç‚¹ä¸Šä¿å­˜çš„æ˜¯å…¨è¡Œæ•°æ®ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ç´¢å¼•ä¸‹æ¨å¹¶ä¸ä¼šèµ·åˆ°å‡å°‘æŸ¥è¯¢å…¨è¡Œæ•°æ®çš„æ•ˆæœã€‚\nä¸ºä»€ä¹ˆèŒƒå›´æŸ¥æ‰¾æ²¡æœ‰ç”¨ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–ï¼Ÿ ä¼°è®¡åº”è¯¥æ˜¯Mysqlè®¤ä¸ºèŒƒå›´æŸ¥æ‰¾è¿‡æ»¤çš„ç»“æœé›†è¿‡å¤§ï¼Œlike KK% åœ¨ç»å¤§å¤šæ•°æƒ…å†µæ¥çœ‹ï¼Œè¿‡æ»¤åçš„ç»“æœé›†æ¯”è¾ƒå°ï¼Œæ‰€ä»¥è¿™é‡ŒMysqlé€‰æ‹©ç»™ like KK% ç”¨äº†ç´¢å¼•ä¸‹æ¨ä¼˜åŒ–ï¼Œå½“ç„¶è¿™ä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œæœ‰æ—¶like KK% ä¹Ÿä¸ä¸€å®šå°±ä¼šèµ°ç´¢å¼•ä¸‹æ¨ã€‚\nå¦‚ä½•é€‰æ‹©ç´¢å¼• å…ˆçœ‹ä¸‹é¢çš„ä¸¤ä¸ªæŸ¥è¯¢:\nåŒæ ·çš„è¡¨ï¼ŒåŒæ ·çš„å­—æ®µï¼Œå› ä¸ºæ¡ä»¶çš„ä¸åŒï¼Œé€‰æ‹©çš„ç´¢å¼•ä¹Ÿä¸åŒï¼ŒMySQL æ˜¯å¦‚ä½•é€‰æ‹©çš„å‘¢ï¼Ÿ\nTrace å·¥å…· MySQl æä¾›äº†ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥çœ‹åˆ°é€‰æ‹©ç´¢å¼•çš„è®¡ç®—è¿‡ç¨‹ï¼Œ ç”¨æ³•å¦‚ä¸‹:\nmysql\u0026gt; set session optimizer_trace=\u0026#34;enabled=on\u0026#34;,end_markers_in_json=on; --å¼€å¯trace mysql\u0026gt; select * from employees where name \u0026gt; \u0026#39;a\u0026#39; order by position; mysql\u0026gt; SELECT * FROM information_schema.OPTIMIZER_TRACE; ä¸‹é¢æ˜¯å¯¹ trace å­—æ®µçš„è§£æ\n{ \u0026#34;steps\u0026#34;: [ { \u0026#34;join_preparation\u0026#34;: { //ç¬¬ä¸€é˜¶æ®µï¼šSQLå‡†å¤‡é˜¶æ®µï¼Œæ ¼å¼åŒ–sql \u0026#34;select#\u0026#34;: 1, \u0026#34;steps\u0026#34;: [ { \u0026#34;expanded_query\u0026#34;: \u0026#34;/* select#1 */ select `employees`.`id` AS `id`,`employees`.`name` AS `name`,`employees`.`age` AS `age`,`employees`.`position` AS `position`,`employees`.`hire_time` AS `hire_time` from `employees` where (`employees`.`name` \u0026gt; \u0026#39;a\u0026#39;) order by `employees`.`position`\u0026#34; } ] /* steps */ } /* join_preparation */ }, { \u0026#34;join_optimization\u0026#34;: { //ç¬¬äºŒé˜¶æ®µï¼šSQLä¼˜åŒ–é˜¶æ®µ \u0026#34;select#\u0026#34;: 1, \u0026#34;steps\u0026#34;: [ { \u0026#34;condition_processing\u0026#34;: { //æ¡ä»¶å¤„ç† \u0026#34;condition\u0026#34;: \u0026#34;WHERE\u0026#34;, \u0026#34;original_condition\u0026#34;: \u0026#34;(`employees`.`name` \u0026gt; \u0026#39;a\u0026#39;)\u0026#34;, \u0026#34;steps\u0026#34;: [ { \u0026#34;transformation\u0026#34;: \u0026#34;equality_propagation\u0026#34;, \u0026#34;resulting_condition\u0026#34;: \u0026#34;(`employees`.`name` \u0026gt; \u0026#39;a\u0026#39;)\u0026#34; }, { \u0026#34;transformation\u0026#34;: \u0026#34;constant_propagation\u0026#34;, \u0026#34;resulting_condition\u0026#34;: \u0026#34;(`employees`.`name` \u0026gt; \u0026#39;a\u0026#39;)\u0026#34; }, { \u0026#34;transformation\u0026#34;: \u0026#34;trivial_condition_removal\u0026#34;, \u0026#34;resulting_condition\u0026#34;: \u0026#34;(`employees`.`name` \u0026gt; \u0026#39;a\u0026#39;)\u0026#34; } ] /* steps */ } /* condition_processing */ }, { \u0026#34;substitute_generated_columns\u0026#34;: { } /* substitute_generated_columns */ }, { \u0026#34;table_dependencies\u0026#34;: [ //è¡¨ä¾èµ–è¯¦æƒ… { \u0026#34;table\u0026#34;: \u0026#34;`employees`\u0026#34;, \u0026#34;row_may_be_null\u0026#34;: false, \u0026#34;map_bit\u0026#34;: 0, \u0026#34;depends_on_map_bits\u0026#34;: [ ] /* depends_on_map_bits */ } ] /* table_dependencies */ }, { \u0026#34;ref_optimizer_key_uses\u0026#34;: [ ] /* ref_optimizer_key_uses */ }, { \u0026#34;rows_estimation\u0026#34;: [ //é¢„ä¼°è¡¨çš„è®¿é—®æˆæœ¬ { \u0026#34;table\u0026#34;: \u0026#34;`employees`\u0026#34;, \u0026#34;range_analysis\u0026#34;: { \u0026#34;table_scan\u0026#34;: { //å…¨è¡¨æ‰«ææƒ…å†µ \u0026#34;rows\u0026#34;: 10123, //æ‰«æè¡Œæ•° \u0026#34;cost\u0026#34;: 2054.7 //æŸ¥è¯¢æˆæœ¬ } /* table_scan */, \u0026#34;potential_range_indexes\u0026#34;: [ //æŸ¥è¯¢å¯èƒ½ä½¿ç”¨çš„ç´¢å¼• { \u0026#34;index\u0026#34;: \u0026#34;PRIMARY\u0026#34;, //ä¸»é”®ç´¢å¼• \u0026#34;usable\u0026#34;: false, \u0026#34;cause\u0026#34;: \u0026#34;not_applicable\u0026#34; }, { \u0026#34;index\u0026#34;: \u0026#34;idx_name_age_position\u0026#34;, //è¾…åŠ©ç´¢å¼• \u0026#34;usable\u0026#34;: true, \u0026#34;key_parts\u0026#34;: [ \u0026#34;name\u0026#34;, \u0026#34;age\u0026#34;, \u0026#34;position\u0026#34;, \u0026#34;id\u0026#34; ] /* key_parts */ } ] /* potential_range_indexes */, \u0026#34;setup_range_conditions\u0026#34;: [ ] /* setup_range_conditions */, \u0026#34;group_index_range\u0026#34;: { \u0026#34;chosen\u0026#34;: false, \u0026#34;cause\u0026#34;: \u0026#34;not_group_by_or_distinct\u0026#34; } /* group_index_range */, \u0026#34;analyzing_range_alternatives\u0026#34;: { //åˆ†æå„ä¸ªç´¢å¼•ä½¿ç”¨æˆæœ¬ \u0026#34;range_scan_alternatives\u0026#34;: [ { \u0026#34;index\u0026#34;: \u0026#34;idx_name_age_position\u0026#34;, \u0026#34;ranges\u0026#34;: [ \u0026#34;a \u0026lt; name\u0026#34; //ç´¢å¼•ä½¿ç”¨èŒƒå›´ ] /* ranges */, \u0026#34;index_dives_for_eq_ranges\u0026#34;: true, \u0026#34;rowid_ordered\u0026#34;: false, //ä½¿ç”¨è¯¥ç´¢å¼•è·å–çš„è®°å½•æ˜¯å¦æŒ‰ç…§ä¸»é”®æ’åº \u0026#34;using_mrr\u0026#34;: false, \u0026#34;index_only\u0026#34;: false, //æ˜¯å¦ä½¿ç”¨è¦†ç›–ç´¢å¼• \u0026#34;rows\u0026#34;: 5061, //ç´¢å¼•æ‰«æè¡Œæ•° \u0026#34;cost\u0026#34;: 6074.2, //ç´¢å¼•ä½¿ç”¨æˆæœ¬ \u0026#34;chosen\u0026#34;: false, //æ˜¯å¦é€‰æ‹©è¯¥ç´¢å¼• \u0026#34;cause\u0026#34;: \u0026#34;cost\u0026#34; } ] /* range_scan_alternatives */, \u0026#34;analyzing_roworder_intersect\u0026#34;: { \u0026#34;usable\u0026#34;: false, \u0026#34;cause\u0026#34;: \u0026#34;too_few_roworder_scans\u0026#34; } /* analyzing_roworder_intersect */ } /* analyzing_range_alternatives */ } /* range_analysis */ } ] /* rows_estimation */ }, { \u0026#34;considered_execution_plans\u0026#34;: [ { \u0026#34;plan_prefix\u0026#34;: [ ] /* plan_prefix */, \u0026#34;table\u0026#34;: \u0026#34;`employees`\u0026#34;, \u0026#34;best_access_path\u0026#34;: { //æœ€ä¼˜è®¿é—®è·¯å¾„ \u0026#34;considered_access_paths\u0026#34;: [ //æœ€ç»ˆé€‰æ‹©çš„è®¿é—®è·¯å¾„ { \u0026#34;rows_to_scan\u0026#34;: 10123, \u0026#34;access_type\u0026#34;: \u0026#34;scan\u0026#34;, //è®¿é—®ç±»å‹ï¼šä¸ºscanï¼Œå…¨è¡¨æ‰«æ \u0026#34;resulting_rows\u0026#34;: 10123, \u0026#34;cost\u0026#34;: 2052.6, \u0026#34;chosen\u0026#34;: true, //ç¡®å®šé€‰æ‹© \u0026#34;use_tmp_table\u0026#34;: true } ] /* considered_access_paths */ } /* best_access_path */, \u0026#34;condition_filtering_pct\u0026#34;: 100, \u0026#34;rows_for_plan\u0026#34;: 10123, \u0026#34;cost_for_plan\u0026#34;: 2052.6, \u0026#34;sort_cost\u0026#34;: 10123, \u0026#34;new_cost_for_plan\u0026#34;: 12176, \u0026#34;chosen\u0026#34;: true } ] /* considered_execution_plans */ }, { \u0026#34;attaching_conditions_to_tables\u0026#34;: { \u0026#34;original_condition\u0026#34;: \u0026#34;(`employees`.`name` \u0026gt; \u0026#39;a\u0026#39;)\u0026#34;, \u0026#34;attached_conditions_computation\u0026#34;: [ ] /* attached_conditions_computation */, \u0026#34;attached_conditions_summary\u0026#34;: [ { \u0026#34;table\u0026#34;: \u0026#34;`employees`\u0026#34;, \u0026#34;attached\u0026#34;: \u0026#34;(`employees`.`name` \u0026gt; \u0026#39;a\u0026#39;)\u0026#34; } ] /* attached_conditions_summary */ } /* attaching_conditions_to_tables */ }, { \u0026#34;clause_processing\u0026#34;: { \u0026#34;clause\u0026#34;: \u0026#34;ORDER BY\u0026#34;, \u0026#34;original_clause\u0026#34;: \u0026#34;`employees`.`position`\u0026#34;, \u0026#34;items\u0026#34;: [ { \u0026#34;item\u0026#34;: \u0026#34;`employees`.`position`\u0026#34; } ] /* items */, \u0026#34;resulting_clause_is_simple\u0026#34;: true, \u0026#34;resulting_clause\u0026#34;: \u0026#34;`employees`.`position`\u0026#34; } /* clause_processing */ }, { \u0026#34;reconsidering_access_paths_for_index_ordering\u0026#34;: { \u0026#34;clause\u0026#34;: \u0026#34;ORDER BY\u0026#34;, \u0026#34;steps\u0026#34;: [ ] /* steps */, \u0026#34;index_order_summary\u0026#34;: { \u0026#34;table\u0026#34;: \u0026#34;`employees`\u0026#34;, \u0026#34;index_provides_order\u0026#34;: false, \u0026#34;order_direction\u0026#34;: \u0026#34;undefined\u0026#34;, \u0026#34;index\u0026#34;: \u0026#34;unknown\u0026#34;, \u0026#34;plan_changed\u0026#34;: false } /* index_order_summary */ } /* reconsidering_access_paths_for_index_ordering */ }, { \u0026#34;refine_plan\u0026#34;: [ { \u0026#34;table\u0026#34;: \u0026#34;`employees`\u0026#34; } ] /* refine_plan */ } ] /* steps */ } /* join_optimization */ }, { \u0026#34;join_execution\u0026#34;: { //ç¬¬ä¸‰é˜¶æ®µï¼šSQLæ‰§è¡Œé˜¶æ®µ \u0026#34;select#\u0026#34;: 1, \u0026#34;steps\u0026#34;: [ ] /* steps */ } /* join_execution */ } ] /* steps */ } // ç»“è®ºï¼šå…¨è¡¨æ‰«æçš„æˆæœ¬ä½äºç´¢å¼•æ‰«æï¼Œæ‰€ä»¥mysqlæœ€ç»ˆé€‰æ‹©å…¨è¡¨æ‰«æ mysql\u0026gt; select * from employees where name \u0026gt; \u0026#39;zzz\u0026#39; order by position; mysql\u0026gt; SELECT * FROM information_schema.OPTIMIZER_TRACE; # æŸ¥çœ‹traceå­—æ®µå¯çŸ¥ç´¢å¼•æ‰«æçš„æˆæœ¬ä½äºå…¨è¡¨æ‰«æï¼Œæ‰€ä»¥mysqlæœ€ç»ˆé€‰æ‹©ç´¢å¼•æ‰«æ mysql\u0026gt; set session optimizer_trace=\u0026#34;enabled=off\u0026#34;; //å…³é—­trace æ·±å…¥ä¼˜åŒ– order by å’Œ group by order by å’Œ group by ä¹Ÿä¼šéµå¾ªå·¦å‰ç¼€æ³•åˆ™, å¦‚ä¸‹ä¾‹å­\næ ¹æ®å·¦å‰ç¼€æ³•åˆ™ï¼Œç”¨åˆ°äº† name å­—æ®µçš„ç´¢å¼•ï¼ŒåŒæ—¶ä½¿ç”¨ age å­—æ®µç”¨æ¥æ’åºï¼Œ å› ä¸º extra ç§æ²¡æœ‰ filesort\norder by æˆ–è€… group by ç”¨åˆ°çš„ç´¢å¼•ä¸ä¼šå‚ä¸åˆ° key_len çš„è®¡ç®—ï¼Œç´¢å¼• key_len ä»ç„¶åªæ˜¯ 74ï¼Œ å³ nameå­—æ®µçš„é•¿åº¦\nå†çœ‹ä¸‹é¢ä¸€ä¸ªä¾‹å­:\nwhere æ¡ä»¶æ˜¯name æ’åºå­—æ®µæ˜¯ position è·³è¿‡äº†ageå­—æ®µï¼Œæ‰€ä»¥åªèƒ½ç”¨ name ç´¢å¼•ï¼Œæ— æ³•åˆ©ç”¨ position ç´¢å¼•è¿›è¡Œç´¢å¼•æ’åºï¼Œç”¨åˆ°æ˜¯æ–‡ä»¶æ’åº\nå†çœ‹ç¬¬ä¸‰ä¸ªä¾‹å­:\nä½¿ç”¨nameæ¡ä»¶æŸ¥è¯¢ï¼Œ åŒæ—¶ä½¿ç”¨ age position åŒå­—æ®µæ’åºï¼Œæ²¡æœ‰è·³è¿‡è”åˆç´¢å¼•çš„å­—æ®µ. æ‰€ä»¥å¯ä»¥ç”¨ç´¢å¼•æ’åº\nç„¶åé¢ å€’ä¸€ä¸‹æ’åºé¡ºåºï¼Œå…ˆposition å† ageï¼š\nå‘ç°æ­¤æ—¶åªèƒ½æ–‡ä»¶æ’åºäº†\nå†çœ‹ä¸‹é¢çš„ä¾‹å­\nè™½ç„¶æ’åºå­—æ®µä¸ç´¢å¼•å­—æ®µä¸ä¸€æ ·ï¼Œä½†ä»ç„¶æ˜¯ç´¢å¼•æ’åºï¼Œ å› ä¸ºæŸ¥è¯¢æ¡ä»¶ä¸­ ç”¨åˆ°æ˜¯ ï¼ˆnameï¼Œ ageï¼‰ç´¢å¼•ï¼Œæ’åºä¸­ç”¨åˆ°æ˜¯ position ç´¢å¼•ï¼Œå¹¶æ²¡æœ‰é¢ å€’é¡ºåºã€‚æ‰€ä»¥è¿˜æ˜¯ç´¢å¼•æ’åº\nå¦‚æœä¸€ä¸ªæ­£åºä¸€ä¸ªå€’åºå‘¢ï¼Ÿ\nè™½ç„¶æ’åºå­—æ®µä¸ç´¢å¼•å­—æ®µé¡ºåºç›¸åŒï¼Œ ä½†æ˜¯ age æ˜¯æ­£åºï¼Œ position æ˜¯å€’å™ï¼Œå¯¼è‡´ä¸ç´¢å¼•çš„æ’åºæ–¹å¼ä¸åŒï¼Œæ— æ³•åˆ©ç”¨ç´¢å¼•ã€‚ä»è€Œå‘ç”Ÿäº†æ–‡ä»¶æ’åºï¼Œ Mysql8ä»¥ä¸Šç‰ˆæœ¬æœ‰é™åºç´¢å¼•å¯ä»¥æ”¯æŒè¯¥ç§æŸ¥è¯¢æ–¹å¼ã€‚\nå…ˆ in æŸ¥è¯¢:\nå¯¹äºæ’åºæ¥è¯´ï¼Œå¤šä¸ªç›¸ç­‰æ¡ä»¶ä¹Ÿæ˜¯èŒƒå›´æŸ¥è¯¢, æ— æ³•åˆ©ç”¨ç´¢å¼•æ’åº\nå…ˆèŒƒå›´æŸ¥è¯¢:\nè¿™é‡Œå‘ç”Ÿäº†å…¨è¡¨æ‰«æï¼Œæ²¡æœ‰ä»»ä½•ç´¢å¼•ï¼Œæ’åºè‡ªç„¶ä¹Ÿæ— æ³•åˆ©ç”¨ç´¢å¼•äº†ï¼Œå¯ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•ä¼˜åŒ–:\nä¼˜åŒ–æ€»ç»“ MySQLæ”¯æŒä¸¤ç§æ–¹å¼çš„æ’åºfilesortå’Œindexï¼ŒUsing indexæ˜¯æŒ‡MySQLæ‰«æç´¢å¼•æœ¬èº«å®Œæˆæ’åºã€‚indexæ•ˆç‡é«˜ï¼Œfilesortæ•ˆç‡ä½ã€‚ 2ã€order byæ»¡è¶³ä¸¤ç§æƒ…å†µä¼šä½¿ç”¨Using indexã€‚\norder byè¯­å¥ä½¿ç”¨ç´¢å¼•æœ€å·¦å‰åˆ—ã€‚\nä½¿ç”¨whereå­å¥ä¸order byå­å¥æ¡ä»¶åˆ—ç»„åˆæ»¡è¶³ç´¢å¼•æœ€å·¦å‰åˆ—ã€‚\nå°½é‡åœ¨ç´¢å¼•åˆ—ä¸Šå®Œæˆæ’åºï¼Œéµå¾ªç´¢å¼•å»ºç«‹ï¼ˆç´¢å¼•åˆ›å»ºçš„é¡ºåºï¼‰æ—¶çš„æœ€å·¦å‰ç¼€æ³•åˆ™ã€‚\nå¦‚æœorder byçš„æ¡ä»¶ä¸åœ¨ç´¢å¼•åˆ—ä¸Šï¼Œå°±ä¼šäº§ç”ŸUsing filesortã€‚\nèƒ½ç”¨è¦†ç›–ç´¢å¼•å°½é‡ç”¨è¦†ç›–ç´¢å¼•\ngroup byä¸order byå¾ˆç±»ä¼¼ï¼Œå…¶å®è´¨æ˜¯å…ˆæ’åºååˆ†ç»„ï¼Œéµç…§ç´¢å¼•åˆ›å»ºé¡ºåºçš„æœ€å·¦å‰ç¼€æ³•åˆ™ã€‚å¯¹äºgroup byçš„ä¼˜åŒ–å¦‚æœä¸éœ€è¦æ’åºçš„å¯ä»¥åŠ ä¸Šorder by nullç¦æ­¢æ’åºã€‚æ³¨æ„ï¼Œwhereé«˜äºhavingï¼Œèƒ½å†™åœ¨whereä¸­çš„é™å®šæ¡ä»¶å°±ä¸è¦å»havingé™å®šäº†ã€‚\nUsing filesortæ–‡ä»¶æ’åºåŸç†è¯¦è§£ å•è·¯æ’åºæ¨¡å¼ï¼› æ˜¯ä¸€æ¬¡æ€§å–å‡ºæ»¡è¶³æ¡ä»¶è¡Œçš„æ‰€æœ‰å­—æ®µï¼Œç„¶ååœ¨sort bufferä¸­è¿›è¡Œæ’åºï¼›ç”¨traceå·¥å…·å¯ä»¥çœ‹åˆ°sort_modeä¿¡æ¯é‡Œæ˜¾ç¤º\u0026lt; sort_key, additional_fields \u0026gt;æˆ–è€…\u0026lt; sort_key, packed_additional_fields \u0026gt;\nåŒè·¯æ’åºï¼ˆåˆå«å›è¡¨æ’åºæ¨¡å¼ï¼‰ æ˜¯é¦–å…ˆæ ¹æ®ç›¸åº”çš„æ¡ä»¶å–å‡ºç›¸åº”çš„æ’åºå­—æ®µå’Œå¯ä»¥ç›´æ¥å®šä½è¡Œæ•°æ®çš„è¡Œ IDï¼Œç„¶ååœ¨ sort buffer ä¸­è¿›è¡Œæ’åºï¼Œæ’åºå®Œåéœ€è¦å†æ¬¡å–å›å…¶å®ƒéœ€è¦çš„å­—æ®µï¼›ç”¨traceå·¥å…·å¯ä»¥çœ‹åˆ°sort_modeä¿¡æ¯é‡Œæ˜¾ç¤º\u0026lt; sort_key, rowid \u0026gt;\nMySQL é€šè¿‡æ¯”è¾ƒç³»ç»Ÿå˜é‡ max_length_for_sort_data(é»˜è®¤1024å­—èŠ‚) çš„å¤§å°å’Œéœ€è¦æŸ¥è¯¢çš„å­—æ®µæ€»å¤§å°æ¥åˆ¤æ–­ä½¿ç”¨å“ªç§æ’åºæ¨¡å¼ã€‚\nå¦‚æœ å­—æ®µçš„æ€»é•¿åº¦å°äºmax_length_for_sort_data ï¼Œé‚£ä¹ˆä½¿ç”¨ å•è·¯æ’åºæ¨¡å¼ï¼› å¦‚æœ å­—æ®µçš„æ€»é•¿åº¦å¤§äºmax_length_for_sort_data ï¼Œé‚£ä¹ˆä½¿ç”¨ åŒè·¯æ’åºæ¨¡Â·å¼ã€‚ åˆ†é¡µä¼˜åŒ– å¸¸è§„çš„limitåˆ†é¡µ æœ‰å¦‚ä¸‹æŸ¥è¯¢è¯­å¥\nselect * from employees limit 10000,10; è¯¥sqlå¹¶ä¸æ˜¯åªæŸ¥è¯¢äº†10æ¡ï¼Œè€Œæ˜¯æŸ¥æ‰¾äº†10010æ¡ï¼Œç„¶åæŠŠå‰10000æ¡ç»“æœç»™èˆå¼ƒæ‰, å› æ­¤è¦æŸ¥è¯¢ä¸€ä¸ªå¤§è¡¨é åçš„å†…å®¹ï¼Œæ‰§è¡Œæ•ˆç‡æ˜¯éå¸¸ä½çš„\nä¼˜åŒ– æ ¹æ®ä¸»é”®æ’åº ä¸Šé¢çš„ä¸‹é¢çš„sqlè¯­å¥æ²¡æœ‰æŒ‡å®šæ’åºæ–¹å¼ï¼Œé»˜è®¤ä½¿ç”¨IDæ’åºã€‚å½“ä½¿ç”¨IDæ’åºæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä¼˜åŒ–ã€‚\nselect * from employees where id \u0026gt; 90000 limit 5; å¦‚æœidæ˜¯è¿ç»­è‡ªå¢çš„ï¼Œå’Œlimit 90000,5 ç»“æœæ²¡æœ‰å·®åˆ«ï¼Œæ˜¯ 90001 ~ 90005 çš„æ•°æ®ã€‚\nä½†æ˜¯å¦‚æœåœ¨90000ä¹‹å‰åˆ é™¤äº†ä¸€æ¡æ•°æ®ï¼Œç»“æœå°±ä¸ä¸€æ ·äº†ï¼Œid \u0026gt; 90000 limit 5 çš„ç»“æœæ˜¯ 90001 ~ 90005ï¼Œ ä½†æ˜¯limit 90000, 5 çš„ç»“æœæ˜¯ 90002 ~ 90006ï¼Œ å¾ˆæ˜æ˜¾ 90002 ~ 90006 æ‰æ˜¯ç¬¦åˆæˆ‘ä»¬ç›´è§‰çš„ã€‚æ‰€ä»¥è¿™ä¸ªä¼˜åŒ–åªèƒ½é™åˆ¶ä¸æ’åºæ¡ä»¶æ˜¯è¿ç»­çš„ã€‚å¦‚æœidä¸æ˜¯è‡ªå¢çš„å‘¢ï¼Ÿä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µï¼Œå‡å¦‚ 90000 è¿™æ¡æ•°æ®æœ‰ä¸¤ä¸ªï¼Œlimit 90000, 5 çš„ç»“æœæ˜¯ 90000 ~ 90004ï¼Œè€Œ id \u0026gt; 90000 limit 5 çš„ç»“æœä»æ˜¯ 90001 ~ 90005ï¼Œ ä¼šæŠŠ id= 90000 çš„æ•°æ®æ¼æ‰ä¸€æ¡ã€‚\næ‰€ä»¥è¿™ä¸ªä¼˜åŒ–åªèƒ½ç”¨äºæ’åºçš„å­—æ®µæ˜¯è¿ç»­è‡ªå¢çš„ï¼Œå¹¶ä¸”ä¸èƒ½é‡å¤\néä¸»é”®æ’åºçš„ä¼˜åŒ– æœ‰å¦‚ä¸‹æŸ¥è¯¢è¯­å¥\nEXPLAIN select * from employees ORDER BY name limit 90000,5; å‘ç°å¹¶æ²¡æœ‰ç”¨ä¸Šnameçš„ç´¢å¼•ï¼Œå› ä¸º select * ,æ‰«æè”åˆç´¢å¼•æ—¶ï¼Œæ— æ³•çš„åˆ°å…¨éƒ¨æ•°æ®ï¼Œéœ€è¦å›è¡¨ï¼Œæˆæœ¬æ¯”å…¨è¡¨æ‰«ææ›´é«˜ï¼Œæ‰€ä»¥ä¼˜åŒ–å™¨æ”¾å¼ƒä½¿ç”¨ç´¢å¼•ã€‚\nå¯ä»¥ä½¿ç”¨ç´¢å¼•è¦†ç›–çš„æ–¹æ³•ï¼Œä½¿ç”¨åˆ†é¡µæŸ¥è¯¢ä»…ä»…æ‰¾åˆ°å°‘é‡çš„ä¸»é”®ï¼Œç„¶ååœ¨ä½¿ç”¨ä¸»é”®æŸ¥æ‰¾æ•´è¡Œæ•°æ®ï¼Œ å¦‚ä¸‹:\nselect * from employees e inner join (select id from employees order by name limit 90000,5) ed on e.id = ed.id; çœ‹ä¸‹æ‰§è¡Œè®¡åˆ’ï¼š\nåŸ SQL ä½¿ç”¨æ–‡ä»¶æ’åºï¼Œä¼˜åŒ–åçš„ä½¿ç”¨ç´¢å¼•æ’åº\nè¡¨å…³è”ä¼˜åŒ– å…ˆé€ ä¸€äº›æ•°æ®:\nCREATE TABLE `t1` ( `id` int(11) NOT NULL AUTO_INCREMENT, `a` int(11) DEFAULT NULL, `b` int(11) DEFAULT NULL, PRIMARY KEY (`id`), KEY `idx_a` (`a`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8; create table t2 like t1; -- æ’å…¥ä¸€äº›ç¤ºä¾‹æ•°æ® -- å¾€t1è¡¨æ’å…¥1ä¸‡è¡Œè®°å½• dropÂ procedureÂ ifÂ existsÂ insert_t1;Â delimiterÂ ;; createÂ procedureÂ insert_t1()Â begin declareÂ iÂ int;Â setÂ i=1;Â while(i\u0026lt;=10000)doÂ insertÂ intoÂ t1(a,b)Â values(i,i);Â setÂ i=i+1;Â endÂ while; end;; delimiterÂ ; callÂ insert_t1(); -- å¾€t2è¡¨æ’å…¥100è¡Œè®°å½• dropÂ procedureÂ ifÂ existsÂ insert_t2;Â delimiterÂ ;; createÂ procedureÂ insert_t2()Â begin declareÂ iÂ int;Â setÂ i=1;Â while(i\u0026lt;=100)doÂ insertÂ intoÂ t2(a,b)Â values(i,i);Â setÂ i=i+1;Â endÂ while; end;; delimiterÂ ; callÂ insert_t2(); æ–°å»º t1 t2 è¡¨ï¼Œç»“æ„ä¸€æ ·ï¼Œ éƒ½åœ¨aå­—æ®µä¸Šæœ‰ç´¢å¼•ï¼Œbå­—æ®µæ²¡æœ‰ç´¢å¼•ï¼Œt1è¡¨æœ‰ 10000 è¡Œè®°å½•ï¼Œt2è¡¨åªæœ‰100æ¡è®°å½•ã€‚\nå¸¸è§çš„è¡¨å…³è”ç®—æ³• å†…åµŒå¾ªç¯è¿æ¥ç®—æ³• Nested-Loop Join åŸºäºå—çš„åµŒå¥—å¾ªç¯è¿æ¥ç®—æ³• Block Nested-Loop Join å†…åµŒå¾ªç¯è¿æ¥ç®—æ³• ä¸€æ¬¡ä¸€è¡Œå¾ªç¯åœ°ä»ç¬¬ä¸€å¼ è¡¨ï¼ˆç§°ä¸ºé©±åŠ¨è¡¨ï¼‰ä¸­è¯»å–è¡Œï¼Œåœ¨è¿™è¡Œæ•°æ®ä¸­å–åˆ°å…³è”å­—æ®µï¼Œæ ¹æ®å…³è”å­—æ®µåœ¨å¦ä¸€å¼ è¡¨ï¼ˆè¢«é©±åŠ¨è¡¨ï¼‰é‡Œå–å‡ºæ»¡è¶³æ¡ä»¶çš„è¡Œï¼Œç„¶åå–å‡ºä¸¤å¼ è¡¨çš„ç»“æœåˆé›†ã€‚\nä¸€èˆ¬å…³è”å­—æ®µæœ‰ç´¢å¼•çš„æ—¶å€™ä½¿ç”¨è¿™ç§ç®—æ³•, ç¤ºä¾‹:\nEXPLAIN select * from t1 inner join t2 on t1.a= t2.a; ä»æ‰§è¡Œè®¡åˆ’ä¸­å¯ä»¥çœ‹åˆ°è¿™äº›ä¿¡æ¯ï¼š\né©±åŠ¨è¡¨æ˜¯ t2ï¼Œè¢«é©±åŠ¨è¡¨æ˜¯ t1ã€‚å…ˆæ‰§è¡Œçš„å°±æ˜¯é©±åŠ¨è¡¨ï¼›ä¼˜åŒ–å™¨ä¸€èˆ¬ä¼šä¼˜å…ˆé€‰æ‹©å°è¡¨åšé©±åŠ¨è¡¨ï¼Œç”¨whereæ¡ä»¶è¿‡æ»¤å®Œé©±åŠ¨è¡¨ï¼Œç„¶åå†è·Ÿè¢«é©±åŠ¨è¡¨åšå…³è”æŸ¥è¯¢ã€‚æ‰€ä»¥ä½¿ç”¨ inner join æ—¶ï¼Œæ’åœ¨å‰é¢çš„è¡¨å¹¶ä¸ä¸€å®šå°±æ˜¯é©±åŠ¨è¡¨ å½“ä½¿ç”¨left joinæ—¶ï¼Œå·¦è¡¨æ˜¯é©±åŠ¨è¡¨ï¼Œå³è¡¨æ˜¯è¢«é©±åŠ¨è¡¨ï¼Œå½“ä½¿ç”¨right joinæ—¶ï¼Œå³è¡¨æ—¶é©±åŠ¨è¡¨ï¼Œå·¦è¡¨æ˜¯è¢«é©±åŠ¨è¡¨ ä½¿ç”¨äº† NLJç®—æ³•ã€‚ä¸€èˆ¬ join è¯­å¥ä¸­ï¼Œå¦‚æœæ‰§è¡Œè®¡åˆ’ Extra ä¸­æœªå‡ºç° Using join buffer åˆ™è¡¨ç¤ºä½¿ç”¨çš„ join ç®—æ³•æ˜¯ NLJã€‚ ä¸Šé¢sqlçš„å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š\nä»è¡¨ t2 ä¸­è¯»å–ä¸€è¡Œæ•°æ®ï¼ˆå¦‚æœt2è¡¨æœ‰æŸ¥è¯¢è¿‡æ»¤æ¡ä»¶çš„ï¼Œç”¨å…ˆç”¨æ¡ä»¶è¿‡æ»¤å®Œï¼Œå†ä»è¿‡æ»¤ç»“æœé‡Œå–å‡ºä¸€è¡Œæ•°æ®ï¼‰ï¼› ä»ç¬¬ 1 æ­¥çš„æ•°æ®ä¸­ï¼Œå–å‡ºå…³è”å­—æ®µ aï¼Œåˆ°è¡¨ t1 ä¸­æŸ¥æ‰¾ï¼› å–å‡ºè¡¨ t1 ä¸­æ»¡è¶³æ¡ä»¶çš„è¡Œï¼Œè·Ÿ t2 ä¸­è·å–åˆ°çš„ç»“æœåˆå¹¶ï¼Œä½œä¸ºç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼› é‡å¤ä¸Šé¢ 3 æ­¥ã€‚ æ•´ä¸ªè¿‡ç¨‹ä¼šè¯»å– t2 è¡¨çš„æ‰€æœ‰æ•°æ®(æ‰«æ100è¡Œ)ï¼Œç„¶åéå†è¿™æ¯è¡Œæ•°æ®ä¸­å­—æ®µ a çš„å€¼ï¼Œæ ¹æ® t2 è¡¨ä¸­ a çš„å€¼ç´¢å¼•æ‰«æ t1 è¡¨ä¸­çš„å¯¹åº”è¡Œ(æ‰«æ100æ¬¡ t1 è¡¨çš„ç´¢å¼•ï¼Œ1æ¬¡æ‰«æå¯ä»¥è®¤ä¸ºæœ€ç»ˆåªæ‰«æ t1 è¡¨ä¸€è¡Œå®Œæ•´æ•°æ®ï¼Œä¹Ÿå°±æ˜¯æ€»å…± t1 è¡¨ä¹Ÿæ‰«æäº†100è¡Œ)ã€‚å› æ­¤æ•´ä¸ªè¿‡ç¨‹æ‰«æäº† 200 è¡Œ\nåŸºäºå—çš„åµŒå¥—å¾ªç¯ç®—æ³• å½“å…³è”å­—æ®µæ²¡æœ‰æ²¡æœ‰ç´¢å¼•çš„æ—¶å€™ä¼šä½¿ç”¨è¿™ç§ç®—æ³•\næŠŠé©±åŠ¨è¡¨çš„æ•°æ®è¯»å…¥åˆ° join_buffer ä¸­ï¼Œç„¶åæ‰«æè¢«é©±åŠ¨è¡¨ï¼ŒæŠŠè¢«é©±åŠ¨è¡¨æ¯ä¸€è¡Œå–å‡ºæ¥è·Ÿ join_buffer ä¸­çš„æ•°æ®åšå¯¹æ¯”ã€‚\nå¦‚ä¸‹:\nEXPLAIN select * from t1 inner join t2 on t1.b= t2.b; Extra ä¸­ çš„Using join buffer (Block Nested Loop)è¯´æ˜è¯¥å…³è”æŸ¥è¯¢ä½¿ç”¨çš„æ˜¯ BNL ç®—æ³•ã€‚\nä¸Šé¢sqlçš„å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š\næŠŠ t2 çš„æ‰€æœ‰æ•°æ®æ”¾å…¥åˆ° join_buffer ä¸­ æŠŠè¡¨ t1 ä¸­æ¯ä¸€è¡Œå–å‡ºæ¥ï¼Œè·Ÿ join_buffer ä¸­çš„æ•°æ®åšå¯¹æ¯” è¿”å›æ»¡è¶³ join æ¡ä»¶çš„æ•°æ® æ•´ä¸ªè¿‡ç¨‹å¯¹è¡¨ t1 å’Œ t2 éƒ½åšäº†ä¸€æ¬¡å…¨è¡¨æ‰«æï¼Œå› æ­¤æ‰«æçš„æ€»è¡Œæ•°ä¸º10000(è¡¨ t1 çš„æ•°æ®æ€»é‡) + 100(è¡¨ t2 çš„æ•°æ®æ€»é‡) = 10100ã€‚å¹¶ä¸” join_buffer é‡Œçš„æ•°æ®æ˜¯æ— åºçš„ï¼Œå› æ­¤å¯¹è¡¨ t1 ä¸­çš„æ¯ä¸€è¡Œï¼Œéƒ½è¦åš 100 æ¬¡åˆ¤æ–­ï¼Œæ‰€ä»¥å†…å­˜ä¸­çš„åˆ¤æ–­æ¬¡æ•°æ˜¯ 100 * 10000= 100 ä¸‡æ¬¡ã€‚\nè¿™ä¸ªä¾‹å­é‡Œè¡¨ t2 æ‰ 100 è¡Œï¼Œè¦æ˜¯è¡¨ t2 æ˜¯ä¸€ä¸ªå¤§è¡¨ï¼Œjoin_buffer æ”¾ä¸ä¸‹æ€ä¹ˆåŠå‘¢ï¼ŸÂ·\njoin_buffer çš„å¤§å°æ˜¯ç”±å‚æ•° join_buffer_size è®¾å®šçš„ï¼Œé»˜è®¤å€¼æ˜¯ 256kã€‚å¦‚æœæ”¾ä¸ä¸‹è¡¨ t2 çš„æ‰€æœ‰æ•°æ®è¯ï¼Œç­–ç•¥å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ†æ®µæ”¾ã€‚\næ¯”å¦‚ t2 è¡¨æœ‰1000è¡Œè®°å½•ï¼Œ join_buffer ä¸€æ¬¡åªèƒ½æ”¾800è¡Œæ•°æ®ï¼Œé‚£ä¹ˆæ‰§è¡Œè¿‡ç¨‹å°±æ˜¯å…ˆå¾€ join_buffer é‡Œæ”¾800è¡Œè®°å½•ï¼Œç„¶åä» t1 è¡¨é‡Œå–æ•°æ®è·Ÿ join_buffer ä¸­æ•°æ®å¯¹æ¯”å¾—åˆ°éƒ¨åˆ†ç»“æœï¼Œç„¶åæ¸…ç©º join_buffer ï¼Œå†æ”¾å…¥ t2 è¡¨å‰©ä½™200è¡Œè®°å½•ï¼Œå†æ¬¡ä» t1 è¡¨é‡Œå–æ•°æ®è·Ÿ join_buffer ä¸­æ•°æ®å¯¹æ¯”ã€‚æ‰€ä»¥å°±å¤šæ‰«äº†ä¸€æ¬¡ t1 è¡¨ã€‚\nä¸ºä»€ä¹ˆè¦ä½¿ç”¨ BNLJ ç®—æ³•å‘¢? å¦‚æœä¸Šé¢ç¬¬äºŒæ¡sqlä½¿ç”¨ Nested-Loop Joinï¼Œé‚£ä¹ˆæ‰«æè¡Œæ•°ä¸º 100 * 10000 = 100ä¸‡æ¬¡ï¼Œè¿™ä¸ªæ˜¯ç£ç›˜æ‰«æã€‚\nå¾ˆæ˜¾ç„¶ï¼Œç”¨BNLç£ç›˜æ‰«ææ¬¡æ•°å°‘å¾ˆå¤šï¼Œç›¸æ¯”äºç£ç›˜æ‰«æï¼ŒBNLçš„å†…å­˜è®¡ç®—ä¼šå¿«å¾—å¤šã€‚\nå› æ­¤MySQLå¯¹äºè¢«é©±åŠ¨è¡¨çš„å…³è”å­—æ®µæ²¡ç´¢å¼•çš„å…³è”æŸ¥è¯¢ï¼Œä¸€èˆ¬éƒ½ä¼šä½¿ç”¨ BNL ç®—æ³•ã€‚å¦‚æœæœ‰ç´¢å¼•ä¸€èˆ¬é€‰æ‹© NLJ ç®—æ³•ï¼Œæœ‰ç´¢å¼•çš„æƒ…å†µä¸‹ NLJ ç®—æ³•æ¯” BNLç®—æ³•æ€§èƒ½æ›´é«˜\nå¯¹äºå…³è”sqlçš„ä¼˜åŒ– å…³è”å­—æ®µåŠ ç´¢å¼•ï¼Œè®©mysqlåšjoinæ“ä½œæ—¶å°½é‡é€‰æ‹©NLJç®—æ³•ï¼Œé©±åŠ¨è¡¨å› ä¸ºéœ€è¦å…¨éƒ¨æŸ¥è¯¢å‡ºæ¥ï¼Œæ‰€ä»¥è¿‡æ»¤çš„æ¡ä»¶ä¹Ÿå°½é‡è¦èµ°ç´¢å¼•ï¼Œé¿å…å…¨è¡¨æ‰«æï¼Œæ€»ä¹‹ï¼Œèƒ½èµ°ç´¢å¼•çš„è¿‡æ»¤æ¡ä»¶å°½é‡éƒ½èµ°ç´¢å¼•\nå°è¡¨é©±åŠ¨å¤§è¡¨ï¼Œå†™å¤šè¡¨è¿æ¥sqlæ—¶å¦‚æœæ˜ç¡®çŸ¥é“å“ªå¼ è¡¨æ˜¯å°è¡¨å¯ä»¥ç”¨straight_joinå†™æ³•å›ºå®šè¿æ¥é©±åŠ¨æ–¹å¼ï¼Œçœå»mysqlä¼˜åŒ–å™¨è‡ªå·±åˆ¤æ–­çš„æ—¶é—´\nstraight_joinè§£é‡Šï¼šstraight_joinåŠŸèƒ½åŒjoinç±»ä¼¼ï¼Œä½†èƒ½è®©å·¦è¾¹çš„è¡¨æ¥é©±åŠ¨å³è¾¹çš„è¡¨ï¼Œèƒ½æ”¹è¡¨ä¼˜åŒ–å™¨å¯¹äºè”è¡¨æŸ¥è¯¢çš„æ‰§è¡Œé¡ºåºã€‚\næ¯”å¦‚ï¼šselect * from t2 straight_join t1 on t2.a = t1.a; ä»£è¡¨æŒ‡å®šmysqlé€‰ç€ t2 è¡¨ä½œä¸ºé©±åŠ¨è¡¨ã€‚\nstraight_joinåªé€‚ç”¨äºinner joinï¼Œå¹¶ä¸é€‚ç”¨äºleft joinï¼Œright joinã€‚ï¼ˆå› ä¸ºleft joinï¼Œright joinå·²ç»ä»£è¡¨æŒ‡å®šäº†è¡¨çš„æ‰§è¡Œé¡ºåºï¼‰\nå°½å¯èƒ½è®©ä¼˜åŒ–å™¨å»åˆ¤æ–­ï¼Œå› ä¸ºå¤§éƒ¨åˆ†æƒ…å†µä¸‹mysqlä¼˜åŒ–å™¨æ˜¯æ¯”äººè¦èªæ˜çš„ã€‚ä½¿ç”¨straight_joinä¸€å®šè¦æ…é‡ï¼Œå› ä¸ºéƒ¨åˆ†æƒ…å†µä¸‹äººä¸ºæŒ‡å®šçš„æ‰§è¡Œé¡ºåºå¹¶ä¸ä¸€å®šä¼šæ¯”ä¼˜åŒ–å¼•æ“è¦é è°±ã€‚\nå°è¡¨çš„å®šä¹‰ åœ¨å†³å®šå“ªä¸ªè¡¨åšé©±åŠ¨è¡¨çš„æ—¶å€™ï¼Œåº”è¯¥æ˜¯ä¸¤ä¸ªè¡¨æŒ‰ç…§å„è‡ªçš„æ¡ä»¶è¿‡æ»¤ï¼Œè¿‡æ»¤å®Œæˆä¹‹åï¼Œè®¡ç®—å‚ä¸ join çš„å„ä¸ªå­—æ®µçš„æ€»æ•°æ®é‡ï¼Œæ•°æ®é‡å°çš„é‚£ä¸ªè¡¨ï¼Œå°±æ˜¯â€œå°è¡¨â€ï¼Œåº”è¯¥ä½œä¸ºé©±åŠ¨è¡¨ã€‚ä¸å•å•æ˜¯è¡¨çš„æ€»æ•°æ®é‡\ninå’Œexsitsä¼˜åŒ– åŸåˆ™ï¼šå°è¡¨é©±åŠ¨å¤§è¡¨ï¼Œå³å°çš„æ•°æ®é›†é©±åŠ¨å¤§çš„æ•°æ®é›†\ninï¼šå½“Bè¡¨çš„æ•°æ®é›†å°äºAè¡¨çš„æ•°æ®é›†æ—¶ï¼Œinä¼˜äºexists select * from A where id in (select id from B) #ç­‰ä»·äºï¼š for(select id from B){ select * from A where A.id = B.id } existsï¼šå½“Aè¡¨çš„æ•°æ®é›†å°äºBè¡¨çš„æ•°æ®é›†æ—¶ï¼Œexistsä¼˜äºin å°†ä¸»æŸ¥è¯¢Açš„æ•°æ®ï¼Œæ”¾åˆ°å­æŸ¥è¯¢Bä¸­åšæ¡ä»¶éªŒè¯ï¼Œæ ¹æ®éªŒè¯ç»“æœï¼ˆtrueæˆ–falseï¼‰æ¥å†³å®šä¸»æŸ¥è¯¢çš„æ•°æ®æ˜¯å¦ä¿ç•™\nselect * from A where exists (select 1 from B where B.id = A.id) #ç­‰ä»·äº: for(select * from A){ select * from B where B.id = A.id } #Aè¡¨ä¸Bè¡¨çš„IDå­—æ®µåº”å»ºç«‹ç´¢å¼• å…³äºExists EXISTS (subquery)åªè¿”å›TRUEæˆ–FALSE,å› æ­¤å­æŸ¥è¯¢ä¸­çš„SELECT * ä¹Ÿå¯ä»¥ç”¨SELECT 1æ›¿æ¢,å®˜æ–¹è¯´æ³•æ˜¯å®é™…æ‰§è¡Œæ—¶ä¼šå¿½ç•¥SELECTæ¸…å•,å› æ­¤æ²¡æœ‰åŒºåˆ«\nEXISTSå­æŸ¥è¯¢çš„å®é™…æ‰§è¡Œè¿‡ç¨‹å¯èƒ½ç»è¿‡äº†ä¼˜åŒ–è€Œä¸æ˜¯æˆ‘ä»¬ç†è§£ä¸Šçš„é€æ¡å¯¹æ¯”\nEXISTSå­æŸ¥è¯¢å¾€å¾€ä¹Ÿå¯ä»¥ç”¨JOINæ¥ä»£æ›¿ï¼Œä½•ç§æœ€ä¼˜éœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æ\ncount æŸ¥è¯¢ä¼˜åŒ– æœ‰ä¸‹é¢å››æ¡æŸ¥è¯¢è¯­å¥\nEXPLAIN select count(1) from employees; EXPLAIN select count(id) from employees; EXPLAIN select count(name) from employees; EXPLAIN select count(*) from employees; åªæœ‰ count(å­—æ®µå) ä¸ä¼šæŠŠè¯¥å­—æ®µä¸ºnull è®¡å…¥æ€»æ•°\nå…¶å®ä¸Šé¢å››æ¡çš„æŸ¥è¯¢è®¡åˆ’éƒ½ä¸€æ ·ï¼Œæ•ˆç‡ä¸Šæ²¡æœ‰å¤ªå¤§çš„å·®åˆ«\nå½“å­—æ®µæœ‰ç´¢å¼• count(*)â‰ˆcount(1)\u0026gt;count(å­—æ®µ)\u0026gt;count(ä¸»é”®Â id)\nå­—æ®µæœ‰ç´¢å¼•ï¼Œcount(å­—æ®µ)ç»Ÿè®¡èµ°äºŒçº§ç´¢å¼•ï¼ŒäºŒçº§ç´¢å¼•å­˜å‚¨æ•°æ®æ¯”ä¸»é”®ç´¢å¼•å°‘ï¼Œæ‰€ä»¥count(å­—æ®µ)\u0026gt;count(ä¸»é”®Â id)\nå½“å­—æ®µæ²¡æœ‰ç´¢å¼• count(*)â‰ˆcount(1)\u0026gt;count(ä¸»é”®Â id)\u0026gt;count(å­—æ®µ)\nå­—æ®µæ²¡æœ‰ç´¢å¼•count(å­—æ®µ)ç»Ÿè®¡èµ°ä¸äº†ç´¢å¼•ï¼Œcount(ä¸»é”® id)è¿˜å¯ä»¥èµ°ä¸»é”®ç´¢å¼•ï¼Œæ‰€ä»¥count(ä¸»é”®Â id)\u0026gt;count(å­—æ®µ)\ncount(1) count(1)è·Ÿcount(å­—æ®µ)æ‰§è¡Œè¿‡ç¨‹ç±»ä¼¼ï¼Œä¸è¿‡count(1)ä¸éœ€è¦å–å‡ºå­—æ®µç»Ÿè®¡ï¼Œå°±ç”¨å¸¸é‡1åšç»Ÿè®¡ï¼Œcount(å­—æ®µ)è¿˜éœ€è¦å–å‡ºå­—æ®µï¼Œæ‰€ä»¥ç†è®ºä¸Šcount(1)æ¯”count(å­—æ®µ)ä¼šå¿«ä¸€ç‚¹ã€‚\ncount(*) count(*) æ˜¯ä¾‹å¤–ï¼Œmysqlå¹¶ä¸ä¼šæŠŠå…¨éƒ¨å­—æ®µå–å‡ºæ¥ï¼Œè€Œæ˜¯ä¸“é—¨åšäº†ä¼˜åŒ–ï¼Œä¸å–å€¼ï¼ŒæŒ‰è¡Œç´¯åŠ ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œæ‰€ä»¥ä¸éœ€è¦ç”¨count(åˆ—å)æˆ–count(å¸¸é‡)æ¥æ›¿ä»£ count(*)ã€‚\nä¸ºä»€ä¹ˆå¯¹äºcount(id)ï¼Œmysqlæœ€ç»ˆé€‰æ‹©è¾…åŠ©ç´¢å¼•è€Œä¸æ˜¯ä¸»é”®èšé›†ç´¢å¼•ï¼Ÿå› ä¸ºäºŒçº§ç´¢å¼•ç›¸å¯¹ä¸»é”®ç´¢å¼•å­˜å‚¨æ•°æ®æ›´å°‘ï¼Œæ£€ç´¢æ€§èƒ½åº”è¯¥æ›´é«˜ï¼Œmysqlå†…éƒ¨åšäº†ç‚¹ä¼˜åŒ–(åº”è¯¥æ˜¯åœ¨5.7ç‰ˆæœ¬æ‰ä¼˜åŒ–)ã€‚\nå¸¸è§ä¼˜åŒ–æ–¹æ³• è‡ªå·±ç»´æŠ¤çš„æ€»è¡Œæ•°\nshow table status\nå¦‚æœåªéœ€è¦çŸ¥é“è¡¨æ€»è¡Œæ•°çš„ä¼°è®¡å€¼å¯ä»¥ç”¨å¦‚ä¸‹sqlæŸ¥è¯¢ï¼Œæ€§èƒ½å¾ˆé«˜\nshow table status like 'employee'\nå°†æ€»æ•°ç»´æŠ¤åˆ°Redisé‡Œ\næ’å…¥æˆ–åˆ é™¤è¡¨æ•°æ®è¡Œçš„æ—¶å€™åŒæ—¶ç»´æŠ¤redisé‡Œçš„è¡¨æ€»è¡Œæ•°keyçš„è®¡æ•°å€¼(ç”¨incræˆ–decrå‘½ä»¤)ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼å¯èƒ½ä¸å‡†ï¼Œå¾ˆéš¾ä¿è¯è¡¨æ“ä½œå’Œredisæ“ä½œçš„äº‹åŠ¡ä¸€è‡´æ€§\nç´¢å¼•è®¾è®¡åŸåˆ™ ç´¢å¼•è®¾è®¡åŸåˆ™\n1ã€ä»£ç å…ˆè¡Œï¼Œç´¢å¼•åä¸Š\nç­‰åˆ°ä¸»ä½“ä¸šåŠ¡åŠŸèƒ½å¼€å‘å®Œæ¯•ï¼ŒæŠŠæ¶‰åŠåˆ°è¯¥è¡¨ç›¸å…³sqléƒ½è¦æ‹¿å‡ºæ¥åˆ†æä¹‹åå†å»ºç«‹ç´¢å¼•ã€‚\n2ã€è”åˆç´¢å¼•å°½é‡è¦†ç›–æ¡ä»¶\næ¯”å¦‚å¯ä»¥è®¾è®¡ä¸€ä¸ªæˆ–è€…ä¸¤ä¸‰ä¸ªè”åˆç´¢å¼•(å°½é‡å°‘å»ºå•å€¼ç´¢å¼•)ï¼Œè®©æ¯ä¸€ä¸ªè”åˆç´¢å¼•éƒ½å°½é‡å»åŒ…å«sqlè¯­å¥é‡Œçš„whereã€order byã€group byçš„å­—æ®µï¼Œè¿˜è¦ç¡®ä¿è¿™äº›è”åˆç´¢å¼•çš„å­—æ®µé¡ºåºå°½é‡æ»¡è¶³sqlæŸ¥è¯¢çš„æœ€å·¦å‰ç¼€åŸåˆ™ã€‚\n3ã€ä¸è¦åœ¨å°åŸºæ•°å­—æ®µä¸Šå»ºç«‹ç´¢å¼•\nç´¢å¼•åŸºæ•°æ˜¯æŒ‡è¿™ä¸ªå­—æ®µåœ¨è¡¨é‡Œæ€»å…±æœ‰å¤šå°‘ä¸ªä¸åŒçš„å€¼ï¼Œæ¯”å¦‚ä¸€å¼ è¡¨æ€»å…±100ä¸‡è¡Œè®°å½•ï¼Œå…¶ä¸­æœ‰ä¸ªæ€§åˆ«å­—æ®µï¼Œå…¶å€¼ä¸æ˜¯ç”·å°±æ˜¯å¥³ï¼Œé‚£ä¹ˆè¯¥å­—æ®µçš„åŸºæ•°å°±æ˜¯2ã€‚\nå¦‚æœå¯¹è¿™ç§å°åŸºæ•°å­—æ®µå»ºç«‹ç´¢å¼•çš„è¯ï¼Œè¿˜ä¸å¦‚å…¨è¡¨æ‰«æäº†ï¼Œå› ä¸ºä½ çš„ç´¢å¼•æ ‘é‡Œå°±åŒ…å«ç”·å’Œå¥³ä¸¤ç§å€¼ï¼Œæ ¹æœ¬æ²¡æ³•è¿›è¡Œå¿«é€Ÿçš„äºŒåˆ†æŸ¥æ‰¾ï¼Œé‚£ç”¨ç´¢å¼•å°±æ²¡æœ‰å¤ªå¤§çš„æ„ä¹‰äº†ã€‚\nä¸€èˆ¬å»ºç«‹ç´¢å¼•ï¼Œå°½é‡ä½¿ç”¨é‚£äº›åŸºæ•°æ¯”è¾ƒå¤§çš„å­—æ®µï¼Œå°±æ˜¯å€¼æ¯”è¾ƒå¤šçš„å­—æ®µï¼Œé‚£ä¹ˆæ‰èƒ½å‘æŒ¥å‡ºB+æ ‘å¿«é€ŸäºŒåˆ†æŸ¥æ‰¾çš„ä¼˜åŠ¿æ¥ã€‚\n4ã€é•¿å­—ç¬¦ä¸²æˆ‘ä»¬å¯ä»¥é‡‡ç”¨å‰ç¼€ç´¢å¼•\nå°½é‡å¯¹å­—æ®µç±»å‹è¾ƒå°çš„åˆ—è®¾è®¡ç´¢å¼•ï¼Œæ¯”å¦‚è¯´ä»€ä¹ˆtinyintä¹‹ç±»çš„ï¼Œå› ä¸ºå­—æ®µç±»å‹è¾ƒå°çš„è¯ï¼Œå ç”¨ç£ç›˜ç©ºé—´ä¹Ÿä¼šæ¯”è¾ƒå°ï¼Œæ­¤æ—¶ä½ åœ¨æœç´¢çš„æ—¶å€™æ€§èƒ½ä¹Ÿä¼šæ¯”è¾ƒå¥½ä¸€ç‚¹ã€‚\nå½“ç„¶ï¼Œè¿™ä¸ªæ‰€è°“çš„å­—æ®µç±»å‹å°ä¸€ç‚¹çš„åˆ—ï¼Œä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œå¾ˆå¤šæ—¶å€™ä½ å°±æ˜¯è¦é’ˆå¯¹varchar(255)è¿™ç§å­—æ®µå»ºç«‹ç´¢å¼•ï¼Œå“ªæ€•å¤šå ç”¨ä¸€äº›ç£ç›˜ç©ºé—´ä¹Ÿæ˜¯æœ‰å¿…è¦çš„ã€‚\nå¯¹äºè¿™ç§varchar(255)çš„å¤§å­—æ®µå¯èƒ½ä¼šæ¯”è¾ƒå ç”¨ç£ç›˜ç©ºé—´ï¼Œå¯ä»¥ç¨å¾®ä¼˜åŒ–ä¸‹ï¼Œæ¯”å¦‚é’ˆå¯¹è¿™ä¸ªå­—æ®µçš„å‰20ä¸ªå­—ç¬¦å»ºç«‹ç´¢å¼•ï¼Œå°±æ˜¯è¯´ï¼Œå¯¹è¿™ä¸ªå­—æ®µé‡Œçš„æ¯ä¸ªå€¼çš„å‰20ä¸ªå­—ç¬¦æ”¾åœ¨ç´¢å¼•æ ‘é‡Œï¼Œç±»ä¼¼äº KEY index(name(20),age,position)\næ­¤æ—¶ä½ åœ¨whereæ¡ä»¶é‡Œæœç´¢çš„æ—¶å€™ï¼Œå¦‚æœæ˜¯æ ¹æ®nameå­—æ®µæ¥æœç´¢ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±ä¼šå…ˆåˆ°ç´¢å¼•æ ‘é‡Œæ ¹æ®nameå­—æ®µçš„å‰20ä¸ªå­—ç¬¦å»æœç´¢ï¼Œå®šä½åˆ°ä¹‹åå‰20ä¸ªå­—ç¬¦çš„å‰ç¼€åŒ¹é…çš„éƒ¨åˆ†æ•°æ®ä¹‹åï¼Œå†å›åˆ°èšç°‡ç´¢å¼•æå–å‡ºæ¥å®Œæ•´çš„nameå­—æ®µå€¼è¿›è¡Œæ¯”å¯¹ã€‚\nä½†æ˜¯å‡å¦‚ä½ è¦æ˜¯order by nameï¼Œé‚£ä¹ˆæ­¤æ—¶ä½ çš„nameå› ä¸ºåœ¨ç´¢å¼•æ ‘é‡Œä»…ä»…åŒ…å«äº†å‰20ä¸ªå­—ç¬¦ï¼Œæ‰€ä»¥è¿™ä¸ªæ’åºæ˜¯æ²¡æ³•ç”¨ä¸Šç´¢å¼•çš„ï¼Œ group byä¹Ÿæ˜¯åŒç†\n5ã€whereä¸order byå†²çªæ—¶ä¼˜å…ˆwhere\nåœ¨whereå’Œorder byå‡ºç°ç´¢å¼•è®¾è®¡å†²çªæ—¶ï¼Œåˆ°åº•æ˜¯é’ˆå¯¹whereå»è®¾è®¡ç´¢å¼•ï¼Œè¿˜æ˜¯é’ˆå¯¹order byè®¾è®¡ç´¢å¼•ï¼Ÿåˆ°åº•æ˜¯è®©whereå»ç”¨ä¸Šç´¢å¼•ï¼Œè¿˜æ˜¯è®©order byç”¨ä¸Šç´¢å¼•?\nä¸€èˆ¬è¿™ç§æ—¶å€™å¾€å¾€éƒ½æ˜¯è®©whereæ¡ä»¶å»ä½¿ç”¨ç´¢å¼•æ¥å¿«é€Ÿç­›é€‰å‡ºæ¥ä¸€éƒ¨åˆ†æŒ‡å®šçš„æ•°æ®ï¼Œæ¥ç€å†è¿›è¡Œæ’åºã€‚\nå› ä¸ºå¤§å¤šæ•°æƒ…å†µåŸºäºç´¢å¼•è¿›è¡Œwhereç­›é€‰å¾€å¾€å¯ä»¥æœ€å¿«é€Ÿåº¦ç­›é€‰å‡ºä½ è¦çš„å°‘éƒ¨åˆ†æ•°æ®ï¼Œç„¶ååšæ’åºçš„æˆæœ¬å¯èƒ½ä¼šå°å¾ˆå¤šã€‚\nä¸¾ä¸ªä¾‹å­ æœ‰ employeesè¡¨ï¼Œname, age, sex, position åˆ—ï¼Œ æœ‰è”åˆç´¢å¼• ï¼ˆname, age, sex, positionï¼‰,\nsex : æ€§åˆ«ï¼Œå–å€¼0 æˆ–1\næœ‰å¦‚ä¸‹æŸ¥è¯¢: select id from employees where name = 'zhangsan' and age = 18 and position = 'dev' å› ä¸ºè·³è¿‡äº† sex å­—æ®µï¼Œposition æ— æ³•åˆ©ç”¨ç´¢å¼•\nå› ä¸º sex åªæœ‰ä¸¤ä¸ªå–å€¼ï¼Œæˆ‘ä»¬åœ¨æŸ¥è¯¢è¯­å¥ä¸ŠæŠŠ sex çš„å€¼å…¨éƒ¨æšä¸¾å‡ºæ¥ï¼Œ å¦‚ä¸‹:\nselect id from employees where name = 'zhangsan' and age = 18 and sex in (0, 1) and position = 'dev'\nè¿™æ ·ä¸€æ¥å°±å¯ä»¥åˆ©ç”¨å…¨éƒ¨ç´¢å¼•äº†ã€‚\nå†ä¸¾ä¸ªä¾‹å­ åŠ å…¥æˆ‘ä»¬è¦æŸ¥è¯¢æœ€è¿‘ä¸€å‘¨ç™»å½•çš„ç”¨æˆ·ï¼Œé¦–å…ˆæƒ³åˆ°çš„æ˜¯ last_login_time \u0026gt; {ä¸€å‘¨ä¹‹å‰çš„æ—¶é—´}\nè¿™æ˜¯ä¸€ä¸ªèŒƒå›´æŸ¥è¯¢ï¼Œåœ¨åé¢çš„æ‰€æœ‰å­—æ®µä¾¿æ— æ³•åˆ©ç”¨ç´¢å¼•äº†ï¼Œæˆ‘ä»¬å¯ä»¥å†è®¾è®¡ä¸€ä¸ªå­—æ®µï¼Œrecent_login_flag(tinyint) æ ‡è¯†æ˜¯å¦æœ€è¿‘ç™»å½•è¿‡ã€‚ç”¨å®šæ—¶ä»»åŠ¡å®šæœŸæ›´æ–°è¯¥å­—æ®µçš„å€¼ã€‚è¿™æ ·å°±ç”±èŒƒå›´æŸ¥è¯¢å˜æˆäº†ç­‰å€¼æŸ¥è¯¢ï¼Œæ•°æ®å¯èƒ½ä¸æ˜¯å¤ªåŠæ—¶å˜åŒ–ï¼Œå°±çœ‹ä¸šåŠ¡æ˜¯å¦å…è®¸äº†ã€‚\næ€»ä¹‹å°±æ˜¯æƒ³åŠæ³•æœ€å¤§é™åº¦çš„åˆ©ç”¨ç´¢å¼•ã€‚\n","date":"2022-08-03T17:10:57Z","permalink":"https://dccmmtop.github.io/posts/%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96/","section":"posts","tags":["MySQL","ç´¢å¼•"],"title":"ç´¢å¼•ä¼˜åŒ–"},{"categories":null,"contents":"å¤§ä½“æ¥è¯´ï¼ŒMySQLå¯ä»¥åˆ†ä¸º server å±‚å’Œå­˜å‚¨å¼•æ“å±‚ä¸¤éƒ¨åˆ†ï¼Œå¦‚ä¸‹å›¾\nServerå±‚ ä¸»è¦åŒ…æ‹¬è¿æ¥å™¨ã€æŸ¥è¯¢ç¼“å­˜ã€åˆ†æå™¨ã€ä¼˜åŒ–å™¨ã€æ‰§è¡Œå™¨ç­‰ï¼Œæ¶µç›– MySQL çš„å¤§å¤šæ•°æ ¸å¿ƒæœåŠ¡åŠŸèƒ½ï¼Œä»¥åŠæ‰€æœ‰çš„å†…ç½®å‡½æ•° ï¼ˆå¦‚æ—¥æœŸã€æ—¶é—´ã€æ•°å­¦å’ŒåŠ å¯†å‡½æ•°ç­‰ï¼‰ï¼Œæ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½éƒ½åœ¨è¿™ä¸€å±‚å®ç°ï¼Œæ¯”å¦‚å­˜å‚¨è¿‡ç¨‹ã€è§¦å‘å™¨ã€è§†å›¾ç­‰ã€‚\nStoreå±‚ å­˜å‚¨å¼•æ“å±‚è´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œæå–ã€‚å…¶æ¶æ„æ¨¡å¼æ˜¯æ’ä»¶å¼çš„ï¼Œæ”¯æŒ InnoDBã€MyISAMã€Memory ç­‰å¤šä¸ªå­˜å‚¨å¼•æ“ã€‚ç°åœ¨æœ€å¸¸ç”¨çš„å­˜å‚¨å¼•æ“æ˜¯ InnoDBï¼Œå®ƒä» MySQL 5.5.5 ç‰ˆæœ¬å¼€å§‹æˆä¸ºäº†é»˜è®¤å­˜å‚¨å¼•æ“ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬åœ¨create tableæ—¶ä¸æŒ‡å®šè¡¨çš„å­˜å‚¨å¼•æ“ç±»å‹,é»˜è®¤ä¼šç»™ä½ è®¾ç½®å­˜å‚¨å¼•æ“ä¸ºInnoDBã€‚\nè¿æ¥å™¨ é¡¾åæ€ä¹‰ï¼Œä»–ä¸»è¦ä¸å®¢æˆ·ç«¯è¿æ¥æ‰“äº¤é“\nè¿æ¥å™¨è´Ÿè´£è·Ÿå®¢æˆ·ç«¯å»ºç«‹è¿æ¥ã€è·å–æƒé™ã€ç»´æŒå’Œç®¡ç†è¿æ¥ã€‚è¿æ¥å‘½ä»¤ä¸€èˆ¬æ˜¯è¿™ä¹ˆå†™çš„ï¼š\nmysql â€h host[æ•°æ®åº“åœ°å€] â€u root[ç”¨æˆ·] â€p root[å¯†ç ] â€P 3306 è¿æ¥å‘½ä»¤ä¸­çš„ mysql æ˜¯å®¢æˆ·ç«¯å·¥å…·ï¼Œç”¨æ¥è·ŸæœåŠ¡ç«¯å»ºç«‹è¿æ¥ã€‚åœ¨å®Œæˆç»å…¸çš„ TCP æ¡æ‰‹åï¼Œè¿æ¥å™¨å°±è¦å¼€å§‹è®¤è¯ä½ çš„èº«ä»½ï¼Œ è¿™ä¸ªæ—¶å€™ç”¨çš„å°±æ˜¯ä½ è¾“å…¥çš„ç”¨æˆ·åå’Œå¯†ç ã€‚\n1.å¦‚æœç”¨æˆ·åæˆ–å¯†ç ä¸å¯¹ï¼Œä½ å°±ä¼šæ”¶åˆ°ä¸€ä¸ª\u0026quot;Access denied for user\u0026quot;çš„é”™è¯¯ï¼Œç„¶åå®¢æˆ·ç«¯ç¨‹åºç»“æŸæ‰§è¡Œã€‚\n2.å¦‚æœç”¨æˆ·åå¯†ç è®¤è¯é€šè¿‡ï¼Œè¿æ¥å™¨ä¼šåˆ°æƒé™è¡¨é‡Œé¢æŸ¥å‡ºä½ æ‹¥æœ‰çš„æƒé™ã€‚ä¹‹åï¼Œè¿™ä¸ªè¿æ¥é‡Œé¢çš„æƒé™åˆ¤æ–­é€»è¾‘ï¼Œéƒ½å°†ä¾èµ–äºæ­¤æ—¶è¯»åˆ°çš„æƒé™ã€‚\nè¿™å°±æ„å‘³ç€ï¼Œä¸€ä¸ªç”¨æˆ·æˆåŠŸå»ºç«‹è¿æ¥åï¼Œå³ä½¿ä½ ç”¨ç®¡ç†å‘˜è´¦å·å¯¹è¿™ä¸ªç”¨æˆ·çš„æƒé™åšäº†ä¿®æ”¹ï¼Œä¹Ÿä¸ä¼šå½±å“å·²ç»å­˜åœ¨è¿æ¥çš„æƒé™ã€‚ä¿®æ”¹å®Œæˆåï¼Œåªæœ‰å†æ–°å»ºçš„è¿æ¥æ‰ä¼šä½¿ç”¨æ–°çš„æƒé™è®¾ç½®ã€‚ç”¨æˆ·çš„æƒé™è¡¨åœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„mysqlçš„userè¡¨ä¸­ã€‚\nè¯´åˆ°è¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆMySQLçš„æƒé™ä¸åšæˆå®æ—¶ç”Ÿæ•ˆçš„å‘¢ï¼Ÿ ç­”æ¡ˆåªæœ‰ä¸€ä¸ªâ€”â€” ä¸ºäº†æ€§èƒ½\næ¥çœ‹ä¸€ä¸‹ MySQL ç³»ç»Ÿç”¨æˆ·è¡¨:\nselect Host,User,Password from user; å¯ä»¥ç›´æ¥ä¿®æ”¹è¡¨ä¸­çš„æ•°æ®æ¥ä¿®æ”¹æŸä¸ªç”¨æˆ·çš„æƒé™\né•¿è¿æ¥å’ŒçŸ­è¿æ¥ æ•°æ®åº“é‡Œé¢ï¼Œé•¿è¿æ¥æ˜¯æŒ‡è¿æ¥æˆåŠŸåï¼Œå¦‚æœå®¢æˆ·ç«¯æŒç»­æœ‰è¯·æ±‚ï¼Œåˆ™ä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªè¿æ¥ã€‚\nçŸ­è¿æ¥åˆ™æ˜¯æŒ‡æ¯æ¬¡æ‰§è¡Œå®Œå¾ˆå°‘çš„å‡ æ¬¡æŸ¥è¯¢å°±æ–­å¼€è¿æ¥ï¼Œä¸‹æ¬¡æŸ¥è¯¢å†é‡æ–°å»ºç«‹ä¸€ä¸ªã€‚\nå¼€å‘å½“ä¸­æˆ‘ä»¬å¤§å¤šæ•°æ—¶å€™ç”¨çš„éƒ½æ˜¯é•¿è¿æ¥,æŠŠè¿æ¥æ”¾åœ¨Poolå†…è¿›è¡Œç®¡ç†ï¼Œä½†æ˜¯é•¿è¿æ¥æœ‰äº›æ—¶å€™ä¼šå¯¼è‡´ MySQL å ç”¨å†…å­˜æ¶¨å¾—ç‰¹åˆ«å¿«ï¼Œè¿™æ˜¯å› ä¸º MySQL åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸´æ—¶ä½¿ç”¨çš„å†…å­˜æ˜¯ç®¡ç†åœ¨è¿æ¥å¯¹è±¡é‡Œé¢çš„ã€‚è¿™äº›èµ„æºä¼šåœ¨è¿æ¥æ–­å¼€çš„æ—¶å€™æ‰é‡Šæ”¾ã€‚æ‰€ä»¥å¦‚æœé•¿è¿æ¥ç´¯ç§¯ä¸‹æ¥ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜å ç”¨å¤ªå¤§ï¼Œè¢«ç³»ç»Ÿå¼ºè¡Œæ€æ‰ï¼ˆOOMï¼‰ï¼Œä»ç°è±¡çœ‹å°±æ˜¯ MySQL å¼‚å¸¸é‡å¯äº†ã€‚\næ€ä¹ˆè§£å†³è¿™ç±»é—®é¢˜å‘¢\nå®šæœŸæ–­å¼€é•¿è¿æ¥ã€‚ä½¿ç”¨ä¸€æ®µæ—¶é—´ï¼Œæˆ–è€…ç¨‹åºé‡Œé¢åˆ¤æ–­æ‰§è¡Œè¿‡ä¸€ä¸ªå ç”¨å†…å­˜çš„å¤§æŸ¥è¯¢åï¼Œæ–­å¼€è¿æ¥ï¼Œä¹‹åè¦æŸ¥è¯¢å†é‡è¿ã€‚ å¦‚æœä½ ç”¨çš„æ˜¯ MySQL 5.7 æˆ–æ›´æ–°ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ“ä½œåï¼Œé€šè¿‡æ‰§è¡Œ mysql_reset_connection æ¥é‡æ–°åˆå§‹åŒ–è¿æ¥èµ„æºã€‚è¿™ä¸ªè¿‡ç¨‹ä¸éœ€è¦é‡è¿å’Œé‡æ–°åšæƒé™éªŒè¯ï¼Œä½†æ˜¯ä¼šå°†è¿æ¥æ¢å¤åˆ°åˆšåˆšåˆ›å»ºå®Œæ—¶çš„çŠ¶æ€ã€‚ æŸ¥è¯¢ç¼“å­˜ å‚è§æŸ¥è¯¢ç¼“å­˜\nåˆ†æå™¨ å¦‚æœæ²¡æœ‰å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œå°±è¦å¼€å§‹çœŸæ­£çš„æ‰§è¡Œè¯­å¥äº†ï¼Œä½†æ˜¯ MySQL æ€ä¹ˆçŸ¥é“ä½ è¦æŸ¥è¯¢çš„æ˜¯å“ªå¼ è¡¨æ ¼ï¼Œ å“ªä¸ªå­—æ®µï¼Œæ¡ä»¶æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\nè¿™å°±æ˜¯åˆ†æå™¨å¤§æ˜¾èº«æ‰‹çš„æ—¶å€™äº†ï¼Œä»–ä¼šåˆ†ææˆ‘ä»¬çš„ sql è¯­å¥ï¼ŒæŠŠä½ è¦æŸ¥è¯¢çš„è¡¨ï¼Œå­—æ®µ å’Œæ¡ä»¶ç­‰éƒ½è§£æå‡ºæ¥ï¼Œå½¢æˆç‰¹æ®Šçš„ç»“æ„ï¼Œæ–¹ä¾¿åç»­æ“ä½œ\nå¦‚æœ sql è¯­æ³•ä¸å¯¹ï¼Œå°±ä¼šå¾—åˆ° \u0026ldquo;You have an error in your SQL syntax\u0026rdquo; çš„é”™è¯¯æé†’, å¦‚ä¸‹ from é”™è¯¯çš„å†™æˆ form\nmysql\u0026gt; select * fro test where id=1; ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds t o your MySQL server version for the right syntax to use near \u0026#39;fro test where id=1\u0026#39; at line 1 ä½†æ˜¯åˆ†æå™¨æ˜¯å¦‚ä½•è§£æsqlè¯­å¥çš„å‘¢ï¼Ÿ åº•å±‚æ˜¯æ€ä¹ˆå·¥ä½œçš„å‘¢ï¼Ÿ\nè¯æ³•åˆ†æå™¨åŸç† è¯æ³•åˆ†æå™¨åˆ†æˆ6ä¸ªä¸»è¦æ­¥éª¤å®Œæˆå¯¹sqlè¯­å¥çš„åˆ†æ\nè¯æ³•åˆ†æ è¯­æ³•åˆ†æ è¯­ä¹‰åˆ†æ æ„é€ æ‰§è¡Œæ ‘ ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ è®¡åˆ’çš„æ‰§è¡Œ SQLè¯­å¥çš„åˆ†æåˆ†ä¸ºè¯æ³•åˆ†æä¸è¯­æ³•åˆ†æï¼Œmysqlçš„è¯æ³•åˆ†æç”±MySQLLex[MySQLè‡ªå·±å®ç°çš„]å®Œæˆï¼Œè¯­æ³•åˆ†æç”±Bisonç”Ÿæˆã€‚å…³äºè¯­æ³•æ ‘å¤§å®¶å¦‚æœæƒ³è¦æ·±å…¥ç ”ç©¶å¯ä»¥å‚è€ƒè¿™ç¯‡wikiæ–‡ç« \nè¿™é‡Œç»™å‡ºä¸€ä¸ªè§£æåçš„è¯­æ³•æ ‘ï¼Œä¾›å‚è€ƒ\nä¼˜åŒ–å™¨ ç»å†è¿‡åˆ†æå™¨åï¼ŒMySQL å°±çŸ¥é“è‡ªå·±éœ€è¦åšä»€ä¹ˆäº†ï¼Œ ä½†æ˜¯ç¨‹åºå‘˜å†™å‡ºçš„ sql è¯­å¥å¯èƒ½ä¸æ˜¯æœ€ä¼˜çš„ï¼Œè¿™æ—¶ï¼Œä¼˜åŒ–å™¨å¯ä»¥å¯¹ä¸€äº› sql è¯­å¥åšå‡ºä¼˜åŒ–ï¼Œä¸æ”¹å˜æŸ¥è¯¢ç»“æœçš„å‰æä¸‹ï¼Œä½¿æŸ¥è¯¢æ›´é«˜æ•ˆ\nè¿˜å¯ä»¥å†³å®šæŸæ¡ sql ä½¿ç”¨é‚£ä¸ªç´¢å¼•æŸ¥è¯¢æ›´å¿«ã€‚ æˆ–è€…ä¼šå†³å®šè¡¨å…³è”çš„é¡ºåº ç­‰ç­‰\næœ‰å¦‚ä¸‹ä¾‹å­:\nselect * from test1 join test2 using(ID) where test1.name=\u0026#39;å¼ çŠ\u0026#39; and test2.name=\u0026#39;è‰ä¸\u0026#39;; æ—¢å¯ä»¥å…ˆä»è¡¨ test1 é‡Œé¢å–å‡º name=\u0026lsquo;å¼ çŠ\u0026rsquo; ID å€¼ï¼Œå†æ ¹æ® ID å€¼å…³è”åˆ°è¡¨ test2ï¼Œå†åˆ¤æ–­ test2 é‡Œé¢ nameçš„å€¼æ˜¯å¦ç­‰äº \u0026lsquo;è‰ä¸\u0026rsquo;\nä¹Ÿå¯ä»¥å…ˆä»è¡¨ test2 é‡Œé¢å–å‡º name=\u0026lsquo;è‰ä¸\u0026rsquo; çš„è®°å½•çš„ ID å€¼ï¼Œå†æ ¹æ® ID å€¼å…³è”åˆ° test1ï¼Œå†åˆ¤æ–­ test1 é‡Œé¢ name çš„å€¼æ˜¯å¦ç­‰äº \u0026lsquo;å¼ çŠ\u0026rsquo;\nè¿™ä¸¤ç§æ‰§è¡Œæ–¹æ³•çš„é€»è¾‘ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ•ˆç‡ä¼šæœ‰ä¸åŒï¼Œè€Œä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯å†³å®šé€‰æ‹©ä½¿ç”¨å“ªä¸€ä¸ªæ–¹æ¡ˆã€‚ä¼˜åŒ–å™¨é˜¶æ®µå®Œæˆåï¼Œè¿™ä¸ªè¯­å¥çš„æ‰§è¡Œæ–¹æ¡ˆå°±ç¡®å®šä¸‹æ¥äº†ï¼Œç„¶åè¿›å…¥æ‰§è¡Œå™¨é˜¶æ®µ\næ‰§è¡Œå™¨ å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦å…ˆåˆ¤æ–­ä¸€ä¸‹ä½ å¯¹è¿™ä¸ªè¡¨ T æœ‰æ²¡æœ‰æ‰§è¡ŒæŸ¥è¯¢çš„æƒé™ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šè¿”å›æ²¡æœ‰æƒé™çš„é”™è¯¯ï¼Œå¦‚ä¸‹æ‰€ç¤º (åœ¨ å·¥ç¨‹å®ç°ä¸Šï¼Œå¦‚æœå‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œä¼šåœ¨æŸ¥è¯¢ç¼“å­˜è¿”å›ç»“æœçš„æ—¶å€™ï¼Œåšæƒé™éªŒè¯ã€‚æŸ¥è¯¢ä¹Ÿä¼šåœ¨ä¼˜åŒ–å™¨ä¹‹å‰è°ƒç”¨ precheck éªŒè¯æƒ é™)ã€‚\nè¦æ³¨æ„åŒºåˆ† è¿æ¥å™¨ ä¸­ä½¿ç”¨çš„æƒé™ï¼Œ è¿æ¥å™¨ä¸­çš„æƒé™ä½¿ç”¨æˆ·çº§åˆ«çš„ï¼Œè€Œæ‰§è¡Œå™¨ä¸­çš„æƒé™ä½¿è¡¨çº§åˆ«çš„\nselect * from test where id=10; å¦‚æœæœ‰æƒé™ï¼Œå°±æ‰“å¼€è¡¨ç»§ç»­æ‰§è¡Œã€‚æ‰“å¼€è¡¨çš„æ—¶å€™ï¼Œæ‰§è¡Œå™¨å°±ä¼šæ ¹æ®è¡¨çš„å¼•æ“å®šä¹‰ï¼Œå»ä½¿ç”¨è¿™ä¸ªå¼•æ“æä¾›çš„æ¥å£ã€‚\næ¯”å¦‚æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­çš„è¡¨ test ä¸­ï¼ŒID å­—æ®µæ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆæ‰§è¡Œå™¨çš„æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š\nè°ƒç”¨ InnoDB å¼•æ“æ¥å£å–è¿™ä¸ªè¡¨çš„ç¬¬ä¸€è¡Œï¼Œåˆ¤æ–­ ID å€¼æ˜¯ä¸æ˜¯ 10ï¼Œå¦‚æœä¸æ˜¯åˆ™è·³è¿‡ï¼Œå¦‚æœæ˜¯åˆ™å°†è¿™è¡Œå­˜åœ¨ç»“æœé›†ä¸­ï¼› è°ƒç”¨å¼•æ“æ¥å£å–â€œä¸‹ä¸€è¡Œâ€ï¼Œé‡å¤ç›¸åŒçš„åˆ¤æ–­é€»è¾‘ï¼Œç›´åˆ°å–åˆ°è¿™ä¸ªè¡¨çš„æœ€åä¸€è¡Œã€‚ æ‰§è¡Œå™¨å°†ä¸Šè¿°éå†è¿‡ç¨‹ä¸­æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„è¡Œç»„æˆçš„è®°å½•é›†ä½œä¸ºç»“æœé›†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ è‡³æ­¤ï¼Œè¿™ä¸ªè¯­å¥å°±æ‰§è¡Œå®Œæˆäº†ã€‚å¯¹äºæœ‰ç´¢å¼•çš„è¡¨ï¼Œæ‰§è¡Œçš„é€»è¾‘ä¹Ÿå·®ä¸å¤šã€‚ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ˜¯â€œå–æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€è¡Œâ€è¿™ä¸ªæ¥ å£ï¼Œä¹‹åå¾ªç¯å–â€œæ»¡è¶³æ¡ä»¶çš„ä¸‹ä¸€è¡Œâ€è¿™ä¸ªæ¥å£ï¼Œè¿™äº›æ¥å£éƒ½æ˜¯å¼•æ“ä¸­å·²ç»å®šä¹‰å¥½çš„ã€‚ä½ ä¼šåœ¨æ•°æ®åº“çš„æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­çœ‹åˆ°ä¸€ä¸ªrows_examined çš„å­—æ®µï¼Œè¡¨ç¤ºè¿™ä¸ªè¯­å¥æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰«æäº†å¤šå°‘è¡Œã€‚è¿™ä¸ªå€¼å°±æ˜¯åœ¨æ‰§è¡Œå™¨æ¯æ¬¡è°ƒç”¨å¼•æ“è·å–æ•°æ®è¡Œçš„æ—¶å€™ç´¯åŠ çš„ã€‚åœ¨æœ‰äº›åœºæ™¯ä¸‹ï¼Œæ‰§è¡Œå™¨è°ƒç”¨ä¸€æ¬¡ï¼Œåœ¨å¼•æ“å†…éƒ¨åˆ™æ‰«æäº†å¤šè¡Œï¼Œå› æ­¤å¼•æ“æ‰«æè¡Œæ•°è·Ÿ rows_examined å¹¶ä¸æ˜¯å®Œå…¨ç›¸åŒçš„\nbin_log çš„ä½¿ç”¨ ç»å¸¸å¬åˆ°åˆ åº“è·‘è·¯çš„æ¶ˆæ¯ï¼Œå…¶å®åˆ é™¤åº“ä¹‹åä¹Ÿä¸ç”¨è·‘è·¯ï¼ŒMySQL ä¼šæŠŠæˆ‘ä»¬æ‰§è¡Œçš„æ¯æ¡SQLéƒ½è®°å½•åˆ° bin-logä¸­ï¼Œ é‚£ä¹ˆä»€ä¹ˆæ˜¯ bin-log å‘¢ï¼Ÿ\nbinlogæ˜¯Serverå±‚å®ç°çš„äºŒè¿›åˆ¶æ—¥å¿—,ä»–ä¼šè®°å½•æˆ‘ä»¬çš„cudæ“ä½œã€‚Binlogæœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š\nBinlogåœ¨MySQLçš„Serverå±‚å®ç°ï¼ˆå¼•æ“å…±ç”¨ï¼‰ Binlogä¸ºé€»è¾‘æ—¥å¿—,è®°å½•çš„æ˜¯ä¸€æ¡è¯­å¥çš„åŸå§‹é€»è¾‘ Binlogä¸é™å¤§å°,è¿½åŠ å†™å…¥,ä¸ä¼šè¦†ç›–ä»¥å‰çš„æ—¥å¿— å¦‚æœï¼Œæˆ‘ä»¬è¯¯åˆ äº†æ•°æ®åº“,å¯ä»¥ä½¿ç”¨binlogè¿›è¡Œå½’æ¡£!è¦ä½¿ç”¨binlogå½’æ¡£ï¼Œé¦–å…ˆæˆ‘ä»¬å¾—è®°å½•binlogï¼Œå› æ­¤éœ€è¦å…ˆå¼€å¯MySQLçš„binlogåŠŸèƒ½ã€‚\né…ç½®my.cnf log-bin=/usr/local/mysql/data/binlog/mysql-bin # æ³¨æ„5.7ä»¥åŠæ›´é«˜ç‰ˆæœ¬éœ€è¦é…ç½®æœ¬é¡¹ï¼šï¼ˆè‡ªå®šä¹‰,ä¿è¯å”¯ä¸€æ€§)\r# server-id=123454\r#binlogæ ¼å¼ï¼Œæœ‰3ç§statement,row,mixed binlog-format=ROW #è¡¨ç¤ºæ¯1æ¬¡æ‰§è¡Œå†™å…¥å°±ä¸ç¡¬ç›˜åŒæ­¥ï¼Œä¼šå½±å“æ€§èƒ½ï¼Œä¸º0æ—¶è¡¨ç¤ºï¼Œäº‹åŠ¡æäº¤æ—¶mysqlä¸åšåˆ·ç›˜æ“ä½œï¼Œç”±ç³»ç»Ÿå†³å®š\rsync-binlog=1 binlogå‘½ä»¤ æŸ¥çœ‹bin-logæ˜¯å¦å¼€å¯\nshow variables like \u0026#39;%log_bin%\u0026#39;; ä¼šå¤šä¸€ä¸ªæœ€æ–°çš„bin-logæ—¥å¿—\nflush logs; æŸ¥çœ‹æœ€åä¸€ä¸ªbin-logæ—¥å¿—çš„ç›¸å…³ä¿¡æ¯\nshow master status; æ¸…ç©ºæ‰€æœ‰çš„bin-logæ—¥å¿—\nreset master; æŸ¥çœ‹binlogå†…å®¹\n/usr/local/mysql/bin/mysqlbinlog --no-defaults /usr/local/mysql/data/binlog/mysql-bin.000001 æ•°æ®æ¢å¤ æ¢å¤å…¨éƒ¨æ•°æ® /usr/local/mysql/bin/mysqlbinlog --no-defaults /usr/local/mysql/data/binlog/mysql-bin.000001 |mysql -uroot -pÂ test # test æ˜¯æ•°æ®åº“å æ¢å¤æŒ‡å®šæ—¶é—´æ®µæ•°æ® /usr/local/mysql/bin/mysqlbinlog --no-defaults /usr/local/mysql/data/binlog/mysql-bin.000001 --stop-date= \u0026#34;2018-03-02 12:00:00\u0026#34;Â --start-date= \u0026#34;2019-03-02 11:55:00\u0026#34;|mysql -uroot -pÂ test æ¢å¤æŒ‡å®šä½ç½®æ•°æ® /usr/local/mysql/bin/mysqlbinlog --no-defaults --start-position=\u0026#34;408\u0026#34; --stop-position=\u0026#34;731\u0026#34; /usr/local/mysql/data/binlog/mysql-bin.000001 |mysql -uroot -p test \u0026ndash;start-position = \u0026ldquo;408\u0026rdquo; \u0026ndash;start-position = \u0026lsquo;\u0026lsquo;731\u0026quot;\næ€ä¹ˆæ‰¾åˆ°å‘¢ï¼Ÿ\næˆ‘ä»¬éœ€è¦ä½¿ç”¨å·¥å…·æŸ¥çœ‹bin-logä¿¡æ¯:\n/usr/local/mysql/bin/mysqlbinlog --no-defaults /usr/local/mysql/data/binlog/mysql-bin.000001 --stop-date= \u0026#34;2018-03-02 12:00:00\u0026#34;Â --start-date= \u0026#34;2019-03-02 11:55:00\u0026#34;|mysql -uroot -pÂ test ä¿¡æ¯å¦‚ä¸‹:\nç”±æ­¤ä¾¿å¯ä»¥æ¢å¤æŒ‡å®šä½ç½®æˆ–æ—¥æœŸçš„æ•°æ®äº†.\n","date":"2022-08-01T22:20:58Z","permalink":"https://dccmmtop.github.io/posts/mysql%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%84/","section":"posts","tags":["MySQL"],"title":"MySQLå†…éƒ¨ç»“æ„"},{"categories":null,"contents":"åœ¨ select è¯­å¥ä¹‹å‰å¢åŠ  explain å…³é”®å­—ï¼ŒMySQL ä¼šåœ¨æŸ¥è¯¢ä¸Šè®¾ç½®ä¸€ä¸ªæ ‡è®°ï¼Œæ‰§è¡ŒæŸ¥è¯¢ä¼šè¿”å›æ‰§è¡Œè®¡åˆ’çš„ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ æ‰§è¡Œè¿™æ¡SQL\næ³¨æ„ï¼šå¦‚æœ from ä¸­åŒ…å«å­æŸ¥è¯¢ï¼Œä»ä¼šæ‰§è¡Œè¯¥å­æŸ¥è¯¢ï¼Œå°†ç»“æœæ”¾å…¥ä¸´æ—¶è¡¨ä¸­\nexplain ä¸¤ä¸ªå˜ç§ explain extendedï¼š\nä¼šåœ¨ explain çš„åŸºç¡€ä¸Šé¢å¤–æä¾›ä¸€äº›æŸ¥è¯¢ä¼˜åŒ–çš„ä¿¡æ¯ã€‚ç´§éšå…¶åé€šè¿‡ show warnings å‘½ä»¤å¯\nä»¥å¾—åˆ°ä¼˜åŒ–åçš„æŸ¥è¯¢è¯­å¥ï¼Œä»è€Œçœ‹å‡ºä¼˜åŒ–å™¨ä¼˜åŒ–äº†ä»€ä¹ˆã€‚é¢å¤–è¿˜æœ‰ filtered åˆ—ï¼Œæ˜¯ä¸€ä¸ªåŠåˆ†æ¯”çš„å€¼ï¼Œrows * filtered/100 å¯ä»¥ä¼°ç®—å‡ºå°†è¦å’Œ explain ä¸­å‰ä¸€ä¸ªè¡¨è¿›è¡Œè¿æ¥çš„è¡Œæ•°ï¼ˆå‰ä¸€ä¸ªè¡¨æŒ‡ explain ä¸­çš„idå€¼æ¯”å½“å‰è¡¨idå€¼å°çš„ è¡¨ï¼‰ã€‚ explain extended select * from film where id = 1; show warnings; explain partitionsï¼š\nç›¸æ¯” explain å¤šäº†ä¸ª partitions å­—æ®µï¼Œå¦‚æœæŸ¥è¯¢æ˜¯åŸºäºåˆ†åŒºè¡¨çš„è¯ï¼Œä¼šæ˜¾ç¤ºæŸ¥è¯¢å°†è®¿é—®çš„åˆ† åŒºã€‚ explainä¸­çš„åˆ— ç°æœ‰å¦‚ä¸‹è¡¨:\nDROP TABLE IF EXISTS `actor`; CREATE TABLE `actor` ( `id` int(11) NOT NULL, `name` varchar(45) DEFAULT NULL, `update_time` datetime DEFAULT NULL, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8; INSERT INTO `actor` (`id`, `name`, `update_time`) VALUES (1,\u0026#39;a\u0026#39;,\u0026#39;2017â€12â€22 15:27:18\u0026#39;), (2,\u0026#39;b\u0026#39;,\u0026#39;2017â€12â€22 15:27:18\u0026#39;), (3,\u0026#39;c\u0026#39;,\u0026#39;2017â€12â€22 15:27:18\u0026#39;); DROP TABLE IF EXISTS `film`; CREATE TABLE `film` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(10) DEFAULT NULL, PRIMARY KEY (`id`), KEY `idx_name` (`name`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8; INSERT INTO `film` (`id`, `name`) VALUES (3,\u0026#39;film0\u0026#39;),(1,\u0026#39;film1\u0026#39;),(2,\u0026#39;film2\u0026#39;); DROP TABLE IF EXISTS `film_actor`; CREATE TABLE `film_actor` ( `id` int(11) NOT NULL, `film_id` int(11) NOT NULL, `actor_id` int(11) NOT NULL, `remark` varchar(255) DEFAULT NULL, PRIMARY KEY (`id`), KEY `idx_film_actor_id` (`film_id`,`actor_id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8; INSERT INTO `film_actor` (`id`, `film_id`, `actor_id`) VALUES (1,1,1),(2,1,2),(3,2,1); actor è¡¨åªæœ‰ä¸»é”®ç´¢å¼•\nfilm è¡¨æœ‰ä¸»é”®ç´¢å¼•å’Œnameç´¢å¼•\nfilm_actor æœ‰ä¸»é”®ç´¢å¼•å’Œ (film_id, actor_id ) è”åˆç´¢å¼•\nç°æœ‰å¦‚ä¸‹æŸ¥è¯¢:\nexplain select * from film where id = 2; ç»“æœï¼š\nå¯¹ç»“æœä¸­çš„æ¯ä¸€åˆ—é€ä¸ªåˆ†æ:\nidåˆ— idåˆ—çš„ç¼–å·æ˜¯ select çš„åºåˆ—å·ï¼Œæœ‰å‡ ä¸ª select å°±æœ‰å‡ ä¸ªidï¼Œå¹¶ä¸”idçš„é¡ºåºæ˜¯æŒ‰ select å‡ºç°çš„é¡ºåºå¢é•¿çš„ã€‚\nidåˆ—è¶Šå¤§æ‰§è¡Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œidç›¸åŒåˆ™ä»ä¸Šå¾€ä¸‹æ‰§è¡Œï¼Œidä¸ºNULLæœ€åæ‰§è¡Œ\nselect_type åˆ— select_type è¡¨ç¤ºå¯¹åº”è¡Œæ˜¯ç®€å•è¿˜æ˜¯å¤æ‚çš„æŸ¥è¯¢ã€‚\nsimpleï¼šç®€å•æŸ¥è¯¢ã€‚æŸ¥è¯¢ä¸åŒ…å«å­æŸ¥è¯¢å’Œunion primaryï¼šå¤æ‚æŸ¥è¯¢ä¸­æœ€å¤–å±‚çš„ select subqueryï¼šåŒ…å«åœ¨ select ä¸­çš„å­æŸ¥è¯¢ï¼ˆä¸åœ¨ from å­å¥ä¸­ï¼‰ derivedï¼šåŒ…å«åœ¨ from å­å¥ä¸­çš„å­æŸ¥è¯¢ã€‚MySQLä¼šå°†ç»“æœå­˜æ”¾åœ¨ä¸€ä¸ªä¸´æ—¶è¡¨ä¸­ï¼Œä¹Ÿç§°ä¸ºæ´¾ç”Ÿè¡¨ï¼ˆderivedçš„è‹±æ–‡å« ä¹‰ï¼‰ union: åœ¨ union ä¸­çš„ç¬¬äºŒä¸ªå’Œéšåçš„ select æ¥çœ‹ä¸€ä¸‹ primar, subquery, derived çš„åœºæ™¯:\n-- å…³é—­mysql5.7æ–°ç‰¹æ€§å¯¹è¡ç”Ÿè¡¨çš„åˆå¹¶ä¼˜åŒ– set session optimizer_switch=\u0026#39;derived_merge=off\u0026#39;; explain select (select 1 from actor where id = 1) from (select * from film where id = 1) der; ç»“æœ:\nunion åœºæ™¯:\nexplain select 1 union all select 1; ç»“æœ:\ntable åˆ— è¿™ä¸€åˆ—è¡¨ç¤º explain çš„ä¸€è¡Œæ­£åœ¨è®¿é—®å“ªä¸ªè¡¨ã€‚\nå½“ from å­å¥ä¸­æœ‰å­æŸ¥è¯¢æ—¶ï¼Œtableåˆ—æ˜¯derivenN æ ¼å¼ï¼Œè¡¨ç¤ºå½“å‰æŸ¥è¯¢ä¾èµ– id=N çš„æŸ¥è¯¢ï¼Œäºæ˜¯å…ˆæ‰§è¡Œ id=N çš„æŸ¥ è¯¢ã€‚\nå½“æœ‰ union æ—¶ï¼ŒUNION RESULT çš„ table åˆ—çš„å€¼ä¸ºunion1,2ï¼Œ1å’Œ2è¡¨ç¤ºå‚ä¸ union çš„ select è¡Œidã€‚\nâ­type åˆ— è¿™ä¸€åˆ—è¡¨ç¤ºå…³è”ç±»å‹æˆ–è®¿é—®ç±»å‹ï¼Œå³MySQLå†³å®šå¦‚ä½•æŸ¥æ‰¾è¡¨ä¸­çš„è¡Œï¼ŒæŸ¥æ‰¾æ•°æ®è¡Œè®°å½•çš„å¤§æ¦‚èŒƒå›´ã€‚\nä¾æ¬¡ä»æœ€ä¼˜åˆ°æœ€å·®åˆ†åˆ«ä¸ºï¼š**system \u0026gt; const \u0026gt; eq_ref \u0026gt; ref \u0026gt; range \u0026gt; index \u0026gt; ALL **\n**ä¸€èˆ¬æ¥è¯´ï¼Œå¾—ä¿è¯æŸ¥è¯¢è¾¾åˆ°rangeçº§åˆ«ï¼Œæœ€å¥½è¾¾åˆ°ref **\nNULL NULLï¼šmysqlèƒ½å¤Ÿåœ¨ä¼˜åŒ–é˜¶æ®µåˆ†è§£æŸ¥è¯¢è¯­å¥ï¼Œåœ¨æ‰§è¡Œé˜¶æ®µç”¨ä¸ç€å†è®¿é—®è¡¨æˆ–ç´¢å¼•ã€‚ä¾‹å¦‚ï¼šåœ¨ç´¢å¼•åˆ—ä¸­é€‰å–æœ€å°å€¼ï¼Œå¯ ä»¥å•ç‹¬æŸ¥æ‰¾ç´¢å¼•æ¥å®Œæˆï¼Œä¸éœ€è¦åœ¨æ‰§è¡Œæ—¶è®¿é—®è¡¨, å¦‚ä¸‹:\nexplain select min(id) from film; ç»“æœ:\nconst, system const, systemï¼šmysqlèƒ½å¯¹æŸ¥è¯¢çš„æŸéƒ¨åˆ†è¿›è¡Œä¼˜åŒ–å¹¶å°†å…¶è½¬åŒ–æˆä¸€ä¸ªå¸¸é‡ï¼ˆå¯ä»¥çœ‹show warnings çš„ç»“æœï¼‰ã€‚ç”¨äº primary key æˆ– unique key çš„æ‰€æœ‰åˆ—ä¸å¸¸æ•°æ¯”è¾ƒæ—¶ï¼Œæ‰€ä»¥è¡¨æœ€å¤šæœ‰ä¸€ä¸ªåŒ¹é…è¡Œï¼Œè¯»å–1æ¬¡ï¼Œé€Ÿåº¦æ¯”è¾ƒå¿«ã€‚systemæ˜¯ constçš„ç‰¹ä¾‹ï¼Œè¡¨é‡Œåªæœ‰ä¸€æ¡æ•°æ®åŒ¹é…æ—¶ä¸ºsystem\nä¾‹å­:\nexplain extended select * from (select * from film where id = 1) tmp; ç»“æœ:\neq_ref primary key æˆ– unique key ç´¢å¼•è¢«è¿æ¥ä½¿ç”¨ ï¼Œæœ€å¤šåªä¼šè¿”å›ä¸€æ¡ç¬¦åˆæ¡ä»¶çš„è®°å½•ã€‚è¿™å¯èƒ½æ˜¯åœ¨ const ä¹‹å¤–æœ€å¥½çš„è”æ¥ç±»å‹äº†ï¼Œç®€å•çš„ select æŸ¥è¯¢ä¸ä¼šå‡ºç°è¿™ç§ typeã€‚\nä¾‹å­:\nexplain select * from film_actor left join film on film_actor.film_id = film.id; ç»“æœ:\nef ç›¸æ¯” eq_refï¼Œä¸ä½¿ç”¨å”¯ä¸€ç´¢å¼•ï¼Œè€Œæ˜¯ä½¿ç”¨æ™®é€šç´¢å¼•æˆ–è€…å”¯ä¸€æ€§ç´¢å¼•çš„éƒ¨åˆ†å‰ç¼€ï¼Œç´¢å¼•è¦å’ŒæŸä¸ªå€¼ç›¸æ¯”è¾ƒï¼Œå¯èƒ½ä¼š æ‰¾åˆ°å¤šä¸ªç¬¦åˆæ¡ä»¶çš„è¡Œã€‚\nç®€å• select æŸ¥è¯¢ï¼Œnameæ˜¯æ™®é€šç´¢å¼•ï¼ˆéå”¯ä¸€ç´¢å¼•ï¼‰ explain select * from film where name = \u0026#39;film1\u0026#39;; 2.å…³è”è¡¨æŸ¥è¯¢ï¼Œidx_film_actor_idæ˜¯film_idå’Œactor_idçš„è”åˆç´¢å¼•ï¼Œè¿™é‡Œä½¿ç”¨åˆ°äº†film_actorçš„å·¦è¾¹å‰ç¼€film_idéƒ¨åˆ†ã€‚\nexplain select film_id from film left join film_actor on film.id = film_actor.film_id; range èŒƒå›´æ‰«æé€šå¸¸å‡ºç°åœ¨ in(), between ,\u0026gt; ,\u0026lt;, \u0026gt;= ç­‰æ“ä½œä¸­ã€‚ä½¿ç”¨ä¸€ä¸ªç´¢å¼•æ¥æ£€ç´¢ç»™å®šèŒƒå›´çš„è¡Œã€‚\nexplain select * from actor where id \u0026gt; 1; index æ‰«æå…¨ç´¢å¼•å°±èƒ½æ‹¿åˆ°ç»“æœï¼Œä¸€èˆ¬æ˜¯æ‰«ææŸä¸ªäºŒçº§ç´¢å¼•ï¼Œè¿™ç§æ‰«æä¸ä¼šä»ç´¢å¼•æ ‘æ ¹èŠ‚ç‚¹å¼€å§‹å¿«é€ŸæŸ¥æ‰¾ï¼Œè€Œæ˜¯ç›´æ¥ å¯¹äºŒçº§ç´¢å¼•çš„å¶å­èŠ‚ç‚¹éå†å’Œæ‰«æï¼Œé€Ÿåº¦è¿˜æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œè¿™ç§æŸ¥è¯¢ä¸€èˆ¬ä¸ºä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ŒäºŒçº§ç´¢å¼•ä¸€èˆ¬æ¯”è¾ƒå°ï¼Œæ‰€ä»¥è¿™ ç§é€šå¸¸æ¯”ALLå¿«ä¸€äº›ã€‚\nexplain select * from film; ALLï¼š å³å…¨è¡¨æ‰«æï¼Œæ‰«æä½ çš„èšç°‡ç´¢å¼•çš„æ‰€æœ‰å¶å­èŠ‚ç‚¹ã€‚é€šå¸¸æƒ…å†µä¸‹è¿™éœ€è¦å¢åŠ ç´¢å¼•æ¥è¿›è¡Œä¼˜åŒ–äº†ã€‚\nexplain select * from actor; possible_keysåˆ— è¿™ä¸€åˆ—æ˜¾ç¤ºæŸ¥è¯¢å¯èƒ½ä½¿ç”¨å“ªäº›ç´¢å¼•æ¥æŸ¥æ‰¾ã€‚\nexplain æ—¶å¯èƒ½å‡ºç° possible_keys æœ‰åˆ—ï¼Œè€Œ key æ˜¾ç¤º NULL çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µæ˜¯å› ä¸ºè¡¨ä¸­æ•°æ®ä¸å¤šï¼Œmysqlè®¤ä¸ºç´¢å¼• å¯¹æ­¤æŸ¥è¯¢å¸®åŠ©ä¸å¤§ï¼Œé€‰æ‹©äº†å…¨è¡¨æŸ¥è¯¢ã€‚\nå¦‚æœè¯¥åˆ—æ˜¯NULLï¼Œåˆ™æ²¡æœ‰ç›¸å…³çš„ç´¢å¼•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡æ£€æŸ¥ where å­å¥çœ‹æ˜¯å¦å¯ä»¥åˆ›é€ ä¸€ä¸ªé€‚å½“çš„ç´¢å¼•æ¥æ é«˜æŸ¥è¯¢æ€§èƒ½ï¼Œç„¶åç”¨ explain æŸ¥çœ‹æ•ˆæœã€‚\nkeyåˆ— è¿™ä¸€åˆ—æ˜¾ç¤ºmysqlå®é™…é‡‡ç”¨å“ªä¸ªç´¢å¼•æ¥ä¼˜åŒ–å¯¹è¯¥è¡¨çš„è®¿é—®ã€‚\nå¦‚æœæ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œåˆ™è¯¥åˆ—æ˜¯ NULLã€‚å¦‚æœæƒ³å¼ºåˆ¶mysqlä½¿ç”¨æˆ–å¿½è§†possible_keysåˆ—ä¸­çš„ç´¢å¼•ï¼Œåœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨ force indexã€ignore indexã€‚\nkey_lenåˆ— è¿™ä¸€åˆ—æ˜¾ç¤ºäº†mysqlåœ¨ç´¢å¼•é‡Œä½¿ç”¨çš„å­—èŠ‚æ•°ï¼Œé€šè¿‡è¿™ä¸ªå€¼å¯ä»¥ç®—å‡ºå…·ä½“ä½¿ç”¨äº†ç´¢å¼•ä¸­çš„å“ªäº›åˆ—ã€‚\nä¸¾ä¾‹æ¥è¯´ï¼Œfilm_actorçš„è”åˆç´¢å¼• idx_film_actor_id ç”± film_id å’Œ actor_id ä¸¤ä¸ªintåˆ—ç»„æˆï¼Œå¹¶ä¸”æ¯ä¸ªintæ˜¯4å­—èŠ‚ã€‚é€š è¿‡ç»“æœä¸­çš„key_len=4å¯æ¨æ–­å‡ºæŸ¥è¯¢ä½¿ç”¨äº†ç¬¬ä¸€ä¸ªåˆ—ï¼šfilm_idåˆ—æ¥æ‰§è¡Œç´¢å¼•æŸ¥æ‰¾ã€‚\nexplain select * from film_actor where film_id = 2; key_lenè®¡ç®—è§„åˆ™å¦‚ä¸‹ï¼š å­—ç¬¦ä¸²\nchar(n)å’Œvarchar(n)ï¼Œ5.0.3ä»¥åç‰ˆæœ¬ä¸­ï¼Œnå‡ä»£è¡¨å­—ç¬¦æ•°ï¼Œè€Œä¸æ˜¯å­—èŠ‚æ•°ï¼Œå¦‚æœæ˜¯utf-8ï¼Œä¸€ä¸ªæ•°å­— æˆ–å­—æ¯å 1ä¸ªå­—èŠ‚ï¼Œä¸€ä¸ªæ±‰å­—å 3ä¸ªå­—èŠ‚\nchar(n)ï¼šå¦‚æœå­˜æ±‰å­—é•¿åº¦å°±æ˜¯ 3n å­—èŠ‚ varchar(n)ï¼šå¦‚æœå­˜æ±‰å­—åˆ™é•¿åº¦æ˜¯ 3n + 2 å­—èŠ‚ï¼ŒåŠ çš„2å­—èŠ‚ç”¨æ¥å­˜å‚¨å­—ç¬¦ä¸²é•¿åº¦ï¼Œå› ä¸º\nvarcharæ˜¯å˜é•¿å­—ç¬¦ä¸² **æ•°å€¼ç±»å‹ **\ntinyintï¼š1å­—èŠ‚ smallintï¼š2å­—èŠ‚ intï¼š4å­—èŠ‚ bigintï¼š8å­—èŠ‚ æ—¶é—´ç±»å‹\ndateï¼š3å­—èŠ‚ timestampï¼š4å­—èŠ‚ datetimeï¼š8å­—èŠ‚ å¦‚æœå­—æ®µå…è®¸ä¸º NULLï¼Œéœ€è¦1å­—èŠ‚è®°å½•æ˜¯å¦ä¸º NULL\nç´¢å¼•æ˜¯æœ‰æœ€å¤§é•¿åº¦é™åˆ¶çš„ ç´¢å¼•æœ€å¤§é•¿åº¦æ˜¯768å­—èŠ‚ï¼Œå½“å­—ç¬¦ä¸²è¿‡é•¿æ—¶ï¼Œmysqlä¼šåšä¸€ä¸ªç±»ä¼¼å·¦å‰ç¼€ç´¢å¼•çš„å¤„ç†ï¼Œå°†å‰åŠéƒ¨åˆ†çš„å­—ç¬¦æå–å‡ºæ¥åšç´¢å¼•ã€‚\nrefåˆ— è¿™ä¸€åˆ—æ˜¾ç¤ºäº†åœ¨keyåˆ—è®°å½•çš„ç´¢å¼•ä¸­ï¼Œè¡¨æŸ¥æ‰¾å€¼æ‰€ç”¨åˆ°çš„åˆ—æˆ–å¸¸é‡ï¼Œå¸¸è§çš„æœ‰ï¼šconstï¼ˆå¸¸é‡ï¼‰ï¼Œå­—æ®µåï¼ˆä¾‹ï¼šfilm.idï¼‰\nrowsåˆ— è¿™ä¸€åˆ—æ˜¯mysqlä¼°è®¡è¦è¯»å–å¹¶æ£€æµ‹çš„è¡Œæ•°ï¼Œæ³¨æ„è¿™ä¸ªä¸æ˜¯ç»“æœé›†é‡Œçš„è¡Œæ•°ã€‚æœ‰æ—¶ä¼šç›¸å·®å¾ˆå¤§\nExtraåˆ— è¿™ä¸€åˆ—å±•ç¤ºçš„æ˜¯é¢å¤–ä¿¡æ¯ã€‚å¸¸è§çš„é‡è¦å€¼å¦‚ä¸‹ï¼š\nUsing indexï¼šä½¿ç”¨è¦†ç›–ç´¢å¼• ä½¿ç”¨äº† è¾…åŠ©ç´¢å¼•ï¼Œå¹¶ä¸”ä½¿ç”¨äº†ç´¢å¼•è¦†ç›–\nè¦†ç›–ç´¢å¼•å®šä¹‰ ï¼šmysqlæ‰§è¡Œè®¡åˆ’explainç»“æœé‡Œçš„keyæœ‰ä½¿ç”¨ç´¢å¼•ï¼Œå¦‚æœselectåé¢æŸ¥è¯¢çš„å­—æ®µéƒ½å¯ä»¥ä»è¿™ä¸ªç´¢å¼•çš„æ ‘ä¸­è·å–ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬å¯ä»¥è¯´æ˜¯ç”¨åˆ°äº†è¦†ç›–ç´¢å¼•ï¼Œextraé‡Œä¸€èˆ¬éƒ½æœ‰using indexï¼›è¦†ç›–ç´¢å¼•ä¸€èˆ¬é’ˆå¯¹çš„æ˜¯è¾…åŠ©ç´¢å¼•ï¼Œæ•´ä¸ªæŸ¥è¯¢ç»“æœåªé€šè¿‡è¾…åŠ©ç´¢å¼•å°±èƒ½æ‹¿åˆ°ç»“æœï¼Œä¸éœ€è¦é€šè¿‡è¾…åŠ©ç´¢å¼•æ ‘æ‰¾åˆ°ä¸»é”®ï¼Œå†é€šè¿‡ä¸»é”®å»ä¸»é”®ç´¢å¼•æ ‘é‡Œè·å–å…¶å®ƒå­—æ®µå€¼\nä¾‹å­:\nexplain select film_id from film_actor where film_id = 1; Using where ä½¿ç”¨ where è¯­å¥æ¥å¤„ç†ç»“æœï¼Œå¹¶ä¸”æŸ¥è¯¢çš„åˆ—æœªè¢«ç´¢å¼•è¦†ç›–\nexplain select * from actor where name = \u0026#39;a\u0026#39;; Using index condition æŸ¥è¯¢çš„åˆ—ä¸å®Œå…¨è¢«ç´¢å¼•è¦†ç›–ï¼Œwhereæ¡ä»¶ä¸­æ˜¯ä¸€ä¸ªå‰å¯¼åˆ—çš„èŒƒå›´ï¼›\nexplain select * from film_actor where film_id \u0026gt; 1; Using temporary mysqléœ€è¦åˆ›å»ºä¸€å¼ ä¸´æ—¶è¡¨æ¥å¤„ç†æŸ¥è¯¢ã€‚å‡ºç°è¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯è¦è¿›è¡Œä¼˜åŒ–çš„ï¼Œé¦–å…ˆæ˜¯æƒ³åˆ°ç”¨ç´¢\nå¼•æ¥ä¼˜åŒ–ã€‚\nactor.nameæ²¡æœ‰ç´¢å¼•ï¼Œæ­¤æ—¶åˆ›å»ºäº†å¼ ä¸´æ—¶è¡¨æ¥distinct explain select distinct name from actor; 2. film.nameå»ºç«‹äº†idx_nameç´¢å¼•ï¼Œæ­¤æ—¶æŸ¥è¯¢æ—¶extraæ˜¯using index,æ²¡æœ‰ç”¨ä¸´æ—¶è¡¨\nexplain select distinct name from film; Using filesort å°†ç”¨å¤–éƒ¨æ’åºè€Œä¸æ˜¯ç´¢å¼•æ’åºï¼Œæ•°æ®è¾ƒå°æ—¶ä»å†…å­˜æ’åºï¼Œå¦åˆ™éœ€è¦åœ¨ç£ç›˜å®Œæˆæ’åºã€‚è¿™ç§æƒ…å†µä¸‹ä¸€ èˆ¬ä¹Ÿæ˜¯è¦è€ƒè™‘ä½¿ç”¨ç´¢å¼•æ¥ä¼˜åŒ–çš„ã€‚\nactor.nameæœªåˆ›å»ºç´¢å¼•ï¼Œä¼šæµè§ˆactoræ•´ä¸ªè¡¨ï¼Œä¿å­˜æ’åºå…³é”®å­—nameå’Œå¯¹åº”çš„idï¼Œç„¶åæ’åºnameå¹¶æ£€ç´¢è¡Œè®°å½• explain select * from actor order by name; 2. film.nameå»ºç«‹äº†idx_nameç´¢å¼•,æ­¤æ—¶æŸ¥è¯¢æ—¶extraæ˜¯using index\nexplain select * from film order by name; Select tables optimized away ä½¿ç”¨æŸäº›èšåˆå‡½æ•°ï¼ˆæ¯”å¦‚ maxã€minï¼‰æ¥è®¿é—®å­˜åœ¨ç´¢å¼•çš„æŸä¸ªå­—æ®µæ˜¯\nexplain select min(id) from film; ç´¢å¼•æœ€ä½³å®è·µ æœ‰å¦‚ä¸‹ç¤ºä¾‹è¡¨:\nCREATE TABLE `employees` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(24) NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;å§“å\u0026#39;, `age` int(11) NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;å¹´é¾„\u0026#39;, `position` varchar(20) NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;èŒä½\u0026#39;, `hire_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT \u0026#39;å…¥èŒæ—¶é—´\u0026#39;, PRIMARY KEY (`id`), KEY `idx_name_age_position` (`name`,`age`,`position`) USING BTREE ) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8 COMMENT=\u0026#39;å‘˜å·¥è®°å½•è¡¨\u0026#39;; INSERT INTO employees(name,age,position,hire_time) VALUES(\u0026#39;LiLei\u0026#39;,22,\u0026#39;manager\u0026#39;,NOW()); INSERT INTO employees(name,age,position,hire_time) VALUES(\u0026#39;HanMeimei\u0026#39;, 23,\u0026#39;dev\u0026#39;,NOW()); INSERT INTO employees(name,age,position,hire_time) VALUES(\u0026#39;Lucy\u0026#39;,23,\u0026#39;dev\u0026#39;,NOW()); employees è¡¨æœ‰ä¸»é”®ç´¢å¼•å’Œï¼ˆname, age, postitonï¼‰ è”åˆç´¢å¼•\nå…¨å€¼åŒ¹é… EXPLAIN SELECT * FROM employees WHERE name= \u0026#39;LiLei\u0026#39;; EXPLAIN SELECT * FROM employees WHERE name= \u0026#39;LiLei\u0026#39; AND age = 22; EXPLAIN SELECT * FROM employees WHERE name= \u0026#39;LiLei\u0026#39; AND age = 22 AND position =\u0026#39;manager\u0026#39;; ç”±ä¸Šé¢3ä¸ªæŸ¥è¯¢è¯­å¥å’Œåˆ†æç»“æœå¯çŸ¥ï¼Œkey_len å­—æ®µå¯ä»¥æ¨ç®—å‡ºç”¨äº†å“ªäº›ç´¢å¼•\nå·¦å‰ç¼€æ³•åˆ™ å¦‚æœç´¢å¼•äº†å¤šåˆ—ï¼Œè¦éµå®ˆæœ€å·¦å‰ç¼€æ³•åˆ™ã€‚æŒ‡çš„æ˜¯æŸ¥è¯¢ä»ç´¢å¼•çš„æœ€å·¦å‰åˆ—å¼€å§‹å¹¶ä¸”ä¸è·³è¿‡ç´¢å¼•ä¸­çš„åˆ—ã€‚\nEXPLAIN SELECT * FROM employees WHERE name = \u0026#39;Bill\u0026#39; and age = 31; èƒ½ç”¨åˆ° name å’Œ age ç´¢å¼•\nEXPLAIN SELECT * FROM employees WHERE age = 30 AND position = \u0026#39;dev\u0026#39;; æ— æ³•åˆ©ç”¨ç´¢å¼•ï¼Œå› ä¸ºè·³è¿‡äº† name å­—æ®µï¼Œå¯ä»¥å‚ç…§ç´¢å¼•åŸç†\nEXPLAIN SELECT * FROM employees WHERE position = \u0026#39;manager\u0026#39;; åŒæ ·æ— æ³•åˆ©ç”¨ç´¢å¼•\nä¸åœ¨ç´¢å¼•åˆ—ä¸Šåšä»»ä½•æ“ä½œ å¦‚æœåœ¨ç´¢å¼•åˆ—ä¸Šè®¡ç®—ã€å‡½æ•°ã€ï¼ˆè‡ªåŠ¨oræ‰‹åŠ¨ï¼‰ç±»å‹è½¬æ¢ï¼‰ï¼Œä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆè€Œè½¬å‘å…¨è¡¨æ‰«æ\nEXPLAIN SELECT * FROM employees WHERE name = \u0026#39;LiLei\u0026#39;; EXPLAIN SELECT * FROM employees WHERE left(name, 2) = \u0026#39;Li\u0026#39;; -- åå­—çš„å‰ä¸¤ä½ ç¬¬äºŒä¸ªè¯­å¥åœ¨nameåˆ—ä¸Šä½¿ç”¨äº† left å‡½æ•°ã€‚ä½¿ç´¢å¼•å¤±æ•ˆ\nå­˜å‚¨å¼•æ“ä¸èƒ½ä½¿ç”¨ç´¢å¼•ä¸­èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ— EXPLAIN SELECT * FROM employees WHERE name= \u0026#39;LiLei\u0026#39; AND age = 22 AND position =\u0026#39;manager\u0026#39;; EXPLAIN SELECT * FROM employees WHERE name= \u0026#39;LiLei\u0026#39; AND age \u0026gt; 22 AND position =\u0026#39;manager\u0026#39;; ç¬¬ä¸€æ¡å¯ä»¥åˆ©ç”¨å…¨éƒ¨ç´¢å¼• ç¬¬äºŒæ¡åªèƒ½ä½¿ç”¨ (name age) ç´¢å¼• æ— æ³•åˆ©ç”¨ posotion ,å› ä¸º position åœ¨ age å³è¾¹ï¼Œä¸” age æ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œ å¤±æ•ˆåŸç†å‚è§ç´¢å¼•åŸç†\nå°½é‡ä½¿ç”¨è¦†ç›–ç´¢å¼• åªè®¿é—®ç´¢å¼•åŒ…å«çš„åˆ—ï¼Œå‡å°‘ select * çš„æŸ¥è¯¢ï¼Œæ ¹æ®äºŒçº§ç´¢å¼•æ„é€ å¯çŸ¥ï¼Œå¦‚æœè®¿é—®äº†ç´¢å¼•ä¸­ä¸åŒ…å«çš„åˆ—ï¼Œéœ€è¦å†æ¬¡æ‰«æä¸»é”®ç´¢å¼•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å›è¡¨\nä½¿ç”¨äº†è¦†ç›–ç´¢å¼•:\nEXPLAIN SELECT name,age FROM employees WHERE name= \u0026#39;LiLei\u0026#39; AND age = 23 AND position =\u0026#39;manager\u0026#39;; æœªä½¿ç”¨è¦†ç›–ç´¢å¼•:\nEXPLAIN SELECT * FROM employees WHERE name= \u0026#39;LiLei\u0026#39; AND age = 23 AND position =\u0026#39;manager\u0026#39;; éæŸ¥è¯¢ mysqlåœ¨ä½¿ç”¨ä¸ç­‰äºï¼ˆï¼=æˆ–è€…\u0026lt;\u0026gt;ï¼‰ï¼Œnot in ï¼Œnot exists çš„æ—¶å€™æ— æ³•ä½¿ç”¨ç´¢å¼•ä¼šå¯¼è‡´å…¨è¡¨æ‰«æ\n\u0026lt; å°äºã€ \u0026gt; å¤§äºã€ \u0026lt;=ã€\u0026gt;= è¿™äº›ï¼Œmysqlå†…éƒ¨ä¼˜åŒ–å™¨ä¼šæ ¹æ®æ£€ç´¢æ¯”ä¾‹ã€è¡¨å¤§å°ç­‰å¤šä¸ªå› ç´ æ•´ä½“è¯„ä¼°æ˜¯å¦ä½¿ç”¨ç´¢å¼•, è¿™ä¸ªå¹¶ä¸æ˜¯é“å®šçš„è§„åˆ™\nEXPLAIN SELECT * FROM employees WHERE name != \u0026#39;LiLei\u0026#39;; is null,is not null ä¸€èˆ¬æƒ…å†µä¸‹ä¹Ÿæ— æ³•ä½¿ç”¨ç´¢å¼• EXPLAIN SELECT * FROM employees WHERE name is null like å·¦æ¨¡ç³ŠæŸ¥æ‰¾ likeä»¥é€šé…ç¬¦å¼€å¤´ï¼ˆ\u0026rsquo;$abc\u0026hellip;\u0026rsquo;ï¼‰mysqlç´¢å¼•å¤±æ•ˆä¼šå˜æˆå…¨è¡¨æ‰«ææ“ä½œ\nå¦‚ä¸‹:\nEXPLAIN SELECT * FROM employees WHERE name like \u0026#39;%Lei\u0026#39; å¦‚æœæ˜¯ä½¿ç”¨äº†å³æ¨¡ç³ŠæŸ¥æ‰¾ï¼Œå¯ä»¥åˆ©ç”¨ç´¢å¼•:\nEXPLAIN SELECT * FROM employees WHERE name like \u0026#39;Lei%\u0026#39; â­å¦‚ä½•è§£å†³å·¦æ¨¡ç³Šç´¢å¼•ä¸ç”Ÿæ•ˆçš„é—®é¢˜ï¼Ÿ ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼ŒæŸ¥è¯¢å­—æ®µå¿…é¡»æ˜¯å»ºç«‹è¦†ç›–ç´¢å¼•å­—æ®µ EXPLAIN SELECT name,age,position FROM employees WHERE name like \u0026#39;%Lei%\u0026#39;; å¦‚æœä¸èƒ½ä½¿ç”¨è¦†ç›–ç´¢å¼•åˆ™å¯èƒ½éœ€è¦å€ŸåŠ©æœç´¢å¼•æ“ å­—ç¬¦ä¸²ä¸åŠ å•å¼•å·ç´¢å¼•å¤±æ•ˆ name æ˜¯å­—ç¬¦ä¸²ç±»å‹\nEXPLAIN SELECT * FROM employees WHERE name = 1000; å› ä¸ºMySQLå¸®æˆ‘ä»¬åšäº†ä¸€ä¸ªç±»å‹è½¬æ¢ï¼Œç›¸å½“äºåœ¨ name åˆ—ä¸Šæ‰§è¡Œäº†ä¸€ä¸ªå‡½æ•°ã€‚æ— æ³•åˆ©ç”¨ç´¢å¼•\nå°‘ç”¨oræˆ–in ç”¨oræˆ–inï¼Œç”¨å®ƒæŸ¥è¯¢æ—¶ï¼Œmysqlä¸ä¸€å®šä½¿ç”¨ç´¢å¼•ï¼Œmysqlå†…éƒ¨ä¼˜åŒ–å™¨ä¼šæ ¹æ®æ£€ç´¢æ¯”ä¾‹ã€è¡¨å¤§å°ç­‰å¤šä¸ªå› ç´ æ•´ä½“è¯„ ä¼°æ˜¯å¦ä½¿ç”¨ç´¢å¼•ï¼Œè¯¦è§èŒƒå›´æŸ¥è¯¢ä¼˜åŒ–\nè¡¨æ•°æ®é‡å¤ªå°‘æ—¶ï¼Œä¸”æ— æ³•åˆ©ç”¨è¦†ç›–ç´¢å¼•ï¼Œä¸ä¼šèµ°äºŒçº§ç´¢å¼•ï¼Œå› ä¸ºè¿˜éœ€è¦å›è¡¨æ“ä½œï¼ŒMySQL è®¤ä¸ºè¿˜ä¸å¦‚ç›´æ¥æŸ¥å…¨è¡¨æ¥çš„å¿«ï¼Œåæ­£å…¨è¡¨ä¹Ÿæ²¡æœ‰å¤šå°‘æ•°æ®, å¦‚ä¸‹:\nEXPLAIN SELECT * FROM employees WHERE name = \u0026#39;LiLei\u0026#39; or name = \u0026#39;HanMeimei\u0026#39;; èŒƒå›´æŸ¥è¯¢ä¼˜åŒ– å…ˆç»™ age å­—æ®µæ·»åŠ ä¸€ä¸ªå•ç´¢å¼•\nALTER TABLE `employees` ADD INDEX `idx_age` (`age`) USING BTREE; å†æ‰§è¡Œä¸€ä¸‹æŸ¥è¯¢\nexplain select * from employees where age \u0026gt;=1 and age \u0026lt;=2000; å‘ç°å¹¶æ²¡æœ‰èµ°ç´¢å¼•ï¼Œmysqlå†…éƒ¨ä¼˜åŒ–å™¨ä¼šæ ¹æ®æ£€ç´¢æ¯”ä¾‹ã€è¡¨å¤§å°ç­‰å¤šä¸ªå› ç´ æ•´ä½“è¯„ä¼°æ˜¯å¦ä½¿ç”¨ç´¢å¼•ã€‚æ¯”å¦‚è¿™ä¸ªä¾‹å­ï¼Œå¯èƒ½æ˜¯ç”±äºå•æ¬¡æ•°æ®é‡æŸ¥è¯¢è¿‡å¤§å¯¼è‡´ä¼˜åŒ–å™¨æœ€ç»ˆé€‰æ‹©ä¸èµ°ç´¢å¼•\nä¼˜åŒ–æ–¹æ³•ï¼šå¯ä»¥å°†å¤§çš„èŒƒå›´æ‹†åˆ†æˆå¤šä¸ªå°èŒƒå›´, å¦‚ä¸‹\nexplain select * from employees where age \u0026gt;=1 and age \u0026lt;=1000; explain select * from employees where age \u0026gt;=1001 and age \u0026lt;=2000; ç´¢å¼•æ€»ç»“ like KK%ç›¸å½“äº=å¸¸é‡ï¼Œ%KKå’Œ%KK% ç›¸å½“äºèŒƒå›´\n","date":"2022-08-01T10:05:55Z","permalink":"https://dccmmtop.github.io/posts/explain%E8%AF%A6%E8%A7%A3/","section":"posts","tags":["MySQL"],"title":"Explainè¯¦è§£"},{"categories":null,"contents":"ç´¢å¼•æ˜¯ä»€ä¹ˆ ç´¢å¼•æ˜¯å¸®åŠ©MySQLé«˜æ•ˆè·å–æ•°æ®çš„æ’å¥½åºçš„æ•°æ®ç»“æ„\næœ€é‡è¦çš„ç‚¹æ˜¯æœ‰åºçš„ï¼Œæˆ‘ä»¬ç”¨ç´¢å¼•å°±æ˜¯ä¸ºäº†å¿«é€Ÿçš„æŸ¥æ‰¾æ•°æ®ï¼Œå¦‚æœä¸€å †æ•°æ®æ˜¯æ— åºçš„ï¼Œç¨‹åºåªèƒ½æŒ¨ä¸ªéå†æ¯ä¸ªå…ƒç´ ï¼Œå¯¹æ¯”å€¼ï¼Œæ‰èƒ½æ‰¾åˆ°æŸä¸ªå…ƒç´ ï¼Œæœ€åçš„æƒ…å†µè¦æ¯”å¯¹Næ¬¡ï¼Œ N æ˜¯è¿™ä¸€å †æ•°æ®çš„é•¿åº¦ã€‚å¦‚æœæ•°æ®æ˜¯æœ‰åºçš„ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼Œä»–çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(long N)ï¼Œæ•ˆç‡æ¯”ç›´æ¥æŒ¨ä¸ªæŸ¥æ‰¾å¿«çš„å¤šã€‚\näºŒåˆ†æŸ¥æ‰¾ç®—æ³•å…³é”®æ­¥éª¤å°±æ˜¯æ‰¾åˆ°åŒºé—´çš„ä¸­é—´å€¼ï¼Œç„¶åç¡®å®šè¦æŸ¥æ‰¾çš„å€¼è½åœ¨å·¦åŒºé—´è¿˜æ˜¯å³åŒºé—´ï¼Œä¸€ç›´é‡å¤è¿™ä¸ªæ­¥éª¤ç›´åˆ°æ‰¾åˆ°è¯¥å€¼ã€‚äºæ˜¯å°±å¯ä»¥å°†è¿™ç§æŸ¥è¯¢æ–¹æ³•æ˜ å°„æˆä¸€ç§æ•°æ®ç»“æ„â€”â€”æ ‘ã€‚æˆ‘ä»¬è§„å®šä¸€ç§æ ‘ï¼Œæœ‰å·¦èŠ‚ç‚¹ï¼Œå³èŠ‚ç‚¹ï¼Œå’Œå½“å‰èŠ‚ç‚¹ã€‚å¹¶ä¸”å·¦èŠ‚ç‚¹ \u0026lt; å½“å‰èŠ‚ç‚¹ \u0026lt; å³èŠ‚ç‚¹ . å¦‚ä¸‹å›¾æ‰€ç¤º:\nç”±äºæ ‘å…·æœ‰æ–¹ä¾¿å¿«é€ŸæŸ¥æ‰¾çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šä½¿ç”¨æ ‘ç»“æ„å»å­˜å‚¨ç´¢å¼•ï¼Œå¹¶å¯¹ç®€å•çš„æŸ¥æ‰¾äºŒå‰æ ‘åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œæ¯”å¦‚ çº¢é»‘æ ‘ï¼Œå¹³è¡¡äºŒå‰æ ‘ï¼Œ B æ ‘ B+æ ‘\næ ‘çš„æ„å»ºï¼Œåˆ é™¤ï¼Œ æŸ¥æ‰¾éƒ½æœ‰ä¸€å®šçš„ç®—æ³•ï¼Œè¿™é‡Œä¸è¯¦ç»†æè¿°ï¼Œåªéœ€çŸ¥é“æ ‘æœ‰ä¸€ä¸ªé€šç”¨çš„ç‰¹æ€§ï¼šæ ‘çš„é«˜åº¦è¶Šä½ï¼ŒæŸ¥æ‰¾æ•ˆç‡è¶Šé«˜\næ‰€ä»¥ç´¢å¼•çš„æ„å»º ï¼Œ æœ¬è´¨ä¸Šæ˜¯æ§åˆ¶æ ‘çš„é«˜åº¦\nç´¢å¼•æ•°æ®ç»“æ„ äºŒå‰æ ‘ï¼š çº¢é»‘æ ‘ Hash è¡¨ B Tree æ ‘å½¢ç´¢å¼• è¡¨ä¸­çš„æ•°æ®ä¸ç´¢å¼•ç»“æ„æ˜ å°„å…³ç³»å¯ä»¥ç†è§£å¦‚ä¸‹å›¾:\nåŠ å…¥è¦æ‰¾åˆ° col2 = 23 çš„è®°å½•ï¼Œå¦‚æœä¸ä½¿ç”¨ç´¢å¼•ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ•´å¼ è¡¨æ‰«æï¼Œä» 34 -\u0026gt; 77 -\u0026gt; 5 -\u0026gt; 91 -\u0026gt; 22 -\u0026gt; 89 -\u0026gt; 23, éœ€è¦å¯¹æ¯”7æ¬¡æ‰èƒ½æ‰¾åˆ°\nä½¿ç”¨ç´¢å¼•æ—¶ï¼Œ æŸ¥æ‰¾è·¯å¾„æ—¶æ˜¯ 34 -\u0026gt; 22 -\u0026gt; 23 åªéœ€å¯¹æ¯”3æ¬¡å°±è¡Œã€‚åœ¨è¡¨ä¸­æ•°æ®é‡æå¤§æ—¶ï¼Œå·®åˆ«æ›´æ˜æ˜¾\næ ‘çš„åŠ¨ç”» æ¨èä¸€ä¸ªåœ¨çº¿å·¥å…·ï¼Œå®ƒä»¥åŠ¨ç”»çš„å½¢å¼æè¿°äº†æ¯ç§æ ‘çš„æ„å»ºä¸æŸ¥æ‰¾æ–¹æ³•\nä¸ºä»€ä¹ˆä¸æ˜¯ç®€å•çš„äºŒå‰æ ‘ï¼Ÿ æˆ‘ä»¬çŸ¥é“MySQLç´¢å¼•é‡‡ç”¨çš„æ˜¯ B+æ ‘ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸æ˜¯å…¶ä»–çš„æ ‘å‘¢ï¼Ÿ\nå› ä¸ºåœ¨é¡ºåºæ’å…¥ä¸‹ï¼Œæ ‘çš„é«˜åº¦ä¼šä¸€ç›´å¢åŠ ï¼Œç­‰åŒäºé“¾è¡¨ã€‚æ— æ³•æ§åˆ¶æ ‘çš„é«˜åº¦ï¼Œå¦‚ä¸‹å›¾:\nå¦‚æœéœ€è¦æŸ¥æ‰¾6ï¼Œä»ç„¶éœ€è¦æŸ¥æ‰¾6æ¬¡\nä¸ºä»€ä¹ˆä¸æ˜¯çº¢é»‘æ ‘ï¼Ÿ çº¢é»‘æ ‘ï¼ˆå¹³è¡¡äºŒå‰æ ‘ï¼‰ï¼š è™½ç„¶ä¼šè‡ªåŠ¨å¹³è¡¡èŠ‚ç‚¹ä½ç½®ï¼Œä½†ä»ç„¶é«˜åº¦ä¸å¯æ§ã€‚è¡¨æ¯”è¾ƒå¤§æ—¶ä¼šå¯¼è‡´æ ‘çš„é«˜åº¦å¾ˆé«˜ã€‚å¢åŠ æŸ¥æ‰¾æ¬¡æ•°\nä¸ºä»€ä¹ˆæœ€ç»ˆé€‰æ‹©B+æ ‘ è€Œä¸æ˜¯Bæ ‘ è¦è§£å†³è¿™ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“è¿™ä¸¤ç§æ ‘çš„æ„é€ ï¼Œå¦‚ä¸‹å›¾\nB Tree:\nB + Tree:\næ°´å¹³æ–¹å‘å¯ä»¥å­˜æ”¾æ›´å¤šçš„ç´¢å¼•key B+æ ‘å°†æ•°æ®å…¨éƒ¨æ”¾åˆ°å¶å­èŠ‚ç‚¹ï¼Œç•™ä¸‹æ›´å¤šçš„ç©ºé—´æ”¾ key, key è¶Šå¤šï¼Œå®½åº¦è¶Šå®½ï¼ŒåŒæ ·çš„æ•°æ®é‡ï¼Œå®½åº¦è¶Šå¤§ï¼Œé«˜åº¦è¶Šå°ã€‚æŸ¥æ‰¾æ¬¡æ•°å°±è¶Šå°ã€‚\nä¸ºä»€ä¹ˆéœ€è¦ æ‰©å±•æ ‘çš„å®½åº¦è€Œä¸æ˜¯æ ‘çš„æ·±åº¦å‘¢ï¼Ÿ\nå¦‚æœæŒ‰ç…§ä¸Šé¢çš„è¯´æ³•ï¼Œæˆ‘ä»¬æ‹“å®½äº†æ ‘çš„å®½åº¦ï¼Œå‡å°‘äº†æ ‘çš„é«˜åº¦ï¼Œä½†æ˜¯æ¯”è¾ƒæ¬¡æ•°å¹¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œåªä¸è¿‡æ˜¯å‡å°‘äº†çºµå‘çš„æ¯”è¾ƒï¼Œå¢åŠ äº†æ¨ªå‘çš„æ¯”è¾ƒ\nè¿™ä¸ªç–‘é—®çš„å‰ææ˜¯æ‰€æœ‰çš„æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼Œç›´æ¥åœ¨å†…å­˜ä¸­è¿›è¡Œæ¯”è¾ƒå¤§å°ã€‚ ä½†æ˜¯äº‹å®å¹¶éå¦‚æ­¤ï¼Œä¸å¯èƒ½æŠŠè¡¨ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½åŠ åˆ°å†…å­˜ä¸­ï¼Œå¿…é¡»å…ˆä»ç£ç›˜ä¸­åŠ åœ¨ä¸€éƒ¨åˆ†æ•°æ®åˆ°å†…å­˜ï¼Œç„¶ååœ¨å†…å­˜ä¸­æ¯”è¾ƒå¤§å°ï¼Œå†…å­˜ä¸­è¿ç®—çš„é€Ÿåº¦è¿œè¿œå¤§äºä»ç£ç›˜åŠ è½½æ•°æ®çš„é€Ÿåº¦ã€‚ç£ç›˜åŠ è½½æ•°æ®æ˜¯æœºæ¢°è¿åŠ¨ï¼Œéœ€è¦ç”µæœºå¸¦åŠ¨ç£é’ˆè½¬åœˆæ‰«æç£é“ã€‚å†…å­˜è¿ç®—åˆ™æ˜¯ç”µå­è¿åŠ¨ï¼Œä¸å¯åŒæ—¥è€Œè¯­ã€‚\næ•°æ®ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæ˜¯æœ‰æœ€å°å•ä½çš„ï¼Œè¿™ä¸ªå•ä½æ˜¯ é¡µï¼Œ ä¸æ˜¯ å­—èŠ‚æˆ–è€… ä½ï¼Œ é¡µæ˜¯å›ºå®šå­—èŠ‚æ•°æ®ï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šï¼Œè¿™æ ·å¯ä»¥å‡å°‘åŠ è½½ç£ç›˜çš„æ¬¡æ•°ã€‚\nç”±äºB Tree çš„æ¯ä¸€å±‚éƒ½å·²ç»æ˜¯æœ‰åºçš„ï¼Œæˆ‘ä»¬æŠŠæ ‘ä¸­æ°´å¹³æ–¹å‘çš„æ•°æ®æ”¾åœ¨ç£ç›˜ç›¸é‚»çš„åœ°æ–¹ï¼Œæ¯æ¬¡ä»ç£ç›˜åŠ è½½ä¸€é¡µæ•°æ®æ—¶ï¼Œä¾¿å¯ä»¥å¾—åˆ°éƒ¨åˆ†æˆ–å…¨éƒ¨çš„æ°´å¹³æ–¹å‘çš„ç»“ç‚¹ï¼Œä¸ç”¨å†æ¬¡æ’åºã€‚\nåœ¨æ°´å¹³æ–¹å‘åœ¨å†…å­˜ä¸­ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾çš„æ•ˆç‡è¿œè¿œå¤§äºä»ç£ç›˜ä¸­åŠ è½½ä¸€é¡µæ•°æ®ï¼Œ æ‰€ä»¥æˆ‘ä»¬å¸Œæœ›æ ‘è¶Šå®½è¶Šå¥½,è¿™æ ·ä¸€æ¬¡æ€§åŠ è½½çš„æ•°æ®å°±è¶Šå¤šï¼Œè€Œä¸æ˜¯è¶Šé«˜è¶Šå¥½\nå¯¹äºB+ æ ‘ï¼Œæˆ‘ä»¬å‡è®¾è¦æŸ¥æ‰¾50è¿™ä¸ªæ•°æ®ï¼Œå…ˆä»æ ¹èŠ‚ç‚¹å³(15 56 77) è¿™äº›æ•°æ®ä¸­æ‰¾åˆ°50æ‰€å¤„çš„èŒƒå›´ï¼Œå› ä¸º (15 56 77) å·²ç»æ˜¯æœ‰åºçš„ï¼Œå¯ä»¥æ ¹æ®äºŒåˆ†æŸ¥æ‰¾ç®—æ³•æ‰¾åˆ° 50 å¤„äº 15\u0026ndash;56ä¹‹é—´ï¼Œ\nç„¶ååŠ è½½ 15 æ‰€æŒ‡å‘çš„ä¸‹ä¸€é¡µæ•°æ® ï¼ˆ15 20 49ï¼‰,å†æ¬¡æ ¹æ®äºŒåˆ†æŸ¥æ‰¾ç®—æ³•ï¼Œæ‰¾åˆ°50å¤„äº 49ä¹‹åï¼Œå†ä»ç£ç›˜åŠ è½½49æ‰€æŒ‡å‘çš„æ•°æ®é¡µï¼Œæ‰¾åˆ°50\næ•°æ®é‡ä¼°ç®— MySQL è‡ªå·±ä¹Ÿæœ‰ä¸€ä¸ªé€»è¾‘ é¡µï¼Œä¸€èˆ¬æ˜¯æ“ä½œç³»ç»Ÿä¸­ é¡µ çš„æ•´æ•°å€ï¼Œè¿™ä¸ªé€»è¾‘é¡µçš„æ•°æ®å¯ä»¥é€šè¿‡é…ç½®ä¿®æ”¹ï¼Œä½†æ˜¯ä¸å»ºè®®ï¼ŒMySQL æ˜¯ç»è¿‡å¤§é‡çš„æµ‹è¯•ï¼Œä¸ºæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåˆç†çš„é»˜è®¤å€¼ 16Kb\nå¯ä»¥é€šè¿‡ä¸‹é¢è¯­å¥æŸ¥è¯¢ï¼š\nshow global status like \u0026#39;Innodb_page_size\u0026#39; å‡è®¾ä¸Šå›¾ä¸­è¡¨ç¤ºçš„æ˜¯ä¸»é”®ç´¢å¼•ï¼Œç±»å‹æ˜¯ bigint, å  8 ä¸ªå­—èŠ‚ã€‚æŒ‡å‘ä¸‹ä¸€é¡µçš„æŒ‡é’ˆå  6 ä¸ªå­—èŠ‚ï¼Œ é‚£ä¹ˆè¿™ä¸€é¡µå¯ä»¥å­˜æ”¾ 16 * 1024 / (8 + 6) = 1170 ä¸ªkey, åŒç†ç¬¬äºŒé¡µå³ ï¼ˆ15 20 49 \u0026hellip;.ï¼‰ ä¹Ÿå¯ä»¥æ”¾ 1170 ä¸ªkey , å¯¹äºç¬¬ä¸‰é¡µï¼Œä¹Ÿå°±æ˜¯å¶å­èŠ‚ç‚¹ï¼ŒåŒ…å«äº†ä¸»é”®å’Œå¯¹åº”æ•´è¡Œçš„æ•°æ®ã€‚å°±æŒ‰ç…§ä¸€è¡Œæ•°æ®æ”¾1KB å§(å·²ç»æ¯”è¾ƒå¤§äº†) èƒ½æ”¾ 16 è¡Œï¼Œé‚£ä¹ˆåªæœ‰ä¸€é¡µæ ¹èŠ‚ç‚¹çš„è¯ï¼Œ è¿™ä¸ªç´¢å¼•ç´¢å¼•æ ‘èƒ½æ”¾ 1170 * 1170 * 16 =21,902,400 è¡Œæ•°æ®ã€‚ è¿™æ£µæ ‘çš„é«˜åº¦åªæœ‰3ï¼Œå°±å·²ç»èƒ½æ”¯æŒä¸Šåƒä¸‡çš„æ•°æ®é‡äº†ã€‚ä¹Ÿå°±æ˜¯åªéœ€åŠ è½½3æ¬¡ç£ç›˜å°±å¯ä»¥æŸ¥æ‰¾åˆ°æ•°æ®äº†ã€‚å¹¶ä¸”MySQL å­˜æ”¾æ ¹èŠ‚ç‚¹çš„é¡µè¿˜æœ‰ä¼˜åŒ–ï¼Œå¯èƒ½ä¼šæŠŠè¿™ä¸ªé¡µå¸¸é©»å†…å­˜ã€‚\nå¶å­èŠ‚ç‚¹åŒ…å«æ‰€æœ‰çš„ç´¢å¼•å­—æ®µ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåœ¨ä¸»é”®ç´¢å¼•ä¸­ï¼Œå¶å­èŠ‚ç‚¹åŒ…å«äº†è¡¨ä¸­çš„æ‰€æœ‰å­—æ®µï¼Œå¯¹äºä¸€äº›å…¨è¡¨æ‰«æçš„æŸ¥è¯¢æ¥è¯´ï¼Œç›´æ¥æ‰«æå¶å­èŠ‚ç‚¹ä¾¿å¯ä»¥å¾—åˆ°æ•°æ®ï¼Œä¸ç”¨å†ä»ç´¢å¼•æ ‘ä¸ŠæŒ¨ä¸ªæŸ¥æ‰¾\nå¶å­èŠ‚ç‚¹ç›´æ¥åŒ…å«åŒå‘æŒ‡é’ˆ,èŒƒå›´æŸ¥æ‰¾æ•ˆç‡é«˜ å¯¹äºä¸€äº›èŒƒå›´æŸ¥è¯¢æ¯”å¦‚ id \u0026gt; 20 and id \u0026lt; 50, åœ¨ç´¢å¼•æ ‘ä¸Šå®šä½åˆ° 20 ä¹‹åç›´æ¥ä½¿ç”¨å³å‘æŒ‡é’ˆå®šä½åˆ°ä¸‹ä¸€ä¸ªæ¯”20å¤§çš„æ•°æ®ï¼Œä¾æ¬¡å¾€ä¸‹ï¼Œç›´åˆ° 50ï¼Œä¾¿å¯ä»¥æ£€å‡ºè¯¥åŒºé—´çš„æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªæŒ‡é’ˆï¼Œï¼ˆB Treeï¼‰åˆ™éœ€è¦å†æ¬¡å›åˆ°ç´¢å¼•æ ‘ä¸­å»æŸ¥æ‰¾ , æå¤§çš„æé«˜äº†èŒƒå›´æŸ¥æ‰¾çš„æ€§èƒ½\nHash ç´¢å¼• hash ç´¢å¼•åŸç†å¦‚ä¸‹ï¼š\næ›´å¿« å¤§å¤šæƒ…å†µä¸‹ Hash ç´¢å¼•æ¯”B+ Tree ç´¢å¼•æ›´å¿«ï¼ŒHash è®¡ç®—çš„æ•ˆç‡éå¸¸é«˜ï¼Œä¸”ä»…éœ€ä¸€æ¬¡æŸ¥æ‰¾å°±å¯ä»¥å®šä½åˆ°æ•°æ®(æ— hashå†²çªçš„æƒ…å†µ)\nä¸æ”¯æŒèŒƒå›´æŸ¥è¯¢ å›¾ä¸­æœ‰äº›æ­§ä¹‰ï¼ŒHash åçš„å€¼æ˜¯æ²¡æœ‰é¡ºåºçš„ï¼Œä¹Ÿä¸æ˜¯æ•´æ•°ï¼Œæ‰€ä»¥æ— æ³•è¿›è¡Œé«˜æ•ˆçš„èŒƒå›´æŸ¥è¯¢æŸ¥è¯¢\nhash å†²çªé—®é¢˜ å¦‚æœåœ¨æŸåˆ—ä¸Šæœ‰å¾ˆå¤šç›¸åŒçš„è¡Œï¼Œæ¯”å¦‚ name å­—æ®µï¼Œå« å¼ ä¸‰çš„äººéå¸¸å¤šã€‚ä¼šäº§ç”Ÿå¾ˆå¤šæ¬¡hashå†²çªï¼Œåªèƒ½é€€åŒ–æˆåˆ—è¡¨æœç´¢äº†\nè¡¨å¼•æ“ æˆ‘ä»¬å¸¸è¯´çš„ MyISAM å¼•æ“ æˆ–è€… InnoDB å¼•æ“æ˜¯åŸºäºè¡¨çš„ï¼Œæ˜¯è¡¨çš„ä¸€ä¸ªå±æ€§ï¼Œ å¯ä¸æ˜¯åŸºäºæ•°æ®åº“çš„ï¼Œ åŒä¸€ä¸ªæ•°æ®åº“ä¸­å¯ä»¥æœ‰ä¸åŒå¼•æ“çš„è¡¨\nMyISAM å’Œ InnoDB å¼•æ“ ä¸åŒå¼•æ“çš„è¡¨åœ¨ç£ç›˜ä¸­äº§ç”Ÿçš„æ–‡ä»¶ä¹Ÿä¸ä¸€æ ·ï¼Œæ•°æ®åº“æ–‡ä»¶ä½ç½®é»˜è®¤åœ¨å®‰è£…ç›®å½•/data ä¸‹\nMyISAM å¼•æ“ frm: è¡¨ç»“æ„ç›¸å…³, frameï¼ˆæ¡†æ¶ï¼‰ ç¼©å†™` MYD: MyISAM Data è¡¨æ•°æ® MYI: MyISAM Index è¡¨ç´¢å¼• ç´¢å¼•ç»“æ„ä¸­çš„å¶å­èŠ‚ç‚¹çš„ data å­˜æ”¾çš„æ˜¯ æ•°æ®è¡Œçš„ä½ç½®ï¼ŒåŠè¿™ä¸€è¡Œåœ¨ MYD æ–‡ä»¶çš„ä½ç½®ï¼Œ è€Œä¸æ˜¯ç›´æ¥æ”¾çš„çœŸå®æ•°æ®\nInnoDB frm è¡¨ç»“æ„ä¿¡æ¯ ibd è¡¨æ•°æ®åŠ ç´¢å¼• è¡¨æ•°æ®ç»„ç»‡å½¢å¼ è¡¨ç»“æ„æœ¬èº«å°±æ˜¯æŒ‰ç…§ B+ Tree ç»“æ„å­˜å‚¨ï¼Œ å¶å­èŠ‚ç‚¹æ”¾çš„æ˜¯å‡ºç´¢å¼•åˆ—å…¶ä»–åˆ—çš„æ•°æ®\nèšé›†ä¸éèšé›†ç´¢å¼• èšé›†ç´¢å¼• (InnoDB ä¸»é”®ç´¢å¼•)\nå¶å­èŠ‚ç‚¹ç›´æ¥åŒ…å«æ•´è¡Œæ•°æ®\néèšé›†ç´¢å¼• (MyISAM ç´¢å¼•, InnoDB éä¸»é”®ç´¢å¼•)\nå¶å­èŠ‚ç‚¹ä¸åŒ…å«æ•´è¡Œæ•°æ®,åŒ…å«çš„æ˜¯å¯¹åº”è¡Œæ‰€åœ¨çš„ä½ç½®ï¼Œæˆ–è€…ä¸»é”®Id\nå•ä»ç´¢å¼•ç»“æ„çš„æ¥çœ‹ï¼Œèšé›†ç´¢å¼•çš„æŸ¥æ‰¾é€Ÿåº¦é«˜äºéèšé›†ç´¢å¼•\nInnoDB åªæœ‰ä¸€ä¸ªèšé›†ç´¢å¼•ï¼Œé»˜è®¤æ˜¯ä¸»é”®ç´¢å¼•ï¼Œ éä¸»é”®ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜æ”¾çš„æ˜¯ä¸»é”®çš„å€¼ï¼Œå¦‚ä¸‹å›¾\nè¿™æ ·åšçš„ç›®çš„æœ‰ä¸¤ä¸ªï¼š\nèŠ‚çº¦ç©ºé—´ï¼Œé¿å…å°†æ•´è¡Œçš„æ•°æ®å­˜æ”¾å¤šä»½ ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå¦åˆ™æ¯å¢åŠ ä¸€è¡Œï¼Œå¯¹åº”çš„æ¯ä¸ªç´¢å¼•éƒ½è¦ç»´æŠ¤ä¸€ä»½è¡Œæ•°æ®ã€‚å¿…é¡»è¦ç­‰åˆ°æ¯ä¸ªç´¢å¼•éƒ½æ›´æ–°å®Œï¼Œæ•°æ®æ‰èƒ½æ’å…¥æˆåŠŸ â˜…â˜…â˜… ä¸ºä»€ä¹ˆå»ºè®®InnoDB è¡¨å¿…é¡»æœ‰ä¸»é”®ï¼Œå¹¶ä¸”æ˜¯æ•´å‹è‡ªå¢çš„ï¼Ÿ InnoDB æ•´ä¸ªè¡¨çš„æ•°æ®å°±æ˜¯ç”¨B+ æ ‘ç»„ç»‡çš„ï¼Œå¦‚æœå­˜åœ¨ä¸»é”®ï¼Œå°±ç”¨ä¸»é”®ä¸ºç´¢å¼•ï¼Œå¶å­èŠ‚ç‚¹å­˜å‚¨è¡Œæ•°æ®\nå¦‚æœæ²¡æœ‰ä¸»é”®ï¼ŒInnoDB å°±ä¼šæ‰¾åˆ°ä¸€ä¸ªæ¯è¡Œæ•°æ®éƒ½ä¸ç›¸åŒçš„åˆ—ä½œä¸ºç´¢å¼•æ¥ç»„ç»‡æ•´ä¸ªè¡¨çš„æ•°æ®\nå¦‚æœæ²¡æœ‰æ‰¾åˆ°è¿™ç§åˆ—ï¼Œå°±ä¼šå»ºä¸€ä¸ªéšè—çš„åˆ—ï¼Œè‡ªåŠ¨ç»´æŠ¤å€¼ï¼Œç”¨è¿™ä¸ªéšè—çš„åˆ—æ¥ç»„ç»‡æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦ä¸»åŠ¨åšè¿™ç§å·¥ä½œå‡å°‘æ•°æ®åº“çš„è´Ÿæ‹…\nä¸ºä»€ä¹ˆæ˜¯æ•´å‹ å› ä¸ºåœ¨æŸ¥æ‰¾æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å¤šæ¬¡æ¯”è¾ƒå¤§å°ï¼Œæ•´å‹çš„æ¯”è¾ƒè¿ç®—é€Ÿåº¦å¤§äºå­—ç¬¦ä¸²ï¼Œ å¹¶ä¸”å ç”¨ç©ºé—´å°\nä¸ºä»€ä¹ˆæ˜¯è‡ªå¢ è¿™ä¸€ç‚¹æ¶‰åŠåˆ°B+ æ ‘çš„æ„å»ºï¼Œæˆ‘ä»¬çŸ¥é“ç´¢å¼•ä¸€ä¸ªæœ€é‡è¦çš„ç‰¹æ€§å°±æ˜¯æ’å¥½åº çš„ã€‚å¦‚æœæˆ‘ä»¬ä¸æ˜¯é¡ºåºæ’å…¥çš„ï¼Œé‚£ä¹ˆæ ‘å°±è¦è‡ªå·±é¢å¤–åšæ’åºï¼Œè°ƒæ•´æ ‘ç»“æ„ï¼Œæµªè´¹äº†æ€§èƒ½\né¿å…å¶å­èŠ‚ç‚¹çš„åˆ†è£‚ é¿å…B+ æ ‘åšå¹³è¡¡è°ƒæ•´ è”åˆç´¢å¼• è”åˆç´¢å¼•å’Œå•ç´¢å¼•å·®ä¸å¤šï¼Œåªä¸è¿‡æ˜¯å…ˆæŒ‰ç¬¬ä¸€ä¸ªå­—æ®µæ’åºï¼Œå†æŒ‰ç¬¬äºŒä¸ªå­—æ®µæ’åºï¼Œç„¶åå†æŒ‰ç¬¬ä¸‰ä¸ªå­—æ®µæ’åºã€‚\nè¿™ç§æ’åºè§„åˆ™è¡¨æ˜äº†åªæœ‰åœ¨ç¬¬ä¸€ä¸ªå­—æ®µç›¸ç­‰çš„æƒ…å†µä¸‹ï¼Œç¬¬äºŒå­—æ®µæ‰æ˜¯æœ‰åºçš„ã€‚ç¬¬äºŒå­—æ®µç›¸ç­‰çš„æƒ…å†µä¸‹ï¼Œç¬¬ä¸‰ä¸ªå­—æ®µæ‰æ˜¯æœ‰åºçš„ã€‚\næ‰€ä»¥ name = 'Bill' and age = 20 and position = 'dev' å¯ä»¥ç”¨åˆ°å…¨éƒ¨ç´¢å¼•ï¼Œ å› ä¸º name ç¡®å®šäº†ï¼Œage æ˜¯æœ‰åºçš„ï¼Œage å¯ä»¥èµ°ç´¢å¼•ï¼Œ age ç¡®å®šå position å¯ä»¥èµ°ç´¢å¼•ã€‚è¿™ä¸ªè”åˆç´¢å¼•å¯ä»¥å…¨éƒ¨ç”¨åˆ°\nå¦‚æœæ˜¯ name = 'Bill and age \u0026gt; 30 and position = 'dev'' , é¦–å…ˆname å¯ä»¥èµ°ç´¢å¼•ï¼Œname ç¡®å®šå age æ˜¯æœ‰åºçš„ï¼Œage ä¹Ÿå¯ä»¥èµ°ç´¢å¼•ï¼Œä½†æ˜¯ age \u0026gt; 30 å¯¼è‡´ age æŸ¥å‡ºæ¥çš„æ•°æ®æœ‰å¤šä¸ªï¼ˆ31 32ï¼‰, 31 å’Œ 32 ä¸‹çš„ position (dev admin ) ä¸æ˜¯æœ‰åºçš„ï¼Œä¾¿æ— æ³•åˆ©ç”¨äºŒåˆ†ç®—æ³•è¿›è¡ŒæŸ¥æ‰¾ã€‚æ‰€ä»¥æ— æ³•åˆ©ç”¨ position è¿™ä¸ªç´¢å¼•ï¼Œè¿™ä¹Ÿå°±æ˜¯å·¦å‰ç¼€æ³•åˆ™çš„åŸç†å’Œè”åˆç´¢å¼•å¤±æ•ˆçš„åŸç†\n","date":"2022-07-31T23:48:52Z","permalink":"https://dccmmtop.github.io/posts/%E7%B4%A2%E5%BC%95%E7%9A%84%E6%9C%AC%E8%B4%A8/","section":"posts","tags":["ç´¢å¼•","MySQL"],"title":"ç´¢å¼•çš„æœ¬è´¨"},{"categories":null,"contents":"éœ€æ±‚ æœ€è¿‘æƒ³å®ç°ä¸€ä¸ªè‡ªåŠ¨éƒ¨ç½²æƒŠå¤©åšå®¢çš„åŠŸèƒ½ï¼Œæˆ‘æœ‰ä¸€ä¸ªé™æ€åšå®¢é¡¹ç›®,æ˜¯ä½¿ç”¨hugoè¿›è¡Œç¼–è¯‘å’Œéƒ¨ç½²çš„ï¼Œä¹‹å‰è‡ªå·±å†™äº†ä¸€ä¸ªè„šæœ¬å°†å˜åŠ¨çš„åšå®¢è‡ªåŠ¨ç¼–è¯‘éƒ¨ç½²åˆ°github page ä¸Šï¼Œä¹Ÿä¸æ˜¯å¾ˆéº»çƒ¦ã€‚ä½†æ˜¯éœ€è¦åœ¨æœ¬æœºæ‰§è¡Œä¸€æ¬¡å‘½ä»¤ï¼Œæ²¡æœ‰å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œä»¥å‰äº†è§£è¿‡github actionçš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨æŸä¸ªåˆ†æ”¯æäº¤ä»£ç æ—¶è§¦å‘ä¸€ä¸ªä»»åŠ¡ï¼Œå¾ˆé€‚åˆæˆ‘è¿™ä¸ªåœºæ™¯ï¼Œä»Šå¤©æ¥å°è¯•ä¸€ä¸‹ã€‚\ngithub action å…¶å®å°±æ˜¯è®¾ç½®ä¸€ä¸ªè§¦å‘æ¡ä»¶ï¼Œç„¶ågithubæä¾›ä¸€ä¸ªè¿è¡Œç¯å¢ƒå»æ‰§è¡Œæˆ‘ä»¬å®ç°å®šä¹‰å¥½çš„ç¨‹åºï¼Œæ¯æ¬¡æ‰§è¡Œè¿™ä¸ªä»»åŠ¡æ—¶ï¼Œæ‰€ç»™çš„ç¯å¢ƒéƒ½æ˜¯å´­æ–°çš„ï¼Œä¸ä¿å­˜æ•°æ®ã€‚å¹¶ä¸”ä»»åŠ¡çš„æ‰§è¡Œæ—¶é•¿å’Œä¸€å¤©å†…çš„ä»»åŠ¡æ‰§è¡Œæ¬¡æ•°æ˜¯æœ‰é™åˆ¶çš„ã€‚ä¸ç„¶æ—©å°±è¢«è–…ç§ƒäº†ã€‚\næˆ‘çš„éœ€æ±‚æ˜¯ï¼Œå½“æˆ‘åœ¨åšå®¢é¡¹ç›®main åˆ†æ”¯ æ¨é€ä»£ç æ—¶ï¼Œè§¦å‘github action æ‰§è¡Œ hugo --minify å°†markdown æ–‡ä»¶ç¼–è¯‘æˆé™æ€çš„ html æ–‡ä»¶ï¼Œç„¶åæ¨é€åˆ°æˆ‘çš„github page ä¸Šï¼Œå®Œæˆéƒ¨ç½²ã€‚é”æ‰§è¡Œçš„ä»»åŠ¡å°±åªæœ‰ä¸‰æ­¥â€”â€”ä¸‹è½½ä»£ç ï¼Œç¼–è¯‘å’Œéƒ¨ç½²ã€‚\nå…ˆè¯´ç¼–è¯‘ï¼Œè¿™ä¸€æ­¥æ˜¯éœ€è¦ç”¨åˆ°hugoå‘½ä»¤çš„ï¼Œgithub action ç»™æˆ‘ä»¬æä¾›çš„ç¯å¢ƒè‚¯å®šæ—¶æ²¡æœ‰è¿™ä¸ªå‘½ä»¤çš„ï¼Œæˆ‘ä»¬éœ€è¦ä¸‹è½½å®‰è£…ï¼Œéå¸¸æ£’çš„æ˜¯ï¼Œgithub æ”¶å½•äº†å¼€å‘è€…å·²ç»å†™å¥½çš„ action ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨å°±å¥½äº†ï¼Œè¿™ä¸ªä»“åº“ä¸­å°±æœ‰ hugo ç›¸å…³çš„actionâ€”â€” peaceiris/actions-hugo@v2\nåŒç†ï¼Œ éƒ¨ç½²æ­¥éª¤ä¹Ÿæœ‰äººæä¾›äº†å¯¹åº”çš„actionï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ç›´æ¥æ‹¿æ¥ç”¨å°±å¥½äº†ã€‚â€”â€” peaceiris/actions-gh-pages@v3\nç¼–è¯‘ä¹‹å‰å…¶å®è¿˜æœ‰ä¸€æ­¥ï¼Œé‚£å°±æ˜¯ä¸‹è½½ä»£ç ï¼Œåœ¨ä¸€ä¸ªå…¨æ–°çš„ç¯å¢ƒä¸­ï¼Œå¦‚æœæ²¡æœ‰ä»£ç ï¼Œéš¾é“è¦ç¼–è¯‘ç©ºæ°”ï¼Ÿä¸‹è½½ä»£ç è‚¯å®šç¦»ä¸å¼€ git å·¥å…·ï¼Œéš¾é“è¦æˆ‘ä»¬è‡ªå·±è£…ä¸€ä¸ª git ? è¿™å€’ä¸ç”¨è‡ªå·±åšï¼Œä¹Ÿæœ‰ç°æˆçš„ action â€”â€” actions/checkout@v2\nå®ç° æˆ‘ä»¬çš„éœ€æ±‚å’Œæ­¥éª¤å·²ç»æ¢³ç†å®Œäº†ï¼Œä¸‹é¢çœ‹æ€ä¹ˆæ“ä½œå§\nåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»º .github/workflows/pages.yml æ–‡ä»¶ï¼Œ å…¶ä¸­ yml æ–‡ä»¶æ˜¯å¯ä»¥éšæ„å‘½åçš„ï¼Œä½†è·¯å¾„æ˜¯å›ºå®šçš„ã€‚ ç¼–å†™page.yml name: dcblog_action # åå­— on: # è§¦å‘æ¡ä»¶ push: # æœ‰æ¨é€åŠ¨ä½œæ—¶è§¦å‘ branchesjkj: - main # è¿™é‡Œçš„æ„æ€æ˜¯å½“ mainåˆ†æ”¯å‘ç”Ÿpushçš„æ—¶å€™ï¼Œè¿è¡Œä¸‹é¢çš„jobs jobs: # è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¯ä»¥æ—¶å¤šä¸ª deploy: # ä»»åŠ¡å runs-on: ubuntu-18.04 # åœ¨ä»€ä¹ˆç¯å¢ƒè¿è¡Œä»»åŠ¡ steps: - uses: actions/checkout@v2 # å¼•ç”¨actions/checkoutè¿™ä¸ªactionï¼Œä¸æ‰€åœ¨çš„githubä»“åº“åŒå with: submodules: true # Fetch Hugo themes (true OR recursive) è·å–submoduleä¸»é¢˜ fetch-depth: 0 # Fetch all history for .GitInfo and .Lastmod - name: Setup Hugo # æ­¥éª¤åè‡ªå– uses: peaceiris/actions-hugo@v2 # hugoå®˜æ–¹æä¾›çš„actionï¼Œç”¨äºåœ¨ä»»åŠ¡ç¯å¢ƒä¸­è·å–hugo with: hugo-version: \u0026#39;latest\u0026#39; # è·å–æœ€æ–°ç‰ˆæœ¬çš„hugo - name: Build run: hugo --minify # ä½¿ç”¨hugoæ„å»ºé™æ€ç½‘é¡µ - name: Deploy uses: peaceiris/actions-gh-pages@v3 # ä¸€ä¸ªè‡ªåŠ¨å‘å¸ƒgithub pagesçš„action with: external_repository: dccmmtop/dccmmtop.github.io # å‘å¸ƒåˆ°å“ªä¸ªrepo personal_token: xxxx # å‘å¸ƒåˆ°å…¶ä»–repoéœ€è¦æä¾›ä¸Šé¢ç”Ÿæˆçš„personal access token publish_dir: ./public # æ³¨æ„è¿™é‡ŒæŒ‡çš„æ˜¯è¦å‘å¸ƒå“ªä¸ªæ–‡ä»¶å¤¹çš„å†…å®¹ï¼Œè€Œä¸æ˜¯æŒ‡å‘å¸ƒåˆ°ç›®çš„ä»“åº“çš„ä»€ä¹ˆä½ç½®ï¼Œå› ä¸ºhugoé»˜è®¤ç”Ÿæˆé™æ€ç½‘é¡µåˆ°publicæ–‡ä»¶å¤¹ï¼Œæ‰€ä»¥è¿™é‡Œå‘å¸ƒpublicæ–‡ä»¶å¤¹é‡Œçš„å†…å®¹ publish_branch: master # å‘å¸ƒåˆ°å“ªä¸ªbranch personal_token å¯ä»¥å»ä½ çš„github setting ä¸­è·å–,è®°å¾—ä¿å¯†.\néªŒè¯ ä¸‹é¢åœ¨main åˆ†æ”¯ä¸Šæ¨é€ä¸€æ¬¡ä»£ç ï¼Œå¯ä»¥åœ¨github action æ ‡ç­¾é¡µä¸‹çœ‹åˆ°action è¿è¡ŒæˆåŠŸçš„æ ‡è¯†ï¼Œä»¥åŠæ—¥å¿—:\n","date":"2022-07-30T23:01:00Z","permalink":"https://dccmmtop.github.io/posts/github_action%E4%BD%BF%E7%94%A8/","section":"posts","tags":["git"],"title":"github_Actionä½¿ç”¨"},{"categories":null,"contents":"æ•°å­—æ€§å¾ªç¯ #!/bin/bash for((i=1;i\u0026lt;=10;i++)); do echo $(expr $i \\* 3 + 1); done #!/bin/bash for i in $(seq 1 10) do echo $(expr $i \\* 3 + 1); done #!/bin/bash for i in {1..10} do echo $(expr $i \\* 3 + 1); done #!/bin/bash awk \u0026#39;BEGIN{for(i=1; i\u0026lt;=10; i++) print i}\u0026#39; å­—ç¬¦æ€§å¾ªç¯ #!/bin/bash for i in `ls`; do echo $i is file name\\! ; done #!/bin/bash for i in $* ; do echo $i is input chart\\! ; done #!/bin/bash for i in f1 f2 f3 ; do echo $i is appoint ; done #!/bin/bash list=\u0026#34;rootfs usr data data2\u0026#34; for i in $list; do echo $i is appoint ; done è·¯å¾„æŸ¥æ‰¾ #!/bin/bash for file in /proc/*; do echo $file is file path \\! ; done #!/bin/bash for file in $(ls *.sh) do echo $file is file path \\! ; done ç°åœ¨ä¸€èˆ¬éƒ½ä½¿ç”¨for inç»“æ„ï¼Œfor inç»“æ„åé¢å¯ä»¥ä½¿ç”¨å‡½æ•°æ¥æ„é€ èŒƒå›´ï¼Œæ¯”å¦‚$()ã€``è¿™äº›ï¼Œé‡Œé¢å†™ä¸€äº›æŸ¥æ‰¾çš„è¯­æ³•ï¼Œæ¯”å¦‚ls test*ï¼Œé‚£ä¹ˆéå†ä¹‹åå°±æ˜¯è¾“å‡ºæ–‡ä»¶åäº†ã€‚\n","date":"2022-07-28T18:26:36Z","permalink":"https://dccmmtop.github.io/posts/linux%E4%B8%8B%E7%9A%84%E5%BE%AA%E7%8E%AF/","section":"posts","tags":["linux"],"title":"Linuxä¸‹çš„å¾ªç¯"},{"categories":null,"contents":"package main import ( \u0026#34;bufio\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;io\u0026#34; \u0026#34;os\u0026#34; ) func main() { filename := \u0026#34;./1.txt\u0026#34; f, err := os.Open(filename) if err != nil { fmt.Printf(\u0026#34;read %s fail, err: %v\\n\u0026#34;, filename, err) } defer f.Close() reader := bufio.NewReader(f) for { line, _, err := reader.ReadLine() if err == io.EOF { fmt.Println(\u0026#34;done!\u0026#34;) break } fmt.Println(line) // TODO } } ","date":"2022-07-28T09:03:18Z","permalink":"https://dccmmtop.github.io/posts/go%E9%80%90%E8%A1%8C%E8%AF%BB%E5%8F%96%E6%96%87%E4%BB%B6/","section":"posts","tags":["go"],"title":"Goé€è¡Œè¯»å–æ–‡ä»¶"},{"categories":null,"contents":"package model import ( \u0026#34;os\u0026#34; \u0026#34;go.uber.org/zap\u0026#34; \u0026#34;go.uber.org/zap/zapcore\u0026#34; ) func InitLogger(level string) *zap.SugaredLogger { encoder := getEncoder() // åŒæ—¶è¾“å‡ºåˆ°æ–‡ä»¶å’Œæ§åˆ¶å° core := zapcore.NewTee( zapcore.NewCore(encoder, stdWriter(), getLogLevel(level)), zapcore.NewCore(encoder, fileWriter(), getLogLevel(level)), ) return zap.New(core, zap.AddCaller()).Sugar() } func getLogLevel(level string) zapcore.LevelEnabler { switch level { case \u0026#34;DEBUG\u0026#34;: return zapcore.DebugLevel case \u0026#34;INFO\u0026#34;: return zapcore.InfoLevel case \u0026#34;WARN\u0026#34;: return zapcore.WarnLevel case \u0026#34;ERROR\u0026#34;: return zapcore.ErrorLevel default: return zapcore.InfoLevel } } func getEncoder() zapcore.Encoder { encoderConfig := zap.NewProductionEncoderConfig() encoderConfig.EncodeTime = zapcore.ISO8601TimeEncoder encoderConfig.EncodeLevel = zapcore.CapitalColorLevelEncoder return zapcore.NewConsoleEncoder(encoderConfig) } func stdWriter() zapcore.WriteSyncer { return zapcore.AddSync(os.Stdout) } func fileWriter() zapcore.WriteSyncer { file, _ := os.Create(fmt.Sprintf(\u0026#34;./%d_log_name.log\u0026#34;, time.Now().Unix())) return zapcore.AddSync(file) } ","date":"2022-07-27T09:17:52Z","permalink":"https://dccmmtop.github.io/posts/zap%E5%8C%85%E4%BD%BF%E7%94%A8/","section":"posts","tags":["zap","log","go"],"title":"zapåŒ…ä½¿ç”¨"},{"categories":null,"contents":"æ¯ä¸ªRabbitMQ èŠ‚ç‚¹åªæœ‰ä¸¤ç§ç±»å‹ï¼Œè¦ä¹ˆæ˜¯å†…å­˜èŠ‚ç‚¹ï¼Œè¦ä¹ˆæ˜¯ç£ç›˜èŠ‚ç‚¹\nå†…å­˜èŠ‚ç‚¹ å†…å­˜èŠ‚ç‚¹å°†æ‰€æœ‰çš„é˜Ÿåˆ—ã€äº¤æ¢å™¨ã€ç»‘å®šã€ç”¨æˆ·ã€æƒé™å’Œvhostçš„å…ƒæ•°æ®å®šä¹‰éƒ½ä»…å­˜å‚¨åœ¨å†…å­˜ä¸­.\næ˜¾è€Œæ˜“è§ï¼Œå†…å­˜èŠ‚ç‚¹æ‹¥æœ‰æ›´å‡ºè‰²çš„æ€§èƒ½\nç£ç›˜èŠ‚ç‚¹ ç£ç›˜èŠ‚ç‚¹åˆ™å°†å…ƒæ•°æ®å­˜å‚¨åœ¨ç£ç›˜ä¸­,é‡å¯ä¹‹åï¼Œé˜Ÿåˆ—æ•°æ®ä»ç„¶å­˜åœ¨ã€‚ä½†æ˜¯é€Ÿåº¦è¿œè¿œè½åäºå†…å­˜èŠ‚ç‚¹ã€‚\nå•èŠ‚ç‚¹ç³»ç»Ÿåªå…è®¸ç£ç›˜ç±»å‹çš„èŠ‚ç‚¹ï¼›å¦åˆ™ï¼Œæ¯æ¬¡ä½ é‡å¯RabbitMQä¹‹åï¼Œæ‰€æœ‰å…³äºç³»ç»Ÿçš„é…ç½®ä¿¡æ¯éƒ½ä¼šä¸¢å¤±ã€‚\nå¦‚ä½•æŠ‰æ‹© å½“åœ¨é›†ç¾¤ä¸­å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢å™¨æˆ–è€…ç»‘å®šçš„æ—¶å€™ï¼Œè¿™äº›æ“ä½œä¼šç›´åˆ°æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹éƒ½æˆåŠŸæäº¤å…ƒæ•°æ®å˜æ›´åæ‰è¿”å›ã€‚å¯¹äºå†…å­˜èŠ‚ç‚¹æ¥è¯´ï¼Œè¿™æ„å‘³ç€å°†å˜æ›´å†™å…¥å†…å­˜ï¼›è€Œå¯¹äºç£ç›˜èŠ‚ç‚¹æ¥è¯´ï¼Œè¿™æ„å‘³ç€æ˜‚è´µçš„ç£ç›˜å†™å…¥æ“ä½œï¼Œç›´åˆ°å®Œæˆä¹‹åï¼ŒèŠ‚ç‚¹æ‰èƒ½è¯´ï¼šâ€œå®Œäº‹å„¿äº†ï¼â€å‡è®¾ä½ æœ‰äº”ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œå¹¶ä¸”æ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ç£ç›˜èŠ‚ç‚¹ï¼Œåˆ™ä½ å¿…é¡»å¾—ç­‰å¾…æ‰€æœ‰è¿™äº”ä¸ªèŠ‚ç‚¹å°†å…ƒæ•°æ®å†™å…¥ç£ç›˜åï¼Œé˜Ÿåˆ—å£°æ˜æ“ä½œæ‰èƒ½è¿”å›ã€‚\nä¸è¿‡åœ¨é›†ç¾¤ä¸­ï¼Œä½ å¯ä»¥é€‰æ‹©é…ç½®éƒ¨åˆ†èŠ‚ç‚¹ä¸ºå†…å­˜èŠ‚ç‚¹ã€‚ä¸ºä»€ä¹ˆä¼šæƒ³è¦é€‰æ‹©å°†å…ƒæ•°æ®ä»…å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Ÿå› ä¸ºå®ƒä½¿å¾—åƒé˜Ÿåˆ—å’Œäº¤æ¢å™¨å£°æ˜ä¹‹ç±»çš„æ“ä½œæ›´åŠ å¿«é€Ÿã€‚\nRabbitMQåªè¦æ±‚åœ¨é›†ç¾¤ä¸­è‡³å°‘æœ‰ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹ã€‚æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å¯ä»¥æ˜¯å†…å­˜èŠ‚ç‚¹ã€‚è®°ä½ï¼Œå½“èŠ‚ç‚¹åŠ å…¥æˆ–è€…ç¦»å¼€é›†ç¾¤æ—¶ï¼Œå®ƒä»¬å¿…é¡»è¦å°†è¯¥å˜æ›´é€šçŸ¥åˆ°è‡³å°‘ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹ã€‚\nå‡å¦‚é›†ç¾¤ä¸­åªæœ‰ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹ï¼Œä¸å·§çš„æ˜¯å®ƒæœ‰åˆšå¥½å´©æºƒäº†ã€‚é›†ç¾¤ä»ç„¶å¯ä»¥ä¿æŒè¿è¡Œï¼Œåˆ†å‘æ¶ˆæ¯ï¼Œä½†æ˜¯ä½ æ— æ³•åšä»»ä½•æ›´æ”¹ï¼ŒåŒ…æ‹¬ åˆ›å»ºé˜Ÿåˆ—ã€ åˆ›å»ºäº¤æ¢å™¨ã€ åˆ›å»ºç»‘å®šã€ æ·»åŠ ç”¨æˆ·ã€ æ›´æ”¹æƒé™ã€ æ·»åŠ æˆ–åˆ é™¤é›†ç¾¤èŠ‚ç‚¹ã€‚\nä¸ºäº†åº”å¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬é€šç”¨çš„åšæ³•æ˜¯â€œåŒæ´»â€ã€‚ è‡³å°‘è®¾ç½®ä¸¤ä¸ªç£ç›˜èŠ‚ç‚¹ï¼Œä¿è¯åœ¨ä»»ä½•æ—¶å€™éƒ½å¯ä»¥ä¿å­˜å…ƒæ•°æ®çš„å˜æ›´ã€‚é™¤éä½ çš„æ‰€æœ‰ç£ç›˜èŠ‚ç‚¹éƒ½æŒ‚äº†ã€‚\nå½“å†…å­˜èŠ‚ç‚¹é‡å¯åï¼Œå®ƒä»¬ä¼šè¿æ¥åˆ°é¢„å…ˆé…ç½®çš„ç£ç›˜èŠ‚ç‚¹ï¼Œä¸‹è½½å½“å‰é›†ç¾¤å…ƒæ•°æ®æ‹·è´ã€‚æ‰€ä»¥å½“æ·»åŠ å†…å­˜èŠ‚ç‚¹æ—¶ï¼Œç¡®ä¿å‘ŠçŸ¥å…¶æ‰€æœ‰çš„ç£ç›˜èŠ‚ç‚¹ï¼ˆå†…å­˜èŠ‚ç‚¹å”¯ä¸€å­˜å‚¨åˆ°ç£ç›˜çš„å…ƒæ•°æ®ä¿¡æ¯æ˜¯é›†ç¾¤ä¸­ç£ç›˜èŠ‚ç‚¹çš„åœ°å€ï¼‰ã€‚åªè¦å†…å­˜èŠ‚ç‚¹å¯ä»¥æ‰¾åˆ°è‡³å°‘ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ƒå°±èƒ½åœ¨é‡å¯åé‡æ–°åŠ å…¥é›†ç¾¤ã€‚\n","date":"2022-07-07T23:08:21Z","permalink":"https://dccmmtop.github.io/posts/rabbitmq%E4%B8%AD%E7%9A%84%E5%86%85%E5%AD%98%E8%8A%82%E7%82%B9%E4%B8%8E%E7%A3%81%E7%9B%98%E8%8A%82%E7%82%B9/","section":"posts","tags":["rabbitMQ"],"title":"RabbitMQä¸­çš„å†…å­˜èŠ‚ç‚¹ä¸ç£ç›˜èŠ‚ç‚¹"},{"categories":null,"contents":"äº¤æ¢å™¨ä¸åƒé˜Ÿåˆ—é‚£æ ·æœ‰çœŸå®çš„è¿›ç¨‹ï¼Œ å®ƒåªæ˜¯ä¸€å¼ åç§°ä¸é˜Ÿåˆ—è¿›ç¨‹PIDçš„å…³ç³»è¡¨\nå½“ä½ å°†æ¶ˆæ¯å‘å¸ƒåˆ°äº¤æ¢å™¨æ—¶ï¼Œå®é™…ä¸Šæ˜¯ç”±ä½ æ‰€è¿æ¥åˆ°çš„ä¿¡é“å°†æ¶ˆæ¯ä¸Šçš„è·¯ç”±é”®åŒäº¤æ¢å™¨çš„ç»‘å®šåˆ—è¡¨è¿›è¡Œæ¯”è¾ƒï¼Œç„¶åè·¯ç”±æ¶ˆæ¯ã€‚æ­£æ˜¯ä¿¡é“ï¼ˆchannelï¼‰æŒ‰ç…§ç»‘å®šåŒ¹é…çš„ç»“æœï¼Œå°†æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—ã€‚ ä¿¡é“æ‰æ˜¯çœŸæ­£çš„è·¯ç”±å™¨\nç”±äºäº¤æ¢å™¨åªæ˜¯ä¸€å¼ è¡¨ï¼Œå› æ­¤å°†äº¤æ¢å™¨åœ¨æ•´ä¸ªé›†ç¾¤ä¸­è¿›è¡Œå¤åˆ¶ï¼Œæ›´åŠ ç®€å•\nä¸¾ä¾‹æ¥è¯´ï¼Œå½“åˆ›å»ºä¸€ä¸ªæ–°çš„äº¤æ¢å™¨æ—¶ï¼ŒRabbitMQæ‰€è¦åšçš„æ˜¯å°†æŸ¥è¯¢è¡¨æ·»åŠ åˆ°é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Šã€‚è¿™æ—¶ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„æ¯æ¡ä¿¡é“éƒ½å¯ä»¥è®¿é—®åˆ°æ–°çš„äº¤æ¢å™¨äº†ã€‚å› æ­¤ï¼Œç›¸å¯¹äºé»˜è®¤æƒ…å†µä¸‹é˜Ÿåˆ—çš„å®Œæ•´ä¿¡æ¯å­˜åœ¨äºé›†ç¾¤ä¸­çš„å•ä¸€èŠ‚ç‚¹æ¥è¯´ï¼Œé›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹æ‹¥æœ‰æ¯ä¸ªäº¤æ¢å™¨çš„æ‰€æœ‰ä¿¡æ¯ã€‚å°±å¯ç”¨æ€§æ¥è®²ï¼Œè¿™éå¸¸æ£’ï¼Œå› ä¸ºè¿™æ„å‘³ç€ä½ ä¸ç”¨æ‹…å¿ƒåœ¨èŠ‚ç‚¹æ•…éšœæ—¶é‡æ–°å£°æ˜äº¤æ¢å™¨ã€‚åªéœ€è®©æ•…éšœèŠ‚ç‚¹ä¸Šçš„ç”Ÿäº§è€…é‡æ–°è¿æ¥åˆ°é›†ç¾¤ä¸Šï¼Œå®ƒä»¬ç«‹å³å°±èƒ½å¼€å§‹å¾€äº¤æ¢å™¨ä¸Šå‘å¸ƒæ¶ˆæ¯äº†ã€‚\næ¶ˆæ¯ä¸¢å¤± é‚£ä¹ˆå½“æ¶ˆæ¯å·²ç»å‘å¸ƒåˆ°ä¿¡é“ä¸Šï¼Œä½†åœ¨è·¯ç”±å®Œæˆä¹‹å‰èŠ‚ç‚¹å‘ç”Ÿæ•…éšœçš„è¯ï¼Œè¿™äº›æ¶ˆæ¯ä¼šæ€æ ·å‘¢ï¼Ÿ\nAMQPçš„basic.publishå‘½ä»¤ä¸ä¼šè¿”å›æ¶ˆæ¯çš„çŠ¶æ€ã€‚è¿™æ„å‘³ç€å½“ä¿¡é“èŠ‚ç‚¹å´©æºƒæ—¶ä¿¡é“å¯èƒ½ä»ç„¶åœ¨è·¯ç”±æ¶ˆæ¯ï¼Œè€Œç”Ÿäº§è€…å·²ç»ç»§ç»­åˆ›å»ºä¸‹ä¸€æ¡æ¶ˆæ¯äº†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å°†æ‰¿å—ä¸¢å¤±æ¶ˆæ¯çš„é£é™©ã€‚\n","date":"2022-07-07T22:58:26Z","permalink":"https://dccmmtop.github.io/posts/rabbitmq%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%9A%84%E4%BA%A4%E6%8D%A2%E5%99%A8/","section":"posts","tags":["rabbitMQ"],"title":"RabbitMQé›†ç¾¤ä¸­çš„äº¤æ¢å™¨"},{"categories":null,"contents":"ä»ç›´è§‰ä¸Šæ¥çœ‹,ä¸€è¯´åˆ°é›†ç¾¤ï¼Œæˆ‘ä»¬å°±è”æƒ³åˆ°é«˜å¯ç”¨ï¼Œä¸€ä¸ªèŠ‚ç‚¹å®•æœºäº†ï¼Œä¸ä¼šå½±å“æ•´ä½“æœåŠ¡ï¼Œå®¢æˆ·ç«¯ä¼šä»å…¶ä»–èŠ‚ç‚¹æ‹¿æ•°æ®ã€‚æ¯”å¦‚ ES, Redis, mongoDB ç­‰çš„é›†ç¾¤éƒ½æ˜¯ç¬¦åˆç›´è§‰çš„æ¶æ„ã€‚\nä½†æ˜¯ï¼Œäº‹æƒ…åˆ°äº†rabbitMQ è¿™é‡Œï¼Œå´å®Œå…¨ä¸ä¸€æ ·äº†ã€‚\nåœ¨å°†ä¸¤ä¸ªèŠ‚ç‚¹ç»„æˆé›†ç¾¤çš„é‚£ä¸€åˆ»ï¼Œäº‹æƒ…å‘ç”Ÿäº†å·¨å¤§çš„å˜åŒ–ï¼šä¸æ˜¯æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æœ‰æ‰€æœ‰é˜Ÿåˆ—çš„å®Œå…¨æ‹·è´ã€‚\nåœ¨å•ä¸€èŠ‚ç‚¹è®¾ç½®ä¸­ï¼Œæ‰€æœ‰å…³äºé˜Ÿåˆ—çš„ä¿¡æ¯ï¼ˆå…ƒæ•°æ®ã€çŠ¶æ€å’Œå†…å®¹ï¼‰éƒ½å®Œå…¨å­˜å‚¨åœ¨è¯¥èŠ‚ç‚¹ä¸Šã€‚ä½†æ˜¯å¦‚æœåœ¨é›†ç¾¤ä¸­åˆ›å»ºé˜Ÿåˆ—çš„è¯ï¼Œé›†ç¾¤åªä¼šåœ¨å•ä¸ªèŠ‚ç‚¹è€Œä¸æ˜¯åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šåˆ›å»ºå®Œæ•´çš„é˜Ÿåˆ—ä¿¡æ¯ï¼ˆå…ƒæ•°æ®ã€çŠ¶æ€ã€å†…å®¹ï¼‰ã€‚ç»“æœæ˜¯åªæœ‰é˜Ÿåˆ—çš„æ‰€æœ‰è€…èŠ‚ç‚¹çŸ¥é“æœ‰å…³é˜Ÿåˆ—çš„æ‰€æœ‰ä¿¡æ¯ã€‚æ‰€æœ‰å…¶ä»–éæ‰€æœ‰è€…èŠ‚ç‚¹åªçŸ¥é“é˜Ÿåˆ—çš„å…ƒæ•°æ®å’ŒæŒ‡å‘è¯¥é˜Ÿåˆ—å­˜åœ¨çš„é‚£ä¸ªèŠ‚ç‚¹çš„æŒ‡é’ˆã€‚å› æ­¤å½“é›†ç¾¤èŠ‚ç‚¹å´©æºƒæ—¶ï¼Œè¯¥èŠ‚ç‚¹çš„é˜Ÿåˆ—å’Œå…³è”çš„ç»‘å®šå°±éƒ½æ¶ˆå¤±äº†ã€‚é™„åŠ åœ¨é‚£äº›é˜Ÿåˆ—ä¸Šçš„æ¶ˆè´¹è€…ä¸¢å¤±äº†å…¶è®¢é˜…ä¿¡æ¯ï¼Œå¹¶ä¸”ä»»ä½•åŒ¹é…è¯¥é˜Ÿåˆ—ç»‘å®šä¿¡æ¯çš„æ–°æ¶ˆæ¯ä¹Ÿéƒ½ä¸¢å¤±äº†ã€‚\nå®•æœºåçš„é˜Ÿåˆ— ä¸è¦æ‹…å¿ƒï¼Œ èŠ‚ç‚¹å®•æœºåï¼Œæˆ‘ä»¬å¯ä»¥è®©æ¶ˆè´¹è€…é‡æ–°è¿æ¥åˆ°é›†ç¾¤ä¸­å¹¶é‡æ–°åˆ›å»ºQé˜Ÿåˆ—ï¼Œ å¦‚æœé˜Ÿåˆ—Qå†ä¸€å¼€å§‹å°±æ˜¯å†…å­˜çº§åˆ«çš„ï¼Œä¹Ÿå°±è¯´æˆ‘ä»¬å¯ä»¥æ‰¿å—èŠ‚ç‚¹å®•æœºåï¼Œé˜Ÿåˆ—å†…å®¹ä¸¢å¤±çš„é£é™©ï¼Œé‡æ–°åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„é˜Ÿåˆ—ä¹Ÿæ²¡æœ‰ä»€ä¹ˆä¸å¯ã€‚\nä½†æ˜¯å¦‚æœé˜Ÿåˆ—Qä¸€å¼€å§‹æ˜¯è¢«è®¾ç½®æˆäº†æŒä¹…åŒ–çš„å‘¢ï¼Ÿæˆ‘ä»¬å¸Œæœ›é˜Ÿåˆ—ä¸­çš„æ•°æ®æ›´å¯é ï¼Œä¸èƒ½é‡å¯èŠ‚ç‚¹å°±ä¸¢å¤±äº†ã€‚æ‰€ä»¥å¦‚æœå…è®¸é‡æ–°åˆ›å»ºé˜Ÿåˆ—ï¼Œä¸å°±æ˜¯æŠŠä¹‹å‰çš„Qé˜Ÿåˆ—ç»™è¦†ç›–äº†å—ï¼Ÿ rabbit å·²ç»è€ƒè™‘è¿™ç§æƒ…å†µï¼Œ æ‰€ä»¥åœ¨èŠ‚ç‚¹æ¢å¤ä¹‹å‰ï¼Œ ä¸å…è®¸åœ¨é›†ç¾¤ä¸­é‡æ–°å£°æ˜åŒåé˜Ÿåˆ—äº†ï¼Œ å¦‚æœéè¦è¿™ä¹ˆåšçš„è¯ï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ª 404 NOT_FOUND çš„é”™è¯¯ã€‚é™¤éå°†èŠ‚ç‚¹æ¢å¤ï¼Œè¿™ç§æœºåˆ¶ä¿è¯äº†æŒä¹…åŒ–çš„é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¸ä¼šä¸¢å¤±ã€‚\näº§ç”Ÿä¸Šé¢ç°è±¡çš„ â€œç½ªé­ç¥¸é¦–â€ å°±æ˜¯å› ä¸ºï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé˜Ÿåˆ—åªå­˜åœ¨å•ä¸€èŠ‚ç‚¹ä¸Šè€Œä¸æ˜¯æ¯ä¸ªèŠ‚ç‚¹ä¸¢å¤åˆ¶ä¸€ä»½å‘¢ï¼Ÿ\nrabbit è¿™æ ·è®¾è®¡è‚¯å®šæ—¶æœ‰é“ç†çš„å˜›ï¼ä½†æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ\nä¸€åˆ‡ä¸ºäº†æ€§èƒ½ ï¼ˆ1ï¼‰å­˜å‚¨ç©ºé—´â€”â€”å¦‚æœæ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹éƒ½æ‹¥æœ‰æ‰€æœ‰é˜Ÿåˆ—çš„å®Œæ•´æ‹·è´ï¼Œé‚£ä¹ˆæ·»åŠ æ–°çš„èŠ‚ç‚¹ä¸ä¼šç»™ä½ å¸¦æ¥æ›´å¤šå­˜å‚¨ç©ºé—´ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥å­˜å‚¨1GBçš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ·»åŠ ä¸¤ä¸ªèŠ‚ç‚¹åªä¼šç»™ä½ å¸¦æ¥ä¸¤ä¸ªä¸€æ¨¡ä¸€æ ·çš„1GBæ¶ˆæ¯çš„æ‹·è´ã€‚\nï¼ˆ2ï¼‰æ€§èƒ½â€”â€”æ¶ˆæ¯çš„å‘å¸ƒéœ€è¦å°†æ¶ˆæ¯å¤åˆ¶åˆ°æ¯ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹ã€‚å¯¹äºæŒä¹…åŒ–æ¶ˆæ¯æ¥è¯´ï¼Œæ¯ä¸€æ¡æ¶ˆæ¯éƒ½ä¼šè§¦å‘ç£ç›˜æ´»åŠ¨ã€‚æ¯æ¬¡æ–°å¢èŠ‚ç‚¹ï¼Œç½‘ç»œå’Œç£ç›˜è´Ÿè½½éƒ½ä¼šå¢åŠ ï¼Œæœ€ç»ˆåªèƒ½ä¿æŒé›†ç¾¤æ€§èƒ½çš„å¹³ç¨³ï¼ˆç”šè‡³æ›´ç³Ÿï¼‰ã€‚\né€šè¿‡è®¾ç½®é›†ç¾¤ä¸­çš„å”¯ä¸€èŠ‚ç‚¹æ¥è´Ÿè´£ä»»ä½•ç‰¹å®šé˜Ÿåˆ—ï¼Œåªæœ‰è¯¥è´Ÿè´£èŠ‚ç‚¹æ‰ä¼šå› é˜Ÿåˆ—æ¶ˆæ¯è€Œé­å—ç£ç›˜æ´»åŠ¨çš„å½±å“ã€‚æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹åªéœ€è¦å°†æ¥æ”¶åˆ°çš„è¯¥é˜Ÿåˆ—çš„æ¶ˆæ¯ä¼ é€’ç»™è¯¥é˜Ÿåˆ—çš„æ‰€æœ‰è€…èŠ‚ç‚¹ã€‚å› æ­¤ï¼Œå¾€Rabbité›†ç¾¤æ·»åŠ æ›´å¤šçš„èŠ‚ç‚¹æ„å‘³ç€ä½ å°†æ‹¥æœ‰æ›´å¤šçš„é˜Ÿåˆ—ï¼Œè¿™äº›æ–°å¢èŠ‚ç‚¹ä¸ºä½ å¸¦æ¥äº†æ€§èƒ½çš„æå‡ã€‚å½“è´Ÿè½½å¢åŠ æ—¶ï¼ŒRabbitMQé›†ç¾¤æ˜¯æ€§èƒ½æ‰©å±•çš„æœ€ä½³æ–¹æ¡ˆã€‚\n","date":"2022-07-07T00:22:11Z","permalink":"https://dccmmtop.github.io/posts/%E9%9B%86%E7%BE%A4%E4%B8%AD%E7%9A%84%E9%98%9F%E5%88%97/","section":"posts","tags":["rabbitMQ"],"title":"é›†ç¾¤ä¸­çš„é˜Ÿåˆ—"},{"categories":null,"contents":"æœ¬æ–‡é‡‡ç”¨docker-compose çš„æ–¹å¼éƒ¨ç½² rabbitMQé›†ç¾¤\ndocker-compose.yml version: \u0026#34;3\u0026#34; services: rabbitmq: restart: always container_name: rabbitMQ image: rabbitmq:3.7.7-management # æ³¨æ„ hostnameï¼ˆæœ¬åœ°åŸŸåï¼‰, rabbitMQé›†ç¾¤ä¹‹é—´çš„é€šä¿¡å°±æ˜¯é æ­¤å¯»å€çš„ã€‚ç‰©ç†æœºéƒ¨ç½²æ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨å›ºå®šIP hostname: rabbitmq environment: RABBITMQ_NODE_PORT: 5672 # æŒ‡å®šè™šæ‹Ÿä¸»æœºçš„åç§° RABBITMQ_DEFAULT_VHOST: my_vhost RABBITMQ_DEFAULT_USER: admin RABBITMQ_DEFAULT_PASS: admin # æŒ‡å®š erlang_cookie, é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹çš„å€¼å¿…é¡»ä¿æŒä¸€è‡´ï¼Œ erlang ä½¿ç”¨è¯¥å€¼ä½œä¸ºé€šä¿¡çš„å¯†é’¥ RABBITMQ_ERLANG_COOKIE: rabbitmq_erlang_cookie ports: - 15672:15672 volumes: - ./data/rabbit:/var/lib/rabbitmq - ./conf:/etc/rabbitmq rabbitmq1: restart: always container_name: rabbitMQ_1 image: rabbitmq:3.7.7-management hostname: rabbitmq1 environment: RABBITMQ_NODE_PORT: 5672 RABBITMQ_DEFAULT_VHOST: my_vhost RABBITMQ_DEFAULT_USER: admin RABBITMQ_DEFAULT_PASS: admin RABBITMQ_ERLANG_COOKIE: rabbitmq_erlang_cookie ports: - 15673:15672 volumes: - ./data/rabbit_1:/var/lib/rabbitmq - ./conf:/etc/rabbitmq rabbitmq2: restart: always container_name: rabbitMQ_2 image: rabbitmq:3.7.7-management hostname: rabbitmq2 environment: RABBITMQ_NODE_PORT: 5672 RABBITMQ_DEFAULT_VHOST: my_vhost RABBITMQ_DEFAULT_USER: admin RABBITMQ_DEFAULT_PASS: admin RABBITMQ_ERLANG_COOKIE: rabbitmq_erlang_cookie ports: - 15674:15672 volumes: - ./data/rabbit_2:/var/lib/rabbitmq - ./conf:/etc/rabbitmq é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´å¦‚ä½•é€šä¿¡ å¦‚ä¸Šé…ç½®æ‰€ç¤ºï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰åƒä¹‹å‰çš„æœåŠ¡é‚£æ ·ï¼Œä½¿ç”¨ link æ˜ç¡®çš„æ ‡è¯†ä¸å…¶ä»–æœåŠ¡çš„é“¾æ¥å…³ç³»ã€‚é‚£ä¹ˆè¿™æ˜¯å¦‚ä½•è®© 3 ä¸ªèŠ‚ç‚¹äº’ç›¸é€šä¿¡çš„å‘¢ï¼Ÿ\nåŸæ¥docker 1.0 ç‰ˆæœ¬ä¹‹åï¼Œä¼šå†…ç½®ä¸€ä¸ªåŸŸåæœåŠ¡å™¨ï¼Œå¯ä»¥è¿›å…¥å®¹å™¨å†…éƒ¨æŸ¥çœ‹ /etc/reslv.conf æ–‡ä»¶ï¼Œä¼šå‘ç° nameserver 127.0.0.11 é…ç½®ã€‚\nè¿™å°±æ˜¯é»˜è®¤åŸŸåè§£ææœåŠ¡å™¨çš„åœ°å€ã€‚æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº† hostname çš„å€¼,åœ¨å®¹å™¨å¯åŠ¨çš„æ—¶å€™ï¼Œå°±ä¼šå‘åŸŸåæœåŠ¡å™¨æ³¨å†Œä¿¡æ¯ï¼ŒåŸŸåæœåŠ¡å™¨ä¼šè®°åŸŸåä¸è¯¥æœºå™¨ipçš„å¯¹åº”å…³ç³»ï¼Œåé¢æˆ‘ä»¬åœ¨å®¹å™¨ä¸­ä½¿ç”¨ hostname å»è®¿é—®å…¶ä»–æœåŠ¡æ—¶ï¼Œä¾¿ä¼šé€šè¿‡åŸŸåæœåŠ¡å™¨æ‰¾åˆ°å¯¹åº”çš„IPæ˜¯ä»€ä¹ˆï¼Œä»è€Œè®¿é—®è¯¥æœåŠ¡\nç›®å½•ç»“æ„ å¦‚ä¸Šé…ç½®æ‰€ç¤ºï¼Œ åˆ†åˆ«ä½¿ç”¨ ./data/rabbit ./data/rabbit_1 ./data/rabbit_2 ä½œä¸ºæ¯ä¸ªèŠ‚ç‚¹çš„æ•°æ®å·\nä½¿ç”¨ ./conf ä½œä¸ºé…ç½®æ–‡ä»¶çš„å·\næ‰€ä»¥æœ‰å¦‚ä¸‹ç›®å½•ç»“æ„\nå…¶ä¸­ rabbitmq.conf é…ç½®å¦‚ä¸‹\nloopback_users.guest = false\rlisteners.tcp.default = 5672\rdefault_pass = admin\rdefault_user = admin\rdefault_vhost = my_vhost\rhipe_compile = false\rmanagement.listener.port = 15672\rmanagement.listener.ssl = false\r# ä¸‹é¢é…ç½®é’ˆå¯¹ rabbitmq-mqtt æ’ä»¶, æ²¡æœ‰å¼€å¯mqttæ’ä»¶çš„ï¼Œå¿½ç•¥\rmqtt.default_user = mqtt_user\rmqtt.default_pass = Aa111111\rmqtt.allow_anonymous = true\rmqtt.vhost = my_vhost enabled_plugins é…ç½®å¦‚ä¸‹\n[rabbitmq_management,rabbitmq_mqtt,rabbitmq_web_mqtt]. å¼€å¯äº† web ç«¯ç®¡ç†ç•Œé¢ï¼Œmqtt ã€ mqtt_web æ’ä»¶\nå¯åŠ¨å®¹å™¨ æ£€æŸ¥é…ç½®æ­£ç¡®åï¼Œå¯åŠ¨å®¹å™¨\ndocker-compose up -d é›†ç¾¤é…ç½® å¯ä»¥åˆ†åˆ«è¿›å…¥ä¸‰ä¸ªå®¹å™¨å†…éƒ¨æ£€æŸ¥å®¹å™¨æ—¥å¿—ï¼Œç¡®å®šå…¨éƒ¨å¯åŠ¨æˆåŠŸåï¼Œè¿›å…¥ rabbitMQ_1 å®¹å™¨ä¸­ï¼Œæ‰§è¡Œ\nrabbitmqctl stop_app è¯¥å‘½ä»¤ä¼šåœæ­¢å½“å‰å®¹å™¨ä¸­çš„rabbitMQ æœåŠ¡ï¼ŒrabbitMQ æ˜¯ä½¿ç”¨ erlang è¯­è¨€ç¼–å†™çš„ï¼Œ rabbitMQ è‡ªç„¶è¦è¿è¡Œåœ¨ erlang è™šæ‹Ÿä¸­ï¼Œå°±åƒ java class è¿è¡Œåœ¨ jvm è™šæ‹Ÿæœºä¸­ä¸€æ ·çš„é“ç†ã€‚ æ‰€ä»¥ä¸Šé¢çš„å‘½ä»¤åªæ˜¯åœæ­¢ rabbitMQæœåŠ¡ï¼Œerlang è™šæ‹Ÿæœºä»ç„¶åœ¨è¿è¡Œç€ã€‚\nç°åœ¨æˆ‘ä»¬å°† rabbitMQ ä½œä¸ºä¸»èŠ‚ç‚¹ï¼Œ rabbitMQ_1, rabbitMQ_2 ä½œä¸ºä»èŠ‚ç‚¹ï¼ŒæŠŠ rabbtitMQ_1 åŠ å…¥ rabbitMQ ä¸­:\nrabbitmqctl join_cluster rabbit@rabbitmq # rabbitmq å°±æ˜¯ä½ çš„åŸŸåæˆ–ipåœ°å€, å‰é¢çš„ rabbit@ æ˜¯å›ºå®šå†™æ³• ç­‰å¾…å‘½ä»¤æˆåŠŸæ‰§è¡Œåï¼Œå†æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¯åŠ¨ rabbit æœåŠ¡\nrabbitmqctl start_app ç„¶åå¯ä»¥æ‰§è¡Œ rabbitmqctl cluser_status æŸ¥çœ‹èŠ‚ç‚¹è¿è¡ŒçŠ¶æ€ï¼Œ rabbitMQ_2 å®¹å™¨ä¸­é‡å¤ä¸Šè¿°æ­¥éª¤å³å¯\né›†ç¾¤çŠ¶æ€å¦‚ä¸‹:\nå¯ä»¥çœ‹åˆ°é›†ç¾¤ä¸­å·²ç»ç”±ä¸‰ä¸ªç£ç›˜èŠ‚ç‚¹äº†ã€‚\nè‡³äºä¸ºä»€ä¹ˆå«ç£ç›˜èŠ‚ç‚¹ï¼Œå…ˆæŒ‰ä¸‹ä¸è¡¨ï¼Œä¸‹ç¯‡æ–‡ç« å†æ¢è®¨ï¼Œ ä¸‹é¢æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å¦‚ä½•è®©ä¸€ä¸ªèŠ‚ç‚¹ä»é›†ç¾¤ä¸­å…¨èº«è€Œé€€ã€‚\né€€å‡ºé›†ç¾¤ åœ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå³å¯å®‰å…¨çš„è®©èŠ‚ç‚¹é€€å‡ºé›†ç¾¤\nrabbitmqctl stop_app rabbitmqctl reset rabbitmqctl start_app è¿™é‡Œçš„å…³é”®å‘½ä»¤æ˜¯ rabbitmqctl reset, æ­¤å‘½ä»¤æ¸…ç©ºèŠ‚ç‚¹çŠ¶æ€ï¼Œå¹¶å°†å…¶æ¢å¤åˆ°ç©ºç™½çŠ¶æ€ï¼Œæ‰§è¡Œæ­¤å‘½ä»¤æ—¶ï¼ŒèŠ‚ç‚¹ä¼šå’Œé›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹é€šä¿¡ï¼Œå‘Šè¯‰å®ƒä»¬ï¼Œæˆ‘é©¬ä¸Šè¦é€€å‡ºé›†ç¾¤äº†ï¼Œè¿™ä¸€æ­¥éå¸¸é‡è¦ï¼Œä¸ç„¶å…¶ä»–èŠ‚ç‚¹ä»¥ä¸ºå½“å‰èŠ‚ç‚¹æ˜¯å› ä¸ºæ•…éšœè€Œæ–­å¼€çš„ï¼Œå¹¶æœŸæœ›æŸä¸€å¤©ä¸€å®šä¼šå†å›æ¥çš„ï¼ŒåŒæ—¶é˜»æ­¢å…¶ä»–æ–°çš„èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼Œç›´åˆ°è¯¥èŠ‚ç‚¹æ¢å¤ã€‚ æ‰€ä»¥å½“è¦ç¦»å¼€é›†ç¾¤æ—¶ï¼ŒåŠ¡å¿…å…ˆè¦é‡è®¾èŠ‚ç‚¹çŠ¶æ€!!!\nå¦‚ä¸‹:\nä»é›†ç¾¤ç§»é™¤åï¼Œå¯ä»¥çœ‹åˆ°è¯¥èŠ‚ç‚¹å·²ç»ç§°ä¸ºç‹¬ç«‹èŠ‚ç‚¹äº†ã€‚\n","date":"2022-07-04T22:27:10Z","permalink":"https://dccmmtop.github.io/posts/rabbitmq%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/","section":"posts","tags":["rabbitMQ"],"title":"RabbitMQé›†ç¾¤éƒ¨ç½²"},{"categories":null,"contents":"ç”Ÿäº§è€…åœ¨æŸä¸ªé˜Ÿåˆ—ä¸Šç­‰å¾…æ¶ˆè´¹è€…è¿”å›çš„æ¶ˆæ¯ï¼Œ è¿™ä¸ªé˜Ÿåˆ—è¢«ç§°ä¸ºåº”ç­”é˜Ÿåˆ—,RabbitMQ å¤©ç”Ÿæ”¯æŒåº”ç­”é˜Ÿåˆ—çš„æœºåˆ¶ã€‚\nä»€ä¹ˆæ—¶å€™éœ€è¦åº”ç­”é˜Ÿåˆ— å½“ä¸€æ¡æ¶ˆæ¯è¢«æ¶ˆè´¹è€…å¤„ç†åï¼Œéœ€è¦å‘ŠçŸ¥ç”Ÿäº§è€…ä¸€äº›ä¿¡æ¯æ—¶ï¼Œæ¶ˆè´¹è€…å°±éœ€è¦åœ¨åº”ç­”é˜Ÿåˆ—ä¸Šå‘å¸ƒä¸€æ¡åº”ç­”æ¶ˆæ¯ã€‚å½“åº”ç­”æ¶ˆæ¯è¢«ç”Ÿäº§è€…å¤„ç†åï¼Œåº”ç­”é˜Ÿåˆ—å°±åº”è¯¥è¢«åˆ é™¤\nè¿™æ—¶ï¼Œç”Ÿäº§è€…å°±åƒå®¢æˆ·ç«¯çš„è§’è‰²ï¼Œè€Œæ¶ˆè´¹è€…å°±åƒæœåŠ¡å™¨çš„è§’è‰²ã€‚ç”±æ­¤å¯çŸ¥ï¼Œåº”ç­”é˜Ÿåˆ—åº”è¯¥ä¸æ¶ˆæ¯ä¸€å¯¹ä¸€å­˜åœ¨ï¼Œå¹¶ä¸”é˜Ÿåˆ—åç§°å”¯ä¸€ï¼Œåº”ç­”æ¶ˆæ¯è¢«å¤„ç†åï¼Œé˜Ÿåˆ—å°±åº”è¯¥åˆ é™¤ã€‚å¾ˆæ£’çš„æ˜¯ï¼ŒRabbitMQçš„åŒ¿åé˜Ÿåˆ—å¾ˆå¥½çš„æ»¡è¶³äº†è¿™ä¸ªç‰¹æ€§.\nä¸Šä»£ç  å®¢æˆ·ç«¯ï¼ˆç”Ÿäº§è€…ï¼‰ æœåŠ¡ç«¯(æ¶ˆè´¹è€…) ä»ä¸Šä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œåˆ©ç”¨åº”ç­”é˜Ÿåˆ—æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥å®ç° HTTP æœåŠ¡å™¨çš„åŠŸèƒ½ï¼Œå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚ï¼Œ æœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼Œè¿”å›æ•°æ®ï¼Œå®¢æˆ·ç«¯å¤„ç†è¿”å›æ•°æ®\næˆ‘ä»¬çŸ¥é“ï¼ŒRabbitMQä¸­çš„é˜Ÿåˆ—è¦ç»‘å®šåˆ°äº¤æ¢å™¨ä¸Šï¼Œæ‰èƒ½é€šè¿‡è·¯ç”±å°†æ¶ˆæ¯æ­£ç¡®çš„æŠ•é€’åˆ°é˜Ÿåˆ—ä¸Šï¼Œä½†æ˜¯ä¸Šé¢çš„æœåŠ¡ç«¯å‘é€åº”ç­”æ¶ˆæ¯æ—¶ï¼Œå°†æ¶ˆæ¯å¤´ä¸­çš„åº”ç­”é˜Ÿåˆ—è®¾ç½®ä¸ºæ¶ˆæ¯çš„è·¯ç”±keyï¼Œå¹¶æ²¡æœ‰ç»‘å®šçš„åŠ¨ä½œï¼Œä¸ºä»€ä¹ˆä¹Ÿè¡Œå¾—é€šå‘¢ï¼Ÿ\nå…¶å®ï¼Œä¸åŒäºé€šè¿‡RabbitMQå‘å¸ƒçš„ä»»ä½•å…¶ä»–æ¶ˆæ¯ï¼Œè¿™é‡Œæ²¡æœ‰äº¤æ¢å™¨ã€‚è¿™æ˜¯å…³äºé€šè¿‡Rabbitæ¥å®ç°RPCé€šä¿¡çš„å”¯ä¸€ä¸¤å¤„ç‰¹åˆ«çš„åœ°æ–¹ï¼šä½¿ç”¨reply_toä½œä¸ºå‘å¸ƒåº”ç­”æ¶ˆæ¯çš„ç›®çš„åœ°ï¼ŒåŒæ—¶å‘å¸ƒçš„æ—¶å€™æ— é¡»æŒ‡å®šäº¤æ¢å™¨ã€‚\n","date":"2022-06-27T22:57:24Z","permalink":"https://dccmmtop.github.io/posts/%E5%BA%94%E7%AD%94%E9%98%9F%E5%88%97/","section":"posts","tags":["rabbitMQ"],"title":"RabbitMQåº”ç­”é˜Ÿåˆ—"},{"categories":null,"contents":"å®‰è£…powershell ä¸‹è½½åœ°å€\nå®‰è£…scoop æ‰“å¼€powershell æ‰§è¡Œ\nä¿®æ”¹ç­–ç•¥\nset-executionpolicy remotesigned -s cu å®‰è£…scoop\niex (new-object net.webclient).downloadstring('https://get.scoop.sh') è‡ªåŠ¨è¡¥å…¨ PSReadLine åœ¨ V5 æˆ–ä»¥ä¸Šç‰ˆæœ¬ä¸­è‡ªå¸¦\nå‘½ä»¤ $profile å¯è§çœ‹è§é…ç½®æ–‡ä»¶çš„è·¯å¾„ï¼Œå¦‚æœæ²¡æœ‰æ­¤æ–‡ä»¶ï¼Œæ–°å»ºå³å¯\næ‰“é…ç½®æ–‡ä»¶ notepad $profile,è¾“å…¥ä¸€ä¸‹å†…å®¹\nImport-Module PSReadLine # Shows navigable menu of all options when hitting Tab Set-PSReadLineKeyHandler -Key Tab -Function MenuComplete # Autocompleteion for Arrow keys Set-PSReadLineOption -HistorySearchCursorMovesToEnd Set-PSReadLineKeyHandler -Key UpArrow -Function HistorySearchBackward Set-PSReadLineKeyHandler -Key DownArrow -Function HistorySearchForward Set-PSReadLineOption -ShowToolTips Set-PSReadLineOption -PredictionSource History #Set the color for Prediction (auto-suggestion) Set-PSReadLineOption -Colors @{ Command = \u0026#39;Magenta\u0026#39; Number = \u0026#39;DarkBlue\u0026#39; Member = \u0026#39;DarkBlue\u0026#39; Operator = \u0026#39;DarkBlue\u0026#39; Type = \u0026#39;DarkBlue\u0026#39; Variable = \u0026#39;DarkGreen\u0026#39; Parameter = \u0026#39;DarkGreen\u0026#39; ContinuationPrompt = \u0026#39;DarkBlue\u0026#39; Default = \u0026#39;DarkBlue\u0026#39; InlinePrediction = \u0026#39;DarkGray\u0026#39; } oh-my-posh Oh My Poshæ˜¯ä¸€ä¸ªå®šåˆ¶çš„æç¤ºå¼•æ“ï¼Œé€‚ç”¨äºä»»ä½•èƒ½å¤Ÿä½¿ç”¨å‡½æ•°æˆ–å˜é‡è°ƒæ•´æç¤ºå­—ç¬¦ä¸²çš„shellã€‚\nå®‰è£…\nscoop install oh-my-posh\né…ç½®\nåœ¨é…ç½®æ–‡ä»¶ $profile è¾“å…¥ï¼š\noh-my-posh init pwsh --config ~\\scoop\\apps\\oh-my-posh\\current\\themes\\robbyrussel.omp.json | Invoke-Expression Get-ChildItemColor å®‰è£…\nInstall-Module -AllowClobber Get-ChildItemColor -Scope CurrentUser\né…ç½®:\nåœ¨é…ç½®æ–‡ä»¶ $profile è¾“å…¥ï¼š\nImport-Module Get-ChildItemColor\nå®Œæ•´é…ç½® oh-my-posh init pwsh --config C:\\Users\\Administrator\\scoop\\apps\\oh-my-posh\\current\\themes\\robbyrussel.omp.json | Invoke-Expression Import-Module PSReadLine # Shows navigable menu of all options when hitting Tab Set-PSReadLineKeyHandler -Key Tab -Function MenuComplete # Autocompleteion for Arrow keys Set-PSReadLineOption -HistorySearchCursorMovesToEnd Set-PSReadLineKeyHandler -Key UpArrow -Function HistorySearchBackward Set-PSReadLineKeyHandler -Key DownArrow -Function HistorySearchForward Set-PSReadLineOption -ShowToolTips Set-PSReadLineOption -PredictionSource History #Set the color for Prediction (auto-suggestion) Set-PSReadLineOption -Colors @{ Command = \u0026#39;Magenta\u0026#39; Number = \u0026#39;DarkBlue\u0026#39; Member = \u0026#39;DarkBlue\u0026#39; Operator = \u0026#39;DarkBlue\u0026#39; Type = \u0026#39;DarkBlue\u0026#39; Variable = \u0026#39;DarkGreen\u0026#39; Parameter = \u0026#39;DarkGreen\u0026#39; ContinuationPrompt = \u0026#39;DarkBlue\u0026#39; Default = \u0026#39;DarkBlue\u0026#39; InlinePrediction = \u0026#39;DarkGray\u0026#39; } Import-Module Get-ChildItemColor #Set-Alias ll Get-ChildItem -option AllScope #Set-Alias ls Get-ChildItemColorFormatWide -option AllScope Function vim {F:\\Neovim\\bin\\nvim.exe $args} ","date":"2022-05-13T17:28:48Z","permalink":"https://dccmmtop.github.io/posts/powershell%E9%85%8D%E7%BD%AE/","section":"posts","tags":["powershell"],"title":"powershellé…ç½®"},{"categories":null,"contents":"Shellå­¦ä¹ ç¬”è®°ï¼šawkå®ç°group byåˆ†ç»„ç»Ÿè®¡åŠŸèƒ½\næ—¥å¸¸éƒ¨åˆ†æ•°æ®ä»¥ txt çš„æ–‡ä»¶æ ¼å¼æä¾›ï¼Œä¸ºé¿å…å…¥åº“ä¹‹åå†è¿›è¡Œç»Ÿè®¡çš„éº»çƒ¦ï¼Œæ•…å­¦ä¹  shell è¿›è¡Œå¤„ç†ï¼Œå‡å°‘å·¥ä½œé‡ã€‚\n1.æ ·ä¾‹æ•°æ®\ntest.txt YD5Gxxx|6618151|6825449073|6476534190|36251|è¶…çº§ä¼šå‘˜|0 YD5Gxxx|8968336|1445546463|6476534190|36251|è¶…çº§ä¼šå‘˜|0 YD5Gxxx|2545939|6904742993|0858636804|36251|è¶…çº§ä¼šå‘˜|80%ä»¥ä¸Š YD5Gxxx|3200810|6896525523|6501574903|36251|æ™®é€š|0 YD5Gxxx|3378244|6926264463|6519442719|36251|è¶…çº§ä¼šå‘˜|80%ä»¥ä¸Š YD5Gxxx|8075700|6854827783|0858523344|36251|æ™®é€š|80%ä»¥ä¸Š YD5Gxxx|3368804|6934387193|0000487348|36251|è¶…çº§ä¼šå‘˜|(0ï¼Œ50%] YD5Gxxx|2865288|6865082233|0859114957|36251|æ™®é€š|(0ï¼Œ50%] YD5Gxxx|6655543|6930124273|6521876215|36251|è¶…çº§ä¼šå‘˜|(0ï¼Œ50%] YD5Gxxx|2952781|6820973583|0858704189|36251|è¶…çº§ä¼šå‘˜|0 æ¯5è¡Œåˆ‡åˆ†ä¸ºä¸€ä¸ªæ–‡ä»¶ é€šè¿‡ split -l å¯¹æ–‡ä»¶è¿›è¡Œåˆ‡åˆ†ã€‚\nsplit -l 5 super_user.txt\nåˆ†ç»„ç»Ÿè®¡ å®ç°åˆ†ç»„ï¼Œcount[$6]++ å®ç°è®¡æ•°ã€‚\nawk -F '|' '{count[$6]++;} END {for(i in count) {print i count[i]}}' test.txt\næ™®é€š3 è¶…çº§ä¼šå‘˜7 æ ¹æ®ç¬¬7åˆ—è¿›è¡Œç­›é€‰ä¹‹åï¼Œå†æŒ‰ç¬¬6åˆ—è¿›è¡Œåˆ†ç»„ç»Ÿè®¡ã€‚\nawk -F '|' '{if($7==\u0026quot;0\u0026quot;) {count[$6]++;}} END {for(i in count) {print i count[i]}}' test.txt\næ™®é€š1 è¶…çº§ä¼šå‘˜3 åˆ†ç»„æ±‚å’Œ å¯¹æ‰€æœ‰è¿›è¡Œæ±‚å’Œã€‚\nawk -F '|' '{sum += $2} END {print sum}' test.txt\nåˆ†ç»„ä¸€èˆ¬ä½¿ç”¨x[$2]=x[$3]çš„æ–¹å¼æ¥å®ç°ï¼Œå…¶ä¸­x[$2]ä¸­çš„$2ä¸ºè¦åˆ†çš„ç»„ï¼Œå¯ä»¥å¤šä¸ªåˆ†ç»„ï¼Œx[$3]ä¸ºè¦å¤„ç†çš„å€¼ã€‚\nä¸€æ¬¡åˆ†ç»„ awk -F '|' '{x[$6] += $2} END {for(i in x){print i, x[i]}}' test.txt\næ™®é€š 14141798 è¶…çº§ä¼šå‘˜ 34487798 äºŒæ¬¡åˆ†ç»„ awk -F '|' '{x[$6\u0026quot;-\u0026quot;$7] += $2} END {for(i in x){print i, x[i]}}' test.txt\nè¶…çº§ä¼šå‘˜-80%ä»¥ä¸Š 5924183 è¶…çº§ä¼šå‘˜-0 18539268 æ™®é€š-(0ï¼Œ50%] 2865288 è¶…çº§ä¼šå‘˜-(0ï¼Œ50%] 10024347 æ™®é€š-0 3200810 æ™®é€š-80%ä»¥ä¸Š 8075700 æ ¼å¼åŒ–å¤„ç† åˆ†ç»„æ±‚å¹³å‡å€¼ awk -F '|' '{sum += $2} END {print \u0026quot;Average = \u0026quot;, sum/NR}' test.txt\nAverage = 4.86296e+06 awk -F '|' '{a[$6] += $2; ca[$6]++} END {for(i in a){print(i,a[i]/ca[i])}}' test.txt\næ™®é€š 4.71393e+06 è¶…çº§ä¼šå‘˜ 4.92683e+06 åˆ†ç»„æ±‚æœ€å¤§æœ€å° awk -F '|' 'BEGIN {max=0} {if($2\u0026gt;max){max=$2}} END {print max}' test.txt\næœ€å¤§å€¼ awk -F '|' '{if($2\u0026gt;x[$6]){x[$6]=$2}} END {for(i in x) {print i, x[i]}}' test.txt\næ™®é€š 8075700 è¶…çº§ä¼šå‘˜ 8968336 åˆ†ç»„æ•´ç†å­—ç¬¦ awk -F '|' '{x[$6]=x[$6]\u0026quot;\\n\u0026quot;$2} END {for(i in x){print i \u0026quot;:\u0026quot; x[i]}}' test.txt\næ™®é€š: 3200810 8075700 2865288 è¶…çº§ä¼šå‘˜: 6618151 8968336 2545939 3378244 3368804 6655543 2952781 ","date":"2022-05-10T15:51:00Z","permalink":"https://dccmmtop.github.io/posts/awk%E5%88%86%E7%BB%84%E7%BB%9F%E8%AE%A1/","section":"posts","tags":["awk"],"title":"awkåˆ†ç»„ç»Ÿè®¡"},{"categories":null,"contents":"OCPï¼šå¼€é—­åŸåˆ™ è½¯ä»¶çš„5å¤§è®¾è®¡åŸåˆ™ â€œSOLIDâ€ åŸåˆ™,å…¶ä¸­ä¹‹ä¸€å°±æ˜¯ OCP(å¼€é—­åŸåˆ™)\nè¯¥è®¾è®¡åŸåˆ™æ˜¯ç”±Bertrand Meyeråœ¨20ä¸–çºª80å¹´ä»£å¤§åŠ›æ¨å¹¿çš„ï¼Œå…¶æ ¸å¿ƒè¦ç´ æ˜¯ï¼šå¦‚æœè½¯ä»¶ç³»ç»Ÿæƒ³è¦æ›´å®¹æ˜“è¢«æ”¹å˜ï¼Œé‚£ä¹ˆå…¶è®¾è®¡å°±å¿…é¡»å…è®¸æ–°å¢ä»£ç æ¥ä¿®æ”¹ç³»ç»Ÿè¡Œä¸ºï¼Œè€Œéåªèƒ½é ä¿®æ”¹åŸæ¥çš„ä»£ç ã€‚\nå¯¹åŸæœ‰ä»£ç æ”¹åŠ¨è¶Šå°‘ï¼Œç³»ç»Ÿå°±è¶Šç¨³å®šã€‚è‡´åŠ›äºå®ç°å¢åŠ æ–°çš„åŠŸèƒ½åªé€šè¿‡å¢åŠ ä¸€ä¸ªæ’ä»¶å°±å¯ä»¥å®ç°\næ¡ˆä¾‹ æŸç¨‹åºæƒ³å®ç°å¯¹è¾“å…¥å‚æ•°çš„è½¬æ¢ï¼Œå‚æ•°ç›®å‰æ˜¯æ¥è‡ªå‘½ä»¤è¡Œï¼Œä»¥åå¯èƒ½æ¥è‡ªç½‘é¡µï¼Œæˆ–è€…ä»æ–‡æœ¬è¯»å–ã€‚å¦‚æœæŠŠå¤„ç†ä¸šåŠ¡çš„é€»è¾‘ä¸å‚æ•°è½¬æ¢è€¦åˆåˆ°ä¸€èµ·ï¼Œé‚£ä¹ˆä»¥åä¿®æ”¹å‚æ•°æ¥æºæ—¶ï¼ŒåŠ¿å¿…ä¼šéœ€æ”¹éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘ï¼Œé€ æˆç³»ç»Ÿçš„ä¸ç¨³å®šã€‚æœ¬æ–‡å°†æ¨¡ä»¿ \u0026ldquo;database/sql\u0026rdquo; çš„æ–¹å¼ï¼Œåªéœ€æ›´æ¢ä¸åŒçš„åŒ…ï¼Œå®ç°æ›´æ¢è½¬æ¢å™¨çš„æ•ˆæœ\nç›®å½•ç»“æ„å¦‚ä¸‹:\nmain.go\npackage main import ( \u0026#34;ocp/arg_parse\u0026#34; //å®‰è£…å‘½ä»¤è¡Œè½¬æ¢å™¨ //_ \u0026#34;ocp/commandline_arg\u0026#34; // æˆ–è€…å®‰è£…ç½‘é¡µå‚æ•°è½¬æ¢å™¨ _ \u0026#34;ocp/web_arg\u0026#34; \u0026#34;os\u0026#34; ) func main(){ // ä»åŸä»£ç å±‚é¢çœ‹ï¼Œå°±æ˜¯é€šè¿‡æ¥å£è¿›è¡Œå‚æ•°è½¬æ¢ã€‚åœ¨è¿è¡Œæ—¶ï¼Œä¸€ä¸ªå…·ä½“çš„å®ç°å°±æ³¨å†Œåˆ° Driver ä¸Šã€‚ // å®åˆ™æ˜¯é€šè¿‡è¯¥å®ç°ç±»çš„å®ä¾‹æ¥å®Œæˆè½¬æ¢çš„åŠŸèƒ½ arg_parse.Driver.ParseArg(os.Args) } parse.go\nè¯¥åŒ…ä¸­ï¼Œå¤§éƒ¨åˆ†åº”è¯¥æ˜¯æ¥å£ï¼Œè¡¨æ˜äº†å„å…·ä½“å®ç°å·¥å…·éœ€è¦å®ç°çš„ä¸€ç§æ–¹æ³•ï¼Œä¸šåŠ¡ä¸­é€šè¿‡è°ƒç”¨æ¥å£çš„æ–¹å¼ï¼Œæœ€ç»ˆè°ƒç”¨å…·ä½“å®ç°ã€‚\nå°±åƒä¸€ä¸ªé¢†å¯¼è¯´ï¼Œæˆ‘å…¬å¸æœ‰ä¸€ä¸ªå¼€å‘èŒä½ï¼Œè¯¥èŒä½è¦æ±‚ä¼šå®ç°æŸç§è½¬æ¢å‚æ•°çš„æŠ€èƒ½ï¼Œ ä½ ä»¬è¿™äº›å·¥äººå¿…é¡»æ‹¥æœ‰è¿™é¡¹æŠ€èƒ½ï¼Œæ‰èƒ½æ¥æˆ‘è¿™é‡Œä¸Šç­\nè¿™é‡ŒèŒä½æ˜¯è™šæ‹Ÿçš„ï¼ŒèŒä½æœ¬èº«ä¸ä¼šå¹²æ´»ï¼Œä½†æ˜¯ä»–è¦æ±‚äº†åº”è˜è¯¥èŒä½å·¥äººæ‰€æ‹¥æœ‰çš„æŠ€èƒ½\næœ€åé¢†å¯¼ä¼šåè°ƒä¸åŒå·¥ç§ç›¸äº’é…åˆï¼Œå®Œæˆæ•´ä½“ä»»åŠ¡ï¼Œè€Œä¸ä¼šå…³å¿ƒå…·ä½“æ‰§è¡Œä»»åŠ¡çš„å·¥äººã€‚\npackage arg_parse // å®šä¹‰å‚æ•°è½¬æ¢çš„æ¥å£ï¼Œå…¶ä»–å„ç§å‚æ•°è½¬æ¢å™¨éƒ½è¦å®ç°æœ¬æ¥å£çš„åŠŸèƒ½ã€‚ // å…·ä½“çš„å®ç°ç±»çš„å®ä¾‹ä¼šèµ‹å€¼åˆ° Driverï¼Œ(ä¸€ä¸ªèŒä½) var Driver Parse type Args struct { Name string Age int Location string } // å¾…å®ç°çš„æ–¹æ³•(èŒä½è¦æ±‚çš„æŠ€èƒ½) type Parse interface { ParseArg([] string) *Args } commandline_arg.go\nå…·ä½“å¹²æ´»çš„å·¥äºº1\npackage commandline_arg import ( \u0026#34;fmt\u0026#34; \u0026#34;ocp/arg_parse\u0026#34; ) type CommandlineParse struct {} func init(){ // æ³¨å†Œè½¬æ¢å™¨, è¯¥è½¬æ¢å™¨æ‹¥æœ‰ parse æ¥å£çš„æ–¹æ³•ï¼Œ å°±å¯ä»¥æ³¨å†Œ (è¯¥å·¥äººåº”è˜æˆåŠŸ) fmt.Println(\u0026#34;æ³¨å†Œ CommandlineParse\u0026#34;) arg_parse.Driver = \u0026amp;CommandlineParse{} } // å…·ä½“å®ç°çš„åŠŸèƒ½ï¼Œ å®ç°äº† ParseArg æ–¹æ³• (è¯¥å·¥äººæŒæ¡çš„æŠ€èƒ½) func (c CommandlineParse) ParseArg(args []string) *arg_parse.Args{ fmt.Println(\u0026#34;æˆ‘æ˜¯å‘½ä»¤è¡Œçš„å‚æ•°è½¬æ¢å™¨\u0026#34;) return \u0026amp;arg_parse.Args{} } web_arg.go\nå…·ä½“å¹²æ´»çš„å·¥äºº2\npackage web_arg import ( \u0026#34;fmt\u0026#34; \u0026#34;ocp/arg_parse\u0026#34; ) type WebParse struct {} func init(){ // æ³¨å†Œè½¬æ¢å™¨, ï¼ˆå·¥äººåº”è˜æˆåŠŸï¼‰ fmt.Println(\u0026#34;æ³¨å†Œ WebParse\u0026#34;) arg_parse.Driver = \u0026amp;WebParse{} } // å·¥äººæŒæ¡çš„æŠ€èƒ½ func (c WebParse) ParseArg(args []string) *arg_parse.Args{ fmt.Println(\u0026#34;æˆ‘æ˜¯ç½‘é¡µçš„å‚æ•°è½¬æ¢å™¨\u0026#34;) return \u0026amp;arg_parse.Args{} } ","date":"2022-05-08T22:06:51Z","permalink":"https://dccmmtop.github.io/posts/golnag%E6%8F%92%E4%BB%B6%E5%BC%8F%E5%BC%80%E5%8F%91%E7%9A%84%E4%B8%80%E7%A7%8D%E6%A1%88%E4%BE%8B/","section":"posts","tags":["go"],"title":"golnagæ’ä»¶å¼å¼€å‘çš„ä¸€ç§æ¡ˆä¾‹"},{"categories":null,"contents":"æƒ³æŠŠè‡ªå·±å†™çš„ä¸€ä¸ªæ§åˆ¶å°ç¨‹åºæ·»åŠ åˆ°å³é”®ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹æ³¨å†Œè¡¨çš„æ–¹å¼å®ç°ï¼Œä½†æ˜¯ä¿®æ”¹èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œæ¨èä½¿ç”¨å³é”®ç®¡ç†å™¨è¿›è¡Œä¿®æ”¹\nå³ä¾§çš„ â€æ–‡ä»¶â€œ â€æ–‡ä»¶å¤¹â€œ â€ç›®å½•â€œ ç­‰ï¼Œä»£è¡¨åœ¨è¯¥é¡¹å³é”®æ—¶ï¼Œå³é”®èœå•æ˜¾ç¤ºçš„å†…å®¹\nç‚¹å‡» + æ–°å»ºï¼š\nç‚¹å‡»ç¡®å®š\nç”±äºæ˜¯æ§åˆ¶å°ç¨‹åºä¸èƒ½ç›´æ¥è¿è¡Œï¼Œéœ€è¦ä½œä¸ºcmd.exe å‚æ•°æ¥å¯åŠ¨ï¼Œå¦‚ä¸‹:\ncmd.exe /c F:\\bin\\mix.exe push å¦å¤–ï¼Œé—´æ¥å¯åŠ¨ä¸€ä¸ªç¨‹åºçš„æ—¶å€™ä¹Ÿå¯ä»¥ä¼ å…¥ /k å‚æ•°ã€‚ä¸ /c å‚æ•°ä¸åŒçš„æ˜¯ï¼š\n/c åœ¨æ‰§è¡Œå®Œç¨‹åºä¹‹åï¼Œcmd.exe ä¹Ÿä¼šç»ˆæ­¢\n/k åœ¨æ‰§è¡Œå®Œç¨‹åºä¹‹åï¼Œcmd.exe ä¾ç„¶ä¼šç»§ç»­è¿è¡Œ\næ‰€ä»¥ /c å‘½ä»¤ä¼šæ›´é€‚ç”¨äºè‡ªåŠ¨åŒ–çš„è„šæœ¬ï¼Œè€Œ /k å‘½ä»¤åˆ™æ›´é€‚ç”¨äºåŠè‡ªåŠ¨åŒ–çš„è„šæœ¬ã€‚\nåˆ›å»ºæˆåŠŸåå¯ä»¥ä¿®æ”¹å‘½ä»¤ä»¥å›¾æ ‡ï¼š\næ•ˆæœï¼š\n","date":"2022-05-08T16:39:06Z","permalink":"https://dccmmtop.github.io/posts/%E5%8F%B3%E9%94%AE%E6%B3%A8%E5%86%8C%E8%87%AA%E5%AE%9A%E4%B9%89%E7%A8%8B%E5%BA%8F/","section":"posts","tags":["tools"],"title":"å³é”®æ³¨å†Œè‡ªå®šä¹‰ç¨‹åº"},{"categories":null,"contents":"è½¯ä»¶æ¶æ„è¿™é¡¹å·¥ä½œçš„å®è´¨å°±æ˜¯è§„åˆ’å¦‚ä½•å°†ç³»ç»Ÿåˆ‡åˆ†æˆç»„ä»¶ï¼Œå¹¶å®‰æ’å¥½ç»„ä»¶ä¹‹é—´çš„æ’åˆ—å…³ç³»ï¼Œä»¥åŠç»„ä»¶ä¹‹é—´äº’ç›¸é€šä¿¡çš„æ–¹å¼ã€‚ (æ‹†åˆ†ã€ç»„åˆã€é€šä¿¡)\nç›®æ ‡ è®¾è®¡è‰¯å¥½çš„æ¶æ„å¯ä»¥è®©ç³»ç»Ÿä¾¿äºç†è§£ã€æ˜“äºä¿®æ”¹ã€æ–¹ä¾¿ç»´æŠ¤ï¼Œå¹¶ä¸”èƒ½è½»æ¾éƒ¨ç½²ã€‚è½¯ä»¶æ¶æ„çš„ç»ˆæç›®æ ‡å°±æ˜¯æœ€å¤§åŒ–ç¨‹åºå‘˜çš„ç”Ÿäº§åŠ›ï¼ŒåŒæ—¶æœ€å°åŒ–ç³»ç»Ÿçš„æ€»è¿è¥æˆæœ¬ã€‚\nç”Ÿå‘½å‘¨æœŸ è®¾è®¡è‰¯å¥½æ¶æ„çš„æ‰‹æ®µ å§‹ç»ˆä¿æŒå¤šçš„å¯é€‰é¡¹ è½¯ä»¶æ¶æ„å¸ˆçš„ç›®æ ‡æ˜¯åˆ›å»ºä¸€ç§ç³»ç»Ÿå½¢æ€ï¼Œè¯¥å½¢æ€ä¼šä»¥ç­–ç•¥ä¸ºæœ€åŸºæœ¬çš„å…ƒç´ ï¼Œå¹¶è®©ç»†èŠ‚ä¸ç­–ç•¥è„±ç¦»å…³ç³»ï¼Œä»¥å…è®¸åœ¨å…·ä½“å†³ç­–è¿‡ç¨‹ä¸­æ¨è¿Ÿæˆ–å»¶è¿Ÿä¸ç»†èŠ‚ç›¸å…³çš„å†…å®¹ã€‚\nä¸åº”è¯¥è¿‡æ—©çš„å…³æ³¨ä½¿ç”¨å…³ç³»å‹ï¼Œéå…³ç³»å‹ï¼Œè¿˜æ˜¯åˆ†å¸ƒå¼æ•°æ®åº“ ä¸åº”è¯¥è¿‡æ—©çš„å…³æ³¨ä½¿ç”¨webæœåŠ¡ï¼Œæˆ–è€…ä»¥æŸç§å½¢å¼å‘å¸ƒï¼ˆç½‘é¡µï¼Œapp ç­‰ï¼‰ ä¸åº”è¯¥ç¡®å®šæ˜¯å¦ä½¿ç”¨ RESTæ¨¡å¼ç­‰ ä¸åº”è¯¥è¿‡æ—©çš„é‡‡ç”¨ä¾èµ–æ³¨å…¥æ¡†æ¶ å¦‚æœåœ¨å¼€å‘é«˜å±‚ç­–ç•¥æ—¶æœ‰æ„åœ°è®©è‡ªå·±æ‘†è„±å…·ä½“ç»†èŠ‚çš„çº ç¼ ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†ä¸å…·ä½“å®ç°ç›¸å…³çš„ç»†èŠ‚å†³ç­–æ¨è¿Ÿæˆ–å»¶åï¼Œå› ä¸ºè¶Šåˆ°é¡¹ç›®çš„åæœŸï¼Œæˆ‘ä»¬å°±æ‹¥æœ‰è¶Šå¤šçš„ä¿¡æ¯æ¥åšå‡ºåˆç†çš„å†³ç­–ã€‚\nç»„ä»¶çš„å±‚æ¬¡ ç¦»ioè¶Šè¿œï¼Œå±‚æ¬¡è¶Šé«˜ æˆ‘ä»¬å¯¹â€œå±‚æ¬¡â€æ˜¯ä¸¥æ ¼æŒ‰ç…§â€œè¾“å…¥ä¸è¾“å‡ºä¹‹é—´çš„è·ç¦»â€æ¥å®šä¹‰çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ¡ç­–ç•¥è·ç¦»ç³»ç»Ÿçš„è¾“å…¥/è¾“å‡ºè¶Šè¿œï¼Œå®ƒæ‰€å±çš„å±‚æ¬¡å°±è¶Šé«˜ã€‚è€Œç›´æ¥ç®¡ç†è¾“å…¥/è¾“å‡ºçš„ç­–ç•¥åœ¨ç³»ç»Ÿä¸­çš„å±‚æ¬¡æ˜¯æœ€ä½çš„ã€‚\n","date":"2022-05-05T22:29:49Z","permalink":"https://dccmmtop.github.io/posts/%E6%9E%B6%E6%9E%84%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E4%B9%A6%E6%91%98%E5%85%AB%E8%BD%AF%E4%BB%B6%E6%9E%B6%E6%9E%84/","section":"posts","tags":["æ¶æ„"],"title":"æ¶æ„æ•´æ´ä¹‹é“ä¹¦æ‘˜å…«â€”â€”è½¯ä»¶æ¶æ„"},{"categories":null,"contents":"SOLID åŸåˆ™ SRPï¼šå•ä¸€èŒè´£åŸåˆ™ã€‚ è¯¥è®¾è®¡åŸåˆ™æ˜¯åŸºäºåº·å¨å®šå¾‹ï¼ˆConway\u0026rsquo;s Lawï¼‰[1]çš„ä¸€ä¸ªæ¨è®ºâ€”â€”ä¸€ä¸ªè½¯ä»¶ç³»ç»Ÿçš„æœ€ä½³ç»“æ„é«˜åº¦ä¾èµ–äºå¼€å‘è¿™ä¸ªç³»ç»Ÿçš„ç»„ç»‡çš„å†…éƒ¨ç»“æ„ã€‚è¿™æ ·ï¼Œæ¯ä¸ªè½¯ä»¶æ¨¡å—éƒ½æœ‰ä¸”åªæœ‰ä¸€ä¸ªéœ€è¦è¢«æ”¹å˜çš„ç†ç”±ã€‚\nOCPï¼šå¼€é—­åŸåˆ™ã€‚ è¯¥è®¾è®¡åŸåˆ™æ˜¯ç”±Bertrand Meyeråœ¨20ä¸–çºª80å¹´ä»£å¤§åŠ›æ¨å¹¿çš„ï¼Œå…¶æ ¸å¿ƒè¦ç´ æ˜¯ï¼šå¦‚æœè½¯ä»¶ç³»ç»Ÿæƒ³è¦æ›´å®¹æ˜“è¢«æ”¹å˜ï¼Œé‚£ä¹ˆå…¶è®¾è®¡å°±å¿…é¡»å…è®¸æ–°å¢ä»£ç æ¥ä¿®æ”¹ç³»ç»Ÿè¡Œä¸ºï¼Œè€Œéåªèƒ½é ä¿®æ”¹åŸæ¥çš„ä»£ç ã€‚\nLSPï¼šé‡Œæ°æ›¿æ¢åŸåˆ™ã€‚ è¯¥è®¾è®¡åŸåˆ™æ˜¯Barbara Liskovåœ¨1988å¹´æå‡ºçš„ä¸€ä¸ªè‘—åçš„å­ç±»å‹å®šä¹‰ã€‚ç®€å•æ¥è¯´ï¼Œè¿™é¡¹åŸåˆ™çš„æ„æ€æ˜¯å¦‚æœæƒ³ç”¨å¯æ›¿æ¢çš„ç»„ä»¶æ¥æ„å»ºè½¯ä»¶ç³»ç»Ÿï¼Œé‚£ä¹ˆè¿™äº›ç»„ä»¶å°±å¿…é¡»éµå®ˆåŒä¸€ä¸ªçº¦å®šï¼Œä»¥ä¾¿è®©è¿™äº›ç»„ä»¶å¯ä»¥ç›¸äº’æ›¿æ¢ã€‚\nISPï¼šæ¥å£éš”ç¦»åŸåˆ™ã€‚ è¿™é¡¹è®¾è®¡åŸåˆ™ä¸»è¦å‘Šè¯«è½¯ä»¶è®¾è®¡å¸ˆåº”è¯¥åœ¨è®¾è®¡ä¸­é¿å…ä¸å¿…è¦çš„ä¾èµ–ã€‚\nä»»ä½•å±‚æ¬¡çš„è½¯ä»¶è®¾è®¡å¦‚æœä¾èµ–äº†å®ƒå¹¶ä¸éœ€è¦çš„ä¸œè¥¿ï¼Œå°±ä¼šå¸¦æ¥æ„æ–™ä¹‹å¤–çš„éº»çƒ¦ã€‚\nDIPï¼šä¾èµ–åè½¬åŸåˆ™ã€‚ è¯¥è®¾è®¡åŸåˆ™æŒ‡å‡ºé«˜å±‚ç­–ç•¥æ€§çš„ä»£ç ä¸åº”è¯¥ä¾èµ–å®ç°åº•å±‚ç»†èŠ‚çš„ä»£ç ï¼Œæ°æ°ç›¸åï¼Œé‚£äº›å®ç°åº•å±‚ç»†èŠ‚çš„ä»£ç åº”è¯¥ä¾èµ–é«˜å±‚ç­–ç•¥æ€§çš„ä»£ç ã€‚\nå¦‚æœæƒ³è¦è®¾è®¡ä¸€ä¸ªçµæ´»çš„ç³»ç»Ÿï¼Œåœ¨æºä»£ç å±‚æ¬¡çš„ä¾èµ–å…³ç³»ä¸­å°±åº”è¯¥å¤šå¼•ç”¨æŠ½è±¡ç±»å‹ï¼Œè€Œéå…·ä½“å®ç°\nç¨³å®šçš„æŠ½è±¡å±‚ æˆ‘ä»¬æ¯æ¬¡ä¿®æ”¹æŠ½è±¡æ¥å£çš„æ—¶å€™ï¼Œä¸€å®šä¹Ÿä¼šå»ä¿®æ”¹å¯¹åº”çš„å…·ä½“å®ç°ã€‚ä½†åè¿‡æ¥ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹å…·ä½“å®ç°æ—¶ï¼Œå´å¾ˆå°‘éœ€è¦å»ä¿®æ”¹ç›¸åº”çš„æŠ½è±¡æ¥å£ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ¥å£æ¯”å®ç°æ›´ç¨³å®šã€‚\nçš„ç¡®ï¼Œä¼˜ç§€çš„è½¯ä»¶è®¾è®¡å¸ˆå’Œæ¶æ„å¸ˆä¼šèŠ±è´¹å¾ˆå¤§ç²¾åŠ›æ¥è®¾è®¡æ¥å£ï¼Œä»¥å‡å°‘æœªæ¥å¯¹å…¶è¿›è¡Œæ”¹åŠ¨ã€‚æ¯•ç«Ÿäº‰å–åœ¨ä¸ä¿®æ”¹æ¥å£çš„æƒ…å†µä¸‹ä¸ºè½¯ä»¶å¢åŠ æ–°çš„åŠŸèƒ½æ˜¯è½¯ä»¶è®¾è®¡çš„åŸºç¡€å¸¸è¯†ã€‚\nåº”åœ¨ä»£ç ä¸­å¤šä½¿ç”¨æŠ½è±¡æ¥å£ï¼Œå°½é‡é¿å…ä½¿ç”¨é‚£äº›å¤šå˜çš„å…·ä½“å®ç°ç±»\nåº”é¿å…åœ¨ä»£ç ä¸­å†™å…¥ä¸ä»»ä½•å…·ä½“å®ç°ç›¸å…³çš„åå­—ï¼Œæˆ–è€…æ˜¯å…¶ä»–å®¹æ˜“å˜åŠ¨çš„äº‹ç‰©çš„åå­—ã€‚è¿™åŸºæœ¬ä¸Šæ˜¯DIPåŸåˆ™çš„å¦å¤–ä¸€ä¸ªè¡¨è¾¾æ–¹å¼ã€‚\n","date":"2022-05-05T10:45:55Z","permalink":"https://dccmmtop.github.io/posts/%E6%9E%B6%E6%9E%84%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E4%B9%A6%E6%91%98%E4%B8%83%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99/","section":"posts","tags":["æ¶æ„"],"title":"æ¶æ„æ•´æ´ä¹‹é“ä¹¦æ‘˜ä¸ƒâ€”â€”è®¾è®¡åŸåˆ™"},{"categories":null,"contents":"å‡½æ•°å¼ç¼–ç¨‹æ‰€ä¾èµ–çš„åŸç†ï¼Œåœ¨å¾ˆå¤šæ–¹é¢å…¶å®æ˜¯æ—©äºç¼–ç¨‹æœ¬èº«å‡ºç°çš„ã€‚å› ä¸ºå‡½æ•°å¼ç¼–ç¨‹è¿™ç§èŒƒå¼å¼ºçƒˆä¾èµ–äºAlonzo Churchåœ¨20ä¸–çºª30å¹´ä»£å‘æ˜çš„Î»æ¼”ç®—ã€‚\nä»€ä¹ˆæ˜¯å‡½æ•°å¼ç¼–ç¨‹ ä¸¾ä¸ªä¾‹å­ï¼šè®¡ç®—0-25èŒƒå›´å†…æ•´æ•°çš„å¹³æ–¹\nJavaç‰ˆï¼š\npublic class Squint { public static void main(String args[]){ for (int i=0; iï¼œ25; i++) System.out.println(i*i); } } ä¸‹é¢æˆ‘ä»¬æ”¹ç”¨Clojureè¯­è¨€æ¥å†™è¿™ä¸ªç¨‹åºï¼ŒClojureæ˜¯LISPè¯­è¨€çš„ä¸€ç§è¡ç”Ÿä½“ï¼Œå±äºå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ã€‚å…¶ä»£ç å¦‚ä¸‹ï¼š\n(println(take 25(map(fn[x](* x x))(range)))) çœ‹ä¸æ‡‚é¢çš„è¯­è¨€æ²¡æœ‰å…³ç³»ï¼Œæˆ‘ä»¬è®¨è®ºå®ƒçš„ä¸»è¦ç›®æ ‡æ˜¯è¦çªæ˜¾å‡ºClojureå’ŒJavaè¿™ä¸¤ç§è¯­è¨€ä¹‹é—´çš„å·¨å¤§åŒºåˆ«ã€‚åœ¨Javaç¨‹åºä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å¯å˜é‡ï¼Œå³å˜é‡iï¼Œè¯¥å˜é‡çš„å€¼ä¼šéšç€ç¨‹åºæ‰§è¡Œçš„è¿‡ç¨‹è€Œæ”¹å˜ï¼Œæ•…è¢«ç§°ä¸ºå¾ªç¯æ§åˆ¶å˜é‡ã€‚è€ŒClojureç¨‹åºä¸­æ˜¯ä¸å­˜åœ¨è¿™ç§å˜é‡çš„ï¼Œå˜é‡xä¸€æ—¦è¢«åˆå§‹åŒ–ä¹‹åï¼Œå°±ä¸ä¼šå†è¢«æ›´æ”¹äº†ã€‚\nè¿™å¥è¯æœ‰ç‚¹å‡ºäººæ„æ–™ï¼šå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­çš„å˜é‡ï¼ˆVariableï¼‰æ˜¯ä¸å¯å˜ï¼ˆVaryï¼‰çš„ã€‚\nä¸å¯å˜æ€§ä¸è½¯ä»¶æ¶æ„ ä¸ºä»€ä¹ˆä¸å¯å˜æ€§æ˜¯è½¯ä»¶æ¶æ„è®¾è®¡éœ€è¦è€ƒè™‘çš„é‡ç‚¹å‘¢ï¼Ÿä¸ºä»€ä¹ˆè½¯ä»¶æ¶æ„å¸ˆè¦æ“å¿ƒå˜é‡çš„å¯å˜æ€§å‘¢ï¼Ÿç­”æ¡ˆæ˜¾è€Œæ˜“è§ï¼šæ‰€æœ‰çš„ç«äº‰é—®é¢˜ã€æ­»é”é—®é¢˜ã€å¹¶å‘æ›´æ–°é—®é¢˜éƒ½æ˜¯ç”±å¯å˜å˜é‡å¯¼è‡´çš„ã€‚å¦‚æœå˜é‡æ°¸è¿œä¸ä¼šè¢«æ›´æ”¹ï¼Œé‚£å°±ä¸å¯èƒ½äº§ç”Ÿç«äº‰æˆ–è€…å¹¶å‘æ›´æ–°é—®é¢˜ã€‚å¦‚æœé”çŠ¶æ€æ˜¯ä¸å¯å˜çš„ï¼Œé‚£å°±æ°¸è¿œä¸ä¼šäº§ç”Ÿæ­»é”é—®é¢˜ã€‚\næ¢å¥è¯è¯´ï¼Œä¸€åˆ‡å¹¶å‘åº”ç”¨é‡åˆ°çš„é—®é¢˜ï¼Œä¸€åˆ‡ç”±äºä½¿ç”¨å¤šçº¿ç¨‹ã€å¤šå¤„ç†å™¨è€Œå¼•èµ·çš„é—®é¢˜ï¼Œå¦‚æœæ²¡æœ‰å¯å˜å˜é‡çš„è¯éƒ½ä¸å¯èƒ½å‘ç”Ÿã€‚\nä½†æ˜¯ï¼Œèƒ½åšåˆ°æ²¡æœ‰å¯å˜å˜é‡å—ï¼Ÿå³ä¸å¯å˜æ€§\nå¦‚æœæˆ‘ä»¬èƒ½å¿½ç•¥å­˜å‚¨å™¨ä¸å¤„ç†å™¨åœ¨é€Ÿåº¦ä¸Šçš„é™åˆ¶ï¼Œé‚£ä¹ˆç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚å¦åˆ™çš„è¯ï¼Œä¸å¯å˜æ€§åªæœ‰åœ¨ä¸€å®šæƒ…å†µä¸‹æ˜¯å¯è¡Œçš„ã€‚\nå¯å˜æ€§éš”ç¦» ä¸€ç§å¸¸è§æ–¹å¼æ˜¯å°†åº”ç”¨ç¨‹åºï¼Œæˆ–è€…æ˜¯åº”ç”¨ç¨‹åºçš„å†…éƒ¨æœåŠ¡è¿›è¡Œåˆ‡åˆ†ï¼Œåˆ’åˆ†ä¸ºå¯å˜çš„å’Œä¸å¯å˜çš„ä¸¤ç§ç»„ä»¶ã€‚å¦‚ä¸‹å›¾ï¼š\nç”±äºçŠ¶æ€çš„ä¿®æ”¹ä¼šå¯¼è‡´ä¸€ç³»åˆ—å¹¶å‘é—®é¢˜çš„äº§ç”Ÿï¼Œæ‰€ä»¥æˆ‘ä»¬é€šå¸¸ä¼šé‡‡ç”¨æŸç§äº‹åŠ¡å‹å†…å­˜æ¥ä¿æŠ¤å¯å˜å˜é‡ï¼Œé¿å…åŒæ­¥æ›´æ–°å’Œç«äº‰çŠ¶æ€çš„å‘ç”Ÿã€‚\nè¦ç‚¹æ˜¯ï¼šä¸€ä¸ªæ¶æ„è®¾è®¡è‰¯å¥½çš„åº”ç”¨ç¨‹åºåº”è¯¥å°†çŠ¶æ€ä¿®æ”¹çš„éƒ¨åˆ†å’Œä¸éœ€è¦ä¿®æ”¹çŠ¶æ€çš„éƒ¨åˆ†éš”ç¦»æˆå•ç‹¬çš„ç»„ä»¶ï¼Œç„¶åç”¨åˆé€‚çš„æœºåˆ¶æ¥ä¿æŠ¤å¯å˜é‡ã€‚\näº‹ä»¶æº¯æº ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æŸä¸ªé“¶è¡Œåº”ç”¨ç¨‹åºéœ€è¦ç»´æŠ¤å®¢æˆ·è´¦æˆ·ä½™é¢ä¿¡æ¯ï¼Œå½“å®ƒæ‰§è¡Œå­˜å–æ¬¾äº‹åŠ¡æ—¶ï¼Œå°±è¦åŒæ—¶è´Ÿè´£ä¿®æ”¹ä½™é¢è®°å½•ã€‚\nå¦‚æœæˆ‘ä»¬ä¸ä¿å­˜å…·ä½“è´¦æˆ·ä½™é¢ï¼Œä»…ä»…ä¿å­˜äº‹åŠ¡æ—¥å¿—ï¼Œé‚£ä¹ˆå½“æœ‰äººæƒ³æŸ¥è¯¢è´¦æˆ·ä½™é¢æ—¶ï¼Œæˆ‘ä»¬å°±å°†å…¨éƒ¨äº¤æ˜“è®°å½•å–å‡ºï¼Œå¹¶ä¸”æ¯æ¬¡éƒ½å¾—ä»æœ€å¼€å§‹åˆ°å½“ä¸‹è¿›è¡Œç´¯è®¡ã€‚å½“ç„¶ï¼Œè¿™æ ·çš„è®¾è®¡å°±ä¸éœ€è¦ç»´æŠ¤ä»»ä½•å¯å˜å˜é‡äº†ã€‚\nä½†æ˜¾è€Œæ˜“è§ï¼Œè¿™ç§å®ç°æ˜¯æœ‰äº›ä¸åˆç†çš„ã€‚å› ä¸ºéšç€æ—¶é—´çš„æ¨ç§»ï¼Œäº‹åŠ¡çš„æ•°ç›®ä¼šæ— é™åˆ¶å¢é•¿ï¼Œæ¯æ¬¡å¤„ç†æ€»é¢æ‰€éœ€è¦çš„å¤„ç†èƒ½åŠ›å¾ˆå¿«å°±ä¼šå˜å¾—ä¸èƒ½æ¥å—ã€‚å¦‚æœæƒ³ä½¿è¿™ç§è®¾è®¡æ°¸è¿œå¯è¡Œçš„è¯ï¼Œæˆ‘ä»¬å°†éœ€è¦æ— é™å®¹é‡çš„å­˜å‚¨ï¼Œä»¥åŠæ— é™çš„å¤„ç†èƒ½åŠ›ã€‚\nä½†æ˜¯å¯èƒ½æˆ‘ä»¬å¹¶ä¸éœ€è¦è¿™ä¸ªè®¾è®¡æ°¸è¿œå¯è¡Œï¼Œè€Œä¸”å¯èƒ½åœ¨æ•´ä¸ªç¨‹åºçš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œæˆ‘ä»¬æœ‰è¶³å¤Ÿçš„å­˜å‚¨å’Œå¤„ç†èƒ½åŠ›æ¥æ»¡è¶³å®ƒã€‚\nè¿™å°±æ˜¯äº‹ä»¶æº¯æºï¼Œåœ¨è¿™ç§ä½“ç³»ä¸‹ï¼Œæˆ‘ä»¬åªå­˜å‚¨äº‹åŠ¡è®°å½•ï¼Œä¸å­˜å‚¨å…·ä½“çŠ¶æ€ã€‚å½“éœ€è¦å…·ä½“çŠ¶æ€æ—¶ï¼Œæˆ‘ä»¬åªè¦ä»å¤´å¼€å§‹è®¡ç®—æ‰€æœ‰çš„äº‹åŠ¡å³å¯ã€‚\næ›´é‡è¦çš„æ˜¯ï¼Œè¿™ç§æ•°æ®å­˜å‚¨æ¨¡å¼ä¸­ä¸å­˜åœ¨åˆ é™¤å’Œæ›´æ–°çš„æƒ…å†µï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸æ˜¯CRUDï¼Œè€Œæ˜¯CRã€‚å› ä¸ºæ›´æ–°å’Œåˆ é™¤è¿™ä¸¤ç§æ“ä½œéƒ½ä¸å­˜åœ¨äº†ï¼Œè‡ªç„¶ä¹Ÿå°±ä¸å­˜åœ¨å¹¶å‘é—®é¢˜ã€‚\nå¦‚æœæˆ‘ä»¬æœ‰è¶³å¤Ÿå¤§çš„å­˜å‚¨é‡å’Œå¤„ç†èƒ½åŠ›ï¼Œåº”ç”¨ç¨‹åºå°±å¯ä»¥ç”¨å®Œå…¨ä¸å¯å˜çš„ã€çº¯å‡½æ•°å¼çš„æ–¹å¼æ¥ç¼–ç¨‹ã€‚\n","date":"2022-05-03T16:43:03Z","permalink":"https://dccmmtop.github.io/posts/%E6%9E%B6%E6%9E%84%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E4%B9%A6%E6%91%98%E5%85%AD%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/","section":"posts","tags":["æ¶æ„"],"title":"æ¶æ„æ•´æ´ä¹‹é“ä¹¦æ‘˜å…­â€”â€”å‡½æ•°å¼ç¼–ç¨‹"},{"categories":null,"contents":"è­¬å¦‚å°è£…ï¼ˆencapsulationï¼‰ã€ç»§æ‰¿ï¼ˆinheritanceï¼‰ã€å¤šæ€ï¼ˆpolymorphismï¼‰ã€‚å…¶éšå«æ„æ€å°±æ˜¯è¯´é¢å‘å¯¹è±¡ç¼–ç¨‹æ˜¯è¿™ä¸‰é¡¹çš„æœ‰æœºç»„åˆï¼Œæˆ–è€…ä»»ä½•ä¸€ç§æ”¯æŒé¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€å¿…é¡»æ”¯æŒè¿™ä¸‰ä¸ªç‰¹æ€§ã€‚\nå°è£… é€šè¿‡é‡‡ç”¨å°è£…ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸€ç»„ç›¸å…³è”çš„æ•°æ®å’Œå‡½æ•°åœˆèµ·æ¥ï¼Œä½¿åœˆå¤–é¢çš„ä»£ç åªèƒ½çœ‹è§éƒ¨åˆ†å‡½æ•°ï¼Œæ•°æ®åˆ™å®Œå…¨ä¸å¯è§ã€‚\nè€ŒC++ä½œä¸ºä¸€ç§é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ï¼Œåè€Œç ´åäº†Cçš„å®Œç¾å°è£…æ€§ã€‚\nC++é€šè¿‡åœ¨ç¼–ç¨‹è¯­è¨€å±‚é¢å¼•å…¥publicã€privateã€protectedè¿™äº›å…³é”®è¯ï¼Œéƒ¨åˆ†ç»´æŠ¤äº†å°è£…æ€§ã€‚ä½†æ‰€æœ‰è¿™äº›éƒ½æ˜¯ä¸ºäº†è§£å†³ç¼–è¯‘å™¨è‡ªèº«çš„æŠ€æœ¯å®ç°é—®é¢˜è€Œå¼•å…¥çš„hackâ€”â€”ç¼–è¯‘å™¨ç”±äºæŠ€æœ¯å®ç°åŸå› å¿…é¡»åœ¨å¤´æ–‡ä»¶ä¸­çœ‹åˆ°æˆå‘˜å˜é‡çš„å®šä¹‰ã€‚\nè€ŒJavaå’ŒC#åˆ™å½»åº•æŠ›å¼ƒäº†å¤´æ–‡ä»¶ä¸å®ç°æ–‡ä»¶åˆ†ç¦»çš„ç¼–ç¨‹æ–¹å¼ï¼Œè¿™å…¶å®è¿›ä¸€æ­¥å‰Šå¼±äº†å°è£…æ€§ã€‚å› ä¸ºåœ¨è¿™äº›è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬æ˜¯æ— æ³•åŒºåˆ†ä¸€ä¸ªç±»çš„å£°æ˜å’Œå®šä¹‰çš„ã€‚\nç”±äºä¸Šè¿°åŸå› ï¼Œæˆ‘ä»¬å¾ˆéš¾è¯´å¼ºå°è£…æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹çš„å¿…è¦æ¡ä»¶ã€‚è€Œäº‹å®ä¸Šï¼Œæœ‰å¾ˆå¤šé¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€[3]å¯¹å°è£…æ€§å¹¶æ²¡æœ‰å¼ºåˆ¶æ€§çš„è¦æ±‚ã€‚\né¢å‘å¯¹è±¡ç¼–ç¨‹åœ¨åº”ç”¨ä¸Šç¡®å®ä¼šè¦æ±‚ç¨‹åºå‘˜å°½é‡é¿å…ç ´åæ•°æ®çš„å°è£…æ€§ã€‚ä½†å®é™…æƒ…å†µæ˜¯ï¼Œé‚£äº›å£°ç§°è‡ªå·±æä¾›é¢å‘å¯¹è±¡ç¼–ç¨‹æ”¯æŒçš„ç¼–ç¨‹è¯­è¨€ï¼Œç›¸å¯¹äºCè¿™ç§å®Œç¾å°è£…çš„è¯­è¨€è€Œè¨€ï¼Œå…¶å°è£…æ€§éƒ½è¢«å‰Šå¼±äº†ï¼Œè€Œä¸æ˜¯åŠ å¼ºäº†ã€‚\nç»§æ‰¿ æ—¢ç„¶é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€å¹¶æ²¡æœ‰æä¾›æ›´å¥½çš„å°è£…æ€§ï¼Œé‚£ä¹ˆåœ¨ç»§æ‰¿æ€§æ–¹é¢åˆå¦‚ä½•å‘¢ï¼Ÿ\nå—¯ï¼Œå…¶å®ä¹Ÿå°±ä¸€èˆ¬èˆ¬å§ã€‚ç®€è€Œè¨€ä¹‹ï¼Œç»§æ‰¿çš„ä¸»è¦ä½œç”¨æ˜¯è®©æˆ‘ä»¬å¯ä»¥åœ¨æŸä¸ªä½œç”¨åŸŸå†…å¯¹å¤–éƒ¨å®šä¹‰çš„æŸä¸€ç»„å˜é‡ä¸å‡½æ•°è¿›è¡Œè¦†ç›–ã€‚è¿™äº‹å®ä¸Šä¹Ÿæ˜¯Cç¨‹åºå‘˜[4]æ—©åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€å‘æ˜ä¹‹å‰å°±ä¸€ç›´åœ¨åšçš„äº‹äº†ã€‚\nè™½ç„¶é¢å‘å¯¹è±¡ç¼–ç¨‹åœ¨ç»§æ‰¿æ€§æ–¹é¢å¹¶æ²¡æœ‰å¼€åˆ›å‡ºæ–°ï¼Œä½†æ˜¯çš„ç¡®åœ¨æ•°æ®ç»“æ„çš„ä¼ªè£…æ€§ä¸Šæä¾›äº†ç›¸å½“ç¨‹åº¦çš„ä¾¿åˆ©æ€§ã€‚\nå›é¡¾ä¸€ä¸‹åˆ°ç›®å‰ä¸ºæ­¢çš„åˆ†æï¼Œé¢å‘å¯¹è±¡ç¼–ç¨‹åœ¨å°è£…æ€§ä¸Šå¾—0åˆ†ï¼Œåœ¨ç»§æ‰¿æ€§ä¸Šå‹‰å¼ºå¯ä»¥å¾—0.5åˆ†ï¼ˆæ»¡åˆ†ä¸º1ï¼‰ã€‚\nå¤šæ€ åœ¨é¢å‘ç¼–ç¨‹å¯¹è±¡è¯­è¨€è¢«å‘æ˜ä¹‹å‰ï¼Œæˆ‘ä»¬æ‰€ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€èƒ½æ”¯æŒå¤šæ€å—ï¼Ÿ\nç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè¯·æ³¨æ„çœ‹ä¸‹é¢è¿™æ®µç”¨Cè¯­è¨€ç¼–å†™çš„copyç¨‹åºï¼š\n#include ï¼œstdio.hï¼ void copyï¼ˆï¼‰{ int cï¼› while ï¼ˆï¼ˆc=getcharï¼ˆï¼‰ï¼‰!= EOFï¼‰ putcharï¼ˆcï¼‰ï¼› } åœ¨ä¸Šè¿°ç¨‹åºä¸­ï¼Œå‡½æ•°getcharï¼ˆï¼‰ä¸»è¦è´Ÿè´£ä»STDINä¸­è¯»å–æ•°æ®ã€‚ä½†æ˜¯STDINç©¶ç«ŸæŒ‡ä»£çš„æ˜¯å“ªä¸ªè®¾å¤‡å‘¢ï¼ŸåŒæ ·çš„é“ç†ï¼Œputcharï¼ˆï¼‰ä¸»è¦è´Ÿè´£å°†æ•°æ®å†™å…¥STDOUTï¼Œè€ŒSTDOUTåˆæŒ‡ä»£çš„æ˜¯å“ªä¸ªè®¾å¤‡å‘¢ï¼Ÿå¾ˆæ˜¾ç„¶ï¼Œè¿™ç±»å‡½æ•°å…¶å®å°±å…·æœ‰å¤šæ€æ€§ï¼Œå› ä¸ºå®ƒä»¬çš„è¡Œä¸ºä¾èµ–äºSTDINå’ŒSTDOUTçš„å…·ä½“ç±»å‹ã€‚\nè¿™é‡Œçš„STDINå’ŒSTDOUTä¸Javaä¸­çš„æ¥å£ç±»ä¼¼ï¼Œå„ç§è®¾å¤‡éƒ½æœ‰å„è‡ªçš„å®ç°ã€‚å½“ç„¶ï¼Œè¿™ä¸ªCç¨‹åºä¸­æ˜¯æ²¡æœ‰æ¥å£è¿™ä¸ªæ¦‚å¿µçš„ï¼Œé‚£ä¹ˆgetcharï¼ˆï¼‰è¿™ä¸ªè°ƒç”¨çš„åŠ¨ä½œæ˜¯å¦‚ä½•çœŸæ­£ä¼ é€’åˆ°è®¾å¤‡é©±åŠ¨ç¨‹åºä¸­ï¼Œä»è€Œè¯»å–åˆ°å…·ä½“å†…å®¹çš„å‘¢ï¼Ÿ\nå…¶å®å¾ˆç®€å•ï¼ŒUNIXæ“ä½œç³»ç»Ÿå¼ºåˆ¶è¦æ±‚æ¯ä¸ªIOè®¾å¤‡éƒ½è¦æä¾›openã€closeã€readã€writeå’Œseekè¿™5ä¸ªæ ‡å‡†å‡½æ•°ã€‚[6]ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªIOè®¾å¤‡é©±åŠ¨ç¨‹åºå¯¹è¿™5ç§å‡½æ•°çš„å®ç°åœ¨å‡½æ•°è°ƒç”¨ä¸Šå¿…é¡»ä¿æŒä¸€è‡´\ngetcharï¼ˆï¼‰åªæ˜¯è°ƒç”¨äº†STDINæ‰€æŒ‡å‘çš„FILEæ•°æ®ç»“æ„ä½“ä¸­çš„readå‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ã€‚\næ¢å¥è¯è¯´ï¼Œgetcharï¼ˆï¼‰åªæ˜¯è°ƒç”¨äº†STDINæ‰€æŒ‡å‘çš„FILEæ•°æ®ç»“æ„ä½“ä¸­çš„readå‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„å‡½æ•°ã€‚\nå½“ç„¶äº†ï¼Œé¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€è™½ç„¶åœ¨å¤šæ€ä¸Šå¹¶æ²¡æœ‰ç†è®ºåˆ›æ–°ï¼Œä½†å®ƒä»¬ä¹Ÿç¡®å®è®©å¤šæ€å˜å¾—æ›´å®‰å…¨ã€æ›´ä¾¿äºä½¿ç”¨äº†ã€‚\nç”¨å‡½æ•°æŒ‡é’ˆæ˜¾å¼å®ç°å¤šæ€çš„é—®é¢˜å°±åœ¨äºå‡½æ•°æŒ‡é’ˆçš„å±é™©æ€§ã€‚æ¯•ç«Ÿï¼Œå‡½æ•°æŒ‡é’ˆçš„è°ƒç”¨ä¾èµ–äºä¸€ç³»åˆ—éœ€è¦äººä¸ºéµå®ˆçš„çº¦å®šã€‚ç¨‹åºå‘˜å¿…é¡»ä¸¥æ ¼æŒ‰ç…§å›ºå®šçº¦å®šæ¥åˆå§‹åŒ–å‡½æ•°æŒ‡é’ˆï¼Œå¹¶åŒæ ·ä¸¥æ ¼åœ°æŒ‰ç…§çº¦å®šæ¥è°ƒç”¨è¿™äº›æŒ‡é’ˆã€‚åªè¦æœ‰ä¸€ä¸ªç¨‹åºå‘˜æ²¡æœ‰éµå®ˆè¿™äº›çº¦å®šï¼Œæ•´ä¸ªç¨‹åºå°±ä¼šäº§ç”Ÿæå…¶éš¾ä»¥è·Ÿè¸ªå’Œæ¶ˆé™¤çš„Bugã€‚\nä¾èµ–åè½¬ åœ¨å®‰å…¨å’Œä¾¿åˆ©çš„å¤šæ€æ”¯æŒå‡ºç°ä¹‹å‰ï¼Œè½¯ä»¶æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚ä¸‹é¢æœ‰ä¸€ä¸ªå…¸å‹çš„è°ƒç”¨æ ‘çš„ä¾‹å­ï¼Œmainå‡½æ•°è°ƒç”¨äº†ä¸€äº›é«˜å±‚å‡½æ•°ï¼Œè¿™äº›é«˜å±‚å‡½æ•°åˆè°ƒç”¨äº†ä¸€äº›ä¸­å±‚å‡½æ•°ï¼Œè¿™äº›ä¸­å±‚å‡½æ•°åˆç»§ç»­è°ƒç”¨äº†ä¸€äº›åº•å±‚å‡½æ•°ã€‚åœ¨è¿™é‡Œï¼Œæºä»£ç å±‚é¢çš„ä¾èµ–ä¸å¯é¿å…åœ°è¦è·Ÿéšç¨‹åºçš„æ§åˆ¶æµã€‚å¦‚ä¸‹å›¾\nå¦‚ä½ æ‰€è§ï¼Œmainå‡½æ•°ä¸ºäº†è°ƒç”¨é«˜å±‚å‡½æ•°ï¼Œå®ƒå°±å¿…é¡»èƒ½å¤Ÿçœ‹åˆ°è¿™ä¸ªå‡½æ•°æ‰€åœ¨çš„æ¨¡å—ã€‚åœ¨Cä¸­ï¼Œæˆ‘ä»¬ä¼šé€šè¿‡#includeæ¥å®ç°ï¼Œåœ¨Javaä¸­åˆ™é€šè¿‡importæ¥å®ç°ï¼Œè€Œåœ¨C#ä¸­åˆ™ç”¨çš„æ˜¯usingè¯­å¥ã€‚æ€»ä¹‹ï¼Œæ¯ä¸ªå‡½æ•°çš„è°ƒç”¨æ–¹éƒ½å¿…é¡»è¦å¼•ç”¨è¢«è°ƒç”¨æ–¹æ‰€åœ¨çš„æ¨¡å—ã€‚\næ˜¾ç„¶ï¼Œè¿™æ ·åšå°±å¯¼è‡´äº†æˆ‘ä»¬åœ¨è½¯ä»¶æ¶æ„ä¸Šåˆ«æ— é€‰æ‹©ã€‚åœ¨è¿™é‡Œï¼Œç³»ç»Ÿè¡Œä¸ºå†³å®šäº†æ§åˆ¶æµï¼Œè€Œæ§åˆ¶æµåˆ™å†³å®šäº†æºä»£ç ä¾èµ–å…³ç³»ã€‚\nä½†ä¸€æ—¦æˆ‘ä»¬ä½¿ç”¨äº†å¤šæ€ï¼Œæƒ…å†µå°±ä¸ä¸€æ ·äº†ï¼Œå¦‚ä¸‹å›¾\næ¨¡å—HL1è°ƒç”¨äº†ML1æ¨¡å—ä¸­çš„Fï¼ˆï¼‰å‡½æ•°ï¼Œè¿™é‡Œçš„è°ƒç”¨æ˜¯é€šè¿‡æºä»£ç çº§åˆ«çš„æ¥å£æ¥å®ç°çš„ã€‚å½“ç„¶åœ¨ç¨‹åºå®é™…è¿è¡Œæ—¶ï¼Œæ¥å£è¿™ä¸ªæ¦‚å¿µæ˜¯ä¸å­˜åœ¨çš„ï¼ŒHL1ä¼šè°ƒç”¨ML1ä¸­çš„Fï¼ˆï¼‰å‡½æ•°[ã€‚\nè¯·æ³¨æ„æ¨¡å—ML1å’Œæ¥å£Iåœ¨æºä»£ç ä¸Šçš„ä¾èµ–å…³ç³»ï¼ˆæˆ–è€…å«ç»§æ‰¿å…³ç³»ï¼‰ï¼Œè¯¥å…³ç³»çš„æ–¹å‘å’Œæ§åˆ¶æµæ­£å¥½æ˜¯ç›¸åçš„ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºä¾èµ–åè½¬\nå½“æŸä¸ªç»„ä»¶çš„æºä»£ç éœ€è¦ä¿®æ”¹æ—¶ï¼Œä»…ä»…éœ€è¦é‡æ–°éƒ¨ç½²è¯¥ç»„ä»¶ï¼Œä¸éœ€è¦æ›´æ”¹å…¶ä»–ç»„ä»¶ï¼Œè¿™å°±æ˜¯ç‹¬ç«‹éƒ¨ç½²èƒ½åŠ›ã€‚\nå¦‚æœç³»ç»Ÿä¸­çš„æ‰€æœ‰ç»„ä»¶éƒ½å¯ä»¥ç‹¬ç«‹éƒ¨ç½²ï¼Œé‚£å®ƒä»¬å°±å¯ä»¥ç”±ä¸åŒçš„å›¢é˜Ÿå¹¶è¡Œå¼€å‘ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ç‹¬ç«‹å¼€å‘èƒ½åŠ›ã€‚\næ€»ç»“ é¢å‘å¯¹è±¡ç¼–ç¨‹åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿä¸šç•Œåœ¨è¿™ä¸ªé—®é¢˜ä¸Šå­˜åœ¨ç€å¾ˆå¤šä¸åŒçš„è¯´æ³•å’Œæ„è§ã€‚ç„¶è€Œå¯¹ä¸€ä¸ªè½¯ä»¶æ¶æ„å¸ˆæ¥è¯´ï¼Œå…¶å«ä¹‰åº”è¯¥æ˜¯éå¸¸æ˜ç¡®çš„ï¼šé¢å‘å¯¹è±¡ç¼–ç¨‹å°±æ˜¯ä»¥å¤šæ€ä¸ºæ‰‹æ®µæ¥å¯¹æºä»£ç ä¸­çš„ä¾èµ–å…³ç³»è¿›è¡Œæ§åˆ¶çš„èƒ½åŠ›ï¼Œè¿™ç§èƒ½åŠ›è®©è½¯ä»¶æ¶æ„å¸ˆå¯ä»¥æ„å»ºå‡ºæŸç§æ’ä»¶å¼æ¶æ„ï¼Œè®©é«˜å±‚ç­–ç•¥æ€§ç»„ä»¶ä¸åº•å±‚å®ç°æ€§ç»„ä»¶ç›¸åˆ†ç¦»ï¼Œåº•å±‚ç»„ä»¶å¯ä»¥è¢«ç¼–è¯‘æˆæ’ä»¶ï¼Œå®ç°ç‹¬ç«‹äºé«˜å±‚ç»„ä»¶çš„å¼€å‘å’Œéƒ¨ç½²ã€‚\n","date":"2022-05-02T23:29:24Z","permalink":"https://dccmmtop.github.io/posts/%E6%9E%B6%E6%9E%84%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E4%B9%A6%E6%91%98%E4%BA%94%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/","section":"posts","tags":["æ¶æ„"],"title":"æ¶æ„æ•´æ´ä¹‹é“ä¹¦æ‘˜äº”â€”â€”é¢å‘å¯¹è±¡"},{"categories":null,"contents":"ç§‘å­¦æ–¹æ³•è®ºä¸éœ€è¦è¯æ˜æŸæ¡ç»“è®ºæ˜¯æ­£ç¡®çš„ï¼Œåªéœ€è¦æƒ³åŠæ³•è¯æ˜å®ƒæ˜¯é”™è¯¯çš„ã€‚å¦‚æœæŸä¸ªç»“è®ºç»è¿‡ä¸€å®šçš„åŠªåŠ›æ— æ³•è¯ä¼ªï¼Œæˆ‘ä»¬åˆ™è®¤ä¸ºå®ƒåœ¨å½“ä¸‹æ˜¯è¶³å¤Ÿæ­£ç¡®çš„ã€‚\næˆ‘ä»¬çš„ç¨‹åºä¹Ÿæ˜¯å¦‚æ­¤,æˆ‘ä»¬ä¸èƒ½è¯æ˜æˆ‘ä»¬çš„ä»£ç æ˜¯ç»å¯¹æ­£ç¡®çš„ï¼Œè€Œæ˜¯åšå„ç§caseè¦†ç›–è¯æ˜å®ƒå¯èƒ½å­˜åœ¨é”™è¯¯ã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±è®¤ä¸ºç›¸å¯¹ç¨³å®šçš„\nDijkstraæ›¾ç»è¯´è¿‡â€œæµ‹è¯•åªèƒ½å±•ç¤ºBugçš„å­˜åœ¨ï¼Œå¹¶ä¸èƒ½è¯æ˜ä¸å­˜åœ¨Bugâ€ï¼Œæ¢å¥è¯è¯´ï¼Œä¸€æ®µç¨‹åºå¯ä»¥ç”±ä¸€ä¸ªæµ‹è¯•æ¥è¯æ˜å…¶é”™è¯¯æ€§ï¼Œä½†æ˜¯å´ä¸èƒ½è¢«è¯æ˜æ˜¯æ­£ç¡®çš„ã€‚æµ‹è¯•çš„ä½œç”¨æ˜¯è®©æˆ‘ä»¬å¾—å‡ºæŸæ®µç¨‹åºå·²ç»è¶³å¤Ÿå®ç°å½“å‰ç›®æ ‡è¿™ä¸€ç»“è®ºã€‚\nè¿™ç§è¯ä¼ªè¿‡ç¨‹åªèƒ½åº”ç”¨äºå¯è¯æ˜çš„ç¨‹åºä¸Šã€‚æŸæ®µç¨‹åºå¦‚æœæ˜¯ä¸å¯è¯æ˜çš„ï¼Œä¾‹å¦‚ï¼Œå…¶ä¸­é‡‡ç”¨äº†ä¸åŠ é™åˆ¶çš„gotoè¯­å¥ï¼Œé‚£ä¹ˆæ— è®ºæˆ‘ä»¬ä¸ºå®ƒå†™å¤šå°‘æµ‹è¯•ï¼Œä¹Ÿä¸èƒ½å¤Ÿè¯æ˜å…¶æ­£ç¡®æ€§ã€‚\nç»“æ„åŒ–ç¼–ç¨‹èŒƒå¼ä¿ƒä½¿æˆ‘ä»¬å…ˆå°†ä¸€æ®µç¨‹åºé€’å½’é™è§£ä¸ºä¸€ç³»åˆ—å¯è¯æ˜çš„å°å‡½æ•°ï¼Œç„¶åå†ç¼–å†™ç›¸å…³çš„æµ‹è¯•æ¥è¯•å›¾è¯æ˜è¿™äº›å‡½æ•°æ˜¯é”™è¯¯çš„ã€‚å¦‚æœè¿™äº›æµ‹è¯•æ— æ³•è¯ä¼ªè¿™äº›å‡½æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºè¿™äº›å‡½æ•°æ˜¯è¶³å¤Ÿæ­£ç¡®çš„ï¼Œè¿›è€Œæ¨å¯¼æ•´ä¸ªç¨‹åºæ˜¯æ­£ç¡®çš„ã€‚\nç»“æ„åŒ–ç¼–ç¨‹èŒƒå¼ä¸­æœ€æœ‰ä»·å€¼çš„åœ°æ–¹å°±æ˜¯ï¼Œå®ƒèµ‹äºˆäº†æˆ‘ä»¬åˆ›é€ å¯è¯ä¼ªç¨‹åºå•å…ƒçš„èƒ½åŠ›ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆç°ä»£ç¼–ç¨‹è¯­è¨€ä¸€èˆ¬ä¸æ”¯æŒæ— é™åˆ¶çš„gotoè¯­å¥ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨æ¶æ„è®¾è®¡é¢†åŸŸï¼ŒåŠŸèƒ½æ€§é™è§£æ‹†åˆ†ä»ç„¶æ˜¯æœ€ä½³å®è·µä¹‹ä¸€ã€‚\n","date":"2022-05-02T23:13:43Z","permalink":"https://dccmmtop.github.io/posts/%E6%9E%B6%E6%9E%84%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E4%B9%A6%E6%91%98%E5%9B%9B%E7%BB%93%E6%9E%84%E5%8C%96%E7%BC%96%E7%A8%8B/","section":"posts","tags":["æ¶æ„"],"title":"æ¶æ„æ•´æ´ä¹‹é“ä¹¦æ‘˜å››â€”â€”ç»“æ„åŒ–ç¼–ç¨‹"},{"categories":null,"contents":"ç¼–ç¨‹èŒƒå¼æŒ‡çš„æ˜¯ç¨‹åºçš„ç¼–å†™æ¨¡å¼ï¼Œä¸å…·ä½“çš„ç¼–ç¨‹è¯­è¨€å…³ç³»ç›¸å¯¹è¾ƒå°ã€‚è¿™äº›èŒƒå¼ä¼šå‘Šè¯‰ä½ åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™é‡‡ç”¨ä»€ä¹ˆæ ·çš„ä»£ç ç»“æ„ã€‚\nç›®å‰ä¹Ÿåªæœ‰ä¸‰ä¸ªç¼–ç¨‹èŒƒå¼ï¼š\nå®ƒä»¬åˆ†åˆ«æ˜¯ç»“æ„åŒ–ç¼–ç¨‹ï¼ˆstructured programmingï¼‰ã€é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆobject-oriented programmingï¼‰ä»¥åŠå‡½æ•°å¼ç¼–ç¨‹ï¼ˆfunctional programmingï¼‰ã€‚\nç»“æ„åŒ–ç¼–ç¨‹ ç»“æ„åŒ–ç¼–ç¨‹æ˜¯ç¬¬ä¸€ä¸ªæ™®éè¢«é‡‡ç”¨çš„ç¼–ç¨‹èŒƒå¼ï¼ˆä½†æ˜¯å´ä¸æ˜¯ç¬¬ä¸€ä¸ªè¢«æå‡ºçš„ï¼‰ï¼Œç”±Edsger Wybe Dijkstraäº1968å¹´æœ€å…ˆæå‡ºã€‚ä¸æ­¤åŒæ—¶ï¼ŒDijkstraè¿˜è®ºè¯äº†ä½¿ç”¨gotoè¿™æ ·çš„æ— é™åˆ¶è·³è½¬è¯­å¥å°†ä¼šæŸå®³ç¨‹åºçš„æ•´ä½“ç»“æ„ã€‚æ¥ä¸‹æ¥çš„ç« èŠ‚æˆ‘ä»¬è¿˜ä¼šè¯´åˆ°ï¼Œä¹Ÿæ˜¯è¿™ä½ Dijkstra æœ€å…ˆä¸»å¼ ç”¨æˆ‘ä»¬ç°åœ¨ç†ŸçŸ¥çš„ if/then/else è¯­å¥å’Œdo/while/untilè¯­å¥æ¥ä»£æ›¿è·³è½¬è¯­å¥çš„ã€‚\næˆ‘ä»¬å¯ä»¥å°†ç»“æ„åŒ–ç¼–ç¨‹èŒƒå¼å½’ç»“ä¸ºä¸€å¥è¯ï¼š ç»“æ„åŒ–ç¼–ç¨‹å¯¹ç¨‹åºæ§åˆ¶æƒçš„ç›´æ¥è½¬ç§»è¿›è¡Œäº†é™åˆ¶å’Œè§„èŒƒã€‚\né¢å‘å¯¹è±¡ç¼–ç¨‹ å°±æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹äº†ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸ªç¼–ç¨‹èŒƒå¼çš„æå‡ºæ¯”ç»“æ„åŒ–ç¼–ç¨‹è¿˜æ—©äº†ä¸¤å¹´ï¼Œæ˜¯åœ¨1966å¹´ç”±Ole Johan Dahlå’ŒKriste Nygaardåœ¨è®ºæ–‡ä¸­æ€»ç»“å½’çº³å‡ºæ¥çš„ã€‚è¿™ä¸¤ä¸ªç¨‹åºå‘˜æ³¨æ„åˆ°åœ¨ALGOLè¯­è¨€ä¸­ï¼Œå‡½æ•°è°ƒç”¨å †æ ˆï¼ˆcall stack frameï¼‰å¯ä»¥è¢«æŒªåˆ°å †å†…å­˜åŒºåŸŸé‡Œï¼Œè¿™æ ·å‡½æ•°å®šä¹‰çš„æœ¬åœ°å˜é‡å°±å¯ä»¥åœ¨å‡½æ•°è¿”å›ä¹‹åç»§ç»­å­˜åœ¨ã€‚è¿™ä¸ªå‡½æ•°å°±æˆä¸ºäº†ä¸€ä¸ªç±»ï¼ˆclassï¼‰çš„æ„é€ å‡½æ•°ï¼Œè€Œå®ƒæ‰€å®šä¹‰çš„æœ¬åœ°å˜é‡å°±æ˜¯ç±»çš„æˆå‘˜å˜é‡ï¼Œæ„é€ å‡½æ•°å®šä¹‰çš„åµŒå¥—å‡½æ•°å°±æˆä¸ºäº†æˆå‘˜æ–¹æ³•ï¼ˆmethodï¼‰ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨å¤šæ€ï¼ˆpolymorphismï¼‰æ¥é™åˆ¶ç”¨æˆ·å¯¹å‡½æ•°æŒ‡é’ˆçš„ä½¿ç”¨ã€‚\nåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ä¸€å¥è¯æ¥æ€»ç»“é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼š é¢å‘å¯¹è±¡ç¼–ç¨‹å¯¹ç¨‹åºæ§åˆ¶æƒçš„é—´æ¥è½¬ç§»è¿›è¡Œäº†é™åˆ¶å’Œè§„èŒƒã€‚\nå‡½æ•°å¼ç¼–ç¨‹ å°½ç®¡ç¬¬ä¸‰ä¸ªç¼–ç¨‹èŒƒå¼æ˜¯è¿‘äº›å¹´æ‰åˆšåˆšå¼€å§‹è¢«é‡‡ç”¨çš„ï¼Œä½†å®ƒå…¶å®æ˜¯ä¸‰ä¸ªèŒƒå¼ä¸­æœ€å…ˆè¢«å‘æ˜çš„ã€‚äº‹å®ä¸Šï¼Œå‡½æ•°å¼ç¼–ç¨‹æ¦‚å¿µæ˜¯åŸºäºä¸é˜¿å…°Â·å›¾çµåŒæ—¶ä»£çš„æ•°å­¦å®¶Alonzo Churchåœ¨1936å¹´å‘æ˜çš„Î»æ¼”ç®—çš„ç›´æ¥è¡ç”Ÿç‰©ã€‚1958å¹´John Mccarthyåˆ©ç”¨å…¶ä½œä¸ºåŸºç¡€å‘æ˜äº†LISPè¯­è¨€ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒÎ»æ¼”ç®—æ³•çš„ä¸€ä¸ªæ ¸å¿ƒæ€æƒ³æ˜¯ä¸å¯å˜æ€§â€”â€”æŸä¸ªç¬¦å·æ‰€å¯¹åº”çš„å€¼æ˜¯æ°¸è¿œä¸å˜çš„ï¼Œæ‰€ä»¥ä»ç†è®ºä¸Šæ¥è¯´ï¼Œå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ä¸­åº”è¯¥æ˜¯æ²¡æœ‰èµ‹å€¼è¯­å¥çš„ã€‚å¤§éƒ¨åˆ†å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€åªå…è®¸åœ¨éå¸¸ä¸¥æ ¼çš„é™åˆ¶æ¡ä»¶ä¸‹ï¼Œæ‰å¯ä»¥æ›´æ”¹æŸä¸ªå˜é‡çš„å€¼ã€‚\nå› æ­¤ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¯ä»¥å°†å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼æ€»ç»“ä¸ºä¸‹é¢è¿™å¥è¯ï¼š å‡½æ•°å¼ç¼–ç¨‹å¯¹ç¨‹åºä¸­çš„èµ‹å€¼è¿›è¡Œäº†é™åˆ¶å’Œè§„èŒƒã€‚\nå®ƒä»¬éƒ½ä»æŸä¸€æ–¹é¢é™åˆ¶å’Œè§„èŒƒäº†ç¨‹åºå‘˜çš„èƒ½åŠ›ã€‚æ²¡æœ‰ä¸€ä¸ªèŒƒå¼æ˜¯å¢åŠ æ–°èƒ½åŠ›çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªç¼–ç¨‹èŒƒå¼çš„ç›®çš„éƒ½æ˜¯è®¾ç½®é™åˆ¶ã€‚è¿™äº›èŒƒå¼ä¸»è¦æ˜¯ä¸ºäº†å‘Šè¯‰æˆ‘ä»¬ä¸èƒ½åšä»€ä¹ˆï¼Œè€Œä¸æ˜¯å¯ä»¥åšä»€ä¹ˆ\n","date":"2022-05-02T22:52:25Z","permalink":"https://dccmmtop.github.io/posts/%E6%9E%B6%E6%9E%84%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E4%B9%A6%E6%91%98%E4%B8%89%E7%BC%96%E7%A8%8B%E8%8C%83%E5%BC%8F/","section":"posts","tags":["æ¶æ„"],"title":"æ¶æ„æ•´æ´ä¹‹é“ä¹¦æ‘˜ä¸‰â€”â€”ç¼–ç¨‹èŒƒå¼"},{"categories":null,"contents":"å¯¹äºæ¯ä¸ªè½¯ä»¶ç³»ç»Ÿï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é€šè¿‡è¡Œä¸ºå’Œæ¶æ„ä¸¤ä¸ªç»´åº¦æ¥ä½“ç°å®ƒçš„å®é™…ä»·å€¼ã€‚è½¯ä»¶ç ”å‘äººå‘˜åº”è¯¥ç¡®ä¿è‡ªå·±çš„ç³»ç»Ÿåœ¨è¿™ä¸¤ä¸ªç»´åº¦ä¸Šçš„å®é™…ä»·å€¼éƒ½èƒ½é•¿æ—¶é—´ç»´æŒåœ¨å¾ˆé«˜çš„çŠ¶æ€\nå¤§éƒ¨åˆ†ç¨‹åºå‘˜è®¤ä¸ºè¿™å°±æ˜¯ä»–ä»¬çš„å…¨éƒ¨å·¥ä½œã€‚ä»–ä»¬çš„å·¥ä½œæ˜¯ä¸”ä»…æ˜¯ï¼šæŒ‰ç…§éœ€æ±‚æ–‡æ¡£ç¼–å†™ä»£ç ï¼Œå¹¶ä¸”ä¿®å¤ä»»ä½•Bugã€‚è¿™çœŸæ˜¯å¤§é”™ç‰¹é”™ã€‚\nè½¯ä»¶ç³»ç»Ÿå¿…é¡»ä¿æŒçµæ´»ã€‚è½¯ä»¶å‘æ˜çš„ç›®çš„ï¼Œå°±æ˜¯è®©æˆ‘ä»¬å¯ä»¥ä»¥ä¸€ç§çµæ´»çš„æ–¹å¼æ¥æ”¹å˜æœºå™¨çš„å·¥ä½œè¡Œä¸ºã€‚å¯¹æœºå™¨ä¸Šé‚£äº›å¾ˆéš¾æ”¹å˜çš„å·¥ä½œè¡Œä¸ºï¼Œæˆ‘ä»¬é€šå¸¸ç§°ä¹‹ä¸ºç¡¬ä»¶ï¼ˆhardwareï¼‰ã€‚\nå˜æ›´å®æ–½çš„éš¾åº¦åº”è¯¥å’Œå˜æ›´çš„èŒƒç•´ï¼ˆscopeï¼‰æˆç­‰æ¯”å…³ç³»ï¼Œè€Œä¸å˜æ›´çš„å…·ä½“å½¢çŠ¶ï¼ˆshapeï¼‰æ— å…³ã€‚\nå¦‚æœç³»ç»Ÿçš„æ¶æ„è®¾è®¡åå‘æŸç§ç‰¹å®šçš„â€œå½¢çŠ¶â€ï¼Œé‚£ä¹ˆæ–°çš„å˜æ›´å°±ä¼šè¶Šæ¥è¶Šéš¾ä»¥å®æ–½ã€‚æ‰€ä»¥ï¼Œå¥½çš„ç³»ç»Ÿæ¶æ„è®¾è®¡åº”è¯¥å°½å¯èƒ½åšåˆ°ä¸â€œå½¢çŠ¶â€æ— å…³ã€‚\nå¦‚æœä½ é—®ä¸šåŠ¡éƒ¨é—¨ï¼Œæ˜¯å¦æƒ³è¦èƒ½å¤Ÿå˜æ›´éœ€æ±‚ï¼Œä»–ä»¬çš„å›ç­”ä¸€èˆ¬æ˜¯è‚¯å®šçš„ï¼Œè€Œä¸”ä»–ä»¬ä¼šå¢åŠ ä¸€å¥ï¼šå®Œæˆç°åœ¨çš„åŠŸèƒ½æ¯”å®ç°æœªæ¥çš„çµæ´»åº¦æ›´é‡è¦ã€‚ä½†è®½åˆºçš„æ˜¯ï¼Œå¦‚æœäº‹åä¸šåŠ¡éƒ¨é—¨æå‡ºäº†ä¸€é¡¹éœ€æ±‚ï¼Œè€Œä½ çš„é¢„ä¼°å·¥ä½œé‡å¤§å¤§è¶…å‡ºä»–ä»¬çš„é¢„æœŸï¼Œè¿™å¸®å®¶ä¼™é€šå¸¸ä¼šå¯¹ä½ æ”¾ä»»ç³»ç»Ÿæ··ä¹±åˆ°æ— æ³•å˜æ›´çš„çŠ¶æ€è€Œå‹ƒç„¶å¤§æ€’ã€‚\nè¯·è®°ä½ï¼šå¦‚æœå¿½è§†è½¯ä»¶æ¶æ„çš„ä»·å€¼ï¼Œç³»ç»Ÿå°†ä¼šå˜å¾—è¶Šæ¥è¶Šéš¾ä»¥ç»´æŠ¤ï¼Œç»ˆä¼šæœ‰ä¸€å¤©ï¼Œç³»ç»Ÿå°†ä¼šå˜å¾—å†ä¹Ÿæ— æ³•ä¿®æ”¹ã€‚å¦‚æœç³»ç»Ÿå˜æˆäº†è¿™ä¸ªæ ·å­ï¼Œé‚£ä¹ˆè¯´æ˜è½¯ä»¶å¼€å‘å›¢é˜Ÿæ²¡æœ‰å’Œéœ€æ±‚æ–¹åšè¶³å¤Ÿçš„æŠ—äº‰ï¼Œæ²¡æœ‰å®Œæˆè‡ªå·±åº”å°½çš„èŒè´£ã€‚\n","date":"2022-05-02T22:52:09Z","permalink":"https://dccmmtop.github.io/posts/%E6%9E%B6%E6%9E%84%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E4%B9%A6%E6%91%98%E4%BA%8C/","section":"posts","tags":["æ¶æ„"],"title":"æ¶æ„æ•´æ´ä¹‹é“ä¹¦æ‘˜äºŒ"},{"categories":null,"contents":"æ¶æ„æ˜¯ä»€ä¹ˆ æŒ‰ç…§Bobå¤§å”çš„è¯´æ³•ï¼Œæ‰€è°“æ¶æ„å°±æ˜¯â€œç”¨æœ€å°çš„äººåŠ›æˆæœ¬æ¥æ»¡è¶³æ„å»ºå’Œç»´æŠ¤ç³»ç»Ÿéœ€æ±‚â€çš„è®¾è®¡è¡Œä¸ºã€‚\næ‰€è°“è½¯ä»¶æ¶æ„ï¼Œå°±æ˜¯ä½ å¸Œæœ›åœ¨é¡¹ç›®ä¸€å¼€å§‹å°±èƒ½åšå¯¹ï¼Œä½†æ˜¯å´ä¸ä¸€å®šèƒ½å¤Ÿåšå¾—å¯¹çš„å†³ç­–çš„é›†åˆã€‚\nä»äººåŠ›æˆæœ¬çš„è§’åº¦æ¥å®šä¹‰æ¶æ„ï¼Œæ‰€ä»¥ï¼Œæ¶æ„æ˜¯å¦åˆç†ï¼Œå®Œå…¨å–å†³äºæ˜¯å¦èŠ‚çœäººåŠ›ï¼Œä¾¿äºç»´æŠ¤ã€æ‰©å±•ã€‚\nç¬¬ä¸€æ€§åŸç†ï¼šæŠ€æœ¯æ˜¯ä¸ºå•†ä¸šä»·å€¼å’Œç¤¾ä¼šä»·å€¼æœåŠ¡çš„ã€‚ä»è¿™ä¸ªåŸåˆ™å‡ºå‘ï¼Œæ¶æ„å°±æ˜¯ç¡®ä¿ä¸šåŠ¡ çŸ­æœŸå¿«é€Ÿå‘å±•ã€ä¸­æœŸå¯å»¶å±•ã€é•¿æœŸç¨³å®šï¼Œä¸”ä½æˆæœ¬ã€‚åœ¨ä¸šåŠ¡è§†è§’ï¼Œå¯¹æ¶æ„æå‡ºçš„è¦æ±‚å°±æ˜¯â€œæ—¢è¦åˆè¦è¿˜è¦â€¦â€ æ¶æ„ï¼Œç»å¯¹ä¸æ˜¯â€œç‚«æŠ€â€ï¼Œç°åœ¨å¤§å…¬å¸æ™‹å‡æ±‡æŠ¥ï¼Œéƒ½ä¼šéœ€è¦è®²æŠ€æœ¯èƒ½åŠ›ï¼Œä¸ºäº†è¯•ç‚¹æ–°æŠ€æœ¯ï¼Œè€Œå¼ºåŠ ç»™ä¸šåŠ¡è¿­ä»£ï¼Œä¸”å¾€å¾€ä¸šåŠ¡å’Œäº§å“å¾ˆéš¾å‘ç°å’ŒçŸ¥æ™“ï¼Œè¿™æ˜¯éå¸¸æœ¬æœ«å€’ç½®çš„è¡Œä¸ºã€‚\næ¶æ„çš„è¡¡é‡ ä¸€ä¸ªè½¯ä»¶æ¶æ„çš„ä¼˜åŠ£ï¼Œå¯ä»¥ç”¨å®ƒæ»¡è¶³ç”¨æˆ·éœ€æ±‚æ‰€éœ€è¦çš„æˆæœ¬æ¥è¡¡é‡ã€‚å¦‚æœè¯¥æˆæœ¬å¾ˆä½ï¼Œå¹¶ä¸”åœ¨ç³»ç»Ÿçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ä¸€ç›´éƒ½èƒ½ç»´æŒè¿™æ ·çš„ä½æˆæœ¬ï¼Œé‚£ä¹ˆè¿™ä¸ªç³»ç»Ÿçš„è®¾è®¡å°±æ˜¯ä¼˜è‰¯çš„ã€‚å¦‚æœè¯¥ç³»ç»Ÿçš„æ¯æ¬¡å‘å¸ƒéƒ½ä¼šæå‡ä¸‹ä¸€æ¬¡å˜æ›´çš„æˆæœ¬ï¼Œé‚£ä¹ˆè¿™ä¸ªè®¾è®¡å°±æ˜¯ä¸å¥½çš„ã€‚å°±è¿™ä¹ˆç®€å•ã€‚\nç°ä»£çš„goto å¤§å®¶å¯¹ç»“æ„åŒ–ç¼–ç¨‹çš„ä¸€èˆ¬ç†è§£æ˜¯ï¼Œç”±if-elseã€switch-caseä¹‹ç±»çš„è¯­å¥ç»„ç»‡ç¨‹åºä»£ç çš„ç¼–ç¨‹æ–¹å¼ï¼Œå®ƒæœç»äº†gotoå¯¼è‡´çš„æ··ä¹±ã€‚ä½†æ˜¯ä»æ›´æ·±çš„å±‚æ¬¡ä¸Šçœ‹ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ç§è®¾è®¡èŒƒå¼ï¼Œé¿å…éšæ„ä½¿ç”¨gotoï¼Œä½¿ç”¨if-elseã€switch-caseä¹‹ç±»æ§åˆ¶è¯­å¥å’Œå‡½æ•°ã€å­å‡½æ•°ç»„ç»‡èµ·æ¥çš„ç¨‹åºä»£ç ï¼Œå¯ä»¥ä¿è¯ç¨‹åºçš„ç»“æ„æ˜¯æ¸…æ¥šçš„ï¼Œè‡ªé¡¶å‘ä¸‹å±‚å±‚ç»†åŒ–ï¼Œæ¶ˆç­äº†æ‚é”™ï¼Œæœç»äº†æ··æ·†ã€‚\nè”ç³»å¦‚ä»Šçš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæˆ‘ä»¬åœ¨è®¾è®¡çš„æ—¶å€™ï¼ŒçœŸçš„èƒ½å¤Ÿåšåˆ°è‡ªé¡¶å‘ä¸‹å±‚å±‚ç»†åŒ–å—ï¼Ÿæœ‰å¤šå°‘æ¬¡ï¼Œæˆ‘çœ‹åˆ°çš„ç³»ç»Ÿè®¾è®¡å›¾é‡Œï¼Œæ ¹æœ¬æ²¡æœ‰â€œå±‚æ¬¡â€çš„æ¦‚å¿µï¼Œå„ä¸ªæ¨¡å—æ²¡æœ‰ä¸€è‡´çš„å±‚æ¬¡åˆ’åˆ†ï¼Œä¸å­ç³»ç»Ÿäº¤äº’çš„ä¸æ˜¯å­ç³»ç»Ÿï¼Œè€Œæ˜¯ä¸€ç›˜æ•£æ²™å¼çš„æ¥å£ï¼Œç”šè‡³æ¥å£ä¹‹é—´éšæ„äº’è°ƒã€å…³ç³»ä¹±æˆä¸€å›¢éº»çš„æƒ…å†µä¹Ÿæ—¶å¸¸å‡ºç°ï¼Œå¸¦æ¥çš„å°±æ˜¯ç»´æŠ¤å’Œè°ƒè¯•çš„å™©æ¢¦ã€‚å¹æ•£å†å²çš„è¿·é›¾ï¼Œä¸æ­£æ˜¯å¤è€çš„gotoé™·é˜±çš„å†ç°å—ï¼Ÿ\næ¥å£çš„è®¾è®¡ æœ‰å¤šå°‘æ¬¡ï¼Œæˆ‘çœ‹åˆ°æ¥å£çš„è®¾è®¡éå¸¸éšæ„ï¼Œæ¥å£ä¸æ˜¯åŸºäºè¡Œä¸ºè€Œæ˜¯åŸºäºç‰¹å®šåœºæ™¯çš„å®ç°ï¼Œæ²¡æœ‰åšé€‚å½“çš„æŠ½è±¡ï¼Œä¹Ÿæ²¡æœ‰ä¸ºæœªæ¥é¢„ç•™ç©ºé—´ï¼Œç›´æ¥å¯¼è‡´å¥‘çº¦åƒµç¡¬æ­»æ¿ã€‚æ¯æ–°å¢ä¸€ç§ç»ˆç«¯å‘ˆç°å½¢å¼ï¼Œæ•´ä¸ªå†…å®¹ç”Ÿäº§æµç¨‹å°±è¦å¤§åŠ¨å¹²æˆˆï¼Œè¿™æ ·çš„ä¾‹å­å¹¶ä¸ç½•è§ã€‚æŠ¹å»å†å²çš„å°˜åŸƒï¼Œè¿™ä¸æ­£æ˜¯â€œå¤šæ€â€å‡ºç°ä¹‹å‰çš„å›°å¢ƒå—ï¼Ÿ\næ¥å£å®šä¹‰éœ€è¦åŸºäºè¡Œä¸ºä¸å¯ä»¥åŸºäºåœºæ™¯è®¾è®¡ï¼Œå¦åˆ™æ¥å£ä¼šå˜å¾—æ‚ä¹±æ— ç« \næ¥å£è®¾è®¡æ˜¯ç«™åœ¨è‡ªèº«è§’åº¦ï¼Œæ˜ç¡®é¢†åŸŸ åº”ç”¨å®šä½ï¼Œæ˜ç¡®æ¥å£æ–¹æ³•æä¾›çš„èƒ½åŠ›ï¼Œè€Œä¸æ˜¯åŸºäºéœ€æ±‚æ–¹çš„éœ€æ±‚ï¼ˆåœºæ™¯ï¼‰\nè½¯ä»¶æ¶æ„æ˜¯ç³»ç»Ÿè®¾è®¡è¿‡ç¨‹ä¸­çš„é‡è¦è®¾è®¡å†³å®šçš„é›†åˆï¼Œå¯ä»¥é€šè¿‡å˜æ›´æˆæœ¬æ¥è¡¡é‡æ¯ä¸ªè®¾è®¡å†³å®šçš„é‡è¦ç¨‹åº¦ã€‚\nä¸€ä¸ªå¥½çš„æ¶æ„ï¼Œä¸ä»…è¦åœ¨æŸä¸€ç‰¹å®šæ—¶åˆ»æ»¡è¶³è½¯ä»¶ç”¨æˆ·ã€å¼€å‘è€…å’Œæ‰€æœ‰è€…çš„éœ€æ±‚ï¼Œæ›´è¦åœ¨ä¸€æ®µæ—¶é—´å†…æŒç»­æ»¡è¶³ä»–ä»¬çš„åç»­éœ€æ±‚ã€‚å¦‚æœä½ è§‰å¾—å¥½æ¶æ„çš„æˆæœ¬å¤ªé«˜ï¼Œé‚£ä½ å¯ä»¥è¯•è¯•é€‰æ‹©å·®çš„æ¶æ„åŠ ä¸Šè¿”å·¥é‡æ¥çš„æˆæœ¬ã€‚\næŸä¸ªç³»ç»Ÿå› ä¸ºå…¶ç»„ä»¶é”™ç»¼å¤æ‚ï¼Œç›¸äº’è€¦åˆç´§å¯†ï¼Œè€Œå¯¼è‡´ä¸ç®¡å¤šä¹ˆå°çš„æ”¹åŠ¨éƒ½éœ€è¦æ•°å‘¨çš„æ¶æˆ˜æ‰èƒ½å®Œæˆã€‚åˆæˆ–æ˜¯æŸä¸ªç³»ç»Ÿä¸­åˆ°å¤„å……æ»¡äº†è…æœ½çš„è®¾è®¡å’Œè¿ç¯‡ç´¯ç‰çš„æ¶å¿ƒä»£ç ï¼Œå¤„å¤„éƒ½æ˜¯éšœç¢ã€‚å†æˆ–è€…ï¼Œä½ æœ‰æ²¡æœ‰è§è¿‡å“ªä¸ªç³»ç»Ÿçš„è®¾è®¡å¦‚æ­¤ä¹‹å·®ï¼Œè®©æ•´ä¸ªå›¢é˜Ÿçš„å£«æ°”ä½è½ï¼Œç”¨æˆ·å¤©å¤©ç—›è‹¦ï¼Œé¡¹ç›®ç»ç†ä»¬æ‰‹è¶³æ— æªï¼Ÿä½ æœ‰æ²¡æœ‰è§è¿‡æŸä¸ªè½¯ä»¶ç³»ç»Ÿå› å…¶æ¶æ„è…æœ½ä¸å ªï¼Œè€Œå¯¼è‡´å›¢é˜Ÿæµå¤±ï¼Œéƒ¨é—¨è§£æ•£ï¼Œç”šè‡³å…¬å¸å€’é—­ï¼Ÿä½œä¸ºä¸€åç¨‹åºå‘˜ï¼Œä½ åœ¨ç¼–ç¨‹æ—¶ä½“ä¼šè¿‡é‚£ç§ç”Ÿä¸å¦‚æ­»çš„æ„Ÿè§‰å—ï¼Ÿ\nå“ˆå“ˆï¼Œæ·±æœ‰ä½“ä¼šï¼Œç»å†è¿‡è¿™ç§ç—›è‹¦ä¹‹åï¼Œæ‰ä¼šæƒ³ç€æ”¹å˜ï¼Œæƒ³å¯»æ±‚æ›´å¥½çš„æ–¹æ³•\nç›¸ä¿¡æ¯ä¸ªå†™ä»£ç çš„äººéƒ½çŸ¥é“è¿™äº›ç¼–ç çš„å‡†åˆ™ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†äººåŒ…æ‹¬æˆ‘è‡ªå·±åœ¨å†™ä»£ç çš„æ—¶å€™å¯èƒ½æ—©å°±æŠŠè¿™äº›ä»£ç å‡†åˆ™æŠ›ä¹‹è„‘åäº†ï¼Œå¯èƒ½å› ä¸ºå„ç§åŸå› ï¼Œå·¥æœŸç´§å¼ æˆ–è€…å°±æ˜¯è‡ªå·±æ‡’æƒ°çš„æ€æƒ³ä½œæ€ªï¼Œäºæ˜¯ä»£ç å°±è¶Šå†™è¶Šçƒ‚äº†ï¼Œæœ‰ä¸€å¤©è¿è‡ªå·±ä¹Ÿæ‡’å¾—çœ‹è¿™ç©æ„äº†ï¼Œå½“éœ€æ±‚æ”¹åŠ¨çš„æ—¶å€™å°±ä¼šå˜æˆæ‰€æœ‰äººéƒ½ç—›è‹¦çš„æ—¶å€™ï¼Œæ‰€ä»¥åœ¨å†™ä»£ç çš„æ—¶å€™èŠ±ä¸€ç‚¹æ—¶é—´æ˜¯ç¢ç£¨ä¸€ä¸‹å‡†å¤‡æ˜¯éå¸¸æœ‰å¿…è¦çš„ï¼Œè¿™äº›éƒ½æ˜¯å‰äººæ€»ç»“å‡ºæ¥ç»éªŒã€‚\n","date":"2022-05-02T22:51:57Z","permalink":"https://dccmmtop.github.io/posts/%E6%9E%B6%E6%9E%84%E6%95%B4%E6%B4%81%E4%B9%8B%E9%81%93%E4%B9%A6%E6%91%98%E4%B8%80/","section":"posts","tags":["æ¶æ„"],"title":"æ¶æ„æ•´æ´ä¹‹é“ä¹¦æ‘˜ä¸€"},{"categories":null,"contents":"å½“æŸ¥è¯¢å‘½ä¸­ç¼“å­˜æ—¶ï¼Œç«‹å³è¿”å›ç»“æœã€‚è·³è¿‡äº†è§£æ ä¼˜åŒ–å’Œæ‰§è¡Œé˜¶æ®µ\né¸¡è‚‹ æŸ¥è¯¢ç¼“å­˜åœ¨å¤§éƒ¨åˆ†æ—¶å€™éƒ½å¾ˆé¸¡è‚‹ï¼Œ åœ¨ 5.8 ç‰ˆæœ¬å·²ç»å°†æŸ¥è¯¢ç¼“å­˜å»æ‰äº†\nä¸‹é¢å‡ ä¸ªç‰¹æ€§æ˜¯å®ƒé¸¡è‚‹çš„è¯æ®:\nä»€ä¹ˆæ—¶å€™ä¸ä¼šè¢«ç¼“å­˜ æŸ¥è¯¢æ¶‰åŠçš„ç›¸å…³è¡¨æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿä¼šè·Ÿè¸ªæŸ¥è¯¢ä¸­æ¶‰åŠçš„æ¯ä¸ªè¡¨ï¼Œå¦‚æœè¿™äº›è¡¨å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå’Œè¿™ä¸ªè¡¨ç›¸å…³çš„æ‰€æœ‰çš„ç¼“å­˜æ•°æ®éƒ½å°†å¤±æ•ˆã€‚è¿™ç§æœºåˆ¶æ•ˆç‡çœ‹èµ·æ¥æ¯”è¾ƒä½ï¼Œå› ä¸ºæ•°æ®è¡¨å˜åŒ–æ—¶å¾ˆæœ‰å¯èƒ½å¯¹åº”çš„æŸ¥è¯¢ç»“æœå¹¶æ²¡æœ‰å˜æ›´ï¼Œä½†æ˜¯è¿™ç§ç®€å•å®ç°ä»£ä»·å¾ˆå°ï¼Œè€Œè¿™ç‚¹å¯¹äºä¸€ä¸ªéå¸¸ç¹å¿™çš„ç³»ç»Ÿæ¥è¯´éå¸¸é‡è¦ã€‚\næŸ¥è¯¢è¯­å¥ä»»ä½•ç»†å¾®å˜åŒ–æ—¶ MySqlå°†æŸ¥è¯¢ç»“æœå­˜æ”¾åœ¨å¼•ç”¨è¡¨ä¸­ï¼Œé€šè¿‡ä¸€ä¸ªå“ˆå¸Œå€¼å¼•ç”¨ï¼Œè¿™ä¸ªå“ˆå¸Œå€¼åŒ…å«äº†å¦‚ä¸‹å› ç´ ï¼ŒæŸ¥è¯¢æœ¬èº«ã€è¦æŸ¥è¯¢å¾—æ•°æ®åº“ã€å®¢æˆ·ç«¯åè®®çš„ç‰ˆæœ¬ç­‰å…¶ä»–å¯èƒ½ä¼šå½±å“è¿”å›ç»“æœçš„ä¿¡æ¯ï¼Œ\nåˆ¤æ–­ç¼“å­˜æ˜¯å¦å‘½ä¸­æ—¶ï¼ŒMySqlä¸ä¼šè§£æã€å‚æ•°åŒ–ã€ä»»ä½•è§„æ•´æŸ¥è¯¢sqlçš„æ“ä½œï¼Œç›´æ¥ä½¿ç”¨å®¢æˆ·ç«¯å‘æ¥çš„åŸå§‹sqlè¯­å¥ã€‚ä»»ä½•å­—ç¬¦ä¸Šçš„ä¸åŒï¼Œå¦‚ç©ºæ ¼ã€æ³¨é‡Šéƒ½ä¼šå¯¼è‡´ç¼“å­˜ä¸è¢«å‘½ä¸­ã€‚\næŸ¥è¯¢è¯­å¥ä¸­æœ‰ä¸ç¡®å®šæ•°æ®æ—¶ åŒ…å« NOW() ã€ CURRENT_DATE() ã€CURRENT_USER() ã€CONNECTION_ID() ç­‰å˜åŒ–çš„ä¿¡æ¯ åŒ…å«ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ï¼Œå­˜å‚¨å‡½æ•°ï¼Œç”¨æˆ·å˜é‡ï¼Œä¸´æ—¶è¡¨ï¼ŒMySQLç³»ç»Ÿè¡¨ ç­‰ åŒ…å« å­æŸ¥è¯¢ï¼Œå­˜å‚¨è¿‡ç¨‹ï¼ˆå­æŸ¥è¯¢çš„sqlä¸æ˜¯å®Œæ•´çš„ï¼Œè€Œæ˜¯è¿è¡Œæ—¶è¢«è®¡ç®—å‡ºæ¥çš„ï¼‰ æŸ¥è¯¢ç»“æœå¤ªå¤§ æŸ¥è¯¢ç¼“å­˜å†…å­˜ç”¨å®Œ å¦‚æœæŸ¥è¯¢è¯­å¥ä¸­åŒ…å«ä»»ä½•çš„ä¸ç¡®å®šå‡½æ•°ï¼Œé‚£ä¹ˆåœ¨æŸ¥è¯¢ç¼“å­˜ä¸­æ˜¯ä¸å¯ èƒ½æ‰¾åˆ°ç¼“å­˜ç»“æœçš„ã€‚å› ä¸ºå³ä½¿ä¹‹å‰åˆšåˆšæ‰§è¡Œäº†è¿™æ ·çš„æŸ¥è¯¢ï¼Œç»“æœä¹Ÿä¸ä¼šæ”¾åœ¨æŸ¥è¯¢ç¼“å­˜ä¸­ã€‚ MySQLåœ¨ä»»ä½•æ—¶å€™åªè¦å‘ç°ä¸èƒ½è¢«ç¼“å­˜çš„éƒ¨åˆ†ï¼Œå°±ä¼šç¦æ­¢è¿™ä¸ªæŸ¥è¯¢è¢«ç¼“å­˜ã€‚\næŸ¥è¯¢ç¼“å­˜çš„ç¼ºç‚¹ å¯¹è¯»å’Œå†™æ“ä½œå¸¦æ¥é¢å¤–çš„æ¶ˆè€— è¯»æŸ¥è¯¢åœ¨å¼€å§‹ä¹‹å‰å¿…é¡»å…ˆæ£€æŸ¥æ˜¯å¦å‘½ä¸­ç¼“å­˜ MySqlæ‰§è¡Œå®ŒSQLæ—¶ï¼Œå¦‚æœè¯¥SQLå¯ä»¥ç¼“å­˜ï¼Œä½†æ˜¯æ­¤æ—¶è¿˜æ²¡è¢«ç¼“å­˜ï¼Œä¼šå°†æ•°æ®å†™å…¥ç¼“å­˜ä¸­ å½±å“å†™æ“ä½œï¼Œæ‰§è¡Œå†™å…¥æ“ä½œæ—¶ï¼Œå°†æ­¤è¡¨å¯¹åº”çš„æ‰€æœ‰ç¼“å­˜éƒ½è®¾ç½®å¤±æ•ˆã€‚å¯¹æŸ¥è¯¢ç¼“å­˜å¤±æ•ˆçš„æ“ä½œæ˜¯é å…¨å±€é”ä¿æŠ¤çš„ã€‚é˜²æ­¢æ­¤æ—¶åˆè¢«ç¼“å­˜äº†æ—§æ•°æ®ã€‚æ‰€æœ‰ä¸è¯¥è¡¨ç›¸å…³çš„æŸ¥è¯¢éƒ½è¦ç­‰å¾…è¯¥é”ã€‚æ— è®ºæ­¤æŸ¥è¯¢æ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼Œä»¥åŠæ£€æµ‹ç¼“å­˜æ˜¯å¦å¤±æ•ˆã€‚ å¦‚æœç¼“å­˜å¤§ï¼Œæˆ–è€…ç¢ç‰‡å¾ˆå¤šï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å¾ˆå¤§çš„ç³»ç»Ÿæ¶ˆè€—ã€‚ï¼ˆè®¾ç½®äº†å¾ˆå¤§çš„æŸ¥è¯¢ç¼“å­˜çš„æ—¶å€™ï¼‰ äº‹åŠ¡å¯¹æŸ¥è¯¢ç¼“å­˜çš„å½±å“ å¯¹InnoDBç”¨æˆ·æ¥è¯´ï¼Œäº‹åŠ¡çš„ä¸€äº›ç‰¹æ€§ä¼šé™åˆ¶æŸ¥è¯¢ç¼“å­˜çš„ä½¿ç”¨ã€‚å½“ä¸€ä¸ªè¯­å¥åœ¨äº‹åŠ¡ä¸­ä¿®æ”¹äº†æŸä¸ªè¡¨ï¼ŒMySQLä¼šå°†è¿™ä¸ªè¡¨çš„å¯¹åº”çš„æŸ¥è¯¢ç¼“å­˜éƒ½è®¾ç½®å¤±æ•ˆï¼Œè€Œäº‹å®ä¸Šï¼ŒInnoDBçš„å¤šç‰ˆæœ¬ç‰¹æ€§ä¼šæš‚æ—¶å°†è¿™ä¸ªä¿®æ”¹å¯¹å…¶ä»–äº‹åŠ¡å±è”½ã€‚åœ¨è¿™ä¸ªäº‹åŠ¡æäº¤ä¹‹å‰ï¼Œè¿™ä¸ªè¡¨çš„ç›¸å…³æŸ¥è¯¢æ˜¯æ— æ³•è¢«ç¼“å­˜çš„ï¼Œæ‰€ä»¥æ‰€æœ‰åœ¨è¿™ä¸ªè¡¨ä¸Šé¢çš„æŸ¥è¯¢ä¸€å†…éƒ¨æˆ–å¤–éƒ¨çš„äº‹åŠ¡â€”â€”éƒ½åªèƒ½åœ¨è¯¥äº‹åŠ¡æäº¤åæ‰è¢«ç¼“å­˜ã€‚å› æ­¤ï¼Œé•¿æ—¶é—´è¿è¡Œçš„äº‹åŠ¡ï¼Œä¼šå¤§å¤§é™ä½æŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡ã€‚\nç¼“å­˜å¯¹ç³»ç»Ÿçš„å½±å“ åªæœ‰å½“ç¼“å­˜å¸¦æ¥çš„èµ„æºèŠ‚çº¦å¤§äºå…¶æœ¬èº«çš„èµ„æºæ¶ˆè€—æ—¶æ‰ä¼šç»™ç³»ç»Ÿå¸¦æ¥æ€§èƒ½æå‡\né€‚åˆåšç¼“å­˜çš„æŸ¥è¯¢ æ±‡æ€»æŸ¥è¯¢ï¼Œå¦‚ count, max ç­‰ å¤æ‚çš„æŸ¥è¯¢ï¼Œä½†ç»“æœå°‘ã€‚å¦‚å¤šè¡¨å…³è”åéœ€è¦åˆ†ç»„ï¼Œæ’åºåœ¨åˆ†é¡µçš„æŸ¥è¯¢ã€‚åŒæ—¶æ¶‰åŠçš„è¡¨æ›´æ–°æ“ä½œå°‘äºæŸ¥è¯¢æ“ä½œï¼Œé˜²æ­¢ç¼“å­˜é¢‘å‘å¤±æ•ˆ å‘½ä¸­ç‡çš„è®¡ç®— ä¸€ä¸ªåˆ¤æ–­æŸ¥è¯¢ç¼“å­˜æ˜¯å¦æœ‰æ•ˆçš„ç›´æ¥æ•°æ®æ˜¯å‘½ä¸­ç‡ï¼Œå°±æ˜¯ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜è¿”å›ç»“æœå æ€»æŸ¥è¯¢çš„æ¯”ç‡ã€‚å½“MySQLæ¥æ”¶åˆ°ä¸€ä¸ªSELECTæŸ¥è¯¢çš„æ—¶å€™ï¼Œè¦ä¹ˆå¢åŠ Qcache hitsçš„å€¼ï¼Œè¦ä¹ˆå¢åŠ Com selectçš„å€¼ã€‚æ‰€ä»¥æŸ¥è¯¢ç¼“å­˜å‘½ä¸­ç‡å¯ä»¥ç”±å¦‚ä¸‹å…¬å¼è®¡ç®—ï¼šQcache hits / (Qcache hits+Com select)\nå‘½ä¸­ç‡ä½ä¸ä»£è¡¨æ€§èƒ½æå‡å°‘ ä¸è¿‡ï¼ŒæŸ¥è¯¢ç¼“å­˜å‘½ä¸­ç‡æ˜¯ä¸€ä¸ªå¾ˆéš¾åˆ¤æ–­çš„æ•°å€¼ã€‚å‘½ä¸­ç‡å¤šå¤§æ‰æ˜¯å¥½çš„å‘½ä¸­ç‡ï¼Ÿå…·ä½“æƒ…å†µè¦å…·ä½“åˆ†æã€‚åªè¦æŸ¥è¯¢ç¼“å­˜å¸¦æ¥çš„æ•ˆç‡æå‡å¤§äºæŸ¥è¯¢ç¼“å­˜å¸¦æ¥çš„é¢å¤–æ¶ˆè€—ï¼Œå³ä½¿30%å‘½ä¸­ç‡å¯¹ç³»ç»Ÿæ€§èƒ½æå‡ä¹Ÿæœ‰å¾ˆå¤§å¥½å¤„ã€‚å¦å¤–ï¼Œç¼“å­˜äº†å“ªäº›æŸ¥è¯¢ä¹Ÿå¾ˆé‡è¦ï¼Œä¾‹å¦‚ï¼Œè¢«ç¼“å­˜çš„æŸ¥è¯¢æœ¬èº«æ¶ˆè€—éå¸¸å·¨å¤§ï¼Œé‚£ä¹ˆå³ä½¿ç¼“å­˜å‘½ä¸­ç‡éå¸¸ä½ï¼Œä¹Ÿä»ç„¶ä¼šå¯¹ç³»ç»Ÿæ€§èƒ½æå‡æœ‰å¥½å¤„ã€‚æ‰€ä»¥ï¼Œæ²¡æœ‰ä¸€ä¸ªç®€å•çš„è§„åˆ™å¯ä»¥åˆ¤æ–­æŸ¥è¯¢ç¼“å­˜æ˜¯å¦å¯¹ç³»ç»Ÿæœ‰å¥½å¤„ã€‚\nå‘½ä¸­å’Œå†™å…¥çš„æ¯”ç‡ å³Qcache hitså’ŒQcache insertsçš„æ¯”å€¼ã€‚æ ¹æ®ç»éªŒæ¥çœ‹ï¼Œå½“è¿™ä¸ªæ¯”å€¼å¤§äº3ï¼š1æ—¶é€šå¸¸æŸ¥è¯¢ç¼“å­˜æ˜¯æœ‰æ•ˆçš„ï¼Œä¸è¿‡è¿™ä¸ªæ¯”ç‡æœ€å¥½èƒ½å¤Ÿè¾¾åˆ°10ï¼š1ã€‚å¦‚æœä½ çš„åº”ç”¨æ²¡æœ‰è¾¾åˆ°è¿™ä¸ªæ¯”ç‡ï¼Œé‚£ä¹ˆå°±å¯ä»¥è€ƒè™‘ç¦ç”¨æŸ¥è¯¢ç¼“å­˜äº†ï¼Œé™¤éä½ èƒ½å¤Ÿé€šè¿‡ç²¾ç¡®çš„è®¡ç®—å¾—çŸ¥ï¼šå‘½ä¸­å¸¦æ¥çš„æ€§èƒ½æå‡å¤§äºç¼“å­˜å¤±æ•ˆçš„æ¶ˆè€—ï¼Œå¹¶ä¸”æŸ¥è¯¢ç¼“å­˜å¹¶æ²¡æœ‰æˆä¸ºç³»ç»Ÿçš„ç“¶é¢ˆã€‚\nç¼“å­˜å¤±æ•ˆçš„ä¸€äº›æŒ‡æ ‡æ£€æŸ¥ æ›´æ–°å¯¼è‡´\nå¯ä»¥é€šè¿‡å‚æ•°Com*æ¥æŸ¥çœ‹æ•°æ®ä¿®æ”¹çš„æƒ…å†µï¼ˆåŒ…æ‹¬Com update,Com delete,ç­‰ç­‰) ç¼“å­˜ç©ºé—´ä¸è¶³\né€šè¿‡Qcache lowmem prunesæ¥æŸ¥çœ‹æœ‰å¤šå°‘æ¬¡å¤±æ•ˆæ˜¯ç”±äºå†…å­˜ä¸è¶³å¯¼è‡´çš„. ç¼“å­˜çš„æ•°æ®æ²¡æœ‰è¢«æŸ¥è¯¢\næŸ¥çœ‹Com selectå’ŒQcache insertsçš„ç›¸å¯¹å€¼ã€‚\nå¦‚æœæ¯æ¬¡æŸ¥è¯¢æ“ä½œéƒ½æ˜¯ç¼“å­˜æœªå‘½ä¸­ï¼Œç„¶åéœ€è¦å°†æŸ¥è¯¢ç»“æœæ”¾åˆ°ç¼“å­˜ä¸­ï¼Œé‚£ä¹ˆQcache insertsçš„å¤§å°åº”è¯¥å’ŒCom selectç›¸å½“ã€‚æ‰€ä»¥åœ¨ç¼“å­˜å®Œæˆé¢„çƒ­åï¼Œæˆ‘ä»¬æ€»å¸Œ æœ›çœ‹åˆ°Qcache insertsè¿œè¿œå°äºCom selectã€‚ä¸è¿‡ç”±äºç¼“å­˜å’ŒæœåŠ¡å™¨å†…éƒ¨çš„å¤æ‚å’Œå¤šæ ·æ€§ï¼Œä»ç„¶å¾ˆéš¾è¯´ï¼Œè¿™ä¸ªæ¯”ç‡æ˜¯å¤šå°‘æ‰æ˜¯ä¸€ä¸ªåˆé€‚çš„å€¼ã€‚ ç¼“å­˜ç©ºé—´çš„è®¾ç½®å’Œä½¿ç”¨ å¹¶éè¶Šå¤§è¶Šå¥½ æ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºéƒ½ä¼šæœ‰ä¸€ä¸ªâ€œæœ€å¤§ç¼“å­˜ç©ºé—´â€ï¼Œç”šè‡³å¯¹ä¸€äº›çº¯è¯»çš„åº”ç”¨æ¥è¯´ä¹Ÿä¸€æ ·ã€‚æœ€å¤§ç¼“å­˜ç©ºé—´æ˜¯èƒ½å¤Ÿç¼“å­˜æ‰€æœ‰å¯èƒ½æŸ¥è¯¢ç»“æœçš„ç¼“å­˜ç©ºé—´æ€»å’Œã€‚ç†è®ºä¸Šï¼Œå¯¹å¤šæ•°åº”ç”¨æ¥è¯´ï¼Œ è¿™ä¸ªæ•°å€¼éƒ½ä¼šéå¸¸å¤§ã€‚è€Œå®é™…ä¸Šï¼Œç”±äºç¼“å­˜å¤±æ•ˆçš„åŸå› ï¼Œå¤§å¤šæ•°åº”ç”¨æœ€åä½¿ç”¨çš„ç¼“å­˜ç©ºé—´éƒ½æ¯”é¢„æƒ³çš„è¦å°ã€‚å³ä½¿ä½ é…ç½®äº†è¶³å¤Ÿå¤§çš„ç¼“å­˜ç©ºé—´ï¼Œç”±äºä¸æ–­åœ°å¤±æ•ˆï¼Œå¯¼è‡´ç¼“å­˜ç©ºé—´ ä¸€ç›´éƒ½ä¸ä¼šæ¥è¿‘â€œæœ€å¤§ç¼“å­˜ç©ºé—´â€\nè®¾ç½®ä¸€ä¸ªåˆç†å€¼ é€šå¸¸å¯ä»¥é€šè¿‡è§‚å¯ŸæŸ¥è¯¢ç¼“å­˜å†…å­˜çš„å®é™…ä½¿ç”¨æƒ…å†µï¼Œæ¥ç¡®å®šæ˜¯å¦éœ€è¦ç¼©å°æˆ–è€…æ‰©å¤§æŸ¥è¯¢ç¼“å­˜ã€‚å¦‚æœæŸ¥è¯¢ç¼“å­˜ç©ºé—´é•¿æ—¶é—´éƒ½æœ‰å‰©ä½™ï¼Œé‚£ä¹ˆå»ºè®®ç¼©å°ï¼›å¦‚æœç»å¸¸ç”±äºç©ºé—´ä¸è¶³è€Œå¯¼è‡´æŸ¥è¯¢ç¼“å­˜å¤±æ•ˆï¼Œé‚£ä¹ˆåˆ™éœ€è¦å¢å¤§æŸ¥è¯¢ç¼“å­˜ã€‚ä¸è¿‡éœ€è¦æ³¨æ„ï¼Œå¦‚æœæŸ¥è¯¢ç¼“å­˜è¾¾åˆ°äº†å‡ åå…† è¿™æ ·çš„æ•°é‡çº§ï¼Œæ˜¯æœ‰æ½œåœ¨å±é™©çš„ã€‚ï¼ˆè¿™å’Œç¡¬ä»¶ä»¥åŠç³»ç»Ÿå‹åŠ›å¤§å°æœ‰å…³)ã€‚\næŸ¥è¯¢ç¼“å­˜çš„ä¸€äº›é…ç½®å‚æ•° ç”±äºæŸ¥è¯¢ç¼“å­˜è¿™ç§é¸¡è‚‹çš„ç‰¹æ€§ï¼ŒMySQL æä¾›ä¸€ä¸­æŒ‰ç…§éœ€æ±‚å†³å®šæ˜¯å¦ä½¿ç”¨ æŸ¥è¯¢ç¼“å­˜ï¼Œå°†å†³å®šæƒäº¤ç»™äº†ç”¨æˆ·:\né…ç½®æ–‡ä»¶ my.cnf\nquery_cache_typeæœ‰3ä¸ªå€¼ 0ä»£è¡¨å…³é—­æŸ¥è¯¢ç¼“å­˜OFFï¼Œ1ä»£è¡¨å¼€å¯ONï¼Œ2ï¼ˆDEMANDï¼‰ä»£è¡¨å½“sqlè¯­å¥ä¸­æœ‰SQL_CACHE å…³é”®è¯æ—¶æ‰ç¼“å­˜\nquery_cache_type=2 æŸ¥çœ‹å½“å‰mysqlå®ä¾‹æ˜¯å¦å¼€å¯ç¼“å­˜æœºåˆ¶ show global variables like \u0026#34;%query_cache_type%\u0026#34;; ç›‘æ§æŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡: show status like\u0026#39;%Qcache%\u0026#39;; //æŸ¥çœ‹è¿è¡Œçš„ç¼“å­˜ä¿¡æ¯ Qcache_free_blocks:è¡¨ç¤ºæŸ¥è¯¢ç¼“å­˜ä¸­ç›®å‰è¿˜æœ‰å¤šå°‘å‰©ä½™çš„blocksï¼Œå¦‚æœè¯¥å€¼æ˜¾ç¤ºè¾ƒå¤§ï¼Œåˆ™è¯´æ˜æŸ¥è¯¢ç¼“å­˜ä¸­çš„å†…å­˜ç¢ç‰‡è¿‡å¤šäº†ï¼Œå¯èƒ½åœ¨ä¸€å®šçš„æ—¶é—´è¿›è¡Œæ•´ç†ã€‚ Qcache_free_memory:æŸ¥è¯¢ç¼“å­˜çš„å†…å­˜å¤§å°ï¼Œé€šè¿‡è¿™ä¸ªå‚æ•°å¯ä»¥å¾ˆæ¸…æ™°çš„çŸ¥é“å½“å‰ç³»ç»Ÿçš„æŸ¥è¯¢å†…å­˜æ˜¯å¦å¤Ÿç”¨ï¼Œæ˜¯å¤šäº†ï¼Œè¿˜æ˜¯ä¸å¤Ÿç”¨ï¼ŒDBAå¯ä»¥æ ¹æ®å®é™…æƒ…å†µåšå‡ºè°ƒæ•´ã€‚ Qcache_hits:è¡¨ç¤ºæœ‰å¤šå°‘æ¬¡å‘½ä¸­ç¼“å­˜ã€‚æˆ‘ä»¬ä¸»è¦å¯ä»¥é€šè¿‡è¯¥å€¼æ¥éªŒè¯æˆ‘ä»¬çš„æŸ¥è¯¢ç¼“å­˜çš„æ•ˆæœã€‚æ•°å­—è¶Šå¤§ï¼Œç¼“å­˜æ•ˆæœè¶Šç†æƒ³ã€‚ Qcache_inserts: è¡¨ç¤ºå¤šå°‘æ¬¡æœªå‘½ä¸­ç„¶åæ’å…¥ï¼Œæ„æ€æ˜¯æ–°æ¥çš„SQLè¯·æ±‚åœ¨ç¼“å­˜ä¸­æœªæ‰¾åˆ°ï¼Œä¸å¾—ä¸æ‰§è¡ŒæŸ¥è¯¢å¤„ç†ï¼Œæ‰§è¡ŒæŸ¥è¯¢å¤„ç†åæŠŠç»“æœinsertåˆ°æŸ¥è¯¢ç¼“å­˜ä¸­ã€‚è¿™æ ·çš„æƒ…å†µçš„æ¬¡æ•°ï¼Œæ¬¡æ•°è¶Šå¤šï¼Œè¡¨ç¤ºæŸ¥è¯¢ç¼“å­˜åº”ç”¨åˆ°çš„æ¯”è¾ƒå°‘ï¼Œæ•ˆæœä¹Ÿå°±ä¸ç† æƒ³ã€‚å½“ç„¶ç³»ç»Ÿåˆšå¯åŠ¨åï¼ŒæŸ¥è¯¢ç¼“å­˜æ˜¯ç©ºçš„ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚ Qcache_lowmem_prunes:è¯¥å‚æ•°è®°å½•æœ‰å¤šå°‘æ¡æŸ¥è¯¢å› ä¸ºå†…å­˜ä¸è¶³è€Œè¢«ç§»é™¤å‡ºæŸ¥è¯¢ç¼“å­˜ã€‚é€šè¿‡è¿™ä¸ªå€¼ï¼Œç”¨æˆ·å¯ä»¥é€‚å½“çš„è°ƒæ•´ç¼“å­˜å¤§å°ã€‚ Qcache_not_cached: è¡¨ç¤ºå› ä¸ºquery_cache_typeçš„è®¾ç½®è€Œæ²¡æœ‰è¢«ç¼“å­˜çš„æŸ¥è¯¢æ•°é‡ã€‚ Qcache_queries_in_cache:å½“å‰ç¼“å­˜ä¸­ç¼“å­˜çš„æŸ¥è¯¢æ•°é‡ã€‚ Qcache_total_blocks:å½“å‰ç¼“å­˜çš„blockæ•°é‡ å‚è€ƒèµ„æ–™ ã€Šé«˜æ€§èƒ½MySqlã€‹ ","date":"2022-04-24T22:56:45Z","permalink":"https://dccmmtop.github.io/posts/mysql%E4%B8%AD%E7%9A%84%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98/","section":"posts","tags":["MySQL"],"title":"mysqlä¸­çš„æŸ¥è¯¢ç¼“å­˜"},{"categories":null,"contents":"åŸºå‡†æµ‹è¯• http_load å¯ä»¥é€šè¿‡ä¸€ä¸ªè¾“å…¥æ–‡ä»¶æä¾›å¤šä¸ª URLï¼ŒHpttp_load åœ¨è¿™äº› URL ä¸­éšæœºé€‰æ‹©è¿›è¡Œæµ‹è¯•ã€‚\nä¹Ÿå¯ä»¥å®šåˆ¶ axtp_1oadï¼Œä½¿å…¶æŒ‰ç…§æ—¶é—´æ¯”ç‡è¿›è¡Œæµ‹è¯•ï¼Œè€Œä¸ä»…ä»…æ˜¯æµ‹è¯•æœ€å¤§è¯·æ±‚å¤„ç†\nä¸‹é¢é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ http_1oadã€‚é¦–å…ˆåˆ›å»ºä¸€ä¸ª urls.txtæ–‡ä»¶ï¼Œè¾“å…¥\nå¦‚ä¸‹çš„ URL :\nhttp://ww.mysqlperformanceblog.com/\rhttp: //www.mysqlperformanceblog.com/page/2/\rhttp: //www.mysqlperformanceblog .com/mysql-patches/\rhttp: //www.mysqlperformanceblog . com/mysql-performance-presentations/\rhttp: //www.mysqlperformanceblog . com/2006/09/06/slow-query-log-analyzes-tools/ hitp_load æœ€ç®€å•çš„ç”¨æ³•ï¼Œå°±æ˜¯å¾ªç¯è¯·æ±‚ç»™å®šçš„ URL åˆ—è¡¨ã€‚æµ‹è¯•ç¨‹åºå°†ä»¥æœ€å¿«çš„é€Ÿåº¦è¯·\næ±‚è¿™äº› URL :\n$ http_load -parallel 1 -seconds 10 urls.txt\r19 fetches, 1 max parallel, 837929 bytes, in 10.0003 seconds\r44101.5 mean bytes/connection\r1.89995 fetches/sec, 83790.7 bytes/sec\rmsecs/connect: 41.6647 mean, 56.156 max, 38.21 min\rmsecs/first-response: 320.207 mean, 508.958 max, 179.308 min\rHTTP response codes:\rcode 200 - 19 æµ‹è¯•çš„ç»“æœå¾ˆå®¹æ˜“ç†è§£ï¼Œåªæ˜¯ç®€å•åœ°è¾“å‡ºäº†è¯·æ±‚çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯å¦å¤–ä¸€ä¸ªç¨å¾®å¤æ‚\nçš„æµ‹è¯•ï¼Œè¿˜æ˜¯å°½å¯èƒ½å¿«åœ°å¾ªç¯è¯·æ±‚ç»™å®šçš„ URL åˆ—è¡¨ï¼Œä¸è¿‡æ¨¡æ‹ŸåŒæ—¶æœ‰äº”ä¸ªå¹¶å‘ç”¨æˆ·åœ¨\nè¿›è¡Œè¯·æ±‚ ;\n$ http_load -parallel 5 -seconds 10 urls.txt\r94 fetches, 5 max parallel, 4.75565e+06 bytes, in 10.0005 seconds\r50592 mean bytes/connection\r9.39953 fetches/sec, 475541 bytes/sec\rmsecs/connect: 65.1983 mean, 169.991 max, 38.189 min\rmsecs/first-response: 245.014 mean, 993.059 max, 99.646 min\rHTTP response codes:\rcode 200 - 94 å¦å¤–ï¼Œé™¤äº†æµ‹è¯•æœ€å¿«çš„é€Ÿåº¦ï¼Œä¹Ÿå¯ä»¥æ ¹æ®é¢„ä¼°çš„è®¿é—®è¯·æ±‚ç‡ ã€ˆæ¯”å¦‚æ¯ç§’ 5 æ¬¡) æ¥åšå‹åŠ›\næ¨¡æ‹Ÿæµ‹è¯•ã€‚\n$ http_load -rate 5 -seconds 10 urls.txt\r48 fetches, 4 max parallel, 2.50104e+06 bytes, in 10 seconds\r52105 mean bytes/connection\r4.8 fetches/sec, 250104 bytes/sec\rmsecs/connect: 42.5931 mean, 60.462 max, 38.117 min\rmsecs/first-response: 246.811 mean, 546.203 max, 108.363 min\rHTTP response codes:\rcode 200 - 48 æœ€åï¼Œè¿˜å¯ä»¥æ¨¡æ‹Ÿæ›´å¤§çš„è´Ÿè½½ï¼Œå¯ä»¥å°†è®¿é—®è¯·æ±‚ç‡æé«˜åˆ°æ¯ç§’ 20 æ¬¡è¯·æ±‚ã€‚è¯·æ³¨æ„ï¼Œè¿\næ¥å’Œè¯·æ±‚å“åº”æ—¶é—´éƒ½ä¼šéšç€è´Ÿè½½çš„æé«˜è€Œå¢åŠ ã€‚\n$ http_load -rate 20 -seconds 10 urls.txt\r111 fetches, 89 max parallel, 5.91142e+06 bytes, in 10.0001 seconds\r53256.1 mean bytes/connection\r11.0998 fetches/sec, 591134 bytes/sec\rmsecs/connect: 100.384 mean, 211.885 max, 38.214 min\rmsecs/first-response: 2163.51 mean, 7862.77 max, 933.708 min\rHTTP response codes:\rcode 200 -- 111 sysbench sysbench çš„ CPU åŸºå‡†æµ‹è¯•\næœ€å…¸å‹çš„å­ç³»ç»Ÿæµ‹è¯•å°±æ˜¯ CPU åŸºå‡†æµ‹è¯•ã€‚è¯¥æµ‹è¯•ä½¿ç”¨ 64 ä½æ•´æ•°ï¼Œæµ‹è¯•è®¡ç®—ç´ æ•°ç›´åˆ°æŸ\nä¸ªæœ€å¤§å€¼æ‰€éœ€è¦çš„æ—¶é—´ã€‚ ä¸‹é¢çš„ä¾‹å­å°†æ¯”è¾ƒä¸¤å°ä¸åŒçš„GNU/Linux æœåŠ¡å™¨ä¸Šçš„æµ‹è¯•ç»“æœã€‚\nç¬¬ä¸€å°æœºå™¨çš„ CPU é…ç½®å¦‚ä¸‹ :\n[servert ~]$ cat /proc/cpuinfo\rmodel nane + AMD Opteron(tm) Processor 246\rstepping a\rcpu Miz + 192.857\rcache size: 1024 KB è¿™å°æœåŠ¡å™¨ä¸Šè¿è¡Œå¦‚ä¸‹çš„æµ‹è¯• :\n[serverl ~]$ sysbench -testccpu -cpu-max-prime=20000 run\rsysbench v0.4.8: multithreaded system evaluation benchnark\rTest execution summary: total tine: 121.74048 ç¬¬äºŒå°æœåŠ¡å™¨é…ç½®äº†ä¸åŒçš„ CPU ï¼Œ\n[server2 ~]$ cat /proc/cpuinfo\rmodel name: Intel(R) Xeon(R) CPU 5130 @ 2.00GH2\rstepping\rcpu Miz æµ‹è¯•ç»“æœå¦‚ä¸‹ :\n[serverl ~]$ sysbench --test=cpu --cpu-max-prime=20000 run\rsysbench v0.4.8: multithreaded system evaluation benchnark\rTest execution summary: total time: 6.85965 æµ‹è¯•çš„ç»“æœç®€å•æ‰“å°å‡ºäº†è®¡ç®—å‡ºç´ æ•°çš„æ—¶é—´ï¼Œå¾ˆå®¹æ˜“è¿›è¡Œæ¯”è¾ƒã€‚åœ¨ä¸Šé¢çš„æµ‹è¯•ä¸­ï¼Œç¬¬äºŒ\näººå°æœåŠ¡å™¨çš„æµ‹è¯•ç»“æœæ˜¾ç¤ºæ¯”ç¬¬ä¸€å°å¿«ä¸¤å€ã€‚\n","date":"2022-04-14T00:00:02Z","permalink":"https://dccmmtop.github.io/posts/%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/","section":"posts","tags":["MySQL"],"title":"åŸºå‡†æµ‹è¯•"},{"categories":null,"contents":"ä»€ä¹ˆæ˜¯å­—ç¬¦é›†ï¼Œä»€ä¹ˆæ˜¯æ’åºè§„åˆ™ å­—ç¬¦é›†æ˜¯åªä»äºŒè¿›åˆ¶ç¼–ç åˆ°æŸç±»å­—ç¬¦ç¬¦å·çš„æ˜ å°„ï¼Œè¯¥å­—ç¬¦é›†çš„æ’åºè§„åˆ™ç®€ç§°æ ¡å¯¹ï¼Œ\nå¦‚ ASCIIç ï¼Œä¸€ä¸ªå­—èŠ‚å°±å¯ä»¥è¡¨ç¤ºä¸€ä¸ªè‹±æ–‡å­—æ¯ï¼Œå‚ç…§ASCIIç è¡¨\nä¸ºä»€ä¹ˆéœ€è¦å­—ç¬¦é›† å› ä¸ºäººç±»æ— æ³•ç›´æ¥ç†è§£äºŒè¿›åˆ¶æ‰€è¡¨ç¤ºçš„å«ä¹‰ï¼Œéœ€è¦è½¬æ¢\nå¤šå­—èŠ‚å­—ç¬¦é›† ä¸€ä¸ªå­—ç¬¦å ç”¨è¶…è¿‡ä¸€ä¸ªå­—èŠ‚çš„å­—ç¬¦é›†å«åšå¤šå­—èŠ‚å­—ç¬¦é›†\nä¾‹å¦‚ UTF-8\nå¸¸è§å­—ç¬¦é›† 1ï¼ŒASCIIç ï¼šä¸€ä¸ªè‹±æ–‡å­—æ¯ï¼ˆä¸åˆ†å¤§å°å†™ï¼‰å ä¸€ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œä¸€ä¸ªä¸­æ–‡æ±‰å­—å ä¸¤ä¸ªå­—èŠ‚çš„ç©ºé—´ã€‚\n2ï¼ŒUTF-8ç¼–ç ï¼šä¸€ä¸ªè‹±æ–‡å­—ç¬¦ç­‰äºä¸€ä¸ªå­—èŠ‚ï¼Œä¸€ä¸ªä¸­æ–‡ï¼ˆå«ç¹ä½“ï¼‰ç­‰äºä¸‰ä¸ªå­—èŠ‚ã€‚ä¸­æ–‡æ ‡ç‚¹å ä¸‰ä¸ªå­—èŠ‚ï¼Œè‹±æ–‡æ ‡ç‚¹å ä¸€ä¸ªå­—èŠ‚\n3ï¼ŒUnicodeç¼–ç ï¼šä¸€ä¸ªè‹±æ–‡ç­‰äºä¸¤ä¸ªå­—èŠ‚ï¼Œä¸€ä¸ªä¸­æ–‡ï¼ˆå«ç¹ä½“ï¼‰ç­‰äºä¸¤ä¸ªå­—èŠ‚ã€‚ä¸­æ–‡æ ‡ç‚¹å ä¸¤ä¸ªå­—èŠ‚ï¼Œè‹±æ–‡æ ‡ç‚¹å ä¸¤ä¸ªå­—èŠ‚\nMySQL ä¸ºä»€ä¹ˆæä¾›é‚£ä¹ˆå¤šçš„å­—ç¬¦é›†ï¼Œä¸ºä»€ä¹ˆä¸ç»Ÿä¸€ä½¿ç”¨UTF-8 ä¸ºäº†æ€§èƒ½\nåœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥èŠ‚çœç©ºé—´ï¼Œæé«˜æ•ˆç‡ï¼Œä¾‹å¦‚æŸä¸ªå­—æ®µåªæœ‰é˜¿æ‹‰ä¼¯è¯­ï¼Œç›´æ¥ä½¿ç”¨ cp1256 å­—ç¬¦é›†ï¼Œè¯¥å­—ç¬¦é›†åªéœ€ä¸€ä¸ªå­—èŠ‚å°±å¯ä»¥å­˜ä¸‹æ‰€æœ‰é˜¿æ‹‰ä¼¯å­—ç¬¦ã€‚\nå¦‚æœä½¿ç”¨UTF-8å­—ç¬¦é›†ï¼Œä¼šæ¶ˆè€—æ›´å¤šçš„ç©ºé—´\nMySQL æ˜¯å¦‚ä½•è®¾ç½®å­—ç¬¦é›†çš„ åˆ›å»ºå¯¹è±¡æ—¶ï¼ˆå»ºåº“ã€å»ºè¡¨ã€å»ºåˆ—ï¼‰ åº“ \u0026gt; è¡¨ \u0026gt; åˆ—ï¼Œæ¯ä¸ªèŒƒå›´ä¸Šéƒ½æœ‰è‡ªå·±çš„å­—ç¬¦é›†è®¾ç½®ï¼Œé‡‡ç”¨çš„æ—¶ç»§æ‰¿å…³ç³»ã€‚å¦‚æœæ²¡æœ‰æ˜ç¡®æŒ‡å®šå­—ç¬¦é›†ï¼Œåˆ™ç»§æ‰¿ä¸Šä¸€çº§çš„ã€‚\nå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šä¿¡æ—¶ æœåŠ¡å™¨ç«¯æ€»æ˜¯å‡è®¾å®¢æˆ·ç«¯æ˜¯æŒ‰ç…§character set clientè®¾ç½®çš„å­—ç¬¦æ¥ä¼ è¾“æ•°æ®å’ŒSQLè¯­å¥çš„ã€‚ å½“æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯çš„SQLè¯­å¥æ—¶ï¼Œå®ƒå…ˆå°†å…¶è½¬æ¢æˆå­—ç¬¦é›†character_set_connectionã€‚å®ƒè¿˜ä½¿ç”¨è¿™ä¸ªè®¾ç½®æ¥å†³å®šå¦‚ä½•å°†æ•°æ®è½¬æ¢æˆå­—ç¬¦ä¸²ã€‚ å½“æœåŠ¡å™¨ç«¯è¿”å›æ•°æ®æˆ–è€…é”™è¯¯ä¿¡æ¯ç»™å®¢æˆ·ç«¯æ—¶ï¼Œå®ƒä¼šå°†å…¶è½¬æ¢æˆcharacter_set_resultã€‚\nå¦‚å›¾ï¼š\nMySQL å¦‚ä½•æ¯”è¾ƒå­—ç¬¦ä¸²å¤§å° å…ˆå°†å­—ç¬¦ä¸²è½¬æ¢æˆç›¸åŒçš„å­—ç¬¦é›†ï¼Œå¦‚æœå­—ç¬¦é›†ä¸å…¼å®¹ï¼Œä¼šæŠ›å‡ºé”™è¯¯ï¼Œåœ¨MySQL 5.0 åŠä»¥åï¼Œè¿™ä¸ªè½¬æ¢åŠ¨ä½œæ˜¯è‡ªåŠ¨è¿›è¡Œçš„ã€‚\nå­—ç¬¦é›†å¯¹æŸ¥è¯¢çš„å½±å“ å¯èƒ½æ— æ³•ä½¿ç”¨ç´¢å¼•æ’åºï¼Œé€€åŒ–åˆ°æ–‡ä»¶æ’åº åªæœ‰æ’åºæŸ¥è¯¢è¦æ±‚çš„å­—ç¬¦é›†ä¸ä¿å­˜åˆ°æœåŠ¡å™¨ä¸Šæ•°æ®çš„å­—ç¬¦é›†ç›¸åŒçš„æ—¶å€™ï¼Œæ‰ä¼šä½¿ç”¨ç´¢å¼•æ’åºã€‚\nä¾‹å­ï¼šfilm è¡¨æœ‰å­—æ®µ title, ä½¿ç”¨çš„æ˜¯ utf8_general_ci æ’åºè§„åˆ™ã€‚ç°æœ‰æŸ¥è¯¢è¦æ±‚ title å­—æ®µæŒ‰ç…§ utf8_bin æ’åº\nè¿™ä¸­æƒ…å†µä¸‹æ— æ³•ä½¿ç”¨ç´¢å¼•æ’åºï¼Œåªèƒ½ç”¨ æ–‡ä»¶æ’åº\nå¯èƒ½æ— æ³•ä½¿ç”¨ç´¢å¼•è¿›è¡Œå…³è”è¡¨ ä¸ºäº†é€‚åº”å„ç§å­—ç¬¦é›†ï¼ŒMySQLåœ¨æŸ¥è¯¢çš„æ—¶å€™å¯èƒ½ä¼šè¿›è¡Œå­—ç¬¦é›†è½¬æ¢ï¼Œä¾‹å¦‚ï¼Œåœ¨ä½¿ç”¨ä¸åŒå­—ç¬¦é›†çš„åˆ—å»å…³è”ä¸¤å¼ è¡¨çš„æ—¶å€™ï¼Œmysqlä¼šå°è¯•è½¬æ¢å…¶ä¸­ä¸€ä¸ªåˆ—çš„å­—ç¬¦é›†ï¼Œè¿™å’Œåœ¨åˆ—å¤–é¢å°è£…ä¸€ä¸ªå‡½æ•°ä¸€æ ·ï¼Œä¼šè®©mysqlæ— æ³•ä½¿ç”¨è¯¥åˆ—ä¸Šçš„ç´¢å¼•\nå¯¹å­—ç¬¦é•¿åº¦çš„å¤„ç† UTF-8 æ˜¯ä¸€ç§å¤šå­—èŠ‚ç¼–ç ï¼Œä¸€ä¸ªå­—ç¬¦æ‰€å çš„ç©ºé—´å¯èƒ½æ˜¯ 1ã€2ã€3ä¸ªå­—èŠ‚(ä¸æ˜¯å›ºå®šçš„)ã€‚ä½†æ˜¯åœ¨MySQLå†…éƒ¨ï¼Œé€šå¸¸ä½¿ç”¨å›ºå®šçš„ç©ºé—´æ¥å­˜å‚¨ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯å¸Œæœ›æ€»æ˜¯ä¿è¯ç¼“å­˜ä¸­æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥å­˜å‚¨å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ä¸€ä¸ª UTF-8çš„char(10)éœ€è¦30ä¸ªå­—èŠ‚ã€‚\nLENGTH() \u0026gt;= CHAR_LENGTH(), LENGTH() è®¡ç®—å­—èŠ‚é•¿åº¦ï¼Œ CHAR_LENGTH() è¿”å›å­—ç¬¦çš„ä¸ªæ•°\n","date":"2022-04-13T00:22:41Z","permalink":"https://dccmmtop.github.io/posts/mysql%E4%B8%AD%E7%9A%84%E5%AD%97%E7%AC%A6%E9%9B%86/","section":"posts","tags":["MySQL"],"title":"mysqlä¸­çš„å­—ç¬¦é›†"},{"categories":null,"contents":"ç¬¬ä¸€ç§ è®¾ç½®ä¸€ä¸ªæ»‘åŠ¨çª—å£ï¼Œå·¦ä¸‹æ ‡è®° lï¼Œ å³ä¸‹æ ‡è®°r\nr å‘å³ç§»åŠ¨ï¼Œè®°å½•æ¯ä¸ªå­—ç¬¦çš„æœ€åä¸€æ¬¡å‡ºç°çš„ä½ç½® m\nå¦‚æœå½“å‰å­—ç¬¦åœ¨ m ä¸­å­˜åœ¨,å¹¶ä¸”é‡å¤å­—ç¬¦å‡ºç°çš„ä½ç½®åœ¨lå³ä¾§,è®©lç§»åŠ¨åˆ°é‡å¤å­—ç¬¦çš„ä¸‹ä¸€ä¸ªä½ç½®,è·³è¿‡é‡å¤çš„å­—ç¬¦\nræ¯æ¬¡ç§»åŠ¨æ—¶ï¼Œè®¡ç®—rä¸lçš„è·ç¦»,è®°å½•æœ€å¤§å€¼\nfunc lengthOfLongestSubstring(s string) int { c := []rune(s) size := len(c) if size \u0026lt;= 1 { return size } l, r, maxLen, k := 0, 0, 0, 0 ok := false m := make(map[rune]int, size) for ; r \u0026lt; size; r++ { if k, ok = m[c[r]]; ok \u0026amp;\u0026amp; k \u0026gt;= l { l = k + 1 } if r-l+1 \u0026gt; maxLen { maxLen = r - l + 1 } m[c[r]] = r } return maxLen } ç¬¬äºŒç§ é€Ÿåº¦ä¸ç¬¬ä¸€ç§å·®ä¸å¤šï¼Œä½†å†…å­˜å ç”¨å°‘\nfunc lengthOfLongestSubstring(s string) int { c := []rune(s) size := len(c) if size \u0026lt;= 1 { return size } l, r, maxLen := 0, 0, 0 // æ ‡è®°å­—ç¬¦æœ€åä¸€æ¬¡å‡ºç°çš„ä½ç½®,ä¸å¯ä»¥ä½¿ç”¨é»˜è®¤0å€¼ï¼Œå› ä¸ºä¸‹æ ‡æ˜¯ä»0å¼€å§‹çš„ m := [128]int{} for i := 0; i \u0026lt; 128; i++ { m[i] = -1 } for ; r \u0026lt; size; r++ { // å½“å‡ºç°é‡å¤å­—ç¬¦æ—¶ï¼Œå·¦æ ‡è®°è·³åˆ°è¯¥å­—ç¬¦çš„ä¸‹ä¸€ä¸ªä½ç½® l = max(l, m[c[r]]+1) // è®°å½•çª—å£æœ€å¤§é•¿åº¦ maxLen = max(maxLen, r-l+1) // è®°å½•å­—ç¬¦å‡ºç°çš„ä½ç½® m[c[r]] = r } return maxLen } func max(a int, b int) int { if a \u0026gt; b { return a } return b } ","date":"2022-04-08T00:04:33Z","permalink":"https://dccmmtop.github.io/posts/%E6%9C%80%E9%95%BF%E6%97%A0%E9%87%8D%E5%A4%8D%E5%AD%90%E4%B8%B2/","section":"posts","tags":["go","ç®—æ³•"],"title":"æœ€é•¿æ— é‡å¤å­ä¸²"},{"categories":null,"contents":"InnoDB æ˜¯MySQLä¸­å”¯ä¸€æ”¯æŒå¤–é”®çº¦æŸçš„å†…ç½®å¼•æ“\nç¼ºç‚¹ å¤šä¸€æ¬¡æŸ¥è¯¢ åœ¨æ¯æ¬¡ä¿®æ”¹æ•°æ®æ—¶ï¼Œéƒ½è¦åœ¨å¦å¤–ä¸€å¼ è¡¨æ‰§è¡Œä¸€æ¬¡æŸ¥è¯¢æ“ä½œï¼Œå¦‚æœå¤–é”®åˆ—çš„é€‰æ‹©æ€§å¾ˆä½ï¼Œä¼šå¯¼è‡´å­˜åœ¨ä¸€ä¸ªå¾ˆå¤§ä½†æ˜¯é€‰æ‹©æ€§å¾ˆä½çš„ç´¢å¼•ã€‚\næ¯”å¦‚åœ¨ä¸€ä¸ªå¾ˆå¤§çš„usersè¡¨ä¸­ï¼Œæœ‰ä¸€ä¸ª status åˆ—ï¼Œè¯¥åˆ—åªæœ‰2ä¸ªå€¼ï¼Œè™½ç„¶åˆ—æœ¬èº«å¾ˆå°ï¼Œä½†æ˜¯å¦‚æœä¸»é”®å¾ˆå¤§ï¼Œé‚£ä¹ˆè¿™ä¸ªç´¢å¼•å°±ä¼šå¾ˆå¤§ï¼Œè€Œè¿™ä¸ªç´¢å¼•é™¤äº†åšå¤–é”®é™åˆ¶ï¼Œä¹Ÿæ²¡æœ‰å…¶ä»–ä½œç”¨äº†\nå¤–é”®ç»´æŠ¤æ•ˆç‡ä½ åœ¨å¤–é”®ç›¸å…³æ•°æ®çš„æ›´æ–°å’Œåˆ é™¤æ—¶ï¼Œå¤–é”®çš„ç»´æŠ¤æ—¶é€è¡Œè¿›è¡Œçš„ï¼Œæ¯”æ‰¹é‡åˆ é™¤å’Œæ‰¹é‡æ›´æ–°æ•ˆç‡ä½\né¢å¤–çš„é”ç­‰å¾… å¤–é”®çº¦æŸä½¿æŸ¥è¯¢éœ€è¦è®¿é—®ä¸€äº›é¢å¤–çš„è¡¨ï¼Œå°±æ„å‘³ç€éœ€è¦é¢å¤–çš„é”ï¼šæ¯”å¦‚ å­¦ç”Ÿè¡¨æœ‰ä¸€åˆ—å­˜å‚¨ç­çº§çš„ä¸»é”®ï¼Œå½“æ–°å¢ä¸€æ¡å­¦ç”Ÿè®°å½•æ—¶ï¼Œéœ€è¦åœ¨å¯¹åº”ç­çº§çš„è¡ŒåŠ é”ï¼Œé˜²æ­¢åœ¨äº‹åŠ¡ç»“æŸå‰ï¼Œè¯¥ç­çº§è¢«åˆ é™¤ã€‚è¿™ä¼šå¯¼è‡´é¢å¤–çš„é”ç­‰å¾…ï¼Œç”šè‡³æ­»é”ã€‚ç”±äºæ²¡æœ‰ç›´æ¥è®¿é—®è¯¥è¡¨ï¼Œå¾€å¾€éš¾ä»¥æ’æŸ¥è¯¥é—®é¢˜\nä¼˜ç‚¹ ä¿æŒæ•°æ®ä¸€è‡´æ€§æ—¶ï¼Œæ¯”åœ¨åº”ç”¨ä¸­åšæ•ˆç‡é«˜ æ€»ç»“ æœ‰æ—¶å¯ä»¥ä½¿ç”¨è§¦å‘å™¨åšå¤–é”®çº¦æŸï¼Œå¯¹äºç›¸å…³æ•°æ®çš„åŒæ—¶æ›´æ–°ï¼Œå¤–é”®æ›´åˆé€‚ï¼Œä½†æ˜¯å¦‚æœåªå¯¹åˆ—åšæ•°å€¼çº¦æŸï¼Œä½¿ç”¨è§¦å‘å™¨æˆ–è€…é™åˆ¶å–å€¼ä¼šæ›´å¥½ï¼Œ\nå¦‚æœåªæ˜¯åšå¤–é”®çº¦æŸï¼Œåœ¨åº”ç”¨ç¨‹åºå†…åšä¼šæ›´å¥½ï¼Œå¤–é”®ä¼šå¸¦æ¥å¾ˆå¤§çš„é¢å¤–æ¶ˆè€—ï¼Œå¾€å¾€ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆ\n","date":"2022-04-06T23:09:21Z","permalink":"https://dccmmtop.github.io/posts/mysql%E5%A4%96%E9%94%AE%E7%BA%A6%E6%9D%9F/","section":"posts","tags":["MySQL"],"title":"MySQLå¤–é”®çº¦æŸ"},{"categories":null,"contents":"1.ä»‹ç» Integerç±»å‹ï¼Œå³æ•´æ•°ç±»å‹ï¼ŒMySQLæ”¯æŒçš„æ•´æ•°ç±»å‹æœ‰TINYINTã€SMALLINTã€MEDIUMINTã€INTã€BIGINTã€‚\n1.1 ç©ºé—´å’ŒèŒƒå›´ æ¯ç§æ•´æ•°ç±»å‹æ‰€éœ€çš„å­˜å‚¨ç©ºé—´å’ŒèŒƒå›´å¦‚ä¸‹ï¼š\n2. INT(11) 2.1 æ•°å­—æ˜¯å¦é™åˆ¶é•¿åº¦ï¼Ÿ id INT(11) NOT NULL AUTO_INCREMENT\nåœ¨ä¸€äº›å»ºè¡¨è¯­å¥ä¼šå‡ºç°ä¸Šé¢ int(11) çš„ç±»å‹ï¼Œé‚£ä¹ˆå…¶ä»£è¡¨ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ\nå¯¹äºIntegerç±»å‹æ‹¬å·ä¸­çš„æ•°å­—ç§°ä¸ºå­—æ®µçš„æ˜¾ç¤ºå®½åº¦ã€‚è¿™ä¸å…¶ä»–ç±»å‹å­—æ®µçš„å«ä¹‰ä¸åŒã€‚å¯¹äºDECIMALç±»å‹ï¼Œè¡¨ç¤ºæ•°å­—çš„æ€»æ•°ã€‚å¯¹äºå­—ç¬¦å­—æ®µï¼Œè¿™æ˜¯å¯ä»¥å­˜å‚¨çš„æœ€å¤§å­—ç¬¦æ•°ï¼Œä¾‹å¦‚VARCHARï¼ˆ20ï¼‰å¯ä»¥å­˜å‚¨20ä¸ªå­—ç¬¦ã€‚\næ˜¾ç¤ºå®½åº¦å¹¶ä¸å½±å“å¯ä»¥å­˜å‚¨åœ¨è¯¥åˆ—ä¸­çš„æœ€å¤§å€¼ã€‚ INT(5) å’Œ INT(11)å¯ä»¥å­˜å‚¨ç›¸åŒçš„æœ€å¤§å€¼ã€‚å“ªæ€•è®¾ç½®æˆ INT(20) å¹¶ä¸æ„å‘³ç€å°†èƒ½å¤Ÿå­˜å‚¨20ä½æ•°å­—(BIGINT)ï¼Œè¯¥åˆ—è¿˜æ˜¯åªèƒ½å­˜å‚¨INTçš„æœ€å¤§å€¼ã€‚\nç¤ºä¾‹\nåˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨ï¼š\nCREATE TEMPORARY TABLE demo_a ( id INT(11) NOT NULL AUTO_INCREMENT, a INT(1) NOT NULL, b INT(5) NOT NULL, PRIMARY KEY (`id`) ) æ’å…¥è¶…è¿‡\u0026quot;é•¿åº¦\u0026quot;çš„æ•°å­—ï¼š\nINSERT INTO demo_a(a,b) VALUES(255, 88888888);\næŸ¥çœ‹ç»“æœï¼šå‘ç°æ•°å­—å¹¶ä¸æ˜¯è®¾ç½®é•¿åº¦\nmysql\u0026gt; SELECT * FROM demo_a; +----+-----+----------+ | id | a | b | +----+-----+----------+ | 1 | 255 | 88888888 | +----+-----+----------+ 1 row in set (0.03 sec) 2.2 æ•°å­—è¡¨è¾¾ä»€ä¹ˆæ„æ€ï¼Ÿ å½“åˆ—è®¾ç½®ä¸ºUNSIGNED ZEROFILLæ—¶ï¼ŒINT(11)æ‰æœ‰æ„ä¹‰ï¼Œå…¶è¡¨ç¤ºçš„æ„æ€ä¸ºå¦‚æœè¦å­˜å‚¨çš„æ•°å­—å°‘äº11ä¸ªå­—ç¬¦ï¼Œåˆ™è¿™äº›æ•°å­—å°†åœ¨å·¦ä¾§è¡¥é›¶ã€‚\næ³¨æ„ï¼šZEROFILLé»˜è®¤çš„åˆ—ä¸ºæ— ç¬¦å·ï¼Œå› æ­¤ä¸èƒ½å­˜å‚¨è´Ÿæ•°ã€‚\nç¤ºä¾‹\nåˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨ï¼šbåˆ—è®¾ç½®ä¸ºUNSIGNED ZEROFILL\nCREATE TEMPORARY TABLE demo_a ( id INT(11) NOT NULL AUTO_INCREMENT, a INT(11) NOT NULL, b INT(11) UNSIGNED ZEROFILL NOT NULL, PRIMARY KEY (`id`) ); æ’å…¥æ•°å€¼ï¼š\nINSERT INTO demo_a(a,b) VALUES(1, 1);\nç»“æœï¼šbåˆ—çš„å·¦ä¾§ä½¿ç”¨äº†0å¡«å……é•¿åº¦\nmysql\u0026gt; SELECT * FROM demo_a; +----+---+-------------+ | id | a | b | +----+---+-------------+ | 1 | 1 | 00000000001 | +----+---+-------------+ 1 row in set (0.18 sec) ","date":"2022-04-01T23:28:49Z","permalink":"https://dccmmtop.github.io/posts/mysql_integer%E7%B1%BB%E5%9E%8B%E9%95%BF%E5%BA%A6/","section":"posts","tags":["MySQL"],"title":"MySQL Integerç±»å‹ä¸INT(11)"},{"categories":null,"contents":"å¹¶å‘ç¼–ç¨‹ä¸‹ï¼Œå¦‚ä½•å°†goroutineä¸­å‘ç”Ÿçš„é”™è¯¯ä¼ é€’ç»™å…¶ä»–ç¨‹åºï¼Œä»è€Œè¿›è¡Œä¼˜é›…çš„å¤„ç†å‘¢ï¼Œ\nä¸€ç§è§£å†³æ–¹æ¡ˆæ˜¯,å°†å¼‚æ­¥ä»»åŠ¡ä¸­äº§ç”Ÿçš„é”™è¯¯å†™å…¥é€šé“ä¸­ï¼Œåœ¨å¦ä¸€ä¸ªç¨‹åºä¸­è¯»å–è¯¥é€šé“ï¼Œä»è€Œå®ç°é€šä¿¡ï¼ŒäºŒæ¬¡å¤„ç†é”™è¯¯ä¿¡æ¯\nä¾‹å­\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;sync\u0026#34; ) // é”™è¯¯ä¿¡æ¯çš„å°è£… type Result struct { Error error Response *http.Response } func main() { // åˆä¸å¯è¾¾çš„é“¾æ¥ï¼Œä¼šè§¦å‘é”™è¯¯ urls := []string{\u0026#34;http://10.102.49.2/web_client/#/main\u0026#34;, \u0026#34;http://10.102.204.36/console-acp/workspace/eop~region-k1~eop-uat8/deployment/detail/eop-dpl-cir-u6\u0026#34;, \u0026#34;http://123.com\u0026#34;} for result := range checkStatus(urls) { if result.Error != nil { // åœ¨æ­¤è¿›è¡Œé”™è¯¯å¤„ç† fmt.Printf(\u0026#34;Error: %v\\n\u0026#34;, result.Error) continue } fmt.Printf(\u0026#34;Response: %v\\n\u0026#34;, result.Response) } } // å°†ä»»åŠ¡çš„å¤„ç†ç»“æœæ”¾å…¥é€šé“ä¸­ï¼Œå¹¶è¿”å› func checkStatus(urls []string) \u0026lt;-chan Result { results := make(chan Result) go func() { defer close(results) var wg sync.WaitGroup for _, url := range urls { log.Println(\u0026#34;visist: \u0026#34;, url) wg.Add(1) go func(url string) { defer wg.Done() resp, err := http.Get(url) // å°†ç»“æœå†™å…¥é€šé“ results \u0026lt;- Result{Error: err, Response: resp} }(url) } wg.Wait() }() return results } ","date":"2022-02-21T19:43:14Z","permalink":"https://dccmmtop.github.io/posts/%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E4%B8%AD%E7%9A%84%E9%94%99%E8%AF%AF%E4%BC%A0%E9%80%92/","section":"posts","tags":["go"],"title":"å¼‚æ­¥ä»»åŠ¡ä¸­çš„é”™è¯¯ä¼ é€’"},{"categories":null,"contents":"ä¸€ä¸ªé€šé“çš„è¾“å‡ºï¼Œä½œä¸ºä¸‹ä¸€ä¸ªé€šé“çš„è¾“å…¥ï¼Œè¿ç»µä¸ç»\nä¸‹é¢å®ç°äº†åŠ æ³• ä¹˜æ³•çš„æµæ°´çº¿\n// æµæ°´çº¿é€šé“ package main import \u0026#34;fmt\u0026#34; func main() { done := make(chan interface{}) defer close(done) // æ•°æ®æº numStream := generate(done, 1, 2, 3, 4, 5) // ä¹˜æ³• åŠ æ³• ä¹˜æ³• pipeline := multi(done, add(done, multi(done, numStream, 2), 1), 2) for num := range pipeline { fmt.Println(num) } } // æ¥æ”¶ä¸€ä¸ªä¸­æ­¢ä¿¡å·ï¼Œé˜²æ­¢æ³„éœ² // è¿”å›åªè¯»é€šé“ func generate(done \u0026lt;-chan interface{}, num ...int) \u0026lt;-chan int { numStream := make(chan int) go func() { defer close(numStream) for _, i := range num { select { case \u0026lt;-done: return // ä¸æ–­çš„å‘é€šé“ä¸­å†™å…¥æ•°æ® case numStream \u0026lt;- i: } } }() // æ³¨æ„ï¼šéšå¼å°†é€šé“è½¬æ¢æˆåªè¯»é€šé“ return numStream } // ä¹˜æ³•å™¨ï¼Œä»ä¸€ä¸ªé€šé“ä¸­æ¥æ”¶æ•°æ®ï¼Œç„¶å ä¹˜ä»¥factor,å°†ç»“æœå†™å…¥å¦ä¸€ä¸ªé€šé“ä¸­ //ä»ç„¶è¦æ¥æ”¶ä¸€ä¸ªç»ˆæ­¢ä¿¡å· func multi(done \u0026lt;-chan interface{}, numStream \u0026lt;-chan int, factor int) \u0026lt;-chan int { multiStream := make(chan int) go func() { defer close(multiStream) for i := range numStream { select { case \u0026lt;-done: return case multiStream \u0026lt;- (factor * i): } } }() return multiStream } // åŠ æ³•å™¨ï¼Œ åŒä¸Š func add(done \u0026lt;-chan interface{}, numStream \u0026lt;-chan int, factor int) \u0026lt;-chan int { addStream := make(chan int) go func() { defer close(addStream) for i := range numStream { select { case \u0026lt;-done: return case addStream \u0026lt;- (factor + i): } } }() return addStream } ","date":"2022-02-21T19:32:54Z","permalink":"https://dccmmtop.github.io/posts/%E9%80%9A%E9%81%93%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F/","section":"posts","tags":["go"],"title":"é€šé“æµæ°´çº¿å·¥ä½œæ¨¡å¼"},{"categories":null,"contents":"goroutine æ³„éœ² å½“ goroutine è¢«æ°¸è¿œé˜»å¡ï¼Œæˆ–è€…åªæœ‰ä¸» goroutine ç»ˆæ­¢æ—¶ï¼Œå­ goroutine æ‰ä¼šç»ˆæ­¢ï¼Œ\nå³å­goroutine æ²¡æœ‰è‡ªè¡Œç»ˆæ­¢çš„æ—¶æœº\ngoroutine ä¾¿æ— æ³•é‡Šæ”¾å…¶æ‰€å çš„å†…å­˜ç©ºé—´\nä¸€èˆ¬è§£å†³æ–¹æ¡ˆ: ç”±çˆ¶goroutineå‘ŠçŸ¥å­goroutineç»ˆæ­¢æ—¶æœº\nå‡†åˆ™: çˆ¶ goroutine åˆ›å»ºå­ goroutine,é‚£ä¹ˆçˆ¶è¦ç¡®ä¿å­èƒ½å¤Ÿåœæ­¢\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;math/rand\u0026#34; \u0026#34;time\u0026#34; ) func main() { done := make(chan interface{}) randStream := newRandStream(done) fmt.Println(\u0026#34;3 random ints:\u0026#34;) for i := 1; i \u0026lt;= 3; i++ { fmt.Printf(\u0026#34;%d: %d\\n\u0026#34;, i, \u0026lt;-randStream) } // é€šçŸ¥å­goroutineåœæ­¢ close(done) // æ¨¡æ‹Ÿæ­£åœ¨è¿è¡Œçš„å·¥ä½œ time.Sleep(1 * time.Second) } // ç”Ÿäº§è€… // åªåœ¨ç”Ÿäº§è€…ä½œç”¨åŸŸå†…å£°æ˜ chan, å¹¶åœ¨å†…éƒ¨è¿›è¡Œå†™å…¥é€»è¾‘ï¼Œç„¶åè¿”å›åªè¯»çš„é€šé“, é˜²æ­¢åœ¨ç”Ÿäº§è€…å¤–éƒ¨å‘è¯¥é€šé“ä¸­å†™å…¥æ•°æ® // ç»´æŠ¤äº†è¯¥é€šé“çš„çº¯å‡€ func newRandStream(done \u0026lt;-chan interface{}) \u0026lt;-chan int { randStream := make(chan int) go func() { // å½“æ­¤goroutineç»“æŸæ—¶ï¼Œæ‰“å°ã€‚å¦‚æœæ˜¯main groutine ç»ˆæ­¢æ—¶ï¼Œå¯¼è‡´è¯¥goroutineç»ˆæ­¢ï¼Œåˆ™ä¸ä¼šæ‰“å° defer fmt.Println(\u0026#34;newRandStream closure existed\u0026#34;) defer close(randStream) for { select { case randStream \u0026lt;- rand.Int(): case \u0026lt;-done: // æ¥æ”¶åˆ°å…³é—­ä¿¡å·,é¿å…é€šé“æ³„éœ² return } } }() // æœ‰ä¸€ä¸ªéšå¼è½¬æ¢ï¼Œå°†å¯è¯»å¯å†™çš„ randStream è½¬æ¢æˆåªè¯»çš„ return randStream } ","date":"2022-02-21T19:23:11Z","permalink":"https://dccmmtop.github.io/posts/%E9%98%B2%E6%AD%A2goroutine%E6%B3%84%E9%9C%B2%E7%9A%84%E4%B8%80%E8%88%AC%E6%9C%BA%E5%88%B6/","section":"posts","tags":["go"],"title":"é˜²æ­¢goroutineæ³„éœ²çš„ä¸€èˆ¬æœºåˆ¶"},{"categories":null,"contents":"Goä¸­çš„selectå’Œchannelé…åˆä½¿ç”¨ï¼Œé€šè¿‡selectå¯ä»¥ç›‘å¬å¤šä¸ªchannelçš„I/Oè¯»å†™äº‹ä»¶ï¼Œå½“ IOæ“ä½œå‘ç”Ÿæ—¶ï¼Œè§¦å‘ç›¸åº”çš„åŠ¨ä½œã€‚\nåŸºæœ¬ä½¿ç”¨ // å¸¸è§„ç¤ºä¾‹ func example() { done := make(chan interface{}) // ä¸€æ®µæ—¶é—´åå‘é€å…³é—­ä¿¡å· go func() { time.Sleep(5 * time.Second) close(done) }() workCounter := 0 breakLoop := false for { select { case \u0026lt;-done: breakLoop = true default: } if breakLoop { break } workCounter++ time.Sleep(1 * time.Second) } fmt.Printf(\u0026#34;æ”¶åˆ°ç»“æŸä¿¡å·ï¼Œä»»åŠ¡æ‰§è¡Œäº† %d æ¬¡\u0026#34;, workCounter) } è¶…æ—¶æœºåˆ¶ package main import ( \u0026#34;fmt\u0026#34; \u0026#34;time\u0026#34; ) func main() { ch := make(chan int) quit := make(chan bool) //æ–°å¼€ä¸€ä¸ªåç¨‹ go func() { for { select { case num := \u0026lt;-ch: fmt.Println(\u0026#34;num = \u0026#34;, num) case \u0026lt;-time.After(3 * time.Second): fmt.Println(\u0026#34;è¶…æ—¶\u0026#34;) quit \u0026lt;- true } } }() for i := 0; i \u0026lt; 5; i++ { ch \u0026lt;- i time.Sleep(time.Second) } // æ”¶åˆ°è¶…æ—¶ä¿¡å·ï¼Œåœæ­¢é˜»å¡ \u0026lt;-quit fmt.Println(\u0026#34;ç¨‹åºç»“æŸ\u0026#34;) } æœ€å¿«è¿”å› å¤šä¸ª goroutine åšåŒä¸€ä»¶å·¥ä½œï¼Œå–æœ€å¿«çš„è¿”å›ç»“æœ\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;github.com/kirinlabs/HttpRequest\u0026#34; ) func main() { ch1 := make(chan int) ch2 := make(chan int) ch3 := make(chan int) go Getdata(\u0026#34;https://www.baidu.com\u0026#34;,ch1) go Getdata(\u0026#34;https://www.baidu.com\u0026#34;,ch2) go Getdata(\u0026#34;https://www.baidu.com\u0026#34;,ch3) select{ case v:=\u0026lt;- ch1: fmt.Println(v) case v:=\u0026lt;- ch2: fmt.Println(v) case v:=\u0026lt;- ch3: fmt.Println(v) } } func Getdata(url string,ch chan int){ req,err := HttpRequest.Get(url) if err != nil{ }else{ ch \u0026lt;- req.StatusCode() } } æ­»é”ä¸é»˜è®¤æƒ…å†µ package main func main() { ch := make(chan string) select { case \u0026lt;-ch: } } åœ¨ç¬¬ 4 è¡Œåˆ›å»ºäº†ä¸€ä¸ªä¿¡é“ chã€‚æˆ‘ä»¬åœ¨ select å†…éƒ¨ï¼ˆç¬¬ 6 è¡Œï¼‰ï¼Œè¯•å›¾è¯»å–ä¿¡é“ chã€‚ç”±äºæ²¡æœ‰ Go åç¨‹å‘è¯¥ä¿¡é“å†™å…¥æ•°æ®ï¼Œå› æ­¤ select è¯­å¥ä¼šä¸€ç›´é˜»å¡ï¼Œå¯¼è‡´æ­»é”ã€‚è¯¥ç¨‹åºä¼šè§¦å‘è¿è¡Œæ—¶ panic\nç©ºselect package main func main() { select {} } é™¤éæœ‰ case æ‰§è¡Œï¼Œselect è¯­å¥å°±ä¼šä¸€ç›´é˜»å¡ç€ã€‚åœ¨è¿™é‡Œï¼Œselect è¯­å¥æ²¡æœ‰ä»»ä½• caseï¼Œå› æ­¤å®ƒä¼šä¸€ç›´é˜»å¡ï¼Œå¯¼è‡´æ­»é”ã€‚è¯¥ç¨‹åºä¼šè§¦å‘ panic\n","date":"2022-02-21T19:06:18Z","permalink":"https://dccmmtop.github.io/posts/select%E7%94%A8%E6%B3%95%E7%A4%BA%E4%BE%8B/","section":"posts","tags":["go"],"title":"selectç”¨æ³•ç¤ºä¾‹"},{"categories":null,"contents":"å®‰è£… samba yum install samba ä¿®æ”¹é…ç½®æ–‡ä»¶ ä¿®æ”¹é…ç½®æ–‡ä»¶ vim /etc/samba/smb.conf æ·»åŠ è¦å…±äº«çš„ç›®å½•\n[opt] # è¢«å…±äº«ç›®å½•çš„åˆ«å path = /home/dccmmtop/opt # è¦å…±äº«çš„ç›®å½• browseable = yes writable = yes # å¯ä»¥å†™å…¥ valid users = dccmmtop # ç”¨æˆ·ï¼Œè¯¥ç”¨æˆ·è¦æœ‰ç›®å½•çš„æƒé™ create mode=0777 directory mode=0777 force create mode=0777 force directory mode=0777 æ·»åŠ ç”¨æˆ· å°†ç”¨æˆ· dccmmtop è®¾ç½®ä¸ºå¯ä»¥ç™»å½• samba\nsmbpasswd -a dccmmtop // è®¾ç½® dccmmtop çš„sambaæœåŠ¡å¯†ç ï¼Œå¯ä¸ç”¨æˆ·å¯†ç ç›¸åŒ smbpasswd -e dccmmtop // å¯ç”¨sambaç”¨æˆ·ï¼Œæ˜¾ç¤ºEnableåˆ™æˆåŠŸ å…³é—­ç½‘ç»œé˜²ç«å¢™æˆ–æ·»åŠ ç«¯å£ sudo systemctl stop firewalld.service æˆ–è€…å¼€æ”¾ç«¯å£\nsudo firewall-cmd --zone=public --add-port=139/tcp --permanent sudo firewall-cmd --zone=public --add-port=445/tcp --permanent sudo firewall-cmd --zone=public --add-port=137/udp --permanent sudo firewall-cmd --zone=public --add-port=138/udp --permanent sudo firewall-cmd --reload sudo systemctl restart firewalld.service å…³é—­SELinux å®‰å…¨å¢å¼ºå‹Linuxï¼ˆSELinuxï¼‰æ˜¯ä¸€ä¸ªLinuxå†…æ ¸çš„åŠŸèƒ½ï¼Œå®ƒæä¾›æ”¯æŒè®¿é—®æ§åˆ¶çš„å®‰å…¨æ”¿ç­–ä¿æŠ¤æœºåˆ¶\næ‰“å¼€ /etc/selinux/config ,å°† SELINUX è®¾ç½®ä¸º disabled\né‡å¯ç”Ÿæ•ˆ\nä¸´æ—¶ä¿®æ”¹ æ‰§è¡Œå‘½ä»¤ setenforce 0 ä¸´æ—¶å…³é—­SELinux\nè¿è¡Œå‘½ä»¤getenforceï¼ŒéªŒè¯SELinuxçŠ¶æ€ä¸ºdisabledï¼Œè¡¨æ˜SELinuxå·²å…³é—­ã€‚\né‡å¯æœåŠ¡ systemctl restart smb.service // ä¸æŠ¥é”™è¯´æ˜æ²¡é—®é¢˜ windows æŒ‚è½½ å¼€å¯windows SMB æœåŠ¡ï¼Œå¦‚ä¸‹\næ˜ å°„ç½‘ç»œä½ç½®\nä¹‹åè¾“å…¥ä¸Šé¢è®¾ç½®çš„ç”¨æˆ·åå¯†ç å°±å¯ä»¥äº†\n","date":"2022-01-19T11:27:26Z","permalink":"https://dccmmtop.github.io/posts/linux%E6%90%AD%E5%BB%BAsamba%E6%9C%8D%E5%8A%A1/","section":"posts","tags":["linux"],"title":"Linuxæ­å»ºsambaæœåŠ¡"},{"categories":null,"contents":"åˆå§‹åŒ–é¡¹ç›® æ–°å»º myapp ç›®å½•ï¼Œåœ¨ä¸‹é¢æ·»åŠ  Dockerfile æ–‡ä»¶ï¼Œå¦‚ä¸‹:\nDockerfile FROM ruby:2.5\rRUN apt-get update -qq \u0026amp;\u0026amp; apt-get install -y nodejs default-mysql-client\rADD . /myapp\rWORKDIR /myapp\rRUN bundle install\rEXPOSE 3000\rCMD [\u0026#34;bash\u0026#34;] Gemfile å†æ–°å»º Gemfile æ–‡ä»¶\nsource \u0026#39;https://gems.ruby-china.com\u0026#39; # å®‰è£… Rails gem \u0026#39;rails\u0026#39;, \u0026#39;~\u0026gt; 5.1.3\u0026#39; docker-compose.yml version: \u0026#39;3.3\u0026#39; # ä½¿ç”¨å·²ç»å­˜åœ¨çš„å¤–éƒ¨ç½‘ç»œ networks: default: external: name: dev_network services: web: build: . command: bash -c \u0026#34;rm -f tmp/pids/server.pid \u0026amp;\u0026amp; bundle exec rails s -p 3000 -b \u0026#39;0.0.0.0\u0026#39;\u0026#34; volumes: - .:/myapp ports: - \u0026#34;3000:3000\u0026#34; # é“¾æ¥å·²ç»å­˜åœ¨çš„mysql external_links: - mysql:mysql åŠ å…¥ç½‘ç»œ åŠ å…¥å·²ç»å­˜åœ¨çš„ dev_net ç½‘ç»œï¼Œä»¥ä¾¿è®¿é—® mysql æœåŠ¡, å¦‚æœæ²¡æœ‰ dev_net,å¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤åˆ›å»º:\ndocker network create dev_net åœ¨ mysql çš„ docker-compose.yml ä¸­åŒæ ·æ·»åŠ ä¸‹é¢å†…å®¹ï¼Œå¯ä»¥åŠ å…¥ç½‘ç»œ dev_net\n# ä½¿ç”¨å·²ç»å­˜åœ¨çš„å¤–éƒ¨ç½‘ç»œ networks: default: external: name: dev_network ç”Ÿæˆé¡¹ç›®éª¨æ¶ docker-compose run web rails new . --force --database=mysql --skip-bundle Compose ä¼šå…ˆä½¿ç”¨ Dockerfile ä¸º web æœåŠ¡åˆ›å»ºä¸€ä¸ªé•œåƒï¼Œæ¥ç€ä½¿ç”¨è¿™ä¸ªé•œåƒåœ¨å®¹å™¨é‡Œè¿è¡Œ rails new å’Œå®ƒä¹‹åçš„å‘½ä»¤ã€‚ä¸€æ—¦è¿™ä¸ªå‘½ä»¤è¿è¡Œå®Œåï¼Œåº”è¯¥å°±å¯ä»¥çœ‹ä¸€ä¸ªå´­æ–°çš„åº”ç”¨å·²ç»ç”Ÿæˆäº†\nå†æ¬¡æ„å»º æ–°ç”Ÿæˆçš„ Gemfile è¦†ç›–äº†åŸæ¥gemæºçš„é…ç½®, ä¿®æ”¹ Gemfile çš„æºä¸º source 'https://gems.ruby-china.com', å¦å¤–å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ  gem\nç”±äº ä¿®æ”¹ Gemfile , éœ€è¦å†æ¬¡æ„å»ºï¼Œ å°† gem åŒ…å®‰è£…åˆ°é•œåƒä¸­ï¼Œä»¥åæ¯æ¬¡ä¿®æ”¹ Gemfile,éƒ½è¦é‡æ–°æ„å»ºã€‚ æˆ–è€…å¯ä»¥å°† gem çš„å®‰è£…ç›®å½•é€šè¿‡æ·»åŠ å·çš„æ–¹å¼æ˜ å°„åˆ°æœ¬åœ°ã€‚\ndocker-compose build ä¿®æ”¹æ•°æ®åº“é…ç½® ä¿®æ”¹ config/database.yml\n# MySQL. Versions 5.1.10 and up are supported. # # Install the MySQL driver # gem install mysql2 # # Ensure the MySQL gem is defined in your Gemfile # gem \u0026#39;mysql2\u0026#39; # # And be sure to use new-style password hashing: # http://dev.mysql.com/doc/refman/5.7/en/old-client.html # default: \u0026amp;default adapter: mysql2 encoding: utf8 pool: \u0026lt;%= ENV.fetch(\u0026#34;RAILS_MAX_THREADS\u0026#34;) { 5 } %\u0026gt; username: root password: 123456 host: mysql development: \u0026lt;\u0026lt;: *default database: videobot # Warning: The database defined as \u0026#34;test\u0026#34; will be erased and # re-generated from your development database when you run \u0026#34;rake\u0026#34;. # Do not set this db to the same as development or production. test: \u0026lt;\u0026lt;: *default database: myapp_test # As with config/secrets.yml, you never want to store sensitive information, # like your database password, in your source code. If your source code is # ever seen by anyone, they now have access to your database. # # Instead, provide the password as a unix environment variable when you boot # the app. Read http://guides.rubyonrails.org/configuring.html#configuring-a-database # for a full rundown on how to provide these environment variables in a # production deployment. # # On Heroku and other platform providers, you may have a full connection URL # available as an environment variable. For example: # # DATABASE_URL=\u0026#34;mysql2://myuser:mypass@localhost/somedatabase\u0026#34; # # You can use this database configuration with: # # production: # url: \u0026lt;%= ENV[\u0026#39;DATABASE_URL\u0026#39;] %\u0026gt; # production: \u0026lt;\u0026lt;: *default database: myapp_production username: myapp password: \u0026lt;%= ENV[\u0026#39;MYAPP_DATABASE_PASSWORD\u0026#39;] %\u0026gt; å¯åŠ¨ docker-compose up ","date":"2022-01-13T09:05:07Z","permalink":"https://dccmmtop.github.io/posts/%E6%9E%84%E5%BB%BAdocker%E7%8E%AF%E5%A2%83%E5%BC%80%E5%8F%91rails/","section":"posts","tags":["docker","rails"],"title":"æ„å»ºdockerç¯å¢ƒå¼€å‘Rails"},{"categories":null,"contents":"ä¸ºä»€ä¹ˆéœ€è¦æ±  ç”¨æ¥çº¦æŸåˆ›å»ºå’Œå¤ç”¨æ˜‚è´µçš„åœºæ™¯ï¼Œæ¯”å¦‚æ•°æ®åº“è¿æ¥\nGoæ˜¯æ€ä¹ˆå®ç°çš„æ±  é€šè¿‡ sync.Pool åŒ…å®ç°ï¼Œå¹¶å‘å®‰å…¨\næ€ä¹ˆä½¿ç”¨ Get æ–¹æ³•ï¼Œé¦–å…ˆæ£€æŸ¥æ± ä¸­æ˜¯å¦æœ‰å¯ç”¨çš„å®ä¾‹è¿”å›ç»™è°ƒç”¨è€…,å¦‚æœæ²¡æœ‰ï¼Œè°ƒç”¨New æ–¹æ³•åˆ›å»ºæ–°çš„å®ä¾‹,å¹¶è¿”å› ä½¿ç”¨å®Œè¯¥å®ä¾‹åï¼Œè°ƒç”¨ Put æ–¹æ³•ï¼Œå°†å®ä¾‹å½’è¿˜åˆ°æ± ä¸­ ç¤ºä¾‹ package main import( \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; ) func main(){ myPool := sync.Pool{ New: func() interface{} { fmt.Println(\u0026#34;åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä¾‹\u0026#34;) return struct{}{} }, } // ç¬¬ä¸€æ¬¡å–ï¼Œæ± ä¸­æ²¡æœ‰å®ä¾‹,è¦æ–°å»º myPool.Get() // ç¬¬äºŒæ¬¡å–ï¼Œæ± ä¸­ä¹Ÿæ²¡æœ‰å®ä¾‹ï¼Œå› ä¸ºæ²¡æœ‰æŠŠç¬¬ä¸€æ¬¡å–å¾—å®ä¾‹æ”¾å…¥åˆ°æ± ä¸­, è¦æ–°å»º instance := myPool.Get() // å°†å–åˆ°å¾—å®ä¾‹æ”¾å…¥æ± ä¸­ myPool.Put(instance) // æ± ä¸­å·²ç»æœ‰å®ä¾‹ï¼Œä¸ç”¨æ–°å»º myPool.Get() // æ‰€ä»¥ä¼šè¾“å‡º 2 æ¬¡ç»“æœ } ç»“æœ:\nç¬¬äºŒä¸ªä¾‹å­ package main import( \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; \u0026#34;time\u0026#34; \u0026#34;strconv\u0026#34; \u0026#34;os\u0026#34; ) func main(){ numCalcsCreated := 0 calcPool := \u0026amp;sync.Pool{ New: func() interface{} { numCalcsCreated ++ // ä½¿ç”¨äº† 1Kb çš„å†…å­˜ mem := make([]byte,1024) return \u0026amp;mem }, } calcPool.Put(calcPool.New()) calcPool.Put(calcPool.New()) calcPool.Put(calcPool.New()) calcPool.Put(calcPool.New()) const numWorks = 1024 var wg sync.WaitGroup wg.Add(numWorks) sleepTime, err := strconv.Atoi(os.Args[1]) if err != nil { fmt.Println(err) return } for i := 0; i \u0026lt; numWorks ; i ++ { go func(){ defer wg.Done() // ä½¿ç”¨æ± åŒ–æŠ€æœ¯ï¼Œæ¯æ¬¡ç”¨å®Œä¹‹åï¼Œç«‹å³æ”¾å…¥æ± ä¸­ï¼Œæ°¸è¿œåªä¼šä½¿ç”¨å°‘é‡çš„å®ä¾‹ // ä¹Ÿæœ‰å¯èƒ½å½’è¿˜å¤ªæ…¢ï¼Œå¯¼è‡´ç”¨æ± ä¸­æš‚æ—¶æ²¡æœ‰å®ä¾‹å¯ç”¨ï¼Œä»è€Œç»§ç»­ç”Ÿæˆæ–°çš„å®ä¾‹ mem := calcPool.Get() time.Sleep(time.Duration(sleepTime) * time.Nanosecond) defer calcPool.Put(mem) }() } wg.Wait() fmt.Println(\u0026#34;åˆ›å»ºäº†\u0026#34;,numCalcsCreated, \u0026#34;æ¬¡\u0026#34;) } è°ƒæ•´ä¼‘çœ æ—¶é—´ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹\n","date":"2021-12-15T19:56:44Z","permalink":"https://dccmmtop.github.io/posts/go%E6%B1%A0/","section":"posts","tags":["go","æ± åŒ–"],"title":"Goæ± "},{"categories":null,"contents":"æ¦‚å¿µ æµ‹è¯•æ˜¯ç¼–ç¨‹å·¥ä½œä¸­éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œä½†å¾ˆå¤šäººå´å¿½è§†äº†è¿™ä¸€ç‚¹ï¼Œåˆæˆ–è€…åªæ˜¯æŠŠæµ‹è¯•çœ‹ä½œæ˜¯ä¸€ç§å¯æœ‰å¯æ— çš„è¡¥å……æ‰‹æ®µã€‚Goè¯­è¨€æä¾›äº†ä¸€äº›åŸºæœ¬çš„æµ‹è¯•åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½åˆçœ‹ä¸Šå»å¯èƒ½ä¼šæ˜¾å¾—éå¸¸åŸå§‹ï¼Œä½†æ­£å¦‚å°†è¦ä»‹ç»çš„é‚£æ ·ï¼Œè¿™äº›å·¥å…·å®é™…ä¸Šå·²ç»èƒ½å¤Ÿæ»¡è¶³ç¨‹åºå‘˜å¯¹è‡ªåŠ¨æµ‹è¯•çš„éœ€è¦äº†ã€‚\né™¤äº†Goè¯­è¨€å†…ç½®çš„testingåŒ…ä¹‹å¤–ï¼Œè¿˜ä¼šä»‹ç»checkå’ŒGinkgoè¿™ä¸¤ä¸ªæµè¡Œçš„Goæµ‹è¯•åŒ…ï¼Œå®ƒä»¬æä¾›çš„åŠŸèƒ½æ¯”testingåŒ…æ›´ä¸ºä¸°å¯Œã€‚\ntesting testingåŒ…éœ€è¦ä¸go testå‘½ä»¤ä»¥åŠæºä»£ç ä¸­æ‰€æœ‰ä»¥-test.goåç¼€ç»“å°¾çš„æµ‹è¯•æ–‡ä»¶ä¸€åŒä½¿ç”¨ã€‚å°½ç®¡Goå¹¶æ²¡æœ‰å¼ºåˆ¶è¦æ±‚ï¼Œä½†ä¸€èˆ¬æ¥è¯´ï¼Œæµ‹è¯•æ–‡ä»¶çš„åå­—éƒ½ä¼šä¸è¢«æµ‹è¯•æºç æ–‡ä»¶çš„åå­—ç›¸å¯¹åº”ã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œå¯¹äºæºç æ–‡ä»¶server.goï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå‡ºä¸€ä¸ªåä¸ºserver-test.goçš„æµ‹è¯•æ–‡ä»¶ï¼Œè¿™ä¸ªæµ‹è¯•æ–‡ä»¶åŒ…å«æˆ‘ä»¬æƒ³å¯¹server.goè¿›è¡Œçš„æ‰€æœ‰æµ‹è¯•ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œè¢«æµ‹è¯•çš„æºç æ–‡ä»¶å’Œæµ‹è¯•æ–‡ä»¶å¿…é¡»ä½äºåŒä¸€ä¸ªåŒ…ä¹‹å†…ã€‚\nä¸ºäº†æµ‹è¯•æºä»£ç ï¼Œç”¨æˆ·éœ€è¦åœ¨æµ‹è¯•æ–‡ä»¶ä¸­åˆ›å»ºå…·æœ‰ä»¥ä¸‹æ ¼å¼çš„æµ‹è¯•å‡½æ•°ï¼Œå…¶ä¸­xxxå¯ä»¥æ˜¯ä»»æ„è‹±æ–‡å­—æ¯ä»¥åŠæ•°å­—çš„ç»„åˆï¼Œä½†æ˜¯é¦–å­—ç¬¦å¿…é¡»æ˜¯å¤§å†™çš„è‹±æ–‡å­—æ¯ï¼š\nfunc TestXxxï¼ˆ*testing.Tï¼‰{..}\nåœ¨æµ‹è¯•å‡½æ•°çš„å†…éƒ¨ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨Errorï¼ŒFailç­‰ä¸€ç³»åˆ—æ–¹æ³•è¡¨ç¤ºæµ‹è¯•å¤±è´¥ã€‚å½“ç”¨æˆ·åœ¨ç»ˆç«¯é‡Œé¢æ‰§è¡Œgo testå‘½ä»¤çš„æ—¶å€™ï¼Œæ‰€æœ‰ç¬¦åˆä¸Šè¿°æ ¼å¼çš„æµ‹è¯•å‡½æ•°å°±ä¼šè¢«æ‰§è¡Œã€‚å¦‚æœä¸€ä¸ªæµ‹è¯•åœ¨æ‰§è¡Œçš„æ—¶å€™æ²¡æœ‰ä»»ä½•å¤±è´¥ï¼Œå°±è®¤ä¸ºé€šè¿‡äº†æµ‹è¯•\nä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªå•å…ƒé€šå¸¸ä¼šä¸ç¨‹åºä¸­çš„ä¸€ä¸ªå‡½æ•°æˆ–è€…ä¸€ä¸ªæ–¹æ³•ç›¸å¯¹åº”ï¼Œä½†è¿™å¹¶ä¸æ˜¯å¿…é¡»çš„ã€‚ç¨‹åºä¸­çš„ä¸€ä¸ªéƒ¨åˆ†èƒ½å¦ç‹¬ç«‹åœ°è¿›è¡Œæµ‹è¯•ï¼Œæ˜¯è¯„åˆ¤è¿™ä¸ªéƒ¨åˆ†èƒ½å¦è¢«å½’çº³ä¸ºâ€œå•å…ƒâ€çš„ä¸€ä¸ªé‡è¦æŒ‡æ ‡ã€‚\næ£€æµ‹é”™è¯¯ func TestDecode(t *testing.T){ post := Decode(\u0026#34;./tsconfig.json\u0026#34;) if post.Id != 1{ t.Error(\u0026#34;é”™è¯¯çš„postId, æœŸæœ›å¾—åˆ°1ï¼Œå®é™…æ˜¯: \u0026#34;, post.Id) } if post.Content != \u0026#34;Hello world!\u0026#34; { t.Error(\u0026#34;é”™è¯¯çš„post content, æœŸæœ›å¾—åˆ°\u0026#39;Hello world\u0026#39;ï¼Œå®é™…æ˜¯: \u0026#34;, post.Content) } } testing.T æœ‰å‡ ä¸ªå¸¸ç”¨çš„æ–¹æ³•:\nLog å°†ç»™å®šçš„æ–‡æœ¬è®°å½•åˆ°é”™è¯¯æ—¥å¿—é‡Œï¼Œ ä¸ fmt.Println ç±»ä¼¼ Logf æ ¹æ®ç»™å®šçš„æ ¼å¼,å°†æ–‡æœ¬è®°å½•åˆ°é”™è¯¯æ—¥å¿—ï¼Œä¸ fmt.Printf ç±»ä¼¼ Fail å°†æµ‹è¯•å‡½æ•°æ ‡è®°å·²å¤±è´¥ï¼Œä½†å…è®¸æµ‹è¯•å‡½æ•°ç»§ç»­æ‰§è¡Œ FailNow å°†æµ‹è¯•å‡½æ•°æ ‡è®°å·²å¤±è´¥ï¼Œå¹¶åœæ­¢æ‰§è¡Œæµ‹è¯•å‡½æ•° é™¤æ­¤ä¹‹å¤–ã€‚è¿˜æä¾›äº†å…¶ä»–ä¾¿åˆ©çš„æ–¹æ³•\nError å…ˆæ‰§è¡Œ Log å‡½æ•°ï¼Œå†æ‰§è¡Œ Fail å‡½æ•°, å…¶ä»–3ä¸ªç±»ä¼¼\næ‰§è¡Œ go test è¿™æ¡å‘½ä»¤ä¼šæ‰§è¡Œå½“å‰ç›®å½•ä¸­åå­—ä»¥_test.goä¸ºåç¼€çš„æ‰€æœ‰æ–‡ä»¶ã€‚ç»“æœå¦‚ä¸‹\ngo test è¾“å‡ºå¾ˆç²¾ç®€, å¯ä»¥åŠ  -v å‚æ•°ä½¿è¾“å‡ºå†…å®¹æ›´è¯¦ç»†, -cover è·çŸ¥æµ‹è¯•ç”¨ä¾‹å¯¹ä»£ç çš„è¦†ç›–ç‡\nè·³è¿‡æµ‹è¯•ç”¨ä¾‹ Skip åœ¨è¿›è¡Œæµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆtest-driven developmentï¼ŒTDDï¼‰çš„æ—¶å€™ï¼Œé€šå¸¸ä¼šè®©æµ‹è¯•ç”¨ä¾‹æŒç»­åœ°å¤±è´¥ï¼Œç›´åˆ°å‡½æ•°è¢«çœŸæ­£åœ°å®ç°å‡ºæ¥ä¸ºæ­¢ï¼›\nä½†æ˜¯ï¼Œä¸ºäº†é¿å…æµ‹è¯•ç”¨ä¾‹åœ¨å‡½æ•°å°šæœªå®ç°ä¹‹å‰ä¸€ç›´æ‰“å°çƒ¦äººçš„å¤±è´¥ä¿¡æ¯ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥ä½¿ç”¨testing.T ç»“æ„æä¾›çš„skipå‡½æ•°ï¼Œæš‚æ—¶è·³è¿‡æŒ‡å®šçš„æµ‹è¯•ç”¨ä¾‹ã€‚\næ­¤å¤–ï¼Œå¦‚æœæŸä¸ªæµ‹è¯•ç”¨ä¾‹çš„æ‰§è¡Œæ—¶é—´éå¸¸é•¿ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å®æ–½å®Œæ•´æ€§æ£€æŸ¥ï¼ˆsanity checkï¼‰çš„æ—¶å€™ï¼Œä½¿ç”¨Skipå‡½æ•°è·³è¿‡è¯¥æµ‹è¯•ç”¨ä¾‹ã€‚\nç¤ºä¾‹ä»£ç :\nfunc TestEncode(t *testing.T){ // Skip æš‚æ—¶è·³è¿‡å¯¹æŸä¸ªæ–¹æ³•çš„æµ‹è¯• t.Skip(\u0026#34;æš‚æ—¶è·³è¿‡å¯¹Encodeæ–¹æ³•çš„æµ‹è¯•\u0026#34;) } å†æ¬¡æ‰§è¡Œæµ‹è¯•ï¼š\nShort é™¤äº†å¯ä»¥ç›´æ¥è·³è¿‡æ•´ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œç”¨æˆ·è¿˜å¯ä»¥é€šè¿‡å‘go testå‘½ä»¤ä¼ å…¥çŸ­æš‚æ ‡å¿— -shortï¼Œå¹¶åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­ä½¿ç”¨æŸäº›æ¡ä»¶é€»è¾‘æ¥è·³è¿‡æµ‹è¯•ä¸­çš„æŒ‡å®šéƒ¨åˆ†ã€‚\næ³¨æ„ï¼Œè¿™ç§åšæ³•è·Ÿåœ¨go testå‘½ä»¤ä¸­é€šè¿‡é€‰é¡¹æ¥é€‰æ‹©æ€§åœ°æ‰§è¡ŒæŒ‡å®šçš„æµ‹è¯•ä¸ä¸€æ ·ï¼šé€‰æ‹©æ€§æ‰§è¡Œåªä¼šæ‰§è¡ŒæŒ‡å®šçš„æµ‹è¯•ï¼Œå¹¶è·³è¿‡å…¶ä»–æ‰€æœ‰æµ‹è¯•ï¼Œè€Œ-shortæ ‡å¿—åˆ™ä¼šæ ¹æ®ç”¨æˆ·ç¼–å†™æµ‹è¯•ä»£ç çš„æ–¹å¼ï¼Œè·³è¿‡æµ‹è¯•ä¸­çš„æŒ‡å®šéƒ¨åˆ†æˆ–è€…è·³è¿‡æ•´ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚\nç¤ºä¾‹ï¼š\nfunc TestLongTime(t *testing.T) { // å¦‚æœå¸¦æœ‰ -short å‚æ•° if testing.Short() { t.Skip(\u0026#34;è·³è¿‡é•¿æ—¶é—´çš„æµ‹è¯•\u0026#34;) } time.Sleep(10 * time.Second) } å¹¶è¡Œæµ‹è¯• æ­£å¦‚ä¹‹å‰æ‰€è¯´ï¼Œå•å…ƒæµ‹è¯•çš„ç›®çš„æ˜¯ç‹¬ç«‹åœ°è¿›è¡Œæµ‹è¯•ã€‚å°½ç®¡æœ‰äº›æ—¶å€™ï¼Œæµ‹è¯•å¥—ä»¶ä¼šå› ä¸ºå†…éƒ¨å­˜åœ¨ä¾èµ–å…³ç³»è€Œæ— æ³•ç‹¬ç«‹åœ°è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œä½†æ˜¯åªè¦å•å…ƒæµ‹è¯•å¯ä»¥ç‹¬ç«‹åœ°è¿›è¡Œï¼Œç”¨æˆ·å°±å¯ä»¥é€šè¿‡å¹¶è¡Œåœ°è¿è¡Œæµ‹è¯•ç”¨ä¾‹æ¥æå‡æµ‹è¯•çš„é€Ÿåº¦äº†\ntesting é€šè¿‡ Parallel æ–¹æ³•å®ç°å¹¶è¡Œ\nç¤ºä¾‹ï¼š\nfunc TestSleep5(t *testing.T) { t.Parallel() time.Sleep(5 * time.Second) } func TestSleep3(t *testing.T) { t.Parallel() time.Sleep(3 * time.Second) } func TestSleep1(t *testing.T) { t.Parallel() time.Sleep(3 * time.Second) } é€šè¿‡ -parallel n æ§åˆ¶å¯ä»¥åŒæ—¶è¿è¡Œå‡ ä¸ªå•å…ƒæµ‹è¯•\nåŸºå‡†æµ‹è¯• Go çš„ testing åŒ…æ”¯æŒä¸¤ç§æµ‹è¯•ï¼Œä¸€ç§æ˜¯ä¸Šé¢çš„åŠŸèƒ½æµ‹è¯•ï¼Œè¿˜ä¸€ç§å°±æ˜¯æ£€éªŒç¨‹åºçš„æ€§èƒ½çš„åŸºå‡†æµ‹è¯•\nåŸºå‡†æµ‹è¯•ç”¨ä¾‹ä¹Ÿè®¸è¦æ”¾åˆ°ä»¥ _test.go ç»“å°¾çš„æ–‡ä»¶ä¸­ åŸºå‡†æµ‹è¯•å‡½æ•°éœ€è¦ç¬¦åˆ func BenchmarkXXXX(b *testing.B) {\u0026hellip;} æ ¼å¼ æµ‹è¯•ç”¨ä¾‹çš„è¿­ä»£æ¬¡æ•°æ˜¯Goè‡ªè¡Œå†³å®šçš„ ä½¿ç”¨ go test -bench . æ‰§è¡Œæœ¬ç›®å½•ä¸‹çš„æ‰€æœ‰åŸºå‡†æµ‹è¯• ç¤ºä¾‹ï¼š\n// åŸºå‡†æµ‹è¯• func BenchmarkDecode(b *testing.B) { for i := 0; i \u0026lt; b.N; i++ { Decode(\u0026#34;./tsconfig.json\u0026#34;) } ç»“æœ:\næ‰§è¡Œäº† 21745 æ¬¡ã€‚èŠ±è´¹äº† 55310 çº³ç§’ï¼Œå³ 55 æ¯«ç§’\nå®Œæ•´ä»£ç  jsonæ–‡ä»¶\n{ \u0026#34;id\u0026#34;: 1, \u0026#34;content\u0026#34;: \u0026#34;Hello world!\u0026#34;, \u0026#34;author\u0026#34;:{ \u0026#34;id\u0026#34;:2, \u0026#34;name\u0026#34;: \u0026#34;Sau Sheong\u0026#34; }, \u0026#34;comments\u0026#34;: [ { \u0026#34;id\u0026#34;: 3, \u0026#34;content\u0026#34;: \u0026#34;Have a great day!\u0026#34;, \u0026#34;author\u0026#34;: \u0026#34;Adam\u0026#34; }, { \u0026#34;id\u0026#34;: 4, \u0026#34;content\u0026#34;: \u0026#34;How are you today?\u0026#34;, \u0026#34;author\u0026#34;: \u0026#34;Betty\u0026#34; } ] } package main import ( \u0026#34;testing\u0026#34; \u0026#34;time\u0026#34; ) func TestDecode(t *testing.T){ post := Decode(\u0026#34;./tsconfig.json\u0026#34;) if post.Id != 1{ t.Error(\u0026#34;é”™è¯¯çš„postId, æœŸæœ›å¾—åˆ°1ï¼Œå®é™…æ˜¯: \u0026#34;, post.Id) } if post.Content != \u0026#34;Hello world!\u0026#34; { t.Error(\u0026#34;é”™è¯¯çš„post content, æœŸæœ›å¾—åˆ°\u0026#39;Hello world\u0026#39;ï¼Œå®é™…æ˜¯: \u0026#34;, post.Content) } } func TestSleep5(t *testing.T) { t.Parallel() time.Sleep(5 * time.Second) } func TestSleep3(t *testing.T) { t.Parallel() time.Sleep(3 * time.Second) } func TestSleep1(t *testing.T) { t.Parallel() time.Sleep(3 * time.Second) } func TestEncode(t *testing.T){ // Skip æš‚æ—¶è·³è¿‡å¯¹æŸä¸ªæ–¹æ³•çš„æµ‹è¯• t.Skip(\u0026#34;æš‚æ—¶è·³è¿‡å¯¹Encodeæ–¹æ³•çš„æµ‹è¯•\u0026#34;) } func TestLongTime(t *testing.T) { // å¦‚æœå¸¦æœ‰ -short å‚æ•° if testing.Short() { t.Skip(\u0026#34;è·³è¿‡é•¿æ—¶é—´çš„æµ‹è¯•\u0026#34;) } time.Sleep(10 * time.Second) } // åŸºå‡†æµ‹è¯• func BenchmarkDecode(b *testing.B) { for i := 0; i \u0026lt; b.N; i++ { Decode(\u0026#34;./tsconfig.json\u0026#34;) } } ","date":"2021-11-23T23:21:17Z","permalink":"https://dccmmtop.github.io/posts/go%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/","section":"posts","tags":["go","å•å…ƒæµ‹è¯•"],"title":"Goå•å…ƒæµ‹è¯•"},{"categories":null,"contents":"è¿™ä¸ªå°è£…ç¨‹åºä½¿ç”¨çš„ç»“æ„å’Œä¹‹å‰åˆ†æJSONæ—¶ä½¿ç”¨çš„ç»“æ„æ˜¯ç›¸åŒçš„ã€‚\nç¨‹åºé¦–å…ˆä¼šåˆ›å»ºä¸€äº›ç»“æ„ï¼Œç„¶åé€šè¿‡è°ƒç”¨MarshalIndentå‡½æ•°å°†ç»“æ„å°è£…ä¸ºç”±å­—èŠ‚åˆ‡ç‰‡ç»„æˆçš„JSONæ•°æ® æœ€åï¼Œç¨‹åºä¼šå°†å°è£…æ‰€å¾—çš„JSONæ•°æ®å­˜å‚¨åˆ°æŒ‡å®šçš„æ–‡ä»¶ä¸­ã€‚ ä¹Ÿå¯ä»¥é€šè¿‡ç¼–ç å™¨æ‰‹åŠ¨å°†Goç»“æ„ç¼–ç ä¸ºjsonæ•°æ®\næµç¨‹å¦‚ä¸‹:\nç¤ºä¾‹ package main import ( \u0026#34;encoding/json\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;io/ioutil\u0026#34; \u0026#34;os\u0026#34; ) type Post struct { // å¤„ç†å¯¹è±¡å±æ€§ä¸jsonå­—æ®µçš„æ˜ å°„å…³ç³» // å¦‚æœå¯¹è±¡å±æ€§ä¸jsonå­—æ®µåç§°ç›¸åŒã€‚å¯ä»¥çœç•¥ Id int `json:\u0026#34;id\u0026#34;` Content string `json:\u0026#34;content\u0026#34;` Author Author `json:\u0026#34;author\u0026#34;` Comments []Comment `json:\u0026#34;comments\u0026#34;` } type Author struct { Id int `json:\u0026#34;id\u0026#34;` Name string `json:\u0026#34;name\u0026#34;` } type Comment struct { Id int `json:\u0026#34;id\u0026#34;` Content string `json:\u0026#34;content\u0026#34;` Author string `json:\u0026#34;author\u0026#34;` } func main(){ post := Post{ Id: 1, Content: \u0026#34;Hello World\u0026#34;, Author: Author{ Id: 2, Name: \u0026#34;dc1\u0026#34;, }, Comments: []Comment{ { Id: 3, Content: \u0026#34;Have a great day\u0026#34;, Author: \u0026#34;Adam\u0026#34;, }, { Id: 4, Content: \u0026#34;How are you today\u0026#34;, Author: \u0026#34;Betty\u0026#34;, }, }, } fmt.Printf(\u0026#34;post: %v\\n\u0026#34;, post) // å°† json ç»“æ„å°è£…ä¸ºç”±å­—èŠ‚åˆ‡ç‰‡ç»„æˆçš„Jsonæ•°æ® output, err := json.MarshalIndent(\u0026amp;post,\u0026#34;\u0026#34;,\u0026#34;\\t\\t\u0026#34;) if err != nil { panic(err) } // å°†æ•°æ®å†™å…¥æ–‡ä»¶ä¸­ err = ioutil.WriteFile(\u0026#34;post.json\u0026#34;,output,0666) if err != nil { panic(err) } // ä½¿ç”¨Encoderå°†ç»“æ„ç¼–ç åˆ°æ–‡ä»¶ä¸­ // åˆ›å»ºç”¨äºå‚¨å­˜jsonçš„æ–‡ä»¶ jsonFile, err := os.Create(\u0026#34;./post1.json\u0026#34;) if err != nil { panic(err) } // åˆ›å»ºè§£ç å™¨ encoder := json.NewEncoder(jsonFile) // æŠŠç»“æ„ç¼–ç åˆ°jsonæ–‡ä»¶ä¸­ err = encoder.Encode(\u0026amp;post) if err != nil { panic(err) } } ","date":"2021-11-18T23:08:29Z","permalink":"https://dccmmtop.github.io/posts/go%E5%86%99%E5%85%A5json/","section":"posts","tags":["go"],"title":"Goå†™å…¥json"},{"categories":null,"contents":"å¯ä»¥ä½¿ç”¨Unmarshalå‡½æ•°æ¥è§£å°JSONï¼Œè¿˜å¯ä»¥ä½¿ç”¨Decoderæ‰‹åŠ¨åœ°å°†JSONæ•°æ®è§£ç åˆ°ç»“æ„é‡Œé¢ï¼Œä»¥æ­¤æ¥å¤„ç†æµå¼çš„JSONæ•°æ®ï¼Œ\næµç¨‹å¦‚ä¸‹\nè¦è§£æçš„jsonæ–‡ä»¶ { \u0026#34;id\u0026#34;: 1, \u0026#34;content\u0026#34;: \u0026#34;Hello world!\u0026#34;, \u0026#34;author\u0026#34;:{ \u0026#34;id\u0026#34;:2, \u0026#34;name\u0026#34;: \u0026#34;Sau Sheong\u0026#34; }, \u0026#34;comments\u0026#34;: [ { \u0026#34;id\u0026#34;: 3, \u0026#34;content\u0026#34;: \u0026#34;Have a great day!\u0026#34;, \u0026#34;author\u0026#34;: \u0026#34;Adam\u0026#34; }, { \u0026#34;id\u0026#34;: 4, \u0026#34;content\u0026#34;: \u0026#34;How are you today?\u0026#34;, \u0026#34;author\u0026#34;: \u0026#34;Betty\u0026#34; } ] } ç¤ºä¾‹ package main import ( \u0026#34;encoding/json\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;io\u0026#34; \u0026#34;io/ioutil\u0026#34; \u0026#34;os\u0026#34; ) type Post struct { // å¤„ç†å¯¹è±¡å±æ€§ä¸jsonå­—æ®µçš„æ˜ å°„å…³ç³» // å¦‚æœå¯¹è±¡å±æ€§ä¸jsonå­—æ®µåç§°ç›¸åŒã€‚å¯ä»¥çœç•¥ Id int `json:\u0026#34;id\u0026#34;` Content string `json:\u0026#34;content\u0026#34;` Author Author `json:\u0026#34;author\u0026#34;` Comments []Comment `json:\u0026#34;comments\u0026#34;` } type Author struct { Id int `json:\u0026#34;id\u0026#34;` Name string `json:\u0026#34;name\u0026#34;` } type Comment struct { Id int `json:\u0026#34;id\u0026#34;` Content string `json:\u0026#34;content\u0026#34;` Author string `json:\u0026#34;author\u0026#34;` } func main(){ jsonFile, err := os.Open(\u0026#34;./tsconfig.json\u0026#34;) defer jsonFile.Close() if err != nil { panic(err) } var post Post jsonContent, err := ioutil.ReadAll(jsonFile) if err != nil { panic(err) } // å°†jsonæ•°æ®è§£å°è‡³ç»“æ„ err = json.Unmarshal(jsonContent, \u0026amp;post) if err != nil { panic(err) } fmt.Printf(\u0026#34;post: %v\\n\u0026#34;, post) // å¦ä¸€ç§æ–¹å¼ ä½¿ç”¨è§£ç å™¨ jsonFile1, err := os.Open(\u0026#34;./tsconfig.json\u0026#34;) defer jsonFile1.Close() if err != nil { panic(err) } decoder := json.NewDecoder(jsonFile1) var post1 Post err = decoder.Decode(\u0026amp;post1) if err != nil \u0026amp;\u0026amp; err != io.EOF { panic(err) } fmt.Printf(\u0026#34;post1: %v\\n\u0026#34;, post1) } é€‰æ‹© æœ€åï¼Œåœ¨é¢å¯¹JSONæ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è¾“å…¥å†³å®šä½¿ç”¨Decoderè¿˜æ˜¯Unmarshalï¼š\nå¦‚æœJSONæ•°æ®æ¥æºäºio.Readeræµï¼Œ å¦‚http.Requestçš„Bodyï¼Œé‚£ä¹ˆä½¿ç”¨Decoderæ›´å¥½ï¼›\nå¦‚æœJSONæ•°æ®æ¥æºäºå­—ç¬¦ä¸²æˆ–è€…å†…å­˜çš„æŸä¸ªåœ°æ–¹ï¼Œé‚£ä¹ˆä½¿ç”¨Unmarshalæ›´å¥½ã€‚\n","date":"2021-11-18T22:40:07Z","permalink":"https://dccmmtop.github.io/posts/go%E8%A7%A3%E6%9E%90json%E6%96%87%E4%BB%B6/","section":"posts","tags":["go"],"title":"Goè§£æjsonæ–‡ä»¶"},{"categories":null,"contents":"è‡ªåŠ¨è¿ç§» å› ä¸ºGormå¯ä»¥é€šè¿‡è‡ªåŠ¨æ•°æ®è¿ç§»ç‰¹æ€§æ¥åˆ›å»ºæ‰€éœ€çš„æ•°æ®åº“è¡¨ï¼Œå¹¶åœ¨ç”¨æˆ·ä¿®æ”¹ç›¸åº”çš„ç»“æ„æ—¶è‡ªåŠ¨å¯¹æ•°æ®åº“è¡¨è¿›è¡Œæ›´æ–°ï¼Œ å½“æˆ‘ä»¬è¿è¡Œè¿™ä¸ªç¨‹åºæ—¶ï¼Œç¨‹åºæ‰€éœ€çš„æ•°æ®åº“è¡¨å°±ä¼šè‡ªåŠ¨ç”Ÿæˆ\nè´Ÿè´£æ‰§è¡Œæ•°æ®è¿ç§»æ“ä½œçš„AutoMigrateæ–¹æ³•æ˜¯ä¸€ä¸ªå˜é•¿å‚æ•°æ–¹æ³•ï¼Œè¿™ç§ç±»å‹çš„æ–¹æ³•å’Œå‡½æ•°èƒ½å¤Ÿæ¥å—ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ä½œä¸ºè¾“å…¥ã€‚\nåœ¨ä¸‹é¢å±•ç¤ºçš„ä»£ç ä¸­ï¼ŒAutoMigrateæ–¹æ³•æ¥å—çš„æ˜¯Postç»“æ„å’ŒCommentç»“æ„ã€‚å¾—ç›Šäºè‡ªåŠ¨æ•°æ®è¿ç§»ç‰¹æ€§çš„å­˜åœ¨ï¼Œå½“ç”¨æˆ·å‘ç»“æ„é‡Œé¢æ·»åŠ æ–°å­—æ®µçš„æ—¶å€™ï¼ŒGormå°±ä¼šè‡ªåŠ¨åœ¨æ•°æ®åº“è¡¨é‡Œé¢æ·»åŠ ç›¸åº”çš„æ–°åˆ—ã€‚\nè‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´ Commentç»“æ„é‡Œé¢å‡ºç°äº†ä¸€ä¸ªç±»å‹ä¸ºtime.Timeçš„CreatedAtå­—æ®µï¼ŒåŒ…å«è¿™æ ·ä¸€ä¸ªå­—æ®µæ„å‘³ç€Gormæ¯æ¬¡åœ¨æ•°æ®åº“é‡Œåˆ›å»ºä¸€æ¡æ–°è®°å½•çš„æ—¶å€™ï¼Œéƒ½ä¼šè‡ªåŠ¨å¯¹è¿™ä¸ªå­—æ®µè¿›è¡Œè®¾ç½®ã€‚\næ­¤å¤–ï¼ŒCommentç»“æ„çš„å…¶ä¸­ä¸€äº›å­—æ®µè¿˜ç”¨åˆ°äº†ç»“æ„æ ‡ç­¾ï¼Œä»¥æ­¤æ¥æŒ‡ç¤ºGormåº”è¯¥å¦‚ä½•åˆ›å»ºå’Œæ˜ å°„ç›¸åº”çš„å­—æ®µã€‚æ¯”å¦‚ï¼ŒCommentç»“æ„çš„Authorå­—æ®µå°±ä½¿ç”¨äº†ç»“æ„æ ‡ç­¾ã€sqlï¼š\u0026ldquo;not null\u0026rdquo;ï¼Œä»¥æ­¤æ¥å‘ŠçŸ¥Gormï¼Œè¯¥å­—æ®µå¯¹åº”åˆ—çš„å€¼ä¸èƒ½ä¸ºnull\nå¤„ç†æ˜ å°„å…³ç³» åœ¨Commentç»“æ„é‡Œè®¾ç½®äº†ä¸€ä¸ªPostIdå­—æ®µã€‚Gormä¼šè‡ªåŠ¨æŠŠè¿™ç§æ ¼å¼çš„å­—æ®µçœ‹ä½œæ˜¯å¤–é”®ï¼Œå¹¶åˆ›å»ºæ‰€éœ€çš„å…³ç³»ã€‚\nç¤ºä¾‹ä»£ç  package main import ( \u0026#34;fmt\u0026#34; _ \u0026#34;github.com/go-sql-driver/mysql\u0026#34; \u0026#34;github.com/jinzhu/gorm\u0026#34; \u0026#34;time\u0026#34; ) type Post struct { // ä¼šè¢«è‡ªåŠ¨è®¾ç½®æˆä¸»é”® Id int Content string // æ•°æ®åº“å±‚é¢ä¸å¯ä»¥ä¸ºç©ºçº¦æŸ Author string `sql:\u0026#34;not null\u0026#34;` Comments []Comment // çº¦å®šã€‚ åˆ›å»ºæ—¶ä¼šè¢«è‡ªåŠ¨èµ‹å€¼ CreatedAt time.Time } type Comment struct { Id int Content string Author string `sql:\u0026#34;not null\u0026#34;` // ä»¥Idç»“å°¾çš„å­—æ®µè¢«è§†ä¸ºå¤–é”®,åœ¨å…³è”å¯¹è±¡æ—¶èµ·ä½œç”¨. index ä¼šåœ¨æ­¤å­—æ®µä¸Šåˆ›å»ºç´¢å¼• PostId int `sql:\u0026#34;index\u0026#34;` CreatedAt time.Time } var Db *gorm.DB func init(){ var err error Db, err = gorm.Open(\u0026#34;mysql\u0026#34;,\u0026#34;esns:dccmmtop@tcp(192.168.32.128:3306)/chitchat?parseTime=true\u0026#34;) if err != nil { panic(err) } // å¼€å¯è¯¦ç»†æ—¥å¿—ï¼Œä¼šæŠŠæ‰§è¡Œçš„sqlæ‰“å°å‡ºæ¥ Db.LogMode(true) // æ‰§è¡Œæ•°æ®åº“è¿ç§»ã€‚åŒ…æ‹¬æ–°å¢è¡¨ï¼Œæ–°å¢å­—æ®µï¼Œä¿®æ”¹å­—æ®µ Db.AutoMigrate(\u0026amp;Post{},\u0026amp;Comment{}) } func main() { post := Post{ Content: \u0026#34;ä¹±èŠ±æ¸æ¬²è¿·äººçœ¼\u0026#34;, Author: \u0026#34;æå•†éš\u0026#34;, } // åˆ›å»ºpost,å¹¶æ˜ å°„ Db.Create(\u0026amp;post) comment := Comment{ Content: \u0026#34;å¤ªæ£’äº†\u0026#34;, Author: \u0026#34;æç™½\u0026#34;, } // åˆ›å»ºå…³è”çš„å¯¹è±¡ã€‚è¿™é‡Œé€šè¿‡å¤–é”®Id è‡ªåŠ¨æŸ¥æ‰¾æ˜ å°„å…³ç³» Db.Model(\u0026amp;post).Association(\u0026#34;Comments\u0026#34;).Append(comment) var readPost Post // æŸ¥è¯¢ Db.Where(\u0026#34;id = ?\u0026#34;, post.Id).First(\u0026amp;readPost) var comments []Comment // å…³è”æŸ¥è¯¢ Db.Model(\u0026amp;readPost).Related(\u0026amp;comments) fmt.Printf(\u0026#34;post: %v\\n\u0026#34;,readPost) fmt.Printf(\u0026#34;comments: %v\\n\u0026#34;,comments) } gorm å®˜æ–¹æ–‡æ¡£æœ‰è¯¦ç»†çš„æ•™ç¨‹ https://gorm.io/zh_CN/\n","date":"2021-11-16T23:14:23Z","permalink":"https://dccmmtop.github.io/posts/gorm%E5%8C%85%E4%BD%BF%E7%94%A8/","section":"posts","tags":["go"],"title":"gormåŒ…ä½¿ç”¨"},{"categories":null,"contents":"sqlxæ˜¯ä¸€ä¸ªç¬¬ä¸‰æ–¹åº“ï¼Œå®ƒä¸ºdatabase/sqlåŒ…æä¾›äº†ä¸€ç³»åˆ—éå¸¸æœ‰ç”¨çš„æ‰©å±•åŠŸèƒ½ã€‚\nå› ä¸ºsqlxå’Œdatabase/sqlåŒ…ä½¿ç”¨çš„æ˜¯ç›¸åŒçš„æ¥å£ï¼Œæ‰€ä»¥sqlxèƒ½å¤Ÿå¾ˆå¥½åœ°å…¼å®¹ä½¿ç”¨database/sqlåŒ…çš„ç¨‹åºï¼Œ é™¤æ­¤ä¹‹å¤–ï¼Œsqlxè¿˜æä¾›äº†ä»¥ä¸‹è¿™äº›é¢å¤–çš„åŠŸèƒ½ï¼š\né€šè¿‡ç»“æ„æ ‡ç­¾ï¼ˆstruct tagï¼‰å°†æ•°æ®åº“è®°å½•ï¼ˆå³è¡Œï¼‰å°è£…ä¸ºç»“æ„ã€æ˜ å°„æˆ–è€…åˆ‡ç‰‡ï¼› ä¸ºé¢„å¤„ç†è¯­å¥æä¾›å…·åå‚æ•°æ”¯æŒã€‚ è¡¨ç»“æ„ create table blog ( id int auto_increment primary key, title varchar(255) not null, content text not null, creator_id int not null ); ç¤ºä¾‹ package main import ( \u0026#34;fmt\u0026#34; _ \u0026#34;github.com/go-sql-driver/mysql\u0026#34; \u0026#34;github.com/jmoiron/sqlx\u0026#34; ) type Blog struct { Id int Title string Content string // å½“å±æ€§ä¸å­—æ®µåä¸ä¸€è‡´æ—¶ï¼Œä½¿ç”¨ struct_tag è¿›è¡Œæ˜ å°„ Creator int `db:\u0026#34;creator_id\u0026#34;` } var db *sqlx.DB func init(){ var err error db, err = sqlx.Open(\u0026#34;mysql\u0026#34;,\u0026#34;esns:dccmmtop@tcp(192.168.32.128:3306)/chitchat?parseTime=true\u0026#34;) if err != nil { panic(err) } } func (blog *Blog)save(){ result, err := db.Exec(\u0026#34;insert into blog(title, content, creator_id) values (?,?,?)\u0026#34;,blog.Title,blog.Content, blog.Creator) if err != nil { panic(err) } // mysql ä¸æ”¯æŒè¿”å›æ’å…¥åçš„è‡ªå¢Id,éœ€è¦é¢å¤–å¤„ç† id, err := result.LastInsertId() if err != nil { panic(err) } blog.Id = int(id) return } func findById(id int)(blog Blog){ blog = Blog{} // StructScan ä¼šè‡ªåŠ¨èµ‹å€¼å±æ€§ err := db.QueryRowx(\u0026#34;select id, title, content, creator_id from blog where id = ?\u0026#34;, id).StructScan(\u0026amp;blog) if err != nil { panic(err) } return } func main(){ blog := Blog{ Title: \u0026#34;goè¯­è¨€å­¦ä¹ \u0026#34;, Content: \u0026#34;å¼€å¯goç¼–ç¨‹ä¹‹æ—…å§\u0026#34;, Creator: 1, } blog.save() blog = findById(blog.Id) fmt.Printf(\u0026#34;blog: %v\\n\u0026#34;, blog) } ","date":"2021-11-16T22:07:23Z","permalink":"https://dccmmtop.github.io/posts/sqlx%E5%8C%85%E7%9A%84%E4%BD%BF%E7%94%A8/","section":"posts","tags":["go"],"title":"sqlxåŒ…çš„ä½¿ç”¨"},{"categories":null,"contents":"è¿æ¥æ•°æ®åº“ sq1.DBç»“æ„æ˜¯ä¸€ä¸ªæ•°æ®åº“å¥æŸ„ï¼ˆhandleï¼‰ï¼Œå®ƒä»£è¡¨çš„æ˜¯ä¸€ä¸ªåŒ…å«äº†é›¶ä¸ªæˆ–ä»»æ„å¤šä¸ªæ•°æ®åº“è¿æ¥çš„è¿æ¥æ± ï¼ˆpoolï¼‰ï¼Œè¿™ä¸ªè¿æ¥æ± ç”±sqlåŒ…ç®¡ç†ã€‚ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨Openå‡½æ•°ï¼Œå¹¶å°†ç›¸åº”çš„æ•°æ®åº“é©±åŠ¨åå­—ï¼ˆdriver nameï¼‰ä»¥åŠæ•°æ®æºåå­—ï¼ˆdata source nameï¼‰ä¼ é€’ç»™è¯¥å‡½æ•°æ¥å»ºç«‹ä¸æ•°æ®åº“çš„è¿æ¥ã€‚\næ¯”å¦‚ï¼Œåœ¨ä¸‹é¢å±•ç¤ºçš„ä¾‹å­ä¸­ï¼Œç¨‹åºä½¿ç”¨çš„æ˜¯mysqlé©±åŠ¨ã€‚æ•°æ®æºåå­—æ˜¯ä¸€ä¸ªç‰¹å®šäºæ•°æ®åº“é©±åŠ¨çš„å­—ç¬¦ä¸²ï¼Œå®ƒä¼šå‘Šè¯‰é©±åŠ¨åº”è¯¥å¦‚ä½•ä¸æ•°æ®åº“è¿›è¡Œè¿æ¥ã€‚\nOpenå‡½æ•°åœ¨æ‰§è¡Œä¹‹åä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘sq1.DBç»“æ„çš„æŒ‡é’ˆä½œä¸ºç»“æœã€‚Openå‡½æ•°åœ¨æ‰§è¡Œæ—¶ï¼Œä¸ä¼šçœŸæ­£çš„ä¸æ•°æ®åº“è¿æ¥ï¼Œç”šè‡³ä¸ä¼šæ£€æŸ¥å‚æ•°.\nOpenå‡½æ•°çœŸæ­£çš„ä½œç”¨æ˜¯è®¾ç½®å¥½è¿æ¥æ•°æ®åº“æ‰€éœ€è¦çš„ç»“æ„ï¼Œå¹¶ä»¥æƒ°æ€§çš„æ–¹å¼ï¼Œç­‰çœŸæ­£éœ€è¦çš„æ—¶å€™æ‰å»ºç«‹ä¸æ•°æ®åº“è¿æ¥\nvar Db *sql.DB func init() { var err error Db, err = sql.Open(\u0026#34;mysql\u0026#34;, \u0026#34;esns:dccmmtop@tcp(192.168.32.128:3306)/chitchat\u0026#34;) if err != nil { log.Fatal(err) } return } åˆ›å»ºç”¨æˆ· type User struct { Id int64 Uuid string Name string Email string Password string CreatedAt time.Time } func (u *User) Create() (err error) { statement := \u0026#34;insert into users(uuid,name,email,password, created_at) value(?,?,?,?,?)\u0026#34; // é¢„ç¼–è¯‘ stmt, err := Db.Prepare(statement) if err != nil { return err } defer stmt.Close() // åŠ å¯†å¯†ç  u.Password = Encrypt(u.Password) // ç”ŸæˆUUID u.Uuid = CreateUUID() u.CreatedAt = time.Now() // æ‰§è¡Œ result, err := stmt.Exec(u.Uuid,u.Name,u.Email,u.Password,u.CreatedAt) if err != nil { return err } // è¿”å›æ’å…¥åçš„è‡ªå¢ID u.Id, err = result.LastInsertId() if err != nil { util.Danger.Println(\u0026#34;åˆ›å»ºç”¨æˆ·è¿”å›Idé”™è¯¯: \u0026#34;,err) return err } util.Info.Println(\u0026#34;æ–°å¢ç”¨æˆ·: \u0026#34;, fmt.Sprintf(\u0026#34;%v\u0026#34;,*u)) userJson, err := json.Marshal(*u) if err != nil { return err } util.Info.Println(\u0026#34;æ–°å¢ç”¨æˆ·: \u0026#34;, string(userJson)) return } æŸ¥è¯¢ç”¨æˆ· // æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ· func FindUserById(id int64)(u User, err error) { sql := \u0026#34;select id, uuid, `name`, email, password, created_at from users where id = ?\u0026#34; u = User{} // scan å°†æŸ¥è¯¢å‡ºæ¥çš„æ¯ä¸€åˆ—èµ‹å€¼ç»™å¯¹åº”çš„å±æ€§ err = Db.QueryRow(sql, id).Scan(\u0026amp;u.Id, \u0026amp;u.Uuid, \u0026amp;u.Name, \u0026amp;u.Email, \u0026amp;u.Password, \u0026amp;u.CreatedAt) if err != nil { util.Danger.Println(\u0026#34;æŸ¥è¯¢ç”¨æˆ·é”™è¯¯: \u0026#34;, err) return } return } è·å–å¤šä¸ªå¯¹è±¡ type Thread struct { Id int64 Uuid string UserId int64 Topic string CreatedAt time.Time } // è·å–ç”¨æˆ·å‘å¸ƒå¤šä¸ªå¸–å­ func ThreadsList(userId int64)(threads []Thread){ sql := \u0026#34;select id, uuid, user_id, topic,created_at from threads where user_id = ? order by created_at desc\u0026#34; rows, err := Db.Query(sql,userId) if err != nil { util.Danger.Println(\u0026#34;æŸ¥è¯¢ threads é”™è¯¯, è¿”å›ç©ºæ•°æ®,err:\u0026#34;, err) return } defer rows.Close() for rows.Next() { thread := Thread{} err := rows.Scan(\u0026amp;thread.Id,\u0026amp;thread.Uuid,\u0026amp;thread.UserId,\u0026amp;thread.Topic,\u0026amp;thread.CreatedAt) if err != nil { util.Danger.Println(err) continue } threads = append(threads,thread) } return } ","date":"2021-11-13T22:21:13Z","permalink":"https://dccmmtop.github.io/posts/go%E4%B8%8Esql/","section":"posts","tags":["go"],"title":"Goä¸SQL"},{"categories":null,"contents":"\n","date":"2021-11-12T08:57:15Z","permalink":"https://dccmmtop.github.io/posts/sql%E4%BC%98%E5%8C%96/","section":"posts","tags":["MySQL"],"title":"SQLä¼˜åŒ–"},{"categories":null,"contents":"ä»€ä¹ˆæ˜¯æ•°æ®çš„ä¸€è‡´æ€§ â€œæ•°æ®ä¸€è‡´â€ä¸€èˆ¬æŒ‡çš„æ˜¯ï¼šç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œç¼“å­˜çš„æ•°æ®å€¼ = æ•°æ®åº“ä¸­çš„å€¼ã€‚\nä½†æ ¹æ®ç¼“å­˜ä¸­æ˜¯æœ‰æ•°æ®ä¸ºä¾æ®ï¼Œåˆ™â€ä¸€è‡´â€œå¯ä»¥åŒ…å«ä¸¤ç§æƒ…å†µï¼š\nç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œç¼“å­˜çš„æ•°æ®å€¼ = æ•°æ®åº“ä¸­çš„å€¼ï¼ˆéœ€å‡ä¸ºæœ€æ–°å€¼ï¼Œæœ¬æ–‡å°†â€œæ—§å€¼çš„ä¸€è‡´â€å½’ç±»ä¸ºâ€œä¸ä¸€è‡´çŠ¶æ€â€ï¼‰ ç¼“å­˜ä¸­æœ¬æ²¡æœ‰æ•°æ®ï¼Œæ•°æ®åº“ä¸­çš„å€¼ = æœ€æ–°å€¼ï¼ˆæœ‰è¯·æ±‚æŸ¥è¯¢æ•°æ®åº“æ—¶ï¼Œä¼šå°†æ•°æ®å†™å…¥ç¼“å­˜ï¼Œåˆ™å˜ä¸ºä¸Šé¢çš„â€œä¸€è‡´â€çŠ¶æ€ï¼‰ â€æ•°æ®ä¸ä¸€è‡´â€œï¼šç¼“å­˜çš„æ•°æ®å€¼ â‰  æ•°æ®åº“ä¸­çš„å€¼ï¼›ç¼“å­˜æˆ–è€…æ•°æ®åº“ä¸­å­˜åœ¨æ—§å€¼ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹è¯»åˆ°æ—§æ•°æ®\næ•°æ®ä¸ä¸€è‡´æƒ…å†µåŠåº”å¯¹ç­–ç•¥ æ ¹æ®æ˜¯å¦ä¸»åŠ¨å‘ç¼“å­˜ä¸­å†™å€¼ï¼Œå¯ä»¥æŠŠç¼“å­˜åˆ†æˆè¯»å†™ç¼“å­˜å’Œåªè¯»ç¼“å­˜ã€‚\nåªè¯»ç¼“å­˜ï¼šåªåœ¨ç¼“å­˜è¿›è¡Œæ•°æ®æŸ¥æ‰¾ï¼Œå³ä½¿ç”¨ æ›´æ–°æ•°æ®åº“+åˆ é™¤ç¼“å­˜ç­–ç•¥ï¼› è¯»å†™ç¼“å­˜ï¼šéœ€è¦åœ¨ç¼“å­˜ä¸­å¯¹æ•°æ®è¿›è¡Œå¢åˆ æ”¹æŸ¥ï¼Œå³ä½¿ç”¨ æ›´æ–°æ•°æ®åº“+æ›´æ–°ç¼“å­˜ç­–ç•¥ã€‚ åªè¯»ç¼“å­˜ï¼ˆæ›´æ–°æ•°æ®åº“+åˆ é™¤ç¼“å­˜ï¼‰ æ–°å¢æ•°æ®æ—¶ ï¼Œå†™å…¥æ•°æ®åº“ï¼›è®¿é—®æ•°æ®æ—¶ï¼Œç¼“å­˜ç¼ºå¤±ï¼ŒæŸ¥æ•°æ®åº“ï¼Œæ›´æ–°ç¼“å­˜ï¼ˆå§‹ç»ˆæ˜¯å¤„äºâ€æ•°æ®ä¸€è‡´â€œçš„çŠ¶æ€ï¼Œä¸ä¼šå‘ç”Ÿæ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜) æ›´æ–°ï¼ˆä¿®æ”¹/åˆ é™¤ï¼‰æ•°æ®æ—¶ ï¼Œä¼šæœ‰ä¸ªæ—¶åºé—®é¢˜ï¼šæ›´æ–°æ•°æ®åº“ä¸åˆ é™¤ç¼“å­˜çš„é¡ºåºï¼ˆè¿™ä¸ªè¿‡ç¨‹ä¼šå‘ç”Ÿæ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ï¼‰, å¦‚ä¸‹å›¾ åœ¨æ›´æ–°æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šæœ‰å¦‚ä¸‹é—®é¢˜ï¼š\næ— å¹¶å‘è¯·æ±‚ä¸‹ï¼Œå…¶ä¸­ä¸€ä¸ªæ“ä½œå¤±è´¥çš„æƒ…å†µ\nå¹¶å‘è¯·æ±‚ä¸‹ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½ä¼šè¯»åˆ°æ—§å€¼\nå› æ­¤ï¼Œè¦æƒ³è¾¾åˆ°æ•°æ®ä¸€è‡´æ€§ï¼Œéœ€è¦ä¿è¯ä¸¤ç‚¹ï¼š\næ— å¹¶å‘è¯·æ±‚ä¸‹ï¼Œä¿è¯ A å’Œ B æ­¥éª¤éƒ½èƒ½æˆåŠŸæ‰§è¡Œ\nå¹¶å‘è¯·æ±‚ä¸‹ï¼Œåœ¨ A å’Œ B æ­¥éª¤çš„é—´éš”ä¸­ï¼Œé¿å…æˆ–æ¶ˆé™¤å…¶ä»–çº¿ç¨‹çš„å½±å“\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é’ˆå¯¹æœ‰/æ— å¹¶å‘åœºæ™¯ï¼Œè¿›è¡Œåˆ†æå¹¶ä½¿ç”¨ä¸åŒçš„ç­–ç•¥ã€‚\nA. æ— å¹¶å‘æƒ…å†µ æ— å¹¶å‘è¯·æ±‚ä¸‹ï¼Œåœ¨æ›´æ–°æ•°æ®åº“å’Œåˆ é™¤ç¼“å­˜å€¼çš„è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºæ“ä½œè¢«æ‹†åˆ†æˆä¸¤æ­¥ï¼Œé‚£ä¹ˆå°±å¾ˆæœ‰å¯èƒ½å­˜åœ¨â€œæ­¥éª¤ 1 æˆåŠŸï¼Œæ­¥éª¤ 2 å¤±è´¥â€ çš„æƒ…å†µå‘ç”Ÿï¼ˆç”±äºå•çº¿ç¨‹ä¸­æ­¥éª¤ 1 å’Œæ­¥éª¤ 2 æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼Œä¸å¤ªå¯èƒ½ä¼šå‘ç”Ÿ â€œæ­¥éª¤ 2 æˆåŠŸï¼Œæ­¥éª¤ 1 å¤±è´¥â€ çš„æƒ…å†µï¼‰ã€‚\nå…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“,å¦‚å›¾\nå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜\nä¸¤ç§æ–¹æ¡ˆæ‰§è¡Œæƒ…å†µå¯¹æ¯”:\næ‰§è¡Œæ—¶åº æ½œåœ¨é—®é¢˜ ç»“æœ æ˜¯å¦å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜ å…ˆåˆ é™¤ç¼“å­˜ï¼Œåœ¨æ›´æ–°æ•°æ®åº“ åˆ é™¤ç¼“å­˜æˆåŠŸï¼Œæ›´æ–°æ•°æ®åº“å¤±è´¥ è¯·æ±‚æ— æ³•å‘½ä¸­ç¼“å­˜ï¼Œè¯»å–æ•°æ®åº“æ—§å€¼ æ˜¯ å…ˆæ›´æ–°æ•°æ®åº“,ååˆ é™¤ç¼“å­˜ æ›´æ–°æ•°æ®åº“æˆåŠŸï¼Œåˆ é™¤ç¼“å­˜å¤±è´¥ è¯·æ±‚å‘½ä¸­ç¼“å­˜ï¼Œè¯»å–åˆ°æ—§å€¼ æ˜¯ è§£å†³ç­–ç•¥ï¼š\na.æ¶ˆæ¯é˜Ÿåˆ—+å¼‚æ­¥é‡è¯•\næ— è®ºä½¿ç”¨å“ªä¸€ç§æ‰§è¡Œæ—¶åºï¼Œå¯ä»¥åœ¨æ‰§è¡Œæ­¥éª¤ 1 æ—¶ï¼Œå°†æ­¥éª¤ 2 çš„è¯·æ±‚å†™å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå½“æ­¥éª¤ 2 å¤±è´¥æ—¶ï¼Œå°±å¯ä»¥ä½¿ç”¨é‡è¯•ç­–ç•¥ï¼Œå¯¹å¤±è´¥æ“ä½œè¿›è¡Œ â€œè¡¥å¿â€ã€‚\nå¦‚å›¾:\nå…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š\næŠŠè¦åˆ é™¤ç¼“å­˜å€¼æˆ–è€…æ˜¯è¦æ›´æ–°æ•°æ®åº“å€¼æ“ä½œç”Ÿæˆæ¶ˆæ¯ï¼Œæš‚å­˜åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼ˆä¾‹å¦‚ä½¿ç”¨ Kafka æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼› å½“åˆ é™¤ç¼“å­˜å€¼æˆ–è€…æ˜¯æ›´æ–°æ•°æ®åº“å€¼æ“ä½œæˆåŠŸæ—¶ï¼ŒæŠŠè¿™äº›æ¶ˆæ¯ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å»é™¤ï¼ˆä¸¢å¼ƒï¼‰ï¼Œä»¥å…é‡å¤æ“ä½œï¼› å½“åˆ é™¤ç¼“å­˜å€¼æˆ–è€…æ˜¯æ›´æ–°æ•°æ®åº“å€¼æ“ä½œå¤±è´¥æ—¶ï¼Œæ‰§è¡Œå¤±è´¥ç­–ç•¥ï¼Œé‡è¯•æœåŠ¡ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­é‡æ–°è¯»å–ï¼ˆæ¶ˆè´¹ï¼‰è¿™äº›æ¶ˆæ¯ï¼Œç„¶åå†æ¬¡è¿›è¡Œåˆ é™¤æˆ–æ›´æ–°ï¼› åˆ é™¤æˆ–è€…æ›´æ–°å¤±è´¥æ—¶ï¼Œéœ€è¦å†æ¬¡è¿›è¡Œé‡è¯•ï¼Œé‡è¯•è¶…è¿‡çš„ä¸€å®šæ¬¡æ•°ï¼Œå‘ä¸šåŠ¡å±‚å‘é€æŠ¥é”™ä¿¡æ¯ b.è®¢é˜… Binlog å˜æ›´æ—¥å¿—\nåˆ›å»ºæ›´æ–°ç¼“å­˜æœåŠ¡ï¼Œæ¥æ”¶æ•°æ®å˜æ›´çš„ MQ æ¶ˆæ¯ï¼Œç„¶åæ¶ˆè´¹æ¶ˆæ¯ï¼Œæ›´æ–°/åˆ é™¤ Redis ä¸­çš„ç¼“å­˜æ•°æ®ï¼› ä½¿ç”¨ Binlog å®æ—¶æ›´æ–°/åˆ é™¤ Redis ç¼“å­˜ã€‚åˆ©ç”¨ Canalï¼Œå³å°†è´Ÿè´£æ›´æ–°ç¼“å­˜çš„æœåŠ¡ä¼ªè£…æˆä¸€ä¸ª MySQL çš„ä»èŠ‚ç‚¹ï¼Œä» MySQL æ¥æ”¶ Binlogï¼Œè§£æ Binlog ä¹‹åï¼Œå¾—åˆ°å®æ—¶çš„æ•°æ®å˜æ›´ä¿¡æ¯ï¼Œç„¶åæ ¹æ®å˜æ›´ä¿¡æ¯å»æ›´æ–°/åˆ é™¤ Redis ç¼“å­˜ï¼› MQ+Canal ç­–ç•¥ï¼Œå°† Canal Server æ¥æ”¶åˆ°çš„ Binlog æ•°æ®ç›´æ¥æŠ•é€’åˆ° MQ è¿›è¡Œè§£è€¦ï¼Œä½¿ç”¨ MQ å¼‚æ­¥æ¶ˆè´¹ Binlog æ—¥å¿—ï¼Œä»¥æ­¤è¿›è¡Œæ•°æ®åŒæ­¥ï¼› ä¸ç®¡ç”¨ MQ/Canal æˆ–è€… MQ+Canal çš„ç­–ç•¥æ¥å¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼Œå¯¹æ•´ä¸ªæ›´æ–°æœåŠ¡çš„æ•°æ®å¯é æ€§å’Œå®æ—¶æ€§è¦æ±‚éƒ½æ¯”è¾ƒé«˜ï¼Œå¦‚æœäº§ç”Ÿæ•°æ®ä¸¢å¤±æˆ–è€…æ›´æ–°å»¶æ—¶æƒ…å†µï¼Œä¼šé€ æˆ MySQL å’Œ Redis ä¸­çš„æ•°æ®ä¸ä¸€è‡´ã€‚å› æ­¤ï¼Œä½¿ç”¨è¿™ç§ç­–ç•¥æ—¶ï¼Œéœ€è¦è€ƒè™‘å‡ºç°ä¸åŒæ­¥é—®é¢˜æ—¶çš„é™çº§æˆ–è¡¥å¿æ–¹æ¡ˆã€‚ B. é«˜å¹¶å‘æƒ…å†µ ä½¿ç”¨ä»¥ä¸Šç­–ç•¥åï¼Œå¯ä»¥ä¿è¯åœ¨å•çº¿ç¨‹/æ— å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ã€‚ä½†æ˜¯ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œç”±äºæ•°æ®åº“å±‚é¢çš„è¯»å†™å¹¶å‘ï¼Œä¼šå¼•å‘çš„æ•°æ®åº“ä¸ç¼“å­˜æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼ˆæœ¬è´¨æ˜¯åå‘ç”Ÿçš„è¯»è¯·æ±‚å…ˆè¿”å›äº†ï¼‰\n(1) å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“\nå‡è®¾çº¿ç¨‹ A åˆ é™¤ç¼“å­˜å€¼åï¼Œç”±äºç½‘ç»œå»¶è¿Ÿç­‰åŸå› å¯¼è‡´æœªåŠæ›´æ–°æ•°æ®åº“ï¼Œè€Œæ­¤æ—¶ï¼Œçº¿ç¨‹ B å¼€å§‹è¯»å–æ•°æ®æ—¶ä¼šå‘ç°ç¼“å­˜ç¼ºå¤±ï¼Œè¿›è€Œå»æŸ¥è¯¢æ•°æ®åº“ã€‚è€Œå½“çº¿ç¨‹ B ä»æ•°æ®åº“è¯»å–å®Œæ•°æ®ã€æ›´æ–°äº†ç¼“å­˜åï¼Œçº¿ç¨‹ A æ‰å¼€å§‹æ›´æ–°æ•°æ®åº“ï¼Œæ­¤æ—¶ï¼Œä¼šå¯¼è‡´ç¼“å­˜ä¸­çš„æ•°æ®æ˜¯æ—§å€¼ï¼Œè€Œæ•°æ®åº“ä¸­çš„æ˜¯æœ€æ–°å€¼ï¼Œäº§ç”Ÿâ€œæ•°æ®ä¸ä¸€è‡´â€ã€‚å…¶æœ¬è´¨å°±æ˜¯ï¼Œæœ¬åº”åå‘ç”Ÿçš„â€œB çº¿ç¨‹-è¯»è¯·æ±‚â€ å…ˆäº â€œA çº¿ç¨‹-å†™è¯·æ±‚â€ æ‰§è¡Œå¹¶è¿”å›äº†ã€‚\næ—¶åºå¦‚ä¸‹ï¼š\næ—¶é—´ çº¿ç¨‹A çº¿ç¨‹B é—®é¢˜ T1 åˆ é™¤æ•°æ®Xçš„ç¼“å­˜å€¼ T2 1. è¯»å–ç¼“å­˜å€¼Xï¼Œç¼“å­˜ç¼ºå¤±ï¼Œä»æ•°æ®åº“è¯»å–Xå€¼ çº¿ç¨‹Bè¯»åˆ°æ—§å€¼ T3 2. å°†æ•°æ®Xå€¼å†™å…¥ç¼“å­˜ å¯¼è‡´å…¶ä»–çº¿ç¨‹è¯»åˆ°æ—§å€¼ T4 æ›´æ–°æ•°æ®åº“ä¸­Xçš„å€¼ ç¼“å­˜æ—¶æ—§å€¼ï¼Œæ•°æ®åº“æ˜¯æ–°å€¼ã€‚æ•°æ®ä¸ä¸€è‡´ è§£å†³æ–¹æ¡ˆ\na.è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ + å»¶æ—¶åŒåˆ \né€šè¿‡è®¾ç½®ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼Œè‹¥å‘ç”Ÿä¸Šè¿°æ·˜æ±°ç¼“å­˜å¤±è´¥çš„æƒ…å†µï¼Œåˆ™åœ¨ç¼“å­˜è¿‡æœŸåï¼Œè¯»è¯·æ±‚ä»ç„¶å¯ä»¥ä» DB ä¸­è¯»å–æœ€æ–°æ•°æ®å¹¶æ›´æ–°ç¼“å­˜ï¼Œå¯å‡å°æ•°æ®ä¸ä¸€è‡´çš„å½±å“èŒƒå›´ã€‚è™½ç„¶åœ¨ä¸€å®šæ—¶é—´èŒƒå›´å†…æ•°æ®æœ‰å·®å¼‚ï¼Œä½†å¯ä»¥ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚\næ­¤å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡å»¶æ—¶åŒåˆ è¿›è¡Œä¿éšœï¼šåœ¨çº¿ç¨‹ A æ›´æ–°å®Œæ•°æ®åº“å€¼ä»¥åï¼Œè®©å®ƒå…ˆ sleep ä¸€å°æ®µæ—¶é—´ï¼Œç¡®ä¿çº¿ç¨‹ B èƒ½å¤Ÿå…ˆä»æ•°æ®åº“è¯»å–æ•°æ®ï¼Œå†æŠŠç¼ºå¤±çš„æ•°æ®å†™å…¥ç¼“å­˜ï¼ˆæ­¤æ—¶æœ‰å¯èƒ½å†™å…¥çš„æ˜¯æ—§å€¼ï¼‰ï¼Œç„¶åï¼Œçº¿ç¨‹ A å†è¿›è¡Œåˆ é™¤ï¼Œç¡®ä¿ç¼“å­˜ä¸­æœ€ç»ˆä¼šå°†æ˜¯æœ€æ–°çš„å€¼ã€‚åç»­ï¼Œå…¶å®ƒçº¿ç¨‹è¯»å–æ•°æ®æ—¶ï¼Œå‘ç°ç¼“å­˜ç¼ºå¤±ï¼Œä¼šä»æ•°æ®åº“ä¸­è¯»å–æœ€æ–°å€¼\nå»¶æ—¶åˆ é™¤åªæ˜¯ç¡®ä¿æœ€ç»ˆç¼“å­˜ä¸­çš„å€¼ä¸æ•°æ®åº“ä¿æŒä¸€è‡´ã€‚ä¸èƒ½é˜²æ­¢ä¸­é—´çš„ä¸ä¸€è‡´\nredis.delKey(X) db.update(X) Thread.sleep(N) redis.delKey(X) sleep æ—¶é—´ï¼šåœ¨ä¸šåŠ¡ç¨‹åºè¿è¡Œçš„æ—¶å€™ï¼Œç»Ÿè®¡ä¸‹çº¿ç¨‹è¯»æ•°æ®å’Œå†™ç¼“å­˜çš„æ“ä½œæ—¶é—´ï¼Œä»¥æ­¤ä¸ºåŸºç¡€æ¥è¿›è¡Œä¼°ç®—(è¾ƒéš¾)\næ³¨æ„ï¼šå¦‚æœéš¾ä»¥æ¥å— sleep è¿™ç§å†™æ³•ï¼Œå¯ä»¥ä½¿ç”¨å»¶æ—¶é˜Ÿåˆ—è¿›è¡Œæ›¿ä»£ã€‚\nå…ˆåˆ é™¤ç¼“å­˜å€¼å†æ›´æ–°æ•°æ®åº“ï¼Œæœ‰å¯èƒ½å¯¼è‡´è¯·æ±‚å› ç¼“å­˜ç¼ºå¤±è€Œè®¿é—®æ•°æ®åº“ï¼Œç»™æ•°æ®åº“å¸¦æ¥å‹åŠ›ï¼Œä¹Ÿå°±æ˜¯ç¼“å­˜ç©¿é€çš„é—®é¢˜ã€‚é’ˆå¯¹ç¼“å­˜ç©¿é€é—®é¢˜ï¼Œå¯ä»¥ç”¨ç¼“å­˜ç©ºç»“æœã€å¸ƒéš†è¿‡æ»¤å™¨è¿›è¡Œè§£å†³ã€‚\n(2) å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜\nå¦‚æœçº¿ç¨‹ A æ›´æ–°äº†æ•°æ®åº“ä¸­çš„å€¼ï¼Œä½†è¿˜æ²¡æ¥å¾—åŠåˆ é™¤ç¼“å­˜å€¼ï¼Œçº¿ç¨‹ B å°±å¼€å§‹è¯»å–æ•°æ®äº†ï¼Œé‚£ä¹ˆæ­¤æ—¶ï¼Œçº¿ç¨‹ B æŸ¥è¯¢ç¼“å­˜æ—¶ï¼Œå‘ç°ç¼“å­˜å‘½ä¸­ï¼Œå°±ä¼šç›´æ¥ä»ç¼“å­˜ä¸­è¯»å–æ—§å€¼ã€‚å…¶æœ¬è´¨ä¹Ÿæ˜¯ï¼Œæœ¬åº”åå‘ç”Ÿçš„â€œB çº¿ç¨‹-è¯»è¯·æ±‚â€ å…ˆäº â€œA çº¿ç¨‹-åˆ é™¤ç¼“å­˜â€ æ‰§è¡Œå¹¶è¿”å›äº†ã€‚\nå¦‚ä¸‹:\næ—¶é—´ çº¿ç¨‹A çº¿ç¨‹B é—®é¢˜ T1 æ›´æ–°æ•°æ®åº“ä¸­çš„æ•°æ®X T2 è¯»å–æ•°æ®X,å‘½ä¸­ç¼“å­˜ã€‚è¯»å–æ—§å€¼ çº¿ç¨‹Aå°šæœªåˆ é™¤ç¼“å­˜ã€‚å¯¼è‡´çº¿ç¨‹Bè¯»åˆ°æ—§å€¼ T3 æ›´æ–°æ•°æ®åº“ä¸­Xçš„å€¼ å¯¼è‡´å…¶ä»–çº¿ç¨‹è¯»åˆ°æ—§å€¼ æˆ–è€…ï¼Œåœ¨â€å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜â€æ–¹æ¡ˆä¸‹ï¼Œâ€œè¯»å†™åˆ†ç¦» + ä¸»ä»åº“å»¶è¿Ÿâ€ä¹Ÿä¼šå¯¼è‡´ä¸ä¸€è‡´ï¼š\næ—¶é—´ çº¿ç¨‹A çº¿ç¨‹B MySQLé›†ç¾¤ é—®é¢˜ T1 æ›´æ–°ä¸»åº“X=2(åŸå€¼ X=1) T2 åˆ é™¤ç¼“å­˜ T3 æŸ¥è¯¢ç¼“å­˜ï¼Œæ²¡æœ‰å‘½ä¸­ã€‚æŸ¥è¯¢ä»åº“ï¼Œå¾—åˆ°æ—§å€¼ X=1 T4 å°†X=1å†™å…¥ç¼“å­˜ T5 ä»åº“åŒæ­¥å®Œæˆ X=2 ç¼“å­˜ä¸­æ˜¯æ—§å€¼X=1,æ•°æ®åº“(ä¸»+ä»)æ˜¯æ–°å€¼ X=2ã€‚æ•°æ®ä¸ä¸€è‡´ è§£å†³æ–¹æ¡ˆï¼š\na.å»¶è¿Ÿæ¶ˆæ¯ å‡­å€Ÿç»éªŒå‘é€ã€Œå»¶è¿Ÿæ¶ˆæ¯ã€åˆ°é˜Ÿåˆ—ä¸­ï¼Œå»¶è¿Ÿåˆ é™¤ç¼“å­˜ï¼ŒåŒæ—¶ä¹Ÿè¦æ§åˆ¶ä¸»ä»åº“å»¶è¿Ÿï¼Œå°½å¯èƒ½é™ä½ä¸ä¸€è‡´å‘ç”Ÿçš„æ¦‚ç‡\nb.è®¢é˜… binlogï¼Œå¼‚æ­¥åˆ é™¤ é€šè¿‡æ•°æ®åº“çš„ binlog æ¥å¼‚æ­¥æ·˜æ±° keyï¼Œåˆ©ç”¨å·¥å…·(canal)å°† binlog æ—¥å¿—é‡‡é›†å‘é€åˆ° MQ ä¸­ï¼Œç„¶åé€šè¿‡ ACK æœºåˆ¶ç¡®è®¤å¤„ç†åˆ é™¤ç¼“å­˜ã€‚\nc.åˆ é™¤æ¶ˆæ¯å†™å…¥æ•°æ®åº“ é€šè¿‡æ¯”å¯¹æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œè¿›è¡Œåˆ é™¤ç¡®è®¤ å…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜ï¼Œæœ‰å¯èƒ½å¯¼è‡´è¯·æ±‚å› ç¼“å­˜ç¼ºå¤±è€Œè®¿é—®æ•°æ®åº“ï¼Œç»™æ•°æ®åº“å¸¦æ¥å‹åŠ›ï¼Œä¹Ÿå°±æ˜¯ç¼“å­˜ç©¿é€çš„é—®é¢˜ã€‚é’ˆå¯¹ç¼“å­˜ç©¿é€é—®é¢˜ï¼Œå¯ä»¥ç”¨ç¼“å­˜ç©ºç»“æœã€å¸ƒéš†è¿‡æ»¤å™¨è¿›è¡Œè§£å†³ã€‚\nd.åŠ é” æ›´æ–°æ•°æ®æ—¶ï¼ŒåŠ å†™é”ï¼›æŸ¥è¯¢æ•°æ®æ—¶ï¼ŒåŠ è¯»é” ä¿è¯ä¸¤æ­¥æ“ä½œçš„â€œåŸå­æ€§â€ï¼Œä½¿å¾—æ“ä½œå¯ä»¥ä¸²è¡Œæ‰§è¡Œã€‚â€œåŸå­æ€§â€çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿä¸å¯åˆ†å‰²åªæ˜¯å¤–åœ¨è¡¨ç°ï¼Œå…¶æœ¬è´¨æ˜¯å¤šä¸ªèµ„æºé—´æœ‰ä¸€è‡´æ€§çš„è¦æ±‚ï¼Œæ“ä½œçš„ä¸­é—´çŠ¶æ€å¯¹å¤–ä¸å¯è§ã€‚\nå»ºè®®ï¼š ä¼˜å…ˆä½¿ç”¨â€œå…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜â€çš„æ‰§è¡Œæ—¶åºï¼ŒåŸå› ä¸»è¦æœ‰ä¸¤ä¸ªï¼š\nå…ˆåˆ é™¤ç¼“å­˜å€¼å†æ›´æ–°æ•°æ®åº“ï¼Œæœ‰å¯èƒ½å¯¼è‡´è¯·æ±‚å› ç¼“å­˜ç¼ºå¤±è€Œè®¿é—®æ•°æ®åº“ï¼Œç»™æ•°æ®åº“å¸¦æ¥å‹åŠ›ï¼› ä¸šåŠ¡åº”ç”¨ä¸­è¯»å–æ•°æ®åº“å’Œå†™ç¼“å­˜çš„æ—¶é—´æœ‰æ—¶ä¸å¥½ä¼°ç®—ï¼Œè¿›è€Œå¯¼è‡´å»¶è¿ŸåŒåˆ ä¸­çš„ sleep æ—¶é—´ä¸å¥½è®¾ç½®ã€‚ è¯»å†™ç¼“å­˜ï¼ˆæ›´æ–°æ•°æ®åº“+æ›´æ–°ç¼“å­˜ï¼‰ è¯»å†™ç¼“å­˜ï¼šå¢åˆ æ”¹åœ¨ç¼“å­˜ä¸­è¿›è¡Œï¼Œå¹¶é‡‡å–ç›¸åº”çš„å›å†™ç­–ç•¥ï¼ŒåŒæ­¥æ•°æ®åˆ°æ•°æ®åº“ä¸­\nåŒæ­¥ç›´å†™ï¼šä½¿ç”¨äº‹åŠ¡ï¼Œä¿è¯ç¼“å­˜å’Œæ•°æ®æ›´æ–°çš„åŸå­æ€§ï¼Œå¹¶è¿›è¡Œå¤±è´¥é‡è¯•ï¼ˆå¦‚æœ Redis æœ¬èº«å‡ºç°æ•…éšœï¼Œä¼šé™ä½æœåŠ¡çš„æ€§èƒ½å’Œå¯ç”¨æ€§ï¼‰\nå¼‚æ­¥å›å†™ï¼šå†™ç¼“å­˜æ—¶ä¸åŒæ­¥å†™æ•°æ®åº“ï¼Œç­‰åˆ°æ•°æ®ä»ç¼“å­˜ä¸­æ·˜æ±°æ—¶ï¼Œå†å†™å›æ•°æ®åº“ï¼ˆæ²¡å†™å›æ•°æ®åº“å‰ï¼Œç¼“å­˜å‘ç”Ÿæ•…éšœï¼Œä¼šé€ æˆæ•°æ®ä¸¢å¤±ï¼‰ è¯¥ç­–ç•¥åœ¨ç§’æ€åœºä¸­æœ‰è§åˆ°è¿‡ï¼Œä¸šåŠ¡å±‚ç›´æ¥å¯¹ç¼“å­˜ä¸­çš„ç§’æ€å•†å“åº“å­˜ä¿¡æ¯è¿›è¡Œæ“ä½œï¼Œä¸€æ®µæ—¶é—´åå†å›å†™æ•°æ®åº“ã€‚\nä¸€è‡´æ€§ï¼šåŒæ­¥ç›´å†™ \u0026gt; å¼‚æ­¥å›å†™ å› æ­¤ï¼Œå¯¹äºè¯»å†™ç¼“å­˜ï¼Œè¦ä¿æŒæ•°æ®å¼ºä¸€è‡´æ€§çš„ä¸»è¦æ€è·¯æ˜¯ï¼šåˆ©ç”¨åŒæ­¥ç›´å†™ åŒæ­¥ç›´å†™ä¹Ÿå­˜åœ¨ä¸¤ä¸ªæ“ä½œçš„æ—¶åºé—®é¢˜ï¼šæ›´æ–°æ•°æ®åº“å’Œæ›´æ–°ç¼“å­˜\næ— å¹¶å‘æƒ…å†µ æ‰§è¡Œé¡ºåº æ½œåœ¨é—®é¢˜ ç»“æœ æ˜¯å¦å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜ è§£å†³ç­–ç•¥ å…ˆæ›´æ–°ç¼“å­˜ï¼Œåæ›´æ–°æ•°æ®åº“ ç¼“å­˜æ›´æ–°æˆåŠŸï¼Œæ•°æ®åº“æ›´æ–°å¤±è´¥ æ•°æ®åº“ä¸ºæ—§å€¼ æ˜¯ æ¶ˆæ¯é˜Ÿåˆ—+é‡è¯•æœºåˆ¶ å…ˆæ›´æ–°æ•°æ®åº“ï¼Œåæ›´æ–°ç¼“å­˜ æ•°æ®åº“æ›´æ–°æˆåŠŸï¼Œç¼“å­˜æ›´æ–°å¤±è´¥ è¯·æ±‚å‘½ä¸­ç¼“å­˜ï¼Œè¯»å–ç¼“å­˜ä¸­çš„æ—§å€¼ æ˜¯ æ¶ˆæ¯é˜Ÿåˆ—+é‡è¯•æœºåˆ¶ï¼›è®¢é˜…Binlogæ—¥å¿— é«˜å¹¶å‘æƒ…å†µ æœ‰ä¸€ä¸‹å››ç§æƒ…å†µ\næ—¶åº å¹¶å‘ç±»å‹ æ½œåœ¨é—®é¢˜ å½±å“ç¨‹åº¦ å…ˆæ›´æ–°æ•°æ®åº“ï¼Œåæ›´æ–°ç¼“å­˜ å†™+è¯» å¹¶å‘ 1. çº¿ç¨‹Aå…ˆæ›´æ–°æ•°æ®åº“\n2. çº¿ç¨‹Bè¯»å–æ•°æ®ï¼Œå‘½ä¸­ç¼“å­˜ï¼Œè¯»å–åˆ°æ—§å€¼\n3. çº¿ç¨‹Aæ›´æ–°ç¼“å­˜æˆåŠŸï¼Œåç»­è¯·æ±‚ä¼šå‘½ä¸­ç¼“å­˜ï¼Œå¾—åˆ°æ–°å€¼ çº¿ç¨‹Aæœªæ›´æ–°å®Œç¼“å­˜ä¹‹å‰ï¼Œè¿™æœŸé—´çš„è¯»è¯·æ±‚ä¼šè¯»åˆ°çŸ­æš‚æ—§å€¼ã€‚å¯¹ä¸šåŠ¡å½±å“çŸ­æš‚ å…ˆæ›´æ–°ç¼“å­˜ï¼Œåæ›´æ–°æ•°æ®åº“ å†™+è¯» å¹¶å‘ 1. çº¿ç¨‹Aå…ˆæ›´æ–°ç¼“å­˜æˆåŠŸ\n2. çº¿ç¨‹Bè¯»å–æ•°æ®ï¼Œæ­¤æ—¶çº¿ç¨‹Bå‘½ä¸­ç¼“å­˜ï¼Œè¯»å–åˆ°æœ€æ–°å€¼\n3.çº¿ç¨‹Aæ›´æ–°æ•°æ®åº“æˆåŠŸ è™½ç„¶çº¿ç¨‹Aè¿˜æœªæ›´æ–°å®Œæ•°æ®åº“ï¼Œæ•°æ®åº“ä¸ç¼“å­˜ä¼šå­˜åœ¨çŸ­æš‚çš„ä¸ä¸€è‡´ã€‚ä½†åœ¨è¿™ä¹‹å‰è¿›æ¥çš„è¯»è¯·æ±‚éƒ½èƒ½å‘½ä¸­ç¼“å­˜ï¼Œè·å–åˆ°æœ€æ–°å€¼ï¼Œå¯¹ä¸šåŠ¡å½±å“è¾ƒå° å…ˆæ›´æ–°æ•°æ®åº“ï¼Œåæ›´æ–°ç¼“å­˜ å†™+å†™ å¹¶å‘ 1.çº¿ç¨‹A,BåŒæ—¶æ›´æ–°åŒä¸€æ¡æ•°æ®\n2. æ›´æ–°ç¼“æ•°æ®åº“çš„é¡ºåºæ˜¯å…ˆAåB\n3. æ›´æ–°ç¼“å­˜çš„é¡ºåºæ˜¯å…ˆBåA ä¼šå¯¼è‡´æ•°æ®åº“ä¸ç¼“å­˜ä¸ä¸€è‡´ã€‚å¯¹ä¸šåŠ¡å½±å“è¾ƒå¤§ å…ˆæ›´æ–°ç¼“å­˜ï¼Œåæ›´æ–°æ•°æ®åº“ å†™+å†™ å¹¶å‘ 1.çº¿ç¨‹A,BåŒæ—¶æ›´æ–°åŒä¸€æ¡æ•°æ®\n2. æ›´æ–°ç¼“å­˜çš„é¡ºåºæ˜¯å…ˆAåB\n3. æ›´æ–°æ•°æ®åº“çš„é¡ºåºæ˜¯å…ˆBåA ä¼šå¯¼è‡´æ•°æ®åº“ä¸ç¼“å­˜ä¸ä¸€è‡´ã€‚å¯¹ä¸šåŠ¡å½±å“è¾ƒå¤§ é’ˆå¯¹åœºæ™¯ 1 å’Œ 2 çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼šä¿å­˜è¯·æ±‚å¯¹ç¼“å­˜çš„è¯»å–è®°å½•ï¼Œå»¶æ—¶æ¶ˆæ¯æ¯”è¾ƒï¼Œå‘ç°ä¸ä¸€è‡´åï¼Œåšä¸šåŠ¡è¡¥å¿\né’ˆå¯¹åœºæ™¯ 3 å’Œ 4 çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š\nå¯¹äºå†™è¯·æ±‚ï¼Œéœ€è¦é…åˆåˆ†å¸ƒå¼é”ä½¿ç”¨ã€‚å†™è¯·æ±‚è¿›æ¥æ—¶ï¼Œé’ˆå¯¹åŒä¸€ä¸ªèµ„æºçš„ä¿®æ”¹æ“ä½œï¼Œå…ˆåŠ åˆ†å¸ƒå¼é”ï¼Œä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ›´æ–°æ•°æ®åº“å’Œç¼“å­˜ï¼›æ²¡æœ‰æ‹¿åˆ°é”çš„çº¿ç¨‹æŠŠæ“ä½œæ”¾å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œå»¶æ—¶å¤„ç†ã€‚ç”¨è¿™ç§æ–¹å¼ä¿è¯å¤šä¸ªçº¿ç¨‹æ“ä½œåŒä¸€èµ„æºçš„é¡ºåºæ€§ï¼Œä»¥æ­¤ä¿è¯ä¸€è‡´æ€§ã€‚\nå¦‚å›¾ï¼š\nå…¶ä¸­ï¼Œåˆ†å¸ƒå¼é”çš„å®ç°å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š\nä¹è§‚é”\nä½¿ç”¨ç‰ˆæœ¬å·ã€updatetimeï¼›ç¼“å­˜ä¸­ï¼Œåªå…è®¸é«˜ç‰ˆæœ¬è¦†ç›–ä½ç‰ˆæœ¬ Watachå®ç°Redisä¹è§‚é”\nwatchç›‘æ§rediskeyçš„çŠ¶æ€å€¼ï¼Œåˆ›å»ºredisäº‹åŠ¡ï¼Œkey+1ï¼Œæ‰§è¡Œäº‹åŠ¡ï¼Œkeyè¢«ä¿®æ”¹è¿‡åˆ™å›æ»š setnx\nè·å–é”ï¼šset/setnxï¼›é‡Šæ”¾é”ï¼šdelå‘½ä»¤/Luaè„šæœ¬ Redissonåˆ†å¸ƒå¼é”\nåˆ©ç”¨Redisçš„Hashç»“æ„ä½œä¸ºå‚¨å­˜å•å…ƒï¼Œå°†ä¸šåŠ¡æŒ‡å®šçš„åç§°ä½œä¸ºkeyï¼Œå°†éšæœºUUIDå’Œçº¿ç¨‹IDä½œä¸ºfieldï¼Œæœ€åå°†åŠ é”çš„æ¬¡æ•°ä½œä¸ºvalueæ¥å‚¨å­˜ï¼›çº¿ç¨‹å®‰å…¨ å¼ºä¸€è‡´æ€§ç­–ç•¥ ä¸Šè¿°ç­–ç•¥åªèƒ½ä¿è¯æ•°æ®çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚è¦æƒ³åšåˆ°å¼ºä¸€è‡´ï¼Œæœ€å¸¸è§çš„æ–¹æ¡ˆæ˜¯ 2PCã€3PCã€Paxosã€Raft è¿™ç±»ä¸€è‡´æ€§åè®®ï¼Œä½†å®ƒä»¬çš„æ€§èƒ½å¾€å¾€æ¯”è¾ƒå·®ï¼Œè€Œä¸”è¿™äº›æ–¹æ¡ˆä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œè¿˜è¦è€ƒè™‘å„ç§å®¹é”™é—®é¢˜ã€‚å¦‚æœä¸šåŠ¡å±‚è¦æ±‚å¿…é¡»è¯»å–æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹ç­–ç•¥ï¼š\nï¼ˆ1ï¼‰æš‚å­˜å¹¶å‘è¯»è¯·æ±‚\nåœ¨æ›´æ–°æ•°æ®åº“æ—¶ï¼Œå…ˆåœ¨ Redis ç¼“å­˜å®¢æˆ·ç«¯æš‚å­˜å¹¶å‘è¯»è¯·æ±‚ï¼Œç­‰æ•°æ®åº“æ›´æ–°å®Œã€ç¼“å­˜å€¼åˆ é™¤åï¼Œå†è¯»å–æ•°æ®ï¼Œä»è€Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚\nï¼ˆ2ï¼‰ä¸²è¡ŒåŒ–\nè¯»å†™è¯·æ±‚å…¥é˜Ÿåˆ—ï¼Œå·¥ä½œçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡æ¥ä¾æ¬¡æ‰§è¡Œ\nä¿®æ”¹æœåŠ¡ Service è¿æ¥æ± ï¼Œid å–æ¨¡é€‰å–æœåŠ¡è¿æ¥ï¼Œèƒ½å¤Ÿä¿è¯åŒä¸€ä¸ªæ•°æ®çš„è¯»å†™éƒ½è½åœ¨åŒä¸€ä¸ªåç«¯æœåŠ¡ä¸Š\nä¿®æ”¹æ•°æ®åº“ DB è¿æ¥æ± ï¼Œid å–æ¨¡é€‰å– DB è¿æ¥ï¼Œèƒ½å¤Ÿä¿è¯åŒä¸€ä¸ªæ•°æ®çš„è¯»å†™åœ¨æ•°æ®åº“å±‚é¢æ˜¯ä¸²è¡Œçš„\nï¼ˆ3ï¼‰ä½¿ç”¨ Redis åˆ†å¸ƒå¼è¯»å†™é”\nå°†æ·˜æ±°ç¼“å­˜ä¸æ›´æ–°åº“è¡¨æ”¾å…¥åŒä¸€æŠŠå†™é”ä¸­ï¼Œä¸å…¶å®ƒè¯»è¯·æ±‚äº’æ–¥ï¼Œé˜²æ­¢å…¶é—´äº§ç”Ÿæ—§æ•°æ®ã€‚è¯»å†™äº’æ–¥ã€å†™å†™äº’æ–¥ã€è¯»è¯»å…±äº«ï¼Œå¯æ»¡è¶³è¯»å¤šå†™å°‘çš„åœºæ™¯æ•°æ®ä¸€è‡´ï¼Œä¹Ÿä¿è¯äº†å¹¶å‘æ€§ã€‚å¹¶æ ¹æ®é€»è¾‘å¹³å‡è¿è¡Œæ—¶é—´ã€å“åº”è¶…æ—¶æ—¶é—´æ¥ç¡®å®šè¿‡æœŸæ—¶é—´ã€‚\næ€»ç»“ ![](/images/20211111222206819_26974.png =968x)\né’ˆå¯¹è¯»å†™ç¼“å­˜æ—¶ï¼šåŒæ­¥ç›´å†™ï¼Œæ›´æ–°æ•°æ®åº“+æ›´æ–°ç¼“å­˜ï¼š é’ˆå¯¹åªè¯»ç¼“å­˜æ—¶ï¼šæ›´æ–°æ•°æ®åº“+åˆ é™¤ç¼“å­˜ï¼š ![](/images/20211111222315560_29131.png =968x)\nè¾ƒä¸ºé€šç”¨çš„ä¸€è‡´æ€§ç­–ç•¥æ‹Ÿå®šï¼š åœ¨å¹¶å‘åœºæ™¯ä¸‹ï¼Œä½¿ç”¨ â€œæ›´æ–°æ•°æ®åº“ + æ›´æ–°ç¼“å­˜â€ éœ€è¦ç”¨åˆ†å¸ƒå¼é”ä¿è¯ç¼“å­˜å’Œæ•°æ®ä¸€è‡´æ€§ï¼Œä¸”å¯èƒ½å­˜åœ¨â€ç¼“å­˜èµ„æºæµªè´¹â€œå’Œâ€æœºå™¨æ€§èƒ½æµªè´¹â€œçš„æƒ…å†µï¼›ä¸€èˆ¬æ¨èä½¿ç”¨ â€œæ›´æ–°æ•°æ®åº“ + åˆ é™¤ç¼“å­˜â€ çš„æ–¹æ¡ˆã€‚å¦‚æœæ ¹æ®éœ€è¦ï¼Œçƒ­ç‚¹æ•°æ®è¾ƒå¤šï¼Œå¯ä»¥ä½¿ç”¨ â€œæ›´æ–°æ•°æ®åº“ + æ›´æ–°ç¼“å­˜â€ ç­–ç•¥ã€‚\nåœ¨ â€œæ›´æ–°æ•°æ®åº“ + åˆ é™¤ç¼“å­˜â€ çš„æ–¹æ¡ˆä¸­ï¼Œæ¨èä½¿ç”¨æ¨èç”¨ â€œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜â€ ç­–ç•¥ï¼Œå› ä¸ºå…ˆåˆ é™¤ç¼“å­˜å¯èƒ½ä¼šå¯¼è‡´å¤§é‡è¯·æ±‚è½åˆ°æ•°æ®åº“ï¼Œè€Œä¸”å»¶è¿ŸåŒåˆ çš„æ—¶é—´å¾ˆéš¾è¯„ä¼°ã€‚åœ¨ â€œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜â€ ç­–ç•¥ä¸­ï¼Œå¯ä»¥ä½¿ç”¨â€œæ¶ˆæ¯é˜Ÿåˆ—+é‡è¯•æœºåˆ¶â€ çš„æ–¹æ¡ˆä¿è¯ç¼“å­˜çš„åˆ é™¤ã€‚å¹¶é€šè¿‡ â€œè®¢é˜… binlogâ€ è¿›è¡Œç¼“å­˜æ¯”å¯¹ï¼ŒåŠ ä¸Šä¸€å±‚ä¿éšœã€‚\næ­¤å¤–ï¼Œéœ€è¦é€šè¿‡åˆå§‹åŒ–ç¼“å­˜é¢„çƒ­ã€å¤šæ•°æ®æºè§¦å‘ã€å»¶è¿Ÿæ¶ˆæ¯æ¯”å¯¹ç­‰ç­–ç•¥è¿›è¡Œè¾…åŠ©å’Œè¡¥å¿ã€‚ã€å¤šç§æ•°æ®æ›´æ–°è§¦å‘æºï¼šå®šæ—¶ä»»åŠ¡æ‰«æï¼Œä¸šåŠ¡ç³»ç»Ÿ MQã€binlog å˜æ›´ MQï¼Œç›¸äº’ä¹‹é—´ä½œä¸ºäº’è¡¥æ¥ä¿è¯æ•°æ®ä¸ä¼šæ¼æ›´æ–°ã€‘\næ•°æ®ä¸€è‡´æ€§ä¸­éœ€è¦æ³¨æ„çš„å…¶ä»–é—®é¢˜æœ‰å“ªäº›ï¼Ÿ k-v å¤§å°çš„åˆç†è®¾ç½®\nRedis key å¤§å°è®¾è®¡ï¼šç”±äºç½‘ç»œçš„ä¸€æ¬¡ä¼ è¾“ MTU æœ€å¤§ä¸º 1500 å­—èŠ‚ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯é«˜æ•ˆçš„æ€§èƒ½ï¼Œå»ºè®®å•ä¸ª k-v å¤§å°ä¸è¶…è¿‡ 1KBï¼Œä¸€æ¬¡ç½‘ç»œä¼ è¾“å°±èƒ½å®Œæˆï¼Œé¿å…å¤šæ¬¡ç½‘ç»œäº¤äº’ï¼›k-v æ˜¯è¶Šå°æ€§èƒ½è¶Šå¥½Redis çƒ­ keyï¼šï¼ˆ1ï¼‰ å½“ä¸šåŠ¡é‡åˆ°å•ä¸ªè¯»çƒ­ keyï¼Œé€šè¿‡å¢åŠ å‰¯æœ¬æ¥æé«˜è¯»èƒ½åŠ›æˆ–æ˜¯ç”¨ hashtag æŠŠ key å­˜å¤šä»½åœ¨å¤šä¸ªåˆ†ç‰‡ä¸­ï¼›ï¼ˆ2ï¼‰å½“ä¸šåŠ¡é‡åˆ°å•ä¸ªå†™çƒ­ keyï¼Œéœ€ä¸šåŠ¡æ‹†åˆ†è¿™ä¸ª key çš„åŠŸèƒ½ï¼Œå±äºè®¾è®¡ä¸åˆç†- å½“ä¸šåŠ¡é‡åˆ°çƒ­åˆ†ç‰‡ï¼Œå³å¤šä¸ªçƒ­ key åœ¨åŒä¸€ä¸ªåˆ†ç‰‡ä¸Šå¯¼è‡´å•åˆ†ç‰‡ cpu é«˜ï¼Œå¯é€šè¿‡ hashtag æ–¹å¼æ‰“æ•£â€”â€”[å¼•è‡ªè…¾è®¯äº‘æŠ€æœ¯åˆ†äº«] é¿å…å…¶ä»–é—®é¢˜å¯¼è‡´ç¼“å­˜æœåŠ¡å™¨å´©æºƒï¼Œè¿›è€Œç®€ç›´å¯¼è‡´æ•°æ®ä¸€è‡´æ€§ç­–ç•¥å¤±æ•ˆ\nç¼“å­˜ç©¿é€ã€ç¼“å­˜å‡»ç©¿ã€ç¼“å­˜é›ªå´©ã€æœºå™¨æ•…éšœç­‰é—®é¢˜ï¼š\næ€»ç»“ å¯¹äºè¯»å¤šå†™å°‘çš„æœåŠ¡ï¼ŒåŠ å…¥ç¼“å­˜å¯ä»¥æé«˜æ€§èƒ½ï¼Œå¦‚æœå†™å¤šè¯»å°‘ï¼Œåˆä¸èƒ½å®¹å¿ç¼“å­˜æ•°æ®çš„ä¸ä¸€è‡´ï¼Œé‚£å°±æ²¡å¿…è¦åŠ ç¼“å­˜äº†ï¼Œç›´æ¥æ“ä½œæ•°æ®åº“ã€‚\nå½“ç„¶ï¼Œå¦‚æœæ•°æ®åº“æ‰›ä¸ä½å‹åŠ›ï¼Œè¿˜å¯ä»¥æŠŠç¼“å­˜ä½œä¸ºå“¦æ•°æ®è¯»å†™çš„ä¸»å­˜å‚¨ï¼Œç„¶åå¼‚æ­¥çš„å°†æ•°æ®åŒæ­¥åˆ°æ•°æ®åº“ï¼Œæ­¤æ—¶æ•°æ®åº“åªåšä¸ºæ•°æ®çš„å¤‡ä»½\næ”¾å…¥ç¼“å­˜çš„æ•°æ®åº”è¯¥æ˜¯å¯¹å®æ—¶æ€§ã€ä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯å¾ˆé«˜çš„æ•°æ®ã€‚åˆ‡è®°ä¸è¦ä¸ºäº†ç”¨ç¼“å­˜ï¼ŒåŒæ—¶åˆè¦ä¿è¯ç»å¯¹çš„ä¸€è‡´æ€§åšå¤§é‡çš„è¿‡åº¦è®¾è®¡å’Œæ§åˆ¶ï¼Œå¢åŠ ç³»ç»Ÿå¤æ‚æ€§ï¼\nå‚è€ƒèµ„æ–™ https://mp.weixin.qq.com/s/GU3cbUkI84IMwttDz16P3w ","date":"2021-11-11T20:29:30Z","permalink":"https://dccmmtop.github.io/posts/mysql%E5%92%8Credis%E7%9A%84%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7%E9%97%AE%E9%A2%98/","section":"posts","tags":["æ¶æ„","redis"],"title":"MySQL å’Œ Redis çš„æ•°æ®ä¸€è‡´æ€§é—®é¢˜"},{"categories":null,"contents":"#rubyçš„åˆ†å¸ƒå¼é”å®ç°ï¼ŒåŸºäºredis class Redlock DefaultRetryCount=3 DefaultRetryDelay=200 ClockDriftFactor = 0.01 UnlockScript=\u0026#39; if redis.call(\u0026#34;get\u0026#34;,KEYS[1]) == ARGV[1] then return redis.call(\u0026#34;del\u0026#34;,KEYS[1]) else return 0 end\u0026#39; def initialize(*server_urls) @servers = [] server_urls.each{|url| @servers \u0026lt;\u0026lt; Redis.new(:url =\u0026gt; url) } @quorum = server_urls.length / 2 + 1 @retry_count = DefaultRetryCount @retry_delay = DefaultRetryDelay @urandom = File.new(\u0026#34;/dev/urandom\u0026#34;) end def set_retry(count,delay) @retry_count = count @retry_delay = delay end def lock_instance(redis,resource,val,ttl) begin return redis.client.call([:set,resource,val,:nx,:px,ttl]) rescue return false end end def unlock_instance(redis,resource,val) begin redis.client.call([:eval,UnlockScript,1,resource,val]) rescue # Nothing to do, unlocking is just a best-effort attempt. end end def get_unique_lock_id val = \u0026#34;\u0026#34; bytes = @urandom.read(20) bytes.each_byte{|b| val \u0026lt;\u0026lt; b.to_s(32) } val end def lock(resource,ttl) val = get_unique_lock_id @retry_count.times { n = 0 start_time = (Time.now.to_f*1000).to_i @servers.each{|s| n += 1 if lock_instance(s,resource,val,ttl) } # Add 2 milliseconds to the drift to account for Redis expires # precision, which is 1 milliescond, plus 1 millisecond min drift # for small TTLs. drift = (ttl*ClockDriftFactor).to_i + 2 validity_time = ttl-((Time.now.to_f*1000).to_i - start_time)-drift if n \u0026gt;= @quorum \u0026amp;\u0026amp; validity_time \u0026gt; 0 return { :validity =\u0026gt; validity_time, :resource =\u0026gt; resource, :val =\u0026gt; val } else @servers.each{|s| unlock_instance(s,resource,val) } end # Wait a random delay before to retry sleep(rand(@retry_delay).to_f/1000) } return false end def unlock(lock) @servers.each{|s| unlock_instance(s,lock[:resource],lock[:val]) } rescue =\u0026gt;e puts \u0026#34;RedLock err:\u0026#34; + e.to_s end end #åˆå§‹åŒ–åˆ†å¸ƒå¼é”ï¼ˆä¸€èˆ¬åœ¨åˆå§‹åŒ–ç¨‹åºä¸­ config/initializers/xxx.rbï¼‰\n$distributed_locks = Redlock.new(\u0026ldquo;redis://#{REDIS_HOST}:6379\u0026rdquo;)\nä½¿ç”¨ç¤ºä¾‹\ndef self.apply_join(user_id, tag_info_id) # è®¾ç½®é‡è¯•æ¬¡æ•°å’Œæ¯æ¬¡é‡è¯•çš„é—´éš”æ—¶é—´ $distributed_locks.set_retry(1, 100) # æŒæœ‰é”çš„æ—¶é—´ tag_user_lock = $distributed_locks.lock(\u0026#34;#{user_id}_#{tag_info_id}\u0026#34;, 60 * 1000) result = false begin if tag_user_lock unless TagUserTag.where(user_id: user_id, tag_id: tag_info_id).first # å¹¶å‘å¯¼è‡´åˆ›å»ºå¤šæ¡ç›¸åŒè®°å½• TagUserTag.where(user_id: user_id, tag_id: tag_info_id, status: 1).delete_all TagUserTag.create(user_id: user_id, tag_id: tag_info_id, status: 1) update_user_tag_cache_status(user_id, tag_info_id, 1) result = true else Rails.logger.info(\u0026#34;è¯¥ç”¨æˆ·å·²ç»åœ¨æœ¬ç³»ç»Ÿæ ‡ç­¾ä¸‹ï¼Œæˆ– å·²æå‡ºç”³è¯·\u0026#34;) end end # é‡Šæ”¾é” $distributed_locks.unlock(tag_user_lock) rescue =\u0026gt; e # é‡Šæ”¾é” $distributed_locks.unlock(tag_user_lock) end result end ","date":"2021-11-11T20:24:42Z","permalink":"https://dccmmtop.github.io/posts/ruby%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/","section":"posts","tags":["ruby"],"title":"rubyåˆ†å¸ƒå¼é”"},{"categories":null,"contents":"å¯¹Goè¯­è¨€æ¥è¯´ï¼ŒCSVæ–‡ä»¶å¯ä»¥é€šè¿‡encoding/csvåŒ…è¿›è¡Œæ“ä½œï¼Œä¸‹é¢é€šè¿‡è¿™ä¸ªåŒ…æ¥è¯»å†™CSVæ–‡ä»¶ã€‚\nç”±äºç¨‹åºåœ¨æ¥ä¸‹æ¥çš„ä»£ç ä¸­ç«‹å³å°±è¦å¯¹å†™å…¥çš„posts.csvæ–‡ä»¶è¿›è¡Œè¯»å–ï¼Œè€Œåˆšåˆšå†™å…¥çš„æ•°æ®æœ‰å¯èƒ½è¿˜æ»ç•™åœ¨ç¼“å†²åŒºä¸­ï¼Œæ‰€ä»¥ç¨‹åºå¿…é¡»è°ƒç”¨å†™å…¥å™¨çš„Flushæ–¹æ³•æ¥ä¿è¯ç¼“å†²åŒºä¸­çš„æ‰€æœ‰æ•°æ®éƒ½å·²ç»è¢«æ­£ç¡®åœ°å†™å…¥æ–‡ä»¶é‡Œé¢äº†ã€‚\nè¯»å–CSVæ–‡ä»¶çš„æ–¹æ³•å’Œå†™äººæ–‡ä»¶çš„æ–¹æ³•ç±»ä¼¼ã€‚é¦–å…ˆï¼Œç¨‹åºä¼šæ‰“å¼€æ–‡ä»¶ï¼Œå¹¶é€šè¿‡å°†æ–‡ä»¶ä¼ é€’ç»™NewReaderå‡½æ•°æ¥åˆ›å»ºå‡ºä¸€ä¸ªè¯»å–å™¨ï¼ˆreaderï¼‰ï¼Œæ¥ç€ï¼Œç¨‹åºä¼šå°†è¯»å–å™¨çš„FieldsPer Recordå­—æ®µçš„å€¼è®¾ç½®ä¸ºè´Ÿæ•°ï¼Œè¿™æ ·çš„è¯ï¼Œå³ä½¿è¯»å–å™¨åœ¨è¯»å–æ—¶å‘ç°è®°å½•ï¼ˆrecordï¼‰é‡Œé¢ç¼ºå°‘äº†æŸäº›å­—æ®µï¼Œè¯»å–è¿›ç¨‹ä¹Ÿä¸ä¼šè¢«ä¸­æ–­ã€‚\nåä¹‹ï¼Œå¦‚æœFieldsPerRecordå­—æ®µçš„å€¼ä¸ºæ­£æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼å°±æ˜¯ç”¨æˆ·è¦æ±‚ä»æ¯æ¡è®°å½•é‡Œé¢è¯»å–å‡ºçš„å­—æ®µæ•°é‡ï¼Œå½“è¯»å–å™¨ä»CsVæ–‡ä»¶é‡Œé¢è¯»å–å‡ºçš„å­—æ®µæ•°é‡å°‘äºè¿™ä¸ªå€¼æ—¶ï¼ŒGoå°±ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ã€‚\næœ€åï¼Œå¦‚æœFieldsPerRecordå­—æ®µçš„å€¼ä¸º0ï¼Œé‚£ä¹ˆè¯»å–å™¨å°±ä¼šå°†è¯»å–åˆ°çš„ç¬¬ä¸€æ¡è®°å½•çš„å­—æ®µæ•°é‡ç”¨ä½œFieldsPerRecordçš„å€¼ã€‚\nåœ¨è®¾ç½®å¥½FieldsPerRecordå­—æ®µä¹‹åï¼Œç¨‹åºä¼šè°ƒç”¨è¯»å–å™¨çš„ReadAl1æ–¹æ³•ï¼Œä¸€æ¬¡æ€§åœ°è¯»å–æ–‡ä»¶ä¸­åŒ…å«çš„æ‰€æœ‰è®°å½•ï¼›ä½†å¦‚æœæ–‡ä»¶çš„ä½“ç§¯è¾ƒå¤§ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥é€šè¿‡è¯»å–å™¨æä¾›çš„å…¶ä»–æ–¹æ³•ï¼Œä»¥æ¯æ¬¡ä¸€æ¡è®°å½•çš„æ–¹å¼è¯»å–æ–‡ä»¶ã€‚\npackage main import ( \u0026#34;encoding/csv\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;os\u0026#34; \u0026#34;strconv\u0026#34; ) type Blog struct { Id int Content string } func main(){ csvFile, err := os.Create(\u0026#34;testCsv.csv\u0026#34;) if err != nil { panic(err) } defer csvFile.Close() csvWriter := csv.NewWriter(csvFile) allPost := []Blog{ {Id: 1, Content: \u0026#34;æ˜¨å¤œè¥¿é£å‡‹æ•æ ‘\u0026#34;}, {Id: 2, Content: \u0026#34;å¿½å¦‚ä¸€å¤œæ˜¥é£æ¥\u0026#34;}, {Id: 3, Content: \u0026#34;åƒæ ‘ä¸‡æ ‘æ¢¨èŠ±å¼€\u0026#34;}, {Id: 4, Content: \u0026#34;å·æˆ‘å±‹ä¸Šä¸‰é‡èŒ…\u0026#34;}, } for _, blog := range allPost { csvWriter.Write([]string{strconv.Itoa(blog.Id), blog.Content}) } csvWriter.Flush() // è¯»å–csv file,err := os.Open(\u0026#34;./testCsv.csv\u0026#34;) if err != nil { panic(nil) } defer file.Close() csvReader := csv.NewReader(file) // è®¾ç½®æ¯è¡Œè‡³å°‘çš„åˆ—æ•°,é‡åˆ°å°‘äºæ­¤æ•°çš„è¡Œæ•°ä¼šæŠ¥é”™ã€‚-1 ä»£è¡¨ä¸æ£€æŸ¥åˆ—æ•° csvReader.FieldsPerRecord = -1 record, err := csvReader.ReadAll() if err != nil { panic(err) } var posts []Blog for _, item := range record { id ,_ := strconv.ParseInt(item[0],0,0) post := Blog{Id: int(id), Content: item[1]} posts = append(posts,post) } fmt.Println(posts[0]) } ","date":"2021-11-09T22:47:15Z","permalink":"https://dccmmtop.github.io/posts/go%E8%AF%BB%E5%86%99csv/","section":"posts","tags":["go"],"title":"Goè¯»å†™CSV"},{"categories":null,"contents":"æ¦‚å¿µ å¹‚ç­‰è¿™ä¸ªæ¦‚å¿µï¼Œæ˜¯ä¸€ä¸ªæ•°å­¦ä¸Šçš„æ¦‚å¿µï¼Œå³ï¼šfâ€¦â€¦(f(f(x))) = f(x)ã€‚ç”¨åœ¨è®¡ç®—æœºé¢†åŸŸï¼ŒæŒ‡çš„æ˜¯ç³»ç»Ÿé‡Œçš„æ¥å£æˆ–æ–¹æ³•å¯¹å¤–çš„ä¸€ç§æ‰¿è¯ºï¼Œä½¿ç”¨ç›¸åŒå‚æ•°å¯¹åŒä¸€èµ„æºé‡å¤è°ƒç”¨æŸä¸ªæ¥å£æˆ–æ–¹æ³•çš„ç»“æœä¸è°ƒç”¨ä¸€æ¬¡çš„ç»“æœç›¸åŒã€‚\nä¸šåŠ¡åœºæ™¯ ä»ä¸šåŠ¡åœºæ™¯ä¸Šæ¥è¯´ï¼Œå¦‚ï¼šç°åœ¨äº’è”ç½‘ç”µå•†çš„ä¸‹å•æœåŠ¡ï¼ŒåŒä¸€ä¸ªç”¨æˆ·åœ¨çŸ­æ—¶é—´å†…è°ƒç”¨æŸä¸€ä¸ªä¸‹å•æœåŠ¡ï¼Œåªèƒ½ä¸‹å•æˆåŠŸä¸€æ¬¡ï¼›é“¶è¡Œè´¦æˆ·ä¹‹é—´çš„è½¬è´¦ï¼ŒAè´¦æˆ·ç»™Bè´¦æˆ·è½¬è´¦ï¼Œæ— è®ºç³»ç»Ÿå‡ºç°ä»€ä¹ˆé—®é¢˜æˆ–æ•…éšœï¼Œä¹Ÿåªèƒ½è½¬è´¦æˆåŠŸä¸€æ¬¡ï¼›å‰ç«¯é¡µé¢å¯¹ç›¸åŒè¡¨å•çš„å†…å®¹å¤šæ¬¡å‘åç«¯å‘èµ·æäº¤è¯·æ±‚ï¼Œåç«¯åªèƒ½ç»™å‡ºä¸€ä¸ªç›¸åŒçš„ç»“æœç­‰éƒ½å±äºå¹‚ç­‰çš„èŒƒç•´ã€‚\nè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæä¾›çš„è¿™äº›æœåŠ¡ä¸æ˜¯å¹‚ç­‰çš„ï¼Œå®¢æˆ·åœ¨ä¸‹å•æ—¶ç”±äºç½‘ç»œä¸ç¨³å®šæˆ–æ˜¯è¿ç»­ç‚¹äº†å‡ æ¬¡ä¸‹å•æŒ‰é’®ï¼Œå®é™…å®¢æˆ·åªä¸‹äº†ä¸€å•ï¼Œç»“æœç³»ç»Ÿé‡Œç»™å®¢æˆ·ç”Ÿæˆäº†å¤šå•ï¼Œé‚£å¹³å°/å•†å®¶å°†æ˜¯æ— æ³•æ‰¿å—çš„ï¼Œå¦‚æœè¢«â€œç¾Šæ¯›å…šâ€ç›¯ä¸Šï¼ŒæŸå¤±æ˜¯æ— å¯ä¼°é‡çš„ï¼›é“¶è¡Œä¹‹é—´çš„è½¬è´¦ï¼ŒAè´¦æˆ·æœ¬æ¥å®é™…ç»™Bè´¦æˆ·åªè½¬äº†ä¸€ç™¾ä¸‡ï¼Œç»“æœBè´¦æˆ·æ”¶åˆ°äº†å‡ ç™¾ä¸‡ï¼Œè¿™åœ¨ä¸šåŠ¡ä¸Šæ˜¯ä¸å¯æ¥å—çš„ã€‚åˆ†æè¿™äº›ä¸šåŠ¡åœºæ™¯ï¼Œå¼€å‘è€…å‘ç°ï¼Œæ— è®ºæ˜¯ä¸‹å•æœåŠ¡ã€è½¬è´¦æœåŠ¡è¿˜æ˜¯è¡¨å•æäº¤éƒ½æ˜¯ä¸€ä¸ªä¸ªä¸šåŠ¡è¯·æ±‚ï¼Œæä¾›è¿™äº›ä¸šåŠ¡æœåŠ¡çš„æ¥å£æˆ–æ–¹æ³•éƒ½åº”è¯¥ä¿è¯æ— è®ºæœåŠ¡æ˜¯è¶…æ—¶ã€é‡è¯•æˆ–æœ‰æ•…éšœç­‰å¼‚å¸¸æƒ…å†µï¼Œéƒ½è¦æ»¡è¶³ä¸šåŠ¡ä¸Šçš„å¤„ç†ç»“æœæ˜¯æ­£ç¡®çš„ã€‚ä¸šåŠ¡ä¸Šçš„ä¸€æ¬¡æˆ–å¤šæ¬¡è¯·æ±‚ï¼Œæœ€ç»ˆçš„å¤„ç†ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œå³ï¼šåœ¨ä¸€å®šæ—¶é—´å†…ï¼ŒæœåŠ¡çš„å¹‚ç­‰å…¶å®å°±æ˜¯è¯·æ±‚çš„å¹‚ç­‰ã€‚\næ¶æ„åˆ†æ ä»ç³»ç»Ÿæ¶æ„ä¸Šè¿›è¡Œåˆ†æï¼Œå¹‚ç­‰è¯¥åœ¨å“ªä¸€å±‚å»åšï¼Œæ€ä¹ˆåšï¼Ÿ\nä¸Šå›¾ä¸ºä¸€ä¸ªæœ€å¸¸è§çš„ç»å…¸ç³»ç»Ÿæ¡†æ¶å›¾ï¼ŒWebç«¯å‘èµ·ä¸€ä¸ªè¯·æ±‚åˆ°åç«¯ï¼Œå¹‚ç­‰è¯¥åœ¨å“ªä¸€å±‚æ¥å¤„ç†å‘¢ï¼Ÿä¸å¦¨ä¸€å±‚ä¸€å±‚çš„åˆ†æã€‚\nNginxæ˜¯å¦éœ€è¦åšå¹‚ç­‰ï¼ŒNginxçš„ä¸»è¦åŠŸèƒ½æ˜¯åšWebæœåŠ¡å™¨ã€åå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡ç­‰ï¼ŒæŠŠè¯·æ±‚è½¬å‘åˆ°åç«¯çš„æœåŠ¡å™¨ä¸Šï¼Œæœ¬èº«ä¸å‚ä¸å…·ä½“çš„ä¸šåŠ¡ï¼Œæ‰€ä»¥Nginxæ˜¯ä¸éœ€è¦åšå¹‚ç­‰å¤„ç†çš„ï¼›Gatewayæ˜¯è´Ÿè´£æƒé™æ ¡éªŒã€å®‰å…¨é˜²å¾¡ã€è®¤è¯é‰´æƒã€æµé‡æ§åˆ¶ã€åè®®è½¬æ¢ã€æ—¥å¿—å®¡è®¡ã€ç›‘æ§ç­‰ï¼Œæœ¬èº«ä¹Ÿä¸å«å¯¹ä»»ä½•ä¸šåŠ¡çš„å¤„ç†ï¼Œæ‰€ä»¥å…¶ä¹Ÿä¸éœ€è¦åšå¹‚ç­‰å¤„ç†ï¼›Serviceå±‚é€šå¸¸æ˜¯å¯¹ä¸šåŠ¡é€»è¾‘è¿›è¡Œå¤„ç†ã€ç¼–æ’ï¼Œå¯èƒ½ä¼šæ”¹å˜æ•°æ®ï¼Œä½†å¯¹äºæ•°æ®çš„æ”¹å˜ç»“æœï¼Œæœ€ç»ˆä¹Ÿè¿˜æ˜¯éœ€è¦é€šè¿‡æ•°æ®è®¿é—®å±‚ï¼Œå†™å…¥åˆ°æ•°æ®åº“ï¼Œæ‰€ä»¥Serviceå±‚ä¹Ÿä¸éœ€è¦åšæ•°æ®å¹‚ç­‰ï¼›DAOå±‚ä¸»è¦æ˜¯å’Œæ•°æ®åº“äº¤äº’ï¼ŒæŠŠServiceå±‚çš„ç»“æœå†™å…¥æ•°æ®åº“ï¼Œå¯¹Serviceå±‚æä¾›è¯»å–ã€å†™å…¥æ•°æ®åº“çš„åŠŸèƒ½ã€‚\nåœ¨å†™å…¥æ•°æ®åº“çš„æ—¶å€™ï¼Œé’ˆå¯¹æ¯ä¸€æ¬¡çš„å†™å…¥ï¼Œå¯èƒ½è¿”å›ä¸åŒçš„ç»“æœï¼Œæ­¤æ—¶å°±éœ€è¦æŒ‰åœºæ™¯è¿›è¡Œå…·ä½“çš„åˆ†æå¯¹å¾…ï¼›DataBaseå±‚ï¼Œä¸»è¦æä¾›æ•°æ®çš„å­˜å‚¨ï¼Œå¹¶ä¸å‚ä¸å…·ä½“çš„ä¸šåŠ¡é€»è¾‘è®¡ç®—ã€‚æ‰€ä»¥ï¼Œé€šè¿‡å¯¹è¯¥æ¶æ„çš„æ¯ä¸€å±‚çš„åŠŸèƒ½åˆ†æï¼Œå¾—å‡ºå¯¹äºè¯·æ±‚çš„å¹‚ç­‰å¤„ç†ï¼Œéœ€è¦åœ¨DAOå±‚åšå¤„ç†ï¼Œä»¥ä¾¿ä¿è¯å¤šæ¬¡è¯·æ±‚å’Œä¸€æ¬¡è¯·æ±‚çš„ç»“æœæ˜¯ä¸€è‡´çš„ã€‚\næ•°æ®åº“æ“ä½œåˆ†æ é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œå¾—å‡ºå¹‚ç­‰éœ€è¦åœ¨DAOå±‚æ¥å¤„ç†ï¼Œå†è¿›ä¸€æ­¥åˆ†æï¼Œå¾—å‡ºDAOå±‚çš„æ“ä½œä¸»è¦å°±æ˜¯CRUDã€‚ä¸‹é¢é€ä¸€å¯¹æ¯ä¸€ç§æ“ä½œåˆ†ææ˜¯å¦éœ€è¦åšå¹‚ç­‰ï¼Œä»¥åŠæ€ä¹ˆåšã€‚\nRï¼ˆreadï¼‰ï¼šå¯¹åº”çš„æ“ä½œSQLè¯­å¥ä¸ºselectã€‚åªè¦æŸ¥è¯¢æ¡ä»¶ä¸å˜ï¼Œåœ¨ä¸€å®šçš„æ—¶é—´å†…ï¼Œæ‰§è¡Œä¸€æ¬¡å’Œæ‰§è¡Œå¤šæ¬¡è¿”å›çš„ç»“æœè‚¯å®šæ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥å…¶æœ¬èº«æ˜¯å¹‚ç­‰çš„ï¼Œä¸éœ€è¦å†åšå¤„ç†ã€‚\nselect * from user where id = 1; æŸ¥è¯¢ä¸€æ¬¡æˆ–å¤šæ¬¡ç»“æœæ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æ˜¯å¹‚ç­‰çš„ã€‚\nCï¼ˆcreateï¼‰ï¼šå¯¹åº”çš„æ“ä½œSQLè¯­å¥ä¸ºinsertã€‚æ­¤æ—¶ï¼Œéœ€è¦åˆ†æƒ…å†µï¼Œå¦‚æœç”¨åˆ°çš„æ•°æ®åº“ä¸»é”®ä¸ºæ•°æ®åº“è‡ªå¢ï¼Œä¸è€ƒè™‘ä¸šåŠ¡ä¸»é”®é˜²é‡çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸€æ¬¡å†™å…¥æ•°æ®åº“å°±ä¸æ˜¯å¹‚ç­‰çš„ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯å¹‚ç­‰ï¼Œéœ€è¦åœ¨æ•°æ®insertå‰åšä¸šåŠ¡é˜²é‡æˆ–æ˜¯åœ¨æ•°æ®åº“è¡¨ä¸Šå¯¹ä¸šåŠ¡ä¸»é”®åŠ å”¯ä¸€ç´¢å¼•ã€‚å¦‚æœæ•°æ®åº“ä¸»é”®ä¸æ˜¯è‡ªå¢ï¼Œæ˜¯ç”±ä¸šåŠ¡ç³»ç»Ÿå†™å…¥çš„ï¼Œéœ€è¦åœ¨ä¸šåŠ¡ç³»ç»Ÿé‡ŒæŠŠæ•°æ®åº“ä¸»é”®å’Œä¸šåŠ¡ä¸»é”®åšä¸€å¯¹ä¸€æ˜ å°„ï¼Œæˆ–æ˜¯ç”±ç‹¬ç«‹æœåŠ¡æä¾›æ•°æ®åº“ä¸»é”®å’Œä¸šåŠ¡ä¸»é”®çš„æ˜ å°„å…³ç³»ï¼Œä¿è¯å¤šæ¬¡è¯·æ±‚è·å–åˆ°çš„æ•°æ®åº“ä¸»é”®å’Œä¸šåŠ¡ä¸»é”®æ˜¯ä¸€è‡´çš„ï¼Œç¡®ä¿å†™å…¥æ•°æ®åº“æ“ä½œæ˜¯å¹‚ç­‰çš„ã€‚ç»¼åˆæ¥è¯´ï¼Œå°±æ˜¯ç›¸åŒçš„æ•°æ®å¤šæ¬¡å†™å…¥æ•°æ®åº“åï¼Œèƒ½å¦ä¿è¯åªæœ‰ä¸€æ¡æ•°æ®ã€‚\ninsert into user (id,age,sex,ts) values(1,10,â€˜maleâ€™,2021-07-20 10:22:23); Uï¼ˆupdateï¼‰ï¼šå¯¹åº”çš„æ“ä½œSQLè¯­å¥ä¸ºupdateã€‚æ›´æ–°æ“ä½œæ—¶ï¼Œä¸€å®šæ˜¯è¦ç”¨ç»å¯¹å€¼è¿›è¡Œæ›´æ–°æ“ä½œï¼Œè€Œä¸è¦ç”¨ç›¸å¯¹å€¼è¿›è¡Œæ›´æ–°ï¼Œç›¸å¯¹å€¼æ›´æ–°å¯èƒ½å¯¼è‡´æ›´æ–°æ“ä½œä¸å¹‚ç­‰ã€‚\nå¹‚ç­‰ï¼š\nupdate user set age = 10 where id = 1; éå¹‚ç­‰ï¼š\nupdate user set age++ where id = 1; Dï¼ˆdeleteï¼‰ï¼šå¯¹åº”çš„æ“ä½œSQLè¯­å¥ä¸ºdeleteã€‚åˆ é™¤æ“ä½œæ—¶ï¼Œå¦‚æœåˆ é™¤çš„æ˜¯ä¸€ä¸ªèŒƒå›´ï¼Œç”Ÿäº§ä¸Šæœ€å¥½æ˜¯ç¦æ­¢è¯¥ç±»æ“ä½œï¼›æ¯”è¾ƒæ¨èçš„åšæ³•æ˜¯æŠŠæŒ‰èŒƒå›´æ“ä½œåˆ é™¤è½¬æ¢ä¸ºå…ˆæŒ‰èŒƒå›´æŸ¥è¯¢ï¼Œå†æŒ‰æŸ¥è¯¢çš„ä¸»é”®è¿›è¡Œåˆ é™¤ã€‚è€Œä¸”æŒ‰èŒƒå›´åˆ é™¤çš„æ“ä½œä¸æ˜¯å¹‚ç­‰çš„ã€‚\nå¹‚ç­‰ï¼š\ndelete from user where id = 1; éå¹‚ç­‰ï¼šè¯¥ç±»æ“ä½œè¦ç¦æ­¢ã€‚\ndelete from user where id in ï¼ˆselect id from user order by id desc limit 10); å¸¸è§ä¸šåŠ¡åœºæ™¯ ä¿è¯å¹‚ç­‰çš„å®ç°æ–¹å¼æœ‰å¤šç§ï¼Œæ­¤å¤„ä¾‹ä¸¾å‡ ç±»å¸¸è§çš„ä¸šåŠ¡åœºæ™¯ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæ ¹æ®ä¸šåŠ¡åœºæ™¯è¿›è¡Œé€‰ç”¨ã€‚\né¡µé¢tokenæœºåˆ¶ è¿›å…¥é¡µé¢æ—¶ï¼Œä»æœåŠ¡å™¨è·å–tokenï¼Œåœ¨æœåŠ¡å™¨ç«¯æŠŠtokenè¿›è¡Œå­˜å‚¨ï¼Œæäº¤æ—¶æŠŠtokenå¸¦åˆ°æœåŠ¡å™¨ç«¯è¿›è¡ŒéªŒè¯,è¿™é‡Œçš„tokenç›¸å½“äºä¸šåŠ¡ID\nå¸¸è§çš„å¤„ç†æµç¨‹å¦‚ä¸‹\nä¹è§‚é”æœºåˆ¶ ä½¿ç”¨æ•°æ®åº“çš„ç‰ˆæœ¬å·å®ç°ä¹è§‚é”ï¼Œæ•°æ®åº“æ›´æ–°æ—¶ï¼Œåˆ¤æ–­ç‰ˆæœ¬å·æ˜¯å¦ä¸æŸ¥è¯¢æ—¶ä¿æŒä¸€è‡´ï¼Œä¸€è‡´æ›´æ–°æˆåŠŸï¼Œå¦åˆ™æ›´æ–°å¤±è´¥ï¼›\nselect+insert æ•°æ®å†™å…¥å‰ï¼Œå…ˆæŸ¥è¯¢æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ç›´æ¥è¿”å›ï¼Œä¸å­˜åœ¨åˆ™å†™å…¥æ•°æ®ï¼Œä¿è¯å†™å…¥æ•°æ®åº“çš„æ•°æ®æ­£ç¡®æ€§ï¼›å¸¸ç”¨äºå¹¶å‘ä¸é«˜çš„ä¸€äº›åå°ç³»ç»Ÿæˆ–æ˜¯é˜²æ­¢ä»»åŠ¡çš„é‡å¤æ‰§è¡Œï¼›\næ‚²è§‚é”æœºåˆ¶ ä¸€èˆ¬idä¸ºä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•ï¼Œä»…é”å®šå½“å‰è®°å½•ï¼›\nselect * from table where id = \u0026#39;1234\u0026#39; for update; å»é‡è¡¨ æ¯ä¸€æ¬¡å†™å…¥æˆ–æ›´æ–°ä¸šåŠ¡è¡¨æ—¶ï¼Œå…ˆæŸ¥è¯¢å»é‡è¡¨æ˜¯å¦å·²ç»å­˜åœ¨è®°å½•ï¼Œå†æ“ä½œä¸šåŠ¡è¡¨ã€‚\næ•°æ®åº“å”¯ä¸€ç´¢å¼• ä¸ºä¸šåŠ¡è¡¨å»ºç«‹å”¯ä¸€ç´¢å¼•ï¼Œé¿å…ä¸šåŠ¡æ•°æ®å¤šæ¬¡å†™å…¥ï¼›\nçŠ¶æ€æœº åŠ¡çŠ¶æ€åœ¨å˜æ›´ä¹‹å‰æ˜¯æœ‰æ¡ä»¶çš„ï¼Œå¿…é¡»æŒ‰è®¾å®šçš„çŠ¶æ€æ¡ä»¶è¿›è¡Œæ›´æ–°ï¼›\nåœ¨å®é™…å¼€å‘ä¸­ï¼Œä¿è¯æä¾›çš„æ¥å£æˆ–æœåŠ¡çš„å¹‚ç­‰ï¼ˆæ€§ï¼‰ï¼Œæ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„æŠ€æœ¯è¦æ±‚ï¼Œå¸Œæœ›é€šè¿‡è¯¥åˆ†æï¼Œèƒ½å¯¹è¿˜æœªç†è§£å¹‚ç­‰ï¼ˆæ€§ï¼‰çš„ç ”å‘äººå‘˜æœ‰æ‰€å¸®åŠ©ã€‚\nå‚è€ƒèµ„æ–™ https://mp.weixin.qq.com/s/_Nn5F98PvoWk_xjVrIpFNQ ","date":"2021-11-09T21:52:29Z","permalink":"https://dccmmtop.github.io/posts/%E5%B9%82%E7%AD%89%E8%AE%BE%E8%AE%A1/","section":"posts","tags":["æ¶æ„"],"title":"å¹‚ç­‰è®¾è®¡"},{"categories":null,"contents":"logrotate åœ¨å¾ˆå¤š Linux å‘è¡Œç‰ˆä¸Šéƒ½æ˜¯é»˜è®¤å®‰è£…çš„ã€‚ç³»ç»Ÿä¼šå®šæ—¶è¿è¡Œ logrotateï¼Œä¸€èˆ¬æ˜¯æ¯å¤©ä¸€æ¬¡ã€‚ç³»ç»Ÿæ˜¯è¿™ä¹ˆå®ç°æŒ‰å¤©æ‰§è¡Œçš„ã€‚crontab ä¼šæ¯å¤©å®šæ—¶æ‰§è¡Œ /etc/cron.daily ç›®å½•ä¸‹çš„è„šæœ¬ï¼Œè€Œè¿™ä¸ªç›®å½•ä¸‹æœ‰ä¸ªæ–‡ä»¶å« logrotateã€‚åœ¨ centos ä¸Šè„šæœ¬å†…å®¹æ˜¯è¿™æ ·çš„ï¼š\nç³»ç»Ÿè‡ªå¸¦ cron taskï¼š/etc/cron.daily/logrotateï¼Œæ¯å¤©è¿è¡Œä¸€æ¬¡ã€‚\n[root@gop-sg-192-168-56-103 logrotate.d]# cat /etc/cron.daily/logrotate #!/bin/sh /usr/sbin/logrotate -s /var/lib/logrotate/logrotate.status /etc/logrotate.conf EXITVALUE=$? if [ $EXITVALUE != 0 ]; then /usr/bin/logger -t logrotate \u0026#34;ALERT exited abnormally with [$EXITVALUE]\u0026#34; fi exit 0 å¯ä»¥çœ‹åˆ°è¿™ä¸ªè„šæœ¬ä¸»è¦åšçš„äº‹å°±æ˜¯ä»¥ /etc/logrotate.conf ä¸ºé…ç½®æ–‡ä»¶æ‰§è¡Œäº† logrotateã€‚å°±æ˜¯è¿™æ ·å®ç°äº†æ¯å¤©æ‰§è¡Œä¸€æ¬¡ logrotateã€‚\nå¾ˆå¤šç¨‹åºçš„ä¼šç”¨åˆ° logrotate æ»šåŠ¨æ—¥å¿—ï¼Œæ¯”å¦‚ nginxã€‚å®ƒä»¬å®‰è£…åï¼Œä¼šåœ¨ /etc/logrotate.d è¿™ä¸ªç›®å½•ä¸‹å¢åŠ è‡ªå·±çš„ logrotate çš„é…ç½®æ–‡ä»¶ã€‚logrotate ä»€ä¹ˆæ—¶å€™æ‰§è¡Œ /etc/logrotate.d ä¸‹çš„é…ç½®å‘¢ï¼Ÿçœ‹åˆ° /etc/logrotate.conf é‡Œè¿™è¡Œï¼Œä¸€åˆ‡å°±ä¸è¨€è€Œå–»äº†ã€‚\ninclude /etc/logrotate.d logrotate åŸç† ogrotate æ˜¯æ€ä¹ˆåšåˆ°æ»šåŠ¨æ—¥å¿—æ—¶ä¸å½±å“ç¨‹åºæ­£å¸¸çš„æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿlogrotate æä¾›äº†ä¸¤ç§è§£å†³æ–¹æ¡ˆã€‚\ncreate copytruncate Linux æ–‡ä»¶æ“ä½œæœºåˆ¶\nä»‹ç»ä¸€ä¸‹ç›¸å…³çš„ Linux ä¸‹çš„æ–‡ä»¶æ“ä½œæœºåˆ¶ã€‚\nLinux æ–‡ä»¶ç³»ç»Ÿé‡Œæ–‡ä»¶å’Œæ–‡ä»¶åçš„å…³ç³»å¦‚ä¸‹å›¾\nç›®å½•ä¹Ÿæ˜¯æ–‡ä»¶ï¼Œæ–‡ä»¶é‡Œå­˜ç€æ–‡ä»¶åå’Œå¯¹åº”çš„ inode ç¼–å·ã€‚é€šè¿‡è¿™ä¸ª inode ç¼–å·å¯ä»¥æŸ¥åˆ°æ–‡ä»¶çš„å…ƒæ•°æ®å’Œæ–‡ä»¶å†…å®¹ã€‚æ–‡ä»¶çš„å…ƒæ•°æ®æœ‰å¼•ç”¨è®¡æ•°ã€æ“ä½œæƒé™ã€æ‹¥æœ‰è€… IDã€åˆ›å»ºæ—¶é—´ã€æœ€åä¿®æ”¹æ—¶é—´ç­‰ç­‰ã€‚æ–‡ä»¶ä»¶åå¹¶ä¸åœ¨å…ƒæ•°æ®é‡Œè€Œæ˜¯åœ¨ç›®å½•æ–‡ä»¶ä¸­ã€‚å› æ­¤æ–‡ä»¶æ”¹åã€ç§»åŠ¨ï¼Œéƒ½ä¸ä¼šä¿®æ”¹æ–‡ä»¶ï¼Œè€Œæ˜¯ä¿®æ”¹ç›®å½•æ–‡ä»¶ã€‚\ncreate è¿™ä¹Ÿå°±æ˜¯é»˜è®¤çš„æ–¹æ¡ˆï¼Œå¯ä»¥é€šè¿‡ create å‘½ä»¤é…ç½®æ–‡ä»¶çš„æƒé™å’Œå±ç»„è®¾ç½®ï¼›è¿™ä¸ªæ–¹æ¡ˆçš„æ€è·¯æ˜¯é‡å‘½ååŸæ—¥å¿—æ–‡ä»¶ï¼Œåˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š\né‡å‘½åæ­£åœ¨è¾“å‡ºæ—¥å¿—æ–‡ä»¶ï¼Œå› ä¸ºé‡å‘½ååªä¿®æ”¹ç›®å½•ä»¥åŠæ–‡ä»¶çš„åç§°ï¼Œè€Œè¿›ç¨‹æ“ä½œæ–‡ä»¶ä½¿ç”¨çš„æ˜¯ inodeï¼Œæ‰€ä»¥å¹¶ä¸å½±å“åŸç¨‹åºç»§ç»­è¾“å‡ºæ—¥å¿—ã€‚ åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ–‡ä»¶åå’ŒåŸæ—¥å¿—æ–‡ä»¶ä¸€æ ·ï¼Œæ³¨æ„ï¼Œæ­¤æ—¶åªæ˜¯æ–‡ä»¶åç§°ä¸€æ ·ï¼Œè€Œ inode ç¼–å·ä¸åŒï¼ŒåŸç¨‹åºè¾“å‡ºçš„æ—¥å¿—è¿˜æ˜¯å¾€åŸæ—¥å¿—æ–‡ä»¶è¾“å‡ºã€‚ æœ€åé€šè¿‡æŸäº›æ–¹å¼é€šçŸ¥ç¨‹åºï¼Œé‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼›ç”±äºé‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶ä¼šç”¨åˆ°æ–‡ä»¶è·¯å¾„è€Œé inode ç¼–å·ï¼Œæ‰€ä»¥æ‰“å¼€çš„æ˜¯æ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚ å¦‚ä¸Šä¹Ÿå°±æ˜¯ logrotate çš„é»˜è®¤æ“ä½œæ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ mv+create æ‰§è¡Œå®Œä¹‹åï¼Œé€šçŸ¥åº”ç”¨é‡æ–°åœ¨æ–°æ–‡ä»¶å†™å…¥å³å¯ã€‚mv+create æˆæœ¬éƒ½æ¯”è¾ƒä½ï¼Œå‡ ä¹æ˜¯åŸå­æ“ä½œï¼Œå¦‚æœåº”ç”¨æ”¯æŒé‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼Œå¦‚ syslog, nginx, mysql ç­‰ï¼Œé‚£ä¹ˆè¿™æ˜¯æœ€å¥½çš„æ–¹å¼ã€‚æ¯”å¦‚é€šè¿‡ kill å‘½ä»¤å‘ç¨‹åºå‘é€ä¸€ä¸ª HUP ä¿¡å·ï¼Œä½¿ä¹‹é‡æ–°åŠ è½½\nä¸è¿‡ï¼Œæœ‰äº›ç¨‹åºå¹¶ä¸æ”¯æŒè¿™ç§æ–¹å¼ï¼Œå‹æ ¹æ²¡æœ‰æä¾›é‡æ–°æ‰“å¼€æ—¥å¿—çš„æ¥å£ï¼›è€Œå¦‚æœé‡å¯åº”ç”¨ç¨‹åºï¼Œå¿…ç„¶ä¼šé™ä½å¯ç”¨æ€§ï¼Œä¸ºæ­¤å¼•å…¥äº†å¦‚ä¸‹æ–¹å¼ã€‚\ncopytruncate è¯¥æ–¹æ¡ˆæ˜¯æŠŠæ­£åœ¨è¾“å‡ºçš„æ—¥å¿—æ‹· (copy) ä¸€ä»½å‡ºæ¥ï¼Œå†æ¸…ç©º (trucate) åŸæ¥çš„æ—¥å¿—ï¼›è¯¦ç»†æ­¥éª¤å¦‚ä¸‹ï¼š\nå°†å½“å‰æ­£åœ¨è¾“å‡ºçš„æ—¥å¿—æ–‡ä»¶å¤åˆ¶ä¸ºç›®æ ‡æ–‡ä»¶ï¼Œæ­¤æ—¶ç¨‹åºä»ç„¶å°†æ—¥å¿—è¾“å‡ºåˆ°åŸæ¥æ–‡ä»¶ä¸­ï¼Œæ­¤æ—¶ï¼ŒåŸæ–‡ä»¶åä¹Ÿæ²¡æœ‰å˜ã€‚ æ¸…ç©ºæ—¥å¿—æ–‡ä»¶ï¼ŒåŸç¨‹åºä»ç„¶è¿˜æ˜¯è¾“å‡ºåˆ°é¢„æ¡ˆæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œå› ä¸ºæ¸…ç©ºæ–‡ä»¶åªæŠŠæ–‡ä»¶çš„å†…å®¹åˆ é™¤äº†ï¼Œè€Œ inode å¹¶æ²¡æ”¹å˜ï¼Œåç»­æ—¥å¿—çš„è¾“å‡ºä»ç„¶å†™å…¥è¯¥æ–‡ä»¶ä¸­ã€‚ å¦‚ä¸Šæ‰€è¿°ï¼Œå¯¹äº copytruncate ä¹Ÿå°±æ˜¯å…ˆå¤åˆ¶ä¸€ä»½æ–‡ä»¶ï¼Œç„¶åæ¸…ç©ºåŸæœ‰æ–‡ä»¶ã€‚\né€šå¸¸æ¥è¯´ï¼Œæ¸…ç©ºæ“ä½œæ¯”è¾ƒå¿«ï¼Œä½†æ˜¯å¦‚æœæ—¥å¿—æ–‡ä»¶å¤ªå¤§ï¼Œé‚£ä¹ˆå¤åˆ¶å°±ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œä»è€Œå¯èƒ½å¯¼è‡´éƒ¨åˆ†æ—¥å¿—ä¸¢å¤±ã€‚ä¸è¿‡è¿™ç§æ–¹å¼ä¸éœ€è¦åº”ç”¨ç¨‹åºçš„æ”¯æŒå³å¯ã€‚\né…ç½® logrotate æ‰§è¡Œæ–‡ä»¶ï¼š /usr/sbin/logrotate\nä¸»é…ç½®æ–‡ä»¶: /etc/logrotate.conf\nè‡ªå®šä¹‰é…ç½®æ–‡ä»¶: /etc/logrotate.d/*.conf\nä¿®æ”¹é…ç½®æ–‡ä»¶åï¼Œå¹¶ä¸éœ€è¦é‡å¯æœåŠ¡ã€‚\nç”±äº logrotate å®é™…ä¸Šåªæ˜¯ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¸æ˜¯ä»¥ daemon è¿è¡Œã€‚\nè¿è¡Œ logrotate logrotate [OPTION...] \u0026lt;configfile\u0026gt; -d, --debug ï¼šdebug æ¨¡å¼ï¼Œæµ‹è¯•é…ç½®æ–‡ä»¶æ˜¯å¦æœ‰é”™è¯¯ã€‚ -f, --force ï¼šå¼ºåˆ¶è½¬å‚¨æ–‡ä»¶ã€‚ -m, --mail=command ï¼šå‹ç¼©æ—¥å¿—åï¼Œå‘é€æ—¥å¿—åˆ°æŒ‡å®šé‚®ç®±ã€‚ -s, --state=statefile ï¼šä½¿ç”¨æŒ‡å®šçš„çŠ¶æ€æ–‡ä»¶ã€‚ -v, --verbose ï¼šæ˜¾ç¤ºè½¬å‚¨è¿‡ç¨‹ crontab å®šæ—¶ é€šå¸¸æƒ¯ç”¨çš„åšæ³•æ˜¯é…åˆ crontab æ¥å®šæ—¶è°ƒç”¨ã€‚é»˜è®¤æ˜¯ä¸€å¤©æ‰§è¡Œä¸€æ¬¡ï¼Œå¯ä»¥è‡ªå·±æ·»åŠ  crontab è§„åˆ™\ncrontab -e */30 * * * * /usr/sbin/logrotate /etc/logrotate.d/rsyslog \u0026gt; /dev/null 2\u0026gt;\u0026amp;1 \u0026amp; æ‰‹åŠ¨è¿è¡Œ debug æ¨¡å¼ï¼šæŒ‡å®š [-d|\u0026ndash;debug]\nlogrotate -d å¹¶ä¸ä¼šçœŸæ­£è¿›è¡Œ rotate æˆ–è€… compress æ“ä½œï¼Œä½†æ˜¯ä¼šæ‰“å°å‡ºæ•´ä¸ªæ‰§è¡Œçš„æµç¨‹ï¼Œå’Œè°ƒç”¨çš„è„šæœ¬ç­‰è¯¦ç»†ä¿¡æ¯ã€‚\nverbose æ¨¡å¼ï¼š æŒ‡å®š [-v|\u0026ndash;verbose]\nlogrotate -v ä¼šçœŸæ­£æ‰§è¡Œæ“ä½œï¼Œæ‰“å°å‡ºè¯¦ç»†ä¿¡æ¯ï¼ˆdebug æ¨¡å¼ï¼Œé»˜è®¤æ˜¯å¼€å¯ verboseï¼‰\nlogrotate å‚æ•° è¯¦ç»†ä»‹ç»è¯·è‡ªè¡Œ man logrotate\nä¸»è¦ä»‹ç»ä¸‹å®Œæˆå¸¸ç”¨éœ€æ±‚ä¼šç”¨åˆ°çš„ä¸€äº›å‚æ•°ã€‚\nä¸€ä¸ªå…¸å‹çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š\n[root@localhost ~]# vim /etc/logrotate.d/log_file /var/log/log_file { monthly rotate 5 compress delaycompress missingok notifempty create 644 root root postrotate /usr/bin/killall -HUP rsyslogd endscript } monthly: æ—¥å¿—æ–‡ä»¶å°†æŒ‰æœˆè½®å¾ªã€‚å…¶å®ƒå¯ç”¨å€¼ä¸º dailyï¼Œweekly æˆ–è€… yearlyã€‚ rotate 5: ä¸€æ¬¡å°†å­˜å‚¨ 5 ä¸ªå½’æ¡£æ—¥å¿—ã€‚å¯¹äºç¬¬å…­ä¸ªå½’æ¡£ï¼Œæ—¶é—´æœ€ä¹…çš„å½’æ¡£å°†è¢«åˆ é™¤ã€‚ compress: åœ¨è½®å¾ªä»»åŠ¡å®Œæˆåï¼Œå·²è½®å¾ªçš„å½’æ¡£å°†ä½¿ç”¨ gzip è¿›è¡Œå‹ç¼©ã€‚ delaycompress: æ€»æ˜¯ä¸ compress é€‰é¡¹ä¸€èµ·ç”¨ï¼Œdelaycompress é€‰é¡¹æŒ‡ç¤º logrotate ä¸è¦å°†æœ€è¿‘çš„å½’æ¡£å‹ç¼©ï¼Œå‹ç¼© å°†åœ¨ä¸‹ä¸€æ¬¡è½®å¾ªå‘¨æœŸè¿›è¡Œã€‚è¿™åœ¨ä½ æˆ–ä»»ä½•è½¯ä»¶ä»ç„¶éœ€è¦è¯»å–æœ€æ–°å½’æ¡£æ—¶å¾ˆæœ‰ç”¨ã€‚ missingok: åœ¨æ—¥å¿—è½®å¾ªæœŸé—´ï¼Œä»»ä½•é”™è¯¯å°†è¢«å¿½ç•¥ï¼Œä¾‹å¦‚ â€œæ–‡ä»¶æ— æ³•æ‰¾åˆ°â€ ä¹‹ç±»çš„é”™è¯¯ã€‚ notifempty: å¦‚æœæ—¥å¿—æ–‡ä»¶ä¸ºç©ºï¼Œè½®å¾ªä¸ä¼šè¿›è¡Œã€‚ create 644 root root: ä»¥æŒ‡å®šçš„æƒé™åˆ›å»ºå…¨æ–°çš„æ—¥å¿—æ–‡ä»¶ï¼ŒåŒæ—¶ logrotate ä¹Ÿä¼šé‡å‘½ååŸå§‹æ—¥å¿—æ–‡ä»¶ã€‚ postrotate/endscript: åœ¨æ‰€æœ‰å…¶å®ƒæŒ‡ä»¤å®Œæˆåï¼Œpostrotate å’Œ endscript é‡Œé¢æŒ‡å®šçš„å‘½ä»¤å°†è¢«æ‰§è¡Œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œrsyslogd è¿›ç¨‹å°†ç«‹å³å†æ¬¡è¯»å–å…¶é…ç½®å¹¶ç»§ç»­è¿è¡Œã€‚ ä¸Šé¢çš„æ¨¡æ¿æ˜¯é€šç”¨çš„ï¼Œè€Œé…ç½®å‚æ•°åˆ™æ ¹æ®ä½ çš„éœ€æ±‚è¿›è¡Œè°ƒæ•´ï¼Œä¸æ˜¯æ‰€æœ‰çš„å‚æ•°éƒ½æ˜¯å¿…è¦çš„ã€‚\n/var/log/log_file {\rsize=50M\rrotate 5\rdateext\rcreate 644 root root\rpostrotate\r/usr/bin/killall -HUP rsyslogd\rendscript\r} åœ¨ä¸Šé¢çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬åªæƒ³è¦è½®è¯¢ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œsize=50M æŒ‡å®šæ—¥å¿—æ–‡ä»¶å¤§å°å¯ä»¥å¢é•¿åˆ° 50MB,ä¸æ»¡50MBä¸ä¼šè¢«åˆ†å‰²\ndateext æŒ‡ç¤ºè®©æ—§æ—¥å¿—æ–‡ä»¶ä»¥åˆ›å»ºæ—¥æœŸå‘½åã€‚\nå¸¸è§é…ç½®å‚æ•°\ndaily: æŒ‡å®šè½¬å‚¨å‘¨æœŸä¸ºæ¯å¤© weekly: æŒ‡å®šè½¬å‚¨å‘¨æœŸä¸ºæ¯å‘¨ monthly: æŒ‡å®šè½¬å‚¨å‘¨æœŸä¸ºæ¯æœˆ rotate count: æŒ‡å®šæ—¥å¿—æ–‡ä»¶åˆ é™¤ä¹‹å‰è½¬å‚¨çš„æ¬¡æ•°ï¼Œ0 æŒ‡æ²¡æœ‰å¤‡ä»½ï¼Œ5 æŒ‡ä¿ç•™ 5 ä¸ªå¤‡ä»½ tabooext [+] listï¼šè®© logrotate ä¸è½¬å‚¨æŒ‡å®šæ‰©å±•åçš„æ–‡ä»¶ï¼Œç¼ºçœçš„æ‰©å±•åæ˜¯ï¼š.rpm-orig, .rpmsave, v, å’Œï½ missingokï¼šåœ¨æ—¥å¿—è½®å¾ªæœŸé—´ï¼Œä»»ä½•é”™è¯¯å°†è¢«å¿½ç•¥ï¼Œä¾‹å¦‚ â€œæ–‡ä»¶æ— æ³•æ‰¾åˆ°â€ ä¹‹ç±»çš„é”™è¯¯ã€‚ size sizeï¼šå½“æ—¥å¿—æ–‡ä»¶åˆ°è¾¾æŒ‡å®šçš„å¤§å°æ—¶æ‰è½¬å‚¨ï¼Œbytes (ç¼ºçœ) åŠ KB (sizek) æˆ– MB (sizem) compressï¼š é€šè¿‡ gzip å‹ç¼©è½¬å‚¨ä»¥åçš„æ—¥å¿— nocompressï¼š ä¸å‹ç¼© copytruncateï¼šç”¨äºè¿˜åœ¨æ‰“å¼€ä¸­çš„æ—¥å¿—æ–‡ä»¶ï¼ŒæŠŠå½“å‰æ—¥å¿—å¤‡ä»½å¹¶æˆªæ–­ nocopytruncateï¼š å¤‡ä»½æ—¥å¿—æ–‡ä»¶ä½†æ˜¯ä¸æˆªæ–­ create mode owner group: è½¬å‚¨æ–‡ä»¶ï¼Œä½¿ç”¨æŒ‡å®šçš„æ–‡ä»¶æ¨¡å¼åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ nocreate: ä¸å»ºç«‹æ–°çš„æ—¥å¿—æ–‡ä»¶ delaycompressï¼š å’Œ compress ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œè½¬å‚¨çš„æ—¥å¿—æ–‡ä»¶åˆ°ä¸‹ä¸€æ¬¡è½¬å‚¨æ—¶æ‰å‹ç¼© nodelaycompressï¼š è¦†ç›– delaycompress é€‰é¡¹ï¼Œè½¬å‚¨åŒæ—¶å‹ç¼©ã€‚ errors address: ä¸“å‚¨æ—¶çš„é”™è¯¯ä¿¡æ¯å‘é€åˆ°æŒ‡å®šçš„ Email åœ°å€ ifempty: å³ä½¿æ˜¯ç©ºæ–‡ä»¶ä¹Ÿè½¬å‚¨ï¼Œè¿™ä¸ªæ˜¯ logrotate çš„ç¼ºçœé€‰é¡¹ã€‚ notifempty: å¦‚æœæ˜¯ç©ºæ–‡ä»¶çš„è¯ï¼Œä¸è½¬å‚¨ mail address: æŠŠè½¬å‚¨çš„æ—¥å¿—æ–‡ä»¶å‘é€åˆ°æŒ‡å®šçš„ E-mail åœ°å€ nomail: è½¬å‚¨æ—¶ä¸å‘é€æ—¥å¿—æ–‡ä»¶ olddir directoryï¼šå‚¨åçš„æ—¥å¿—æ–‡ä»¶æ”¾å…¥æŒ‡å®šçš„ç›®å½•ï¼Œå¿…é¡»å’Œå½“å‰æ—¥å¿—æ–‡ä»¶åœ¨åŒä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿ noolddirï¼š è½¬å‚¨åçš„æ—¥å¿—æ–‡ä»¶å’Œå½“å‰æ—¥å¿—æ–‡ä»¶æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹ prerotate/endscriptï¼š åœ¨è½¬å‚¨ä»¥å‰éœ€è¦æ‰§è¡Œçš„å‘½ä»¤å¯ä»¥æ”¾å…¥è¿™ä¸ªå¯¹ï¼Œè¿™ä¸¤ä¸ªå…³é”®å­—å¿…é¡»å•ç‹¬æˆè¡Œ nginx æ—¥å¿—è½®æ¢ç¤ºä¾‹ /var/log/nginx/*.log /var/log/nginx/*/*.log{\rdaily\rmissingok\rrotate 14\rcompress\rdelaycompress\rnotifempty\rcreate 640 root adm\rsharedscripts\rpostrotate\r[ ! -f /var/run/nginx.pid ] || kill -USR1 `cat /var/run/nginx.pid`\rendscript\r} å…³äº USR1 ä¿¡å·è§£é‡Š USR1 äº¦é€šå¸¸è¢«ç”¨æ¥å‘ŠçŸ¥åº”ç”¨ç¨‹åºé‡è½½é…ç½®æ–‡ä»¶ï¼›ä¾‹å¦‚ï¼Œå‘ Apache HTTP æœåŠ¡å™¨å‘é€ä¸€ä¸ª USR1 ä¿¡å·å°†å¯¼è‡´ä»¥ä¸‹æ­¥éª¤çš„å‘ç”Ÿï¼šåœæ­¢æ¥å—æ–°çš„è¿æ¥ï¼Œç­‰å¾…å½“å‰è¿æ¥åœæ­¢ï¼Œé‡æ–°è½½å…¥é…ç½®æ–‡ä»¶ï¼Œé‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶ï¼Œé‡å¯æœåŠ¡å™¨ï¼Œä»è€Œå®ç°ç›¸å¯¹å¹³æ»‘çš„ä¸å…³æœºçš„æ›´æ”¹ã€‚\nå¯¹äº USR1 å’Œ 2 éƒ½å¯ä»¥ç”¨æˆ·è‡ªå®šä¹‰çš„ï¼Œåœ¨ POSIX å…¼å®¹çš„å¹³å°ä¸Šï¼ŒSIGUSR1 å’Œ SIGUSR2 æ˜¯å‘é€ç»™ä¸€ä¸ªè¿›ç¨‹çš„ä¿¡å·ï¼Œå®ƒè¡¨ç¤ºäº†ç”¨æˆ·å®šä¹‰çš„æƒ…å†µã€‚å®ƒä»¬çš„ç¬¦å·å¸¸é‡åœ¨å¤´æ–‡ä»¶ signal.h ä¸­å®šä¹‰ã€‚åœ¨ä¸åŒçš„å¹³å°ä¸Šï¼Œä¿¡å·çš„ç¼–å·å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ç¬¦å·åç§°ã€‚\nkill -HUP pid\nkillall -HUP pName\nå…¶ä¸­ pid æ˜¯è¿›ç¨‹æ ‡è¯†ï¼ŒpName æ˜¯è¿›ç¨‹çš„åç§°ã€‚\nå¦‚æœæƒ³è¦æ›´æ”¹é…ç½®è€Œä¸éœ€åœæ­¢å¹¶é‡æ–°å¯åŠ¨æœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨ä¸Šé¢ä¸¤ä¸ªå‘½ä»¤ã€‚åœ¨å¯¹é…ç½®æ–‡ä»¶ä½œå¿…è¦çš„æ›´æ”¹åï¼Œå‘å‡ºè¯¥å‘½ä»¤ä»¥åŠ¨æ€æ›´æ–°æœåŠ¡é…ç½®ã€‚æ ¹æ®çº¦å®šï¼Œå½“ä½ å‘é€ä¸€ä¸ªæŒ‚èµ·ä¿¡å· (ä¿¡å· 1 æˆ– HUP) æ—¶ï¼Œå¤§å¤šæ•°æœåŠ¡å™¨è¿›ç¨‹ (æ‰€æœ‰å¸¸ç”¨çš„è¿›ç¨‹) éƒ½ä¼šè¿›è¡Œå¤ä½æ“ä½œå¹¶é‡æ–°åŠ è½½å®ƒä»¬çš„é…ç½®æ–‡ä»¶ã€‚\nå‚è€ƒèµ„æ–™ Linux æ—¥å¿—åˆ‡å‰²ç¥å™¨ logrotate åŸç†ä»‹ç»å’Œé…ç½®è¯¦è§£\n","date":"2021-11-08T22:25:00Z","permalink":"https://dccmmtop.github.io/posts/%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2logrotate%E5%8E%9F%E7%90%86%E5%92%8C%E9%85%8D%E7%BD%AE/","section":"posts","tags":null,"title":"æ—¥å¿—åˆ‡å‰²logrotateåŸç†å’Œé…ç½®"},{"categories":null,"contents":"ä¸Šä¸‹æ–‡æ„ŸçŸ¥ Goè¯­è¨€çš„æ¨¡æ¿å¼•æ“å¯ä»¥æ ¹æ®å†…å®¹æ‰€å¤„çš„ä¸Šä¸‹æ–‡æ”¹å˜å…¶æ˜¾ç¤º.\nä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„ç”¨é€”å°±æ˜¯å¯¹è¢«æ˜¾ç¤ºçš„å†…å®¹å®æ–½æ­£ç¡®çš„è½¬ä¹‰ï¼ˆescapeï¼‰ï¼šè¿™æ„å‘³ç€ï¼Œå¦‚æœæ¨¡æ¿æ˜¾ç¤ºçš„æ˜¯HTMLæ ¼å¼çš„å†…å®¹ï¼Œé‚£ä¹ˆæ¨¡æ¿å°†å¯¹å…¶å®æ–½HTMLè½¬ä¹‰ï¼›å¦‚æœæ¨¡æ¿æ˜¾ç¤ºçš„æ˜¯JavaScriptæ ¼å¼çš„å†…å®¹ï¼Œé‚£ä¹ˆæ¨¡æ¿å°†å¯¹å…¶å®æ–½JavaScriptè½¬ä¹‰ï¼›è¯¸å¦‚æ­¤ç±»ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒGoæ¨¡æ¿å¼•æ“è¿˜å¯ä»¥è¯†åˆ«å‡ºå†…å®¹ä¸­çš„URLæˆ–è€…cssæ ·å¼ã€‚\nç¤ºä¾‹ package main import ( \u0026#34;html/template\u0026#34; \u0026#34;net/http\u0026#34; ) func main() { server := http.Server{ Addr: \u0026#34;127.0.0.1:8080\u0026#34;, } http.HandleFunc(\u0026#34;/testContextAware\u0026#34;, testContextAware) server.ListenAndServe() } func testContextAware(w http.ResponseWriter, r *http.Request) { t, err := template.ParseFiles(\u0026#34;./testContextAware.tmpl\u0026#34;) if err != nil { panic(err) } content := `æˆ‘é—®: \u0026lt;i\u0026gt; \u0026#34;å‘ç”Ÿäº†ä»€ä¹ˆ\u0026#34; \u0026lt;/i\u0026gt;` err = t.Execute(w,content) if err != nil { panic(err) } } ä¸Šä¸‹æ–‡æ„ŸçŸ¥æ¨¡æ¿ \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Title\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div\u0026gt;{{ . }}\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;\u0026lt;a href=\u0026#34;/{{ . }}\u0026#34;\u0026gt;Path\u0026lt;/a\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;\u0026lt;a href=\u0026#34;/?q={{ . }}\u0026#34;\u0026gt;Query\u0026lt;/a\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;\u0026lt;a onclick=\u0026#34;f (\u0026#39;{{ .}}\u0026#39;) \u0026#34;\u0026gt;Onclick\u0026lt;/a\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; `` ## ç»“æœ ```txt HTTP/1.1 200 OK Date: Mon, 08 Nov 2021 13:52:59 GMT Content-Length: 569 Content-Type: text/html; charset=utf-8 \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Title\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div\u0026gt;æˆ‘é—®: \u0026amp;lt;i\u0026amp;gt; \u0026amp;#34;å‘ç”Ÿäº†ä»€ä¹ˆ\u0026amp;#34; \u0026amp;lt;/i\u0026amp;gt;\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;\u0026lt;a href=\u0026#34;/%e6%88%91%e9%97%ae:%20%3ci%3e%20%22%e5%8f%91%e7%94%9f%e4%ba%86%e4%bb%80%e4%b9%88%22%20%3c/i%3e\u0026#34;\u0026gt;Path\u0026lt;/a\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;\u0026lt;a href=\u0026#34;/?q=%e6%88%91%e9%97%ae%3a%20%3ci%3e%20%22%e5%8f%91%e7%94%9f%e4%ba%86%e4%bb%80%e4%b9%88%22%20%3c%2fi%3e\u0026#34;\u0026gt;Query\u0026lt;/a\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;div\u0026gt;\u0026lt;a onclick=\u0026#34;f (\u0026#39;æˆ‘é—®: \\u003ci\\u003e \\u0022å‘ç”Ÿäº†ä»€ä¹ˆ\\u0022 \\u003c\\/i\\u003e\u0026#39;) \u0026#34;\u0026gt;Onclick\u0026lt;/a\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; åŸæœ¬æœ‰å¯èƒ½ä¼šè¢«æµè§ˆå™¨æ‰§è¡Œçš„jså·²ç»è¢«è½¬ä¹‰äº†ï¼ŒåŸæ ·å±•ç¤º\nåº”ç”¨åœºæ™¯ ç”±ä¸Šå¯è§ï¼Œä¸Šä¸‹æ–‡æ„ŸçŸ¥ç‰¹æ€§å¯ä»¥å¾ˆæ–¹ä¾¿çš„é¿å…XSSæ”»å‡»\nä¸Šä¸‹æ–‡æ„ŸçŸ¥åŠŸèƒ½ä¸ä»…èƒ½å¤Ÿè‡ªåŠ¨å¯¹HTMLè¿›è¡Œè½¬ä¹‰ï¼Œå®ƒè¿˜èƒ½å¤Ÿé˜²æ­¢åŸºäºJavaScriptï¼ŒCssç”šè‡³URLçš„XSSæ”»å‡»ã€‚é‚£ä¹ˆè¿™æ˜¯å¦æ„å‘³ç€æˆ‘ä»¬åªè¦ä½¿ç”¨Goçš„æ¨¡æ¿å¼•æ“å°±å¯ä»¥æ— å¿§æ— è™‘åœ°è¿›è¡Œå¼€å‘äº†å‘¢ï¼Ÿå¹¶éå¦‚æ­¤ï¼Œä¸Šä¸‹æ–‡æ„ŸçŸ¥è™½ç„¶å¾ˆæ–¹ä¾¿ï¼Œä½†å®ƒå¹¶éçµä¸¹å¦™è¯ï¼Œè€Œä¸”æœ‰ä¸å°‘æ–¹æ³•å¯ä»¥ç»•å¼€ä¸Šä¸‹æ–‡æ„ŸçŸ¥ã€‚\nå®é™…ä¸Šï¼Œå¦‚æœéœ€è¦ï¼Œç”¨å¯ä»¥å®Œå…¨ä¸ä½¿ç”¨ä¸Šä¸‹æ–‡æ„ŸçŸ¥ç‰¹æ€§çš„ã€‚\nä¸ä½¿ç”¨ä¸Šä¸‹æ–‡æ„ŸçŸ¥ å¯ä»¥ä½¿ç”¨ç±»å‹è½¬æ¢ï¼ŒæŠŠå†…å®¹è½¬æ¢æˆhtml\nfunc testContextAware(w http.ResponseWriter, r *http.Request) { t, err := template.ParseFiles(\u0026#34;./testContextAware.tmpl\u0026#34;) if err != nil { panic(err) } content := `æˆ‘é—®: \u0026lt;i\u0026gt; \u0026#34;å‘ç”Ÿäº†ä»€ä¹ˆ\u0026#34; \u0026lt;/i\u0026gt;` err = t.Execute(w,template.HTML(content)) if err != nil { panic(err) } } ","date":"2021-11-08T21:32:35Z","permalink":"https://dccmmtop.github.io/posts/go%E6%A8%A1%E6%9D%BF%E4%B9%8B%E4%B8%8A%E4%B8%8B%E6%84%9F%E7%9F%A5/","section":"posts","tags":["go"],"title":"Goæ¨¡æ¿ä¹‹ä¸Šä¸‹æ–‡æ„ŸçŸ¥"},{"categories":null,"contents":"Goçš„æ¨¡æ¿åŠ¨ä½œå°±æ˜¯åµŒå…¥æ¨¡æ¿çš„å‘½ä»¤\næ¡ä»¶åŠ¨ä½œ {{ if arg }} some content {{ else }} other content {{ end }} è¿­ä»£åŠ¨ä½œ è¿­ä»£åŠ¨ä½œå¯ä»¥å¯¹æ•°ç»„ï¼Œåˆ‡ç‰‡ï¼Œæ˜ å°„ï¼Œæˆ–è€…é€šé“è¿›è¡Œè¿­ä»£, åœ¨è¿­ä»£å¾ªç¯å†…éƒ¨ï¼Œ ç‚¹(.) ä¼šè¢«è®¾ç½®æ­£åœ¨å½“å‰è¿­ä»£å†…å®¹\nè®¾ç½®åŠ¨ä½œ è®¾ç½®åŠ¨ä½œå…è®¸ä¸ºæŒ‡å®šçš„èŒƒå›´çš„ç‚¹(.) è®¾ç½®æŒ‡å®šçš„å€¼ã€‚å‡å°‘é‡å¤ä»£ç \nåŒ…å«åŠ¨ä½œ åŒ…å«åŠ¨ä½œï¼ˆinclude actionï¼‰å…è®¸ç”¨æˆ·åœ¨ä¸€ä¸ªæ¨¡æ¿é‡Œé¢åŒ…å«å¦ä¸€ä¸ªæ¨¡æ¿ï¼Œä»è€Œæ„å»ºå‡ºåµŒå¥—çš„æ¨¡æ¿ã€‚\nåŒ…å«åŠ¨ä½œçš„æ ¼å¼ä¸º{{ template \u0026ldquo;name\u0026rdquo; arg }}ï¼Œå…¶ä¸­nameå‚æ•°ä¸ºè¢«åŒ…å«æ¨¡æ¿çš„åå­—ã€‚æ²¡æœ‰ç‰¹åˆ«æŒ‡å®šåç§°æ—¶ï¼Œå°±æ˜¯æ–‡ä»¶åï¼Œ arg æ˜¯å‚æ•°å\nå‚æ•°ã€å˜é‡å’Œç®¡é“ å‚æ•°\nä¸€ä¸ªå‚æ•°ï¼ˆargumentï¼‰å°±æ˜¯æ¨¡æ¿ä¸­çš„ä¸€ä¸ªå€¼ã€‚å®ƒå¯ä»¥æ˜¯å¸ƒå°”å€¼ã€æ•´æ•°ã€å­—ç¬¦ä¸²ç­‰å­—é¢é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»“æ„ã€ç»“æ„ä¸­çš„ä¸€ä¸ªå­—æ®µæˆ–è€…æ•°ç»„ä¸­çš„ä¸€ä¸ªé”®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå‚æ•°è¿˜å¯ä»¥æ˜¯ä¸€ä¸ªå˜é‡ã€ä¸€ä¸ªæ–¹æ³•ï¼ˆè¿™ä¸ªæ–¹æ³•å¿…é¡»åªè¿”å›ä¸€ä¸ªå€¼ï¼Œæˆ–è€…åªè¿”å›ä¸€ä¸ªå€¼å’Œä¸€ä¸ªé”™è¯¯ï¼‰æˆ–è€…ä¸€ä¸ªå‡½æ•°ã€‚æœ€åï¼Œå‚æ•°ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç‚¹ï¼ˆ.ï¼‰ï¼Œç”¨äºè¡¨ç¤ºå¤„ç†å™¨å‘æ¨¡æ¿å¼•æ“ä¼ é€’çš„æ•°æ®ã€‚\nå˜é‡\né™¤äº†å‚æ•°ä¹‹å¤–ï¼Œç”¨æˆ·è¿˜å¯ä»¥åœ¨åŠ¨ä½œä¸­è®¾ç½®å˜é‡ã€‚å˜é‡ä»¥ç¾å…ƒç¬¦å·ï¼ˆ$ï¼‰å¼€å¤´ï¼Œå°±åƒè¿™æ ·ï¼š\nåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç‚¹ï¼ˆ.ï¼‰æ˜¯ä¸€ä¸ªæ˜ å°„ï¼Œè€ŒåŠ¨ä½œrangeåœ¨è¿­ä»£è¿™ä¸ªæ˜ å°„çš„æ—¶å€™ï¼Œä¼šå°†å˜é‡$keyå’Œ$valueåˆ†åˆ«åˆå§‹åŒ–ä¸ºå½“å‰è¢«è¿­ä»£æ˜ å°„å…ƒç´ çš„é”®å’Œå€¼ã€‚\nç®¡é“\næ¨¡æ¿ä¸­çš„ç®¡é“ï¼ˆpipelineï¼‰æ˜¯å¤šä¸ªæœ‰åºåœ°ä¸²è”èµ·æ¥çš„å‚æ•°ã€å‡½æ•°å’Œæ–¹æ³•ï¼Œå®ƒçš„å·¥ä½œæ–¹å¼å’Œè¯­æ³•è·ŸUnixçš„ç®¡é“ä¹Ÿéå¸¸ç›¸ä¼¼ï¼š\n{{p1 | p2 | p3}} è¿™é‡Œçš„p1,p2å’Œp3å¯ä»¥æ˜¯å‚æ•°æˆ–è€…å‡½æ•°ã€‚\nç®¡é“å…è®¸ç”¨æˆ·å°†ä¸€ä¸ªå‚æ•°çš„è¾“å‡ºä¼ é€’ç»™ä¸‹ä¸€ä¸ªå‚æ•°ï¼Œè€Œå„ä¸ªå‚æ•°ä¹‹é—´åˆ™ä½¿ç”¨ | åˆ†éš”ã€‚\nå‡½æ•° Goçš„æ¨¡æ¿å¼•æ“å‡½æ•°éƒ½æ˜¯å—é™åˆ¶çš„ï¼šå°½ç®¡è¿™äº›å‡½æ•°å¯ä»¥æ¥å—ä»»æ„å¤šä¸ªå‚æ•°ä½œä¸ºè¾“å…¥ï¼Œä½†å®ƒä»¬åªèƒ½è¿”å›ä¸€ä¸ªå€¼ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªå€¼å’Œä¸€ä¸ªé”™è¯¯ã€‚\nä¸ºäº†åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æ¨¡æ¿å‡½æ•°ï¼Œéœ€è¦ï¼š\nåˆ›å»ºä¸€ä¸ªåä¸ºFuncMapçš„æ˜ å°„ï¼Œå¹¶å°†æ˜ å°„çš„é”®è®¾ç½®ä¸ºå‡½æ•°çš„åå­—ï¼Œè€Œæ˜ å°„çš„å€¼åˆ™è®¾ç½®ä¸ºå®é™…å®šä¹‰çš„å‡½æ•° å°†FuncMap ä¸æ¨¡æ¿ç»‘å®š ç¤ºä¾‹ï¼š\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;html/template\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;time\u0026#34; ) func main(){ server := http.Server{ Addr: \u0026#34;127.0.0.1:8080\u0026#34;, } http.HandleFunc(\u0026#34;/testFuncMap\u0026#34;, testFuncMap) server.ListenAndServe() } func testFuncMap(w http.ResponseWriter, re *http.Request) { funcMap := template.FuncMap{ \u0026#34;fdate\u0026#34;: formatDate, } t := template.New(\u0026#34;testFuncMap.tmpl\u0026#34;).Funcs(funcMap) // å‰åæ¨¡æ¿çš„åå­—å¿…é¡»ç›¸åŒ t, err := t.ParseFiles(\u0026#34;./testFuncMap.tmpl\u0026#34;) if err != nil { fmt.Println(err) return } err = t.Execute(w,time.Now()) if err != nil { fmt.Println(err) return } } func formatDate(t time.Time) string{ layout := \u0026#34;2006-01-02\u0026#34; return t.Format(layout) } æ¨¡æ¿æ–‡ä»¶ \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Title\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; the date/time is {{. | fdate}} \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ç»“æœ \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Title\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; the date/time is 2021-11-08 \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; ","date":"2021-11-02T22:44:33Z","permalink":"https://dccmmtop.github.io/posts/go%E6%A8%A1%E6%9D%BF%E4%B9%8B%E5%8A%A8%E4%BD%9C/","section":"posts","tags":["go"],"title":"Goæ¨¡æ¿ä¹‹åŠ¨ä½œ"},{"categories":null,"contents":"Goçš„æ¨¡æ¿éƒ½æ˜¯æ–‡æœ¬æ–‡æ¡£ï¼ˆå…¶ä¸­Webåº”ç”¨çš„æ¨¡æ¿é€šå¸¸éƒ½æ˜¯HTMLï¼‰ï¼Œå®ƒä»¬éƒ½åµŒå…¥äº†ä¸€äº›ç§°ä¸ºåŠ¨ä½œï¼ˆactionï¼‰çš„æŒ‡ä»¤ã€‚ä»æ¨¡æ¿å¼•æ“çš„è§’åº¦æ¥è¯´ï¼Œæ¨¡æ¿å°±æ˜¯åµŒå…¥äº†åŠ¨ä½œçš„æ–‡æœ¬ï¼ˆè¿™äº›æ–‡æœ¬é€šå¸¸åŒ…å«åœ¨æ¨¡æ¿æ–‡ä»¶é‡Œé¢ï¼‰ï¼Œè€Œæ¨¡æ¿å¼•æ“åˆ™é€šè¿‡åˆ†æå¹¶æ‰§è¡Œè¿™äº›æ–‡æœ¬æ¥ç”Ÿæˆå‡ºå¦å¤–ä¸€äº›æ–‡æœ¬ã€‚Goè¯­è¨€æ‹¥æœ‰é€šç”¨æ¨¡æ¿å¼•æ“åº“ text/templateï¼Œå®ƒå¯ä»¥å¤„ç†ä»»æ„æ ¼å¼çš„æ–‡æœ¬ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒGoè¯­è¨€è¿˜æ‹¥æœ‰ä¸“é—¨ä¸ºHTMLæ ¼å¼è€Œè®¾çš„æ¨¡æ¿å¼•æ“åº“ html/template æ¨¡æ¿ä¸­çš„åŠ¨ä½œé»˜è®¤ä½¿ç”¨ä¸¤ä¸ªå¤§æ‹¬å· {{}}ï¼‰åŒ…å›´ï¼Œå¦‚æœç”¨æˆ·æœ‰éœ€è¦ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ¨¡æ¿å¼•æ“æä¾›çš„æ–¹æ³•è‡ªè¡ŒæŒ‡å®šå…¶ä»–å®šç•Œç¬¦ï¼ˆdelimiterï¼‰ã€‚\nä½¿ç”¨æ­¥éª¤ ä½¿ç”¨ Go çš„æ¨¡æ¿å¼•æ“éœ€è¦ä¸¤ä¸ªæ­¥éª¤ï¼š\nå¯¹æ–‡æœ¬æ ¼å¼çš„æ¨¡æ¿æºè¿›è¡Œè¯­æ³•åˆ†æï¼Œåˆ›å»ºä¸€ä¸ªç»è¿‡è¯­æ³•åˆ†æçš„æ¨¡æ¿ç»“æ„ï¼Œå…¶ä¸­æ¨¡æ¿æºæ—¢å¯ä»¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯æ¨¡æ¿æ–‡ä»¶åŒ…å«çš„å†…å®¹ï¼Œ æ‰§è¡Œç»è¿‡è¯­æ³•åˆ†æçš„æ¨¡æ¿ï¼Œå°† ResponseWriter å’Œæ¨¡æ¿æ‰€éœ€è¦çš„åŠ¨æ€æ•°æ®ä¼ é€’ç»™æ¨¡æ¿å¼•æ“ï¼Œè¢«è°ƒç”¨çš„æ¨¡æ¿å¼•æ“ä¼šæŠŠåˆ†æåçš„æ¨¡æ¿ç»“æ„å’Œæ•°æ®ç»“åˆèµ·æ¥ï¼Œç”Ÿæˆæœ€ç»ˆçš„HTML,å¹¶å°†HTMLå†™å…¥ ResponseWriter.\nç¤ºä¾‹:\ntmp.html: \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html lang=\u0026#34;en\u0026#34;\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Title\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; {{.}} \u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt; package main import ( \u0026#34;html/template\u0026#34; \u0026#34;net/http\u0026#34; ) func main(){ server := http.Server{ Addr: \u0026#34;127.0.0.1:8080\u0026#34;, } http.HandleFunc(\u0026#34;/process\u0026#34;,process) server.ListenAndServe() } func process(w http.ResponseWriter, request *http.Request) { t, _ := template.ParseFiles(\u0026#34;./tmpl.html\u0026#34;) t.Execute(w, \u0026#34;ä½ å¥½å“‡ï¼æé“¶æ²³\u0026#34;) // ç¬¬äºŒç§æ–¹å¼ /** t = template.New(\u0026#34;tmpl.html\u0026#34;) t.ParseFiles(\u0026#34;./tmpl.html\u0026#34;) t.Execute(w,\u0026#34;hello\u0026#34;) */ } å¯¹æ¨¡æ¿è¿›è¡Œè¯­æ³•åˆ†æ ParseFilesæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ï¼ˆstandaloneï¼‰å‡½æ•°ï¼Œå®ƒå¯ä»¥å¯¹æ¨¡æ¿æ–‡ä»¶è¿›è¡Œè¯­æ³•åˆ†æï¼Œå¹¶åˆ›å»ºå‡ºä¸€ä¸ªç»è¿‡è¯­æ³•åˆ†æçš„æ¨¡æ¿ç»“æ„ä»¥ä¾›Executeæ–¹æ³•æ‰§è¡Œã€‚å®é™…ä¸Šï¼ŒParseFileså‡½æ•°åªæ˜¯ä¸ºäº†æ–¹ä¾¿åœ°è°ƒç”¨Templateç»“æ„çš„ParseFilesæ–¹æ³•è€Œè®¾ç½®çš„ä¸€ä¸ªå‡½æ•°-å½“ç”¨æˆ·è°ƒç”¨Parserileså‡½æ•°çš„æ—¶å€™ï¼ŒGoä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ¨¡æ¿ï¼Œå¹¶å°†ç”¨æˆ·ç»™å®šçš„æ¨¡æ¿æ–‡ä»¶çš„åå­—ç”¨ä½œè¿™ä¸ªæ–°æ¨¡æ¿çš„åå­—ï¼š\nt, _ := template.ParseFiles(\u0026#34;tmpl.html\u0026#34;) è¿™ç›¸å½“äºåˆ›å»ºä¸€ä¸ªæ–°æ¨¡æ¿ï¼Œç„¶åè°ƒç”¨å®ƒçš„ParseFilesæ–¹æ³•\nt := template.New(\u0026#34;tmpl.html\u0026#34;) t, _ := t.ParseFiles(\u0026#34;tmpl.html\u0026#34;) ä¸Šé¢ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥æ¥å—å¤šä¸ªæ¨¡æ¿å‚æ•°ï¼Œä½†åªè¿”å›ç¬¬ä¸€ä¸ªå‚æ•°å¯¹åº”çš„æ¨¡æ¿ç»“æ„\nå½“ç”¨æˆ·å‘ParseFileså‡½æ•°æˆ–Parserilesæ–¹æ³•ä¼ å…¥å¤šä¸ªæ–‡ä»¶æ—¶ï¼ŒParseFilesåªä¼šè¿”å›ç”¨æˆ·ä¼ å…¥çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„å·²åˆ†ææ¨¡æ¿ï¼Œå¹¶ä¸”è¿™ä¸ªæ¨¡æ¿ä¹Ÿä¼šæ ¹æ®ç”¨æˆ·ä¼ å…¥çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„åå­—è¿›è¡Œå‘½åï¼›è‡³äºå…¶ä»–ä¼ å…¥æ–‡ä»¶çš„å·²åˆ†ææ¨¡æ¿åˆ™ä¼šè¢«æ”¾ç½®åˆ°ä¸€ä¸ªæ˜ å°„é‡Œé¢ï¼Œè¿™ä¸ªæ˜ å°„å¯ä»¥åœ¨ä¹‹åæ‰§è¡Œæ¨¡æ¿æ—¶ä½¿ç”¨ã€‚\næ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·è®¤ä¸ºï¼šåœ¨å‘Parserilesä¼ å…¥å•ä¸ªæ–‡ä»¶æ—¶ï¼ŒParserilesè¿”å›çš„æ˜¯ä¸€ä¸ªæ¨¡æ¿ï¼›è€Œåœ¨å‘ParseFilesä¼ å…¥å¤šä¸ªæ–‡ä»¶æ—¶ï¼ŒParseFilesè¿”å›çš„åˆ™æ˜¯ä¸€ä¸ªæ¨¡æ¿é›†åˆï¼Œç†è§£è¿™ä¸€ç‚¹èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬æ›´å¥½åœ°å­¦ä¹ åµŒå¥—æ¨¡æ¿æŠ€æœ¯ã€‚\nå¯¹å­—ç¬¦ä¸²åˆ†æ åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç¨‹åºéƒ½æ˜¯å¯¹æ¨¡æ¿æ–‡ä»¶è¿›è¡Œè¯­æ³•åˆ†æï¼Œä½†æ˜¯åœ¨éœ€è¦æ—¶ï¼Œç¨‹åºä¹Ÿå¯ä»¥ç›´æ¥å¯¹å­—ç¬¦ä¸²å½¢å¼çš„æ¨¡æ¿è¿›è¡Œè¯­æ³•åˆ†æã€‚å®é™…ä¸Šï¼Œæ‰€æœ‰å¯¹æ¨¡æ¿è¿›è¡Œè¯­æ³•åˆ†æçš„æ‰‹æ®µæœ€ç»ˆéƒ½éœ€è¦è°ƒç”¨Parseæ–¹æ³•æ¥æ‰§è¡Œå®é™…çš„è¯­æ³•åˆ†ææ“ä½œã€‚æ¯”å¦‚è¯´ï¼Œåœ¨æ¨¡æ¿å†…å®¹ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œè¯­å¥\nt, _ := template.ParseFiles(\u0026#34;./tmpl.html\u0026#34;) å’Œä»£ç \ntmpl := `\u0026lt;! DOCTYPE html\u0026gt; \u0026lt;html\u0026gt;\u0026lt;head\u0026gt; \u0026lt;meta http-equiv=\u0026#34;Content-Type\u0026#34;content=\u0026#34;text/html; charset=utf-8\u0026#34;\u0026gt; \u0026lt;title\u0026gt;Go Web programming\u0026lt;/title\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; {.}} \u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;` t := template. New (\u0026#34;tmpl. html\u0026#34;) t, = t. Parse (tmpl). t. Execute (w, \u0026#34;Hello world!\u0026#34;) å°†äº§ç”Ÿç›¸åŒçš„æ•ˆæœ\nå¯¹é”™è¯¯çš„å¤„ç† ä¸€ç›´éƒ½æ²¡æœ‰å¤„ç†åˆ†ææ¨¡æ¿æ—¶å¯èƒ½ä¼šäº§ç”Ÿçš„é”™è¯¯ã€‚è™½ç„¶Goè¯­è¨€çš„ä¸€èˆ¬åšæ³•æ˜¯æ‰‹åŠ¨åœ°å¤„ç†é”™è¯¯ï¼Œä½†Goä¹Ÿæä¾›äº†å¦å¤–ä¸€ç§æœºåˆ¶ï¼Œä¸“é—¨ç”¨äºå¤„ç†åˆ†ææ¨¡æ¿æ—¶å‡ºç°çš„é”™è¯¯ï¼š\nt := template.Must(template.ParseFiles(\u0026quot;tmpl.html\u0026quot;))\nMustå‡½æ•°å¯ä»¥åŒ…è£¹èµ·ä¸€ä¸ªå‡½æ•°ï¼Œè¢«åŒ…è£¹çš„å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªæŒ‡å‘æ¨¡æ¿çš„æŒ‡é’ˆå’Œä¸€ä¸ªé”™è¯¯ï¼Œå¦‚æœè¿™ä¸ªé”™è¯¯ä¸æ˜¯nilï¼Œé‚£ä¹ˆMustå‡½æ•°å°†äº§ç”Ÿä¸€ä¸ªpanicã€‚\nåœ¨Goé‡Œé¢ï¼Œpanicä¼šå¯¼è‡´æ­£å¸¸çš„æ‰§è¡Œæµç¨‹è¢«ç»ˆæ­¢ï¼šå¦‚æœpanicæ˜¯åœ¨å‡½æ•°å†…éƒ¨äº§ç”Ÿçš„ï¼Œé‚£ä¹ˆå‡½æ•°ä¼šå°†è¿™ä¸ªpanicè¿”å›ç»™å®ƒçš„è°ƒç”¨è€…ã€‚panicä¼šä¸€ç›´å‘è°ƒç”¨æ ˆçš„ä¸Šæ–¹ä¼ é€’ï¼Œç›´è‡³mainå‡½æ•°ä¸ºæ­¢ï¼Œå¹¶ä¸”ç¨‹åºä¹Ÿä¼šå› æ­¤è€Œå´©æºƒã€‚\næ‰§è¡Œæ¨¡æ¿ æ‰§è¡Œæ¨¡æ¿æœ€å¸¸ç”¨çš„æ–¹æ³•å°±æ˜¯è°ƒç”¨æ¨¡æ¿çš„Executeæ–¹æ³•ï¼Œå¹¶å‘å®ƒä¼ é€’Responsewriterä»¥åŠæ¨¡æ¿æ‰€éœ€çš„æ•°æ®ã€‚åœ¨åªæœ‰ä¸€ä¸ªæ¨¡æ¿çš„æƒ…å†µä¸‹ï¼Œä¸Šé¢æåˆ°çš„è¿™ç§æ–¹æ³•æ€»æ˜¯å¯è¡Œçš„ï¼Œä½†å¦‚æœæ¨¡æ¿ä¸æ­¢ä¸€ä¸ªï¼Œé‚£ä¹ˆå½“å¯¹æ¨¡æ¿é›†åˆè°ƒç”¨Executeæ–¹æ³•çš„æ—¶å€™ï¼ŒExecuteæ–¹æ³•åªä¼šæ‰§è¡Œæ¨¡æ¿é›†åˆä¸­çš„ç¬¬ä¸€ä¸ªæ¨¡æ¿ã€‚å¦‚æœæƒ³è¦æ‰§è¡Œçš„ä¸æ˜¯æ¨¡æ¿é›†åˆä¸­çš„ç¬¬ä¸€ä¸ªæ¨¡æ¿è€Œæ˜¯å…¶ä»–æ¨¡æ¿ï¼Œå°±éœ€è¦ä½¿ç”¨ExecuteTemplate æ–¹æ³•\nt,_ := template.ParseFiles(\u0026#34;t1. html\u0026#34;, \u0026#34;t2. html\u0026#34;) å˜é‡tå°±æ˜¯ä¸€ä¸ªåŒ…å«äº†ä¸¤ä¸ªæ¨¡æ¿çš„æ¨¡æ¿é›†åˆï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªæ¨¡æ¿åä¸ºt1.htmlï¼Œè€Œç¬¬äºŒä¸ªæ¨¡æ¿åˆ™åä¸ºt2.html\nï¼ˆæ­£å¦‚å‰é¢æ‰€è¯´ï¼Œé™¤éæ˜¾å¼åœ°å¯¹æ¨¡æ¿åè¿›è¡Œä¿®æ”¹ï¼Œå¦åˆ™æ¨¡æ¿çš„åå­—å’Œåç¼€åå°†ç”±ä¼ å…¥çš„æ¨¡æ¿æ–‡ä»¶å†³å®šï¼‰ï¼Œå¦‚æœå¯¹è¿™ä¸ªæ¨¡æ¿é›†åˆè°ƒç”¨Executeæ–¹æ³•ï¼š\nt.Execute(w,\u0026#34;ä½ å¥½å“‡ï¼\u0026#34;) å°±åªæœ‰æ¨¡æ¿t1.htmlä¼šè¢«æ‰§è¡Œã€‚å¦‚æœæƒ³è¦æ‰§è¡Œçš„æ˜¯æ¨¡æ¿t2.htmlè€Œä¸æ˜¯t1.htmlï¼Œåˆ™éœ€è¦æ‰§è¡Œä»¥ä¸‹è¯­å¥ï¼š\nt.ExecuteTemplate(w,\u0026#34;t2.html\u0026#34;,\u0026#34;ä½ å¥½å“‡!\u0026#34;) `` ","date":"2021-11-01T22:51:35Z","permalink":"https://dccmmtop.github.io/posts/go%E7%9A%84%E6%A8%A1%E6%9D%BF%E5%BC%95%E6%93%8E/","section":"posts","tags":["go"],"title":"Goçš„æ¨¡æ¿å¼•æ“"},{"categories":null,"contents":"ä¸ºäº†å‘ç”¨æˆ·æŠ¥å‘ŠæŸä¸ªåŠ¨ä½œçš„æ‰§è¡Œæƒ…å†µï¼Œåº”ç”¨ç¨‹åºæœ‰æ—¶å€™ä¼šå‘ç”¨æˆ·å±•ç¤ºä¸€æ¡ç®€çŸ­çš„é€šçŸ¥æ¶ˆæ¯ï¼Œ\næ¯”å¦‚è¯´ï¼Œå¦‚æœä¸€ä¸ªç”¨æˆ·å°è¯•åœ¨è®ºå›ä¸Šå‘è¡¨ä¸€ç¯‡å¸–å­ï¼Œä½†æ˜¯è¿™ç¯‡å¸–å­å› ä¸ºæŸç§åŸå› è€Œå‘è¡¨å¤±è´¥äº†ï¼Œé‚£ä¹ˆè®ºå›åº”è¯¥å‘è¿™ä¸ªç”¨æˆ·å±•ç¤ºä¸€æ¡å¸–å­å‘å¸ƒå¤±è´¥çš„æ¶ˆæ¯ã€‚\nè¿™ç§é€šçŸ¥æ¶ˆæ¯åº”è¯¥å‡ºç°åœ¨ç”¨æˆ·å½“å‰æ‰€åœ¨çš„é¡µé¢ï¼Œä½†æ˜¯åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œç”¨æˆ·åœ¨è®¿é—®è¿™ä¸ªé¡µé¢æ—¶å´ä¸åº”è¯¥çœ‹åˆ°è¿™æ ·çš„æ¶ˆæ¯ã€‚å› æ­¤ç¨‹åºå®é™…ä¸Šè¦åšçš„æ˜¯åœ¨æŸä¸ªæ¡ä»¶è¢«æ»¡è¶³æ—¶ï¼Œæ‰åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºä¸€æ¡ä¸´æ—¶å‡ºç°çš„æ¶ˆæ¯ï¼Œè¿™æ ·ç”¨æˆ·åœ¨åˆ·æ–°é¡µé¢ä¹‹åå°±ä¸ä¼šå†çœ‹è§ç›¸åŒçš„æ¶ˆæ¯äº†-æˆ‘ä»¬æŠŠè¿™ç§ä¸´æ—¶å‡ºç°çš„æ¶ˆæ¯ç§°ä¸ºé—ªç°æ¶ˆæ¯ï¼ˆflash messageï¼‰\nå®ç°é—ªç°æ¶ˆæ¯çš„æ–¹æ³•æœ‰å¾ˆå¤šç§ï¼Œä½†æœ€å¸¸ç”¨çš„æ–¹æ³•æ˜¯æŠŠè¿™äº›æ¶ˆæ¯å­˜å‚¨åœ¨é¡µé¢åˆ·æ–°æ—¶å°±ä¼šè¢«ç§»é™¤çš„ä¼šè¯cookieé‡Œé¢\næ·»åŠ é—ªç°æ¶ˆæ¯åˆ°cookie setMessageå¤„ç†å™¨å‡½æ•°çš„å®šä¹‰è·Ÿä¹‹å‰å±•ç¤ºè¿‡çš„setCookieå¤„ç†å™¨å‡½æ•°çš„å®šä¹‰éå¸¸ç›¸ä¼¼ï¼Œä¸»è¦çš„åŒºåˆ«åœ¨äºsetMessageå¯¹æ¶ˆæ¯ä½¿ç”¨äº†Base64URLç¼–ç ï¼Œä»¥æ­¤æ¥æ»¡è¶³å“åº”é¦–éƒ¨å¯¹cookieå€¼çš„URLç¼–ç è¦æ±‚ã€‚åœ¨è®¾ç½®cookieæ—¶ï¼Œå¦‚æœcookieçš„å€¼æ²¡æœ‰åŒ…å«è¯¸å¦‚ç©ºæ ¼æˆ–è€…ç™¾åˆ†å·è¿™æ ·çš„ç‰¹æ®Šå­—ç¬¦ï¼Œé‚£ä¹ˆä¸å¯¹å®ƒè¿›è¡Œç¼–ç ä¹Ÿæ˜¯å¯ä»¥çš„ï¼›ä½†æ˜¯å› ä¸ºåœ¨å‘é€é—ªç°æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯æœ¬èº«é€šå¸¸ä¼šåŒ…å«è¯¸å¦‚ç©ºæ ¼è¿™æ ·çš„å­—ç¬¦ï¼Œæ‰€ä»¥å¯¹cookieçš„å€¼è¿›è¡Œç¼–ç å°±æˆäº†ä¸€ä»¶å¿…ä¸å¯å°‘çš„äº‹æƒ…äº†ã€‚\nfunc setMessage(w http.ResponseWriter, r *http.Request) { msg := []byte(\u0026#34;åˆ›å»ºå¤±è´¥ï¼Œç¼ºå°‘å¿…å¡«å­—æ®µ!\u0026#34;) cookie := \u0026amp;http.Cookie{ Name: \u0026#34;flash\u0026#34;, // å¿…é¡»å¯¹ cookie è¿›è¡Œurlç¼–ç  Value: base64.URLEncoding.EncodeToString(msg), } http.SetCookie(w, cookie) } å±•ç¤ºé—ªç°æ¶ˆæ¯ // å±•ç¤ºé—ªç°æ¶ˆæ¯ func showMessage(w http.ResponseWriter, r *http.Request) { msg, err := r.Cookie(\u0026#34;flash\u0026#34;) if err != nil { if err == http.ErrNoCookie { fmt.Fprintln(w, \u0026#34;not found message\u0026#34;) return } } // ä½¿cookieè¿‡æœŸï¼Œè®©æµè§ˆå™¨åˆ é™¤cookie cookie := http.Cookie{ Name: \u0026#34;flash\u0026#34;, MaxAge: -1, Expires: time.Unix(1,0), } http.SetCookie(w, \u0026amp;cookie) fmt.Fprintln(w, msg) } è¿™ä¸ªå‡½æ•°é¦–å…ˆä¼šå°è¯•è·å–æŒ‡å®šçš„cookieï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°è¯¥cookieï¼Œå®ƒå°±ä¼šæŠŠå˜é‡errè®¾ç½®æˆä¸€ä¸ªhttp.ErrNoCookieå€¼ï¼Œå¹¶å‘æµè§ˆå™¨è¿”å›ä¸€æ¡\u0026quot;No message found\u0026quot;æ¶ˆæ¯ã€‚å¦‚æœæ‰¾åˆ°äº†è¿™ä¸ªcookieï¼Œé‚£ä¹ˆå®ƒå¿…é¡»å®Œæˆä»¥ä¸‹ä¸¤ä¸ªæ“ä½œ\nåˆ›å»ºä¸€ä¸ªåŒåçš„cookieï¼Œå°†å®ƒçš„MaxAgeå€¼è®¾ç½®ä¸ºè´Ÿæ•°ï¼Œå¹¶ä¸”å°†Expireså€¼ä¹Ÿè®¾ç½®æˆä¸€ä¸ªå·²ç»è¿‡å»çš„æ—¶é—´ï¼› ä½¿ç”¨SetCookieæ–¹æ³•å°†åˆšåˆšåˆ›å»ºçš„åŒåcookieå‘é€è‡³å®¢æˆ·ç«¯ã€‚ åˆçœ‹ä¸Šå»ï¼Œè¿™ä¸¤ä¸ªæ“ä½œçš„ç›®çš„ä¼¼ä¹æ˜¯è¦æ›¿æ¢å·²ç»å­˜åœ¨çš„cookieï¼Œä½†å®é™…ä¸Šï¼Œå› ä¸ºæ–°cookieçš„MaxAgeå€¼ä¸ºè´Ÿæ•°ï¼Œå¹¶ä¸”Expireså€¼ä¹Ÿæ˜¯ä¸€ä¸ªå·²ç»è¿‡å»çš„æ—¶é—´ï¼Œæ‰€ä»¥è¿™æ ·åšå®é™…ä¸Šå°±æ˜¯è¦å®Œå…¨åœ°ç§»é™¤è¿™ä¸ªcookieã€‚åœ¨è®¾ç½®å®Œæ–°cookieä¹‹åï¼Œç¨‹åºä¼šå¯¹å­˜å‚¨åœ¨æ—§cookieä¸­çš„æ¶ˆæ¯è¿›è¡Œè§£ç ï¼Œå¹¶é€šè¿‡å“åº”è¿”å›è¿™æ¡æ¶ˆæ¯ã€‚\nå®Œæ•´ä»£ç  package main import ( \u0026#34;encoding/base64\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;time\u0026#34; ) /** * åˆ©ç”¨cookieå®ç°é—ªç°æ¶ˆæ¯ */ func main(){ server := http.Server{ Addr: \u0026#34;127.0.0.1:8080\u0026#34;, } http.HandleFunc(\u0026#34;setMessage\u0026#34;,setMessage) http.HandleFunc(\u0026#34;showMessage\u0026#34;,showMessage) server.ListenAndServe() } // å±•ç¤ºé—ªç°æ¶ˆæ¯ func showMessage(w http.ResponseWriter, r *http.Request) { msg, err := r.Cookie(\u0026#34;flash\u0026#34;) if err != nil { if err == http.ErrNoCookie { fmt.Fprintln(w, \u0026#34;not found message\u0026#34;) return } } // ä½¿cookieè¿‡æœŸï¼Œè®©æµè§ˆå™¨åˆ é™¤cookie cookie := http.Cookie{ Name: \u0026#34;flash\u0026#34;, MaxAge: -1, Expires: time.Unix(1,0), } http.SetCookie(w, \u0026amp;cookie) fmt.Fprintln(w, msg) } func setMessage(w http.ResponseWriter, r *http.Request) { msg := []byte(\u0026#34;åˆ›å»ºå¤±è´¥ï¼Œç¼ºå°‘å¿…å¡«å­—æ®µ!\u0026#34;) cookie := \u0026amp;http.Cookie{ Name: \u0026#34;flash\u0026#34;, // å¿…é¡»å¯¹ cookie è¿›è¡Œurlç¼–ç  Value: base64.URLEncoding.EncodeToString(msg), } http.SetCookie(w, cookie) } ","date":"2021-10-28T23:20:50Z","permalink":"https://dccmmtop.github.io/posts/%E5%88%A9%E7%94%A8cookie%E5%AE%9E%E7%8E%B0%E9%97%AA%E7%8E%B0%E6%B6%88%E6%81%AF/","section":"posts","tags":["go"],"title":"åˆ©ç”¨cookieå®ç°é—ªç°æ¶ˆæ¯"},{"categories":null,"contents":"è§£æè¯·æ±‚å¤´ // è§£æè¯·æ±‚å¤´ func headers(w http.ResponseWriter, request *http.Request) { // è·å–æ‰€æ¬²è¯·æ±‚å¤´ï¼ŒHeader æ˜¯ä¸ª map, key æ˜¯å­—ç¬¦ä¸²ï¼Œvalue æ˜¯å­—ç¬¦ä¸²åˆ‡ç‰‡ headers := request.Header fmt.Printf(\u0026#34;æ‰€æœ‰è¯·æ±‚å¤´headers: %v\\n\u0026#34;, headers) // è·å–å•ä¸ªè¯·æ±‚å¤´,è¿”å›çš„æ˜¯å­—ç¬¦ä¸²åˆ‡ç‰‡ // [gzip, deflate] coding := headers[\u0026#34;Accept-Encoding\u0026#34;] fmt.Printf(\u0026#34;Accept-Encoding: %v\\n\u0026#34;, coding) // è·å–å•ä¸ªè¯·æ±‚å¤´,å¦‚æœè¯·æ±‚å¤´çš„å€¼æ˜¯å¤šä¸ªï¼Œç”¨é€—å·æ‹¼æ¥ // gzip, deflate coding1 := headers.Get(\u0026#34;Accept-Encoding\u0026#34;) fmt.Printf(\u0026#34;Accept-Encoding1: %v\\n\u0026#34;, coding1) fmt.Fprintln(w, headers) } ä»æµä¸­è§£æè¯·æ±‚ä½“ ç›´æ¥è¯»å– body å­—èŠ‚æµï¼Œå†è½¬æ¢æˆè‡ªå·±æƒ³è¦çš„æ ¼å¼ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œä½†å¯ä»¥å¤„ç†ä»»ä½•è¯·æ±‚ç±»å‹çš„å‚æ•°\n// æ¥è¯·æ±‚ä½“-åŸå§‹ // å¯ä»¥å¤„ç† application/json ç±»å‹çš„å‚æ•° func body(w http.ResponseWriter, request *http.Request) { // è·å–è¯·æ±‚ä½“çš„é•¿åº¦ len := request.ContentLength body := make([]byte, len) //ã€€å°†æ•°æ®è¯»å–åˆ°å­—èŠ‚æ•°ç»„ä¸­ request.Body.Read(body) fmt.Fprintln(w,string(body)) } è§£æè¡¨å• è°ƒç”¨ParseFormæ–¹æ³•æˆ–è€…ParseMultipartFormæ–¹æ³•ï¼Œå¯¹è¯·æ±‚è¿›è¡Œè¯­æ³•åˆ†æã€‚ æ ¹æ®æ­¥éª¤1è°ƒç”¨çš„æ–¹æ³•ï¼Œè®¿é—®ç›¸åº”çš„Formå­—æ®µã€PostFormå­—æ®µæˆ–MultipartFormå­—æ®µ // è§£æè¡¨å•-æ‰‹åŠ¨è§£æè¯­æ³• func form(w http.ResponseWriter, request *http.Request) { // æ‰‹åŠ¨å…ˆè¿›è¡Œè¯­æ³•åˆ†æ request.ParseForm() // å†è®¿é—®Form æˆ–PostForm å­—æ®µ // Form ä¼šåŒæ—¶è¿”å› URL ä¸Šçš„å‚æ•°å€¼ å’Œ form è¡¨å•ä¸­çš„å‚æ•°å€¼ï¼Œå¦‚æœä¸¤å¤„æœ‰ç›¸åŒçš„å‚æ•°ï¼Œå€¼æ˜¯å­—ç¬¦ä¸²åˆ‡ç‰‡ fmt.Printf(\u0026#34;Form: %v\\n\u0026#34;,request.Form) // PostForm åªä¼šåŒ…å«è¡¨å•ä¸­çš„å‚æ•° fmt.Printf(\u0026#34;PostForm: %v\\n\u0026#34;,request.PostForm) // multipart/form-data ç±»å‹å‚æ•° // å–å‡º1024å­—èŠ‚æ•°æ® request.ParseMultipartForm(1024) fmt.Printf(\u0026#34;multipart: %v\\n\u0026#34;,request.MultipartForm) } ç›´æ¥è·å–è¡¨å•å€¼ å› ä¸ºFormvalueæ–¹æ³•å³ä½¿åœ¨ç»™å®šé”®æ‹¥æœ‰å¤šä¸ªå€¼çš„æƒ…å†µä¸‹ï¼Œä¹Ÿåªä¼šä»Formç»“æ„ä¸­å–å‡ºç»™å®šé”®çš„ç¬¬ä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¦è·å–ç»™å®šé”®åŒ…å«çš„æ‰€æœ‰å€¼ï¼Œé‚£ä¹ˆå°±éœ€è¦ç›´æ¥è®¿é—®Formç»“æ„\n// è§£æè¡¨å•-è‡ªåŠ¨è§£æè¯­æ³• func formValue(w http.ResponseWriter, request *http.Request) { // FormValue æ–¹æ³•ä¼šè‡ªåŠ¨è°ƒç”¨ ParseForm æˆ– ParseMultipartForm æ–¹æ³• // å¦‚æœå‚æ•°æœ‰å¤šä¸ªå€¼ï¼Œåªä¼šå–ç¬¬ä¸€ä¸ª, å¦‚æœéœ€è¦è·å–å…¨éƒ¨å€¼ï¼Œç”¨Formå­—æ®µ request.FormValue(\u0026#34;userId\u0026#34;) // PostFormValue åŒä¸Šï¼Œä½†åªåŒ…å«è¡¨å•ä¸­çš„å‚æ•°ï¼ŒåŒ…å«URlä¸­å‚æ•° request.PostFormValue(\u0026#34;name\u0026#34;) } è·å–æ–‡ä»¶ func uploadFile(w http.ResponseWriter, request *http.Request) { // ç¬¬ä¸€ç§æ–¹æ³•ï¼Œè§£ææ–‡ä»¶æµ request.ParseMultipartForm(1024) // å–å‡ºæ–‡ä»¶å¤´ fileHeader := request.MultipartForm.File[\u0026#34;uploaded\u0026#34;][0] // æ‰“å¼€æ–‡ä»¶ file, err := fileHeader.Open() if err != nil { data ,err := ioutil.ReadAll(file) if err != nil { // å°†æ–‡ä»¶å†™å…¥å“åº”ä½“ fmt.Println(\u0026#34;file: \u0026#34;, string(data)) } } // ç¬¬äºŒç§ï¼ŒFormFile æ–¹æ³• file1,_, err := request.FormFile(\u0026#34;uploaded1\u0026#34;) if err != nil { data, err := ioutil.ReadAll(file1) if err != nil { fmt.Println(\u0026#34;file1: \u0026#34;, string(data)) } } } å®Œæ•´ä»£ç  package main import ( \u0026#34;fmt\u0026#34; \u0026#34;io/ioutil\u0026#34; \u0026#34;net/http\u0026#34; ) func main(){ server := http.Server{ Addr: \u0026#34;127.0.0.1:8080\u0026#34;, } http.HandleFunc(\u0026#34;/header\u0026#34;,headers) http.HandleFunc(\u0026#34;/body\u0026#34;,body) http.HandleFunc(\u0026#34;/form\u0026#34;,form) http.HandleFunc(\u0026#34;/formValue\u0026#34;,formValue) http.HandleFunc(\u0026#34;/uploadFile\u0026#34;,uploadFile) server.ListenAndServe() } func uploadFile(w http.ResponseWriter, request *http.Request) { // ç¬¬ä¸€ç§æ–¹æ³•ï¼Œè§£ææ–‡ä»¶æµ request.ParseMultipartForm(1024) // å–å‡ºæ–‡ä»¶å¤´ fileHeader := request.MultipartForm.File[\u0026#34;uploaded\u0026#34;][0] // æ‰“å¼€æ–‡ä»¶ file, err := fileHeader.Open() if err != nil { data ,err := ioutil.ReadAll(file) if err != nil { // å°†æ–‡ä»¶å†™å…¥å“åº”ä½“ fmt.Println(\u0026#34;file: \u0026#34;, string(data)) } } // ç¬¬äºŒç§ï¼ŒFormFile æ–¹æ³• file1,_, err := request.FormFile(\u0026#34;uploaded1\u0026#34;) if err != nil { data, err := ioutil.ReadAll(file1) if err != nil { fmt.Println(\u0026#34;file1: \u0026#34;, string(data)) } } } // è§£æè¡¨å•-è‡ªåŠ¨è§£æè¯­æ³• func formValue(w http.ResponseWriter, request *http.Request) { // FormValue æ–¹æ³•ä¼šè‡ªåŠ¨è°ƒç”¨ ParseForm æˆ– ParseMultipartForm æ–¹æ³• // å¦‚æœå‚æ•°æœ‰å¤šä¸ªå€¼ï¼Œåªä¼šå–ç¬¬ä¸€ä¸ª, å¦‚æœéœ€è¦è·å–å…¨éƒ¨å€¼ï¼Œç”¨Formå­—æ®µ request.FormValue(\u0026#34;userId\u0026#34;) // PostFormValue åŒä¸Šï¼Œä½†åªåŒ…å«è¡¨å•ä¸­çš„å‚æ•°ï¼ŒåŒ…å«URlä¸­å‚æ•° request.PostFormValue(\u0026#34;name\u0026#34;) } // è§£æè¡¨å•-æ‰‹åŠ¨è§£æè¯­æ³• func form(w http.ResponseWriter, request *http.Request) { // æ‰‹åŠ¨å…ˆè¿›è¡Œè¯­æ³•åˆ†æ request.ParseForm() // å†è®¿é—®Form æˆ–PostForm å­—æ®µ // Form ä¼šåŒæ—¶è¿”å› URL ä¸Šçš„å‚æ•°å€¼ å’Œ form è¡¨å•ä¸­çš„å‚æ•°å€¼ï¼Œå¦‚æœä¸¤å¤„æœ‰ç›¸åŒçš„å‚æ•°ï¼Œå€¼æ˜¯å­—ç¬¦ä¸²åˆ‡ç‰‡ fmt.Printf(\u0026#34;Form: %v\\n\u0026#34;,request.Form) // PostForm åªä¼šåŒ…å«è¡¨å•ä¸­çš„å‚æ•° fmt.Printf(\u0026#34;PostForm: %v\\n\u0026#34;,request.PostForm) // multipart/form-data ç±»å‹å‚æ•° // å–å‡º1024å­—èŠ‚æ•°æ® request.ParseMultipartForm(1024) fmt.Printf(\u0026#34;multipart: %v\\n\u0026#34;,request.MultipartForm) } // æ¥è¯·æ±‚ä½“-åŸå§‹ // å¯ä»¥å¤„ç† application/json ç±»å‹çš„å‚æ•° func body(w http.ResponseWriter, request *http.Request) { // è·å–è¯·æ±‚ä½“çš„é•¿åº¦ len := request.ContentLength body := make([]byte, len) //ã€€å°†æ•°æ®è¯»å–åˆ°å­—èŠ‚æ•°ç»„ä¸­ request.Body.Read(body) fmt.Fprintln(w,string(body)) } // è§£æè¯·æ±‚å¤´ func headers(w http.ResponseWriter, request *http.Request) { // è·å–æ‰€æ¬²è¯·æ±‚å¤´ï¼ŒHeader æ˜¯ä¸ª map, key æ˜¯å­—ç¬¦ä¸²ï¼Œvalue æ˜¯å­—ç¬¦ä¸²åˆ‡ç‰‡ headers := request.Header fmt.Printf(\u0026#34;æ‰€æœ‰è¯·æ±‚å¤´headers: %v\\n\u0026#34;, headers) // è·å–å•ä¸ªè¯·æ±‚å¤´,è¿”å›çš„æ˜¯å­—ç¬¦ä¸²åˆ‡ç‰‡ // [gzip, deflate] coding := headers[\u0026#34;Accept-Encoding\u0026#34;] fmt.Printf(\u0026#34;Accept-Encoding: %v\\n\u0026#34;, coding) // è·å–å•ä¸ªè¯·æ±‚å¤´,å¦‚æœè¯·æ±‚å¤´çš„å€¼æ˜¯å¤šä¸ªï¼Œç”¨é€—å·æ‹¼æ¥ // gzip, deflate coding1 := headers.Get(\u0026#34;Accept-Encoding\u0026#34;) fmt.Printf(\u0026#34;Accept-Encoding1: %v\\n\u0026#34;, coding1) fmt.Fprintln(w, headers) } ","date":"2021-10-28T00:19:44Z","permalink":"https://dccmmtop.github.io/posts/%E8%A7%A3%E6%9E%90%E8%AF%B7%E6%B1%82%E5%A4%B4%E5%92%8C%E8%AF%B7%E6%B1%82%E4%BD%93/","section":"posts","tags":["go"],"title":"è§£æè¯·æ±‚å¤´å’Œè¯·æ±‚ä½“"},{"categories":null,"contents":"åœ¨HTTPåè®®ä¸­ï¼Œé¦–éƒ¨å’Œè¯·æ±‚ä½“æ˜¯åˆ†å¼€ä¼ è¾“çš„ï¼Œå°†ä¸€äº›è®¤è¯ä¿¡æ¯å‚æ•°æ”¾åœ¨è¯·æ±‚å¤´ä¸­ï¼ŒæœåŠ¡ç«¯å…ˆè§£æè¯·æ±‚å¤´ï¼Œå¦‚æœè®¤è¯ä¸é€šè¿‡ï¼Œå¯ä»¥ç›´æ¥è¿”å›è®¤è¯å¤±è´¥ï¼Œä¸ç”¨å†ä¼ è¾“è¯·æ±‚ä½“ï¼Œä»è€Œæé«˜æœåŠ¡å™¨çš„æ€§èƒ½ã€‚\nä¸‹é¢åšå®éªŒéªŒè¯,å®éªŒæ€è·¯ï¼š\nç¼–å†™ä¸€ä¸ªå¸¦æœ‰èº«ä»½éªŒè¯çš„ä¸Šä¼ æ–‡ä»¶æ¥å£ï¼Œæ­¤æ¥å£å…ˆè§£æè¯·æ±‚å¤´ä¸­çš„ tokenå‚æ•°ï¼Œå¦‚æœtokenæ­£ç¡®ï¼Œç»§ç»­è§£æè¯·æ±‚ä½“ä¸­çš„é™„ä»¶ï¼Œå¦‚æœtokené”™è¯¯ï¼Œç›´æ¥è¿”å›401ï¼Œ\nä¸Šä¼ ä¸€ä¸ªè¶…å¤§çš„æ–‡ä»¶ï¼Œæ¯”è¾ƒä¸¤ç§æƒ…å†µçš„æ¥å£è€—æ—¶ã€‚\næ¥å£ package main import ( \u0026#34;fmt\u0026#34; \u0026#34;io/ioutil\u0026#34; \u0026#34;net/http\u0026#34; ) func main(){ server := http.Server{ Addr: \u0026#34;127.0.0.1:8080\u0026#34;, } http.HandleFunc(\u0026#34;/test\u0026#34;,test) server.ListenAndServe() } func test(w http.ResponseWriter, request *http.Request) { token := request.Header.Get(\u0026#34;Authorization\u0026#34;) if token != \u0026#34;Bearer 12345\u0026#34; { w.WriteHeader(401) fmt.Fprintln(w,\u0026#34;è®¤è¯å¤±è´¥\u0026#34;) return } fmt.Println(\u0026#34;è§£ææ–‡ä»¶ã€‚ã€‚ã€‚\u0026#34;) data, _ ,err := request.FormFile(\u0026#34;file\u0026#34;) if err != nil { file, _ := ioutil.ReadAll(data) fmt.Fprintln(w, string(file)) } } æµ‹è¯• é€šè¿‡ curl è°ƒç”¨è¯¥æ¥å£, ä¸ºä½¿æ•ˆæœæ˜æ˜¾ï¼Œä¸Šä¼ äº†ä¸€ä¸ªè¾ƒå¤§çš„é•œåƒæ–‡ä»¶ã€‚\ntoken é”™è¯¯çš„æƒ…å†µ curl -i --location --request GET \u0026#39;127.0.0.1:8080/test\u0026#39; --header \u0026#39;Authorization:Bearer 123456\u0026#39; --form \u0026#39;file=@\u0026#34;/home/dc/windows10.iso\u0026#34;\u0026#39; å‡ æ¯«ç§’å†…å°±è¿”å›äº†å¤±è´¥çš„ç»“æœ:\nHTTP/1.1 401 Unauthorized Date: Wed, 27 Oct 2021 14:45:54 GMT Content-Length: 13 Content-Type: text/plain; charset=utf-8 Connection: close è®¤è¯å¤±è´¥ token æ­£ç¡®çš„æƒ…å†µ\ncurl -i --location --request GET \u0026#39;127.0.0.1:8080/test\u0026#39; --header \u0026#39;Authorization:Bearer 12345\u0026#39; --form \u0026#39;file=@\u0026#34;/home/dc/windows10.iso\u0026#34;\u0026#39; é€šè¿‡åå°æ—¥å¿—å¯ä»¥çœ‹åˆ°æ­£åœ¨è¯»å–æ–‡ä»¶ã€‚ç”±äºæµ‹è¯•çš„é™„ä»¶æœ‰3Gå¤šï¼Œéœ€è¦æ¼«é•¿çš„ç­‰å¾…ã€‚\næ€»ç»“ ç”±æ­¤è¯æ˜ï¼Œè¯·æ±‚å¤´å’Œè¯·æ±‚ä½“æ—¶åˆ†å¼€ä¼ è¾“çš„, æˆ‘ä»¬å¾€å¾€æŠŠä¸€äº›èº«ä»½è®¤è¯ä¿¡æ¯ç­‰æ”¾åœ¨é¦–éƒ¨ï¼Œä¾¿äºæœåŠ¡å¿«é€Ÿçš„å“åº”ã€‚æ­¤å¤–è¿˜éœ€æ³¨æ„ä¸€ç‚¹ï¼Œåœ¨ä¸€äº›webæ¡†æ¶ä¸­æä¾›çš„é€šç”¨èº«ä»½æ ¡éªŒä¸­é—´ä»¶ï¼Œæˆ–è€…è‡ªå·±ç¼–å†™çš„è¯·æ±‚è¿‡æ»¤å™¨ï¼Œéœ€è¦å…ˆè§£æè¯·æ±‚å¤´ï¼Œå†è§£æè¯·æ±‚ä½“ã€‚æ‰èƒ½åˆ©ç”¨ä¸Šæ­¤ç‰¹æ€§ã€‚\n","date":"2021-10-27T22:12:48Z","permalink":"https://dccmmtop.github.io/posts/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%8A%8A%E6%9F%90%E4%BA%9B%E5%8F%82%E6%95%B0%E6%94%BE%E5%9C%A8%E8%AF%B7%E6%B1%82%E5%A4%B4%E4%B8%AD/","section":"posts","tags":["HTTTP","go"],"title":"ä¸ºä»€ä¹ˆæŠŠæŸäº›å‚æ•°æ”¾åœ¨è¯·æ±‚å¤´ä¸­"},{"categories":null,"contents":"å°† cookie å‘é€ç»™è‡³å®¢æˆ·ç«¯ Cookieç»“æ„çš„stringæ–¹æ³•å¯ä»¥è¿”å›ä¸€ä¸ªç»è¿‡åºåˆ—åŒ–å¤„ç†çš„cookieï¼Œå…¶ä¸­Set-Cookieå“åº”é¦–éƒ¨çš„å€¼å°±æ˜¯ç”±è¿™äº›åºåˆ—åŒ–ä¹‹åçš„cookieç»„æˆçš„ã€‚\npackage main import \u0026#34;net/http\u0026#34; func main(){ server := http.Server{ Addr: \u0026#34;127.0.0.1:8080\u0026#34;, } http.HandleFunc(\u0026#34;/setCookie\u0026#34;,setCookie) server.ListenAndServe() } func setCookie(w http.ResponseWriter, request *http.Request) { c1 := http.Cookie{ Name: \u0026#34;first_cookie\u0026#34;, Value: \u0026#34;åƒé¥­äº†å—\u0026#34;, HttpOnly: true, } c2 := http.Cookie{ Name: \u0026#34;second_cookie\u0026#34;, Value: \u0026#34;åƒå•¥å‘¢\u0026#34;, HttpOnly: true, } // String() æ–¹æ³•è¿”å›åºåˆ—åŒ–åå¾— cookie w.Header().Set(\u0026#34;Cookie\u0026#34;,c1.String()) w.Header().Add(\u0026#34;Cookie\u0026#34;,c2.String()) // ç¬¬äºŒç§è®¾ç½® cookie çš„æ–¹æ³• c3 := http.Cookie{ Name: \u0026#34;cookie3\u0026#34;, Value: \u0026#34;å¤©æ°”æ€ä¹ˆæ ·\u0026#34;, HttpOnly: true, } http.SetCookie(w, \u0026amp;c3) } ","date":"2021-10-26T23:32:10Z","permalink":"https://dccmmtop.github.io/posts/cookie%E6%93%8D%E4%BD%9C/","section":"posts","tags":["go"],"title":"Cookieæ“ä½œ"},{"categories":null,"contents":"ä¼šè¯ cookie ä¸æŒä¹… cookie æ²¡æœ‰è®¾ç½®Expireså­—æ®µçš„cookieé€šå¸¸ç§°ä¸ºä¼šè¯cookieæˆ–è€…ä¸´æ—¶cookieï¼Œè¿™ç§cookieåœ¨æµè§ˆå™¨å…³é—­çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨è¢«ç§»é™¤ã€‚ç›¸å¯¹è€Œè¨€ï¼Œè®¾ç½®äº†Expireså­—æ®µçš„cookieé€šå¸¸ç§°ä¸ºæŒä¹…cookieï¼Œè¿™ç§cookieä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°æŒ‡å®šçš„è¿‡æœŸæ—¶é—´æ¥ä¸´æˆ–è€…è¢«æ‰‹åŠ¨åˆ é™¤ä¸ºæ­¢ã€‚\ncookie è¿‡æœŸæ—¶é—´ Expireså­—æ®µå’ŒMaxAgeå­—æ®µéƒ½å¯ä»¥ç”¨äºè®¾ç½®cookieçš„è¿‡æœŸæ—¶é—´ï¼Œå…¶ä¸­Expireså­—æ®µç”¨äºæ˜ç¡®åœ°æŒ‡å®šcookieåº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™è¿‡æœŸï¼Œè€ŒMaxAgeå­—æ®µåˆ™æŒ‡æ˜äº†cookieåœ¨è¢«æµè§ˆå™¨åˆ›å»ºå‡ºæ¥ä¹‹åèƒ½å¤Ÿå­˜æ´»å¤šå°‘ç§’ã€‚ä¹‹æ‰€ä»¥ä¼šå‡ºç°è¿™ä¸¤ç§æˆªç„¶ä¸åŒçš„è¿‡æœŸæ—¶é—´è®¾ç½®æ–¹å¼ï¼Œæ˜¯å› ä¸ºä¸åŒæµè§ˆå™¨ä½¿ç”¨äº†å„ä¸ç›¸åŒçš„cookieå®ç°æœºåˆ¶ï¼Œè·ŸGoè¯­è¨€æœ¬èº«çš„è®¾è®¡æ— å…³ã€‚è™½ç„¶HTTP 1.1ä¸­åºŸå¼ƒäº†Expiresï¼Œæ¨èä½¿ç”¨MaxAgeæ¥ä»£æ›¿Expiresï¼Œä½†å‡ ä¹æ‰€æœ‰æµè§ˆå™¨éƒ½ä»ç„¶æ”¯æŒExpiresï¼›è€Œä¸”ï¼Œå¾®è½¯çš„IE6ï¼ŒIE7å’ŒIE8éƒ½ä¸æ”¯æŒMaxAgeã€‚ä¸ºäº†è®©cookieåœ¨æ‰€æœ‰æµè§ˆå™¨ä¸Šéƒ½èƒ½å¤Ÿæ­£å¸¸åœ°è¿ä½œï¼Œä¸€ä¸ªå®é™…çš„æ–¹æ³•æ˜¯åªä½¿ç”¨Expiresï¼Œæˆ–è€…åŒæ—¶ä½¿ç”¨Expireså’Œ ĞœĞ°xAge.\n","date":"2021-10-26T23:28:06Z","permalink":"https://dccmmtop.github.io/posts/cookie%E6%A6%82%E8%A7%88/","section":"posts","tags":["HTTP"],"title":"Cookieæ¦‚è§ˆ"},{"categories":null,"contents":"è¿”å›ä½“ func writeExample(w http.ResponseWriter, request *http.Request) { // æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®å“åº”ç±»å‹ï¼Œä¼šé€šè¿‡æ£€æµ‹å“åº”çš„å‰ 512 ä¸ªå­—èŠ‚è‡ªåŠ¨åˆ¤æ–­å“åº”ç±»å‹ // è¿™é‡Œæ˜¯ Content-Type: text/html; charset=utf-8 str:= `\u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;Go Web Programming\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt;\u0026lt;hl\u0026gt;Hello World\u0026lt;/hl\u0026gt;\u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt;` w.Write([]byte(str)) } è®¾ç½®çŠ¶æ€ç  func writeHeaderExample(w http.ResponseWriter, request *http.Request) { // è®¾ç½®HTTP çŠ¶æ€ç , WriteHeader æ–¹æ³•åæœ‰è¯¯å¯¼ï¼Œåªèƒ½è®¾ç½®çŠ¶æ€ç ï¼Œè€Œä¸æ˜¯å…¶ä»–å“åº”é¦–éƒ¨ï¼Œ // é»˜è®¤æ˜¯200 // è°ƒç”¨ WriteHeader ä¹‹åä¸èƒ½åœ¨å¯¹å“åº”é¦–éƒ¨åšä»»ä½•æ“ä½œã€‚ä½†æ˜¯å¯ä»¥ç»§ç»­å†™å…¥å“åº”ä½“ w.WriteHeader(500) // åœ¨ WriteHeader ä¹‹åå¯¹é¦–éƒ¨çš„è®¾ç½®æ— æ•ˆ //w.Header().Set(\u0026#34;Content-Type\u0026#34;,\u0026#34;json\u0026#34;) fmt.Fprintln(w,\u0026#34;æœåŠ¡å¼‚å¸¸\u0026#34;) } è®¾ç½®é‡å®šå‘ func headerExample(w http.ResponseWriter, request *http.Request) { // Header è®¾ç½®å“åº”é¦–éƒ¨ w.Header().Set(\u0026#34;Location\u0026#34;,\u0026#34;http://www.baidu.com\u0026#34;) w.WriteHeader(302) } è¿”å›JSON func jsonExample(w http.ResponseWriter, request *http.Request) { // Header è®¾ç½®å“åº”é¦–éƒ¨ w.Header().Set(\u0026#34;Content-Type\u0026#34;,\u0026#34;application/json\u0026#34;) post := \u0026amp;Post{ User: \u0026#34;He Dong\u0026#34;, Thread: []string{\u0026#34;First\u0026#34;,\u0026#34;Second\u0026#34;,\u0026#34;Three\u0026#34;}, } json, _ := json.Marshal(post) w.Write(json) } å®Œæ•´ä»£ç  package main import ( json \u0026#34;encoding/json\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;net/http\u0026#34; ) type Post struct { User string Thread []string } // é€šè¿‡ç¼–å†™å“åº”é¦–éƒ¨é‡å®šå‘ func main(){ server := http.Server{ Addr: \u0026#34;127.0.0.1:8080\u0026#34;, } http.HandleFunc(\u0026#34;/write\u0026#34;,writeExample) http.HandleFunc(\u0026#34;/writeHeader\u0026#34;,writeHeaderExample) http.HandleFunc(\u0026#34;/redirect\u0026#34;,headerExample) http.HandleFunc(\u0026#34;/jsonExample\u0026#34;,jsonExample) server.ListenAndServe() } func writeExample(w http.ResponseWriter, request *http.Request) { // æ²¡æœ‰æ‰‹åŠ¨è®¾ç½®å“åº”ç±»å‹ï¼Œä¼šé€šè¿‡æ£€æµ‹å“åº”çš„å‰ 512 ä¸ªå­—èŠ‚è‡ªåŠ¨åˆ¤æ–­å“åº”ç±»å‹ // è¿™é‡Œæ˜¯ Content-Type: text/html; charset=utf-8 str:= `\u0026lt;html\u0026gt; \u0026lt;head\u0026gt;\u0026lt;title\u0026gt;Go Web Programming\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt; \u0026lt;body\u0026gt;\u0026lt;hl\u0026gt;Hello World\u0026lt;/hl\u0026gt;\u0026lt;/body\u0026gt; \u0026lt;/html\u0026gt;` w.Write([]byte(str)) } func writeHeaderExample(w http.ResponseWriter, request *http.Request) { // è®¾ç½®HTTP çŠ¶æ€ç , WriteHeader æ–¹æ³•åæœ‰è¯¯å¯¼ï¼Œåªèƒ½è®¾ç½®çŠ¶æ€ç ï¼Œè€Œä¸æ˜¯å…¶ä»–å“åº”é¦–éƒ¨ï¼Œ // é»˜è®¤æ˜¯200 // è°ƒç”¨ WriteHeader ä¹‹åä¸èƒ½åœ¨å¯¹å“åº”é¦–éƒ¨åšä»»ä½•æ“ä½œã€‚ä½†æ˜¯å¯ä»¥ç»§ç»­å†™å…¥å“åº”ä½“ w.WriteHeader(500) // åœ¨ WriteHeader ä¹‹åå¯¹é¦–éƒ¨çš„è®¾ç½®æ— æ•ˆ //w.Header().Set(\u0026#34;Content-Type\u0026#34;,\u0026#34;json\u0026#34;) fmt.Fprintln(w,\u0026#34;æœåŠ¡å¼‚å¸¸\u0026#34;) } func headerExample(w http.ResponseWriter, request *http.Request) { // Header è®¾ç½®å“åº”é¦–éƒ¨ w.Header().Set(\u0026#34;Location\u0026#34;,\u0026#34;http://www.baidu.com\u0026#34;) w.WriteHeader(302) } // è¿”å›json func jsonExample(w http.ResponseWriter, request *http.Request) { // Header è®¾ç½®å“åº”é¦–éƒ¨ w.Header().Set(\u0026#34;Content-Type\u0026#34;,\u0026#34;application/json\u0026#34;) post := \u0026amp;Post{ User: \u0026#34;He Dong\u0026#34;, Thread: []string{\u0026#34;First\u0026#34;,\u0026#34;Second\u0026#34;,\u0026#34;Three\u0026#34;}, } json, _ := json.Marshal(post) w.Write(json) } ","date":"2021-10-26T22:54:48Z","permalink":"https://dccmmtop.github.io/posts/%E8%AE%BE%E7%BD%AE%E5%93%8D%E5%BA%94%E9%A6%96%E9%83%A8/","section":"posts","tags":["go"],"title":"è®¾ç½®å“åº”é¦–éƒ¨åŠå“åº”ä½“ç¤ºä¾‹"},{"categories":null,"contents":"package main import ( \u0026#34;crypto/rand\u0026#34; \u0026#34;crypto/rsa\u0026#34; \u0026#34;crypto/x509\u0026#34; \u0026#34;crypto/x509/pkix\u0026#34; \u0026#34;encoding/pem\u0026#34; \u0026#34;math/big\u0026#34; \u0026#34;net\u0026#34; \u0026#34;os\u0026#34; \u0026#34;time\u0026#34; ) func main(){ max := new(big.Int).Lsh(big.NewInt(1), 128) serialNumber, _ := rand.Int(rand.Reader,max) subject := pkix.Name{ Organization: []string {\u0026#34;YX\u0026#34;}, OrganizationalUnit: []string {\u0026#34;YX\u0026#34;}, CommonName: \u0026#34;DC\u0026#34;, } template := x509.Certificate{ SerialNumber: serialNumber, Subject: subject, NotBefore: time.Now(), NotAfter: time.Now().Add(365 * 24 * time.Hour), KeyUsage: x509.KeyUsageKeyEncipherment | x509.KeyUsageDigitalSignature, ExtKeyUsage: []x509.ExtKeyUsage{x509.ExtKeyUsageServerAuth}, IPAddresses: []net.IP{net.ParseIP(\u0026#34;127.0.0.1\u0026#34;)}, } pk, _ := rsa.GenerateKey(rand.Reader,2048) derBytes , _ := x509.CreateCertificate(rand.Reader, \u0026amp;template, \u0026amp;template, \u0026amp;pk.PublicKey, pk) cerOut, _ := os.Create(\u0026#34;cert.pem\u0026#34;) pem.Encode(cerOut, \u0026amp;pem.Block{Type: \u0026#34;CERTIFICATE\u0026#34;, Bytes: derBytes}) cerOut.Close() keyOut , _ := os.Create(\u0026#34;key.pem\u0026#34;) pem.Encode(keyOut, \u0026amp;pem.Block{Type: \u0026#34;RAS PRIVATE KEY\u0026#34;, Bytes: x509.MarshalPKCS1PrivateKey(pk)}) keyOut.Close() } ","date":"2021-10-25T22:02:11Z","permalink":"https://dccmmtop.github.io/posts/%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6%E5%8F%8A%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%A7%81%E9%92%A5/","section":"posts","tags":null,"title":"ç”Ÿæˆè¯ä¹¦åŠæœåŠ¡ç«¯ç§é’¥"},{"categories":null,"contents":"ä»€ä¹ˆæ˜¯æ— çŠ¶æ€ å› ä¸ºHTTPæ˜¯ä¸€ç§æ— è¿æ¥åè®®ï¼ˆconnection-less protocolï¼‰ï¼Œé€šè¿‡è¿™ç§åè®®å‘é€ç»™æœåŠ¡å™¨çš„è¯·æ±‚å¯¹æœåŠ¡å™¨ä¹‹å‰å¤„ç†è¿‡çš„è¯·æ±‚ä¸€æ— æ‰€çŸ¥ï¼Œæ‰€ä»¥åº”ç”¨ç¨‹åºæ‰ä¼šä»¥cookieçš„æ–¹å¼åœ¨å®¢æˆ·ç«¯å®ç°æ•°æ®æŒä¹…åŒ–ï¼Œå¹¶ä»¥ä¼šè¯çš„æ–¹å¼åœ¨æœåŠ¡å™¨ä¸Šå®ç°æ•°æ®æŒä¹…åŒ–ï¼Œè€Œä¸äº†è§£è¿™ä¸€ç‚¹çš„äººæ˜¯å¾ˆéš¾ç†è§£ä¸ºä»€ä¹ˆè¦åœ¨ä¸åŒè¿æ¥ä¹‹é—´ä½¿ç”¨cookieå’Œä¼šè¯å®ç°ä¿¡æ¯æŒä¹…åŒ–\n","date":"2021-10-24T22:17:14Z","permalink":"https://dccmmtop.github.io/posts/http%E6%A6%82%E8%A7%88/","section":"posts","tags":["HTTP"],"title":"HTTPæ¦‚è§ˆ"},{"categories":null,"contents":"nobodyåœ¨linuxä¸­æ˜¯ä¸€ä¸ªä¸èƒ½ç™»é™†çš„å¸å·ï¼Œä¸€äº›æœåŠ¡è¿›ç¨‹å¦‚apacheï¼Œaquidç­‰éƒ½é‡‡ç”¨ä¸€äº›ç‰¹æ®Šçš„å¸å·æ¥è¿è¡Œï¼Œæ¯”å¦‚nobody,news,gamesç­‰ç­‰ï¼Œè¿™æ˜¯å°±å¯ä»¥é˜²æ­¢ç¨‹åºæœ¬èº«æœ‰å®‰å…¨é—®é¢˜çš„æ—¶å€™ï¼Œä¸ä¼šè¢«é»‘å®¢è·å¾—rootæƒé™\n1ã€Windowsç³»ç»Ÿåœ¨å®‰è£…åä¼šè‡ªåŠ¨å»ºç«‹ä¸€äº›ç”¨æˆ·å¸æˆ·ï¼Œåœ¨Linuxç³»ç»Ÿä¸­åŒæ ·æœ‰ä¸€äº›ç”¨æˆ·å¸æˆ·æ˜¯åœ¨ç³»ç»Ÿå®‰è£…åå°±æœ‰çš„ï¼Œå°±åƒWindowsç³»ç»Ÿä¸­çš„å†…ç½®å¸æˆ·ä¸€æ ·ã€‚\n2ã€å®ƒä»¬æ˜¯ç”¨æ¥å®Œæˆç‰¹å®šä»»åŠ¡çš„ï¼Œæ¯”å¦‚nobodyå’Œftpç­‰ï¼Œæˆ‘ä»¬è®¿é—® www.111cn.netçš„ç½‘é¡µç¨‹åºæ—¶ï¼Œå®˜ç½‘çš„æœåŠ¡å™¨å°±æ˜¯è®©å®¢æˆ·ä»¥ nobody èº«ä»½ç™»å½•çš„(ç›¸å½“äºWindowsç³»ç»Ÿä¸­çš„åŒ¿åå¸æˆ·);æˆ‘ä»¬åŒ¿åè®¿é—®ftpæ—¶ï¼Œä¼šç”¨åˆ°ç”¨æˆ·ftpæˆ–nobodyã€‚\n3ã€é¦–å…ˆï¼Œnobodyæ˜¯ä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼Œéç‰¹æƒç”¨æˆ·ã€‚ ä½¿ç”¨nobodyç”¨æˆ·åçš„\u0026rsquo;ç›®çš„\u0026rsquo;æ˜¯ï¼Œä½¿ä»»ä½•äººéƒ½å¯ä»¥ç™»å½•ç³»ç»Ÿï¼Œä½†æ˜¯å…¶ UID å’Œ GID ä¸æä¾›ä»»ä½•ç‰¹æƒï¼Œå³è¯¥uidå’Œgidåªèƒ½è®¿é—®äººäººçš†å¯è¯»å†™çš„æ–‡ä»¶ã€‚\n4ã€å…¶æ¬¡ï¼Œè®¸å¤šç³»ç»Ÿä¸­éƒ½æŒ‰æƒ¯ä¾‹åœ°é»˜è®¤åˆ›å»ºä¸€ä¸ªnobodyï¼Œå°½é‡\u0026rsquo;é™åˆ¶å®ƒçš„æƒé™è‡³æœ€å°\u0026rsquo;ï¼Œå½“æœåŠ¡å™¨å‘å¤–æœåŠ¡æ—¶ï¼Œå¯èƒ½ä¼šè®©clientä»¥nobodyçš„èº«ä»½ç™»å½•ã€‚\n5ã€nobodyå°±æ˜¯ä¸€ä¸ªæ™®é€šè´¦æˆ·ï¼Œå› ä¸ºé»˜è®¤ç™»å½•shellæ˜¯ \u0026lsquo;/sbin/nologin\u0026rsquo;ï¼Œæ‰€ä»¥è¿™ä¸ªç”¨æˆ·æ˜¯æ— æ³•ç›´æ¥ç™»å½•ç³»ç»Ÿçš„ï¼Œä¹Ÿå°±æ˜¯é»‘å®¢å¾ˆéš¾é€šè¿‡æ¼æ´è¿æ¥åˆ°ä½ çš„æœåŠ¡å™¨æ¥åšç ´åã€‚æ­¤å¤–è¿™ä¸ªç”¨æˆ·çš„æƒé™ä¹Ÿç»™é…ç½®çš„å¾ˆä½ã€‚å› æ­¤æœ‰æ¯”è¾ƒé«˜çš„å®‰å…¨æ€§ã€‚ä¸€åˆ‡éƒ½åªç»™æœ€ä½æƒé™ã€‚è¿™å°±æ˜¯nobodyå­˜åœ¨çš„æ„ä¹‰ã€‚\n","date":"2021-10-21T17:30:36Z","permalink":"https://dccmmtop.github.io/posts/linux_nobody%E7%94%A8%E6%88%B7/","section":"posts","tags":null,"title":"Linux_nobodyç”¨æˆ·"},{"categories":null,"contents":"æ¦‚è§ˆ ä¸ºäº†ç†è§£Elasticsearchä¸­æ•°æ®æ˜¯å¦‚ä½•ç»„ç»‡çš„ï¼Œä»ä»¥ä¸‹ä¸¤ä¸ªè§’åº¦æ¥è§‚å¯Ÿ\né€»è¾‘è®¾è®¡ æœç´¢åº”ç”¨æ‰€è¦æ³¨æ„çš„ã€‚ç”¨äºç´¢å¼•å’Œæœç´¢çš„åŸºæœ¬å•ä½æ˜¯æ–‡æ¡£ï¼Œå¯ä»¥å°†å…¶è®¤ä¸º æ–‡æ¡£ä»¥ç±»å‹æ¥åˆ†ç»„ï¼Œç±»å‹åŒ…å«è‹¥å¹²æ–‡æ¡£ï¼Œ ç±»ä¼¼è¡¨æ ¼åŒ…å«è‹¥å¹²\nè¡Œã€‚ æ˜¯å…³ç³»æ•°æ®åº“é‡Œçš„ä¸€è¡Œã€‚ æœ€ç»ˆä¸€ä¸ªæˆ–å¤šä¸ªç±»å‹å­˜åœ¨äºåŒä¸€ç´¢å¼•ä¸­ï¼Œç´¢å¼•æ˜¯æ›´å¤§çš„å®¹å™¨ï¼Œ ç±»ä¼¼äºSQLä¸­çš„æ•°æ®åº“\nES SQL æ–‡æ¡£ è¡Œ ç±»å‹ è¡¨ ç´¢å¼• æ•°æ®åº“ ç‰©ç†è®¾è®¡ åœ¨åå°Elasticsearchæ˜¯å¦‚ä½•å¤„ç†æ•°æ®çš„ã€‚\nElasticsearchå°†æ¯ä¸ªç´¢å¼•åˆ’åˆ†ä¸ºåˆ†ç‰‡ï¼Œæ¯ä»½åˆ†ç‰‡å¯ä»¥åœ¨é›†ç¾¤ä¸­çš„ä¸åŒæœåŠ¡å™¨é—´è¿ç§»ã€‚é€šå¸¸ï¼Œåº”ç”¨ç¨‹åºæ— é¡»å…³å¿ƒè¿™äº›ï¼Œå› ä¸ºæ— è®ºElasticsearchæ˜¯å•å°è¿˜æ˜¯å¤šå°æœåŠ¡å™¨ï¼Œåº”ç”¨å’ŒElasticsearchçš„äº¤äº’åŸºæœ¬ä¿æŒä¸å˜ã€‚ä½†æ˜¯ï¼Œå¼€å§‹ç®¡ç†é›†ç¾¤çš„æ—¶å€™ï¼Œå°±éœ€è¦ç•™å¿ƒäº†ã€‚ åŸå› æ˜¯ï¼Œç‰©ç†è®¾è®¡çš„é…ç½®æ–¹å¼å†³å®šäº†é›†ç¾¤çš„æ€§èƒ½å¯æ‰©å±•æ€§å’Œå¯ç”¨æ€§\né€»è¾‘è®¾è®¡ è¿™ä¸ªç´¢å¼•ä¸€ç±»å‹-IDçš„ç»„åˆå”¯ä¸€ç¡®å®šäº†Elasticsearchä¸­çš„æŸç¯‡æ–‡æ¡£ã€‚å½“è¿›è¡Œæœç´¢çš„æ—¶å€™ï¼Œå¯ä»¥æŸ¥æ‰¾ç‰¹å®šç´¢å¼•ã€ç‰¹å®šç±»å‹ä¸­çš„æ–‡æ¡£ï¼Œä¹Ÿå¯ä»¥è·¨å¤šä¸ªç±»å‹ç”šè‡³æ˜¯å¤šä¸ªç´¢å¼•è¿›è¡Œæœç´¢ã€‚\næ–‡æ¡£ æ— æ¨¡å¼\nElasticsearchä¸­çš„æ–‡æ¡£æ˜¯æ— æ¨¡å¼çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¹¶éæ‰€æœ‰çš„æ–‡æ¡£éƒ½éœ€è¦æ‹¥æœ‰ç›¸åŒçš„å­—æ®µï¼Œå®ƒä»¬ä¸æ˜¯å—é™äºåŒä¸€ä¸ªæ¨¡å¼ã€‚ä¾‹å¦‚ï¼Œåœ¨æ‰€æœ‰ä¿¡æ¯å®Œå¤‡ä¹‹å‰å°±è¦ä½¿ç”¨ç»„ç»‡è€…æ•°æ®æ—¶ï¼Œä½ å¯ä»¥å½»åº•å¿½ç•¥ä½ç½®æ•°æ®ã€‚\næ˜ å°„åŒ…å«æŸä¸ªç±»å‹ä¸­å½“å‰ç´¢å¼•çš„æ‰€æœ‰æ–‡æ¡£çš„æ‰€æœ‰å­—æ®µã€‚ä½†æ˜¯ä¸æ˜¯æ‰€æœ‰çš„æ–‡æ¡£å¿…é¡»è¦æœ‰æ‰€æœ‰çš„å­—æ®µ åŠ¨æ€æ·»åŠ å­—æ®µ\nå¦‚æœä¸€ç¯‡æ–°è¿‘æ–‡æ¡£æ‹¥æœ‰ä¸€ä¸ªæ˜ å°„ä¸­å°šä¸å­˜åœ¨çš„å­—æ®µ, Elasticsearchä¼šè‡ªåŠ¨åœ°å°†æ–°å­—æ®µåŠ å…¥æ˜ å°„ è‡ªåŠ¨æ¨å¯¼ç±»å‹\nå¦‚æœå€¼æ˜¯7, Elasticsearchä¼šå‡è®¾å­—æ®µæ˜¯é•¿æ•´å‹ã€‚\nè¿™ç§æ–°å­—æ®µçš„è‡ªåŠ¨æ£€æµ‹ä¹Ÿæœ‰ç¼ºç‚¹,å› ä¸º Elasticsearchå¯èƒ½çŒœå¾—ä¸å¯¹ã€‚ä¾‹å¦‚,åœ¨ç´¢å¼•äº†å€¼7ä¹‹å,ä½ å¯èƒ½æƒ³å†ç´¢å¼•he11owor1a,è¿™æ—¶ç”±äºå®ƒæ˜¯ stringè€Œä¸æ˜¯1ong,ç´¢å¼•å°±ä¼šå¤±è´¥ã€‚å¯¹äºçº¿ä¸Šç¯å¢ƒã€æœ€å®‰å…¨çš„æ–¹å¼æ˜¯åœ¨ç´¢å¼•æ•°æ®ä¹‹å‰,å°±å®šä¹‰å¥½æ‰€éœ€çš„æ˜ å°„ã€‚ ç±»å‹ ç±»å‹æ˜¯æ–‡æ¡£çš„é€»è¾‘å®¹å™¨,ç±»ä¼¼äºè¡¨æ ¼æ˜¯è¡Œçš„å®¹å™¨ã€‚åœ¨ä¸åŒçš„ç±»å‹ä¸­,æœ€å¥½æ”¾å…¥ä¸åŒç»“æ„(æ¨¡å¼)çš„æ–‡æ¡£\næ²¡æœ‰ç‰©ç†å®ä½“ä¸ç±»å‹ç³»ç›¸å¯¹åº” ï¼Œä»ç‰©ç†è§’åº¦æ¥çœ‹,åŒä¸€ç´¢å¼•ä¸­çš„æ–‡æ¡£éƒ½æ˜¯å†™å…¥ç£ç›˜,è€Œä¸è€ƒè™‘å®ƒä»¬æ‰€å±çš„æ˜ å°„ç±»å‹ã€‚ ç´¢å¼• å‡†å®æ—¶ æ¯ä¸ªç´¢å¼•æœ‰ä¸€ä¸ªç§°ä¸º refresh interva1çš„è®¾ç½®,å®šä¹‰äº†æ–°è¿‘ç´¢å¼•çš„æ–‡æ¡£å¯¹äºæœç´¢å¯è§çš„æ—¶é—´é—´éš”ã€‚ä»æ€§èƒ½çš„è§’åº¦æ¥çœ‹,åˆ·æ–°æ“ä½œçš„ä»£ä»·æ˜¯éå¸¸æ˜‚è´µçš„,è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ›´æ–°åªæ˜¯å¶å°”è¿›è¡Œã€‚é»˜è®¤æ˜¯æ¯ç§’æ›´æ–°ä¸€æ¬¡,è€Œä¸æ˜¯æ¯æ¥ä¸€ç¯‡æ–°çš„æ–‡æ¡£å°±æ›´æ–°ä¸€æ¬¡ã€‚å¦‚æœçœ‹åˆ° Elasticsearchè¢«ç§°ä¸ºå‡†å®æ—¶çš„,å°±æ˜¯æŒ‡çš„è¿™ç§åˆ·æ–°è¿‡ç¨‹ã€‚\nç‰©ç†è®¾è®¡ åˆ†ç‰‡ é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªç´¢å¼•ç”±5ä¸ªä¸»åˆ†ç‰‡ç»„æˆï¼Œæ¯ä¸ªä¸»åˆ†ç‰‡æœ‰ä¸€ä¸ªå‰¯æœ¬ã€‚ä¸€å…±10ä¸ªåˆ†ç‰‡ã€‚ï¼ˆè‡³å°‘ä¸€ä¸ªä¸»åˆ†ç‰‡ï¼Œ0ä¸ªæˆ–å¤šä¸ªå‰¯åˆ†ç‰‡ï¼‰\nä¸€ä»½åˆ†ç‰‡æ˜¯ä¸€ä¸ªåŒ…å«å€’æ’ç´¢å¼•çš„ç›®å½•ä¸­ ä¹Ÿæ˜¯ Luceneçš„ç´¢å¼•\nåˆ†ç‰‡ä¹Ÿæ˜¯ Elasticsearchå°†æ•°æ®ä»ä¸€ä¸ªèŠ‚ç‚¹è¿ç§»åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹çš„æœ€å°å•ä½\nå‰¯åˆ†ç‰‡å¯ä»¥åœ¨è¿è¡Œçš„æ—¶å€™æ·»åŠ æˆ–è€…ç§»é™¤ï¼Œè€Œä¸»åˆ†ç‰‡ä¸å¯ä»¥ï¼Œåˆ›å»ºç´¢å¼•ä¹‹å‰å¿…é¡»ç¡®å®šä¸»åˆ†ç‰‡çš„æ•°é‡\nè¿‡å°‘çš„åˆ†ç‰‡å°†é™åˆ¶å¯æ‰©å±•æ€§,ä½†æ˜¯è¿‡å¤šçš„åˆ†ç‰‡ä¼šå½±å“æ€§èƒ½ã€‚é»˜è®¤è®¾ç½®çš„5ä»½æ˜¯ä¸€ä¸ªä¸é”™å¼€å§‹\nå­˜å‚¨æ–‡æ¡£ é»˜è®¤æƒ…å†µä¸‹,å½“å­˜å‚¨ä¸€ç¯‡æ–‡æ¡£çš„æ—¶å€™,ç³»ç»Ÿé¦–å…ˆæ ¹æ®æ–‡æ¡£IDçš„æ•£åˆ—å€¼é€‰æ‹©ä¸€ä¸ªä¸»åˆ†ç‰‡,å¹¶å°†æ–‡æ¡£å‘é€åˆ°è¯¥ä¸»åˆ†ç‰‡\nç„¶åæ–‡æ¡£è¢«å‘é€åˆ°è¯¥ä¸»åˆ†ç‰‡çš„æ‰€æœ‰å‰¯æœ¬åˆ†ç‰‡è¿›è¡Œå­˜å‚¨ã€‚è¿™ä½¿å¾—å‰¯æœ¬åˆ†ç‰‡å’Œä¸»åˆ†ç‰‡ä¹‹é—´ä¿æŒæ•°æ®çš„åŒæ­¥ã€‚\næ•°æ®åŒæ­¥ä½¿å¾—å‰¯æœ¬åˆ†ç‰‡å¯ä»¥æœåŠ¡äºæœç´¢è¯·æ±‚,å¹¶åœ¨åŸæœ‰ä¸»åˆ†ç‰‡æ— æ³•è®¿é—®æ—¶è‡ªåŠ¨å‡çº§ä¸ºä¸»åˆ†ç‰‡ã€‚\né»˜è®¤åœ°,æ–‡æ¡£åœ¨åˆ†ç‰‡ä¸­å‡åŒ€åˆ†å¸ƒ:å¯¹äºæ¯ç¯‡æ–‡æ¡£,åˆ†ç‰‡æ˜¯é€šè¿‡å…¶IDå­—ç¬¦ä¸²çš„æ•£åˆ—å†³å®šçš„ã€‚æ¯ä»½åˆ†ç‰‡æ‹¥æœ‰ç›¸åŒçš„æ•£åˆ—èŒƒå›´,æ¥æ”¶æ–°æ–‡æ¡£çš„æœºä¼šå‡ç­‰\næœç´¢æ–‡æ¡£ åœ¨æœç´¢çš„æ—¶å€™,æ¥å—è¯·æ±‚çš„èŠ‚ç‚¹å°†è¯·æ±‚è½¬å‘åˆ°ä¸€ç»„åŒ…å«æ‰€æœ‰æ•°æ®çš„åˆ†ç‰‡ã€‚ Elasticsearchä½¿ç”¨ round-robinçš„è½®è¯¢æœºåˆ¶é€‰æ‹©å¯ç”¨çš„åˆ†ç‰‡(ä¸»åˆ†ç‰‡æˆ–å‰¯æœ¬åˆ†ç‰‡),å¹¶å°†æœç´¢è¯·æ±‚è½¬å‘è¿‡å»ã€‚ Elasticsearchç„¶åä»è¿™äº›åˆ†ç‰‡æ”¶é›†ç»“æœ,å°†å…¶èšé›†åˆ°å•ä¸€çš„å›å¤,ç„¶åå°†å›å¤è¿”å›ç»™å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºã€‚\nå€’æ’ç´¢å¼• å€’æ’ç´¢å¼•çš„ç»“æ„ä½¿å¾— Elasticsearchåœ¨ä¸æ‰«ææ‰€æœ‰æ–‡æ¡£çš„æƒ…å†µä¸‹,å°±èƒ½å‘Šè¯‰ä½ å“ªäº›æ–‡æ¡£åŒ…å«ç‰¹å®šçš„è¯æ¡(å•è¯)ã€‚\nè¯æ¡å­—å…¸\nè¯æ¡å­—å…¸å°†æ¯ä¸ªè¯æ¡å’ŒåŒ…å«è¯¥è¯æ¡çš„æ–‡æ¡£æ˜ å°„èµ·æ¥ï¼Œæœç´¢æ—¶æ²¡æœ‰å¿…è¦ä¸ºäº†æŸä¸ªè¯æ¡æ‰«ææ‰€æœ‰çš„æ–‡æ¡£,è€Œæ˜¯æ ¹æ®è¿™ä¸ªå­—å…¸å¿«é€Ÿåœ°è¯†åˆ«åŒ¹é…çš„æ–‡æ¡£ã€‚ è¯é¢‘\nè¯é¢‘ä½¿å¾— Elasticsearchå¯ä»¥å¿«é€Ÿåœ°è·å–æŸç¯‡æ–‡æ¡£ä¸­æŸä¸ªè¯æ¡å²€ç°çš„æ¬¡æ•°ã€‚è¿™å¯¹äºè®¡ç®—ç»“æœçš„ç›¸å…³æ€§å¾—åˆ†éå¸¸é‡è¦ã€‚ä¾‹å¦‚,å¦‚æœæœç´¢â€œ denverâ€,åŒ…å«å¤šä¸ªâ€œ denver\u0026quot;â€çš„æ–‡æ¡£é€šå¸¸æ›´ä¸ºç›¸å…³ã€‚ æ°´å¹³æ‰©å±• å¢åŠ æ›´å¤šçš„èŠ‚ç‚¹ï¼Œå·¥ä½œè´Ÿè½½è¢«åˆ†æ‘Šï¼ŒæŠµå¾¡é«˜å¹¶å‘ã€‚æ— æ³•æé«˜å•ä¸ªæœæœç´¢é€Ÿåº¦\nå‚ç›´æ‰©å±• ç»™æœºå™¨å¢åŠ æ›´å¤šçš„å†…å­˜æˆ–cpuæ ¸å¿ƒï¼Œæ›´å¿«çš„ç£ç›˜\nå·¥å…· æœ‰å‡ ä¸ªå›¾å½¢åŒ–ç•Œé¢\nElasticsearch Head\nElasticsearch Headå¯ä»¥é€šè¿‡ Elasticsearchæ’ä»¶çš„å½¢å¼æ¥å®‰è£…è¿™ä¸ªå·¥å…·,ä¸€ä¸ªå•\næœºçš„HTTPæœåŠ¡å™¨,æˆ–æ˜¯å¯ä»¥ä»æ–‡ä»¶ç³»ç»Ÿæ‰“å¼€çš„ç½‘é¡µã€‚å¯ä»¥ä»é‚£é‡Œå‘é€HTTPè¯·æ±‚,\nä½†æ˜¯Headä½œä¸ºç›‘æ§å·¥å…·æ˜¯æœ€æœ‰ç”¨çš„,å‘ä½ å±•ç¤ºé›†ç¾¤ä¸­åˆ†ç‰‡æ˜¯å¦‚ä½•åˆ†å¸ƒçš„ã€‚ å‚è€ƒèµ„æ–™ ã€ŠElasticSearchå®æˆ˜ã€‹\n","date":"2021-10-18T23:23:43Z","permalink":"https://dccmmtop.github.io/posts/elasticsearch%E8%AE%A4%E7%9F%A5/","section":"posts","tags":null,"title":"ElasticSearchè®¤çŸ¥"},{"categories":null,"contents":"","date":"2021-10-17T09:59:49Z","permalink":"https://dccmmtop.github.io/posts/https%E8%87%AA%E7%AD%BE%E8%AF%81%E4%B9%A6/","section":"posts","tags":null,"title":"HTTPSè‡ªç­¾è¯ä¹¦"},{"categories":null,"contents":"æ’å…¥å¹¶ä¿å­˜æ–‡æ¡£ db.foo.insert({\u0026#34;bar\u0026#34;: \u0026#34;baz\u0026#34;}) è¿™ä¸ªæ“ä½œä¼šç»™æ–‡æ¡£è‡ªåŠ¨å¢åŠ ä¸€ä¸ª\u0026quot;_id\u0026quot;é”®ï¼ˆè¦æ˜¯åŸæ¥æ²¡æœ‰çš„è¯ï¼‰ï¼Œç„¶åå°†å…¶ä¿å­˜åˆ°MongoDBä¸­ã€‚\næ‰¹é‡æ’å…¥ å¦‚æœè¦å‘é›†åˆä¸­æ’å…¥å¤šä¸ªæ–‡æ¡£ï¼Œä½¿ç”¨æ‰¹é‡æ’å…¥ä¼šå¿«ä¸€äº›ã€‚ä½¿ç”¨æ‰¹é‡æ’å…¥ï¼Œå¯ä»¥å°†ä¸€ç»„æ–‡æ¡£ä¼ é€’ç»™æ•°æ®åº“ã€‚\nåœ¨shellä¸­ï¼Œå¯ä»¥ä½¿ç”¨batchInsertå‡½æ•°å®ç°æ‰¹é‡æ’å…¥ï¼Œå®ƒä¸insertå‡½æ•°éå¸¸åƒï¼Œåªæ˜¯å®ƒæ¥å—çš„æ˜¯ä¸€ä¸ªæ–‡æ¡£æ•°ç»„ä½œä¸ºå‚æ•°ï¼š\ndb.foo.batchInsert([{\u0026#34;_id\u0026#34;: 1},{\u0026#34;_id\u0026#34;: 2}, {\u0026#34;_id\u0026#34;: 3}]) è¦æ˜¯åªå¯¼å…¥åŸå§‹æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œä»æ•°æ®feedæˆ–è€…MySQLä¸­å¯¼å…¥ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·ï¼Œå¦‚mongoimportï¼Œè€Œä¸æ˜¯æ‰¹é‡æ’å…¥\nå½“å‰ç‰ˆæœ¬çš„MongoDBèƒ½æ¥å—çš„æœ€å¤§æ¶ˆæ¯é•¿åº¦æ˜¯48 MBï¼Œæ‰€ä»¥åœ¨ä¸€æ¬¡æ‰¹é‡æ’å…¥ä¸­èƒ½æ’å…¥çš„æ–‡æ¡£æ˜¯æœ‰é™åˆ¶çš„ã€‚å¦‚æœè¯•å›¾æ’å…¥48 MBä»¥ä¸Šçš„æ•°æ®ï¼Œå¤šæ•°é©±åŠ¨ç¨‹åºä¼šå°†è¿™ä¸ªæ‰¹é‡æ’å…¥è¯·æ±‚æ‹†åˆ†ä¸ºå¤šä¸ª48 MBçš„æ‰¹é‡æ’å…¥è¯·æ±‚ã€‚å…·ä½“å¯ä»¥æŸ¥çœ‹æ‰€ä½¿ç”¨çš„é©±åŠ¨ç¨‹åºçš„ç›¸å…³æ–‡æ¡£ã€‚\nå¦‚æœåœ¨æ‰§è¡Œæ‰¹é‡æ’å…¥çš„è¿‡ç¨‹ä¸­æœ‰ä¸€ä¸ªæ–‡æ¡£æ’å…¥å¤±è´¥ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªæ–‡æ¡£ä¹‹å‰çš„æ‰€æœ‰æ–‡æ¡£éƒ½ä¼šæˆåŠŸæ’å…¥åˆ°é›†åˆä¸­ï¼Œè€Œè¿™ä¸ªæ–‡æ¡£ä»¥åŠä¹‹åçš„æ‰€æœ‰æ–‡æ¡£å…¨éƒ¨æ’å…¥å¤±è´¥ã€‚\nåœ¨æ‰¹é‡æ’å…¥ä¸­é‡åˆ°é”™è¯¯æ—¶ï¼Œå¦‚æœå¸Œæœ›batchInsertå¿½ç•¥é”™è¯¯å¹¶ä¸”ç»§ç»­æ‰§è¡Œåç»­æ’å…¥ï¼Œå¯ä»¥ä½¿ç”¨continueOnErroré€‰é¡¹\næ’å…¥æ ¡éªŒ æ£€æŸ¥æ–‡æ¡£çš„åŸºæœ¬ç»“æ„ï¼Œå¦‚æœæ²¡æœ‰\u0026quot;_id\u0026quot;å­—æ®µï¼Œå°±è‡ªåŠ¨å¢åŠ ä¸€ä¸ªã€‚ æ‰€æœ‰æ–‡æ¡£éƒ½å¿…é¡»å°äº16 MBï¼ˆè¿™ä¸ªå€¼æ˜¯MongoDBè®¾è®¡è€…äººä¸ºå®šçš„ï¼Œæœªæ¥æœ‰å¯èƒ½ä¼šå¢åŠ ï¼‰ã€‚ä½œè¿™æ ·çš„é™åˆ¶ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢ä¸è‰¯çš„æ¨¡å¼è®¾è®¡ï¼Œå¹¶ä¸”ä¿è¯æ€§èƒ½ä¸€è‡´ ","date":"2021-09-05T17:46:38Z","permalink":"https://dccmmtop.github.io/posts/%E5%88%9B%E5%BB%BA%E6%96%87%E6%A1%A3/","section":"posts","tags":["mongoDB"],"title":"Mongoåˆ›å»ºæ–‡æ¡£"},{"categories":null,"contents":"è¿è¡Œshell MongoDBè‡ªå¸¦JavaScript shellï¼Œå¯åœ¨shellä¸­ä½¿ç”¨å‘½ä»¤è¡Œä¸MongoDBå®ä¾‹äº¤äº’ã€‚\nshellæ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„JavaScriptè§£é‡Šå™¨ï¼Œå¯è¿è¡Œä»»æ„JavaScriptç¨‹åº\nå¦å¤–ï¼Œå¯å……åˆ†åˆ©ç”¨JavaScriptçš„æ ‡å‡†åº“:\nå†è€…ï¼Œå¯å®šä¹‰å’Œè°ƒç”¨JavaScriptå‡½æ•°ï¼š[æ’å›¾]\néœ€è¦æ³¨æ„ï¼Œå¯ä½¿ç”¨å¤šè¡Œå‘½ä»¤ã€‚shellä¼šæ£€æµ‹è¾“å…¥çš„JavaScriptè¯­å¥æ˜¯å¦å®Œæ•´ï¼Œå¦‚æ²¡å†™å®Œå¯åœ¨ä¸‹ä¸€è¡Œæ¥ç€å†™ã€‚åœ¨æŸè¡Œè¿ç»­ä¸‰æ¬¡æŒ‰ä¸‹å›è½¦é”®å¯å–æ¶ˆæœªè¾“å…¥å®Œæˆçš„å‘½ä»¤ï¼Œå¹¶é€€å›åˆ°ï¼-æç¤ºç¬¦ã€‚\nå¯åŠ¨mongo shellæ—¶ä¸è¿æ¥åˆ°ä»»ä½•mongodæœ‰æ—¶å¾ˆæ–¹ä¾¿ã€‚é€šè¿‡\u0026ndash;nodbå‚æ•°å¯åŠ¨shellï¼Œå¯åŠ¨æ—¶å°±ä¸ä¼šè¿æ¥ä»»ä½•æ•°æ®åº“,å¯åŠ¨mongo shellæ—¶ä¸è¿æ¥åˆ°ä»»ä½•mongodæœ‰æ—¶å¾ˆæ–¹ä¾¿ã€‚é€šè¿‡\u0026ndash;nodbå‚æ•°å¯åŠ¨shellï¼Œå¯åŠ¨æ—¶å°±ä¸ä¼šè¿æ¥ä»»ä½•æ•°æ®åº“\nå¯ä»¥é€šè¿‡db.help()æŸ¥çœ‹æ•°æ®åº“çº§åˆ«çš„å¸®åŠ©ï¼Œä½¿ç”¨db.foo.help()æŸ¥çœ‹é›†åˆçº§åˆ«çš„å¸®åŠ©ã€‚\nå¦‚æœæƒ³çŸ¥é“ä¸€ä¸ªå‡½æ•°æ˜¯åšä»€ä¹ˆç”¨çš„ï¼Œå¯ä»¥ç›´æ¥åœ¨shellè¾“å…¥å‡½æ•°åï¼ˆå‡½æ•°ååä¸è¦è¾“å…¥å°æ‹¬å·ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥çœ‹åˆ°ç›¸åº”å‡½æ•°çš„JavaScriptå®ç°ä»£ç ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæƒ³çŸ¥é“updateå‡½æ•°çš„å·¥ä½œæœºåˆ¶ï¼Œæˆ–è€…æ˜¯è®°ä¸æ¸…å‚æ•°çš„é¡ºåºï¼Œå°±å¯ä»¥åƒä¸‹é¢è¿™æ ·åšï¼š\nä½¿ç”¨shellæ‰§è¡Œè„šæœ¬ å¦‚æœå¸Œæœ›ä½¿ç”¨æŒ‡å®šçš„ä¸»æœº/ç«¯å£ä¸Šçš„mongodè¿è¡Œè„šæœ¬ï¼Œéœ€è¦å…ˆæŒ‡å®šåœ°å€ï¼Œç„¶åå†è·Ÿä¸Šè„šæœ¬æ–‡ä»¶çš„åç§°\nä¹Ÿå¯ä»¥ä½¿ç”¨load()å‡½æ•°ï¼Œä»äº¤äº’å¼shellä¸­è¿è¡Œè„šæœ¬ï¼š\nåœ¨è„šæœ¬ä¸­å¯ä»¥è®¿é—®dbå˜é‡ï¼Œä»¥åŠå…¶ä»–å…¨å±€å˜é‡ã€‚ç„¶è€Œï¼Œshellè¾…åŠ©å‡½æ•°ï¼ˆæ¯”å¦‚\u0026quot;usedb\u0026quot;å’Œ\u0026quot;show collections\u0026quot;ï¼‰ä¸å¯ä»¥åœ¨æ–‡ä»¶ä¸­ä½¿ç”¨ã€‚è¿™äº›è¾…åŠ©å‡½æ•°éƒ½æœ‰å¯¹åº”çš„JavaScriptå‡½æ•°\nç¼–è¾‘å¤åˆå˜é‡ shellçš„å¤šè¡Œæ”¯æŒæ˜¯éå¸¸æœ‰é™çš„ï¼šä¸å¯ä»¥ç¼–è¾‘ä¹‹å‰çš„è¡Œã€‚å¦‚æœç¼–è¾‘åˆ°ç¬¬15è¡Œæ—¶å‘ç°ç¬¬1è¡Œæœ‰ä¸ªé”™è¯¯ï¼Œé‚£ä¼šè®©äººéå¸¸æ‡Šæ¼ã€‚å› æ­¤ï¼Œå¯¹äºå¤§å—çš„ä»£ç æˆ–è€…æ˜¯å¯¹è±¡ï¼Œä½ å¯èƒ½æ›´æ„¿æ„åœ¨ç¼–è¾‘å™¨ä¸­ç¼–è¾‘ã€‚ä¸ºäº†æ–¹ä¾¿åœ°è°ƒç”¨ç¼–è¾‘å™¨ï¼Œå¯ä»¥åœ¨shellä¸­è®¾ç½®EDITORå˜é‡ï¼ˆä¹Ÿå¯ä»¥åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼‰ï¼š\nEDITOR = \u0026#34;/usr/bin/vim\u0026#34; ç°åœ¨ï¼Œå¦‚æœæƒ³è¦ç¼–è¾‘ä¸€ä¸ªå˜é‡ï¼Œå¯ä»¥ä½¿ç”¨\u0026quot;editå˜é‡å\u0026quot;è¿™ä¸ªå‘½ä»¤ï¼Œæ¯”å¦‚ï¼š\nç”¨æˆ·ä¸»ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º.mongorc.jsçš„æ–‡ä»¶,åœ¨.mongorc.jsæ–‡ä»¶ä¸­æ·»åŠ ä¸€è¡Œå†…å®¹ï¼ŒEDITOR=\u0026ldquo;ç¼–è¾‘å™¨è·¯å¾„\u0026rdquo;;ï¼Œä»¥åå°±ä¸å¿…å•ç‹¬è®¾ç½®EDITORå˜é‡äº†ã€‚\n","date":"2021-09-05T17:36:12Z","permalink":"https://dccmmtop.github.io/posts/mongo_shell%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C/","section":"posts","tags":null,"title":"Mongo_ShellåŸºç¡€æ“ä½œ"},{"categories":null,"contents":"æ–‡æ¡£æ˜¯MongoDBä¸­æ•°æ®çš„åŸºæœ¬å•å…ƒï¼Œéå¸¸ç±»ä¼¼äºå…³ç³»å‹æ•°æ®åº“ç®¡ç†ç³»ç»Ÿä¸­çš„è¡Œï¼Œä½†æ›´å…·è¡¨ç°åŠ›ã€‚\nç±»ä¼¼åœ°ï¼Œé›†åˆï¼ˆcollectionï¼‰å¯ä»¥çœ‹ä½œæ˜¯ä¸€ä¸ªæ‹¥æœ‰åŠ¨æ€æ¨¡å¼ï¼ˆdynamic schemaï¼‰çš„è¡¨ã€‚\nMongoDBçš„ä¸€ä¸ªå®ä¾‹å¯ä»¥æ‹¥æœ‰å¤šä¸ªç›¸äº’ç‹¬ç«‹çš„æ•°æ®åº“ï¼ˆdatabaseï¼‰ï¼Œæ¯ä¸€ä¸ªæ•°æ®åº“éƒ½æ‹¥æœ‰è‡ªå·±çš„é›†åˆã€‚\næ¯ä¸€ä¸ªæ–‡æ¡£éƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„é”®\u0026quot;_id\u0026quot;ï¼Œè¿™ä¸ªé”®åœ¨æ–‡æ¡£æ‰€å±çš„é›†åˆä¸­æ˜¯å”¯ä¸€çš„ã€‚\næ–‡æ¡£ MongoDBè€Œä¸”åŒºåˆ†å¤§å°å†™ï¼Œ\nä¸‹é¢ä¸¤ä¸ªæ–‡æ¡£æ˜¯ä¸åŒçš„\n{ \u0026#34;foo\u0026#34;: 3 } { \u0026#34;Foo\u0026#34;: 3 } æ–‡æ¡£ä¸­çš„é”®/å€¼å¯¹æ˜¯æœ‰åºçš„ï¼š{\u0026ldquo;x\u0026rdquo; : 1, \u0026ldquo;y\u0026rdquo;:2}ä¸{\u0026ldquo;y\u0026rdquo;: 2, \u0026ldquo;x\u0026rdquo;: 1}æ˜¯ä¸åŒçš„ã€‚\né€šå¸¸ï¼Œå­—æ®µé¡ºåºå¹¶ä¸é‡è¦ï¼Œæ— é¡»è®©æ•°æ®åº“æ¨¡å¼ä¾èµ–ç‰¹å®šçš„å­—æ®µé¡ºåºï¼ˆMongoDBä¼šå¯¹å­—æ®µé‡æ–°æ’åºï¼‰ã€‚åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå­—æ®µé¡ºåºå˜å¾—éå¸¸é‡è¦ï¼Œ\né›†åˆ æ–‡æ¡£ä¸­çš„é”®/å€¼å¯¹æ˜¯æœ‰åºçš„ï¼š{\u0026ldquo;x\u0026rdquo; : 1, \u0026ldquo;y\u0026rdquo;:2}ä¸{\u0026ldquo;y\u0026rdquo;: 2, \u0026ldquo;x\u0026rdquo;: 1}æ˜¯ä¸åŒçš„ã€‚é€šå¸¸ï¼Œå­—æ®µé¡ºåºå¹¶ä¸é‡è¦ï¼Œæ— é¡»è®©æ•°æ®åº“æ¨¡å¼ä¾èµ–ç‰¹å®šçš„å­—æ®µé¡ºåºï¼ˆMongoDBä¼šå¯¹å­—æ®µé‡æ–°æ’åºï¼‰ã€‚åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œå­—æ®µé¡ºåºå˜å¾—éå¸¸é‡è¦ï¼Œ\né›†åˆæ˜¯åŠ¨æ€æ¨¡å¼çš„ã€‚è¿™æ„å‘³ç€ä¸€ä¸ªé›†åˆé‡Œé¢çš„æ–‡æ¡£å¯ä»¥æ˜¯å„å¼å„æ ·çš„\nå‘½å å¯ä»¥ä½¿ç”¨db.collectionNameè·å–ä¸€ä¸ªé›†åˆçš„å†…å®¹ï¼Œä½†æ˜¯ï¼Œå¦‚æœé›†åˆåç§°ä¸­åŒ…å«ä¿ç•™å­—æˆ–è€…æ— æ•ˆçš„JavaScriptå±æ€§åç§°ï¼Œdb.collectionNameå°±ä¸èƒ½æ­£å¸¸å·¥ä½œäº†ã€‚\nå‡è®¾è¦è®¿é—®versioné›†åˆï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨db.versionï¼Œå› ä¸ºdb.versionæ˜¯dbçš„ä¸€ä¸ªæ–¹æ³•ï¼ˆä¼šè¿”å›å½“å‰MongoDBæœåŠ¡å™¨çš„ç‰ˆæœ¬ï¼‰ï¼š\nåœ¨JavaScriptä¸­ï¼Œx.yç­‰åŒäºx[\u0026lsquo;y\u0026rsquo;]ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé™¤äº†åç§°çš„å­—é¢é‡ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å˜é‡è®¿é—®å­é›†åˆã€‚å› æ­¤ï¼Œå¦‚æœéœ€è¦å¯¹blogçš„æ¯ä¸€ä¸ªå­é›†åˆè¿›è¡Œæ“ä½œï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼è¿›è¡Œè¿­ä»£\nç›¸åŒæ•°æ®ç»“æ„å½’ä¸ºä¸€ä¸ªæ–‡æ¡£ å¦‚æœæŠŠå„ç§å„æ ·çš„æ–‡æ¡£ä¸åŠ åŒºåˆ†åœ°æ”¾åœ¨åŒä¸€ä¸ªé›†åˆé‡Œï¼Œæ— è®ºå¯¹å¼€å‘è€…è¿˜æ˜¯å¯¹ç®¡ç†å‘˜æ¥è¯´éƒ½å°†æ˜¯å™©æ¢¦ã€‚\nåœ¨ä¸€ä¸ªé›†åˆé‡ŒæŸ¥è¯¢ç‰¹å®šç±»å‹çš„æ–‡æ¡£åœ¨é€Ÿåº¦ä¸Šä¹Ÿå¾ˆä¸åˆ’ç®—ï¼Œåˆ†å¼€æŸ¥è¯¢å¤šä¸ªé›†åˆè¦å¿«å¾—å¤šã€‚\næŠŠåŒç§ç±»å‹çš„æ–‡æ¡£æ”¾åœ¨ä¸€ä¸ªé›†åˆé‡Œï¼Œæ•°æ®ä¼šæ›´åŠ é›†ä¸­\nåˆ›å»ºç´¢å¼•æ—¶ï¼Œéœ€è¦ä½¿ç”¨æ–‡æ¡£çš„é™„åŠ ç»“æ„ï¼ˆç‰¹åˆ«æ˜¯åˆ›å»ºå”¯ä¸€ç´¢å¼•æ—¶ï¼‰ã€‚ç´¢å¼•æ˜¯æŒ‰ç…§é›†åˆæ¥å®šä¹‰çš„ã€‚åœ¨ä¸€ä¸ªé›†åˆä¸­åªæ”¾å…¥ä¸€ç§ç±»å‹çš„æ–‡æ¡£ï¼Œå¯ä»¥æ›´æœ‰æ•ˆåœ°å¯¹é›†åˆè¿›è¡Œç´¢å¼•ã€‚\nå‘½å é›†åˆåä¸èƒ½ä»¥â€œsystem.â€å¼€å¤´ï¼Œè¿™æ˜¯ä¸ºç³»ç»Ÿé›†åˆä¿ç•™çš„å‰ç¼€ã€‚ä¾‹å¦‚ï¼Œsystem.usersè¿™ä¸ªé›†åˆä¿å­˜ç€æ•°æ®åº“çš„ç”¨æˆ·ä¿¡æ¯ï¼Œè€Œsystem.namespacesé›†åˆä¿å­˜ç€æ‰€æœ‰æ•°æ®åº“é›†åˆçš„ä¿¡æ¯ã€‚ ç”¨æˆ·åˆ›å»ºçš„é›†åˆä¸èƒ½åœ¨é›†åˆåä¸­åŒ…å«ä¿ç•™å­—ç¬¦â€™$\u0026rsquo;ã€‚å› ä¸ºæŸäº›ç³»ç»Ÿç”Ÿæˆçš„é›†åˆä¸­åŒ…å«$ï¼Œå¾ˆå¤šé©±åŠ¨ç¨‹åºç¡®å®æ”¯æŒåœ¨é›†åˆåé‡ŒåŒ…å«è¯¥å­—ç¬¦ã€‚é™¤éä½ è¦è®¿é—®è¿™ç§ç³»ç»Ÿåˆ›å»ºçš„é›†åˆï¼Œå¦åˆ™ä¸åº”è¯¥åœ¨é›†åˆåä¸­åŒ…å«$ã€‚ å­é›†åˆ ç»„ç»‡é›†åˆçš„ä¸€ç§æƒ¯ä¾‹æ˜¯ä½¿ç”¨â€œ.â€åˆ†éš”ä¸åŒå‘½åç©ºé—´çš„å­é›†åˆã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå…·æœ‰åšå®¢åŠŸèƒ½çš„åº”ç”¨å¯èƒ½åŒ…å«ä¸¤ä¸ªé›†åˆï¼Œåˆ†åˆ«æ˜¯blog.postså’Œblog.authors\næ•°æ®åº“ æ®åº“æœ€ç»ˆä¼šå˜æˆæ–‡ä»¶ç³»ç»Ÿé‡Œçš„æ–‡ä»¶ï¼Œè€Œæ•°æ®åº“åå°±æ˜¯ç›¸åº”çš„æ–‡ä»¶åï¼Œè¿™æ˜¯æ•°æ®åº“åæœ‰å¦‚æ­¤å¤šé™åˆ¶çš„åŸå› ã€‚\nå¦å¤–ï¼Œæœ‰ä¸€äº›æ•°æ®åº“åæ˜¯ä¿ç•™çš„ï¼Œå¯ä»¥ç›´æ¥è®¿é—®è¿™äº›æœ‰ç‰¹æ®Šè¯­ä¹‰çš„æ•°æ®åº“ã€‚è¿™äº›æ•°æ®åº“å¦‚ä¸‹æ‰€ç¤ºã€‚ Â· adminä»èº«ä»½éªŒè¯çš„è§’åº¦æ¥è®²ï¼Œè¿™æ˜¯â€œrootâ€æ•°æ®åº“ã€‚å¦‚æœå°†ä¸€ä¸ªç”¨æˆ·æ·»åŠ åˆ°adminæ•°æ®åº“ï¼Œè¿™ä¸ªç”¨æˆ·å°†è‡ªåŠ¨è·å¾—æ‰€æœ‰æ•°æ®åº“çš„æƒé™ã€‚å†è€…ï¼Œä¸€äº›ç‰¹å®šçš„æœåŠ¡å™¨ç«¯å‘½ä»¤ä¹Ÿåªèƒ½ä»adminæ•°æ®åº“è¿è¡Œï¼Œå¦‚åˆ—å‡ºæ‰€æœ‰æ•°æ®åº“æˆ–å…³é—­æœåŠ¡å™¨ã€‚ localè¿™ä¸ªæ•°æ®åº“æ°¸è¿œéƒ½ä¸å¯ä»¥å¤åˆ¶ï¼Œä¸”ä¸€å°æœåŠ¡å™¨ä¸Šçš„æ‰€æœ‰æœ¬åœ°é›†åˆéƒ½å¯ä»¥å­˜å‚¨åœ¨è¿™ä¸ªæ•°æ®åº“ä¸­ config MongoDBç”¨äºåˆ†ç‰‡è®¾ç½®æ—¶ï¼Œåˆ†ç‰‡ä¿¡æ¯ä¼šå­˜å‚¨åœ¨configæ•°æ®åº“ä¸­ã€‚ å¯åŠ¨MongoDB é€šå¸¸ï¼ŒMongoDBä½œä¸ºç½‘ç»œæœåŠ¡å™¨æ¥è¿è¡Œï¼Œå®¢æˆ·ç«¯å¯è¿æ¥åˆ°è¯¥æœåŠ¡å™¨å¹¶æ‰§è¡Œæ“ä½œã€‚ä¸‹è½½MongoDBï¼ˆhttp://www.mongodb.org/downloadsï¼‰å¹¶è§£å‹ï¼Œè¿è¡Œmongodå‘½ä»¤ï¼Œå¯åŠ¨æ•°æ®åº“æœåŠ¡å™¨\nmongodåœ¨æ²¡æœ‰å‚æ•°çš„æƒ…å†µä¸‹ä¼šä½¿ç”¨é»˜è®¤æ•°æ®ç›®å½•/data/dbï¼ˆWindowsç³»ç»Ÿä¸­ä¸ºC:\\data\\dbï¼‰ é»˜è®¤æƒ…å†µä¸‹ï¼ŒMongoDBç›‘å¬27017ç«¯å£ mongodè¿˜ä¼šå¯åŠ¨ä¸€ä¸ªéå¸¸åŸºæœ¬çš„HTTPæœåŠ¡å™¨ï¼Œç›‘å¬æ•°å­—æ¯”ä¸»ç«¯å£å·é«˜1000çš„ç«¯å£ï¼Œä¹Ÿå°±æ˜¯28017ç«¯å£ã€‚è¿™æ„å‘³ç€ï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®http://localhost:28017ï¼Œèƒ½è·å–æ•°æ®åº“çš„ç®¡ç†ä¿¡æ¯ shellä¸­çš„åŸºæœ¬æ“ä½œ è¦æŸ¥çœ‹dbå½“å‰æŒ‡å‘å“ªä¸ªæ•°æ®åº“ï¼Œå¯ä»¥ä½¿ç”¨dbå‘½ä»¤\né€‰æ‹©æ•°æ®åº“ use\nè¯»å– findå’ŒfindOneæ–¹æ³•å¯ä»¥ç”¨äºæŸ¥è¯¢é›†åˆé‡Œçš„æ–‡æ¡£ã€‚è‹¥åªæƒ³æŸ¥çœ‹ä¸€ä¸ªæ–‡æ¡£ï¼Œå¯ç”¨findOneï¼š\nfindå’ŒfindOneå¯ä»¥æ¥å—ä¸€ä¸ªæŸ¥è¯¢æ–‡æ¡£ä½œä¸ºé™å®šæ¡ä»¶ã€‚è¿™æ ·å°±å¯ä»¥æŸ¥è¯¢ç¬¦åˆä¸€å®šæ¡ä»¶çš„æ–‡æ¡£ã€‚ä½¿ç”¨findæ—¶ï¼Œshellä¼šè‡ªåŠ¨æ˜¾ç¤ºæœ€å¤š20ä¸ªåŒ¹é…çš„æ–‡æ¡£ï¼Œä¹Ÿå¯è·å–æ›´å¤šæ–‡æ¡£\næ›´æ–° ä½¿ç”¨updateä¿®æ”¹åšå®¢æ–‡ç« ã€‚updateæ¥å—ï¼ˆè‡³å°‘ï¼‰ä¸¤ä¸ªå‚æ•°ï¼šç¬¬ä¸€ä¸ªæ˜¯é™å®šæ¡ä»¶ï¼ˆç”¨äºåŒ¹é…å¾…æ›´æ–°çš„æ–‡æ¡£ï¼‰ï¼Œç¬¬äºŒä¸ªæ˜¯æ–°çš„æ–‡æ¡£\nä¾‹å­:\nä¿®æ”¹å˜é‡postï¼Œå¢åŠ \u0026quot;comments\u0026quot;é”®ï¼š\npost.comment = [] db.blog.update({title: \u0026#34;my blog\u0026#34;},post) åˆ é™¤ ä½¿ç”¨removeæ–¹æ³•å¯å°†æ–‡æ¡£ä»æ•°æ®åº“ä¸­æ°¸ä¹…åˆ é™¤ã€‚å¦‚æœæ²¡æœ‰ä½¿ç”¨ä»»ä½•å‚æ•°ï¼Œå®ƒä¼šå°†é›†åˆå†…çš„æ‰€æœ‰æ–‡æ¡£å…¨éƒ¨åˆ é™¤ã€‚å®ƒå¯ä»¥æ¥å—ä¸€ä¸ªä½œä¸ºé™å®šæ¡ä»¶çš„æ–‡æ¡£ä½œä¸ºå‚æ•°\n","date":"2021-09-05T16:47:25Z","permalink":"https://dccmmtop.github.io/posts/mongodb%E5%9F%BA%E7%A1%80/","section":"posts","tags":["mongoDB"],"title":"MongoDBåŸºç¡€"},{"categories":null,"contents":"Go çš„åŒ…ç®¡ç†æ–¹å¼æ˜¯é€æ¸æ¼”è¿›çš„ï¼Œ æœ€åˆæ˜¯ monorepo æ¨¡å¼ï¼Œæ‰€æœ‰çš„åŒ…éƒ½æ”¾åœ¨ GOPATH é‡Œé¢ï¼Œä½¿ç”¨ç±»ä¼¼å‘½åç©ºé—´çš„åŒ…è·¯å¾„åŒºåˆ†åŒ…ï¼Œä¸è¿‡è¿™ç§åŒ…ç®¡ç†æ˜¾ç„¶æ˜¯æœ‰é—®é¢˜ï¼Œç”±äºåŒ…ä¾èµ–å¯èƒ½ä¼šå¼•å…¥ç ´åæ€§æ›´æ–°ï¼Œç”Ÿäº§ç¯å¢ƒå’Œæµ‹è¯•ç¯å¢ƒä¼šå‡ºç°è¿è¡Œä¸ä¸€è‡´çš„é—®é¢˜ã€‚\nä» v1.5 å¼€å§‹å¼€å§‹å¼•å…¥ vendor åŒ…æ¨¡å¼ï¼Œå¦‚æœé¡¹ç›®ç›®å½•ä¸‹æœ‰ vendor ç›®å½•ï¼Œé‚£ä¹ˆ go å·¥å…·é“¾ä¼šä¼˜å…ˆä½¿ç”¨ vendor å†…çš„åŒ…è¿›è¡Œç¼–è¯‘ã€æµ‹è¯•ç­‰ï¼Œè¿™ä¹‹åç¬¬ä¸‰æ–¹çš„åŒ…ç®¡ç†æ€è·¯éƒ½æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥å®ç°ï¼Œæ¯”å¦‚è¯´ç”±ç¤¾åŒºç»´æŠ¤å‡†å®˜æ–¹åŒ…ç®¡ç†å·¥å…· depã€‚\nä¸è¿‡å®˜æ–¹å¹¶ä¸è®¤åŒè¿™ç§æ–¹å¼ï¼Œåœ¨ v1.11 ä¸­åŠ å…¥äº† Go Module ä½œä¸ºå®˜æ–¹åŒ…ç®¡ç†å½¢å¼ï¼Œå°±è¿™æ · dep æ— å¥ˆçš„ç»“æŸäº†ä½¿å‘½ã€‚æœ€åˆçš„ Go Module ææ¡ˆçš„åç§°å«åš vgoï¼Œä¸‹é¢ä¸ºäº†ä»‹ç»ç®€ç§°ä¸º gomodã€‚ä¸è¿‡åœ¨ v1.11 å’Œ v1.12 çš„ Go ç‰ˆæœ¬ä¸­ gomod æ˜¯ä¸èƒ½ç›´æ¥ä½¿ç”¨çš„ã€‚å¯ä»¥é€šè¿‡ go env å‘½ä»¤è¿”å›å€¼çš„ GOMOD å­—æ®µæ˜¯å¦ä¸ºç©ºæ¥åˆ¤æ–­æ˜¯å¦å·²ç»å¼€å¯äº† gomodï¼Œå¦‚æœæ²¡æœ‰å¼€å¯ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ export GO111MODULE=on å¼€å¯ã€‚\nç›®å‰ gomod åœ¨ Go v1.12 åŠŸèƒ½åŸºæœ¬ç¨³å®šï¼Œåˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬ v1.13 å°†é»˜è®¤å¼€å¯ï¼Œæ˜¯æ—¶å€™å¼€å§‹åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ gomod äº†ã€‚\nHello,World\nGo ç»´æŠ¤è€… Russ Cox å†™ä¸€ä¸ªç®€å•çš„åº“ï¼Œç”¨äºè¯´æ˜ gomod çš„ä½¿ç”¨ï¼Œä¸‹æ–‡æˆ‘å°†ä½¿ç”¨è¿™ä¸ªåº“å¼€å§‹ä»‹ç»ã€‚\né¦–å…ˆåœ¨ä¸ªäººåŒ…å‘½åç©ºé—´ç›®å½•æ–°å»ºä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œç„¶åç›´æ¥ä½¿ç”¨ go mod init å³å¯ã€‚\nmkdir $GOPATH/github.com/islishude/gomodtest cd $GOPATH/github.com/islishude/gomodtest go mod init æ›´æ–°ï¼šç°åœ¨ä¸å…è®¸åœ¨ GOPATH ä¸‹ä½¿ç”¨ gomodï¼Œéœ€è¦æ›´æ”¹æˆä»¥ä¸‹å‘½ä»¤ï¼š\nmkdir -p ~/gopher/gomodtest cd ~/gopher/gomodtest go mod init github.com/islishude/gomodtest è¿™æ—¶å¯çœ‹åˆ°ç›®å½•å†…å¤šäº† go.mod æ–‡ä»¶ï¼Œå†…å®¹å¾ˆç®€å•åªæœ‰ä¸¤è¡Œï¼š\nmodule github.com/islishude/gomodtest\ngo 1.12\né¦–è¡Œä¸ºå½“å‰çš„æ¨¡å—åç§°ï¼Œæ¥ä¸‹æ¥æ˜¯ go çš„ä½¿ç”¨ç‰ˆæœ¬ã€‚è¿™ä¸¤è¡Œå’Œ npm package.json çš„ name å’Œ engine å­—æ®µçš„åŠŸèƒ½å¾ˆç±»ä¼¼ã€‚\nç„¶åæ–°å»ºä¸€ä¸ª main.go å†™å…¥ä»¥ä¸‹å†…å®¹ï¼Œè¿™é‡Œæˆ‘ä»¬å¼•ç”¨äº† rsc.io/quote åŒ…ï¼Œæ³¨æ„æˆ‘ä»¬ç°åœ¨è¿˜æ²¡æœ‰ä¸‹è½½è¿™ä¸ªåŒ…ã€‚\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;rsc.io/quote\u0026#34; ) func main() { fmt.Println(quote.Hello()) } å¦‚æœæ˜¯é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ go run main.go è‚¯å®šä¼šæç¤ºæ‰¾ä¸åˆ°è¿™ä¸ªåŒ…çš„é”™è¯¯ï¼Œä½†æ˜¯å½“å‰ gomod æ¨¡å¼ï¼Œå¦‚æœæ²¡æœ‰æ­¤ä¾èµ–å›å…ˆä¸‹è½½è¿™ä¸ªä¾èµ–ã€‚\n$ go run main.go go: finding rsc.io/quote v1.5.2 go: finding rsc.io/sampler v1.3.0 go: finding golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c go: downloading rsc.io/quote v1.5.2 go: extracting rsc.io/quote v1.5.2 go: downloading rsc.io/sampler v1.3.0 go: extracting rsc.io/sampler v1.3.0 go: downloading golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c go: extracting golang.org/x/text v0.0.0-20170915032832-14c0d48ead0c Hello, world. å› ä¸ºåŒ…å« http://golang.org ä¸‹çš„åŒ…ï¼Œè®°å¾—è®¾ç½®ä»£ç†ã€‚è¿™ä¸ªæ—¶å€™å½“å‰åŒ…ç›®å½•é™¤äº† go.mod è¿˜æœ‰ä¸€ä¸ª go.sum çš„æ–‡ä»¶ï¼Œè¿™ä¸ªç±»ä¼¼ npm package-lock.jsonã€‚\ngomod ä¸ä¼šåœ¨ $GOPATH/src ç›®å½•ä¸‹ä¿å­˜ rsc.io åŒ…çš„æºç ï¼Œè€Œæ˜¯åŒ…æºç å’Œé“¾æ¥åº“ä¿å­˜åœ¨ $GOPATH/pkg/mod ç›®å½•ä¸‹ã€‚\n$ ls $GOPATH/pkg/mod cache golang.org rsc.io é™¤äº† go run å‘½ä»¤ä»¥å¤–ï¼Œgo buildã€go test ç­‰å‘½ä»¤ä¹Ÿèƒ½è‡ªåŠ¨ä¸‹è½½ç›¸å…³ä¾èµ–åŒ…ã€‚\nåŒ…ç®¡ç†å‘½ä»¤\nå½“ç„¶æˆ‘ä»¬å¹³å¸¸éƒ½ä¸ä¼šç›´æ¥å…ˆå†™ä»£ç ï¼Œå†™ä¸Šå¼•å…¥çš„ä¾èµ–åç§°å’Œè·¯å¾„ï¼Œç„¶ååœ¨ build çš„æ—¶å€™åœ¨ä¸‹è½½ã€‚\nå®‰è£…ä¾èµ– å¦‚æœè¦æƒ³å…ˆä¸‹è½½ä¾èµ–ï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥åƒä»¥å‰é‚£æ · go get å³å¯ï¼Œä¸è¿‡ gomod ä¸‹å¯ä»¥è·Ÿè¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼Œæ¯”å¦‚ go get foo@v1.2.3ï¼Œä¹Ÿå¯ä»¥è·Ÿ git çš„åˆ†æ”¯æˆ– tagï¼Œæ¯”å¦‚go get foo@masterï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è·Ÿ git æäº¤å“ˆå¸Œï¼Œæ¯”å¦‚ go get foo@e3702bed2ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œgomod é™¤äº†éµå¾ªè¯­ä¹‰åŒ–ç‰ˆæœ¬åŸåˆ™å¤–ï¼Œè¿˜éµå¾ªæœ€å°ç‰ˆæœ¬é€‰æ‹©åŸåˆ™ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå½“å‰ç‰ˆæœ¬æ˜¯ v1.1.0ï¼Œåªä¼šä¸‹è½½ä¸è¶…è¿‡è¿™ä¸ªæœ€å¤§ç‰ˆæœ¬å·ã€‚å¦‚æœä½¿ç”¨ go get foo@masterï¼Œä¸‹æ¬¡åœ¨ä¸‹è½½åªä¼šå’Œç¬¬ä¸€æ¬¡çš„ä¸€æ ·ï¼Œæ— è®º master åˆ†æ”¯æ˜¯å¦æ›´æ–°äº†ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œä½¿ç”¨åŒ…å«å½“å‰æœ€æ–°æäº¤å“ˆå¸Œçš„è™šæ‹Ÿç‰ˆæœ¬å·æ›¿ä»£ç›´æ¥çš„ master ç‰ˆæœ¬å·ã€‚\n$ go get golang.org/x/crypto/sha3@master go: finding golang.org/x/crypto/sha3 latest go: finding golang.org/x/crypto latest $ cat go.mod module github.com/adesight/test go 1.12 require ( golang.org/x/crypto v0.0.0-20190313024323-a1f597ede03a // indirect rsc.io/quote v1.5.2 ) å¦‚æœä¸‹è½½æ‰€æœ‰ä¾èµ–å¯ä»¥ä½¿ç”¨ go mod download å‘½ä»¤ã€‚\nå‡çº§ä¾èµ– æŸ¥çœ‹æ‰€æœ‰ä»¥å‡çº§ä¾èµ–ç‰ˆæœ¬ï¼š\n$ go list -u -m all go: finding golang.org/x/sys latest go: finding golang.org/x/crypto latest github.com/adesight/test golang.org/x/crypto v0.0.0-20190313024323-a1f597ede03a golang.org/x/sys v0.0.0-20190215142949-d0b11bdaac8a [v0.0.0-20190316082340-a2f829d7f35f] golang.org/x/text v0.3.0 rsc.io/quote v1.5.2 rsc.io/sampler v1.99.99 ###å‡çº§æ¬¡çº§æˆ–è¡¥ä¸ç‰ˆæœ¬å·ï¼š\ngo get -u rsc.io/quote ä»…å‡çº§è¡¥ä¸ç‰ˆæœ¬å·ï¼š go get -u=patch rscio/quote å‡é™çº§ç‰ˆæœ¬å·ï¼Œå¯ä»¥ä½¿ç”¨æ¯”è¾ƒè¿ç®—ç¬¦æ§åˆ¶ï¼š\ngo get foo@\u0026#39;\u0026lt;v1.6.2\u0026#39; ç§»é™¤ä¾èµ– å½“å‰ä»£ç ä¸­ä¸éœ€è¦äº†æŸäº›åŒ…ï¼Œåˆ é™¤ç›¸å…³ä»£ç ç‰‡æ®µåå¹¶æ²¡æœ‰åœ¨ go.mod æ–‡ä»¶ä¸­è‡ªåŠ¨ç§»å‡ºã€‚\nè¿è¡Œä¸‹é¢å‘½ä»¤å¯ä»¥ç§»å‡ºæ‰€æœ‰ä»£ç ä¸­ä¸éœ€è¦çš„åŒ…ï¼š\ngo mod tidy å¦‚æœä»…ä»…ä¿®æ”¹ go.mod é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œé‚£ä¹ˆå¯ä»¥è¿è¡Œ go mod edit --droprequire=pathï¼Œæ¯”å¦‚è¦ç§»å‡º golang.org/x/crypto åŒ…\ngo mod edit --droprequire=golang.org/x/crypto\næŸ¥çœ‹ä¾èµ–åŒ… å¯ä»¥ç›´æ¥æŸ¥çœ‹ go.mod æ–‡ä»¶ï¼Œæˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œï¼š\n$ go list -m all github.com/adesight/test golang.org/x/crypto v0.0.0-20190313024323-a1f597ede03a golang.org/x/sys v0.0.0-20190215142949-d0b11bdaac8a golang.org/x/text v0.3.0 rsc.io/quote v1.5.2 rsc.io/sampler v1.99.99 $ go list -m -json all # json æ ¼å¼è¾“å‡º { \u0026#34;Path\u0026#34;: \u0026#34;golang.org/x/text\u0026#34;, \u0026#34;Version\u0026#34;: \u0026#34;v0.3.0\u0026#34;, \u0026#34;Time\u0026#34;: \u0026#34;2017-12-14T13:08:43Z\u0026#34;, \u0026#34;Indirect\u0026#34;: true, \u0026#34;Dir\u0026#34;: \u0026#34;/Users/lishude/go/pkg/mod/golang.org/x/text@v0.3.0\u0026#34;, \u0026#34;GoMod\u0026#34;: \u0026#34;/Users/lishude/go/pkg/mod/cache/download/golang.org/x/text/@v/v0.3.0.mod\u0026#34; } { \u0026#34;Path\u0026#34;: \u0026#34;rsc.io/quote\u0026#34;, \u0026#34;Version\u0026#34;: \u0026#34;v1.5.2\u0026#34;, \u0026#34;Time\u0026#34;: \u0026#34;2018-02-14T15:44:20Z\u0026#34;, \u0026#34;Dir\u0026#34;: \u0026#34;/Users/lishude/go/pkg/mod/rsc.io/quote@v1.5.2\u0026#34;, \u0026#34;GoMod\u0026#34;: \u0026#34;/Users/lishude/go/pkg/mod/cache/download/rsc.io/quote/@v/v1.5.2.mod\u0026#34; } æ¨¡å—é…ç½®æ–‡æœ¬æ ¼å¼åŒ– ç”±äºå¯æ‰‹åŠ¨ä¿®æ”¹ go.mod æ–‡ä»¶ï¼Œæ‰€ä»¥å¯èƒ½æ­¤æ–‡ä»¶å¹¶æ²¡æœ‰è¢«æ ¼å¼åŒ–ï¼Œä½¿ç”¨ä¸‹é¢å‘½ä»¤è¿›è¡Œæ–‡æœ¬æ ¼å¼åŒ–ã€‚\ngo mod edit -fmt å‘å¸ƒç‰ˆæœ¬ å‘å¸ƒåŒ…æ–°ç‰ˆæœ¬å’Œå…¶å®ƒåŒ…ç®¡ç†å·¥å…·åŸºæœ¬ä¸€è‡´ï¼Œå¯ä»¥ç›´æ¥æ‰“æ ‡ç­¾ï¼Œä¸è¿‡æ‰“æ ‡ç­¾ä¹‹å‰éœ€è¦åœ¨ go.mod ä¸­å†™å…¥ç›¸åº”çš„ç‰ˆæœ¬å·ï¼š\n$ go mod edit --module=github.com/islishude/gomodtest/v2 $ cat go.mod module github.com/islishude/gomodtest/v2 go 1.12 require ( golang.org/x/crypto v0.0.0-20190313024323-a1f597ede03a // indirect rsc.io/quote v1.5.2 ) å®˜æ–¹æ¨èå°†ä¸Šè¿°è¿‡ç¨‹åœ¨ä¸€ä¸ªæ–°åˆ†æ”¯æ¥é¿å…æ··æ·†ï¼Œé‚£ä¹ˆç±»å¦‚ä¸Šè¿°ä¾‹å­å¯ä»¥åˆ›å»ºä¸€ä¸ª v2 åˆ†æ”¯ï¼Œä½†è¿™ä¸ªä¸æ˜¯å¼ºåˆ¶è¦æ±‚çš„ã€‚\nè¿˜æœ‰ä¸€ç§æ–¹å¼å‘å¸ƒæ–°ç‰ˆæœ¬ï¼Œé‚£å°±æ˜¯åœ¨ä¸»çº¿ç‰ˆæœ¬ç§åŠ å…¥ v2 æ–‡ä»¶å¤¹ï¼Œç›¸åº”çš„ä¹Ÿéœ€è¦å†…ç½® go.mod è¿™ä¸ªæ–‡ä»¶ã€‚\nä»è€é¡¹ç›®è¿ç§» ä»å¾ˆå¤šç¬¬ä¸‰æ–¹çš„åŒ…ç®¡ç†å·¥å…·è¿ç§»åˆ° gomod ç‰¹åˆ«ç®€å•ï¼Œç›´æ¥è¿è¡Œ go mod init å³å¯ã€‚\nå¦‚æœæ²¡æœ‰ä½¿ç”¨ä»»ä½•ç¬¬ä¸‰æ–¹åŒ…ç®¡ç†å·¥å…·ï¼Œé™¤äº†è¿è¡Œ go mod init åˆå§‹åŒ–ä»¥å¤–ï¼Œè¿˜è¦ä½¿ç”¨ go get ./\u0026hellip; ä¸‹è½½å®‰è£…æ‰€æœ‰ä¾èµ–åŒ…ï¼Œå¹¶æ›´æ–° go.mod å’Œ go.sum æ–‡ä»¶ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼Œgo get å‘½ä»¤ä½¿ç”¨ @latest ç‰ˆæœ¬æ§åˆ¶ç¬¦å¯¹æ‰€æœ‰ä¾èµ–è¿›è¡Œä¸‹è½½ï¼Œå¦‚æœæƒ³è¦æ›´æ”¹æŸä¸€ä¸ªåŒ…çš„ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ go mod edit \u0026ndash;require å‘½ä»¤ï¼Œæ¯”å¦‚è¦æ›´æ–° rsc.io/quote åˆ° v3.1.0 ç‰ˆæœ¬ã€‚\ngo mod edit --require=rsc.io/quote@v3.1.0 ","date":"2021-08-18T16:23:14Z","permalink":"https://dccmmtop.github.io/posts/go_mod%E7%9A%84%E4%BD%BF%E7%94%A8/","section":"posts","tags":["go"],"title":"go_modçš„ä½¿ç”¨"},{"categories":null,"contents":"count(1) and count(*) **å½“è¡¨çš„æ•°æ®é‡å¤§äº›æ—¶ï¼Œå¯¹è¡¨ä½œåˆ†æä¹‹åï¼Œä½¿ç”¨count(1)è¿˜è¦æ¯”ä½¿ç”¨count(*)ç”¨æ—¶å¤šäº†ï¼ **\nä»æ‰§è¡Œè®¡åˆ’æ¥çœ‹ï¼Œcount(1)å’Œcount()çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚ ä½†æ˜¯åœ¨è¡¨åšè¿‡åˆ†æä¹‹åï¼Œcount(1)ä¼šæ¯”count()çš„ç”¨æ—¶å°‘äº›ï¼ˆ1wä»¥å†…æ•°æ®é‡ï¼‰ï¼Œä¸è¿‡å·®ä¸äº†å¤šå°‘ã€‚\nå¦‚æœcount(1)æ˜¯èšç´¢å¼•,id,é‚£è‚¯å®šæ˜¯count(1)å¿«ã€‚ä½†æ˜¯å·®çš„å¾ˆå°çš„ã€‚\nå› ä¸ºcount(),è‡ªåŠ¨ä¼šä¼˜åŒ–æŒ‡å®šåˆ°é‚£ä¸€ä¸ªå­—æ®µã€‚æ‰€ä»¥æ²¡å¿…è¦å»count(1)ï¼Œç”¨count()ï¼Œsqlä¼šå¸®ä½ å®Œæˆä¼˜åŒ–çš„ å› æ­¤ï¼š count(1)å’Œcount(*)åŸºæœ¬æ²¡æœ‰å·®åˆ«ï¼\ncount(1) and count(å­—æ®µ) ä¸¤è€…çš„ä¸»è¦åŒºåˆ«æ˜¯\nï¼ˆ1ï¼‰ count(1) ä¼šç»Ÿè®¡è¡¨ä¸­çš„æ‰€æœ‰çš„è®°å½•æ•°ï¼Œ åŒ…å«å­—æ®µä¸ºnull çš„è®°å½•ã€‚\nï¼ˆ2ï¼‰ count(å­—æ®µ) ä¼šç»Ÿè®¡è¯¥å­—æ®µåœ¨è¡¨ä¸­å‡ºç°çš„æ¬¡æ•°ï¼Œå¿½ç•¥å­—æ®µä¸ºnull çš„æƒ…å†µã€‚å³ ä¸ç»Ÿè®¡å­—æ®µä¸ºnull çš„è®°å½•ã€‚\ncount(*) å’Œ count(1)å’Œcount(åˆ—å)åŒºåˆ«\næ‰§è¡Œæ•ˆæœä¸Š\ncount(*)åŒ…æ‹¬äº†æ‰€æœ‰çš„åˆ—ï¼Œç›¸å½“äºè¡Œæ•°ï¼Œåœ¨ç»Ÿè®¡ç»“æœçš„æ—¶å€™ï¼Œ ä¸ä¼šå¿½ç•¥åˆ—å€¼ä¸ºNULL\ncount(1)åŒ…æ‹¬äº†å¿½ç•¥æ‰€æœ‰åˆ—ï¼Œç”¨1ä»£è¡¨ä»£ç è¡Œï¼Œåœ¨ç»Ÿè®¡ç»“æœçš„æ—¶å€™ï¼Œ ä¸ä¼šå¿½ç•¥åˆ—å€¼ä¸ºNULL\ncount(åˆ—å)åªåŒ…æ‹¬åˆ—åé‚£ä¸€åˆ—ï¼Œåœ¨ç»Ÿè®¡ç»“æœçš„æ—¶å€™ï¼Œä¼šå¿½ç•¥åˆ—å€¼ä¸ºç©ºï¼ˆè¿™é‡Œçš„ç©ºä¸æ˜¯åªç©ºå­—ç¬¦ä¸²æˆ–è€…0ï¼Œè€Œæ˜¯è¡¨ç¤ºnullï¼‰çš„è®¡æ•°ï¼Œ å³æŸä¸ªå­—æ®µå€¼ä¸ºNULLæ—¶ï¼Œä¸ç»Ÿè®¡ã€‚\næ‰§è¡Œæ•ˆç‡ä¸Š\nåˆ—åä¸ºä¸»é”®ï¼Œcount(åˆ—å)ä¼šæ¯”count(1)å¿«\nåˆ—åä¸ä¸ºä¸»é”®ï¼Œcount(1)ä¼šæ¯”count(åˆ—å)å¿«\nå¦‚æœè¡¨å¤šä¸ªåˆ—å¹¶ä¸”æ²¡æœ‰ä¸»é”®ï¼Œåˆ™ countï¼ˆ1ï¼‰ çš„æ‰§è¡Œæ•ˆç‡ä¼˜äº countï¼ˆï¼‰\nå¦‚æœæœ‰ä¸»é”®ï¼Œåˆ™ select countï¼ˆä¸»é”®ï¼‰çš„æ‰§è¡Œæ•ˆç‡æ˜¯æœ€ä¼˜çš„\nå¦‚æœè¡¨åªæœ‰ä¸€ä¸ªå­—æ®µï¼Œåˆ™ select countï¼ˆï¼‰æœ€ä¼˜ã€‚\n","date":"2021-08-15T10:41:01Z","permalink":"https://dccmmtop.github.io/posts/count1%E4%B8%8Ecountx%E7%9A%84%E5%8C%BA%E5%88%AB/","section":"posts","tags":["MySQL"],"title":"count(1)ä¸count(x)çš„åŒºåˆ«"},{"categories":null,"contents":"å”¯ä¸€ç´¢å¼• å”¯ä¸€ç´¢å¼•æ˜¯ç´¢å¼•å…·æœ‰çš„ä¸€ç§å±æ€§ï¼Œè®©ç´¢å¼•å…·å¤‡å”¯ä¸€æ€§ï¼Œç¡®ä¿è¿™å¼ è¡¨ä¸­ï¼Œè¯¥æ¡ç´¢å¼•æ•°æ®ä¸ä¼šé‡å¤å‡ºç°ã€‚åœ¨æ¯ä¸€æ¬¡insertå’Œupdateæ“ä½œæ—¶ï¼Œéƒ½ä¼šè¿›è¡Œç´¢å¼•çš„å”¯ä¸€æ€§æ ¡éªŒï¼Œä¿è¯è¯¥ç´¢å¼•çš„å­—æ®µç»„åˆåœ¨è¡¨ä¸­å”¯ä¸€ã€‚\ndb.containers.createIndex({name: 1},{unique:true, background: true}) db.packages.createIndex({ appId: 1, version: 1 },{unique:true, background: true}) çŸ¥è¯†ç‚¹ä¸€ï¼š\nåˆ›å»ºç´¢å¼•æ—¶,1è¡¨ç¤ºæŒ‰å‡åºå­˜å‚¨,-1è¡¨ç¤ºæŒ‰é™åºå­˜å‚¨ã€‚\nçŸ¥è¯†ç‚¹äºŒ:\nMongoæä¾›ä¸¤ç§å»ºç´¢å¼•çš„æ–¹å¼foregroundå’Œbackgroundã€‚\nå‰å°æ“ä½œï¼Œå®ƒä¼šé˜»å¡ç”¨æˆ·å¯¹æ•°æ®çš„è¯»å†™æ“ä½œç›´åˆ°indexæ„å»ºå®Œæ¯•ï¼›\nåå°æ¨¡å¼ï¼Œä¸é˜»å¡æ•°æ®è¯»å†™æ“ä½œï¼Œç‹¬ç«‹çš„åå°çº¿ç¨‹å¼‚æ­¥æ„å»ºç´¢å¼•ï¼Œæ­¤æ—¶ä»ç„¶å…è®¸å¯¹æ•°æ®çš„è¯»å†™æ“ä½œã€‚\nåˆ›å»ºç´¢å¼•æ—¶ä¸€å®šè¦å†™{background: true}\nåˆ›å»ºç´¢å¼•æ—¶ä¸€å®šè¦å†™{background: true}\nåˆ›å»ºç´¢å¼•æ—¶ä¸€å®šè¦å†™{background: true}\nå¤åˆç´¢å¼• æ¦‚å¿µï¼šæŒ‡çš„æ˜¯å°†å¤šä¸ªé”®ç»„åˆåˆ°ä¸€èµ·åˆ›å»ºç´¢å¼•ï¼Œç»ˆæç›®çš„æ˜¯åŠ é€ŸåŒ¹é…å¤šä¸ªé”®çš„æŸ¥è¯¢ã€‚\ndb.flights.createIndex({ flight: 1, price: 1 },{background: true}) å†…åµŒç´¢å¼• å¯ä»¥åœ¨åµŒå¥—çš„æ–‡æ¡£ä¸Šå»ºç«‹ç´¢å¼•ï¼Œæ–¹å¼ä¸å»ºç«‹æ­£å¸¸ç´¢å¼•å®Œå…¨ä¸€è‡´ã€‚\nä¸ªäººä¿¡æ¯è¡¨ç»“æ„å¦‚ä¸‹,åŒ…å«äº†çœå¸‚åŒºä¸‰çº§çš„åœ°å€ä¿¡æ¯ï¼Œå¦‚æœæƒ³è¦ç»™åŸå¸‚ï¼ˆcityï¼‰æ·»åŠ ç´¢å¼•ï¼Œå…¶å®å°±å’Œæ­£å¸¸æ·»ç´¢å¼•ä¸€æ ·\ndb.personInfos.createIndex({â€œaddress.cityâ€:1}) æ•°ç»„ç´¢å¼• MongoDBæ”¯æŒå¯¹æ•°ç»„å»ºç«‹ç´¢å¼•ï¼Œè¿™æ ·å°±å¯ä»¥é«˜æ•ˆçš„æœç´¢æ•°ç»„ä¸­çš„ç‰¹å®šå…ƒç´ ã€‚\nçŸ¥è¯†ç‚¹å››ï¼š\nä½†æ˜¯ï¼å¯¹æ•°ç»„å»ºç«‹ç´¢å¼•çš„ä»£ä»·æ˜¯éå¸¸é«˜çš„ï¼Œä»–å®é™…ä¸Šæ˜¯ä¼šå¯¹æ•°ç»„ä¸­çš„æ¯ä¸€é¡¹éƒ½å•ç‹¬å»ºç«‹ç´¢å¼•ï¼Œå°±ç›¸å½“äºå‡è®¾æ•°ç»„ä¸­æœ‰åé¡¹ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨åŸåŸºç¡€ä¸Šï¼Œå¤šå‡ºåå€çš„ç´¢å¼•å¤§å°ã€‚å¦‚æœæœ‰ä¸€ç™¾ä¸ªä¸€åƒä¸ªå‘¢ï¼Ÿ\næ‰€ä»¥åœ¨mongoä¸­æ˜¯ç¦æ­¢å¯¹ä¸¤ä¸ªæ•°ç»„æ·»åŠ å¤åˆç´¢å¼•çš„ï¼Œå¯¹ä¸¤ä¸ªæ•°ç»„æ·»åŠ ç´¢å¼•é‚£ä¹ˆç´¢å¼•å¤§å°å°†æ˜¯çˆ†ç‚¸å¢é•¿ï¼Œæ‰€ä»¥è°¨è®°åœ¨å¿ƒã€‚\nè¿‡æœŸç´¢å¼•ï¼ˆTTLï¼‰\nå¯ä»¥é’ˆå¯¹æŸä¸ªæ—¶é—´å­—æ®µï¼ŒæŒ‡å®šæ–‡æ¡£çš„è¿‡æœŸæ—¶é—´ï¼ˆç»è¿‡æŒ‡å®šæ—¶é—´åè¿‡æœŸ æˆ– åœ¨æŸä¸ªæ—¶é—´ç‚¹è¿‡æœŸï¼‰\nå“ˆå¸Œç´¢å¼•ï¼ˆHashed Indexï¼‰ æ˜¯æŒ‡æŒ‰ç…§æŸä¸ªå­—æ®µçš„hashå€¼æ¥å»ºç«‹ç´¢å¼•ï¼Œhashç´¢å¼•åªèƒ½æ»¡è¶³å­—æ®µå®Œå…¨åŒ¹é…çš„æŸ¥è¯¢ï¼Œä¸èƒ½æ»¡è¶³èŒƒå›´æŸ¥è¯¢ç­‰\nåœ°ç†ä½ç½®ç´¢å¼•ï¼ˆGeospatial Indexï¼‰ èƒ½å¾ˆå¥½çš„è§£å†³ä¸€äº›åœºæ™¯ï¼Œæ¯”å¦‚ã€æŸ¥æ‰¾é™„è¿‘çš„ç¾é£Ÿã€ã€ã€æŸ¥æ‰¾é™„è¿‘çš„åŠ æ²¹ç«™ã€ç­‰\næ–‡æœ¬ç´¢å¼•ï¼ˆText Indexï¼‰ èƒ½è§£å†³å¿«é€Ÿæ–‡æœ¬æŸ¥æ‰¾çš„éœ€æ±‚ï¼Œæ¯”å¦‚ï¼Œæ—¥å¿—å¹³å°ï¼Œç›¸å¯¹æ—¥å¿—å…³é”®è¯æŸ¥æ‰¾ï¼Œå¦‚æœé€šè¿‡æ­£åˆ™æ¥æŸ¥æ‰¾çš„è¯æ•ˆç‡æä½ï¼Œè¿™æ—¶å°±å¯ä»¥é€šè¿‡æ–‡æœ¬ç´¢å¼•çš„å½¢å¼æ¥è¿›è¡ŒæŸ¥æ‰¾\nExplainæŸ¥è¯¢è®¡åˆ’ æåˆ°æŸ¥çš„æ…¢ï¼ŒäºŒè¯ä¸è¯´ç›´æ¥çœ‹æŸ¥è¯¢è®¡åˆ’å¥½ä¹ˆï¼Ÿå…·ä½“æ¯ä¸€ä¸ªå­—æ®µçš„å«ä¹‰æˆ‘å°±ä¸åšèµ˜è¿°äº†å¾ˆå®¹æ˜“æŸ¥åˆ°ï¼Œæˆ‘æˆªå–winningPlançš„éƒ¨åˆ†å’Œå¤§å®¶ä¸€èµ·çœ‹ä¸€ä¸‹ã€‚WinningPlanå°±æ˜¯åœ¨æŸ¥è¯¢è®¡åˆ’ä¸­èƒœå‡ºçš„æ–¹æ¡ˆï¼Œé‚£è‚¯å®šå°±æœ‰è¢«æ·˜æ±°çš„æ–¹æ¡ˆï¼Œæ˜¯åœ¨rejectPlané‡Œã€‚\n// æŸ¥è¯¢è®¡åˆ’ä¸­çš„winningPlanéƒ¨åˆ† \u0026#34;winningPlan\u0026#34;: { \u0026#34;stage\u0026#34;: \u0026#34;FETCH\u0026#34;, \u0026#34;filter\u0026#34;: { \u0026#34;createdAt\u0026#34;: { \u0026#34;$gte\u0026#34;: ISODate(\u0026#34;2019-07-22T12:00:44.000Z\u0026#34;) } }, \u0026#34;inputStage\u0026#34;: { \u0026#34;stage\u0026#34;: \u0026#34;IXSCAN\u0026#34;, \u0026#34;keyPattern\u0026#34;: { \u0026#34;load\u0026#34;: 1 }, \u0026#34;indexName\u0026#34;: \u0026#34;load_1\u0026#34;, \u0026#34;isMultiKey\u0026#34;: false, \u0026#34;multiKeyPaths\u0026#34;: { \u0026#34;load\u0026#34;: [] }, \u0026#34;isUnique\u0026#34;: false, \u0026#34;isSparse\u0026#34;: false, \u0026#34;isPartial\u0026#34;: false, \u0026#34;indexVersion\u0026#34;: 2, \u0026#34;direction\u0026#34;: \u0026#34;backward\u0026#34;, \u0026#34;indexBounds\u0026#34;: { \u0026#34;load\u0026#34;: [ \u0026#34;[MaxKey, MinKey]\u0026#34; ] } } }, çŸ¥è¯†ç‚¹å…­ï¼š explain ç»“æœå°†æŸ¥è¯¢è®¡åˆ’ä»¥é˜¶æ®µæ ‘çš„å½¢å¼å‘ˆç°ã€‚\næ¯ä¸ªé˜¶æ®µå°†å…¶ç»“æœï¼ˆæ–‡æ¡£æˆ–ç´¢å¼•é”®ï¼‰ä¼ é€’ç»™çˆ¶èŠ‚ç‚¹ã€‚\nä¸­é—´èŠ‚ç‚¹æ“çºµç”±å­èŠ‚ç‚¹äº§ç”Ÿçš„æ–‡æ¡£æˆ–ç´¢å¼•é”®ã€‚\næ ¹èŠ‚ç‚¹æ˜¯MongoDBä»ä¸­æ´¾ç”Ÿç»“æœé›†çš„æœ€åé˜¶æ®µã€‚\nå¯¹äºæ–°äººä¸€å®šè¦ç‰¹åˆ«æ³¨æ„ï¼šåœ¨çœ‹æŸ¥è¯¢ç»“æœçš„é˜¶æ®µæ ‘çš„æ—¶å€™ä¸€å®šä¸€å®šæ˜¯ä»æœ€é‡Œå±‚ä¸€å±‚ä¸€å±‚å¾€å¤–çœ‹çš„ï¼Œä¸æ˜¯ç›´æ¥é¡ºç€è¯»ä¸‹æ¥çš„ã€‚\nçŸ¥è¯†ç‚¹ä¸ƒï¼š åœ¨æŸ¥è¯¢è®¡åˆ’ä¸­å‡ºç°äº†å¾ˆå¤šstageï¼Œä¸‹é¢åˆ—ä¸¾çš„ç»å¸¸å‡ºç°çš„stageä»¥åŠä»–çš„å«ä¹‰ï¼š\nCOLLSCANï¼šå…¨è¡¨æ‰«æ\nIXSCANï¼šç´¢å¼•æ‰«æ\nFETCHï¼šæ ¹æ®å‰é¢æ‰«æåˆ°çš„ä½ç½®æŠ“å–å®Œæ•´æ–‡æ¡£\nSORTï¼šè¿›è¡Œå†…å­˜æ’åºï¼Œæœ€ç»ˆè¿”å›ç»“æœ\nSORT_KEY_GENERATORï¼šè·å–æ¯ä¸€ä¸ªæ–‡æ¡£æ’åºæ‰€ç”¨çš„é”®å€¼\nLIMITï¼šä½¿ç”¨limité™åˆ¶è¿”å›æ•°\nSKIPï¼šä½¿ç”¨skipè¿›è¡Œè·³è¿‡\nIDHACKï¼šé’ˆå¯¹_idè¿›è¡ŒæŸ¥è¯¢\nCOUNTSCANï¼šcountä¸ä½¿ç”¨ç”¨Indexè¿›è¡Œcountæ—¶çš„stageè¿”å›\nCOUNT_SCANï¼šcountä½¿ç”¨äº†Indexè¿›è¡Œcountæ—¶çš„stageè¿”å›\nTEXTï¼šä½¿ç”¨å…¨æ–‡ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢æ—¶å€™çš„stageè¿”å›\næœ€æœŸæœ›çœ‹åˆ°çš„æŸ¥è¯¢ç»„åˆ Fetch+IDHACK\nFetch+ixscan\nLimit+ï¼ˆFetch+ixscanï¼‰\nPROJECTION+ixscan\næœ€ä¸æœŸæœ›çœ‹åˆ°çš„æŸ¥è¯¢ç»„åˆ\nCOLLSCANï¼ˆå…¨è¡¨æ‰«ï¼‰\nSORTï¼ˆä½¿ç”¨sortä½†æ˜¯æ— indexï¼‰\nCOUNTSCANï¼ˆä¸ä½¿ç”¨ç´¢å¼•è¿›è¡Œcountï¼‰\næœ€å·¦å‰ç¼€åŸåˆ™ å‡å®šç´¢å¼•(aï¼Œbï¼Œc) å®ƒå¯èƒ½æ»¡è¶³çš„æŸ¥è¯¢å¦‚ä¸‹ï¼š\n1. a 2. aï¼Œb 3. aï¼Œbï¼Œc 4. aï¼Œc [è¯¥ç»„åˆåªèƒ½ç”¨aéƒ¨åˆ†] 5. a, c, b [cbåœ¨æŸ¥è¯¢æ—¶ä¼šè¢«ä¼˜åŒ–æ¢ä½ç½®] æ˜¾ç„¶ï¼Œæœ€å·¦å‰ç¼€çš„æ ¸å¿ƒæ˜¯æŸ¥è¯¢æ¡ä»¶å­—æ®µå¿…é¡»å«æœ‰ç´¢å¼•ç¬¬ä¸€ä¸ªå­—æ®µ\næœ€å·¦å€¼å°½å¯èƒ½ç”¨æœ€ç²¾ç¡®è¿‡æ»¤æ€§æœ€å¥½çš„å€¼ï¼Œä¸è¦ç”¨é‚£ç§å¯èƒ½ä¼šç”¨äºèŒƒå›´æ¨¡ç³ŠæŸ¥è¯¢ï¼Œç”¨äºæ’åºçš„å­—æ®µ\næ•ˆç‡æä½çš„æ“ä½œç¬¦ $whereå’Œ$existsï¼šè¿™ä¸¤ä¸ªæ“ä½œç¬¦ï¼Œå®Œå…¨ä¸èƒ½ä½¿ç”¨ç´¢å¼•ã€‚\n$neå’Œ$not:é€šå¸¸æ¥è¯´å–åå’Œä¸ç­‰äº,å¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼Œä½†æ˜¯æ•ˆç‡æä½ï¼Œä¸æ˜¯å¾ˆæœ‰æ•ˆï¼Œå¾€å¾€ä¹Ÿä¼šé€€åŒ–æˆæ‰«æå…¨è¡¨ã€‚\n$nin:ä¸åŒ…å«ï¼Œè¿™ä¸ªæ“ä½œç¬¦ä¹Ÿæ€»æ˜¯ä¼šå…¨è¡¨æ‰«æ\nå¯¹äºç®¡é“ä¸­çš„ç´¢å¼•ï¼Œä¹Ÿå¾ˆå®¹æ˜“å‡ºç°æ„å¤–ï¼Œåªæœ‰åœ¨ç®¡é“æœ€å¼€å§‹æ—¶çš„match sortå¯ä»¥ä½¿ç”¨åˆ°ç´¢å¼•ï¼Œä¸€æ—¦å‘ç”Ÿè¿‡projectæŠ•å°„ï¼Œgroupåˆ†ç»„ï¼Œlookupè¡¨å…³è”ï¼Œunwindæ‰“æ•£ç­‰æ“ä½œåï¼Œå°±å®Œå…¨æ— æ³•ä½¿ç”¨ç´¢å¼•ã€‚\nç´¢å¼•è®¾è®¡å’Œä¼˜åŒ–åŸåˆ™\næœ€åç¥­å‡ºæä¸¹è€å¸ˆçš„ç´¢å¼•è®¾è®¡å’Œä¼˜åŒ–åŸåˆ™\n1.ä¸»é”®çš„è®¾ç½®\nä¸šåŠ¡æ— å…³ã€æ˜¾ç¤ºæŒ‡å®šã€é€’å¢å±æ€§\n2.æ•°æ®åŒºåˆ†åº¦\nåŸåˆ™ä¸ŠåŒºåˆ†åº¦é«˜çš„å­—æ®µä¼˜å…ˆåšç´¢å¼•å­—æ®µï¼Œå¦‚æœæ˜¯ç»„åˆç´¢å¼•ä¼˜å…ˆæ”¾å‰é¢\n3.å­—æ®µæ›´æ–°é¢‘ç‡ é¢‘ç¹æ›´æ–°çš„å­—æ®µæ˜¯å¦åšç´¢å¼•å­—æ®µéœ€è¦ç»¼åˆè€ƒè™‘å¯¹ä¸šåŠ¡çš„å½±å“åŠæŸ¥è¯¢çš„ä»£ä»·\n4.å‰ç¼€ç´¢å¼•é—®é¢˜ éœ€è¦æ³¨æ„çš„æ˜¯å› å‰ç¼€ç´¢å¼•åªåŒ…å«éƒ¨åˆ†å€¼å› æ­¤æ— æ³•é€šè¿‡å‰ç¼€ç´¢å¼•ä¼˜åŒ–æ’åº\n5.é€‚å½“å†—ä½™è®¾è®¡ å¯¹äºå­˜å‚¨è¾ƒé•¿å­—ç¬¦ä¸²å­—æ®µå¯é¢å¤–å¢åŠ å­—æ®µå­˜å‚¨åŸå­—æ®µè®¡ç®—(å¦‚hash)åçš„å€¼\nåˆ›å»ºç´¢å¼•æ—¶åªéœ€è¦å¯¹é¢å¤–å­—æ®µåˆ›å»ºç´¢å¼•å³å¯\n6.é¿å…æ— æ•ˆç´¢å¼• é€šå¸¸ç±»ä¼¼è¡¨å·²ç»å«æœ‰ä¸»é”®IDå°±æ— éœ€å†åˆ›å»ºé¢å¤–å”¯ä¸€æ€§çš„IDç´¢å¼•\n7.æŸ¥è¯¢è¦†ç›–ç‡ è®¾è®¡ä¸€ä¸ªç´¢å¼•æˆ‘ä»¬éœ€è¦è€ƒè™‘å°½é‡è¦†ç›–æ›´å¤šçš„æŸ¥è¯¢åœºæ™¯\n8.æ§åˆ¶å­—æ®µæ•° å¦‚æœä½ è®¾è®¡çš„ç´¢å¼•ä¾‹å¦‚å«æœ‰7ã€8ä¸ªå­—æ®µé€šå¸¸éœ€è¦è€ƒè™‘è®¾è®¡æ˜¯å¦åˆç†\nä¼˜åŒ–åŸåˆ™ 1.å‡å°‘ç½‘ç»œå¸¦å®½ æŒ‰éœ€è¿”å›æ‰€éœ€å­—æ®µã€å°½é‡é¿å…è¿”å›å¤§å­—æ®µ\n2.å‡å°‘å†…å­˜è®¡ç®— å‡å°‘æ— å¿…è¦ä¸­é—´ç»“æœå­˜å‚¨ã€å‡å°‘å†…å­˜è®¡ç®—\n3.å‡å°‘ç£ç›˜IO æ·»åŠ åˆé€‚çš„ç´¢å¼•ã€å…³æ³¨SQLæ”¹å†™\n","date":"2021-08-12T23:13:39Z","permalink":"https://dccmmtop.github.io/posts/%E7%B4%A2%E5%BC%95/","section":"posts","tags":["mongo"],"title":"ç´¢å¼•"},{"categories":null,"contents":"å¼€å¯æŸ¥è¯¢æ—¥å¿— æ–¹æ³•ä¸€ï¼šæ‰§è¡ŒMongoDBå‘½ä»¤ è¿™ä¸ªå‘½ä»¤åªèƒ½è®¾ç½®å•ä¸ªç»„ä»¶çš„æ—¥å¿—ç­‰çº§ï¼Œå¦‚æœæƒ³è¦ä¸€æ¬¡æ€§è®¾ç½®å¤šä¸ªç»„ä»¶çš„æ—¥å¿—ç­‰çº§ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š\næ–°å»º start_log.jsï¼Œ å†…å®¹å¦‚ä¸‹\ndb.adminCommand( { setParameter: 1, logComponentVerbosity: { verbosity: 1, query: { verbosity: 2 }, storage: { verbosity: 2, journal: { verbosity: 1 } } } } ); æ‰§è¡Œå‘½ä»¤ï¼š\nå¦‚æœå¼€å¯äº†è®¤è¯,è¿˜éœ€è¦åŠ ä¸Šç”¨æˆ·å’Œå¯†ç ä¿¡æ¯\n./mongo 127.0.0.1:27019/eop_task ./start_log.js\nä¸Šé¢ä¾‹å­ä¸­çš„æ–¹æ³•ï¼Œ\nå°†å…¨å±€çš„æ—¥å¿—ç­‰çº§è®¾ç½®æˆ1ï¼›\nå°†queryçš„æ—¥å¿—ç­‰çº§è®¾ç½®æˆ2ï¼›\nå°†storageçš„æ—¥å¿—ç­‰çº§è®¾ç½®æˆ2ï¼›\nå°†storage.journalçš„æ—¥å¿—ç­‰çº§è®¾ç½®æˆ1ï¼›\næ¢å¤åŸçº§åˆ«ï¼š\næ–°å»º close_log.js,å†…å®¹å¦‚ä¸‹ï¼š\ndb.auth(\u0026#34;eop\u0026#34;,\u0026#34;password\u0026#34;); db.adminCommand( { setParameter:0, logComponentVerbosity: { verbosity: 0, query: { verbosity: -1 } } }); æ‰§è¡Œå‘½ä»¤ ./mongo 127.0.0.1:27019/eop_task ./close_log.js\næ–¹æ³•äºŒï¼šå†™å…¥é…ç½®æ–‡ä»¶ æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œç­‰åŒäºåœ¨é…ç½®æ–‡ä»¶ä¸­å†™å…¥ï¼š\nsystemLog: verbosity: 1 component: query: verbosity: 2 storage: verbosity: 2 journal: verbosity: 1 æ—¥å¿—è½®æ¢ æœ‰æ—¶å€™ï¼Œé•¿æ—¶é—´æ²¡æœ‰æ¸…ç†æ—¥å¿—ï¼Œæ—¥å¿—çš„æ•°æ®é‡ä¼šå˜çš„å¾ˆå¤§ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹æ³•æ¥å¯¹æ—¥å¿—è¿›è¡Œæ»šåŠ¨ï¼š\nåˆ©ç”¨æ—¥å¿—è½®æ»šçš„æ–¹æ³•ï¼Œç›´æ¥åœ¨MongoDBçš„å‘½ä»¤è¡Œé‡Œé¢è¾“å…¥ï¼š\nuse admin //åˆ‡æ¢åˆ°adminæ•°æ®åº“ db.runCommand({logRotate:1}) è¿™ç§æ–¹æ³•é‡‡ç”¨äº†å‘½ä»¤æ¥åˆ‡æ¢æ—¥å¿—æ–‡ä»¶ï¼Œä¸éœ€è¦å…³é—­mongodbæœåŠ¡ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒæ¨èçš„åšæ³•ã€‚\nå½“ç„¶ï¼Œå¦‚æœéœ€è¦äººæ‰‹å·¥çš„å®šæœŸæ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼Œå¥½åƒä¹Ÿä¸å¤Ÿä¼˜é›…ï¼Œæ‰€ä»¥å¯ä»¥é…åˆcrontabå»åšè¿™ä¸ªäº‹æƒ…ï¼Œæ¯å¤©å®šæ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œè¾¾åˆ°æ—¥å¿—æ–‡ä»¶è½®æ»šçš„ç›®çš„ã€‚\næŸ¥è¯¢æ—¥å¿—åˆ†æ è°ƒæ•´æ—¥å¿—ç­‰çº§åï¼Œåœ¨æ—¥å¿—æ–‡ä»¶ä¸­ä¼šå‘ç°å¦‚ä¸‹ç±»ä¼¼æ—¥å¿—\n{ aggregate: \u0026#34;zyb_work_task\u0026#34;, pipeline: [ { $match: { level: 0 } }, { $match: { $or: [ { \u0026#34;creator.id\u0026#34;: 811 }, { assigneeType: 0, assigneeId: 811 }, { assigneeType: 1, assigneeId: { $in: [ 5778 ] } }, { assigneeType: 2, assigneeId: { $in: [ 29295, 28087, 28118 ] } }, { \u0026#34;ccUser.id\u0026#34;: 811 }, { subAssigneeList: 811 }, { subCcList: 811 }, { subCreatorList: 811 } ] } }, { $addFields: { currentEmpFocus: { $ifNull: [ \u0026#34;$empFocus.811\u0026#34;, 0 ] } } }, { $match: { finishFlag: false } }, { $sort: { currentEmpFocus: -1, createTime: -1 } }, { $limit: 20 } ], cursor: {} } ç„¶åå°†å…¶å¤åˆ¶åˆ°jsæ–‡ä»¶ä¸­ï¼š\nfind_task_list.js\n//è®¤è¯ db.auth(\u0026#34;eop\u0026#34;,\u0026#34;pass\u0026#34;); // æ ¼å¼åŒ–è¾“å‡º print(JSON.stringify( // æ‰§è¡Œå‘½ä»¤ db.runCommand( // ç›´æ¥å¤åˆ¶æ—¥å¿—ä¸­çš„æŸ¥è¯¢å‘½ä»¤ { aggregate: \u0026#34;zyb_work_task\u0026#34;, pipeline: [ { $match: { level: 0 } }, { $match: { $or: [ { \u0026#34;creator.id\u0026#34;: 811 }, { assigneeType: 0, assigneeId: 811 }, { assigneeType: 1, assigneeId: { $in: [ 5778 ] } }, { assigneeType: 2, assigneeId: { $in: [ 29295, 28087, 28118 ] } }, { \u0026#34;ccUser.id\u0026#34;: 811 }, { subAssigneeList: 811 }, { subCcList: 811 }, { subCreatorList: 811 } ] } }, { $addFields: { currentEmpFocus: { $ifNull: [ \u0026#34;$empFocus.811\u0026#34;, 0 ] } } }, { $match: { finishFlag: false } }, { $sort: { currentEmpFocus: -1, createTime: -1 } }, { $limit: 20 } ], cursor: {} } ) ) ); æ‰§è¡Œ: ./mongo 127.0.0.1:27019/eop_task ./find_task_list.js\næ­¤æ—¶å°±å¯ä»¥å°†åº”ç”¨çš„æŸ¥è¯¢è¯­å¥å¯¹åº”çš„ç»“æœæ˜¾ç¤ºå‡ºæ¥ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥çš„è°ƒè¯•\n","date":"2021-08-12T23:13:15Z","permalink":"https://dccmmtop.github.io/posts/%E5%BC%80%E5%90%AF%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97/","section":"posts","tags":["mongoDB"],"title":"å¼€å¯æŸ¥è¯¢æ—¥å¿—"},{"categories":null,"contents":"require \u0026#34;socket\u0026#34; local_ip = UDPSocket.open {|s| s.connect(\u0026#34;1.1.1.1\u0026#34;, 1);s.addr.last} ","date":"2021-08-12T23:12:27Z","permalink":"https://dccmmtop.github.io/posts/%E8%8E%B7%E5%8F%96%E6%9C%AC%E6%9C%BAip%E5%9C%B0%E5%9D%80/","section":"posts","tags":["ruby"],"title":"è·å–æœ¬æœºipåœ°å€"},{"categories":null,"contents":"sidekiqæ¸…ç©ºé˜Ÿåˆ—é‡Œä»»åŠ¡çš„æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼Œä¸€æ˜¯ä½¿ç”¨sidekiqçš„apiï¼ŒäºŒæ˜¯ç›´æ¥æ“ä½œredis\nä¸€ã€ä½¿ç”¨sidekiqçš„apiæ¸…ç©ºé˜Ÿåˆ—çš„ä»»åŠ¡ sidekiqé‡Œæœ‰æä¾›æ“ä½œé˜Ÿåˆ—çš„apiï¼Œé¦–å…ˆå¼•å…¥\nrequire\u0026rsquo;sidekiq/api'\nè·å–æ‰€æœ‰é˜Ÿåˆ—ï¼šSidekiq::Queue.all\nè·å–é»˜è®¤é˜Ÿåˆ—ï¼šSidekiq::Queue.new# the \u0026ldquo;default\u0026rdquo; queue\næŒ‰åç§°è·å–é˜Ÿåˆ—ï¼šSidekiq::Queue.new(\u0026ldquo;mailer\u0026rdquo;)\næ¸…ç©ºé˜Ÿåˆ—çš„æ‰€æœ‰ä»»åŠ¡ï¼šSidekiq::Queue.new.clear\næŒ‰æ¡ä»¶æ¥åˆ é™¤é˜Ÿåˆ—çš„ä»»åŠ¡ï¼š\nqueue=Sidekiq::Queue.new(\u0026#34;mailer\u0026#34;) queue.eachdo |job| job.klass# =\u0026gt; \u0026#39;MyWorker\u0026#39; job.args# =\u0026gt; [1, 2, 3] job.delete if job.jid==\u0026#39;abcdef1234567890\u0026#39; end äºŒã€ç›´æ¥æ“ä½œredisæ¥åˆ é™¤é˜Ÿåˆ—é‡Œçš„ä»»åŠ¡ é¦–å…ˆè·å–é…ç½®æ–‡ä»¶configï¼Œå†è¿æ¥redisï¼Œè¿™é‡Œä½¿ç”¨äº†redisçš„GemåŒ…\nredis= Redis.new(:host =\u0026gt; config[\u0026lsquo;host\u0026rsquo;], :port =\u0026gt; config[\u0026lsquo;port\u0026rsquo;], :db=\u0026gt; config[\u0026lsquo;db\u0026rsquo;], :password =\u0026gt; config[\u0026lsquo;password\u0026rsquo;])\nç”±äºqueuesç”¨çš„æ˜¯setç±»å‹çš„æ•°æ®ï¼Œæ‰€ä»¥è¦ç”¨sremæ¥åˆ é™¤ç›¸åº”çš„æ•°æ®\nredis.srem(â€˜queuesâ€™, â€˜é˜Ÿåˆ—çš„åç§°â€™) # è¿™ç§æƒ…å†µä¼šç›´æ¥åˆ é™¤è¯¥åç§°çš„é˜Ÿåˆ— ","date":"2021-08-12T23:12:03Z","permalink":"https://dccmmtop.github.io/posts/%E6%B8%85%E9%99%A4sidekiq%E4%BB%BB%E5%8A%A1/","section":"posts","tags":["rails"],"title":"æ¸…é™¤sidekiqä»»åŠ¡"},{"categories":null,"contents":"ä¾‹å­å¦‚ä¸‹ï¼š\nç”¨sort_by\ndef order_weight_sort_by(string) string.split(\u0026#34; \u0026#34;).sort_by do |a| sum_a = a.split(\u0026#34;\u0026#34;).inject(0) { |mem, var| mem += var.to_i } first_number = a[0].to_i [a.size, sum_a, first_number] end.join(\u0026#34; \u0026#34;) end string = \u0026ldquo;56 65 74 100 99 68 86 980 90\u0026rdquo;\np order_weight_sort_by(string )\nç»“æœæ˜¯\u0026quot;90 56 65 74 68 86 99 100 980\u0026quot;\nä¸Šé¢çš„æ–¹æ³•æ˜¯å…ˆå°†å­—ç¬¦ä¸²å˜æˆä¸€ä¸ªç”±æ•°å­—å­—ç¬¦ä¸²ç»„æˆçš„æ•°ç»„ã€‚ç„¶åå…ˆæŒ‰ç…§å­—ç¬¦ä¸²çš„é•¿åº¦è¿›è¡Œæ’åºï¼Œå†æŒ‰ç…§å­—ç¬¦ä¸²å„æ•°å­—ä¹‹å’Œè¿›è¡Œæ’åºï¼Œæœ€åæŒ‰ç…§å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªæ•°å­—å¤§å°è¿›è¡Œæ’åºã€‚\nå…³é”®ä»£ç [a.size, sum_a, first_number]\nå½“æœ€åæ˜¯ä¸€ä¸ªæ¡ä»¶æ•°ç»„æ—¶ï¼Œsort_byä¼šæŒ‰ç…§è¯¥æ¡ä»¶æ•°ç»„çš„é¡ºåºä¾æ¬¡æ’åºã€‚\nç”¨sort\ndef order_weight_sort(string) string.split(\u0026#34; \u0026#34;).sort do |a, b| sum_a = a.split(\u0026#34;\u0026#34;).inject(0) { |mem, var| mem += var.to_i } first_number_a = a[0].to_i size_a = a.size sum_b = b.split(\u0026#34;\u0026#34;).inject(0) { |mem, var| mem += var.to_i } first_number_b = b[0].to_i size_b = b.size [size_a, sum_a, first_number_a] \u0026lt;=\u0026gt; [size_b, sum_b, first_number_b] end.join(\u0026#34; \u0026#34;) end string = \u0026ldquo;56 65 74 100 99 68 86 980 90\u0026rdquo;\np order_weight_sort(string )\nç»“æœä¸ä¸Šé¢æ˜¯ä¸€æ ·çš„ã€‚\nå…³é”®ä»£ç [size_a, sum_a, first_number_a] \u0026lt;=\u0026gt; [size_b, sum_b, first_number_b]\nè¿™æ ·çœ‹èµ·æ¥sort_byæ¯”sortç®€æ´å¾ˆå¤šã€‚\nç¡®å®sort_byåªéœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œè€Œsortéœ€è¦ä¸¤ä¸ªå‚æ•°ã€‚ä½†ä»–ä»¬å®ç°å¤šå±‚æ’åºæ˜¯ä¸€æ ·çš„ï¼Œæœ€åéƒ½æ˜¯ç”¨ä¸€ä¸ªæ¡ä»¶æ•°ç»„æ¥è¡¨ç¤ºã€‚\nåŒºåˆ«\nä½†sortè¦æ¯”sort_byçµæ´»ã€‚å› ä¸ºæœ€åçš„æ’åºæ¡ä»¶è¿˜å¯ä»¥è¿™æ ·å†™ï¼š\n[size_b, sum_a, first_number_b] \u0026lt;=\u0026gt; [size_a, sum_b, first_number_a]\nè¿™æ ·å°±ç›¸å½“äºå…ˆæŒ‰é•¿åº¦å€’åºæ’åˆ—ï¼Œç„¶åå†æŒ‰ç…§å­—ç¬¦ä¸²å„æ•°å­—ä¹‹å’Œè¿›è¡Œæ’åºï¼Œæœ€åå†æŒ‰ç…§é¦–ä¸ªå­—ç¬¦çš„å¤§å°å€’åºæ’åˆ—ã€‚\nä½œè€…ï¼škamionayuki\né“¾æ¥ï¼šhttp://www.jianshu.com/p/319d0174f246\nä¾†æºï¼šç®€ä¹¦\nè‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚\n","date":"2021-08-12T23:10:45Z","permalink":"https://dccmmtop.github.io/posts/ruby%E5%A4%9A%E5%B1%82%E6%95%B0%E7%BB%84%E6%8E%92%E5%BA%8F/","section":"posts","tags":["ruby"],"title":"rubyå¤šå±‚æ•°ç»„æ’åº"},{"categories":null,"contents":"railséªŒè¯ç  1.å®‰è£…åŒ…\ngem \u0026#39;rucaptcha\u0026#39; gem \u0026#39;dalli\u0026#39; 2.é…ç½®è·¯ç”± ï¼ˆæœ€æ–°ç‰ˆæœ¬çš„ä¸ç”¨é…ç½®è·¯ç”±ï¼‰\nmount RuCaptcha::Engine =\u0026gt; \u0026#34;/rucaptcha\u0026#34; 3.controlleréƒ¨åˆ†\ndef create @user = User.new(user_params) if verify_rucaptcha?(@user)\u0026amp;\u0026amp;@user.save ...... 4.viewéƒ¨åˆ†\n\u0026lt;div class=\u0026#34;form-group \u0026#34;\u0026gt; \u0026lt;%= rucaptcha_input_tag( class:\u0026#39;form-control rucaptcha-text\u0026#39;) %\u0026gt; \u0026lt;a href=\u0026#34;#\u0026#34; class=\u0026#39;rucaptcha-image-box\u0026#39;\u0026gt;\u0026lt;%= rucaptcha_image_tag(class:\u0026#39;rucaptcha-image\u0026#39;, alt: \u0026#39;Captcha\u0026#39;) %\u0026gt;\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; 5.å®ç°ç‚¹å‡»å›¾ç‰‡åˆ·æ–°éªŒè¯ç \n#ç‚¹å‡»éªŒè¯ç åˆ·æ–° $(\u0026#34;.rucaptcha-image\u0026#34;).click -\u0026gt; img = $(this) currentSrc = img.attr(\u0026#39;src\u0026#39;); img.attr(\u0026#39;src\u0026#39;, currentSrc.split(\u0026#39;?\u0026#39;)[0] + \u0026#39;?\u0026#39; + (new Date()).getTime()); return false ","date":"2021-08-12T23:08:20Z","permalink":"https://dccmmtop.github.io/posts/rails%E9%AA%8C%E8%AF%81%E7%A0%81/","section":"posts","tags":["rails"],"title":"railséªŒè¯ç "},{"categories":null,"contents":"æœ‰æ—¶å€™æˆ‘éœ€è¦å†™ä¸€ä¸ªé¡µé¢èƒ½å‘show edit é‚£æ ·å¯ä»¥æ¥å—å‚æ•°çš„è·¯ç”±,å¼„äº†å¥½ä¹…ä¸çŸ¥é“æ€æ ·è§£å†³,ä»Šå¤©æç„¶å¤§æ‚Ÿ\næˆ‘ä»¬æ‰§è¡Œ rake routes å°±ä¼šçœ‹åˆ°å¦‚ä¸‹\nwechat_nodes GET /wechat/nodes(.:format) wechat/nodes#index POST /wechat/nodes(.:format) wechat/nodes#create new_wechat_node GET /wechat/nodes/new(.:format) wechat/nodes#new edit_wechat_node GET /wechat/nodes/:id/edit(.:format) wechat/nodes#edit wechat_node GET /wechat/nodes/:id(.:format) wechat/nodes#show PATCH /wechat/nodes/:id(.:format) wechat/nodes#update PUT /wechat/nodes/:id(.:format) wechat/nodes#update DELETE /wechat/nodes/:id(.:format) wechat/nodes#destroy è¿™æ˜¯ä½¿ç”¨resources ç”Ÿæˆä¸€äº›è·¯ç”±,æˆ‘ä»¬å¯ä»¥æ¨¡ä»¿å†™å‡ºè‡ªå·±çš„è·¯ç”±\næˆ‘ä»¬çœ‹æœ€åä¸€åˆ—çš„å†…å®¹, å¯¹äºshow æ¥è¯´ ä»–çš„æ ¼å¼ä¸º/wechat/nodes/:id å†çœ‹edit ä»–çš„æ ¼å¼æ˜¯/wechat/nodes/:id/edit\nåŠ å…¥æˆ‘ä»¬è¦æƒ³å†™ä¸€ä¸ª/wechat/node/edit/34/topic/23 ç±»ä¼¼çš„è·¯ç”±,æˆ‘ä»¬å¯ä»¥ç›´æ¥è¿™æ ·å†™\nresources nodes do collection do get \u0026#39;edit/:id/topic/:node_id\u0026#39;, to: \u0026#39;nodes#topic\u0026#39; , as: \u0026#39;topic_edit\u0026#39; end end è¿™é‡Œä¸ºä»€ä¹ˆä¼šæœ‰ä¸€ä¸ªaså‘¢,å› ä¸ºæ²¡æœ‰aså’Œå…¶åé¢çš„åç§°çš„è¯,è¿™æ ·æ˜¯æ²¡æœ‰å‰é¢çš„è·¯ç”±ä¿¡æ¯çš„.\nç­›é€‰è·¯ç”±-è·¯ç”±å†²çªçš„è§£å†³æ–¹æ¡ˆ Railsé¡¹ç›®æœ‰ä¸€ä¸ªArticleæ¨¡å‹,å¯¹åº”ArticlesControlleræ§åˆ¶å™¨,å…¶è·¯ç”±è®¾ç½®å¦‚ä¸‹:\nresources :articles do end è¿™æ ·å®ƒçš„CRUDè·¯å¾„å°±éƒ½è‡ªåŠ¨åˆ›å»ºå‡ºæ¥äº† ;)\nç°åœ¨æˆ‘æƒ³å†æ·»åŠ ä¸€ä¸ªå¯¹Articleæ¨¡å‹æœç´¢çš„é¡µé¢,é‚£ä¹ˆé¦–å…ˆè¦åœ¨æ§åˆ¶å™¨ä¸­æ·»åŠ å¯¹åº”çš„searchæ–¹æ³•:\ndef search render text:\u0026#34;hello search!!!\u0026#34; end ç„¶ååœ¨Articleé»˜è®¤è·¯ç”±é›†åˆåé¢æ·»åŠ ä¸€è¡Œæ–°è·¯ç”±:\nget \u0026quot;articles/search\u0026quot;,to:\u0026quot;articles#search\u0026quot;1\nç°åœ¨æˆ‘ä»¬è®¿é—®ä¸€ä¸‹articles/searché¡µé¢,å’¦?æ€ä¹ˆå‡ºé”™äº†:\nä»”ç»†çœ‹å‡ºé”™ä¿¡æ¯,åŸæ¥Articleä¹‹å‰çš„showè·¯ç”±æ°æ°å¯ä»¥åŒ¹é…æ–°çš„searchè·¯ç”±,åªä¸è¿‡åŸæ¥çš„:idå˜æˆäº†searchè¿™ä¸ªå­—ç¬¦ä¸²å“¦.è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæŠ¥Couldnâ€™t find Article with id=searchçš„åŸå› äº†!\nä¸‹é¢ç»™å‡ºè§£å†³,æˆ‘ä»¬åªéœ€è¦å…ˆç¦ç”¨é»˜è®¤çš„showè·¯ç”±:\nresources :articles,except:[:show] do resources :comments end ç„¶åå†ç”Ÿæˆä¸€æ¡ç­›é€‰è·¯ç”±å³å¯,æ‰€è°“ç­›é€‰è·¯ç”±å°±æ˜¯å¯¹è¯¥è·¯ç”±å†…å®¹è¿›è¡Œç»†ç²’åº¦åŒ¹é…çš„æ–¹æ³•:\nget \u0026#34;articles/:id\u0026#34;,to:\u0026#34;articles#show\u0026#34;,constraints:{id:/\\d+/} è·¯ç”±éƒ½æ˜¯ä»ä¸Šä¹‹ä¸‹ä¾æ¬¡åŒ¹é…çš„,å¦‚æœä¸Šé¢ä¸€æ¡è¢«åŒ¹é…åˆ™è·¯ç”±åŒ¹é…ç»“æŸ!è¿™é‡ŒåªåŒ¹é…idä¸ºæ•°å­—çš„articles/xxxè·¯å¾„,æ‰€ä»¥searchå°±ä¼šé»˜è®¤è¢«å¿½ç•¥ä»è€Œè¢«åé¢searchæ­£ç¡®çš„è·¯ç”±æ‰€åŒ¹é…!\n","date":"2021-08-12T22:53:06Z","permalink":"https://dccmmtop.github.io/posts/%E5%8F%82%E6%95%B0%E8%B7%AF%E7%94%B1%E4%B8%8E%E8%B7%AF%E7%94%B1%E5%86%B2%E7%AA%81%E8%A7%A3%E5%86%B3%E4%B8%8E%E7%AD%9B%E9%80%89%E8%B7%AF%E7%94%B1/","section":"posts","tags":["rails"],"title":"å‚æ•°è·¯ç”±ä¸è·¯ç”±å†²çªè§£å†³ä¸ç­›é€‰è·¯ç”±"},{"categories":null,"contents":"å­˜å‚¨è¿‡ç¨‹æ·»åŠ åˆ— create procedure add_col( in model_name text, in col_name text, in col_info text, out result text ) begin if not exists( select * from information_schema.COLUMNS where TABLE_NAME = model_name and COLUMN_NAME = col_name) then set @ddl=CONCAT(\u0026#39;alter table \u0026#39;, model_name, \u0026#39; add column \u0026#39;, col_name, col_info); prepare stmt from @ddl; execute stmt; set result = \u0026#39;success\u0026#39;; else set result = \u0026#39;exists\u0026#39;; end if; end; set @result = \u0026#39;\u0026#39;; call add_col(\u0026#39;dc_employee\u0026#39;,\u0026#39;senior_1 \u0026#39;,\u0026#39;tinyint(1) NULL DEFAULT 0 COMMENT \u0026#34;æ˜¯å¦æ˜¯é«˜çº§ç”¨æˆ·ï¼Œ0 ä¸æ˜¯ 1 æ˜¯\u0026#34;\u0026#39;,@result); select @result; ","date":"2021-08-10T18:19:22Z","permalink":"https://dccmmtop.github.io/posts/%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E6%B7%BB%E5%8A%A0%E5%88%97/","section":"posts","tags":["mysql"],"title":"å­˜å‚¨è¿‡ç¨‹æ·»åŠ åˆ—"},{"categories":null,"contents":"MySQLéš”ç¦»çº§åˆ« éš”ç¦»çº§åˆ«æ˜¯é’ˆå¯¹æ•°æ®åº“ ACID ä¸­çš„I(éš”ç¦»æ€§)æ¥è¯´çš„\nåŸå­æ€§ ä¸€è‡´æ€§ éš”ç¦»æ€§ æŒä¹…æ€§ éš”ç¦»æ€§ é€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ªäº‹åŠ¡æ‰€åšçš„ä¿®æ”¹ï¼Œåœ¨æœ€ç»ˆæäº¤ä»¥å‰ï¼Œå¯¹å…¶ä»–äº‹åŠ¡æ˜¯ä¸å¯è§çš„ï¼Œä¸ºä»€ä¹ˆæ˜¯ â€œé€šå¸¸æ¥è¯´â€ï¼Œå› ä¸ºè¿™ç§ç‰¹æ€§å’Œéš”ç¦»çº§åˆ«æœ‰å…³\næœªæäº¤è¯» READ UNCOMMITTED äº‹åŠ¡ä¸­çš„ä¿®æ”¹ï¼Œå³ä½¿æ²¡æœ‰æäº¤ï¼Œå…¶ä»–äº‹åŠ¡ä¹Ÿå¯ä»¥è¯»åˆ°ã€‚è¢«ç§°ä¸ºè„è¯»ã€‚\nä»æ€§èƒ½ä¸Šæ¥è¯´ï¼Œå¹¶æ²¡æœ‰æ¯”å…¶ä»–çº§åˆ«å¥½å¤ªå¤šï¼Œå´æœ‰å¾ˆå¤šé—®é¢˜ï¼Œä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨ã€‚\nè¯»æäº¤ï¼š äº‹åŠ¡Aäº‹å…ˆè¯»å–äº†æ•°æ®ï¼Œäº‹åŠ¡Bç´§æ¥äº†æ›´æ–°äº†æ•°æ®ï¼Œå¹¶æäº¤äº†äº‹åŠ¡ï¼Œè€Œäº‹åŠ¡Aå†æ¬¡è¯»å–è¯¥æ•°æ®æ—¶ï¼Œæ•°æ®å·²ç»å‘ç”Ÿäº†æ”¹å˜ã€‚é€ æˆäº†ä¸å¯é‡å¤è¯»ï¼ˆè™šè¯»ï¼‰ã€‚\nå¯é‡å¤è¯»ï¼š äº‹åŠ¡Aè¯»å–ä¸æœç´¢æ¡ä»¶ç›¸åŒ¹é…çš„è‹¥å¹²è¡Œã€‚äº‹åŠ¡Bä»¥æ’å…¥æˆ–åˆ é™¤è¡Œç­‰æ–¹å¼æ¥ä¿®æ”¹äº‹åŠ¡Açš„ç»“æœé›†ï¼Œç„¶åå†æäº¤ã€‚äº‹åŠ¡Aå†è¯»å–æ—¶ï¼Œå´å‘ç°æ•°æ®å‘ç”Ÿäº†å˜åŒ–ã€‚é€ æˆäº†å¹»è¯»ã€‚\nä¸å¯é‡å¤è¯»çœŸæ­£å«ä¹‰åº”è¯¥åŒ…å«è™šè¯»å’Œå¹»è¯»ã€‚ æ‰€è°“çš„è™šè¯»ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶ç»å¸¸è¯´çš„ä¸å¯é‡å¤è¯»ï¼Œæ˜¯æŒ‡åœ¨æ•°æ®åº“è®¿é—®ä¸­ï¼Œä¸€ä¸ªäº‹åŠ¡èŒƒå›´å†…ä¸¤ä¸ªç›¸åŒçš„æŸ¥è¯¢å´è¿”å›äº†ä¸åŒæ•°æ®ã€‚è¿™æ˜¯ç”±äºæŸ¥è¯¢æ—¶ç³»ç»Ÿä¸­å…¶ä»–äº‹åŠ¡ä¿®æ”¹çš„æäº¤è€Œå¼•èµ·çš„ã€‚æ¯”å¦‚äº‹åŠ¡T1è¯»å–æŸä¸€æ•°æ®ï¼Œäº‹åŠ¡T2è¯»å–å¹¶ä¿®æ”¹äº†è¯¥æ•°æ®ï¼ŒT1ä¸ºäº†å¯¹è¯»å–å€¼è¿›è¡Œæ£€éªŒè€Œå†æ¬¡è¯»å–è¯¥æ•°æ®ï¼Œä¾¿å¾—åˆ°äº†ä¸åŒçš„ç»“æœã€‚\nä¸€ç§æ›´æ˜“ç†è§£çš„è¯´æ³•æ˜¯ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡å†…ï¼Œå¤šæ¬¡è¯»åŒä¸€ä¸ªæ•°æ®ã€‚åœ¨è¿™ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰ç»“æŸæ—¶ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®è¯¥åŒä¸€æ•°æ®ã€‚é‚£ä¹ˆï¼Œåœ¨ç¬¬ä¸€ä¸ªäº‹åŠ¡çš„ä¸¤æ¬¡è¯»æ•°æ®ä¹‹é—´ã€‚ç”±äºç¬¬äºŒä¸ªäº‹åŠ¡çš„ä¿®æ”¹ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªäº‹åŠ¡è¯»åˆ°çš„æ•°æ®å¯èƒ½ä¸ä¸€æ ·ï¼Œè¿™æ ·å°±å‘ç”Ÿäº†åœ¨ä¸€ä¸ªäº‹åŠ¡å†…ä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®æ˜¯ä¸ä¸€æ ·çš„ï¼Œå› æ­¤ç§°ä¸ºä¸å¯é‡å¤è¯»ï¼Œå³åŸå§‹è¯»å–ä¸å¯é‡å¤ã€‚\næ‰€è°“å¹»è¯»ï¼Œæ˜¯æŒ‡äº‹åŠ¡Aè¯»å–ä¸æœç´¢æ¡ä»¶ç›¸åŒ¹é…çš„è‹¥å¹²è¡Œã€‚äº‹åŠ¡Bä»¥æ’å…¥æˆ–åˆ é™¤è¡Œç­‰æ–¹å¼æ¥ä¿®æ”¹äº‹åŠ¡Açš„ç»“æœé›†ï¼Œç„¶åå†æäº¤ã€‚\nå¹»è¯»æ˜¯æŒ‡å½“äº‹åŠ¡ä¸æ˜¯ç‹¬ç«‹æ‰§è¡Œæ—¶å‘ç”Ÿçš„ä¸€ç§ç°è±¡ï¼Œä¾‹å¦‚ç¬¬ä¸€ä¸ªäº‹åŠ¡å¯¹ä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œæ¯”å¦‚è¿™ç§ä¿®æ”¹æ¶‰åŠåˆ°è¡¨ä¸­çš„â€œå…¨éƒ¨æ•°æ®è¡Œâ€ã€‚åŒæ—¶ï¼Œç¬¬äºŒä¸ªäº‹åŠ¡ä¹Ÿä¿®æ”¹è¿™ä¸ªè¡¨ä¸­çš„æ•°æ®ï¼Œè¿™ç§ä¿®æ”¹æ˜¯å‘è¡¨ä¸­æ’å…¥â€œä¸€è¡Œæ–°æ•°æ®â€ã€‚é‚£ä¹ˆï¼Œä»¥åå°±ä¼šå‘ç”Ÿæ“ä½œç¬¬ä¸€ä¸ªäº‹åŠ¡çš„ç”¨æˆ·å‘ç°è¡¨ä¸­è¿˜æœ‰æ²¡æœ‰ä¿®æ”¹çš„æ•°æ®è¡Œï¼Œå°±å¥½è±¡å‘ç”Ÿäº†å¹»è§‰ä¸€æ ·.ä¸€èˆ¬è§£å†³å¹»è¯»çš„æ–¹æ³•æ˜¯å¢åŠ èŒƒå›´é”RangeSï¼Œé”å®šæ£€é”èŒƒå›´ä¸ºåªè¯»ï¼Œè¿™æ ·å°±é¿å…äº†å¹»è¯»ã€‚\nç®€å•æ¥è¯´ï¼Œå¹»è¯»æ˜¯ç”±æ’å…¥æˆ–è€…åˆ é™¤å¼•èµ·çš„ã€‚\n","date":"2021-08-10T18:17:48Z","permalink":"https://dccmmtop.github.io/posts/mysql%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/","section":"posts","tags":["MySQL"],"title":"MySQLéš”ç¦»çº§åˆ«"},{"categories":null,"contents":"å¼€å¯æ…¢æ—¥å¿— åœ¨ MySQL ä¸­ï¼Œæ…¢æŸ¥è¯¢æ—¥å¿—é»˜è®¤ä¸ºOFFçŠ¶æ€ï¼Œé€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡ŒæŸ¥çœ‹ï¼š\nshow variables like \u0026quot;slow_query_log\u0026quot;;\né€šè¿‡å¦‚ä¸‹å‘½ä»¤è¿›è¡Œè®¾ç½®ä¸º ON çŠ¶æ€ï¼š\nset global slow_query_log = \u0026quot;ON\u0026quot;;\næ—¥å¿—å­˜å‚¨ä½ç½® å…¶ä¸­slow_query_log_fileå±æ€§ï¼Œè¡¨ç¤ºæ…¢æŸ¥è¯¢æ—¥å¿—å­˜å‚¨ä½ç½®ï¼Œå…¶æ—¥å¿—é»˜è®¤åç§°ä¸º host åç§°ã€‚\nå¦‚ä¸‹æ‰€ç¤ºï¼š\nshow variables like \u0026quot;slow_query_log_file\u0026quot;;\n+---------------------+----------------------------------------------+ | Variable_name | Value | +---------------------+----------------------------------------------+ | | slow_query_log_file | /usr/local/mysql/data/hostname.log | +---------------------+----------------------------------------------+ 2 rows in set (0.01 sec) ä¹Ÿå¯ä½¿ç”¨ ä»¥ä¸‹å‘½ä»¤è¿›è¡Œä¿®æ”¹ï¼š\nset global slow_query_log_file = ${path}/${filename}.log;\nè®¾ç½®é˜€å€¼ æ…¢æŸ¥è¯¢ æŸ¥è¯¢æ—¶é—´ï¼Œå½“SQLæ‰§è¡Œæ—¶é—´è¶…è¿‡è¯¥å€¼æ—¶ï¼Œåˆ™ä¼šè®°å½•åœ¨slow_query_log_file æ–‡ä»¶ä¸­ï¼Œå…¶é»˜è®¤ä¸º 10 ï¼Œæœ€å°å€¼ä¸º 0ï¼Œ(å•ä½ï¼š\nç§’)ã€‚\nmysql\u0026gt; show variables like \u0026#34;long_query_time\u0026#34;; +-----------------+-----------+ | Variable_name | Value | +-----------------+-----------+ | long_query_time | 10.000000 | +-----------------+-----------+ 1 row in set (0.00 sec) å¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤è¿›è¡Œä¿®æ”¹ï¼š\nmysql\u0026gt; set global long_query_time = 5; è®°å½•ä¸ºèµ°ç´¢å¼•çš„sql åœ¨ MySQL ä¸­ï¼Œè¿˜å¯ä»¥è®¾ç½®å°†æœªèµ°ç´¢å¼•çš„SQLè¯­å¥è®°å½•åœ¨æ…¢æ—¥å¿—æŸ¥è¯¢æ–‡ä»¶ä¸­(é»˜è®¤ä¸ºå…³é—­çŠ¶æ€)ã€‚é€šè¿‡ä¸‹è¿°å±æ€§å³å¯è¿›è¡Œè®¾ç½®ï¼š\nmysql\u0026gt; set global log_queries_not_using_indexes = \u0026#34;ON\u0026#34;; Query OK, 0 rows affected (0.00 sec) æ³¨æ„äº‹é¡¹ è®¾ç½®è¯¥å±æ€§åï¼Œåªè¦SQLæœªèµ°ç´¢å¼•ï¼Œå³ä½¿æŸ¥è¯¢æ—¶é—´å°äºlong_query_timeå€¼ï¼Œä¹Ÿä¼šè®°å½•åœ¨æ…¢SQLæ—¥å¿—æ–‡ä»¶ä¸­ã€‚ è¯¥è®¾ç½®ä¼šå¯¼è‡´æ…¢æ—¥å¿—å¿«é€Ÿå¢é•¿ï¼Œå¼€å¯å‰å»ºè®®æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶æ‰€åœ¨ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³ã€‚ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸å»ºè®®å¼€å¯è¯¥å‚æ•°ã€‚ è§£ææ—¥å¿—æ–‡ä»¶ æ…¢æŸ¥è¯¢æ—¥å¿—ä»¥#ä½œä¸ºèµ·å§‹ç¬¦ã€‚ User@Hostï¼šè¡¨ç¤ºç”¨æˆ· å’Œ æ…¢æŸ¥è¯¢æŸ¥è¯¢çš„ipåœ°å€ã€‚ å¦‚ä¸Šæ‰€è¿°ï¼Œè¡¨ç¤º rootç”¨æˆ· localhoståœ°å€ã€‚ Query_time: è¡¨ç¤ºSQLæŸ¥è¯¢æŒç»­æ—¶é—´ï¼Œ å•ä½ (ç§’)ã€‚ Lock_time: è¡¨ç¤ºè·å–é”çš„æ—¶é—´ï¼Œ å•ä½(ç§’)ã€‚ Rows_sent: è¡¨ç¤ºå‘é€ç»™å®¢æˆ·ç«¯çš„è¡Œæ•°ã€‚ Rows_examined: è¡¨ç¤ºï¼šæœåŠ¡å™¨å±‚æ£€æŸ¥çš„è¡Œæ•°ã€‚ set timestamp ï¼šè¡¨ç¤º æ…¢SQL è®°å½•æ—¶çš„æ—¶é—´æˆ³ã€‚ æ…¢sqlæ—¥å¿—åˆ†æå·¥å…·pt-query-digest ä¸‹è½½å®‰è£… yum install percona-toolkit-3.0.3-1.el7.x86_64.rpm ä¸‹è½½åœ°å€ï¼šhttps://www.percona.com/downloads/percona-toolkit/3.0.3/\næ¨èç”¨æ³• æŸ¥è¯¢ä¿å­˜åˆ°query_historyè¡¨æŸ¥çœ‹æ…¢sqlï¼Œæ•°æ®ç»“æ„æ¸…æ™°ï¼Œæ–¹ä¾¿åˆ†æï¼Œæ–¹ä¾¿ä¸å…¶ä»–ç³»ç»Ÿé›†æˆã€‚\npt-query-digest --user=root --password=epPfPHxY --history h=10.8.8.66,D=testDb,t=query_review--create-history-table mysql_slow.log --since \u0026#39;2020-10-01 09:30:00\u0026#39; --until \u0026#39;2020-10-21 18:30:00\u0026#39; å¸¸è§ç”¨æ³• ç›´æ¥åˆ†ææ…¢æŸ¥è¯¢æ–‡ä»¶\npt-query-digest slow.log \u0026gt; slow_report.log åˆ†ææŸä¸ªç”¨æˆ·çš„æ…¢sql\npt-query-digest \u0026ndash;filter \u0026lsquo;($event-\u0026gt;{user} || \u0026ldquo;\u0026rdquo;) =~ m/^root/i\u0026rsquo; slow.log\nåˆ†ææŸä¸ªæ•°æ®åº“çš„æ…¢sql\npt-query-digest \u0026ndash;filter \u0026lsquo;($event-\u0026gt;{db} || \u0026ldquo;\u0026rdquo;) =~ m/^sonar/i\u0026rsquo; slow.log\nåˆ†ææŸæ®µæ—¶é—´å†…çš„æ…¢sql pt-query-digest mysql_slow.log --since \u0026#39;2020-09-21 09:30:00\u0026#39; --until \u0026#39;2020-09-21 18:30:00\u0026#39; è¾“å‡ºç»“æœè¯´æ˜\nç¬¬ä¸€éƒ¨åˆ†ï¼šæ€»ä½“ç»Ÿè®¡ç»“æœ Overallï¼šæ€»å…±æœ‰å¤šå°‘æ¡æŸ¥è¯¢ Time rangeï¼šæŸ¥è¯¢æ‰§è¡Œçš„æ—¶é—´èŒƒå›´ uniqueï¼šå”¯ä¸€æŸ¥è¯¢æ•°é‡ï¼Œå³å¯¹æŸ¥è¯¢æ¡ä»¶è¿›è¡Œå‚æ•°åŒ–ä»¥åï¼Œæ€»å…±æœ‰å¤šå°‘ä¸ªä¸åŒçš„æŸ¥è¯¢ totalï¼šæ€»è®¡ minï¼šæœ€å° maxï¼šæœ€å¤§ avgï¼šå¹³å‡ 95%ï¼šæŠŠæ‰€æœ‰å€¼ä»å°åˆ°å¤§æ’åˆ—ï¼Œä½ç½®ä½äº95%çš„é‚£ä¸ªæ•°ï¼Œè¿™ä¸ªæ•°ä¸€èˆ¬æœ€å…·æœ‰å‚è€ƒä»·å€¼ medianï¼šä¸­ä½æ•°ï¼ŒæŠŠæ‰€æœ‰å€¼ä»å°åˆ°å¤§æ’åˆ—ï¼Œä½ç½®ä½äºä¸­é—´é‚£ä¸ªæ•° \u0026hellip;\u0026hellip;\n#è¯­å¥æ‰§è¡Œæ—¶é—´\n#é”å ç”¨æ—¶é—´\n#å‘é€åˆ°å®¢æˆ·ç«¯çš„è¡Œæ•°\n#selectè¯­å¥æ‰«æè¡Œæ•°\n#æŸ¥è¯¢çš„å­—ç¬¦æ•°\nç¬¬äºŒéƒ¨åˆ†ï¼šæŸ¥è¯¢åˆ†ç»„ç»Ÿè®¡ç»“æœ Rankï¼šæ‰€æœ‰è¯­å¥çš„æ’åï¼Œé»˜è®¤æŒ‰æŸ¥è¯¢æ—¶é—´é™åºæ’åˆ—ï¼Œé€šè¿‡--order-byæŒ‡å®š Query IDï¼šè¯­å¥çš„IDï¼Œï¼ˆå»æ‰å¤šä½™ç©ºæ ¼å’Œæ–‡æœ¬å­—ç¬¦ï¼Œè®¡ç®—hashå€¼ï¼‰ Responseï¼šæ€»çš„å“åº”æ—¶é—´ timeï¼šè¯¥æŸ¥è¯¢åœ¨æœ¬æ¬¡åˆ†æä¸­æ€»çš„æ—¶é—´å æ¯” callsï¼šæ‰§è¡Œæ¬¡æ•°ï¼Œå³æœ¬æ¬¡åˆ†ææ€»å…±æœ‰å¤šå°‘æ¡è¿™ç§ç±»å‹çš„æŸ¥è¯¢è¯­å¥ R/Callï¼šå¹³å‡æ¯æ¬¡æ‰§è¡Œçš„å“åº”æ—¶é—´ V/Mï¼šå“åº”æ—¶é—´Variance-to-meançš„æ¯”ç‡ Itemï¼šæŸ¥è¯¢å¯¹è±¡ ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¯ä¸€ç§æŸ¥è¯¢çš„è¯¦ç»†ç»Ÿè®¡ç»“æœ ç”±ä¸‹é¢æŸ¥è¯¢çš„è¯¦ç»†ç»Ÿè®¡ç»“æœï¼Œæœ€ä¸Šé¢çš„è¡¨æ ¼åˆ—å‡ºäº†æ‰§è¡Œæ¬¡æ•°ã€æœ€å¤§ã€æœ€å°ã€å¹³å‡ã€95%ç­‰å„é¡¹ç›®çš„ç»Ÿè®¡ã€‚ IDï¼šæŸ¥è¯¢çš„IDå·ï¼Œå’Œä¸Šå›¾çš„Query IDå¯¹åº” Databasesï¼šæ•°æ®åº“å Usersï¼šå„ä¸ªç”¨æˆ·æ‰§è¡Œçš„æ¬¡æ•°ï¼ˆå æ¯”ï¼‰ Query_time distribution ï¼šæŸ¥è¯¢æ—¶é—´åˆ†å¸ƒ, é•¿çŸ­ä½“ç°åŒºé—´å æ¯”ï¼Œæœ¬ä¾‹ä¸­1s-10sä¹‹é—´æŸ¥è¯¢æ•°é‡æ˜¯10sä»¥ä¸Šçš„ä¸¤å€ã€‚ Tablesï¼šæŸ¥è¯¢ä¸­æ¶‰åŠåˆ°çš„è¡¨ Explainï¼šSQLè¯­å¥ ","date":"2021-08-10T18:16:04Z","permalink":"https://dccmmtop.github.io/posts/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/","section":"posts","tags":["mysql"],"title":"mysqlæ…¢æ—¥å¿—"},{"categories":null,"contents":"å®‰è£… sudo apt-get install mysql-server mysql-client é…ç½®è¿œç¨‹å¯è¿æ¥ ä½ æƒ³myuserä½¿ç”¨mypasswordï¼ˆå¯†ç ï¼‰ä»ä»»ä½•ä¸»æœºè¿æ¥åˆ°mysqlæœåŠ¡å™¨çš„è¯ã€‚\nmysql\u0026gt;GRANT ALL PRIVILEGES ON *.* TO \u0026#39;ç”¨æˆ·å\u0026#39;@\u0026#39;%\u0026#39;IDENTIFIED BY \u0026#39;ä½ çš„å¯†ç \u0026#39; WITH GRANT OPTION; å¦‚æœä½ æƒ³å…è®¸ç”¨æˆ·myuserä»ipä¸º192.168.1.6çš„ä¸»æœºè¿æ¥åˆ°mysqlæœåŠ¡å™¨ï¼Œå¹¶ä½¿ç”¨mypasswordä½œä¸ºå¯†ç \nmysql\u0026gt;GRANT ALL PRIVILEGES ON *.* TO \u0026#39;ç”¨æˆ·å\u0026#39;@\u0026#39;192.168.1.3\u0026#39;IDENTIFIED BY \u0026#39;ä½ çš„å¯†ç \u0026#39; WITH GRANT OPTION; æœ€å\nmysql\u0026gt;FLUSH PRIVILEGES; ä½¿ä¿®æ”¹ç”Ÿæ•ˆï¼Œå°±å¯ä»¥äº†\nåœ¨è¿œç¨‹ä¸»æœºä¸Šå¼€æ”¾é˜²ç«å¢™ç«¯å£ sudo ufw allow 3306 æˆ–è€…å…³é—­é˜²ç«å¢™ï¼ˆä¸æ¨èï¼‰sudo ufw disable\nä¿®æ”¹mysqlé…ç½®æ–‡ä»¶ [mysqld] character-set-server = utf8 bind-address = 0.0.0.0 //ä¿®æ”¹ipåœ°å€ port = 3306 é…ç½®æ–‡ä»¶åœ¨/etc/mysql/mysql.conf.d/mysqld.cnf\né‡å¯mysqlæœåŠ¡ï¼šservice mysql restart\næŸ¥çœ‹å¤„äºç›‘å¬çš„æœåŠ¡çŠ¶æ€ï¼šsudo netstat -aptn\né˜¿é‡Œäº‘ä¸»æœº å¦‚æœä½ è¦è¿æ¥çš„è¿œç¨‹ä¸»æœºæ˜¯é˜¿é‡Œäº‘æœåŠ¡å™¨è¿˜éœ€è¦é…ç½®å®‰å…¨ç»„è§„åˆ™ï¼ï¼ï¼\nå¼€æ”¾å…¥å£ï¼Œç«¯å£ä¸º3306/3306 ä¼˜å…ˆçº§1 è¿œç¨‹è®¿é—®åœ°å€ï¼š0.0.0.0/0 ç‚¹å‡»ä¿å­˜\n","date":"2021-08-10T18:12:14Z","permalink":"https://dccmmtop.github.io/posts/ubuntu%E5%AE%89%E8%A3%85mysql%E5%8F%8A%E9%85%8D%E7%BD%AE%E8%BF%9C%E7%A8%8B%E8%AE%BF%E9%97%AE/","section":"posts","tags":["MySQL"],"title":"Ubuntu å®‰è£… mysql åŠé…ç½®è¿œç¨‹è®¿é—®"},{"categories":null,"contents":"GoAccessçš„å¤šç§å±•ç¤ºæ–¹å¼\ngoaccessæœ‰å¤šç§æ•°æ®å¯è§†åŒ–çš„æ–¹å¼,åˆ†åˆ«ä¸º:\nå‘½ä»¤è¡Œè¾“å‡ºæ ¼å¼åŒ–æ•°æ®\nåˆ©ç”¨access.logç”Ÿæˆé™æ€çš„å¯è§†åŒ–æ•°æ®\nç”Ÿæˆå®æ—¶å¯è§†åŒ–æ•°æ®\næ³¨æ„ï¼Œå¦‚æœæ˜¯ç¼–è¯‘å®‰è£…ä¸”é€‰æ‹©äº† â€“enable-geoip=mmdbçš„è¯éœ€è¦ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œå¹¶åœ¨ä½¿ç”¨å‘½ä»¤çš„æ—¶å€™å¸¦ä¸Šå‚æ•° â€“config-file=/usr/local/etc/goaccess/goaccess.confï¼Œå¦‚æœæ˜¯ç”¨åŒ…ç®¡ç†å™¨å®‰è£…çš„è¯åˆ™ä¸éœ€è¦\nå‘½ä»¤è¡Œè¾“å‡ºGoAccess\ngoaccess /var/log/nginx/access.log -cï¼Œä¼šå…ˆè¯¢é—®ä½ æ•°æ®çš„æ ¼å¼ï¼Œæˆ‘è¿™é‡Œçš„æ—¥å¿—ä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ç§ã€‚\nè§£æaccesslogç”Ÿæˆé™æ€html\nGoAccessè¿˜å¯ä»¥è§£æaccess.logç”Ÿæˆé™æ€htmlï¼Œä»¥æ›´åŠ ç›´è§‚çš„æ–¹å¼æ¥å±•ç¤ºæ•°æ®ã€‚\ngoaccess /var/log/nginx/access.log -o report.html \u0026ndash;log-format=COMBINEDï¼Œä¹‹åå†ä½¿ç”¨æµè§ˆå™¨è®¿é—®report.htmlå³å¯æŸ¥çœ‹æŠ¥å‘Šï¼Œå„ç§æ•°æ®ä¸€åº”ä¿±å…¨ã€‚\nå®æ—¶è§£æè®¿é—®æ—¥å¿—\nGoAccessé™¤äº†å¯ä»¥ç”Ÿæˆé™æ€çš„htmlæ–‡ä»¶ï¼Œè¿˜å¯ä»¥ç”Ÿæˆå®æ—¶ç½‘ç«™è®¿é—®æ•°æ®ï¼\ngoaccess /var/log/nginx/access.log -o /var/www/html/report.html \u0026ndash;log-format=COMBINED \u0026ndash;real-time-html \u0026ndash;config-file=/usr/local/etc/goaccess/goaccess.conf\næ·»åŠ ä¸­æ–‡æ”¯æŒ\nGoaccess 1.3ä¹‹åçš„ç‰ˆæœ¬æä¾›äº†å¤šè¯­è¨€æ”¯æŒï¼Œå…ˆåœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ apt install language-pack-zh-hans å®‰è£…ä¸­æ–‡åŒ…ï¼Œå†ä½¿ç”¨export LANG=zh_CN.UTF-8ä¿®æ”¹ç¯å¢ƒå˜é‡ï¼Œå†æ¬¡ä½¿ç”¨ goaccess /var/log/nginx/access.log -o /var/www/html/report.html \u0026ndash;log-format=COMBINED \u0026ndash;real-time-html \u0026ndash;config-file=/usr/local/etc/goaccess/goaccess.confå¯åŠ¨GoAccesså¯ä»¥å‘ç°å·²ç»æ˜¯ä¸­æ–‡ç•Œé¢äº†ã€‚\nå…³äºå®æ—¶æ¨¡å¼ï¼Œå¯ä»¥æŸ¥çœ‹å®˜ç½‘çš„demo https://rt.goaccess.io/?20200209201008\nå¼‚å¸¸é€€å‡º\nå¦‚æœå®æ—¶æ¨¡å¼æ²¡æœ‰æ­£å¸¸é€€å‡ºï¼Œå¯èƒ½æ— æ³•å†æ¬¡æ­£å¸¸å¯åŠ¨ï¼ŒGoAccessé»˜è®¤ä½¿ç”¨7890 websocketç«¯å£ï¼Œæ‰€ä»¥ä½¿ç”¨lsof -i:7890æŸ¥çœ‹å ç”¨è¯¥ç«¯å£çš„è¿›ç¨‹å·å¹¶killå³å¯ã€‚\nsslæ”¯æŒ\nå¦‚æœéœ€è¦åœ¨åŠ å¯†è¿æ¥ä¸Šè¾“å‡ºå®æ—¶æ•°æ®ï¼Œåˆ™éœ€è¦ä½¿ç”¨ \u0026ndash;ssl-cert= å’Œ \u0026ndash;ssl-key=,æˆ‘åœ¨è®¾ç½®ä¹‹åè®¿é—®report.htmlå‘ç°æ•°æ®ä¾æ—§æ˜¯é™æ€çš„ï¼Œçªç„¶æƒ³èµ·æˆ‘ç”¨äº†cloudflare cdnï¼Œè€Œ7890ç«¯å£å¹¶ä¸åœ¨cloudflareçš„æ”¯æŒç«¯å£åˆ—è¡¨é‡Œé¢ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨å‚æ•° \u0026ndash;ws-url=wss://æœåŠ¡å™¨åŸŸå(æˆ‘ä»¬çš„æµè§ˆå™¨ä¼šå°è¯•ä¸è¯¥åŸŸåçš„8443ç«¯å£è§äº†wsè¿æ¥):8443 \u0026ndash;port=8443 æŠŠç«¯å£æ”¹æˆäº†8443ã€‚ä»¤äººæ²¡æƒ³åˆ°çš„æ˜¯ï¼Œæ­¤æ—¶çš„report.htmlä½¿ç”¨ä»£ç†é“¾æ¥çš„æ—¶å€™æ˜¯å¯ä»¥è¿æ¥çš„ï¼Œå¹¶å¯ä»¥æŸ¥çœ‹å®æ—¶ä¿¡æ¯ï¼Œè€Œç›´æ¥è¿æ¥çš„æ—¶å€™ä¾æ—§æ˜¯é™æ€æ•°æ®ï¼Œtcpingä¸€çœ‹ã€‚\nå»cloudflareçš„å®˜ç½‘å¯ä»¥å‘ç°å¦‚ä¸‹å†…å®¹\nåªæœ‰ç«¯å£ 80 å’Œ 443 å¯å…¼å®¹ä»¥ä¸‹æœåŠ¡ï¼š\nå¯¹äºå¯ç”¨äº†ä¸­å›½ç½‘ç»œçš„åŸŸåçš„ä¸­å›½å¢ƒå†…æ•°æ®ä¸­å¿ƒ HTTP/HTTPS æµé‡ï¼Œ\nä¹Ÿå°±æ˜¯è¯´ï¼Œå›½å†…æ˜¯æ²¡åŠæ³•é€šè¿‡cloudflareè¿æ¥é80/443ç«¯å£çš„â€¦\nåå‘ä»£ç†\nä½†æ˜¯ä¹Ÿä¸æ˜¯æ²¡æœ‰åŠæ³•è¿æ¥ï¼Œæœ€åæˆ‘æƒ³åˆ°äº†åå‘ä»£ç†çš„æ–¹æ¡ˆã€‚\nå°†å¯åŠ¨å‚æ•°æ”¹ä¸º\u0026ndash;ws-url=wss://ä½ çš„åŸŸå.com/goaccess \u0026ndash;port=7890\nä¿®æ”¹nginxç«™ç‚¹é…ç½®æ–‡ä»¶ /etc/nginx/site-available/default,æ·»åŠ ä¸‹é¢å†…å®¹\nlocation /goaccess {\rproxy_redirect off;\rproxy_pass https://127.0.0.1:7890;\rproxy_http_version 1.1;\rproxy_set_header Upgrade $http_upgrade;\rproxy_set_header Connection \u0026quot;upgrade\u0026quot;;\rproxy_set_header Host $http_host;\r}\ræ³¨æ„ï¼Œå¦‚æœä½ çš„ç«™ç‚¹é…ç½®æ–‡ä»¶é‡Œé¢å¼€å¯äº†urlé‡å†™ï¼Œä¸ºäº†é¿å… /goaccess å—åˆ°å½±å“ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¯¥è·¯å¾„æ’é™¤é‡å†™ã€‚\næŠŠé‡å†™è§„åˆ™éƒ½æ”¾åˆ°location / é‡Œé¢å» location / { if (-f $request_filename/index.html){ rewrite (.*) $1/index.html break; } if (-f $request_filename/index.php){ rewrite (.*) $1/index.php; } if (!-f $request_filename){ rewrite (.*) /index.php; } } #ä¸‹é¢ä»€ä¹ˆéƒ½ä¸éœ€è¦åš\nlocation /goaccess/ { } ä¹‹åé‡å¯nginxï¼Œå†è®¿é—®report.htmlï¼Œå‘ç°å·¦è¾¹é½¿è½®å¤„ç»ˆäºæ˜¾ç¤ºconnectäº†ã€‚\nå¦‚æœä½ åªæ˜¯è‡ªå·±çœ‹æˆ–è€…ä¸åœ¨æ„ipæš´éœ²ï¼Œå…¶å®ç›´æ¥ä½¿ç”¨ipç›´æ¥è¿æ¥ä¸èµ°cdnå°±æ²¡é‚£ä¹ˆéº»çƒ¦äº†ã€‚\n","date":"2021-08-10T18:10:24Z","permalink":"https://dccmmtop.github.io/posts/%E5%88%86%E6%9E%90nginx%E6%97%A5%E5%BF%97/","section":"posts","tags":["nginx"],"title":"åˆ†ænginxæ—¥å¿—"},{"categories":null,"contents":"ç°åœ¨æœ‰éœ€æ±‚ï¼Œæƒ³è¦å¼€æœºå°±è¿è¡Œä¸€äº›ä¸œè¥¿ï¼Œæ–¹æ³•æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯æ¡Œé¢çº§çš„å¯åŠ¨ï¼Œä¸€ä¸ªæ˜¯ç³»ç»Ÿçº§çš„å¯åŠ¨\næ¡Œé¢çº§åˆ«ï¼Œå°±æ˜¯è¿›å…¥æ¡Œé¢åï¼Œè‡ªåŠ¨æ‰“å¼€ä¸€äº›è½¯ä»¶\nç³»ç»Ÿçº§åˆ«å°±æ˜¯å†æ²¡æœ‰è¿›å…¥æ¡Œé¢å°±è¿è¡Œä¸€äº›ä¸œè¥¿ã€‚\nå…ˆè°ˆæ¡Œé¢çº§çš„ï¼Œæ¯”å¦‚ gnomeï¼Œå¯åŠ¨ gnome-tweak å·¥å…·å°±å¯ä»¥çœ‹åˆ°å¼€æœºå¯åŠ¨é¡¹ç›®ï¼Œæ·»åŠ è¿›å»å³å¯ã€‚\nç³»ç»Ÿçº§åˆ«çš„ï¼Œæˆ‘è§‰å¾—æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯åˆ›å»º systemctl çš„ service è„šæœ¬ã€‚è¿™ä¸ªè„šæœ¬æ”¾ä»€ä¹ˆä½ç½®å‘¢ï¼Ÿ\næˆ‘ä»¬è¿è¡Œä¸€ä¸ªå‘½ä»¤å°±çœ‹åˆ°äº†ï¼š\n$ systemctl enable sshd Created symlink /etc/systemd/system/multi-user.target.wants/sshd.service â†’ /usr/lib/systemd/system/sshd.service. æˆ‘ä»¬å¼€èµ·æ¥ sshd æœåŠ¡ï¼Œæ˜¾ç¤ºå‡ºæ¥ service çš„ä½ç½®ï¼Œæˆ‘ä»¬æ¨¡ä»¿è¿™ä¸ªåšä¸€ä¸ªå¼€æœºå¯åŠ¨å‡ºæ¥ã€‚\nè¿˜è®°å¾—å¾ˆæ—©çš„ linux ä¸­æœ‰ä¸€ä¸ª rc.local ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆéœ€è¦å¼€æœºå¯åŠ¨çš„è„šæœ¬ç›´æ¥ä¸¢è¿›å»å°±è¡Œäº†ã€‚\nå‡çº§åˆ°äº†systemd ä¹‹åï¼Œè¿™ä¸ªç©æ„å°±æ¶ˆå¤±äº†ï¼Œæˆ‘ä»¬å°è¯•æ¢å¤ä»–ã€‚\nå…ˆå»ºç«‹ä¸€ä¸ª rc-local.serviceï¼Œ sudo vim /usr/lib/systemd/system/rc-local.service ç„¶åï¼Œæˆ‘ä»¬æ¨¡ä»¿å…¶ä»–çš„ service ï¼Œæ¥å†™ä¸€ä¸‹ï¼š\n[Unit]\rDescription=\u0026#34;/etc/rc.local Compatibility\u0026#34; #Wants=sshdgenkeys.service\r#After=sshdgenkeys.service\r#After=network.target\r[Service]\rType=forking\rExecStart=/etc/rc.local start\rTimeoutSec=0\rStandardInput=tty\rRemainAfterExit=yes\rSysVStartPriority=99\r[Install]\rWantedBy=multi-user.target ç„¶åï¼Œæˆ‘ä»¬åˆ›å»º /etc/rc.local æ–‡ä»¶ï¼š sudo touch /etc/rc.local sudo chmod +x /etc/rc.local è®¾ç½® rc.local å¼€æœºè‡ªå¯ sudo systemctl enable rc-local.service ","date":"2021-08-10T17:55:56Z","permalink":"https://dccmmtop.github.io/posts/arch%E6%B7%BB%E5%8A%A0rc.local%E5%AE%9E%E7%8E%B0%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF/","section":"posts","tags":["linux"],"title":"archæ·»åŠ rc.local å®ç°å¼€æœºè‡ªå¯"},{"categories":null,"contents":"ç¬”è®°æœ¬å¯ä»¥åŒæ—¶è¿æ¥æ— çº¿å’Œæœ‰çº¿ï¼Œå¦‚æœå¯ä»¥æŒ‡å®šå“ªäº›ipä½¿ç”¨æ— çº¿ï¼Œå“ªäº›ipåœ°å€å¯ä»¥ä½¿ç”¨æœ‰çº¿ï¼Œ\nå‡è®¾æ— çº¿è¿æ¥çš„æ˜¯å†…ç½‘ï¼Œ æœ‰çº¿è¿æ¥çš„æ˜¯å¤–ç½‘ï¼Œå¯ä»¥è®¾ç½®é™æ€è·¯ç”±ï¼Œä½¿è®¿é—®ä¸åŒçš„åœ°å€ä½¿ç”¨ä¸åŒçš„ç½‘ç»œ\né¦–å…ˆç¡®å®š æœ¬æœº æ— çº¿å’Œæœ‰çº¿ çš„ç½‘å…³ï¼š sudo ip route show å¦‚ä¸Šå›¾ wlp3s0 æ˜¯æˆ‘çš„æ— çº¿è®¾å¤‡ï¼Œenp0s20f0u1 æ˜¯æœ‰çº¿è®¾å¤‡ï¼Œ å¯ä»¥æŠŠç½‘çº¿æ‹”äº†æ¥ç¡®å®šå“ªä¸ªæ˜¯ä»€ä¹ˆè®¾å¤‡\næ— çº¿è®¾å¤‡ä½¿ç”¨ 192.168.1.1 ä½œä¸ºç½‘å…³\næœ‰çº¿è®¾å¤‡ä½¿ç”¨ 192.168.42.129 ä½œä¸ºç½‘å…³\nè®¾ç½®è·¯ç”± å‡è®¾ æŸå…¬å¸çš„å†…ç½‘éƒ½æ˜¯ 10 å¼€å¤´çš„ï¼Œ\nip route add 10.0.0.0/8 via 192.168.1.1 dev wlp3s0 10.0.0.0/8 æ˜¯DICPè¡¨ç¤ºæ³•ï¼Œä¸æ‡‚å¯ä»¥ä½¿ç”¨ ç«™é•¿å·¥å…· è®¡ç®—\næ­¤æ—¶åœ¨ä½¿ç”¨ sudo ip route show æŸ¥çœ‹è·¯ç”±è¡¨\næ°¸ä¹…ç”Ÿæ•ˆ ä¸Šè¿°æ–¹æ³•åªèƒ½ä¸´æ—¶ç”Ÿæ•ˆï¼Œå¯ä»¥å†™æˆè„šæœ¬å¼€æœºè‡ªå¯arch æ·»åŠ rc.local å®ç°å¼€æœºè‡ªå¯\næœ¬æ–¹æ³•å·²åœ¨ arch ä¸­éªŒè¯ å…¶ä»–ç³»ç»Ÿ å¤§åŒå°å¼‚ï¼Œå¯»æ‰¾ ä»£æ›¿ ip route çš„å‘½ä»¤å³å¯\nwin ä¸‹è®¾ç½®æ–¹æ³• ä½¿ç”¨ç®¡ç†å‘˜æ‰“å¼€ powershell\nipconfig æŸ¥çœ‹ä¼˜å…ˆå’Œæ— çº¿çš„ç½‘å…³\nroute -p add 40.0.0.0 mask 255.0.0.0 192.168.2.1 æ·»åŠ  40 å¼€å¤´çš„ip èµ°å†…ç½‘\nroute -p add 10.0.0.0 mask 255.0.0.0 192.168.2.1 æ·»åŠ  10 å¼€å¤´çš„ip èµ°å†…ç½‘\n","date":"2021-08-10T17:50:41Z","permalink":"https://dccmmtop.github.io/posts/%E5%90%8C%E6%97%B6%E8%BF%9E%E6%8E%A5%E5%86%85%E7%BD%91%E5%92%8C%E5%A4%96%E7%BD%91/","section":"posts","tags":["linux"],"title":"åŒæ—¶è¿æ¥å†…ç½‘å’Œå¤–ç½‘"},{"categories":null,"contents":"Gité…ç½®å¤šä¸ªSSH-Key å½“æœ‰å¤šä¸ªgitè´¦å·æ—¶ï¼Œæ¯”å¦‚ï¼š\na. ä¸€ä¸ªgiteeï¼Œç”¨äºå…¬å¸å†…éƒ¨çš„å·¥ä½œå¼€å‘ï¼›\nb. ä¸€ä¸ªgithubï¼Œç”¨äºè‡ªå·±è¿›è¡Œä¸€äº›å¼€å‘æ´»åŠ¨ï¼›\nè§£å†³æ–¹æ³•\nç”Ÿæˆä¸€ä¸ªå…¬å¸ç”¨çš„SSH-Key\n$ ssh-keygen -t rsa -C \u0026#39;xxxxx@company.com\u0026#39; -f ~/.ssh/gitee_id_rsa ç”Ÿæˆä¸€ä¸ªgithubç”¨çš„SSH-Key\n$ ssh-keygen -t rsa -C \u0026#39;xxxxx@qq.com\u0026#39; -f ~/.ssh/github_id_rsa åœ¨ ~/.ssh ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªconfigæ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼ˆå…¶ä¸­Hostå’ŒHostNameå¡«å†™gitæœåŠ¡å™¨çš„åŸŸåï¼ŒIdentityFileæŒ‡å®šç§é’¥çš„è·¯å¾„ï¼‰\n# gitee Host gitee.com HostName gitee.com PreferredAuthentications publickey IdentityFile ~/.ssh/gitee_id_rsa # github Host github.com HostName github.com PreferredAuthentications publickey IdentityFile ~/.ssh/github_id_rsa ç”¨sshå‘½ä»¤åˆ†åˆ«æµ‹è¯•\n$ ssh -T git@gitee.com $ ssh -T git@github.com ","date":"2021-08-10T17:50:06Z","permalink":"https://dccmmtop.github.io/posts/git%E7%94%9F%E6%88%90%E5%85%AC%E9%92%A5/","section":"posts","tags":["git"],"title":"gitç”Ÿæˆå…¬é’¥"},{"categories":null,"contents":"docSet æ–‡æ¡£å¯ç”¨äº zeal dash è½¯ä»¶ä¸­ã€‚ zeal åœ¨win ä¸‹ å’Œ Linux å‡æœ‰å¯ç”¨ç‰ˆæœ¬ dash åˆ™åªåœ¨ Mac å¯ç”¨\nåˆ¶ä½œ dcocSet æ–‡æ¡£ä¸»è¦åˆ† 3 æ­¥\né•œåƒæ–‡æ¡£ç½‘ç«™ åšé•œåƒç½‘ç«™å°±æ˜¯æŠŠæ•´ä¸ªç½‘ç«™çˆ¬ä¸‹æ¥ï¼Œå¹¶ä¸”æŠŠ css å’Œ js å›¾ç‰‡ç­‰é™æ€èµ„æºæ–‡ä»¶è½¬æ¢æˆæœ¬åœ°çš„è·¯å¾„ï¼Œ ä¸»è¦ä½¿ç”¨å·¥å…·æ˜¯ wget\nä»¥ vue ä¸­æ–‡æ–‡æ¡£ ä¸ºä¾‹:\nwget -r -p -np -k https://cn.vuejs.org/ åˆ¶ä½œç´¢å¼•æ–‡ä»¶ zeal å¯ä»¥å¿«é€Ÿçš„æœç´¢æ–‡æ¡£ä¸»è¦åˆ©ç”¨äº† sqlite æ•°æ®åº“ï¼Œåœ¨æ•°æ®åº“ä¸­æœ‰ä¸€å¼  serchIndex è¡¨ï¼Œ è¿™å¼ è¡¨å¸¸ç”¨çš„å­—æ®µæœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«æ˜¯ name , type, path\nname\nå…³é”®è¯\ntype\nå…³é”®è¯çš„ç±»å‹ï¼Œä»£è¡¨è¯¥å…³é”®è¯æ˜¯å‡½æ•°ï¼Œè¿˜æ˜¯ç±»ï¼Œç­‰ç­‰å¯é€‰çš„å­—æ®µæœ‰ Sections, Fun, classes\npath\nç‚¹å‡»å…³é”®è¯è¦è·³è½¬çš„è·¯å¾„\næ‰€ä»¥ï¼Œå…³é”®æ˜¯åˆ¶ä½œä¸€ä¸ªè¿™ç§åˆç†çš„ç´¢å¼•è¡¨\nä¸‹é¢æ˜¯ä½¿ç”¨ ruby å®ç°åˆ¶ä½œç´¢å¼•è¡¨çš„åŠŸèƒ½ï¼Œä»¥åŠä¸€äº›ç›®å½•çš„ç”Ÿæˆ\nrequire \u0026#39;nokogiri\u0026#39; require \u0026#34;sqlite3\u0026#34; require \u0026#34;fileutils\u0026#34; class HtmlToDoc def initialize(html_dir, docset_name) @html_path = html_dir @docset_name = \u0026#34;#{docset_name}.docset\u0026#34; @name = docset_name mkdir_file create_plist @con = SQLite3::Database.new(@dsidx) @con.execute(\u0026#34;CREATE TABLE IF NOT EXISTS searchIndex(id INTEGER PRIMARY KEY, name TEXT, type TEXT, path TEXT)\u0026#34;); end # æ’å…¥æ•°æ® def update_db(name, path, type = \u0026#39;Classes\u0026#39;) @con.execute(\u0026#39;INSERT OR IGNORE INTO searchIndex(name, type, path) VALUES (?,?,?)\u0026#39;,[name,type,path]) puts name,path end # æå–urlï¼Œæ ¹æ®ä½ çš„éœ€æ±‚æ›´æ”¹æå–è§„åˆ™ def add_urls(html_path) doc = Nokogiri::HTML(File.open(html_path).read) doc.css(\u0026#34;h3\u0026gt;a\u0026#34;).each do |tag| name = tag.parent.text.strip if name.size \u0026gt; 0 \u0026amp;\u0026amp; tag[:href] path = tag[:href].strip.split(\u0026#34;#\u0026#34;).last update_db(name,html_path + \u0026#34;#\u0026#34; + path) end end end # ç”Ÿæˆç›®å½• def mkdir_file FileUtils.rm_r(@docset_name) if File.exists?(@docset_name) @doc_dir = \u0026#34;#{@docset_name}/Contents/Resources/Documents\u0026#34; FileUtils.mkdir_p(@doc_dir) @dsidx = \u0026#34;#{@docset_name}/Contents/Resources/docSet.dsidx\u0026#34; FileUtils.touch(@dsidx) @plist = \u0026#34;#{@docset_name}/Contents/info.plist\u0026#34; FileUtils.touch(@plist) puts \u0026#34;ç›®å½•åˆ›å»ºæˆåŠŸ\u0026#34; end # åˆ¶ä½œplist æ–‡ä»¶ # å„ç§key çš„æ„æ€è¯·å‚è€ƒ dash å®˜æ–¹æ–‡æ¡£ def create_plist plist = \u0026lt;\u0026lt;-EOF \u0026lt;?xml version=\u0026#34;1.0\u0026#34; encoding=\u0026#34;UTF-8\u0026#34;?\u0026gt; \u0026lt;!DOCTYPE plist PUBLIC \u0026#34;-//Apple//DTD PLIST 1.0//EN\u0026#34; \u0026#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd\u0026#34;\u0026gt; \u0026lt;plist version=\u0026#34;1.0\u0026#34;\u0026gt; \u0026lt;dict\u0026gt; \u0026lt;key\u0026gt;CFBundleIdentifier\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;#{@name}\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;CFBundleName\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;#{@name}\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;DashDocSetFamily\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;#{@name}\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;DocSetPlatformFamily\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;requests\u0026lt;/string\u0026gt; \u0026lt;key\u0026gt;isDashDocset\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;isJavaScriptEnabled\u0026lt;/key\u0026gt; \u0026lt;true/\u0026gt; \u0026lt;key\u0026gt;dashIndexFilePath\u0026lt;/key\u0026gt; \u0026lt;string\u0026gt;#{@name}\u0026lt;/string\u0026gt; \u0026lt;/dict\u0026gt; \u0026lt;/plist\u0026gt; EOF File.open(@plist,\u0026#34;w\u0026#34;).write(plist) end # ç§»åŠ¨æ–‡æ¡£ def copy_files FileUtils.cp_r(@html_path.split(\u0026#34;/\u0026#34;).first, @doc_dir) # å°†docSet æ–‡æ¡£ç§»åŠ¨åˆ° zeal ç›®å½•ä¸‹ # local_doc_dir = \u0026#34;/home/dccmmtop/.local/share/Zeal/Zeal/docsets\u0026#34; # FileUtils.cp_r(@docset_name, local_doc_dir) end def start Dir.open(@html_path).each do |file| next unless file =~ /.html$/ add_urls(File.join(@html_path, file)) end copy_files end end if ARGV[0] == \u0026#34;-h\u0026#34; puts \u0026#39;ruby ./convert.rb \u0026#34;è¦ç”Ÿæˆæ–‡æ¡£çš„htmlåœ°å€(è¦åŒ…å«æ•´ä¸ªç½‘ç«™çš„æ ¹ç›®å½•)\u0026#34; \u0026#34;ç”Ÿæˆæ–‡æ¡£çš„åå­—\u0026#34;\u0026#39; puts \u0026#34;ä¾‹å­ï¼š ruby convert.rb cn.vuejs.org/v2/guide vue\u0026#34; else HtmlToDoc.new(ARGV[0],ARGV[1]).start end ç§»åŠ¨docSetç›®å½• æœ€åå°† åˆ¶ä½œå¥½çš„ docSet æ–‡ä»¶å¤¹ç§»åŠ¨åˆ° zeal çš„æ–‡æ¡£ç›®å½•ä¸‹, ä¹Ÿå¯ä»¥å°†ä¸Šé¢è„šæœ¬ä¸­ copy_files æ–¹æ³•æœ€åä¸¤è¡Œå»æ‰\n","date":"2021-08-10T17:33:16Z","permalink":"https://dccmmtop.github.io/posts/%E5%88%B6%E4%BD%9Cdocset%E6%96%87%E6%A1%A3/","section":"posts","tags":["linux"],"title":"åˆ¶ä½œdocSetæ–‡æ¡£"},{"categories":null,"contents":"git åº“ä¸­å·²ç»æœ‰æ–‡ä»¶è¢«è·Ÿè¸ªï¼Œå¦‚ä½•å¿½ç•¥æœ¬åœ°æ”¹åŠ¨åçš„è·Ÿè¸ª\næ”¾å…¥åˆ°.gitinore å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨ï¼Œè¿˜æ˜¯ä¼šæ˜¾ç¤ºæ”¹åŠ¨ï¼Œæ˜¯å¦è¦æäº¤ï¼Œçœ‹ç€å¾ˆçƒ¦\nå¿½ç•¥æœ¬åœ°æ–‡ä»¶ï¼Œä¸”ä¸ä¼šå¯¹çº¿ä¸Šåº“é‡Œçš„æ–‡ä»¶é€ æˆå½±å“ï¼Œæ‰§è¡Œæ­¤å‘½ä»¤:\ngit update-index --assume-unchanged filename\nå¦‚æœæƒ³æ’¤é”€å¿½ç•¥ï¼Œæäº¤æ­¤æ–‡ä»¶çš„æ”¹åŠ¨ï¼Œæ‰§è¡Œæ­¤å‘½ä»¤ï¼š\ngit update-index --no-assume-unchanged filename\nå¦‚æœå¿½ç•¥çš„æ–‡ä»¶å¤šäº†ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹å¿½ç•¥åˆ—è¡¨\ngit uls-files -v | grep '^h\\ '\næå–æ–‡ä»¶è·¯å¾„ï¼Œæ–¹æ³•å¦‚ä¸‹\ngit ls-files -v | grep '^h\\ ' | awk '{print $2}'\næ‰€æœ‰è¢«å¿½ç•¥çš„æ–‡ä»¶ï¼Œå–æ¶ˆå¿½ç•¥çš„æ–¹æ³•ï¼Œå¦‚ä¸‹\ngit ls-files -v | grep '^h' | awk '{print $2}' |xargs git update-index --no-assume-unchanged ","date":"2021-08-10T17:10:57Z","permalink":"https://dccmmtop.github.io/posts/%E5%BF%BD%E7%95%A5%E6%94%B9%E5%8A%A8/","section":"posts","tags":["git"],"title":"å¿½ç•¥æ”¹åŠ¨"},{"categories":null,"contents":"ä¸ºä»€ä¹ˆè¦ä½¿ç”¨tmux? å¯¹æˆ‘ä¸ªäººè€Œè¨€ï¼Œtmux å¯¹æˆ‘æœ€å¤§çš„å¸å¼•åŠ›å°±æ˜¯ å¤šçª—å£ï¼Œä»¥åŠä¼šè¯çš„ä¿æŒä¸æ¢å¤ï¼Œæˆ‘å¯ä»¥å¾ˆæ–¹ä¾¿çš„åˆ‡æ¢çª—å£ï¼Œä»¥åŠå¿«é€Ÿæ¢å¤å·¥ä½œç¯å¢ƒ\nå®‰è£… æˆ‘ä½¿ç”¨çš„æ˜¯æºç å®‰è£…ï¼Œ\nä¸‹è½½æºç  ä¸‹è½½é“¾æ¥ è§£å‹ è¿›å…¥åˆ°è§£å‹ç›®å½•ï¼Œæ‰§è¡Œ ./configure --prefix=/usr/local/tmux3.1c \u0026amp;\u0026amp; make ç„¶åæ‰§è¡Œ sudo make install\næˆ‘ä¸ªäººå–œæ¬¢æŒ‡å®šç›®å½•ï¼Œæ–¹ä¾¿æ—¥åå¸è½½ï¼Œæˆ–åˆ‡æ¢ç‰ˆæœ¬,ä¸­é—´å¯èƒ½ä¼šæœ‰ç¼ºå°‘ä¾èµ–åŒ…çš„é”™è¯¯ï¼Œæ ¹æ®é”™è¯¯æç¤ºä¿¡æ¯å–ç½‘ä¸Šæœç´¢å¯¹åº”çš„åŒ…å®‰è£…å³å¯ï¼Œå…¶å®linuxå‘å±•åˆ°ç°åœ¨ï¼Œå¾ˆå¤šé”™è¯¯æç¤ºä¿¡æ¯éƒ½éå¸¸è¯¦ç»†ï¼Œè‹±è¯­ä¸å¥½çš„å¯ä»¥ç¿»è¯‘ä¸‹ï¼Œå°±çŸ¥é“å¤±è´¥çš„åŸå› äº†ï¼Œæœ‰æ—¶åè€Œæ¯”ç›´æ¥å¤åˆ¶é”™è¯¯ä¿¡æ¯å–ç½‘ä¸Šæœç´¢å¿«çš„å¤šã€‚ æ­¤æ—¶å·²ç»å®‰è£…å®Œæ¯•ï¼Œå¯æ‰§è¡Œæ–‡ä»¶åœ¨ /usr/lcoal/tmux3.1c/bin/tmux, å¯ä»¥åœ¨ /usr/bin/ ä¸‹åˆ›å»º tmux çš„è½¯é“¾ï¼Œæˆ–è€…ç›´æ¥åœ¨ ~/.bash_profile æ–‡ä»¶ä¸­ç¼–å†™ alias tmux='/usr/local/tmux3.1c/tmux' ç„¶ååœ¨ç»ˆç«¯æ‰§è¡Œ\nsource ~/.bash_profile å°±å¯ä»¥è®©é…ç½®æ–‡ä»¶ç”Ÿæ•ˆäº†ã€‚ é…ç½®åŠå®‰è£…æ’ä»¶ ä¸‹é¢æ˜¯æˆ‘çš„é…ç½®æ–‡ä»¶,ä»¥åŠè¯´æ˜\n##-- bindkeys --# ### ä¿®æ”¹å‰ç¼€é”®ä¸º ctrl a set -g prefix ^a unbind ^b bind a send-prefix # çª—å£åˆ‡æ¢ æˆ‘è®¾ç½®çš„é”®ä½å’Œ vim ç›¸é€š # ctrl + j ä¸Šä¸€ä¸ªçª—å£ bind -n C-j previous-window # ctrl + k ä¸‹ä¸€ä¸ªçª—å£ bind -n C-k next-window # è®¾ç½®æ¾å¼€é¼ æ ‡ä¸ä¼šè‡ªåŠ¨è·³åˆ°å±å¹•åº•éƒ¨ï¼Œè¿™ä¸ªç‰¹æ€§éœ€è¦ç¨å¾®é«˜ä¸€ç‚¹çš„ç‰ˆæœ¬æ‰æ”¯æŒ set -g mouse on unbind -T copy-mode-vi MouseDragEnd1Pane # å¿«é€ŸåŠ è½½é…ç½®æ–‡ä»¶ï¼Œä¸ç”¨é‡å¯ tmux bind-key r source-file ~/.tmux.conf \\; display-message \u0026#34;tmux.conf reloaded\u0026#34; # ä¸‹é¢æ˜¯åº•éƒ¨çŠ¶æ€æ çš„é…ç½®ï¼Œä¸ªäººä¸å–œæ¬¢èŠ±é‡Œèƒ¡å“¨ï¼Œç®€å•å¤Ÿç”¨å³å¯ set -g message-style \u0026#34;bg=#00346e, fg=#ffffd7\u0026#34; # tomorrow night blue, base3 set -g status-style \u0026#34;bg=#00346e, fg=#ffffd7\u0026#34; # tomorrow night blue, base3 set -g status-left \u0026#34;#[bg=#0087ff] â Hi!\u0026#34; # blue set -g status-left-length 400 set -g status-right \u0026#34;\u0026#34; #set -g status-right \u0026#34;#[bg=red] %Y-%m-%d %H:%M \u0026#34; #set -g status-right-length 600 set -wg window-status-format \u0026#34; #I #W \u0026#34; set -wg window-status-current-format \u0026#34; #I #W \u0026#34; set -wg window-status-separator \u0026#34;|\u0026#34; set -wg window-status-current-style \u0026#34;bg=red\u0026#34; # red set -wg window-status-last-style \u0026#34;fg=red\u0026#34; # split window unbind % # æ°´å¹³åˆ†éš”çª—å£ å¿«æ·é”®æ˜¯ prefix \\ (æˆ‘çš„å‰ç¼€æ˜¯ ctrl + A) bind \\\\ split-window -h unbind \u0026#39;\u0026#34;\u0026#39; # å‚ç›´åˆ†éš”çª—å£ å¿«æ·é”®æ˜¯ prefix - bind - split-window -v # select pane é¢æ¿ä¹‹é—´è·³è½¬ bind k selectp -U # above (prefix k) bind j selectp -D # below (prefix j) bind h selectp -L # left (prefix h) bind l selectp -R # right (prefix l) # ä¸‹é¢æ˜¯æ’ä»¶éƒ¨åˆ† # ç”¨æ¥ä¿å­˜ä¼šè¯ å’Œ å›å¤ä¼šè¯çš„ # ä¿å­˜ä¼šè¯å¿«æ·é”®æ˜¯ prefix + ctrl + s (å¯¹åº”æˆ‘çš„å°±æ˜¯ ctrl + A ctrl + s ä¸­é—´ä¸è¦æ¾å¼€ ctrl é”®) # æ¢å¤ä¼šè¯ï¼š prefix + ctrl + r set -g @plugin \u0026#39;tmux-plugins/tmux-resurrect\u0026#39; set -g @continuum-restore \u0026#39;on\u0026#39; set -g @resurrect-save-bash-history \u0026#39;on\u0026#39; set -g @resurrect-capture-pane-contents \u0026#39;on\u0026#39; # è®¾ç½®ä¿å­˜ vim çš„å·¥ä½œçŠ¶æ€ set -g @resurrect-strategy-vim \u0026#39;session\u0026#39; # æ¯éš”60ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡ set -g @continuum-save-interval \u0026#39;60\u0026#39; # é¼ æ ‡é€‰ä¸­å³å¤åˆ¶çš„æ’ä»¶ set -g @plugin \u0026#39;tmux-plugins/tmux-yank\u0026#39; set -g @yank_action \u0026#39;copy-pipe\u0026#39; set -g @yank_with_mouse on # å®‰è£…æ’ä»¶çš„æ’ä»¶ # ctrl + I å³è‡ªåŠ¨ä¸‹è½½æ’ä»¶å®‰è£…ã€‚ run \u0026#39;~/.tmux/plugins/tpm/tpm\u0026#39; ç»“æŸï¼ æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿ä¸‹é¢ç•™è¨€ï¼Œæˆ–è€…åŠ æˆ‘å¥½å‹è®¨è®ºå“Ÿï¼æˆ–è€…è¯·æˆ‘åƒä¸ªç³–æœ (^_^)\n","date":"2021-08-10T11:21:12Z","permalink":"https://dccmmtop.github.io/posts/%E4%BD%BF%E7%94%A8tmux/","section":"posts","tags":null,"title":"Linux tmux å®‰è£…åŠé…ç½®"},{"categories":null,"contents":"Linuxä¿®æ”¹æ—¶åŒºçš„æ­£ç¡®æ–¹æ³•\nCentOSå’ŒUbuntuçš„æ—¶åŒºæ–‡ä»¶æ˜¯/etc/localtimeï¼Œä½†æ˜¯åœ¨CentOS7ä»¥ålocaltimeä»¥åŠå˜æˆäº†ä¸€ä¸ªé“¾æ¥æ–‡ä»¶\n[root@centos7 ~]# ll /etc/localtime\nlrwxrwxrwx 1 root root 33 Oct 12 11:01 /etc/localtime -\u0026gt; /usr/share/zoneinfo/Asia/Shanghai\nå¦‚æœé‡‡ç”¨ç›´æ¥cpçš„æ–¹æ³•ä¿®æ”¹ç³»ç»Ÿæ—¶åŒºï¼Œé‚£ä¹ˆå°±ä¼šæŠŠå®ƒæ‰€é“¾æ¥çš„æ–‡ä»¶ä¿®æ”¹æ‰ï¼Œä¾‹å¦‚æŠŠç¾å›½çš„æ—¶åŒºæ–‡ä»¶å†…å®¹ä¿®æ”¹æˆäº†ä¸Šæµ·çš„æ—¶åŒºå†…å®¹ï¼Œæœ‰å¯èƒ½ä¼šå¯¼è‡´æœ‰äº›ç¼–ç¨‹è¯­è¨€æˆ–ç¨‹åºåœ¨è¯»å–ç³»ç»Ÿæ—¶åŒºçš„æ—¶å€™å‘ç”Ÿé”™è¯¯ï¼Œå› æ­¤æ­£ç¡®çš„ä¿®æ”¹æ–¹æ³•æ˜¯ï¼š\nCentOS6ã€Ubuntu16\ncp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime CentOS7ã€RHEL7ã€Scientific Linux 7ã€Oracle Linux 7\næœ€å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨timedatectlå‘½ä»¤\ntimedatectl list-timezones |grep Shanghai #æŸ¥æ‰¾ä¸­å›½æ—¶åŒºçš„å®Œæ•´åç§° Asia/Shanghai\ntimedatectl set-timezone Asia/Shanghai #å…¶ä»–æ—¶åŒºä»¥æ­¤ç±»æ¨\næˆ–è€…ç›´æ¥æ‰‹åŠ¨åˆ›å»ºè½¯é“¾æ¥(éªŒè¯è¿‡) ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime ","date":"2021-08-10T11:18:51Z","permalink":"https://dccmmtop.github.io/posts/%E4%BF%AE%E6%94%B9%E6%97%B6%E5%8C%BA/","section":"posts","tags":null,"title":"ä¿®æ”¹æ—¶åŒº"},{"categories":null,"contents":"åœ¨ç›®æ ‡æœºå™¨ä¸­ä¿®æ”¹/etc/ssh/sshd_confæ–‡ä»¶\nå°†UseDNS çš„ç¼ºçœå€¼ç”±yesä¿®æ”¹ä¸ºnoï¼Œå¹¶é‡å¯ssh\n","date":"2021-08-10T10:48:44Z","permalink":"https://dccmmtop.github.io/posts/ssh%E6%85%A2/","section":"posts","tags":null,"title":"sshæ…¢"},{"categories":null,"contents":"é€šè¿‡renameå‘½ä»¤æ‰¹é‡é‡å‘½åæ–‡ä»¶ åŸºæœ¬è¯­æ³•\nç¤ºä¾‹\næ”¹å˜æ–‡ä»¶æ‰©å±•å å¤§å†™æ”¹æˆå°å†™ æ›´æ”¹æ–‡ä»¶åæ¨¡å¼ é€šè¿‡renameå‘½ä»¤æ‰¹é‡é‡å‘½åæ–‡ä»¶\nåŸºæœ¬è¯­æ³•\nrename [-n -v -f] \u0026lt;pcre\u0026gt; \u0026lt;files\u0026gt; \u0026lsquo;pcreâ€™æ˜¯Perlå…¼å®¹æ­£åˆ™è¡¨è¾¾å¼ï¼Œå®ƒè¡¨ç¤ºçš„æ˜¯è¦é‡å‘½åçš„æ–‡ä»¶å’Œè¯¥æ€ä¹ˆåšã€‚æ­£åˆ™è¡¨è¾¾å¼çš„å½¢å¼æ˜¯â€˜s/old-name/new-name/â€™ã€‚\nâ€˜-vâ€™é€‰é¡¹ä¼šæ˜¾ç¤ºæ–‡ä»¶åæ”¹å˜çš„ç»†èŠ‚ï¼ˆæ¯”å¦‚ï¼šXXXé‡å‘½åæˆYYYï¼‰ã€‚\nâ€˜-nâ€™é€‰é¡¹å‘Šè¯‰renameå‘½ä»¤åœ¨ä¸å®é™…æ”¹å˜åç§°çš„æƒ…å†µä¸‹æ˜¾ç¤ºæ–‡ä»¶å°†ä¼šé‡å‘½åçš„æƒ…å†µã€‚è¿™ä¸ªé€‰é¡¹åœ¨ä½ æƒ³è¦åœ¨ä¸æ”¹å˜æ–‡ä»¶åçš„æƒ…å†µä¸‹æ¨¡æ‹Ÿæ”¹å˜æ–‡ä»¶åçš„æƒ…å†µä¸‹å¾ˆæœ‰ç”¨ã€‚\nâ€˜-fâ€™é€‰é¡¹å¼ºåˆ¶è¦†ç›–å­˜åœ¨çš„æ–‡ä»¶ã€‚\nç¤ºä¾‹\næ”¹å˜æ–‡ä»¶æ‰©å±•å\nå‡è®¾ä½ æœ‰è®¸å¤š.jpegçš„å›¾ç‰‡æ–‡ä»¶ï¼Œä½ æƒ³è¦æŠŠå®ƒä»¬çš„åå­—æ”¹æˆ.jpgã€‚ä¸‹é¢çš„å‘½ä»¤å°±ä¼šå°†.jpeg æ–‡ä»¶æ”¹æˆ *.jpgã€‚\nrename 's/\\.jpeg/\\.jpg/' *.jpeg å¤§å†™æ”¹æˆå°å†™\næœ‰æ—¶ä½ æƒ³è¦æ”¹å˜æ–‡ä»¶åçš„å¤§å°å†™ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ã€‚\næŠŠæ‰€æœ‰çš„æ–‡ä»¶æ”¹æˆå°å†™\nrename 'y/A-Z/a-z/'\næŠŠæ‰€æœ‰çš„æ–‡ä»¶æ”¹æˆå¤§å†™\nrename 'y/a-z/A-Z/' * æ›´æ”¹æ–‡ä»¶åæ¨¡å¼\nç°åœ¨è®©æˆ‘ä»¬è€ƒè™‘æ›´å¤æ‚çš„åŒ…å«å­æ¨¡å¼çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚åœ¨PCREä¸­ï¼Œå­æ¨¡å¼åŒ…å«åœ¨åœ†æ‹¬å·ä¸­ï¼Œç¬¦åæ¥ä¸Šæ•°å­—ï¼ˆæ¯”å¦‚1ï¼Œ$2ï¼‰ã€‚ ä¸‹é¢çš„å‘½ä»¤ä¼šå°†â€˜imgNNNN.jpegâ€™å˜æˆâ€˜danNNNN.jpgâ€™ã€‚\nroot@root:~$ rename -v \u0026#39;s/img_(\\d{4})\\.jpeg/dan_$1.jpg/\u0026#39; *.jpeg img_5417.jpeg renamed as dan_5417.jpg img_5418.jpeg renamed as dan_5418.jpg img_5419.jpeg renamed as dan_5419.jpg img_5420.jpeg renamed as dan_5420.jpg img_5421.jpeg renamed as dan_5421.jpg img_5422.jpeg renamed as dan_5422.jpg ä¸‹é¢çš„å‘½ä»¤ä¼šå°†â€˜img_000NNNN.jpegâ€™å˜æˆâ€˜dan_NNNN.jpgâ€™ã€‚\nroot@root:~$ rename -v \u0026#39;s/img_\\d{3}(\\d{4})\\.jpeg/dan_$1.jpg/\u0026#39; *.jpeg img_0005417.jpeg renamed as dan_5417.jpg img_0005418.jpeg renamed as dan_5418.jpg img_0005419.jpeg renamed as dan_5419.jpg img_0005420.jpeg renamed as dan_5420.jpg img_0005421.jpeg renamed as dan_5421.jpg img_0005422.jpeg renamed as dan_5422.jpg ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå­æ¨¡å¼â€˜\\d{4}â€™ä¼šæ•æ‰4ä¸ªè¿ç»­çš„æ•°å­—ï¼Œæ•æ‰çš„å››ä¸ªæ•°å­—åŒ¹é…æ¨¡å¼å¯¹åº”$1, å°†ä¼šç”¨äºæ–°çš„æ–‡ä»¶åã€‚\n","date":"2021-08-10T10:12:57Z","permalink":"https://dccmmtop.github.io/posts/linux%E6%89%B9%E9%87%8F%E9%87%8D%E5%91%BD%E5%90%8D/","section":"posts","tags":null,"title":"linuxæ‰¹é‡é‡å‘½å"},{"categories":null,"contents":"è®¾ç½®ss git config --global http.proxy \u0026#39;socks5://127.0.0.1:1080\u0026#39; git config --global https.proxy \u0026#39;socks5://127.0.0.1:1080\u0026#39; è®¾ç½®ä»£ç† git config --global https.proxy http://127.0.0.1:1080 git config --global https.proxy https://127.0.0.1:1080 å–æ¶ˆä»£ç† git config --global --unset http.proxy git config --global --unset https.proxy ","date":"2021-08-08T17:18:35Z","permalink":"https://dccmmtop.github.io/posts/git%E8%AE%BE%E7%BD%AE%E5%92%8C%E5%8F%96%E6%B6%88%E4%BB%A3%E7%90%86/","section":"posts","tags":["git"],"title":"git è®¾ç½®å’Œå–æ¶ˆä»£ç†"},{"categories":null,"contents":"\n","date":"2021-08-03T23:02:05Z","permalink":"https://dccmmtop.github.io/posts/%E5%8D%95%E5%90%91%E9%80%9A%E9%81%93/","section":"posts","tags":null,"title":"å•å‘é€šé“"},{"categories":null,"contents":"var æ–¹å¼ var name type = expiression\nvar name string = \u0026#34;zhangsan\u0026#34; var name = \u0026#34;zhangsan\u0026#34; var name string // é»˜è®¤å€¼æ˜¯ \u0026#34;\u0026#34; å˜é‡åˆ—è¡¨å£°æ˜ var æ–¹å¼é€šå¸¸ç”¨æˆ·å’Œåˆå§‹åŒ–ç±»å‹ä¸ä¸€è‡´çš„å±€éƒ¨å˜é‡ï¼Œæˆ–åˆ™åˆå§‹åŒ–å€¼ä¸é‡è¦çš„æƒ…å†µ\nçŸ­å˜é‡å£°æ˜ å¤šå˜é‡å£°æ˜ i,j := 0,1\né‡ç‚¹ := ä»£è¡¨å£°æ˜\n= æ ‡è¯†èµ‹å€¼\näº¤æ¢å€¼\ni,j = j,i\nç¬¬äºŒæ¬¡å£°æ˜ç­‰åŒèµ‹å€¼\nç¬¬äºŒè¡Œ err ç­‰åŒäºèµ‹å€¼\nè‡³å°‘å£°æ˜ä¸€ä¸ªå˜é‡\n","date":"2021-08-01T11:36:29Z","permalink":"https://dccmmtop.github.io/posts/%E5%8F%98%E9%87%8F/","section":"posts","tags":["go"],"title":"å˜é‡"},{"categories":null,"contents":"æ•°ç»„ åˆå§‹åŒ– æŒ‡å®šé•¿åº¦ a := [2]int{1,2} // æŒ‡å®šé•¿åº¦å’Œå­—é¢é‡ ä¸æŒ‡å®šé•¿åº¦ a := [...]int{1,2} //ä¸æŒ‡å®šé•¿åº¦ï¼Œæœ‰åé¢çš„åˆ—è¡¨æ¥ç¡®å®šå…¶é•¿åº¦ æŒ‡å®šæ€»é•¿åº¦ï¼Œé€šè¿‡ç´¢å¼•åˆå§‹åŒ–, æ²¡æœ‰åˆå§‹åŒ–çš„ä½ç½®ä½¿ç”¨é»˜è®¤å€¼ a := [3]int{1:1, 2:3} ä¸æŒ‡å®šæ€»é•¿åº¦ï¼Œé€šè¿‡ç´¢å¼•åˆå§‹åŒ–, æœ€åä¸€ä¸ªç´¢å¼•ä¸ºæ€»é•¿åº¦,æ²¡æœ‰åˆå§‹åŒ–çš„ä½ç½®ä½¿ç”¨é»˜è®¤å€¼ a := [...]int{1:1, 2:3, 5:9} ç‰¹ç‚¹ é•¿åº¦å›ºå®š,ä¸å¯ä»¥è¿½åŠ å…ƒç´  æ˜¯å€¼ç±»å‹ï¼Œèµ‹å€¼æˆ–ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œéƒ½æ˜¯å€¼æ‹·è´ æ•°ç»„é•¿åº¦æ˜¯ç±»å‹çš„ä¸€éƒ¨åˆ† [10]int å’Œ [20]int æ˜¯ä¸åŒç±»å‹ å¯ä»¥æ ¹æ®æ•°ç»„åˆ›å»ºåˆ‡ç‰‡ åˆ‡ç‰‡ åˆ›å»ºåˆ‡ç‰‡ ç”±æ•°ç»„åˆ›å»º\narray[b:e]\narray è¡¨ç¤ºæ•°ç»„åï¼Œbè¡¨ç¤ºå¼€å§‹ç´¢å¼•ï¼Œå¯ä»¥ä¸æŒ‡å®šï¼Œé»˜è®¤æ˜¯0ï¼Œ\neè¡¨ç¤ºç»“æŸç´¢å¼•ï¼Œå¯ä»¥ä¸æŒ‡å®šï¼Œé»˜è®¤æ˜¯æ•°ç»„é•¿åº¦len(array)\narray[b:e] è¡¨ç¤ºåˆ›å»º e-b ä¸ªå…ƒç´ çš„åˆ‡ç‰‡ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ array[b],æœ€åä¸€ä¸ªå…ƒç´ æ˜¯ array[e-1]\nç”± make å‡½æ•°åˆ›å»º\n// len = 10 cap = 10 a := make([]int, 10) //len = 10 cap = 15 b := make([]int, 10, 15) åˆ‡ç‰‡æ“ä½œ len() è¿”å›é•¿åº¦ cap() è¿”å›åº•å±‚æ•°ç»„å®¹é‡ append() è¿½åŠ å…ƒç´  copy() å¤åˆ¶åˆ‡ç‰‡ å­—ç¬¦ä¸²ä¸åˆ‡ç‰‡çš„è½¬æ¢ str := \u0026#34;hello,ä¸–ç•Œ\u0026#34; // è½¬æ¢æˆå­—èŠ‚åˆ‡ç‰‡ a := []byte(str) // è½¬æ¢æˆ rune åˆ‡ç‰‡ b := []rune(str) ","date":"2021-07-29T23:11:14Z","permalink":"https://dccmmtop.github.io/posts/%E6%95%B0%E7%BB%84%E4%B8%8E%E5%88%87%E7%89%87/","section":"posts","tags":null,"title":"æ•°ç»„ä¸åˆ‡ç‰‡"},{"categories":null,"contents":"ç”¨åœ¨å¸¸é‡å£°æ˜ä¸­ï¼Œåˆå§‹å€¼ä¸º0ï¼Œä¸€ç»„å¸¸é‡åŒæ—¶å£°æ˜æ—¶ï¼Œå…¶å€¼é€è¡Œå¢åŠ \nç±»ä¼¼æšä¸¾ const ( c0 = iota //c0 == 0 c1 = iota //c1 == 1 c2 = iota //c2 == 2 ) ç®€å†™æ¨¡å¼\nconst ( c0 = iota // c0 == 0 c1 // c1 == 1 c2 // c2 == 2 ) åˆ†å¼€çš„const åˆ†å¼€çš„constè¯­å¥ï¼Œ iota çš„å€¼æ¯æ¬¡éƒ½æ˜¯ä»0å¼€å§‹\nconst c0 = iota // c0 == 0\nconst c1 = iota // c1 == 0\n","date":"2021-07-29T22:49:53Z","permalink":"https://dccmmtop.github.io/posts/iota-%E7%94%A8%E6%B3%95/","section":"posts","tags":null,"title":"iota ç”¨æ³•"},{"categories":null,"contents":"1.Macä¸‹ç¼–è¯‘Linux, Windows Linux CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build filename.go Windows CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build filename.go å¦‚: CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -o helloworld-windows helloworld.go\n2.Linuxä¸‹ç¼–è¯‘Mac, Windows Mac CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build filename.go Windows CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build filename.go 3.Windowsä¸‹ç¼–è¯‘Mac, Linux Mac SET CGO_ENABLED=0 SET GOOS=darwin SET GOARCH=amd64 go build filename.go Linux SET CGO_ENABLED=0 SET GOOS=linux SET GOARCH=amd64 go build filename.go\n","date":"2021-07-25T10:24:03Z","permalink":"https://dccmmtop.github.io/posts/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/","section":"posts","tags":null,"title":"äº¤å‰ç¼–è¯‘"},{"categories":null,"contents":" ps -ef | grep nginx | awk -F ' ' '{print $2}'| xargs\n","date":"2021-07-10T16:58:13Z","permalink":"https://dccmmtop.github.io/posts/%E5%A4%9A%E8%A1%8C%E5%8F%98%E5%8D%95%E8%A1%8C/","section":"posts","tags":null,"title":"å¤šè¡Œå˜å•è¡Œ"},{"categories":null,"contents":"æœ‰æ—¶éœ€è¦æ ¹æ®è‡ªå·±çš„å·¥ä½œåœºåˆå»æ‰©å±• git å‘½ä»¤,æ¯”å¦‚\næ¨é€åˆ°ä»“åº“åè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨è·³è½¬åˆ°å‘èµ·åˆå¹¶æ±‚é¡µé¢ åˆ†æ”¯å‘½åæ¯”è¾ƒé•¿å…¶ç›¸ä¼¼åº¦æ¯”è¾ƒå¤§æ—¶ï¼Œè‡ªåŠ¨è¡¥å…¨ä¸é‚£ä¹ˆæœ‰æ•ˆç‡ï¼Œç»™æ¯ä¸ªåˆ†æ”¯ç¼–å·ï¼Œè¾“å…¥æŒ‡å®šç¼–å·å³å¯åˆ‡æ¢å¯¹åº”çš„åˆ†æ”¯ æˆ‘æœ€æ¨èçš„ä¸€ç§æ–¹å¼æ˜¯åˆ©ç”¨ shell è„šæœ¬çš„ç‰¹æ€§ï¼Œå°†è„šæœ¬å‘½åä¸º git-xxxx æ–¹å¼ï¼Œåœ¨ç»ˆç«¯å°±å¯ä»¥é€šè¿‡ git xxx çš„æ–¹å¼è¿è¡Œè¯¥å‘½ä»¤\nä¸‹é¢æ˜¯ä¸¤ä¸ªä¾‹å­ï¼š\nç»™æ¯ä¸ªåˆ†æ”¯ç¼–ç  åœ¨ /usr/lcoal/bin å…ˆæ–°å»º git-brr æ–‡ä»¶,è¾“å…¥ä¸‹é¢è„šæœ¬ï¼š\n#!/bin/bash git branch --no-color | cat -n | sed \u0026#39;s/*/ /\u0026#39; | awk \u0026#39;{print $2 \u0026#34; (\u0026#34;$1\u0026#34;)\u0026#34;}\u0026#39; sudo chomd +x ./git-brr èµ‹äºˆå¯æ‰§è¡Œæƒé™\nç„¶ååˆ°ä¸€ä¸ªé¡¹ç›®ä¸‹æ‰§è¡Œ git brr\næŒ‡å®šç¼–å·åˆ‡æ¢åˆ†æ”¯ åœ¨ /usr/lcoal/bin å…ˆæ–°å»º git-coo æ–‡ä»¶,è¾“å…¥ä¸‹é¢è„šæœ¬\n#!/bin/bash git checkout $( git brr | egrep \u0026#34;\\($1)$\u0026#34; | egrep -o \u0026#39;.+ \u0026#39;) ç„¶å sudo chomd +x ./git-coo èµ‹äºˆå¯æ‰§è¡Œæƒé™\næ­¤æ—¶å°±å¯å·²é€šè¿‡ git coo 4 åˆ‡æ¢å¯¹åº”çš„åˆ†æ”¯äº†\n","date":"2021-06-10T17:17:09Z","permalink":"https://dccmmtop.github.io/posts/%E6%89%A9%E5%B1%95git%E5%8A%9F%E8%83%BD%E7%9A%84%E4%B8%80%E7%A7%8D%E6%96%B9%E5%BC%8F/","section":"posts","tags":["git"],"title":"æ‰©å±•gitåŠŸèƒ½çš„ä¸€ç§æ–¹å¼"},{"categories":null,"contents":"åŸºæœ¬ç±»å‹ä»¥åŠèŒƒå›´ é€‰æ‹©ä¼˜åŒ–çš„æ•°æ®ç±»å‹ MySQL æ”¯æŒçš„æ•°æ®ç±»å‹éå¸¸å¤šï¼Œé€‰æ‹©æ­£ç¡®çš„æ•°æ®ç±»å‹å¯¹äºè·å¾—é«˜æ€§èƒ½è‡³å…³é‡è¦ã€‚ä¸ç®¡\nå­˜å‚¨å“ªç§ç±»å‹çš„æ•°æ®ï¼Œä¸‹é¢å‡ ä¸ªç®€å•çš„åŸåˆ™éƒ½æœ‰åŠ©äºåšå‡ºæ›´å¥½çš„é€‰æ‹©ã€‚\næ›´å°çš„é€šå¸¸æ›´å¥½ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹,åº”è¯¥å°½é‡ä½¿ç”¨å¯ä»¥æ­£ç¡®å­˜å‚¨æ•°æ®çš„æœ€å°æ•°æ®ç±»å‹äºŒã€‚æ›´å°çš„æ•°æ®ç±»å‹é€š\nå¸¸æ›´å¿«ï¼Œå› ä¸ºå®ƒä»¬å ç”¨æ›´å°‘çš„ç£ç›˜ã€å†…å­˜å’Œ CPU ç¼“å­˜ï¼Œå¹¶ä¸”å¤„ç†æ—¶éœ€è¦çš„ CPU å‘¨\næœŸä¹Ÿæ›´å°‘ã€‚\nä½†æ˜¯è¦ç¡®ä¿æ²¡æœ‰ä½ä¼°éœ€è¦å­˜å‚¨çš„å€¼çš„èŒƒå›´ï¼Œå› ä¸ºåœ¨ schema ä¸­çš„å¤šä¸ªåœ°æ–¹å¢åŠ æ•°æ®ç±»\nå‹çš„èŒƒå›´æ˜¯ä¸€ä¸ªéå¸¸è€—æ—¶å’Œç—›è‹¦çš„æ“ä½œã€‚å¦‚æœæ— æ³•ç¡®å®šå“ªä¸ªæ•°æ®ç±»å‹æ˜¯æœ€å¥½çš„ï¼Œå°±\né€‰æ‹©ä½ è®¤ä¸ºä¸ä¼šè¶…è¿‡èŒƒå›´çš„æœ€å°ç±»å‹ã€‚(å¦‚æœç³»ç»Ÿä¸æ˜¯å¾ˆå¿™æˆ–è€…å­˜å‚¨çš„æ•°æ®é‡ä¸å¤šï¼Œ\næˆ–è€…æ˜¯åœ¨å¯ä»¥è½»æ˜“ä¿®æ”¹è®¾è®¡çš„æ—©æœŸé˜¶æ®µï¼Œé‚£ä¹‹åä¿®æ”¹æ•°æ®ç±»å‹ä¹Ÿæ¯”è¾ƒå®¹æ˜“) ã€‚\nç®€å•å°±å¥½ ç®€å•æ•°æ®ç±»å‹çš„æ“ä½œé€šå¸¸éœ€è¦æ›´å°‘çš„ CPU å‘¨æœŸã€‚ä¾‹å¦‚ï¼Œæ•´å‹æ¯”å­—ç¬¦æ“ä½œä»£ä»·æ›´ä½ï¼Œ\nå› ä¸ºå­—ç¬¦é›†å’Œæ ¡å¯¹è§„åˆ™ (æ’åºè§„åˆ™)ä½¿å­—ç¬¦æ¯”è¾ƒæ¯”æ•´å‹æ¯”è¾ƒæ›´å¤æ‚ã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªä¾‹å­:\nä¸€ä¸ªæ˜¯åº”è¯¥ä½¿ç”¨ MySQL å†…å»ºçš„ç±»å‹åœ­ è€Œä¸æ˜¯å­—ç¬¦ä¸²æ¥å­˜å‚¨æ—¥æœŸå’Œæ—¶é—´ï¼Œå¦å¤–ä¸€ä¸ª\næ˜¯åº”è¯¥ç”¨æ•´å‹å­˜å‚¨ å« åœ°å€ã€‚ç¨åæˆ‘ä»¬å°†ä¸“é—¨è®¨è®ºè¿™ä¸ªè¯é¢˜ã€‚\nå°½é‡é¿å… NULL å¾ˆå¤šè¡¨éƒ½åŒ…å«å¯ä¸º NULL (ç©ºå€¼) çš„åˆ—ï¼Œå³ä½¿åº”ç”¨ç¨‹åºå¹¶ä¸éœ€è¦ä¿å­˜ NULL ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œ\nè¿™æ˜¯å› ä¸ºå¯ä¸º NULL æ˜¯åˆ—çš„é»˜è®¤å±æ€§ä¸»:ã€‚é€šå¸¸æƒ…å†µä¸‹æœ€å¥½æŒ‡å®šåˆ—ä¸º NOT NULL, é™¤éçœŸ\nçš„éœ€è¦å­˜å‚¨ NULLå€¼ã€‚\nå¦‚æœæŸ¥è¯¢ä¸­åŒ…å«å¯ä¸º NULL çš„åˆ—ï¼Œå¯¹ MySQL æ¥è¯´æ›´éš¾ä¼˜åŒ–ï¼Œå› ä¸ºå¯ NULL çš„åˆ—ä½¿\nå¾—ç´¢å¼•ã€ç´¢å¼•ç»Ÿè®¡å’Œå€¼æ¯”è¾ƒéƒ½æ›´å¤æ‚ã€‚å¯ä¸º NULL çš„åˆ—ä¼šä½¿ç”¨æ›´å¤šçš„å­˜å‚¨ç©ºé—´ï¼Œåœ¨\nMySQL é‡Œä¹Ÿéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚å½“å¯ä¸º NULL çš„åˆ—è¢«ç´¢å¼•æ—¶ï¼Œæ¯ä¸ªç´¢å¼•è®°å½•éœ€è¦ä¸€ä¸ªé¢\nå¤–çš„å­—èŠ‚ï¼Œåœ¨ MyISAM é‡Œç”šè‡³è¿˜å¯èƒ½å¯¼è‡´å›ºå®šå¤§å°çš„ç´¢å¼•(ä¾‹å¦‚åªæœ‰ä¸€ä¸ªæ•´æ•°åˆ—çš„\nç´¢å¼•) å˜æˆå¯å˜å¤§å°çš„ç´¢å¼•ã€‚\né€šå¸¸æŠŠå¯ä¸º NULL çš„åˆ—æ”¹ä¸º NOT NULL å¸¦æ¥çš„æ€§èƒ½æå‡æ¯”è¾ƒå°ï¼Œæ‰€ä»¥ (è°ƒä¼˜æ—¶) æ²¡æœ‰\nå¿…è¦é¦–å…ˆåœ¨ç°æœ‰ schema ä¸­æŸ¥æ‰¾å¹¶ä¿®æ”¹æ‰è¿™ç§æƒ…å†µï¼Œé™¤éç¡®å®šè¿™ä¼šå¯¼è‡´é—®é¢˜ã€‚ä½†æ˜¯ï¼Œ\nå¦‚æœè®¡åˆ’åœ¨åˆ—ä¸Šå»ºç´¢å¼•ï¼Œå°±åº”è¯¥å°½é‡é¿å…è®¾è®¡æˆå¯ä¸º NULL çš„åˆ—ã€‚\næ•´æ•°ç±»å‹ ç±»å‹ å­˜å‚¨ç©ºé—´ TINYINT 8 SMALLINT 16 MEDIUMINT 24 INT 32 BIGINT 64 å­—ç¬¦ä¸² VARCHAR VARCHAR ç±»å‹ç”¨äºå­˜å‚¨å¯å˜é•¿å­—ç¬¦ä¸²ï¼Œæ˜¯æœ€å¸¸è§çš„å­—ç¬¦ä¸²æ•°æ®ç±»å‹ã€‚å®ƒæ¯”å®šé•¿ç±»å‹\næ›´èŠ‚çœç©ºé—´ï¼Œå› ä¸ºå®ƒä»…ä½¿ç”¨å¿…è¦çš„ç©ºé—´ (ä¾‹å¦‚ï¼Œè¶ŠçŸ­çš„å­—ç¬¦ä¸²ä½¿ç”¨è¶Šå°‘çš„ç©ºé—´) ã€‚æœ‰\nä¸€ç§æƒ…å†µä¾‹å¤–ï¼Œå¦‚æœ MySQL è¡¨ä½¿ç”¨ ROW_FORMAT=FIXED åˆ›å»ºçš„è¯ï¼Œæ¯ä¸€è¡Œéƒ½ä¼šä½¿ç”¨\nå®šé•¿å­˜å‚¨ï¼Œè¿™ä¼šå¾ˆæµªè´¹ç©ºé—´ã€‚\nVARCHARéœ€è¦ä½¿ç”¨ 1 æˆ– 2 ä¸ªé¢å¤–å­—èŠ‚è®°å½•å­—ç¬¦ä¸²çš„é•¿åº¦ : å¦‚æœåˆ—çš„æœ€å¤§é•¿åº¦å°äºæˆ–\nç­‰äº 255 å­—èŠ‚, åˆ™åªä½¿ç”¨ 1 ä¸ªå­—èŠ‚è¡¨ç¤º, å¦åˆ™ä½¿ç”¨ 2 ä¸ªå­—èŠ‚ã€‚å‡è®¾é‡‡ç”¨ latinl å­—ç¬¦é›†ï¼Œ\nä¸€ä¸ª VARCHAR(16) çš„åˆ—éœ€è¦ 11 ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚VARCHAR(1069) çš„åˆ—åˆ™éœ€è¦ 1002\nä¸ªå­—èŠ‚ï¼Œå› ä¸ºéœ€è¦ 2 ä¸ªå­—èŠ‚å­˜å‚¨é•¿åº¦ä¿¡æ¯ã€‚\nVARCHARèŠ‚çœäº†å­˜å‚¨ç©ºé—´ï¼Œæ‰€ä»¥å¯¹æ€§èƒ½ä¹Ÿæœ‰å¸®åŠ©ã€‚ä½†æ˜¯ï¼Œç”±æ‰‹ç­”æ˜¯å˜é•¿çš„ï¼Œåœ¨\nUPDATE æ—¶å¯èƒ½ä½¿è¡Œå˜å¾—æ¯”åŸæ¥æ›´é•¿ï¼Œè¿™å°±å¯¼è‡´éœ€è¦åšé¢å¤–çš„å·¥ä½œã€‚å¦‚æœä¸€ä¸ªè¡Œå ç”¨\nçš„ç©ºé—´å¢é•¿ï¼Œå¹¶ä¸”åœ¨é¡µå†…æ²¡æœ‰æ›´å¤šçš„ç©ºé—´å¯ä»¥å­˜å‚¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸åŒçš„å­˜å‚¨å¼•\näººæ“çš„å¤„ç†æ–¹å¼æ˜¯ä¸ä¸€æ ·çš„ã€‚ä¾‹å¦‚ï¼ŒMyISAM ä¼šå°†è¡Œæ‹†æˆä¸åŒçš„ç‰‡æ®µå­˜å‚¨ï¼ŒInnoDB\nåˆ™éœ€è¦åˆ†è£‚é¡µæ¥ä½¿è¡Œå¯ä»¥æ”¾è¿›é¡µå†…ã€‚å…¶ä»–ä¸€äº›å­˜å‚¨å¼•æ“ä¹Ÿè®¸ä»ä¸åœ¨åŸæ•°æ®ä½ç½®æ›´æ–°\næ•°æ®ã€‚\nä¸‹é¢è¿™äº›æƒ…å†µä¸‹ä½¿ç”¨VARCHARæ˜¯åˆé€‚çš„ : å­—ç¬¦ä¸²åˆ—çš„æœ€å¤§é•¿åº¦æ¯”å¹³å‡é•¿åº¦å¤§å¾ˆå¤š ï¼Œ\nåˆ—çš„æ›´æ–°å¾ˆå°‘ï¼Œæ‰€ä»¥ç¢ç‰‡ä¸æ˜¯é—®é¢˜ ï¼Œ ä½¿ç”¨äº†åƒ UTF-8 è¿™æ ·å¤æ‚çš„å­—ç¬¦é›†ï¼Œæ¯ä¸ªå­—ç¬¦\néƒ½ä½¿ç”¨ä¸åŒçš„å­—èŠ‚æ•°è¿›è¡Œå­˜å‚¨ã€‚\nCHAR CHAR ç±»å‹æ˜¯å®šé•¿çš„ : MySQL æ€»æ˜¯æ ¹æ®å®šä¹‰çš„å­—ç¬¦ä¸²é•¿åº¦åˆ†é…è¶³å¤Ÿçš„ç©ºé—´ã€‚å½“å­˜å‚¨\n[CHARå€¼æ—¶å…¨MYSQIç ”åˆ é™¤æ‰€æœ‰çš„æœ«å°¾ç©ºæ ¼ä¸Š(åœ¨ MySQL 4.1 å’Œæ›´è€ç‰ˆæœ¬ä¸­ VARCHAR\nä¹Ÿæ˜¯è¿™æ ·å®ç°çš„ä¸€ ä¹Ÿå°±æ˜¯è¯´è¿™äº›ç‰ˆæœ¬ä¸­ CHAR å’Œ VARCHAR åœ¨é€»è¾‘ä¸Šæ˜¯ä¸€æ ·çš„ï¼ŒåŒº\nåˆ«åªæ˜¯åœ¨å­˜å‚¨æ ¼å¼ä¸Š) ã€‚ CHARå€¼ä½æ ¹æ®éœ€è¦é‡‡ç”¨ç©ºæ ¼è¿›è¡Œå¡«å……ä»¥æ–¹ä¾¿æ¯”è¾ƒ\nEEARé€‚å’å­˜å‚¨å¾ˆçŸ¥çš„å­—ç¬¦å|æˆ–è€…æ‰€æœ‰å€¼éƒ½æ¥è¿‘åŒä¸€ä¸ªé•¿åº¦ã€‚ä¾‹å¦‚ï¼ŒCHAR éå¸¸é€‚\nåˆå­˜å‚¨å¯†ç çš„ MD5 å€¼ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªå®šé•¿çš„å€¼ã€‚å¯¹äºç»å¸¸å˜æ›´çš„æ•°æ®ï¼ŒCHARä¹Ÿæ¯”\nVARCHARæ›´å¥½ï¼Œå› ä¸ºå®šé•¿çš„ CHAR ç±»å‹ä¸å®¹æ˜“äº§ç”Ÿç¢ç‰‡ã€‚å¯¹äºéå¸¸çŸ­çš„åˆ—ï¼ŒCHAR æ¯”\nVARCHAR åœ¨å­˜å‚¨ç©ºé—´ä¸Šä¹Ÿæ›´æœ‰æ•ˆç‡ã€‚ä¾‹å¦‚ç”¨ CHAR(1) æ¥å­˜å‚¨åªæœ‰ Y å’ŒNçš„å€¼ï¼Œå¦‚æœ\né‡‡ç”¨å•å­—èŠ‚å­—ç¬¦é›†äºŒ åªéœ€è¦ä¸€ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯ VARCHAR(1) å´éœ€è¦ä¸¤ä¸ªå­—èŠ‚ï¼Œå› ä¸ºè¿˜æœ‰\nä¸€ä¸ªè®°å½•é•¿åº¦çš„é¢å¤–å­—èŠ‚ã€‚\næ…·æ…¨æ˜¯ä¸æ˜æ™ºçš„ ä½¿ç”¨ VARCHAR(5) å’Œ VARCHAR(290) å­˜å‚¨â€œheLLo\u0026rsquo; çš„ç©ºé—´å¼€é”€æ˜¯ä¸€æ ·çš„ã€‚é‚£ä¹ˆä½¿ç”¨æ›´\nçŸ­çš„åˆ—æœ‰ä»€ä¹ˆä¼˜åŠ¿å—?\näº‹å®è¯æ˜æœ‰å¾ˆå¤§çš„ä¼˜åŠ¿ã€‚æ›´é•¿çš„åˆ—ä¼šæ¶ˆè€—æ›´å¤šçš„å†…å­˜ï¼Œå› ä¸º MYSQL é€šå¸¸ä¼šåˆ†é…å›º\nå®šå¤§å°çš„å†…å­˜å—æ¥ä¿å­˜å†…éƒ¨å€¼ã€‚å°¤å…¶æ˜¯ä½¿ç”¨å†…å­˜ä¸´æ—¶è¡¨è¿›è¡Œæ’åºæˆ–æ“ä½œæ—¶ä¼šç‰¹åˆ«ç²³\nç²’ã€‚åœ¨åˆ©ç”¨ç£ç›˜ä¸´æ—¶è¡¨è¿›è¡Œæ’åºæ—¶ä¹ŸåŒæ ·ç³Ÿæ¥¼ã€‚\næ‰€ä»¥æœ€å¥½çš„ç­–ç•¥æ˜¯åªåˆ†é…çœŸæ­£éœ€è¦çš„ç©ºé—´ã€‚\næ—¥æœŸå’Œæ—¶é—´ç±»å‹ MySQL å¯ä»¥ä½¿ç”¨è®¸å¤šç±»å‹æ¥ä¿å­˜æ—¥æœŸå’Œæ—¶é—´å€¼ï¼Œä¾‹å¦‚ YEAR å’Œ DATEã€‚MySQL èƒ½å­˜å‚¨çš„\næœ€å°æ—¶é—´ç²’åº¦ä¸ºç§’ (MariaDB æ”¯æŒå¾®ç§’çº§åˆ«çš„æ—¶é—´ç±»å‹) ã€‚ä½†æ˜¯ MySQL ä¹Ÿå¯ä»¥ä½¿ç”¨å¾®ç§’\nçº§çš„ç²’åº¦è¿›è¡Œä¸´æ—¶è¿ç®—ï¼Œæˆ‘ä»¬ä¼šå±•ç¤ºæ€ä¹ˆç»•å¼€è¿™ç§å­˜å‚¨é™åˆ¶ã€‚\nå¤§éƒ¨åˆ†æ—¶é—´ç±»å‹éƒ½æ²¡æœ‰æ›¿ä»£å“ï¼Œå› æ­¤æ²¡æœ‰ä»€ä¹ˆæ˜¯æœ€ä½³é€‰æ‹©çš„é—®é¢˜ã€‚å”¯ä¸€çš„é—®é¢˜æ˜¯ä¿\nå­˜æ—¥æœŸå’Œæ—¶é—´çš„æ—¶å€™éœ€è¦åšä»€ä¹ˆã€‚MySQL æä¾›ä¸¤ç§ç›¸ä¼¼çš„æ—¥æœŸç±»å‹ : DATETIME å’Œ\nTIMESTAMPã€‚å¯¹äºå¾ˆå¤šåº”ç”¨ç¨‹åºï¼Œå®ƒä»¬éƒ½èƒ½å·¥ä½œï¼Œä½†æ˜¯åœ¨æŸäº›åœºæ™¯ï¼Œä¸€ä¸ªæ¯”å¦ä¸€ä¸ªå·¥ä½œ\nå¾—å¥½ã€‚è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ã€‚\nDATETIME è¿™ä¸ªç±»å‹èƒ½ä¿å­˜å¤§èŒƒå›´çš„å€¼ï¼Œä» 1001 å¹´åˆ° 9999 å¹´ï¼Œç²¾åº¦ä¸ºç§’ã€‚å®ƒæŠŠæ—¥æœŸå’Œæ—¶é—´å°\nè£…åˆ°æ ¼å¼ä¸ºYYYYMMDDHHMMSS çš„æ•´æ•°ä¸­ï¼Œä¸æ—¶åŒºæ— å…³ã€‚ä½¿ç”¨8 ä¸ªå­—èŠ‚çš„å­˜å‚¨\nç©ºé—´ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼ŒMySQL ä»¥ä¸€ç§å¯æ’åºçš„ã€æ— æ­§ä¹‰çš„æ ¼å¼æ˜¾ç¤º DATETIMEå€¼ï¼Œä¾‹å¦‚\nâ€œ2008-01-16 22:37:08\u0026quot;ã€‚è¿™æ˜¯ ANSI æ ‡å‡†å®šä¹‰çš„æ—¥æœŸå’Œæ—¶é—´è¡¨ç¤ºæ–¹æ³•ã€‚\nTIMESTAMP å°±åƒå®ƒçš„åå­—ä¸€æ ·ï¼ŒTIMETAMP ç±»å‹ä¿å­˜äº†ä» 1970 å¹´ 1 æœˆ 1 æ—¥åˆå¤œ æ ¼æ—å°¼æ²»æ ‡å‡†\næ—¶é—´) ä»¥æ¥çš„ç§’æ•°,å®ƒå’Œ UNIX æ—¶é—´æˆ³ç›¸åŒã€‚TIMESTAMP åªä½¿ç”¨ 4 ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼Œ\nå› æ­¤å®ƒçš„èŒƒå›´æ¯” DATETIME å°å¾—å¤š : åªèƒ½è¡¨ç¤ºä» 1970 å¹´åˆ° 2038 å¹´ã€‚MySQL æä¾›äº†\nFROM_UNIXTINME() å‡½æ•°æŠŠ Unix æ—¶é—´æˆ³è½¬æ¢ä¸ºæ—¥æœŸï¼Œå¹¶æä¾›äº† UNIX_TIMESTAMP() å‡½\næ•°æŠŠæ—¥æœŸè½¬æ¢ä¸º Unix æ—¶é—´å‘ã€‚\nMySQL 4.1 ä»¥åŠæ›´æ–°çš„ç‰ˆæœ¬æŒ‰ç…§ DATETIME çš„æ–¹å¼æ ¼å¼åŒ– TIMESTAMP çš„å€¼ï¼Œä½†æ˜¯\nMySQL 4.0 ä»¥åŠæ›´è€çš„ç‰ˆæœ¬ä¸ä¼šåœ¨å„ä¸ªéƒ¨åˆ†ä¹‹é—´æ˜¾ç¤ºä»»ä½•æ ‡ç‚¹ç¬¦å·ã€‚è¿™ä»…ä»…æ˜¯æ˜¾ç¤º\næ ¼å¼ä¸Šçš„åŒºåˆ«ï¼ŒTIMESTAMP çš„å­˜å‚¨æ ¼å¼åœ¨å„ä¸ªç‰ˆæœ¬éƒ½æ˜¯ä¸€æ ·çš„ã€‚\nTIMESTAMP æ˜¾ç¤ºçš„å€¼ä¹Ÿä¾èµ–äºæ—¶åŒºã€‚MyYSQL æœåŠ¡å™¨ã€æ“ä½œç³»ç»Ÿï¼Œä»¥åŠå®¢æˆ·ç«¯è¿æ¥éƒ½\næœ‰æ—¶åŒºè®¾ç½®ã€‚\nå› æ­¤ï¼Œå­˜å‚¨å€¼ä¸º 0 çš„ TIMESTAMP åœ¨ç¾å›½ä¸œéƒ¨æ—¶åŒºæ˜¾ç¤º â€œ1969-12-31 19:00:00\u0026quot;, 45\næ ¼æ—å°¼æ²»æ—¶é—´å·® 5 ä¸ªå°æ—¶ã€‚æœ‰å¿…è¦å¼ºè°ƒä¸€ä¸‹è¿™ä¸ªåŒºåˆ« : å¦‚æœåœ¨å¤šä¸ªæ—¶åŒºå­˜å‚¨æˆ–è®¿é—®\næ•°æ®ï¼ŒTIMESTAMP å’Œ DATETIME çš„è¡Œä¸ºå°†å¾ˆä¸ä¸€æ ·ã€‚å‰è€…æä¾›çš„å€¼ä¸æ—¶åŒºæœ‰å…³ç³»ï¼Œå\nè€…åˆ™ä¿ç•™æ–‡æœ¬è¡¨ç¤ºçš„æ—¥æœŸå’Œæ—¶é—´ã€‚\nTIMESTAMP ä¹Ÿæœ‰ DATETIME æ²¡æœ‰çš„ç‰¹æ®Šå±æ€§ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ’å’Œäººæ—¶æ²¡æœ‰æŒ‡å®šç¬¬ä¸€\nä¸ªTIMESTAMP åˆ—çš„å€¼,MySQL åˆ™è®¾ç½®è¿™ä¸ªåˆ—çš„å€¼ä¸ºå½“å‰æ—¶é—´\u0026quot;ã€‚ åœ¨æ’å…¥ä¸€è¡Œè®°å½•æ—¶ï¼Œ\nMySQL é»˜è®¤ä¹Ÿä¼šæ›´æ–°ç¬¬ä¸€ä¸ª TIMESTAMP åˆ—çš„å€¼ (é™¤éåœ¨ UPDATE è¯­å¥ä¸­æ˜ç¡®æŒ‡å®šäº†\nå€¼)ã€‚ä½ å¯ä»¥é…ç½®ä»»ä½• TIMESTAMP åˆ—çš„æ’å…¥å’Œæ›´æ–°è¡Œä¸ºã€‚æœ€åï¼ŒTIMESTAMP åˆ—é»˜è®¤ä¸º\nNOT NULLï¼Œè¿™ä¹Ÿå’Œå…¶ä»–çš„æ•°æ®ç±»å‹ä¸ä¸€æ ·ã€‚\né™¤äº†ç‰¹æ®Šè¡Œä¸ºä¹‹å¤–, é€šå¸¸ä¹Ÿåº”è¯¥å°½é‡ä½¿ç”¨ TIMESTAMPï¼Œå› ä¸ºå®ƒæ¯” DATETIME ç©ºé—´æ•ˆç‡æ›´é«˜ã€‚\næœ‰æ—¶å€™äººä»¬ä¼šå°† Unix æ—¶é—´æˆªå­˜å‚¨ä¸ºæ•´æ•°å€¼ï¼Œä½†è¿™ä¸ä¼šå¸¦æ¥ä»»ä½•æ”¶ç›Šã€‚ç”¨æ•´æ•°ä¿å­˜æ—¶é—´\næˆªçš„æ ¼å¼é€šå¸¸ä¸æ–¹ä¾¿å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸æ¨èè¿™æ ·åšã€‚\nå¦‚æœéœ€è¦å­˜å‚¨æ¯”ç§’æ›´å°ç²’åº¦çš„æ—¥æœŸå’Œæ—¶é—´å€¼æ€ä¹ˆåŠ? MySQL ç›®å‰æ²¡æœ‰æä¾›åˆé€‚çš„æ•°æ®\nç±»å‹ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨è‡ªå·±çš„å­˜å‚¨æ ¼å¼ : å¯ä»¥ä½¿ç”¨ BIGINT ç±»å‹å­˜å‚¨å¾®ç§’çº§åˆ«çš„æ—¶é—´æˆªï¼Œæˆ–\nè€…ä½¿ç”¨DOUBLE å­˜å‚¨ç§’ä¹‹åçš„å°æ•°éƒ¨åˆ†ã€‚è¿™ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥ä½¿ç”¨ MariaDB\n","date":"2021-04-13T23:59:32Z","permalink":"https://dccmmtop.github.io/posts/%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B%E4%BB%A5%E5%8F%8A%E8%8C%83%E5%9B%B4/","section":"posts","tags":["mysql"],"title":"åŸºæœ¬ç±»å‹ä»¥åŠèŒƒå›´"},{"categories":null,"contents":"å…ˆsortæ’åºï¼Œå†å»é‡ :sort //ç›´æ¥æ’åº :g/^\\(.*\\)$\\n\\1$/d //å»é™¤é‡å¤è¡Œ :g/\\%(^\\1$\\n\\)\\@\u0026lt;=\\(.*\\)$/d //åŠŸèƒ½åŒä¸Šï¼Œä¹Ÿæ˜¯å»é™¤é‡å¤è¡Œ :g/\\%(^\\1\\\u0026gt;.*$\\n\\)\\@\u0026lt;=\\(\\k\\+\\).*$/d //åŠŸèƒ½åŒä¸Šï¼Œä¹Ÿæ˜¯å»é™¤é‡å¤è¡Œ ä½¿ç”¨awk awk '!a[$0]++' file\nè§£æï¼š\nawkæµç¨‹æ˜¯é€è¡Œå¤„ç†çš„ï¼Œé»˜è®¤ä»æ–‡ä»¶çš„ç¬¬ä¸€è¡Œä¸€ç›´å¤„ç†åˆ°æ–‡ä»¶æœ€åä¸€è¡Œ\nè¿˜è¦çŸ¥é“awkçš„åŸºæœ¬å‘½ä»¤æ ¼å¼æ˜¯'pattern{action}'å…ˆåŒ¹é…å„ç§å„æ ·çš„æ ·å¼ï¼Œç„¶åå¤§æ‹¬å·é‡Œå¤„ç†å¦‚ä½•æ‰“å°è¾“å‡ºï¼Œ\né»˜è®¤çš„åªè¦åŒ¹é…äº†patternå°±{print $0}ï¼Œå¦‚æœpatternæœªå‘½ä¸­å…¶åˆ¤æ–­å€¼ä¸ºå‡ï¼ˆ0ï¼‰é‚£ä¹ˆå°±ä¸ä¼šå†å»å¤„ç†{action}äº†\npatternå‘½ä¸­åˆ™ä¸ºåˆ¤æ–­å€¼ä¸ºçœŸï¼ˆé0ï¼‰å°±å»å¤„ç†{action}ã€‚\nä¸¾ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼šawk '1' fileå’Œawk '{print $0}' file æ˜¯ä¸€ä¸ªé“ç†ï¼Œéƒ½æ˜¯ä»å¤´åˆ°å°¾ä¾æ¬¡æ‰“å°æ–‡ä»¶çš„æ¯ä¸€è¡Œã€‚\n'!a[$0]++'\nåˆ†æˆå‡ ä¸ªéƒ¨åˆ†ç®€å•è§£é‡Šä¸‹å§ã€‚\nè¿™ä¸ªå‘½ä»¤æ²¡æœ‰{action}ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦patternéƒ¨åˆ†åˆ¤æ–­å€¼ä¸ºçœŸï¼ˆé0ï¼‰å°±æ‰“å°è¯¥è¡Œï¼Œå¦åˆ™å°±è·³è¿‡ä¸æ‰“å°\nï¼åœ¨awkæ˜¯å–ç›¸åçš„æ„æ€ï¼Œå°±æ˜¯æŠŠå¯¹çš„å˜æˆé”™çš„æŠŠçœŸçš„å˜æˆå‡çš„ï¼Œæ”¾åœ¨è¿™ä¸ªå‘½ä»¤ä¸­æ˜¯ç¥é©¬ä½œç”¨ä¸€ä¼šè§£é‡Šï¼›\na[$0] è¿™ä¸ªéå¸¸å¥½ç†è§£ï¼Œå»ºç«‹æ•°ç»„aï¼Œå…¶å˜é‡æ˜¯æ–‡æœ¬ä¸­çš„æ¯ä¸€è¡Œï¼Œawké‡Œ$1æ˜¯ç¬¬ä¸€åˆ—ï¼Œ$2æ˜¯ç¬¬äºŒåˆ—ï¼Œä»¥æ­¤ç±»æ¨$NFæ˜¯æœ€åä¸€åˆ—ï¼Œè€Œ$0æ˜¯ä»£è¡¨æ‰€æœ‰åˆ—åŠåˆ†éš”ç¬¦ï¼Œä¹Ÿå°±æ˜¯ä¸€æ•´è¡Œï¼Œè¿™æ ·å¦‚æœpatternæ˜¯çœŸçš„é‚£å°±æ‰“å°ä¸€æ•´è¡Œ\n++çš„æ„æ€æ˜¯aæ•°ç»„å–å˜é‡å®Œæ¯•åï¼Œå¯¹è¯¥æ•°ç»„å€¼+1\næ‰¾ä¸ªæœ€ç®€å•çš„æ–‡æ¡£æ¥è§£é‡Šä¸€ä¸‹\ncat file xxx yyy xxx zzz è¿™ä¸ªæ–‡ä»¶æœ‰4è¡Œï¼Œå…¶ä¸­ç¬¬ä¸€ã€ä¸‰è¡Œæ˜¯é‡å¤çš„ã€‚å¥—ç”¨è¿™ä¸ªå‘½ä»¤å¤„ç†æµç¨‹å¦‚ä¸‹ï¼š\nè·å–ç¬¬ä¸€è¡Œa[xxx]ï¼Œå› ä¸ºè¿™æ˜¯ç¬¬ä¸€è¡Œï¼Œæ•°ç»„aé‡Œä»æ²¡è§è¿‡xxxè¿™ä¸ªå˜é‡ï¼Œé‚£ä¹ˆè‡ªç„¶ä»–çš„å€¼å°±æ˜¯å‡ï¼ˆ0ï¼‰ä¹Ÿå°±æ˜¯è¯´a[xxx]=0ï¼Œè¿™ä¸ªæ—¶å€™ï¼å°±æœ‰å¤§ä½œç”¨äº†ï¼Œä»–æŠŠa[xxx]å‡ï¼ˆ0ï¼‰å˜æˆäº†a[xxx]ä¸ºçœŸï¼ˆ!0ï¼‰è¿™ä¸ªæ—¶å€™åŸæœ¬ä¸è¯¥æ‰“å°çš„ç¬¬ä¸€è¡Œå°±å˜æˆäº†åº”è¯¥æ‰“å°äº†ï¼Œå–é€»è¾‘ååå¯¹a[xxx]çš„å€¼+1ç„¶åå¤„ç†ç¬¬äºŒè¡Œ\nç¬¬äºŒè¡Œa[yyy]è¿™ä¸ªæƒ…å†µè·Ÿåˆšæ‰ç¬¬ä¸€è¡Œçš„a[xxx]ä¸€æ ·ï¼Œä¹Ÿåº”è¯¥æ‰“å°ä»–\nåˆ°ç¬¬ä¸‰è¡Œçš„æ—¶å€™æƒ…å†µå˜äº†ï¼Œå› ä¸ºç¬¬ä¸€è¡Œå·²ç»å‡ºç°è¿‡a[xxx]å¹¶ä¸”å·²ç»++è¿‡äº†ï¼Œä»–çš„å€¼å·²ç»æ˜¯é0è€Œä¸æ˜¯å‰ä¸¤è¡Œçš„0äº†ï¼Œæœ¬åº”æ‰“å°ä½†è¿™æ—¶å€™å†ç”±ï¼å–é€»è¾‘åå°±ä¸å¿…æ‰“å°äº†\nç¬¬å››è¡Œa[zzz]å°±åˆå’Œç¬¬ä¸€ã€äºŒä¸¤è¡Œä¸€æ ·äº†ã€‚\næ‰€ä»¥æ‰§è¡Œå®Œå°±æ˜¯è¿™ä¸ªç»“æœ\nawk \u0026#39;!a[$0]++\u0026#39; file xxx yyy zzz å†æŠŠfileæç¨å¾®å¤æ‚ç‚¹\nawk \u0026#39;{print NR,$0}\u0026#39; file 1 xxx 2 yyy 3 zzz 4 xxx 5 yyy 6 zzz 7 xxx 8 yyy 9 zzz ä¸€å…±9è¡Œæ–‡æœ¬ï¼Œ3è¡Œä¸€æ¬¡é‡å¤ã€‚ä¸ºäº†çœ‹å¾—æ›´æ¸…æ¥šï¼Œæœ¬æ¥é»˜è®¤çš„{print $0}ç¨å¾®æ”¹ä¸‹ï¼Œå˜æˆ{print NR,$0} NRè¡¨ç¤ºè¡Œå·ã€‚\né‚£ä¹ˆç°åœ¨æ¥æ‰§è¡Œä¸‹åˆšæ‰è®²çš„è¯•è¯•çœ‹\nawk \u0026#39;!a[$0]++{print NR,$0}\u0026#39; file 1 xxx 2 yyy 3 zzz awk \u0026#39;a[$0]++{print NR,$0}\u0026#39; file 4 xxx 5 yyy 6 zzz 7 xxx 8 yyy 9 zzz ","date":"2019-11-09T18:05:59Z","permalink":"https://dccmmtop.github.io/posts/%E5%8E%BB%E9%99%A4%E9%87%8D%E5%A4%8D%E8%A1%8C/","section":"posts","tags":["linux"],"title":"å»é™¤é‡å¤è¡Œ"},{"categories":null,"contents":"æ ¹æ®é¡¹ç›®çš„è¿›å±•ï¼Œæˆ‘ä»¬éœ€è¦å®ç°åå°è¿›è¡Œå®šæ—¶è¯»å–ä¿¡æ¯çš„åŠŸèƒ½ï¼Œè€Œæœ€å…³é”®çš„å®ç°éƒ¨åˆ†æ˜¯å‘¨æœŸæ€§åŠŸèƒ½ï¼Œæ ¹æ®è°ƒç ”ï¼Œå†³å®šä½¿ç”¨wheneveræ¥å®ç°è¿™ä¸€åŠŸèƒ½ã€‚\ngithubï¼šhttps://github.com/javan/whenever\nå¼€å‘å‰éœ€è¦æ˜ç¡®çš„é—®é¢˜ wheneveræ˜¯æ€æ ·ä¸€ç§å‘¨æœŸæ€§æœºåˆ¶ï¼Ÿ wheneverèƒ½ä¸ºæˆ‘ä»¬æä¾›ä»€ä¹ˆåŠŸèƒ½ï¼Ÿ wheneverä¸ºå‘¨æœŸæ€§ä»»åŠ¡æä¾›äº†å“ªäº›æ§åˆ¶æ–¹å¼ï¼Ÿ é—®é¢˜è§£å†³\nwheneverå‘¨æœŸæ€§æœºåˆ¶\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹githubä¸Šé¢æ˜¯æ€ä¹ˆè¯´çš„ï¼š\nWhenever is a Ruby gem that provides a clear syntax for writing and deploying cron jobs.\næ„æ€å°±æ˜¯è¯´ï¼Œwheneveræ˜¯ä¸€ä¸ªruby gemï¼Œä½†åŒæ—¶å®ƒæ˜¯åŸºäºcron jobsçš„ã€‚\né‚£ä¹ˆä»€ä¹ˆæ˜¯cron jobså‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç»´åŸºç™¾ç§‘çš„å®šä¹‰ï¼š\nCron crontabå‘½ä»¤å¸¸è§äºUnixå’Œç±»Unixçš„æ“ä½œç³»ç»Ÿä¹‹ä¸­ï¼Œç”¨äºè®¾ç½®å‘¨æœŸæ€§è¢«æ‰§è¡Œçš„æŒ‡ä»¤ã€‚è¯¥å‘½ä»¤ä»æ ‡å‡†è¾“å…¥è®¾å¤‡è¯»å–æŒ‡ä»¤ï¼Œå¹¶å°†å…¶å­˜æ”¾äºâ€œcrontabâ€æ–‡ä»¶ä¸­ï¼Œä»¥ä¾›ä¹‹åè¯»å–å’Œæ‰§è¡Œã€‚è¯¥è¯æ¥æºäºå¸Œè…Šè¯­chronosï¼ˆÏ‡ÏÏŒÎ½Î¿Ï‚ï¼‰ï¼ŒåŸæ„æ˜¯æ—¶é—´ã€‚\né€šå¸¸ï¼Œcrontabå‚¨å­˜çš„æŒ‡ä»¤è¢«å®ˆæŠ¤è¿›ç¨‹æ¿€æ´»ï¼Œcrondå¸¸å¸¸åœ¨åå°è¿è¡Œï¼Œæ¯ä¸€åˆ†é’Ÿæ£€æŸ¥æ˜¯å¦æœ‰é¢„å®šçš„ä½œä¸šéœ€è¦æ‰§è¡Œã€‚è¿™ç±»ä½œä¸šä¸€èˆ¬ç§°ä¸ºcron jobsã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œcrontabæ˜¯åœ¨unixå’Œç±»unixç³»ç»Ÿä¸­ç”¨æ¥å®ç°å‘¨æœŸæ€§åŠŸèƒ½çš„æŒ‡ä»¤ã€‚åœ¨ç½‘ä¸Šæœä¸€ä¸‹ï¼Œæˆ‘ä»¬å°±ä¼šçœ‹åˆ°å¾ˆå¤šcrontabæŒ‡ä»¤ç›¸å…³çš„è¯­æ³•ã€‚\næ ¹æ®ä¸Šè¿°çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºè¿™æ ·çš„ç»“è®ºï¼š\nwheneveräº‹å®ä¸Šæ˜¯ä¸€ä¸ªcronç¿»è¯‘å™¨ï¼Œå®ƒå°†railsä¸­çš„rubyä»£ç ç¿»è¯‘æˆcronè„šæœ¬ï¼Œä»è€Œå°†å‘¨æœŸæ€§çš„ä»»åŠ¡äº¤ç»™cronæ¥æ‰§è¡Œã€‚ è¿™æ ·ï¼Œé€šè¿‡wheneveræˆ‘ä»¬å¯ä»¥ä½¿ç”¨rubyè¯­è¨€æ¥å†™å‘¨æœŸæ€§ä»»åŠ¡ä»£ç ï¼Œåœ¨rubyå±‚æ§åˆ¶ä»£ç ï¼Œè€Œä¸éœ€è¦ä¸shellè„šæœ¬è¿›è¡Œåˆ‡æ¢ï¼›å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œç”±äºcronå‘½ä»¤çš„å¼ºå¤§ï¼Œå®ƒçš„è¯­æ³•ä¹Ÿå› æ­¤å˜å¾—å¾ˆå¤æ‚ï¼Œé€šè¿‡wheneverï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°å‘¨æœŸæ€§ä»»åŠ¡ã€‚\nä¸€ä¸ªååˆ†ç®€å•çš„demo 1.æ·»åŠ whenever(Gemfile)\ngem 'whenever', :require =\u0026gt;false\n2.ç”Ÿæˆconfig/schedule.rbæ–‡ä»¶\næ‰§è¡Œå‘½ä»¤ï¼š\nwheneverize\n3.æ·»åŠ è‡ªå·±çš„å‘¨æœŸæ€§ä»»åŠ¡\nåœ¨config/schedule.rbæ–‡ä»¶ä¸­æ·»åŠ ï¼š\nset :environment, :development every 2.minutes do runner \u0026#34;Timetest.mytime\u0026#34; end å…¶ä¸­ï¼Œset :environment, :developmentæ˜¯è®¾ç½®æ‰§è¡Œä»»åŠ¡æ—¶çš„ç¯å¢ƒï¼Œé»˜è®¤æƒ…å†µä¸‹ç¯å¢ƒä¸ºproduction\nä¸Šè¿°ä»£ç å®ç°çš„æ˜¯æ¯ä¸¤åˆ†é’Ÿè¯»å–å½“å‰æ—¶é—´å¹¶å­˜å…¥åˆ°æ•°æ®åº“çš„åŠŸèƒ½ã€‚å…¶ä¸­ï¼Œrunneræ–¹æ³•æ‰§è¡Œçš„æ–¹æ³•å¦‚ä¸‹ï¼š\nclassTimetest \u0026lt; ApplicationRecord def self.mytime a = Timetest.new a.time_now = Time.now a.save end end è¿™æ ·ï¼Œåœ¨railsä¸­å®ç°wheneverçš„ä»£ç å°±ç®—æ˜¯å†™å®Œäº†ï¼ŒçœŸçš„æ˜¯ç®€å•åˆ°ä¸è¡Œå•Šï¼ï¼ˆå®åœ¨å¿ä¸ä½æ„Ÿæ…¨ä¸€å¥ï¼‰\nä¸‹é¢å°±è¦æ‰§è¡Œå‘¨æœŸæ€§ä»»åŠ¡äº†ã€‚\n4.æ‰§è¡Œå‘¨æœŸæ€§ä»»åŠ¡\nåœ¨railså·¥ç¨‹æ–‡ä»¶å¤¹ä¸‹è¿›è¡Œä¸€ä¸‹æ“ä½œ\næ›´æ–°schedule.rbä¸­çš„ä»»åŠ¡åˆ°cronjobä¸­ whenever -i\nå¯ä»¥çœ‹åˆ°è¿™æ ·çš„æ‰“å°ç»“æœï¼š\n[write]crontabfileupdated\næ‰§è¡Œå‘¨æœŸæ€§ä»»åŠ¡ whenever -w\nå¯ä»¥çœ‹åˆ°ï¼š\n[write]crontabfilewritten\næ­¤æ—¶æˆ‘ä»¬çš„å‘¨æœŸæ€§ä»»åŠ¡ä¾¿åœ¨åå°è¿è¡Œäº†ï¼Œæ­¤æ—¶æŸ¥çœ‹æˆ‘ä»¬çš„ä»»åŠ¡ï¼š\ncrontab -l\nå¯ä»¥çœ‹åˆ°ä»¥ä¸‹æ‰“å°ï¼š\n# Begin Whenever generated tasks for:\n/home/vito/rails/test_of_rails/test_rails/config/schedule.rb0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,32,34,36,38,40,42,44,46,48,50,52,54,56,58 * * * * /bin/bash -l -c \u0026#39;cd /home/vito/rails/test_of_rails/test_rails \u0026amp;\u0026amp; bundle exec bin/rails runner -e development \u0026#39;\\\u0026#39;\u0026#39;Timetest.mytime\u0026#39;\\\u0026#39;\u0026#39;\u0026#39;# End Whenever generated tasks for: /home/vito/rails/test_of_rails/test_rails/config/schedule.rb è¿™æ ·ï¼Œæˆ‘ä»¬çš„å‘¨æœŸæ€§ä»»åŠ¡å°±ç®—æ˜¯åœ¨é¡ºåˆ©æ‰§è¡Œäº†ã€‚\néœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯è¿è¡Œæ—¶crontabçš„ç¯å¢ƒï¼ˆrailså’Œcrontabç¯å¢ƒä¸åŒ¹é…æ—¶wheneveræ— æ³•æ‰§è¡Œï¼‰ï¼Œä¸€èˆ¬è°ƒè¯•æ—¶å¤šä½¿ç”¨çš„æ˜¯developmentç¯å¢ƒï¼Œè€Œä¸è®¾ç½®æ—¶é»˜è®¤çš„æ˜¯productionç¯å¢ƒï¼Œå¦‚æœä½ ä½¿ç”¨crontab -lå‘ç°æ˜¯productionç¯å¢ƒï¼Œå¯ä»¥ä½¿ç”¨\ncrontab -e\nç›´æ¥ä¿®æ”¹ä¸ºdevelopmentï¼Œæˆ–è€…ç›´æ¥å°†-e productionåˆ æ‰å³å¯ã€‚\nç»è¿‡ä¸Šè¿°æµç¨‹ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥æˆåŠŸåœ°å®ç°å‘¨æœŸæ€§ä»»åŠ¡äº†ã€‚å¦‚æœæ­¤æ—¶ä½ å‘ç°è‡ªå·±çš„å‘¨æœŸæ€§ä»»åŠ¡è¿˜æ˜¯æ²¡æœ‰æ‰§è¡Œï¼Œé‚£ä½ å°±å¾—å¥½å¥½çœ‹çœ‹ä½ è‡ªå·±çš„ä»»åŠ¡ä»£ç äº†ï¼Œå¾ˆå¯èƒ½æ˜¯æ‰§è¡Œçš„ä»»åŠ¡ä»£ç æœ¬èº«æœ‰é—®é¢˜ï¼Œè€Œä¸wheneverçš„å®ç°æ²¡æœ‰å¤ªå¤§çš„å…³ç³»äº†ã€‚\n","date":"2019-10-31T22:04:20Z","permalink":"https://dccmmtop.github.io/posts/whenever%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F/","section":"posts","tags":["ruby"],"title":"wheneverä½¿ç”¨æ–¹å¼"},{"categories":null,"contents":"ä»¥å‰å°±é‡åˆ°è¿‡çš„é—®é¢˜ã€‚æœ‰å¦‚ä¸‹æƒ…æ™¯ï¼š\n1.å‡è®¾ç°åœ¨æˆ‘è¦å°†æ–‡ä»¶açš„éƒ¨åˆ†å†…å®¹å¤åˆ¶åˆ°æ–‡ä»¶bä¸­ï¼Œä¸€èˆ¬æƒ…å†µï¼Œæˆ‘ä¼šç”¨vsæˆ–è€…spå‘½ä»¤æ‰“å¼€è¿™ä¸¤ä¸ªæ–‡ä»¶ç„¶åç”¨yå’Œpè¿›è¡Œå¤åˆ¶ç²˜è´´ã€‚ä½†æ˜¯å¦‚æœåˆ†åˆ«ç”¨vimæ‰“å¼€è¿™ä¸¤ä¸ªæ–‡ä»¶å°±ä¸èƒ½å®Œæˆä¸Šè¿°åŠ¨ä½œã€‚\n2.å‡è®¾æˆ‘å…ˆåœ¨è¦æŠŠvimæ‰“å¼€çš„æºä»£ç ä¸­çš„éƒ¨åˆ†å†…å®¹å¤åˆ¶åˆ°åšå®¢ä¸­ï¼Œä¸€èˆ¬æˆ‘ä¼šç”¨vimç¼–è¾‘å¥½ä»¥åï¼Œé€€å‡ºç”¨geditæ‰“å¼€ï¼Œæˆ–è€…catä¸€ä¸‹ï¼Œå†å¤åˆ¶åˆ°ç³»ç»Ÿå‰ªåˆ‡æ¿ï¼Œå†ç²˜è´´ã€‚\nä»Šå¤©ï¼Œå¯¹äºvimè¿™ä¸ªæ²¡åŠæ³•è·Ÿâ€œå¤–ç•Œâ€äº¤æµçš„ç‰¹æ€§å¿å¤Ÿäº†ï¼Œå†³å®šè§£å†³ä¸€ä¸‹ã€‚\n1.é¦–å…ˆï¼ŒæŸ¥çœ‹vimç‰ˆæœ¬æ˜¯å¦æ”¯æŒclipboard vim --version | grep \u0026#34;clipboard\u0026#34;1 ç»“æœå¦‚ä¸‹ï¼š\nclipboard å‰é¢æœ‰ä¸€ä¸ªå°å°çš„å‡å·ï¼Œè¯´æ˜ä¸æ”¯æŒã€‚\n2.å¦‚æœä¸æ”¯æŒçš„è¯ï¼Œéœ€è¦å®‰è£…å›¾å½¢åŒ–ç•Œé¢çš„vimï¼Œæˆ–è€…é‡æ–°ç¼–è¯‘vim sudo apt-get install vim-gnome1 å®‰è£…å®Œæˆåå†æ¬¡æ‰§è¡Œï¼š\nvim --version | grep \u0026#34;clipboard\u0026#34;1 å‘ç°å·²ç»æ”¯æŒclipboard\n3.vimçš„å¯„å­˜å™¨ æ‰“å¼€vimè¾“å…¥:regæŸ¥çœ‹vimçš„å¯„å­˜å™¨ï¼Œå½“æ”¯æŒclipboardä¹‹åï¼Œä¼šå¤šå‡º\u0026quot;+å¯„å­˜å™¨ï¼Œè¡¨ç¤ºç³»ç»Ÿå‰ªåˆ‡æ¿ï¼Œåœ¨vimä¸­è¿›å…¥visualè§†å›¾åä½¿ç”¨\u0026quot;Ny(Nè¡¨ç¤ºç‰¹å®šå¯„å­˜å™¨ç¼–å¥½)ï¼Œå°†å†…å®¹å¤åˆ¶åˆ°ç‰¹å®šçš„å‰ªåˆ‡æ¿ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ç›®çš„æ˜¯è¦å¤åˆ¶åˆ°ç³»ç»Ÿå‰ªåˆ‡æ¿åˆ™éœ€è¦é€‰ä¸­å†…å®¹åè¾“å…¥å‘½ä»¤ï¼š\n\u0026#34;+y1 ç²˜è´´åˆ°ç‰¹å®šçš„å¯„å­˜å™¨ä¹Ÿæ˜¯åŒç†ã€‚ä¾‹å¦‚\u0026quot;+på°†ç³»ç»Ÿå‰ªåˆ‡æ¿çš„å†…å®¹æ‹·è´åˆ°vimä¸­ï¼ˆéç¼–è¾‘æ¨¡å¼ä¸‹ï¼‰ã€‚\n4. æ˜ å°„\n\u0026#34; ä»ç³»ç»Ÿå‰ªåˆ‡æ¿ç²˜è´´ nnoremap P \u0026#34;+p \u0026#34; å¤åˆ¶åˆ°ç³»ç»Ÿå‰ªåˆ‡æ¿ vmap Y \u0026#34;+y ","date":"2019-10-31T22:01:14Z","permalink":"https://dccmmtop.github.io/posts/vim%E4%B8%AD%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%B2%98%E8%B4%B4%E5%92%8C%E5%A4%8D%E5%88%B6/","section":"posts","tags":["vim"],"title":"vimä¸­ä¸ç³»ç»Ÿçš„ç²˜è´´å’Œå¤åˆ¶"},{"categories":null,"contents":"è‡ªå®šä¹‰è„šæœ¬ ç¼–å†™è‡ªå·±çš„éœ€è¦å¼€å¯è‡ªå¯çš„è„šæœ¬ï¼Œå¦‚ä¸‹ï¼š\n#!/usr/bin/env ruby `cd /home/mc/code/rails_app/master_crawler_trm \u0026amp;\u0026amp; nohup rake real_time_extract_word \u0026gt; /dev/null 2\u0026amp;\u0026gt;1` å¯åŠ¨è„šæœ¬ #!/usr/bin/env ruby start = \u0026#34; sudo -u mc /home/mc/bin/real_time_extract_words \u0026#34; stop = \u0026#34;ps -ef | grep real_time_extract_word | grep -v grep | cut -c 9-15 | xargs kill -9\u0026#34; action = ARGV[0] if action == \u0026#39;start\u0026#39; system(start) puts \u0026#34;å¯åŠ¨æˆåŠŸ\u0026#34; elsif action == \u0026#39;stop\u0026#39; system(stop) puts \u0026#34;å·²åœæ­¢\u0026#34; elsif action == \u0026#39;restart\u0026#39; system(stop) system(start) puts \u0026#34;å·²é‡å¯\u0026#34; end è¿™ä¸ªæ–‡ä»¶å¯ä»¥è¢« ubuntu ä¸‹çš„æœåŠ¡è¯»å–å¹¶æ‰§è¡Œï¼Œä¿å­˜è¯¥æ–‡ä»¶ä¸º custom_sh ç„¶å sudo chmod +x custom_shèµ‹äºˆå¯æ‰§è¡Œæƒé™\nè¦æ³¨æ„è‡ªå·±çš„è„šæœ¬éœ€è¦åœ¨å“ªä¸ªç”¨æˆ·ä¸‹æ‰§è¡Œ\næ“ä½œè¯¥æœåŠ¡ sudo systemctl daemon-reload # æ·»åŠ æ–°çš„ æˆ–è€…æ”¹åŠ¨ æœåŠ¡ä¹‹åè¦åˆ·æ–° sudo service custom_sh start # å¯åŠ¨ sudo service custom_sh stop # åœæ­¢ sudo service custom_sh status # æŸ¥çœ‹çŠ¶æ€ å¼€å¯è‡ªå¯ sudo update-rc.d custom_sh defaults ","date":"2019-04-28T17:59:37Z","permalink":"https://dccmmtop.github.io/posts/ubuntu%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%9C%8D%E5%8A%A1%E4%BB%A5%E5%8F%8A%E5%BC%80%E6%9C%BA%E8%87%AA%E5%90%AF/","section":"posts","tags":["linux"],"title":"ubuntuä¸­æ·»åŠ æœåŠ¡ä»¥åŠå¼€æœºè‡ªå¯"},{"categories":null,"contents":"å‡å¦‚å·²ç»è¿æ¥çš„çš„æ•°æ®åº“åæ˜¯ word_development, ç°åœ¨éœ€è¦æ·»åŠ ä¸€ä¸ªåä¸º trademark_development å’Œ trademark_test çš„æœ¬åœ°æ•°æ®åº“\næ­¥éª¤å¦‚ä¸‹:\næ·»åŠ é…ç½®ä¿¡æ¯ åœ¨ config/database.yml æ·»åŠ å¦‚ä¸‹ä¿¡æ¯\ntrademark_default: \u0026amp;trademark_default adapter: postgresql encoding: unicode pool: \u0026lt;%= ENV.fetch(\u0026#34;RAILS_MAX_THREADS\u0026#34;) { 5 } %\u0026gt; trademark_development: \u0026lt;\u0026lt;: *trademark_default database: trademark_development # å¦‚æœæ˜¯è¿œç¨‹çš„æ•°æ®åº“æ·»åŠ å¦‚ä¸‹ä¿¡æ¯ #username: username #password: 123456 #host: xxxx #port: xxx trademark_test: \u0026lt;\u0026lt;: *trademark_default database: trademark_test å…³è” model æ¨¡ä»¿ ApplicationRecord è¿™ä¸ªæŠ½è±¡ç±»ï¼Œæ–°å»ºä¸€ä¸ª TrademarkBase æŠ½è±¡ç±»ï¼Œç„¶åæŒ‡æ˜è¿™ä¸ªç±»è¿æ¥çš„æ•°æ®åº“çš„é…ç½®\nclass TrademarkBase \u0026lt; ActiveRecord::Base self.abstract_class = true establish_connection \u0026#34;trademark_#{Rails.env}\u0026#34;.to_sym end ç»§æ‰¿æŠ½è±¡ç±» æ–°å»ºçš„ model ç»§æ‰¿è¯¥ç±»ï¼Œç„¶åæŒ‡å®šè¡¨å\nclass TrademarkUser \u0026lt; TrademarkBase self.table_name = :users end æµ‹è¯• è¿›å…¥æ§åˆ¶å°ä¸­\npry(main)\u0026gt; TrademarkUser =\u0026gt; TrademarkUser (call \u0026#39;TrademarkUser.connection\u0026#39; to establish a connection) å¯ä»¥çœ‹åˆ°æˆåŠŸå…³è”å¦ä¸€ä¸ªæ•°æ®åº“ä¸­çš„è¡¨å¯¹è±¡\n","date":"2019-04-03T11:48:31Z","permalink":"https://dccmmtop.github.io/posts/rails%E8%BF%9E%E6%8E%A5%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93/","section":"posts","tags":["rails"],"title":"Railsè¿æ¥å¤šä¸ªæ•°æ®åº“"},{"categories":null,"contents":" æ‘˜æŠ„è‡ª ã€ŠposrgreSQL ä¿®ç‚¼ä¹‹é“ ä»å°å·¥åˆ°ä¸“å®¶ã€‹\nè§¦å‘å™¨ï¼ˆtriggerï¼‰æ˜¯ä¸€ç§ç”±äº‹ä»¶è‡ªåŠ¨è§¦å‘æ‰§è¡Œçš„ç‰¹æ®Šçš„å­˜å‚¨è¿‡ç¨‹ï¼Œè¿™äº›äº‹ä»¶å¯ä»¥æ˜¯å¯¹ä¸€ä¸ªè¡¨è¿›è¡Œ INSERT,UPDATE,DELETE ç­‰æ“ä½œ\nè§¦å‘å™¨ç»å¸¸ç”¨äºåŠ å¼ºæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸå’Œä¸šåŠ¡è§„åˆ™ä¸Šçš„çº¦æŸç­‰\nåˆ›å»ºè§¦å‘å™¨ åˆ›å»ºè§¦å‘å™¨çš„è¯­æ³•å¦‚ä¸‹\nCREATE [ CONSTRAINT ] TRIGGER name { BEFORE | AFTER | INSTEAD OF } { event [ OR ... ] } ON table_name [ FROM referenced_table_name ] [ NOT DEFERRABLE | [ DEFERRABLE ] [ INITIALLY IMMEDIATE | INITIALLY DEFERRED ] ] [ REFERENCING { { OLD | NEW } TABLE [ AS ] transition_relation_name } [ ... ] ] [ FOR [ EACH ] { ROW | STATEMENT } ] [ WHEN ( condition ) ] EXECUTE PROCEDURE function_name ( arguments ) åˆ›å»ºè§¦å‘å™¨çš„æ­¥éª¤ åˆ›å»ºæ‰§è¡Œå‡½æ•° å…ˆä¸ºè§¦å‘å™¨åˆ›å»ºä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼Œæ­¤å‡½æ•°çš„è¿”å›ç±»å‹ä¸ºè§¦å‘å™¨ç±»å‹ï¼Œç„¶åå³å¯åˆ›å»ºç›¸åº”çš„è§¦å‘å™¨\nä¸‹é¢ä½¿ç”¨ä¸€ä¸ªä¾‹å­æ¥è®²è§£è§¦å‘å™¨çš„ä½¿ç”¨ï¼Œå‡è®¾æœ‰ä¸€å¼ å­¦ç”Ÿè¡¨ï¼ˆstudentï¼‰ï¼Œå’Œä¸€å¼ è€ƒè¯•æˆç»©è¡¨ï¼ˆscoreï¼‰\nCREATE TABLE student( student_no int primary key, student_name varchar(40), age int ) CREATE TABLE score( student_no int, chinese_no int, math_score int, test_date date ) å¦‚æœæƒ³åˆ é™¤å­¦ç”Ÿè¡¨çš„ä¸€æ¡è®°å½•æ—¶ï¼ŒæŠŠè¿™ä¸ªå­¦ç”Ÿåœ¨æˆç»©è¡¨ä¸­çš„æˆç»©ä¹Ÿåˆ é™¤æ‰ï¼Œè¿™æ—¶å°±å¯ä»¥ä½¿ç”¨è§¦å‘å™¨ã€‚å…ˆå»ºè§¦å‘å™¨çš„æ‰§è¡Œå‡½æ•°ï¼š\nCREATE OR REPLACE FUNCTION student_delete_trigger() RETURNS TRIGGER AS $$ BEGIN DELETE FROM score WHERE student_no = OLD.student_no; RETURN OLD; END; $$ LANGUAGE plpgsql; åˆ›å»ºè§¦å‘å™¨ CREATE TRIGGER delete_student_trigger AFTER DELETE ON student FOR EACH ROW EXECUTE PROCEDURE student_delete_trigger(); æµ‹è¯• æŒ‰ç…§ä¸Šé¢çš„è¯­å¥åˆ›å»ºå¥½è§¦å‘å™¨åè¿˜éœ€è¦ç›¸åº”çš„æµ‹è¯•ï¼Œå…ˆæ’å…¥ä¸€äº›æµ‹è¯•æ•°æ®ï¼š\nINSERT INTO student VALUES(1, \u0026#39;å¼ ä¸‰\u0026#39;, 14); INSERT INTO student VALUES(2, \u0026#39;æå››\u0026#39;, 13); INSERT INTO student VALUES(3, \u0026#39;ç‹äºŒ\u0026#39;, 15); INSERT INTO score VALUES(1, 85, 75, date \u0026#39;2013-05-23\u0026#39;); INSERT INTO score VALUES(1, 89, 73, date \u0026#39;2013-09-18\u0026#39;); INSERT INTO score VALUES(2, 68, 83, date \u0026#39;2013-05-23\u0026#39;); INSERT INTO score VALUES(2, 73, 85, date \u0026#39;2013-09-18\u0026#39;); INSERT INTO score VALUES(3, 72, 79, date \u0026#39;2013-05-23\u0026#39;); INSERT INTO score VALUES(3, 78, 82, date \u0026#39;2013-05-23\u0026#39;); ç°åœ¨æŠŠå­¦å¥½ä¸º 3 çš„å­¦ç”Ÿ â€œç‹äºŒâ€ ä»è¡¨ \u0026ldquo;student\u0026rdquo; åˆ æ‰ï¼š\nDELETE FROM stduent WHERE student_no = 3; è¿™æ—¶å¯ä»¥æŸ¥è¯¢æˆç»©è¡¨ \u0026lsquo;score\u0026rsquo; å¯ä»¥å‘ç°å­¦å·ï¼ˆstudent_no ï¼‰ ä¸º 3 çš„å­¦ç”Ÿæˆç»©è®°å½•ä¹Ÿè¢«åˆ é™¤æ‰äº†\nè¯­å¥çº§è§¦å‘å™¨ä¸è¡Œçº§è§¦å‘å™¨ è¯­å¥çº§è§¦å‘å™¨ è¯­å¥çº§è§¦å‘å™¨æ˜¯æŒ‡æ‰§è¡Œæ¯ä¸ª SQL æ—¶ï¼Œåªæ‰§è¡Œä¸€æ¬¡ï¼Œè¡Œçº§è§¦å‘å™¨æ˜¯æŒ‡æ¯è¡Œå°±ä¼šæ‰§è¡Œä¸€æ¬¡ã€‚ä¸€ä¸ªä¿®æ”¹ 0 è¡Œçš„æ“ä½œä»»ç„¶ä¼šå¯¼è‡´åˆé€‚çš„è¯­å¥çº§è§¦å‘å™¨è¢«æ‰§è¡Œã€‚ä¸‹é¢æ¥çœ‹çœ‹ç›¸åº”çš„ç¤ºä¾‹ã€‚\nå‡è®¾å¯¹ student çš„æ›´æ–°æƒ…å†µè®°å½• logã€‚å¯ä»¥ä¸º student å»ºä¸€å¼  log è¡¨ï¼Œå¦‚ä¸‹ï¼š\nCREATE TABLE log_student( update_time timetamp, --æ“ä½œçš„æ—¶é—´ db_user varchar(40), --æ“ä½œçš„æ•°æ®åº“ç”¨æˆ·å opr_type varchar(6), --æ“ä½œç±»å‹ï¼šinsert delete udate ); åˆ›å»ºè®°å½• log çš„è§¦å‘å™¨å‡½æ•°ï¼š\nCREATE FUNCTION log_student_trigger() RETURNS trigger AS $$ BEGIN INSERT INTO log_student values(now(), user, TG_OP); RETURN NULL; END; $$ LANGUAGE \u0026#34;plpgsql\u0026#34;; ä¸Šé¢å‡½æ•°ä¸­çš„ \u0026ldquo;TG_OP\u0026rdquo; æ˜¯è§¦å‘å™¨ä¸­çš„ç‰¹æ®Šå˜é‡ï¼Œä»£è¡¨ DML æ“ä½œç±»å‹ã€‚\nç„¶ååœ¨ student è¡¨ä¸Šåˆ›å»ºä¸€ä¸ªè¯­å¥çº§è§¦å‘å™¨ï¼š\nCREATE TRIGGER log_student_trigger AFTER INSERT OR UPDATE OR DELETE ON student FOR STATEMENT EXECUTE PROCEDURE log_student_trigger(); åˆ é™¤è§¦å‘å™¨ drop trigger log_student_log on student; è¯­å¥çº§è§¦å‘å™¨å³ä½¿åœ¨æ²¡æœ‰æ›´æ–°åˆ°æ•°æ®æ—¶ï¼Œä¹Ÿä¼šè¢«è§¦å‘\nè¡Œçº§è§¦å‘å™¨ CREATE TRIGGER log_student_trigger_2 AFTER INSERT OR UPDATE OR DELETE ON student FOR ROW EXECUTE PROCEDURE log_student_trigger(); è¡Œçº§è§¦å‘å™¨å³ä½¿åœ¨æ²¡æœ‰æ›´æ–°åˆ°æ•°æ®æ—¶ï¼Œä¸ä¼šè¢«è§¦å‘\nBEFORE è§¦å‘å™¨å’Œ AFTER è§¦å‘å™¨ é€šå¸¸ï¼Œè¯­å¥çº§åˆ«çš„ \u0026ldquo;before\u0026rdquo; è§¦å‘å™¨æ˜¯åœ¨è¯­å¥å¼€å§‹åšä»»ä½•äº‹ä¹‹å‰è¢«è§¦å‘ï¼Œè€Œè¯­å¥çº§åˆ«çš„\u0026quot;after\u0026quot; è§¦å‘å™¨æ˜¯åœ¨è¯­å¥ç»“æŸæ—¶æ‰è§¦å‘çš„ã€‚è¡Œçº§åˆ«çš„\u0026quot;before\u0026quot; è§¦å‘å™¨æ˜¯åœ¨å¯¹ç‰¹å®šè¡Œè¿›è¡Œæ“ä½œä¹‹å‰è§¦å‘çš„ï¼Œè€Œè¡Œçº§åˆ«çš„ \u0026ldquo;after\u0026rdquo; è§¦å‘å™¨æ˜¯åœ¨è¯­å¥ç»“æŸæ—¶æ‰è§¦å‘çš„ï¼Œä½†æ˜¯å®ƒä¼šåœ¨ä»»ä½•è¯­å¥çº§åˆ«çš„ \u0026ldquo;after\u0026rdquo; è§¦å‘å™¨è¢«è§¦å‘ä¹‹å‰è§¦å‘\nBEFORE è§¦å‘å™¨å¯ä»¥ç›´æ¥ä¿®æ”¹ \u0026ldquo;NEW\u0026rdquo; å€¼ä»¥æ”¹å˜å®é™…æ›´æ–°çš„å€¼ï¼Œå…·ä½“ä¾‹å­å¦‚ä¸‹ï¼š\nå…ˆå»ºä¸€ä¸ªè§¦å‘å™¨å‡½æ•°ï¼š\nCREATE FUNCTION student_new_name_trigger() RETURNS trigger AS \u0026#39; BEGIN NEW.student_name = NEW.student_name || NEW.student_no; RETURN NEW; END; \u0026#39; LANGUAGE \u0026#34;plpgsql\u0026#34;; è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œæ’å…¥æˆ–è€…æ›´æ–°æ—¶ï¼Œåœ¨ \u0026ldquo;student_name\u0026rdquo; åé¢åŠ ä¸Š \u0026ldquo;student_no\u0026rdquo; å­¦å·ã€‚ä¹Ÿå°±æ˜¯ç›´æ¥ä¿®æ”¹ \u0026ldquo;NEW.student_name\u0026rdquo; ,è¯­å¥å¦‚ä¸‹ï¼š\nNEW.student_name = NEW.student_name||NEW.student_no åœ¨è¿™ä¸­æƒ…å†µä¸‹åªèƒ½ä½¿ç”¨ BEFORE è§¦å‘å™¨ï¼Œå› ä¸º BEFORE è§¦å‘å™¨æ˜¯åœ¨æ›´æ–°æ•°æ®ä¹‹å‰è§¦å‘çš„ï¼Œæ‰€ä»¥è¿™æ—¶ä¿®æ”¹äº†\u0026quot;NEW.student_name\u0026quot;, åé¢å®é™…æ›´æ–°åˆ°æ•°æ®åº“ä¸­çš„å€¼å°±å˜æˆäº† \u0026ldquo;student_name||student_no\u0026rdquo;\nå¦‚æœä½¿ç”¨äº† AFTER ï¼Œåˆ™ä¿®æ”¹ \u0026ldquo;NEW\u0026rdquo; æ˜¯æ²¡ç”¨çš„\nåˆ é™¤è§¦å‘å™¨ åˆ é™¤è§¦å‘å™¨çš„è¯­æ³•å¦‚ä¸‹ï¼š\nDROP TRIGGER [ IF EXISTS ] name ON table [CASCADE | RESTRICT ];\nå…¶ä¸­çš„è¯­æ³•è¯´æ˜å¦‚ä¸‹ã€‚\nIF EXISTS: å¦‚æœæŒ‡å®šçš„è§¦å‘å™¨ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå‘å‡ºä¸€ä¸ª notice è€Œä¸æ˜¯è·‘å‡ºä¸€ä¸ªé”™è¯¯ CASCADE: çº§è”åˆ é™¤ä¾èµ–æ­¤è§¦å‘å™¨çš„å¯¹è±¡ RESTRICT: è¿™æ˜¯é»˜è®¤å€¼ï¼Œå¦‚æœæœ‰ä»»ä½•ä¾èµ–å¯¹è±¡å­˜åœ¨ï¼Œé‚£ä¹ˆæ‹’ç»åˆ é™¤ **åœ¨ PostgresSQL ä¸­è¦åœ¨åˆ é™¤è§¦å‘å™¨çš„è¯­æ³•ä¸­æŒ‡å®š \u0026ldquo;ON table\u0026rdquo;ï¼Œè€Œåœ¨å…¶ä»–ä¸€äº›æ•°æ®åº“çš„è¯­å‘å¯èƒ½ç›´æ¥æ˜¯ \u0026ldquo;DROP TRIGGER name\u0026rdquo; **\nåˆ é™¤è§¦å‘å™¨æ—¶ï¼Œè§¦å‘å™¨çš„å‡½æ•°ä¸ä¼šè¢«åˆ é™¤ã€‚ä¸è¿‡ï¼Œå½“è¡¨åˆ é™¤æ—¶ï¼Œè¡¨ä¸Šçš„è§¦å‘å™¨ä¹Ÿä¼šè¢«åˆ é™¤\nè§¦å‘å™¨çš„è¡Œä¸º è§¦å‘å™¨å‡½æ•°ä¸è¿”å›å€¼ã€‚è¯­å¥çº§è§¦å‘å™¨æ€»æ˜¯è¿”å› NULLã€‚ å³å¿…é¡»æ˜¾å¼çš„åœ¨è§¦å‘å™¨å‡½æ•°ä¸­å†™ä¸Š \u0026ldquo;RETURN NULL\u0026rdquo;, å¦‚æœæ²¡æœ‰å†™ï¼Œå°†å¯¼è‡´å‡ºé”™ã€‚\nå¯¹äº \u0026ldquo;BEFORE\u0026rdquo; å’Œ \u0026ldquo;INSTEAD OF\u0026rdquo; è¿™ç±»è¡Œçº§è§¦å‘å™¨å‡½æ•°æ¥è¯´ï¼Œå¦‚æœè¿”å›çš„æ˜¯ NULLï¼Œ åˆ™è¡¨ç¤ºå¿½ç•¥å¯¹å½“å‰è¡Œçš„æ“ä½œï¼Œå¦‚æœè¿”å›çš„æ˜¯é NULL è¡Œï¼Œå¯¹ä¸ INSERT å’Œ UPDATE æ¥è¯´ï¼Œè¿”å›çš„è¡Œå°†æˆä¸ºè¢«æ’å…¥çš„è¡Œæˆ–å°†è¦æ˜¯æ›´æ–°çš„è¡Œã€‚\nå¯¹äºã€€AFTER è¿™ç±»è¡Œçº§è§¦å‘å™¨æ¥è¯´ï¼Œå…¶è¿”å›å€¼å°†ä¼šè¢«å¿½ç•¥ã€‚\nå¦‚æœåŒä¸€æ—¶é—´ä¸Šæœ‰å¤šä¸ªè§¦å‘å™¨ï¼Œåˆ™å°†æŒ‰è§¦å‘å™¨åå­—çš„é¡ºåºæ¥è§¦å‘ã€‚ã€€å¦‚æœæ˜¯ã€€\u0026ldquo;BEFORE\u0026rdquo; å’Œã€€\u0026ldquo;INTEAD OF\u0026rdquo; è¡Œçº§è§¦å‘å™¨ï¼Œæ¯ä¸ªè§¦å‘å™¨æ‰€è¿”å›çš„è¡Œï¼ˆå¯èƒ½å·²ç»è¢«ä¿®æ”¹ï¼‰å°†æˆä¸ºä¸‹ä¸€ä¸ªè§¦å‘å™¨çš„è¾“å…¥ï¼Œå¦‚æœ\u0026quot;BEFORE\u0026quot; å’Œã€€\u0026ldquo;INSTEAD OF\u0026rdquo; è¡Œçº§è§¦å‘å™¨è¿”å›çš„å†…å®¹ä¸ºç©ºï¼Œé‚£ä¹ˆè¯¥è¡Œä¸Šçš„å…¶ä»–è¡Œçº§è§¦å‘å™¨ä¹Ÿä¸ä¼šè¢«è§¦å‘ã€‚\nè§¦å‘å™¨å‡½æ•°ä¸­çš„ç‰¹æ®Šå˜é‡ å½“æŠŠä¸€ä¸ª PL/pgSQL å‡½æ•°å½“åšè§¦å‘å™¨å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šåœ¨é¡¶å±‚ç”Ÿå‘½å­—æ®µé‡Œè‡ªåŠ¨åˆ›å»ºå‡ ä¸ªç‰¹æ®Šå˜é‡ï¼Œæ¯”å¦‚åœ¨ä¹‹å‰çš„å‡ ä¸ªä¾‹å­å½“ä¸­ã€€\u0026ldquo;NEW\u0026rdquo;, \u0026ldquo;OLD\u0026rdquo;, \u0026ldquo;TG_OP\u0026rdquo;, å˜é‡ç­‰ã€‚å¯ä»¥ä½¿ç”¨çš„å˜é‡å¦‚ä¸‹è¿™äº›ï¼š\nNEW: è¯¥å˜é‡ä¸º INSERT/UPDATE æ“ä½œè§¦å‘çš„è¡Œçº§è§¦å‘å™¨ä¸­å­˜å‚¨çš„æ–°æ•°æ®è¡Œï¼Œæ•°æ®ç±»å‹æ˜¯ã€€\u0026ldquo;RECORD\u0026rdquo; ,åœ¨è¯­å¥çº§åˆ«çš„è§¦å‘å™¨é‡Œæ²¡æœ‰åˆ†é…æ¬¡å˜é‡ï¼Œã€€DELETE æ“ä½œè§¦å‘çš„è¡Œçº§è§¦å‘å™¨ä¸­ä¹Ÿæ²¡æœ‰åˆ†é…æ­¤å˜é‡\nOLDï¼šæ•°æ®ç±»å‹æ˜¯ recordã€‚åœ¨ updateã€delete æ“ä½œè§¦å‘æ—¶å­˜å‚¨æ—§çš„æ•°æ®è¡Œã€‚\nTG_NAMEï¼šæ•°æ®ç±»å‹æ˜¯ nameã€‚è§¦å‘å™¨åç§°ã€‚\nTG_WHENï¼šå†…å®¹ä¸º\u0026quot;BEFORE\u0026quot;æˆ–â€œAFTERâ€ï¼Œå¯ä»¥ç”¨æ¥åˆ¤æ–­æ˜¯ BEFORE è§¦å‘å™¨è¿˜æ˜¯ AFTER è§¦å‘å™¨ã€‚\nTG_LEVELï¼šå†…å®¹ä¸ºâ€œROWâ€æˆ–â€œSTATEMENTâ€ï¼Œå¯ä»¥ç”¨æ¥åˆ¤æ–­æ˜¯è¯­å¥çº§è§¦å‘å™¨è¿˜æ˜¯è¡Œçº§è§¦å‘å™¨ã€‚\nTG_OPï¼šå†…å®¹ä¸ºâ€œINSERTâ€ã€â€œUPDATEâ€ã€â€œDELETEâ€ã€â€œTRUNCATEâ€ï¼Œç”¨äºæŒ‡å®š DML è¯­å¥ç±»å‹ã€‚\nTG_RELIDï¼šè§¦å‘å™¨æ‰€åœ¨è¡¨çš„ oidã€‚\nTG_TABLE_NAMEï¼šè§¦å‘å™¨æ‰€åœ¨è¡¨çš„è¡¨åç§°ã€‚\nTG_SCHEMA_NAMEï¼šè§¦å‘å™¨æ‰€åœ¨è¡¨çš„æ¨¡å¼ã€‚\nTG_NARGSï¼šåœ¨åˆ›å»ºè§¦å‘å™¨è¯­å¥ä¸­èµ‹äºˆè§¦å‘å™¨è¿‡ç¨‹çš„å‚æ•°ä¸ªæ•°ã€‚\nTG_ARGV[]ï¼štext ç±»å‹çš„ä¸€ä¸ªæ•°ç»„ã€‚åˆ›å»ºè§¦å‘å™¨è¯­å¥ä¸­æŒ‡å®šçš„å‚æ•°ã€‚\n","date":"2019-03-30T09:15:25Z","permalink":"https://dccmmtop.github.io/posts/%E8%A7%A6%E5%8F%91%E5%99%A8%E5%88%9B%E5%BB%BA%E7%A4%BA%E4%BE%8B/","section":"posts","tags":["SQL","è§¦å‘å™¨"],"title":"è§¦å‘å™¨åˆ›å»ºç¤ºä¾‹"},{"categories":null,"contents":" ç¿»è¯‘å¹¶æ•´ç†ï¼š https://collectiveidea.com/blog/archives/2016/07/22/solutions-to-potential-upgrade-problems-in-rails-5\nhttps://blog.bigbinary.com/2016/08/29/rails-5-disables-autoloading-after-booting-the-app-in-production.html\nautoloadå’Œeager_load autoload: åœ¨å¸¸é‡ä½¿ç”¨ä¹‹å‰ä¸ä¼šåŠ è½½ï¼Œåªæœ‰å½“ä½¿ç”¨ä¸€ä¸ªå½“å‰ä¸å­˜åœ¨å¸¸é‡æ—¶ï¼Œä¼šåœ¨ autoload_paths å¯»æ‰¾ï¼Œç„¶ååŠ è½½å®ƒï¼Œå½“åœ¨ç»™å®šçš„ç›®å½•ä¸­æ‰¾ä¸åˆ°è¿™ä¸ªå¸¸é‡æ—¶ï¼Œå°±ä¼šè§¦å‘é”™è¯¯ã€‚å¹¶ä¸” autoload æ˜¯éçº¿ç¨‹å®‰å…¨çš„\neager_load åœ¨ä½¿ç”¨å¸¸é‡ä¹‹å‰ï¼ŒåŠ è½½ eager_load_paths ä¸­çš„æ‰€æœ‰å¸¸é‡\nRails5çš„å˜åŒ– åœ¨ Rails5 ä¸­çš„ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œ autoload é»˜è®¤æ˜¯è¢«ç¦ç”¨çš„ï¼Œ æœ‰ä¸‰ç§åŠæ³•è§£å†³è¿™ä¸ªé—®é¢˜\næ·»åŠ è·¯å¾„åˆ° eager_load_paths å‡å¦‚è‡ªå·±å†™çš„ç±»åœ¨libä¸‹\nåœ¨ config/application.rb ä¸­\nconfig.eager_load_paths \u0026lt;\u0026lt; Rails.root.join(\u0026#39;lib\u0026#39;) é‡æ–°å¯ç”¨ autoload ä½ å¯ä»¥åœ¨ä»»ä½•ç¯å¢ƒä¸­é‡æ–°å¯ç”¨ autoload, ä½†æ˜¯è¿™ç§æ–¹æ³•åœ¨é«˜ç‰ˆæœ¬ä¸­å¯èƒ½è¢«å¼ƒç”¨\nconfig.enable_dependency_loading = true æŠŠä»£ç ç§»åŠ¨åˆ° app/ ç›®å½•ä¸‹ Rails åœ¨é»˜è®¤çš„æƒ…å†µä¸‹ä¼š autolaod å’Œ eager_load app/ ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹ã€‚è¿™æ ·å¯ä»¥å‡å°‘ä½ é¢å¤–çš„é…ç½®ã€‚ä¾‹å¦‚æŠŠ lib ç›®å½• ç§»åŠ¨åˆ° app/lib/\nè¯‘æ³¨ï¼š è¿™ç§æ–¹å¼ä½¿ rails çš„ç›®å½•å˜å¾—æ··ä¹±ï¼Œ ä¸å»ºè®®\n","date":"2019-01-19T10:21:48Z","permalink":"https://dccmmtop.github.io/posts/rails5%E4%B8%AD%E7%9A%84autoload%E5%92%8Ceager_load/","section":"posts","tags":["rails"],"title":"Rails5ä¸­çš„autoloadå’Œeager_load"},{"categories":null,"contents":" ç¿»è¯‘è‡ª https://medium.com/@florenceliang/some-notes-about-using-hash-sort-by-in-ruby-f4b3a700fc33\nrubyä¸­çš„sortå’Œsort_by æ˜¯ä¸¤ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§è‡ªå·±çš„æƒ³æ³•æ’åºã€‚æ¯”å¦‚æˆ‘ä»¬å¯ä»¥æŒ‰ç…§åå­—å­—æ¯è¡¨æˆ–è€…åå­—çš„é•¿çŸ­è¿›è¡Œæ’åºã€‚ä½†æ˜¯rubyæ–‡æ¡£ä¸­å´æ²¡æœ‰è¿‡å¤šçš„è¯´æ˜ï¼Œå› æ­¤æœ¬æ–‡ä¸»è¦è¯´æ˜ä¸€ä¸‹å…³äºHashçš„sortå’Œsort_byçš„ç”¨æ³•\nè¿”å›æ•°ç»„ é¦–å…ˆè¦çŸ¥é“çš„æ˜¯ Hash å¯¹è±¡è°ƒç”¨ sort æˆ–è€… sort_by åï¼Œä¼šè¿”å›ä¸€ä¸ªæ•°ç»„ï¼Œè€Œä¸æ˜¯Hashã€‚å¦‚æœæƒ³å¾—åˆ° Hashï¼Œéœ€è¦ä½¿ç”¨ to_h æ–¹æ³•\nå‡å¦‚æœ‰ä¸‹é¢çš„ Hash\nhash = {a:1, b:2, c:4, d:3, e:2} è°ƒç”¨sortæ–¹æ³•ï¼Œå°†ä¼šè¿”å›ä¸€ä¸ªåµŒå¥—æ•°ç»„\nhash.sort # æ²¡æœ‰æŒ‡å®šæŒ‰ä»€ä¹ˆå€¼è¿›è¡Œæ’åºï¼Œæ‰€é¡ºåºä¸ä¼šå‘ç”Ÿå˜åŒ– =\u0026gt; [[:a, 1], [:b, 2], [:c, 4], [:d, 3], [:e 2]] æŒ‰ç…§ hash çš„å€¼æ’åº hash.sort_by {|k, v| v} =\u0026gt; [[:a, 1], [:b, 2], [:e, 2], [:d, 3], [:c, 4]] æŒ‰ç…§ hash çš„å€¼å€’åº hash.sort_by {|k, v| -v} =\u0026gt; [[:c, 4], [:d, 3], [:b, 2], [:e, 2], [:a, 1]] å…ˆæŒ‰å€¼å€’åºå†æŒ‰ key æ­£åº hash = {â€œwâ€=\u0026gt;2, â€œkâ€=\u0026gt;1, â€œlâ€=\u0026gt;2, â€œvâ€=\u0026gt;5, â€œdâ€=\u0026gt;2, â€œhâ€=\u0026gt;4, â€œfâ€=\u0026gt;1, â€œuâ€=\u0026gt;1, â€œpâ€=\u0026gt;1, â€œjâ€=\u0026gt;1} hash.sort_by {|k, v| [-v, k]} =\u0026gt; [[â€œvâ€, 5], [â€œhâ€, 4], [â€œdâ€, 2], [â€œlâ€, 2], [â€œwâ€, 2], [â€œfâ€, 1], [â€œjâ€, 1], [â€œkâ€, 1], [â€œpâ€, 1], [â€œuâ€, 1]] ","date":"2019-01-15T11:45:27Z","permalink":"https://dccmmtop.github.io/posts/ruby%E4%B8%ADhash%E7%9A%84%E6%8E%92%E5%BA%8F/","section":"posts","tags":["ruby"],"title":"rubyä¸­hashçš„æ’åº"},{"categories":null,"contents":":g/xxx/dï¼Œåˆ é™¤åŒ…å«xxxçš„è¡Œ :v/xxx/dï¼Œåˆ é™¤ä¸å«xxxçš„è¡Œ :%s/xxx//gnï¼Œç»Ÿè®¡xxxä¸ªæ•°ï¼Œnè¡¨ç¤ºåªæŠ¥å‘ŠåŒ¹é…çš„ä¸ªæ•°è€Œä¸è¿›è¡Œå®é™…çš„æ›¿æ¢ã€‚ è¯¦è§ã€Œ:help :vã€æˆ–ã€Œhelp :gã€\n","date":"2019-01-09T15:25:29Z","permalink":"https://dccmmtop.github.io/posts/vim%E5%88%A0%E9%99%A4%E4%B8%8D%E5%8C%85%E5%90%AB%E7%89%B9%E5%AE%9A%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E8%A1%8C/","section":"posts","tags":["vim"],"title":"vimåˆ é™¤ä¸åŒ…å«ç‰¹å®šå­—ç¬¦ä¸²çš„è¡Œ"},{"categories":null,"contents":"åå¼•å· è¿”å›æ ‡å‡†è¾“å‡º output = `ls` puts \u0026#34;output is #{output}\u0026#34; Result of above code is\n$ ruby main.rb output is lab.rb åå¼•å·æ‰§è¡Œç³»ç»Ÿå‘½ä»¤æ—¶ï¼Œä¼šæŠŠå¼‚å¸¸æŠ›ç»™ä¸»çº¿ç¨‹ åå¼•å·ä¼šä»ä¸»è¿›ç¨‹æ–°å¼€ä¸€ä¸ªè¿›ç¨‹æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚æœå­è¿›ç¨‹å‘ç”Ÿå¼‚å¸¸ï¼Œä¼šä¼ é€’ç»™ä¸»è¿›ç¨‹ï¼Œå¦‚æœä¸»è¿›ç¨‹æ²¡æœ‰å¯¹å¼‚å¸¸è¿›è¡Œå¤„ç†ï¼Œä¸»è¿›ç¨‹å°±ä¼šç»ˆæ­¢ã€‚\nä¸‹é¢çš„ä¾‹å­ä¸­ æ‰§è¡Œä¸€ä¸ªâ€˜xxxxxâ€™éæ³•çš„å‘½ä»¤\noutput = `xxxx` puts \u0026#34;output is #{output}\u0026#34; æ‰§è¡Œç»“æœï¼š\n$ ruby main.rb main.rb:1:in ``\u0026#39;: No such file or directory - xxxxxxx (Errno::ENOENT) from main.rb:1:in `\u0026lt;main\u0026gt;\u0026#39; é˜»å¡è¿›ç¨‹ ä¸»è¿›ç¨‹ä¼šä¸€ç›´ç­‰å¾…åå¼•å·ä¸­çš„å­è¿›ç¨‹ç»“æŸ\næ£€æŸ¥å‘½ä»¤çš„æ‰§è¡ŒçŠ¶æ€ ä½¿ç”¨ $?.success? æ¥æ£€æŸ¥å‘½ä»¤çš„æ‰§è¡ŒçŠ¶æ€\noutput = `ls` puts \u0026#34;output is #{output}\u0026#34; puts $?.success? ç»“æœ:\n$ ruby main.rb output is lab.rb main.rb true å…è®¸ä½¿ç”¨å­—ç¬¦ä¸²æ’å€¼ ä¾‹å­ï¼š\ncmd = \u0026#39;ls\u0026#39; `#{cmd}` x% x% å’Œåå¼•å·ä¸€æ ·ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ä¸åŒçš„åˆ†éš”ç¬¦\noutput = %x[ ls ] output = %x{ ls } system system ä¹Ÿå¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œä»–å’Œåå¼•å·æœ‰ç‚¹ç›¸åƒã€‚\né˜»å¡è¿›ç¨‹\néšè—å¼‚å¸¸\nsystem ä¸ä¼šå‘ä¸»è¿›ç¨‹ä¼ é€’å¼‚å¸¸ã€‚\noutput = system(\u0026#39;xxxxxxx\u0026#39;) puts \u0026#34;output is #{output}\u0026#34; ç»“æœï¼š\n$ ruby main.rb output is æ£€æŸ¥å‘½ä»¤çš„æ‰§è¡ŒçŠ¶æ€ å¦‚æœå‘½ä»¤æˆåŠŸæ‰§è¡Œï¼Œåˆ™ç³»ç»Ÿè¿”å›trueï¼ˆé€€å‡ºçŠ¶æ€ä¸ºé›¶ï¼‰ã€‚å¯¹äºéé›¶é€€å‡ºçŠ¶æ€ï¼Œå®ƒè¿”å›false, å¦‚æœå‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œè¿”å›nil\nsystem(\u0026#34;command that does not exist\u0026#34;) #=\u0026gt; nil system(\u0026#34;ls\u0026#34;) #=\u0026gt; true system(\u0026#34;ls | grep foo\u0026#34;) #=\u0026gt; false exec exec ä¼šæ›¿æ¢æ‰å½“å‰è¿›ç¨‹ï¼Œè¯·çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š\nåœ¨ irb ä¸­æ‰§è¡Œexec(\u0026rsquo;ls\u0026rsquo;)ï¼š\n$ irb e1.9.3-p194 :001 \u0026gt; exec(\u0026#39;ls\u0026#39;) lab.rb main.rb nsingh ~/dev/lab 1.9.3 $ å¯ä»¥å‘ç°ï¼Œæ‰§è¡Œå®Œexec(\u0026ldquo;ls\u0026rdquo;)å‘½ä»¤ä»¥åï¼Œå·²ç»é€€å‡ºirbï¼Œå›åˆ°shellã€‚\nç”±äºexecæ›¿æ¢äº†å½“å‰è¿›ç¨‹ï¼Œå› æ­¤å¦‚æœæ“ä½œæˆåŠŸï¼Œåˆ™ä¸ä¼šè¿”å›ä»»ä½•å†…å®¹ã€‚å¦‚æœæ“ä½œå¤±è´¥ï¼Œåˆ™å¼•å‘SystemCallError\nsh shå®é™…ä¸Šæ˜¯åœ¨å‘¼å«ç³»ç»Ÿ, FileUtilsåœ¨rakeä¸­æ·»åŠ äº†æ­¤æ–¹æ³•ã€‚å®ƒå…è®¸ä»¥ç®€å•çš„æ–¹å¼æ£€æŸ¥å‘½ä»¤çš„é€€å‡ºçŠ¶æ€ã€‚\nrequire \u0026#39;rake\u0026#39; sh %w(xxxxx) do |ok, res| if !ok abort \u0026#39;the operation failed\u0026#39; end end popen3 å¦‚æœä½ è¦æ•è·stdoutå’Œstderrï¼Œé‚£ä¹ˆä½ åº”è¯¥ä½¿ç”¨popen3ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•å…è®¸ä½ ä¸stdinï¼Œstdoutå’Œstderrè¿›è¡Œäº¤äº’ã€‚\næˆ‘æƒ³ä»¥ç¼–ç¨‹æ–¹å¼æ‰§è¡Œgit push heroku masterï¼Œæˆ‘æƒ³æ•è·è¾“å‡ºã€‚è¿™æ˜¯æˆ‘çš„ä»£ç ã€‚\nrequire \u0026#39;open3\u0026#39; cmd = \u0026#39;git push heroku master\u0026#39; Open3.popen3(cmd) do |stdin, stdout, stderr, wait_thr| puts \u0026#34;stdout is:\u0026#34; + stdout.read puts \u0026#34;stderr is:\u0026#34; + stderr.read end è¾“å‡ºï¼š\nstdout is: stderr is: -----\u0026gt; Heroku receiving push -----\u0026gt; Ruby/Rails app detected -----\u0026gt; Installing dependencies using Bundler version 1.2.1 è¿™é‡Œéœ€è¦æ³¨æ„çš„é‡è¦ä¸€ç‚¹æ˜¯ï¼Œå½“æˆ‘æ‰§è¡Œç¨‹åºruby lab.rbæ—¶ï¼Œæˆ‘çš„ç»ˆç«¯åœ¨å‰10ç§’å†…æ²¡æœ‰çœ‹åˆ°ä»»ä½•è¾“å‡ºã€‚ç„¶åæˆ‘å°†æ•´ä¸ªè¾“å‡ºè§†ä¸ºä¸€ä¸ªè½¬å‚¨ã€‚\nå¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œherokuæ­£åœ¨å°†æ‰€æœ‰è¿™äº›è¾“å‡ºå†™å…¥stderrè€Œä¸æ˜¯stdoutã€‚\næ‰€ä»¥æˆ‘ä»¬åº”è¯¥æ•è·æ¥è‡ªherokuçš„è¾“å‡ºï¼Œå› ä¸ºå®ƒæ­£åœ¨æµå¼ä¼ è¾“è€Œä¸æ˜¯åœ¨å¤„ç†ç»“æŸæ—¶å°†æ•´ä¸ªè¾“å‡ºè½¬å‚¨ä¸ºä¸€ä¸ªå•ä¸ªçš„å­—ç¬¦ä¸²å—ã€‚\nè¿™æ˜¯ä¿®æ”¹åçš„ä»£ç ã€‚\nrequire \u0026#39;open3\u0026#39; cmd = \u0026#39;git push heroku master\u0026#39; Open3.popen3(cmd) do |stdin, stdout, stderr, wait_thr| while line = stderr.gets puts line end end ç°åœ¨ï¼Œå½“æˆ‘ä½¿ç”¨ruby lab.rbæ‰§è¡Œä¸Šè¿°å‘½ä»¤æ—¶ï¼Œæˆ‘ä¼šé€æ­¥è·å¾—ç»ˆç«¯è¾“å‡ºï¼Œå°±å¥½åƒæˆ‘è¾“å…¥äº†git push heroku masterä¸€æ ·ã€‚ è¿™æ˜¯æ•è·æµè¾“å‡ºçš„å¦ä¸€ä¸ªä¾‹å­ã€‚\nrequire \u0026#39;open3\u0026#39; cmd = \u0026#39;ping www.google.com\u0026#39; Open3.popen3(cmd) do |stdin, stdout, stderr, wait_thr| while line = stdout.gets puts line end end åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæ‚¨å°†åœ¨ç»ˆç«¯ä¸Šè·å¾—pingçš„è¾“å‡ºï¼Œå°±åƒæ‚¨åœ¨ç»ˆç«¯ä¸Šé”®å…¥ping www.google.comä¸€æ ·ã€‚\nç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•æ£€æŸ¥å‘½ä»¤æ˜¯å¦æˆåŠŸ\nrequire \u0026#39;open3\u0026#39; cmd = \u0026#39;ping www.google.com\u0026#39; Open3.popen3(cmd) do |stdin, stdout, stderr, wait_thr| exit_status = wait_thr.value unless exit_status.success? abort \u0026#34;FAILED !!! #{cmd}\u0026#34; end end popen2e popen2eç±»ä¼¼äºpopen3ï¼Œä½†åˆå¹¶äº†æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯ã€‚\nrequire \u0026#39;open3\u0026#39; cmd = \u0026#39;ping www.google.com\u0026#39; Open3.popen2e(cmd) do |stdin, stdout_err, wait_thr| while line = stdout_err.gets puts line end exit_status = wait_thr.value unless exit_status.success? abort \u0026#34;FAILED !!! #{cmd}\u0026#34; end end åœ¨æ‰€æœ‰å…¶ä»–é¢†åŸŸï¼Œæ­¤æ–¹æ³•ä¸popen3ç±»ä¼¼ã€‚\nProcess.spawn Kernel.spawnåœ¨å­shellä¸­æ‰§è¡Œç»™å®šçš„å‘½ä»¤ã€‚å®ƒä¼šç«‹å³è¿”å›è¿›ç¨‹IDã€‚\nirb(main)\u0026gt; pid = Process.spawn(\u0026#34;ls -al\u0026#34;) =\u0026gt; 81001 ","date":"2019-01-03T09:50:00Z","permalink":"https://dccmmtop.github.io/posts/%E7%94%A8ruby%E6%89%A7%E8%A1%8C%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4/","section":"posts","tags":["ruby"],"title":"ç”¨rubyæ‰§è¡Œç³»ç»Ÿå‘½ä»¤"},{"categories":null,"contents":"æ•´ç†è‡ªhttps://devhints.io/xpath#prefixes\nDescendant selectors h1 //h1 div p //div//p ul \u0026gt; li //ul/li ul \u0026gt; li \u0026gt; a //ul/li/a div \u0026gt; * //div/* :root / :root \u0026gt; body /body Attribute selectors #id //*[@id=\u0026quot;id\u0026quot;] .class //*[@class=\u0026quot;class\u0026quot;] â€¦kinda input[type=\u0026quot;submit\u0026quot;] //input[@type=\u0026quot;submit\u0026quot;] a#abc[for=\u0026quot;xyz\u0026quot;] //a[@id=\u0026quot;abc\u0026quot;][@for=\u0026quot;xyz\u0026quot;] a[rel] //a[@rel] a[href^='/'] //a[starts-with(@href, '/')] a[href$='pdf'] //a[ends-with(@href, '.pdf')] a[href*='://'] //a[contains(@href, '://')] a[rel~='help'] //a[contains(@rel, 'help')] â€¦kinda Order selectors ul \u0026gt; li:first-child //ul/li[1] ul \u0026gt; li:nth-child(2) //ul/li[2] ul \u0026gt; li:last-child //ul/li[last()] li#id:first-child //li[@id=\u0026quot;id\u0026quot;][1] a:first-child //a[1] a:last-child //a[last()] Siblings h1 ~ ul //h1/following-sibling::ul h1 + ul //h1/following-sibling::ul[1] h1 ~ #id //h1/following-sibling::[@id=\u0026quot;id\u0026quot;] jQuery $('ul \u0026gt; li').parent() //ul/li/.. $('li').closest('section') //li/ancestor-or-self::section $('a').attr('href') //a/@href $('span').text() //span/text() Other things h1:not([id]) //h1[not(@id)] Text match //button[text()=\u0026quot;Submit\u0026quot;] Text match (substring) //button[contains(text(),\u0026quot;Go\u0026quot;)] Arithmetic //product[@price \u0026gt; 2.50] Has children //ul[*] Has children (specific) //ul[li] Or logic //a[@name or @href] Union (joins results) `//a Class check //div[contains(concat(\u0026#39; \u0026#39;,normalize-space(@class),\u0026#39; \u0026#39;),\u0026#39; foobar \u0026#39;)] Xpath doesnâ€™t have the â€œcheck if part of space-separated listâ€ operator, so this is the workaround (source).\n#Expressions Steps and axes // ul / a[@id='link'] Axis Step Axis Step Prefixes Prefix Example What // //hr[@class='edge'] Anywhere ./ ./a Relative / /html/body/div Root Begin your expression with any of these.\nAxes Axis Example What / //ul/li/a Child // //[@id=\u0026quot;list\u0026quot;]//a Descendant Separate your steps with /. Use two (//) if you donâ€™t want to select direct children.\nSteps //div //div[@name=\u0026#39;box\u0026#39;] //[@id=\u0026#39;link\u0026#39;] A step may have an element name (div) and predicates ([...]). Both are optional. They can also be these other things:\n//a/text() #=\u0026gt; \u0026#34;Go home\u0026#34; //a/@href #=\u0026gt; \u0026#34;index.html\u0026#34; //a/* #=\u0026gt; All a\u0026#39;s child elements #Predicates Predicates //div[true()] //div[@class=\u0026#34;head\u0026#34;] //div[@class=\u0026#34;head\u0026#34;][@id=\u0026#34;top\u0026#34;] Restricts a nodeset only if some condition is true. They can be chained.\nOperators # Comparison //a[@id = \u0026#34;xyz\u0026#34;] //a[@id != \u0026#34;xyz\u0026#34;] //a[@price \u0026gt; 25] # Logic (and/or) //div[@id=\u0026#34;head\u0026#34; and position()=2] //div[(x and y) or not(z)] Use comparison and logic operators to make conditionals.\nUsing nodes # Use them inside functions //ul[count(li) \u0026gt; 2] //ul[count(li[@class=\u0026#39;hide\u0026#39;]) \u0026gt; 0] # This returns `\u0026lt;ul\u0026gt;` that has a `\u0026lt;li\u0026gt;` child //ul[li] You can use nodes inside predicates.\nIndexing //a[1] # first \u0026lt;a\u0026gt; //a[last()] # last \u0026lt;a\u0026gt; //ol/li[2] # second \u0026lt;li\u0026gt; //ol/li[position()=2] # same as above //ol/li[position()\u0026gt;1] # :not(:first-child) Use [] with a number, or last() or position().\nChaining order a[1][@href=\u0026#39;/\u0026#39;] a[@href=\u0026#39;/\u0026#39;][1] Order is significant, these two are different.\nNesting predicates //section[//h1[@id=\u0026#39;hi\u0026#39;]] This returns \u0026lt;section\u0026gt; if it has an \u0026lt;h1\u0026gt; descendant with id='hi'.\n#Functions Node functions name() # //[starts-with(name(), \u0026#39;h\u0026#39;)] text() # //button[text()=\u0026#34;Submit\u0026#34;] # //button/text() lang(str) namespace-uri() count() # //table[count(tr)=1] position() # //ol/li[position()=2] Boolean functions not(expr) # button[not(starts-with(text(),\u0026#34;Submit\u0026#34;))] String functions contains() # font[contains(@class,\u0026#34;head\u0026#34;)] starts-with() # font[starts-with(@class,\u0026#34;head\u0026#34;)] ends-with() # font[ends-with(@class,\u0026#34;head\u0026#34;)] concat(x,y) substring(str, start, len) substring-before(\u0026#34;01/02\u0026#34;, \u0026#34;/\u0026#34;) #=\u0026gt; 01 substring-after(\u0026#34;01/02\u0026#34;, \u0026#34;/\u0026#34;) #=\u0026gt; 02 translate() normalize-space() string-length() Type conversion string() number() boolean() #Axes Using axes //ul/li # ul \u0026gt; li //ul/child::li # ul \u0026gt; li (same) //ul/following-sibling::li # ul ~ li //ul/descendant-or-self::li # ul li //ul/ancestor-or-self::li # $(\u0026#39;ul\u0026#39;).closest(\u0026#39;li\u0026#39;) Steps of an expression are separated by /, usually used to pick child nodes. Thatâ€™s not always true: you can specify a different â€œaxisâ€ with ::.\n// ul /child:: li Axis Step Axis Step Child axis # both the same //ul/li/a //child::ul/child::li/child::a child:: is the default axis. This makes //a/b/c work.\n# both the same # this works because `child::li` is truthy, so the predicate succeeds //ul[li] //ul[child::li] # both the same //ul[count(li) \u0026gt; 2] //ul[count(child::li) \u0026gt; 2] Descendant-or-self axis # both the same //div//h4 //div/descendant-or-self::h4 // is short for the descendant-or-self:: axis.\n# both the same //ul//[last()] //ul/descendant-or-self::[last()] Other axes Axis Abbrev Notes ancestor ancestor-or-self attribute @ @href is short for attribute::href child div is short for child::div descendant descendant-or-self // // is short for /descendant-or-self::node()/ namespace self . . is short for self::node() parent .. .. is short for parent::node() following following-sibling preceding preceding-sibling There are other axes you can use.\nUnions //a | //span Use | to join two expressions.\n#More examples Examples //* # all elements count(//*) # count all elements (//h1)[1]/text() # text of the first h1 heading //li[span] # find a \u0026lt;li\u0026gt; with an \u0026lt;span\u0026gt; inside it # ...expands to //li[child::span] //ul/li/.. # use .. to select a parent Find a parent //section[h1[@id=\u0026#39;section-name\u0026#39;]] Finds a \u0026lt;section\u0026gt; that directly contains h1#section-name\n//section[//h1[@id=\u0026#39;section-name\u0026#39;]] Finds a \u0026lt;section\u0026gt; that contains h1#section-name. (Same as above, but uses descendant-or-self instead of child)\nClosest ./ancestor-or-self::[@class=\u0026#34;box\u0026#34;] Works like jQueryâ€™s $().closest('.box').\nAttributes //item[@price \u0026gt; 2*@discount] Finds \u0026lt;item\u0026gt; and check its attributes\n","date":"2019-01-02T17:56:48Z","permalink":"https://dccmmtop.github.io/posts/xpath%E7%94%A8%E6%B3%95/","section":"posts","tags":["xpath"],"title":"xpathç”¨æ³•"},{"categories":null,"contents":" æ‰“å¼€ç®¡ç†é…ç½®ï¼Œ \u0026ndash;\u0026gt; appearance \u0026ndash;\u0026gt; new\nç»™æ–°çš„ color theme å‘½å(gruvbox)ï¼Œç„¶åç‚¹å‡»åº”ç”¨ï¼Œä¿å­˜ã€‚\næ‰“å¼€ .kde/share/apps/konsole/gruvbox.colortheme,æ¸…ç©ºæ–‡ä»¶å†…å®¹\nåœ¨ manjaro ä¸­ï¼Œ è¯¥æ–‡ä»¶ä½äº ~/.local/share/konsole/ ç›®å½•ä¸‹\nå¤åˆ¶ https://github.com/morhetz/gruvbox-contrib/blob/master/konsole/Gruvbox_dark.colorscheme, åˆ° gruvbox.colorscheme.\nGruvbox_dark.colorscheme\n[Background] Color=40,40,40 [BackgroundIntense] Color=40,40,40 [Color0] Color=40,40,40 [Color0Intense] Color=146,131,116 [Color1] Color=204,36,29 [Color1Intense] Color=251,73,52 [Color2] Color=152,151,26 [Color2Intense] Color=184,187,38 [Color3] Color=215,153,33 [Color3Intense] Color=250,189,47 [Color4] Color=69,133,136 [Color4Intense] Color=131,165,152 [Color5] Color=177,98,134 [Color5Intense] Color=211,134,155 [Color6] Color=104,157,106 [Color6Intense] Color=142,192,124 [Color7] Color=168,153,132 [Color7Intense] Color=235,219,178 [Foreground] Color=235,219,178 [ForegroundIntense] Color=235,219,178 [General] Description=Gruvbox Opacity=1 Wallpaper= ","date":"2018-12-28T11:31:57Z","permalink":"https://dccmmtop.github.io/posts/yakuake%E9%85%8D%E7%BD%AEcolor-theme/","section":"posts","tags":["yakuake","color"],"title":"yakuakeé…ç½®color-theme"},{"categories":null,"contents":"rails ä¸­ä½¿ç”¨é‚®ä»¶æœåŠ¡æ˜¯éå¸¸æ–¹ä¾¿çš„ï¼Œç›´æ¥åŠ é…ç½®æ–‡ä»¶å°±å¯ä»¥ï¼Œå‚è€ƒæŒ‡å—\nqq é‚®ç®±æ­£ç¡®çš„é…ç½®å¦‚ä¸‹\nproduction.rb / development.rb\nActionMailer::Base.delivery_method = :smtp config.action_mailer.perform_deliveries = true config.action_mailer.raise_delivery_errors = true config.action_mailer.default :charset =\u0026gt; \u0026#34;utf-8\u0026#34; ActionMailer::Base.smtp_settings = { :address =\u0026gt; \u0026#39;smtp.qq.com\u0026#39;, :port =\u0026gt; 465, :domain =\u0026gt; \u0026#39;qq.com\u0026#39;, :user_name =\u0026gt; ENV[\u0026#39;qq_mail_address\u0026#39;] # æˆæƒç  :password =\u0026gt; ENV[\u0026#39;qq_mail_address\u0026#39;] :authentication =\u0026gt; \u0026#39;plain\u0026#39;, :ssl =\u0026gt; true, :enable_starttls_auto =\u0026gt; true } åˆ‡è®°ï¼Œqq é‚®ç®±åå°è¦å¼€å¯ POP3/SMTP æœåŠ¡ï¼Œå¼€å¯çš„æ—¶å€™éœ€è¦é€šè¿‡å‘é€çŸ­ä¿¡æ¯å¯ç”¨ï¼Œå¯ç”¨çš„æ—¶å€™ä¼šç”Ÿæˆä¸€ä¸ªæˆæƒç ï¼Œé…ç½®æ–‡ä»¶çš„ password åªéœ€è¦å¡«å†™æˆæƒç å³å¯ã€‚\n","date":"2018-11-28T17:26:31Z","permalink":"https://dccmmtop.github.io/posts/rails%E5%8F%91%E9%80%81qq%E9%82%AE%E4%BB%B6%E7%9A%84%E9%85%8D%E7%BD%AE/","section":"posts","tags":["rails"],"title":"railså‘é€qqé‚®ä»¶çš„é…ç½®"},{"categories":null,"contents":"åœ¨åˆå§‹åŒ–æ•°æ®åº“ç³»ç»Ÿæ—¶ï¼Œæœ‰ä¸€ä¸ªé¢„å®šä¹‰çš„è¶…çº§ç”¨æˆ·ï¼Œè¿™ç”¨æˆ·çš„åç§°ä¸åˆå§‹åŒ–è¯¥æ•°æ®åº“çš„æ“ä½œç³»ç»Ÿç”¨æˆ·åç›¸åŒï¼Œé»˜è®¤æ˜¯ postgresï¼Œåœ¨è¿™ä¸ªè¶…çº§ç”¨æˆ·è¿æ¥æ•°æ®åº“ï¼Œç„¶ååˆ›å»ºå‡ºæ›´å¤šçš„ç”¨æˆ·ã€‚\nåˆ›å»ºç”¨æˆ·å’Œè§’è‰² åˆ›å»ºç”¨æˆ·ä¸è§’è‰²çš„è¯­æ³•å¦‚ä¸‹ï¼š\nCREATE ROLE name [ [ WITH] option [ ... ] ] // æˆ– CREATE ROLE name [ [ WITH] option [ ... ] ] åœ¨ postgres ä¸­ï¼Œç”¨æˆ·ä¸è§’è‰²æ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼Œé™¤äº† \u0026ldquo;CREATE USER\u0026rdquo; é»˜è®¤åˆ›å»ºå‡ºæ¥çš„ç”¨æˆ·å…·æœ‰ç™»å½•ï¼ˆLOGINï¼‰æƒé™ï¼Œè€Œ \u0026ldquo;CREATE ROLE\u0026quot;åˆ›å»ºå‡ºæ¥çš„ç”¨æˆ·é»˜è®¤æ²¡æœ‰ç™»å½•æƒé™ä¹‹å¤–ï¼Œæ²¡æœ‰ä»»ä½•ä¸åŒã€‚\nä¸Šé¢çš„ option å¯ä»¥æ˜¯ä»¥ä¸‹å†…å®¹ï¼š\nSUPERUSER | NOSUPERUSER: è¡¨ç¤ºåˆ›å»ºå‡ºæ¥çš„ç”¨æˆ·æ˜¯å¦æ˜¯è¶…çº§ç”¨æˆ·ï¼Œåªèƒ½æ˜¯è¶…çº§ç”¨æˆ·æ‰èƒ½åˆ›å»ºè¶…çº§ç”¨æˆ·ã€‚ CREATEDB | NOCREATEDB: æŒ‡å®šåˆ›å»ºå‡ºæ¥çš„ç”¨æˆ·æ˜¯å¦å…·æœ‰æ‰§è¡Œ \u0026ldquo;CREATE DATABASE\u0026quot;çš„æƒé™ CREATEROLE | NOCREATEROLE: æŒ‡å®šåˆ›å»ºå‡ºæ¥çš„ç”¨æˆ·æ˜¯å¦å…·æœ‰åˆ›å»ºå…¶ä»–è§’è‰²çš„æƒé™ CREATEUSER | NOCREATEUSER: æŒ‡å®šåˆ›å»ºå‡ºæ¥çš„ç”¨æˆ·æ˜¯å¦å…·æœ‰åˆ›å»ºå…¶ä»–ç”¨æˆ·çš„æƒé™ INHERIT | NOINHERIT: å¦‚æœåˆ›å»ºçš„ç”¨æˆ·æ‹¥æœ‰æŸä¸€ä¸ªæˆ–è€…æŸå‡ ä¸ªè§’è‰²ï¼Œè¿™æ˜¯è‹¥æ˜¯æŒ‡å®š INHERITï¼Œåˆ™è¡¨ç¤ºç”¨æˆ·è‡ªåŠ¨æ‹¥æœ‰ç›¸åº”è§’è‰²çš„æƒé™ï¼Œå¦åˆ™è¿™ä¸ªç”¨æˆ·æ²¡æœ‰è¯¥è§’è‰²çš„æƒé™ã€‚ LOGIN|NOLOGINï¼šæŒ‡å®šåˆ›å»ºå‡ºæ¥çš„ç”¨æˆ·æ˜¯å¦æœ‰â€œLOGIN çš„æƒé™ï¼Œå¯ä»¥ä¸´æ—¶åœ°ç¦æ­¢ä¸€ä¸ªç”¨æˆ·çš„â€œLOGINâ€æƒé™ï¼Œè¿™æ—¶è¿™ä¸ªç”¨æˆ·å°±ä¸èƒ½è¿æ¥åˆ°æ•°æ®åº“äº†ã€‚ CONNECTION LIMIT connlimitï¼šæŒ‡å®šè¯¥ç”¨æˆ·å¯ä»¥ä½¿ç”¨çš„å¹¶å‘è¿æ¥æ•°é‡ã€‚é»˜è®¤å€¼æ˜¯-1ï¼Œ è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ [ENCRYPTED | UNENCRYPTED] PASSWORD \u0026lsquo;password\u0026rsquo;ï¼šç”¨äºæ§åˆ¶å­˜å‚¨åœ¨ç³»ç»Ÿè¡¨é‡Œé¢çš„å£ä»¤æ˜¯å¦åŠ å¯†ã€‚ VALID UNTIL \u0026rsquo;timestamp\u0026rsquo;ï¼šå¯†ç å¤±æ•ˆæ—¶é—´ï¼Œå¦‚æœä¸æŒ‡å®šè¿™ä¸ªå­å¥ï¼Œé‚£ä¹ˆå£ä»¤å°†æ°¸è¿œæœ‰æ•ˆã€‚ IN ROLE rolename[ï¼Œ\u0026hellip;]ï¼šæŒ‡å®šç”¨æˆ·æˆä¸ºå“ªäº›è§’è‰²çš„æˆå‘˜ï¼Œè¯·æ³¨æ„æ²¡æœ‰ä»»ä½•é€‰é¡¹å¯ä»¥æŠŠæ–°è§’è‰²æ·»åŠ ä¸ºç®¡ç†å‘˜ï¼Œå¿…é¡»ä½¿ç”¨ç‹¬ç«‹çš„ GRANT å‘½ä»¤æ¥åšè¿™ä»¶äº‹æƒ…ã€‚ ROLE rolename[ï¼Œ\u0026hellip;]ï¼šrolename å°†æˆä¸ºè¿™ä¸ªæ–°å»ºçš„è§’è‰²çš„æˆå‘˜ã€‚ ADMIN rolename[,ï¼ï¼ï¼]ï¼šrolename å°†æœ‰è¿™ä¸ªæ–°å»ºè§’è‰²çš„ WITH ADMIN OPTION æƒé™ã€‚ æƒé™çš„ç®¡ç† åœ¨æ•°æ®åº“ä¸­ï¼Œæ¯ä¸ªæ•°æ®åº“çš„é€»è¾‘ç»“æ„å¯¹è±¡ï¼ˆåŒ…æ‹¬æ•°æ®åº“ï¼‰éƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…ï¼Œ ä¹Ÿå°±æ˜¯è¯´ä»»ä½•æ•°æ®åº“å¯¹è±¡éƒ½æ˜¯å±äºæŸä¸ªç”¨æˆ·çš„ï¼Œæ‰€æœ‰è€…é»˜è®¤å°±æ‹¥æœ‰æ‰€æœ‰æƒé™ã€‚æ‰€ä»¥ä¸éœ€è¦æŠŠ å¯¹è±¡çš„æƒé™å†èµ‹ç»™æ‰€æœ‰è€…ã€‚è¿™ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œè‡ªå·±åˆ›å»ºçš„æ•°æ®åº“å¯¹è±¡ï¼Œè‡ªå·±å½“ç„¶æœ‰å…¨éƒ¨çš„æƒé™ äº†ã€‚å½“ç„¶ï¼Œæ‰€æœ‰è€…å‡ºäºå®‰å…¨è€ƒè™‘ä¹Ÿå¯ä»¥é€‰æ‹©åºŸå¼ƒä¸€äº›è‡ªå·±çš„æƒé™ã€‚åœ¨ PostsgreSQL æ•°æ®åº“ä¸­ï¼Œ åˆ é™¤ä¸€ä¸ªå¯¹è±¡åŠä»»æ„ä¿®æ”¹å®ƒçš„æƒåŠ›éƒ½ä¸èƒ½èµ‹äºˆåˆ«äººï¼Œå®ƒæ˜¯æ‰€æœ‰è€…å›ºæœ‰çš„ï¼Œä¸èƒ½è¢«èµ‹äºˆæˆ–æ’¤é”€ã€‚ æ‰€æœ‰è€…ä¹Ÿéšå«åœ°æ‹¥æœ‰æŠŠæ“ä½œè¯¥å¯¹è±¡çš„æƒé™èµ‹ç»™åˆ«äººçš„æƒåˆ©ã€‚\nä¸€ä¸ªç”¨æˆ·çš„æƒé™åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯åœ¨åˆ›å»ºç”¨æˆ·æ—¶å°±æŒ‡å®šçš„æƒé™ï¼Œè¿™äº›æƒé™å¦‚ä¸‹ï¼š\nè¶…çº§ç”¨æˆ·çš„æƒé™ åˆ›å»ºæ•°æ®åº“çš„æƒé™ æ˜¯å¦å…è®¸ LOGIN çš„æƒé™ è¿™äº›æƒé™æ˜¯åˆ›å»ºç”¨æˆ·æ—¶æŒ‡å®šçš„ï¼Œåé¢å¯ä½¿ç”¨ ALTER ROLE å‘½ä»¤æ¥ä¿®æ”¹ã€‚\nè¿˜æœ‰ä¸€ç±»æƒé™ï¼Œæ˜¯ç”±å‘½ä»¤ GRANT å’Œ REVOKE æ¥ç®¡ç†çš„ï¼Œè¿™äº›æƒé™å¦‚ä¸‹ï¼š\nåœ¨æ•°æ®åº“ä¸­åˆ›å»ºæ¨¡å¼(SCHEMA) å…è®¸åœ¨æŒ‡å®šçš„æ•°æ®åº“ä¸­åˆ›å»ºä¸´æ—¶è¡¨ è¿æ¥æŸä¸ªæ•°æ®åº“ åœ¨æ¨¡å¼ä¸­åˆ›å»ºæ•°æ®åº“å¯¹è±¡ï¼Œå¦‚åˆ›å»ºè¡¨ã€è§†å›¾ã€å‡½æ•°ç­‰ åœ¨ä¸€äº›è¡¨ä¸­åš SELECTã€UPDATEã€INSERTã€DELETE ç­‰æ“ä½œ åœ¨ä¸€å¼ è¡¨çš„å…·ä½“åˆ—ä¸Šè¿›è¡Œ SELECTã€UPDATEã€INSERT æ“ä½œ å¯¹åºåˆ—è¿›è¡ŒæŸ¥è¯¢ï¼ˆæ‰§è¡Œåºåˆ—çš„ currval å‡½æ•°ï¼‰ã€ä½¿ç”¨ï¼ˆæ‰§è¡Œåºåˆ—çš„ currval å‡½æ•°å’Œ nextval å‡½æ•°ï¼‰ã€æ›´æ–°ç­‰æ“ä½œ åœ¨å£°æ˜è¡¨ä¸Šåˆ›å»ºè§¦å‘å™¨ å¯ä»¥æŠŠè¡¨ã€ç´¢å¼•ç­‰å»ºåˆ°æŒ‡å®šçš„è¡¨ç©ºé—´ åœ¨ä½¿ç”¨æ—¶ï¼Œéœ€è¦åˆ†æ¸…æ¥šä¸Šè¿°ä¸¤ç±»æƒé™ï¼Œå¦‚æœè¦ç»™ç”¨æˆ·èµ‹äºˆåˆ›å»ºæ•°æ®åº“çš„æƒé™ï¼Œåˆ™éœ€è¦ä½¿ç”¨â€œALTER ROLEâ€å‘½ä»¤ï¼Œè€Œè¦ç»™ç”¨æˆ·èµ‹äºˆåˆ›å»ºæ¨¡å¼çš„æƒé™æ—¶ï¼Œéœ€è¦ä½¿ç”¨â€œGRANTâ€å‘½ä»¤ã€‚\nâ€œALTER ROLEâ€å‘½ä»¤çš„æ ¼å¼å¦‚ä¸‹ï¼š\nALTER ROLE name [ [ WITH ] option] å‘½ä»¤ä¸­çš„\u0026quot;option\u0026rsquo;ä¸â€œCREATEROLEâ€ä¸­çš„å«ä¹‰ç›¸åŒï¼Œè¿™é‡Œå°±ä¸å†é‡å¤å™è¿°äº†ã€‚\næ€»ç»“ PostgreSQL ä¸­çš„æƒé™æ˜¯æŒ‰ä»¥ä¸‹å‡ ä¸ªå±‚æ¬¡è¿›è¡Œç®¡ç†çš„ï¼š\né¦–å…ˆç®¡ç†èµ‹åœ¨ç”¨æˆ·ç‰¹æ®Šå±æ€§ä¸Šçš„æƒé™ï¼Œå¦‚è¶…çº§ç”¨æˆ·çš„æƒé™ã€åˆ›å»ºæ•°æ®åº“çš„æƒé™ã€åˆ›å»º ç”¨æˆ·çš„æƒé™ã€Login çš„æƒé™ï¼Œç­‰ç­‰ã€‚ ç„¶åæ˜¯åœ¨æ•°æ®åº“ä¸­åˆ›å»ºæ¨¡å¼çš„æƒé™ã€‚ æ¥ç€æ˜¯åœ¨æ¨¡å¼ä¸­åˆ›å»ºæ•°æ®åº“å¯¹è±¡çš„æƒé™ï¼Œå¦‚åˆ›å»ºè¡¨ã€åˆ›å»ºç´¢å¼•ï¼Œç­‰ç­‰ã€‚ ä¹‹åæ˜¯æŸ¥è¯¢è¡¨ã€å¾€è¡¨ä¸­æ’äººæ•°æ®ã€æ›´æ–°è¡¨ã€åˆ é™¤è¡¨ä¸­æ•°æ®çš„æƒé™ã€‚ æœ€åæ˜¯æ“ä½œè¡¨ä¸­æŸäº›å­—æ®µçš„æƒé™ã€‚ ","date":"2018-11-25T22:58:15Z","permalink":"https://dccmmtop.github.io/posts/postgres%E7%B3%BB%E5%88%97%E4%B9%8B%E7%94%A8%E6%88%B7%E5%8F%8A%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/","section":"posts","tags":["database"],"title":"postgresç³»åˆ—ä¹‹ç”¨æˆ·åŠæƒé™ç®¡ç†"},{"categories":null,"contents":"æ•´ç†è‡ªruby-china åŸºç¡€çš„ç”¨æ³• def print_heredoc puts \u0026lt;\u0026lt;EOF this is the first line this is the second line EOF end print_heredoc è¾“å‡ºï¼š\nthis is the first line this is the second line å¦‚æœä½ è§‰å¾—ä»£ç å¤ªéš¾çœ‹ï¼ˆè¿™æ ¹æœ¬ä¸ç¬¦åˆ Ruby çš„é£æ ¼ï¼‰ï¼Œä½ å¯èƒ½ä¼šè¿™æ ·å†™ï¼š\ndef print_heredoc puts \u0026lt;\u0026lt;EOF this is the first line this is the second line EOF end print_heredoc ä½ ä¼šå‘ç°é«˜äº®æ˜¾ç¤ºå·²ç»ä¸å¯¹äº†ï¼Œå®ƒè¿˜ä¼šæŠ¥è¿™æ ·çš„ä¸€ä¸ªé”™è¯¯ï¼š\ntest.rb:6: can\u0026#39;t find string \u0026#34;EOF\u0026#34; anywhere before EOF test.rb:2: syntax error, unexpected end-of-input, expecting tSTRING_CONTENT or tSTRING_DBEG or tSTRING_DVAR or tSTRING_END å¯ä»¥ç¼©è¿›çš„ç”¨æ³• å¸Œæœ›ä»£ç å†™çš„æ¼‚äº®ä¸€ç‚¹çš„è¯ï¼Œå°±å¾—å¤šåšç‚¹å·¥ä½œï¼Œåœ¨ç¬¬ä¸€ä¸ª EOF å‰åŠ ä¸Šä¸€ä¸ªå‡å·å°± OK äº†ï¼š\ndef print_heredoc puts \u0026lt;\u0026lt;-EOF this is the first line this is the second line EOF end print_heredoc è¾“å‡ºï¼š\nthis is the first line this is the second line ruby 2.3 å¼•å…¥ä¸€ä¸ªæ–°çš„è¯­æ³• def hello puts \u0026lt;\u0026lt;~HEREDOC I know I know You will like it. HEREDOC end hello å®Œç¾è¾“å‡º:\nI know I know You will like it. heredoc çš„æœ¬è´¨ æœ‰ä¸‹é¢ä¸€ä¸ªæ–¹æ³•ï¼š\ndef a_method(string, integer) puts \u0026#34;the string is #{string} and the integer is #{integer}\u0026#34; end ä¸€èˆ¬è¿™ä¹ˆç”¨è¿™ä¸ªæ–¹æ³•ï¼š\na_method \u0026#34;the string\u0026#34;, 1 å¦‚æœæƒ³ç”¨ heredoc å‘¢ï¼Ÿè¿™é‡Œå°±éœ€è¦è¯´ä¸‹é‚£ä¸ª\u0026lt;\u0026lt;-EOFåˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿå…¶å®\u0026lt;\u0026lt;-EOFåªæ˜¯ä¸ªå ä½ç¬¦ï¼Œå†™ä¸Šå®ƒä»¥åï¼Œå®ƒå°±ä»£è¡¨å°†è¦è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²çš„åˆ¤æ–­æ˜¯ä»\u0026lt;\u0026lt;-EOFçš„ä¸‹ä¸€è¡Œå¼€å§‹è®¡ç®—ï¼Œä¸€ç›´ç¢°åˆ°åªæœ‰EOFçš„ä¸€è¡Œï¼ˆè¿™ä¸€è¡Œåªæœ‰ä¸€ä¸ªEOFï¼‰ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²å°±è¿™æ ·è®¡ç®—å‡ºæ¥çš„ã€‚å¦‚æœä¸Šé¢çš„è¿™ä¸ªæ–¹æ³•è¦ç”¨ heredoc çš„è¯ï¼Œå°±å¯ä»¥è¿™æ ·å†™ï¼š\na_method \u0026lt;\u0026lt;-EOF, 1 this is the first line this is the second line EOF è¾“å‡ºï¼š\nthe string is this is the first line this is the second line and the integer is 1 å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª\u0026lt;\u0026lt;-EOFå°±å¥½åƒä¸€ä¸ªå®å‚ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠä»–å®Œå…¨å½“ä¸ªå®å‚æ¥å¯¹å¾…ï¼Œå®ƒæ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±å¯ä»¥è°ƒç”¨å­—ç¬¦ä¸²çš„æ–¹æ³•ï¼Œåƒè¿™æ ·ï¼š\na_method \u0026lt;\u0026lt;-EOF.gsub(\u0026#34;\\n\u0026#34;, \u0026#34;\u0026#34;), 1 this is the first line this is the second line EOF è¾“å‡ºï¼š\nthe string is this is the first linethis is the second line and the integer is 1 æˆ‘ä»¬æŠŠå®ƒæ°ç›´äº†ï¼Œå“ˆå“ˆã€‚æ¢ä¸ªå†™æ³•æ›´èƒ½ä½“ç° heredoc çš„æœ¬è´¨ï¼š\na_method(\u0026lt;\u0026lt;-EOF.gsub(\u0026#34;\\n\u0026#34;, \u0026#34;\u0026#34;), 1) this is the first line this is the second line EOF heredoc çš„å°æŠ€å·§ é‚£ä¸ª\u0026lt;\u0026lt;-EOFä¸ºä»€ä¹ˆå«EOFï¼Œä¸ºä»€ä¹ˆä¸å«ABCï¼Œä½ å¯ä»¥è¯•è¯•ï¼Œå«ABCä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯æœ«å°¾é‚£ä¸ªä¹Ÿè¦å†™ ABCï¼Œè¦ä¿æŒé…å¯¹ã€‚åœ¨æœ‰äº›ç¼–è¾‘å™¨ï¼ˆAtomï¼ŒRubyMineï¼‰ä¸­ç”šè‡³ä¼šæ ¹æ®å ä½ç¬¦å°† heredoc ä¸­çš„å†…å®¹é«˜äº®æ˜¾ç¤ºï¼Œæ¯”å¦‚å¯ä»¥å†™\u0026lt;\u0026lt;-RUBY, \u0026lt;\u0026lt;-HTMLç­‰ç­‰ã€‚\nå‡å¦‚å‰é¢çš„é‚£ä¸ªæ–¹æ³•è¦ä¼ å…¥ä¸¤ä¸ªå­—ç¬¦ä¸²è¯¥æ€ä¹ˆå†™å‘¢ï¼Ÿå¾ˆç®€å•ï¼š\na_method \u0026lt;\u0026lt;-STR1, \u0026lt;\u0026lt;-STR2 this is for STR1 STR1 this is for STR2 STR2 è¾“å‡ºï¼š\nthe string is this is for STR1 and the integer is this is for STR2 æœ‰ä¸€ç‚¹ç‚¹æ™•ï¼Œè§£é‡Šä¸€ä¸‹ã€‚\u0026lt;\u0026lt;-STR1åœ¨å‰é¢ï¼Œå®ƒå°±ä¼šä¸€ç›´æ‰¾åˆ°åªåŒ…å«STR1çš„é‚£ä¸€è¡Œï¼Œå¹¶æŠŠå…¶ä¸­çš„å†…å®¹æ›¿æ¢æ‰\u0026lt;\u0026lt;-STR1ï¼Œè€Œ\u0026lt;\u0026lt;-STR2åœ¨åé¢ï¼Œå®ƒä¸ä¼šåŒ…æ‹¬\u0026lt;\u0026lt;-STR1å’ŒSTR1ä¸­çš„éƒ¨åˆ†ï¼Œ ä¼šä¸€ç›´æ‰¾åˆ°åªåŒ…å«STR2çš„é‚£ä¸€è¡Œï¼Œç„¶åæ›¿æ¢\u0026lt;\u0026lt;-STR2ã€‚åªéœ€è®°ä½æ˜¯åªåŒ…å«å ä½ç¬¦çš„ä¸€è¡Œï¼Œåƒthis is for STR1ä¸­è™½ç„¶åŒ…å«STR1ï¼Œä½†æ˜¯è¿™ä¸€è¡Œè¿˜æœ‰å…¶ä»–å­—ç¬¦ï¼Œheredoc å°±ä¸ä¼šåœ¨è¿™ä¸€è¡Œç»“æŸï¼Œè€Œæ˜¯æ¥ç€å¾€ä¸‹æ‰¾ã€‚åŒæ—¶éœ€è¦çŸ¥é“ï¼Œè™½ç„¶æ˜¯å ä½ç¬¦ï¼Œä½†æ˜¯å¯ä»¥è°ƒç”¨å­—ç¬¦ä¸²çš„æ–¹æ³•ï¼Œåœ¨ Rails5 ä¸­æœ€è¿‘çš„ä¸€ä¸ª pull request ä¸­ DHH å°±ç”¨äº†å¾ˆå¤š heredocã€‚ä¸è¿‡æˆ‘æ‰¾äº†åŠå¤©æ²¡æ‰¾åˆ°ï¼Œç­‰ä»¥åæ‰¾åˆ°å†æŠŠé“¾æ¥ä»˜åœ¨è¿™é‡Œã€‚\nå‰é¢çš„è¾“å‡ºç»“æœä¸­ï¼Œå¤§å®¶ä¸€å®šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å­—ç¬¦ä¸²çš„æ¢è¡Œå’Œè¡Œé¦–çš„ç¼©è¿›ï¼Œæœ‰æ—¶å€™ä½ æƒ³è¦ä»–ä»¬ï¼Œæœ‰æ—¶å€™å¯ä¸æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨gsubæ¥æ›¿æ¢ã€‚åœ¨ Rails ä¸­å·²ç»æœ‰ä¸€ä¸ªå¥½ç”¨çš„æ–¹æ³•äº†ï¼š\n2.times do puts \u0026lt;\u0026lt;-STR.strip_heredoc this is the first line this is the second line STR end è¾“å‡ºï¼š\nthis is the first line this is the second line this is the first line this is the second line æ³¨æ„è¡Œé¦–æ˜¯æ²¡æœ‰ç©ºæ ¼çš„ï¼Œå’Œè¾“å…¥çš„æ ¼å¼ä¿æŒäº†ä¸€è‡´ï¼Œå¾ˆæ–¹ä¾¿ï¼Œå®ç°ä¹Ÿæ˜¯å¾ˆç®€å•çš„ï¼Œå‚è€ƒ github å§ï¼Œstrip.rb\né‚£äº›å¤ªå¥‡æ€ªçš„å†™æ³• å…¶å®è¿˜æœ‰å¾ˆå¤šå¥‡æ€ªçš„å†™æ³•ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªï¼š\nputs \u0026lt;\u0026lt;-\u0026#34;I am the content\u0026#34; line 1 line 2 line 3 I am the content è¿™æ˜¯åˆæ³•è¯­æ³•ï¼Œä½†ä¼°è®¡ä¸ä¼šæœ‰äººè¿™ä¹ˆå†™ï¼Œç”šè‡³æœ‰çš„ç¼–è¾‘å™¨éƒ½ä¸èƒ½æ­£å¸¸é«˜äº®æ˜¾ç¤ºå®ƒ.\n","date":"2018-11-22T09:23:36Z","permalink":"https://dccmmtop.github.io/posts/ruby_heredoc%E7%9A%84%E7%94%A8%E6%B3%95/","section":"posts","tags":["ruby"],"title":"ruby_heredocçš„ç”¨æ³•"},{"categories":null,"contents":"ä»€ä¹ˆæ˜¯å¤šæ€å…³è” å‡å¦‚æœ‰ä¸‰ä¸ªæ¨¡å‹ï¼Œåˆ†åˆ«æ˜¯ ç”¨æˆ·ï¼Œ äº§å“ï¼Œ å›¾ç‰‡ã€‚å›¾ç‰‡ä¸ºç”¨æˆ·æ‰€æœ‰ï¼Œä¹Ÿä¸ºäº§å“æ‰€æœ‰ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸¤ä¸ª picture çš„æ¨¡å‹ï¼Œå¦‚ä¸‹\nrails g modle picture_user user_id:integer name:string url:string\nrails g modle picture_product product_id:integer name:string url:string\nclass PictureUser \u0026lt; ApplicationRecord belongs_to :user end class PictureProduct \u0026lt; ApplicationRecord belongs_to :product end è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨user.prictures å’Œ product.picturesæ¥åˆ†åˆ«è·å¾—ç”¨æˆ·ä¸‹å’Œäº§å“ä¸‹çš„å›¾ç‰‡äº†ã€‚ä½†æ˜¯æˆ‘ä»¬å‘ç°ï¼Œä¸¤ä¸ªå›¾ç‰‡æ¨¡å‹é™¤äº†å¤–é”®ä¸ä¸€æ ·ï¼Œå…¶ä»–å­—æ®µéƒ½æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§åŠæ³•åªåˆ›å»ºä¸€ä¸ª picture æ¨¡å‹ï¼ŒåŒæ—¶å±äº user å’Œ product å‘¢ï¼Œè¿™ç§æ—¢å±äºä¸€ä¸ªæ¨¡å‹åˆå±äºå¦å¤–ä¸€ä¸ªæ¨¡å‹ï¼ˆå¯ä»¥æ˜¯å¾ˆå¤šä¸ªï¼‰çš„å…³è”å°±æ˜¯å¤šæ€å…³è”ã€‚\nå¤šæ€å…³è”çš„å®ç° ä¸ºäº†èƒ½åŒæ—¶ä½¿ç”¨ user.pictures å’Œ product.pictures æ¥è·å¾—å„è‡ªçš„å›¾ç‰‡ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹ picture æ¨¡å‹åšä¸€äº›ä¿®æ”¹ï¼Œä½¿å…¶èƒ½å¤Ÿæ ‡è¯†ä¸€å¼ å›¾ç‰‡æ˜¯å±äº user è¿˜æ˜¯å±äº product ï¼Œå½“ç„¶å¤–é”®æ˜¯å¿…ä¸å¯å°‘çš„ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå¤–é”®å¯¹åº”ç±»çš„åç§°ï¼Œå¦‚ä¸‹ï¼š\nrails g modle picture pictureable_id:integer pictureable_type:string name:string url:string\nclass Picture \u0026lt; ApplicationRecord belongs_to :pictureable, polymorphic: true end class User \u0026lt; ApplicationRecord has_many :pictures, as: :pictureable end class Product \u0026lt; ApplicationRecord has_many :pictures, as: :pictureable end pictureable ç›¸å½“äºä¸€ä¸ªæ¥å£ï¼Œå‡¡æ˜¯æ‹¥æœ‰å›¾ç‰‡çš„æ¨¡å‹éƒ½å¯ä»¥åƒ User é‚£æ ·ä½¿ç”¨å…³è”ã€‚\nå¯ä»¥ä½¿ç”¨user.pictures.create(name: 'user_0', url: 'https://dcc.com')æ¥åˆ›å»ºä¸€æ¡å…³è”å¯¹è±¡ï¼Œåˆ›å»ºä¹‹åæˆ‘ä»¬å‘ç°åœ¨ picture è¡¨ä¸­å¤šäº†ä¸€æ¡è®°å½•ï¼š\nid: 1, pictureable_type: \u0026#39;User\u0026#39;, pictureable_id: 1, name:\u0026#34;user_0\u0026#34;, url:\u0026#39;https://dcc.com\u0026#39; pictureable_type: \u0026lsquo;User\u0026rsquo; å°±æ˜¯æ‰€å±å¯¹è±¡çš„æ ‡è¯†ï¼Œè¿™æ ·æ‰å¯ä»¥ä½¿ç”¨ user.pictures è¿›è¡ŒæŸ¥è¯¢ã€‚ç”±æ­¤æˆ‘ä»¬çŸ¥é“ï¼Œå¤šæ€å…³è”ä¸­ï¼Œxxxable_type, xxxable_idå­—æ®µæ˜¯å¿…ä¸å¯å°‘çš„ã€‚\n-\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\nä¸‹é¢æ˜¯å…³äºå¤šæ€ view é¡µé¢ä½¿ç”¨çš„è®²è§£åŸæ–‡\nä»€ä¹ˆæ˜¯å¤šæ€ Rails æ¨¡å‹ä¸­çš„å…³ç³»æœ‰ä¸€å¯¹ä¸€ï¼Œä¸€å¯¹å¤šè¿˜æœ‰å¤šå¯¹å¤šï¼Œè¿™äº›å…³è”å…³ç³»éƒ½æ¯”è¾ƒç›´è§‚ï¼Œé™¤æ­¤ä¹‹å¤– Rails è¿˜æ”¯æŒå¤šæ€å…³è”ï¼Œæ‰€è°“çš„å¤šæ€å…³è”å…¶å®å¯ä»¥æ¦‚æ‹¬ä¸ºä¸€ä¸ªæ¨¡å‹åŒæ—¶ä¸å¤šä¸ªå…¶å®ƒæ¨¡å‹ä¹‹é—´å‘ç”Ÿä¸€å¯¹å¤šçš„å…³è”ã€‚å¹¶ä¸”åœ¨å®é™…çš„åº”ç”¨ä¸­è¿™ç§å…³ç³»ä¹Ÿååˆ†æ™®éï¼Œæ¯”å¦‚å¯ä»¥åº”ç”¨åˆ°ç«™å†…æ¶ˆæ¯æ¨¡å—ï¼Œè¯„è®ºæ¨¡å—ï¼Œæ ‡ç­¾æ¨¡å—ç­‰åœ°æ–¹ï¼Œä¸‹å›¾å°±æ˜¯å¤šæ€å…³ç³»ä¸‹çš„è¯„è®ºæ¨¡å—çš„ E-R å›¾ã€‚\né€šè¿‡ E-R å›¾ï¼Œæˆ‘ä»¬èƒ½ç›´è§‚çš„çœ‹åˆ°ç³»ç»Ÿä¸­çš„äº‹ä»¶ï¼Œæ–‡ç« ä»¥åŠç…§ç‰‡éƒ½å¯ä»¥è¢«ç”¨æˆ·è¯„è®ºï¼Œå¹¶ä¸”è¿™äº›è¯„è®ºéƒ½è¢«å­˜å‚¨åœ¨ä¸€å¼ å« comments è¡¨ä¸­ã€‚Okï¼Œç°åœ¨æˆ‘ä»¬å·²ç»ææ¸…æ¥šäº†å¤šæ€çš„å«ä¹‰ï¼Œä¸‹é¢ç»§ç»­çœ‹ä¸‹ Rails ä¸­æ˜¯å¦‚ä½•å®ç°å¤šæ€å…³è”çš„ã€‚\nRails ä¸­å®ç°å¤šæ€çš„æ­¥éª¤ è¿™é‡Œæˆ‘ä»¬é€šè¿‡å°† Rails Guides ä¸­ç»™å‡ºçš„ä¾‹å­çº¿æ€§åŒ–(è½¬åŒ–ä¸ºè¯¦ç»†æ­¥éª¤)æ¥è¯´æ˜è¿™ä¸ªé—®é¢˜ã€‚\nStep 1ï¼š é€šè¿‡ Migration åˆ›å»ºè¡¨ æ‰§è¡Œä¸‹é¢å‘½ä»¤æ¥ç”Ÿæˆ Migration æ–‡ä»¶\nrails g model picture name:string imageable_id:integer imageable_type:string ç”Ÿæˆçš„ Migration æ–‡ä»¶å¦‚ä¸‹:\nclass CreatePictures \u0026lt; ActiveRecord::Migration def change create_table :pictures do |t| t.string :name t.integer :imageable_id t.string :imageable_type t.timestamps null: false end add_index :pictures, :imageable_id end end å…¶ä¸­éœ€è¦ç‰¹åˆ«å…³æ³¨ï¼Œ imageable_id ä¸ imageable_type ä¸¤ä¸ªå­—æ®µï¼Œå‰è€…ç”¨æ¥å­˜å‚¨ç›¸å…³è”å†…å®¹çš„å¤–é”®é”®å€¼ï¼Œåè€…åˆ™ç”¨æ¥å­˜å‚¨ç›¸å…³è”å†…å®¹çš„ç±»å‹åã€‚åé¢åœ¨é€šè¿‡æ¨¡å‹æŸ¥æ‰¾å…³è”å†…å®¹çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªå€¼æ¥å®šä½åˆ°è¦æ‰¾åˆ°çš„å†…å®¹ã€‚ç‰¹åˆ«æ˜¯åè€… imageable_type çš„å­˜åœ¨æ˜¯å¤šæ€å®ç°çš„å…³é”®ã€‚\nStep 2: ä¿®æ”¹å„ Model å¾—å…³è”å…³ç³» æŒ‰ç…§ä¸Šé¢ E-R å›¾å’Œä»£ç ä¿®æ”¹æ¨¡å‹ç»“æ„ï¼Œå› ä¸º Employeeï¼ŒProduct åˆ†åˆ«ä¸ Picture æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œæ‰€ä»¥ç”¨åˆ°äº† has_many ä¸ belongs_to æ–¹æ³•ï¼Œå†ä½¿ç”¨ polymorphic ä¸ as æ¥æŒ‡æ˜æ˜¯å¤šæ€å…³è”ã€‚\nStep 3: Controller ä¸­åº”ç”¨ ä¸Šé¢çš„ä¸¤æ­¥å®Œæˆåå°±èƒ½åœ¨ Controller ä¸­é€šè¿‡å¤šæ€å…³è”å…³ç³»è¿›è¡Œç›¸äº’è®¿é—®äº†ï¼Œå¹¶ä¸”é€šè¿‡å…³è”å…³ç³»åˆ›å»ºçš„æ–°è¯„è®º Rails ä¹Ÿä¼šè‡ªåŠ¨å¸®ä½ è®¾ç½® commentable_id ä¸ commentable_type ä¸¤ä¸ªå­—æ®µçš„å€¼ã€‚\nevent = Event.create name: \u0026#34;event1\u0026#34;\revent1= event.comments.create content: â€œcomment1â€\revent1.commentable_type #=\u0026gt; â€œEventâ€ Doneï¼åˆ°æ­¤å°±ç®—å®Œæ•´åº”ç”¨åˆ°äº†å¤šæ€å…³è”å…³ç³»ï¼Œåç»­éœ€è¦å¤„ç†çš„å°±æ˜¯å¦‚ä½•æ¥ç»„ç»‡ä»£ç è®©å¤šæ€å…³ç³»æ›´åŠ çµæ´»ä¾¿æ·çš„è¢«ä½ æ“ä½œï¼Œä¸è¿‡è¿™ä¸ªå°±åº”è¯¥æ˜¯å¦ä¸€ç¯‡æ–‡ç« çš„å†…å®¹äº†ã€‚:)\nåˆšå¼€å§‹çœ‹ Rails Guide çš„æ—¶å€™å¯¹å¤šæ€çš„è¡¨å…³è”çœŸçš„æ˜¯ä¸€å¤´é›¾æ°´ã€‚åæ¥è‡ªå·±å†™äº†ä¸€ä¸ªåšå®¢åº”ç”¨çš„æ—¶å€™ç”¨åˆ°äº† acts_as_commentable è¿™ä¸ª gemï¼Œå®ƒå°±æ˜¯ç”¨åˆ°äº†å¤šæ€è¡¨çš„å…³è”ï¼Œç„¶åæˆ‘åˆçœ‹äº† Terry åœ¨ railscasts china ä¸Šçš„ è§†é¢‘ ï¼Œå¯¹å¤šæ€çš„ç†è§£å°±æ·±äº†å¾ˆå¤šã€‚\nç†è§£ä»€ä¹ˆæ˜¯å¤šæ€ ä¸€èˆ¬è¡¨çš„å…³è”æœ‰ä¸€å¯¹ä¸€ï¼Œä¸€å¯¹å¤šï¼Œå¤šå¯¹å¤šï¼Œè¿™äº›éƒ½æ˜¯éå¸¸å¥½ç†è§£çš„ï¼Œç„¶åå¯¹äºå¤šæ€çš„è¡¨å…³è”å¯èƒ½ç¨å¾®æœ‰ç‚¹ä¸å¥½ç†è§£ã€‚å…¶å®å¤šæ€å…³é”®å°±æ˜¯ä¸€ä¸ªè¡¨å…³è”åˆ°å¤šä¸ªè¡¨ä¸Šã€‚å°±å¦‚ Commentï¼ˆè¯„è®ºï¼‰è¡¨å§ï¼Œä¸€ä¸ª Topic åº”è¯¥æœ‰ Commentï¼ˆä¸€ä¸ªå¸–å­åº”è¯¥æœ‰è®¸å¤šçš„è¯„è®ºï¼‰ï¼Œé™¤æ­¤ä¹‹å¤– Micropostï¼ˆå¾®åšï¼‰ä¹Ÿå¯èƒ½æœ‰å¾ˆå¤šçš„ Commentã€‚ç„¶åä¸€ä¸ªç½‘ç«™ä¸­æ—¢æœ‰ Topic çš„è®ºå›åŠŸèƒ½ï¼Œåˆæœ‰ Micropost çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬æ€ä¹ˆå¤„ç† Comment è¡¨å‘¢ï¼Ÿå½“ç„¶æˆ‘ä»¬å¯ä»¥å»ºä¸¤ä¸ªç‹¬ç«‹çš„è¡¨æ¯”å¦‚ TopicComment å’Œ MicropostCommentï¼Œå†åˆ†åˆ«å…³è”åˆ° Topic å’Œ Micropost ä¸Šï¼Œä½†è¿™ä¸æ˜¯ä¸€ç§å¥½çš„é€‰æ‹©ï¼Œæˆ‘ä»¬å¯ä»¥åªå»ºä¸€ä¸ªè¡¨ï¼Œç„¶åå»å…³è”è¿™ä¸¤ä¸ªè¡¨ï¼Œç”šè‡³å¤šä¸ªè¡¨ã€‚è¿™ä¹Ÿå°±å®ç°äº†å¤šæ€çš„èƒ½åŠ›ã€‚\nä¸€ä¸ªä¾‹å­ 1.é¦–å…ˆæˆ‘ä»¬å…ˆç”Ÿæˆä¸€ä¸ª Comment çš„ modelï¼Œå‡è®¾å·²ç»æœ‰ Topic å’Œ Micropost è¿™ä¸¤ä¸ª model äº†\nrails g model comment content:text commentable_id:integer comment_type:string 2.ç„¶åæˆ‘ä»¬ ä¼šå¾—åˆ°ä¸€ä¸ª migration\nclass CreateComments \u0026lt; ActiveRecord::Migration def change create_table :comments do |t| t.text :content t.integer :commentable_id t.string :commentable_type t.timestamps end end end ä¹Ÿå¯ä»¥é€šè¿‡ t.references æ¥ç®€åŒ–ä¸Šé¢çš„\nclass CreateComments \u0026lt; ActiveRecord::Migration def change create_table :comments do |t| t.text :content t.references :commentable, :polymorphic =\u0026gt; true #è¿™é‡ŒæŒ‡æ˜äº†å¤šæ€ï¼Œè¿™æ ·ä¼šç”Ÿæˆcomment_idå’Œcomment_typeè¿™ä¸¤ä¸ªå­—æ®µçš„ï¼Œå¦‚ä¸Š t.timestamps end end end å¤šæ€é­”æ³•å°±åœ¨è¿™é‡Œï¼Œcommentable_typle å­—æ®µç”¨äºæŒ‡æ˜ comment æ‰€å…³è”çš„è¡¨çš„ç±»å‹ï¼Œå¦‚ topic æˆ– micropost ç­‰ï¼Œè€Œ comment_id ç”¨äºæŒ‡å®šé‚£ä¸ªå…³è”è¡¨çš„ç±»å‹å¯¹è±¡çš„ idã€‚å¦‚ï¼šå¯ä»¥æŠŠä¸€ä¸ª comment å…³è”åˆ°ç¬¬ä¸€ç¯‡ topic ä¸Šï¼Œé‚£ä¹ˆ comment_type å­—æ®µä¸º topicï¼Œè€Œ comment_id ä¸ºå¯¹åº” topic å¯¹è±¡çš„ id 1,åŒç†è¿™æ ·å°±å¯ä»¥å…³è”åˆ°ä¸åŒè¡¨äº†ï¼Œä»è€Œå®ç°å¤šæ€çš„å…³è”ã€‚\n3,æ•°æ®è¿ç§» rake db:migrate å°±èƒ½ç”Ÿæˆæˆ‘ä»¬è¦çš„è¡¨äº†\n4,å¯¹ model è¿›è¡Œæ“ä½œä»è€Œç°å®è¡¨çš„å…³è”\n####comment model class Comment \u0026lt; ActiveRecord::Base belongs_to :commentable, :polymorphic =\u0026gt; true end çœ‹åˆ°æ²¡æœ‰ï¼Œè¿™é‡Œçš„ comment belongs_to æ²¡æœ‰å†™ topicï¼Œmicropost ç­‰ï¼Œè€Œå†™äº† commentable,å› ä¸º commentable ä¸­æœ‰ type å’Œ id ä¸¤ä¸ªå­—æ®µï¼Œå¯ä»¥æŒ‡å®šä»»ä½•å…¶ä»– model å¯¹è±¡çš„ï¼Œä»è€Œæ‰èƒ½å®ç°å¤šæ€ï¼Œå¦‚æœè¿™é‡Œå†™ belongs_to topic çš„è¯å°±æ²¡åŠæ³•å®ç°å¤šæ€äº†ã€‚ç„¶åæˆ‘ä»¬çœ‹çœ‹ topic å’Œ mocropost çš„ model è¯¥å¦‚ä½•å†™ã€‚\nclass Topic \u0026lt; ActiveRecord::Base has_many :comments, :as =\u0026gt; :commentable end class Micropost \u0026lt; ActiveRecord::Base has_many :comments, :as =\u0026gt; :commentable end çœ‹åˆ°è¿™é‡Œçš„ as äº†å—ï¼Ÿas åœ¨è¿™æˆ‘ä»¬å¯ä»¥è§£é‡Šä¸ºï¼šä½œä¸ºï¼ˆæˆ‘çš„ç†è§£ï¼Œå¯èƒ½è¿™ç§ç†è§£è¡¥ç§‘å­¦ï¼Œå“ˆå“ˆï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ Topic æœ‰è®¸å¤šçš„ commentsï¼Œä½†æ˜¯å®ƒæ˜¯é€šè¿‡å°†è‡ªå·±ä½œä¸º commentableï¼Œå®ç°çš„ã€‚Micropost åŒç†ã€‚\nç„¶åå°±æ˜¯ controller å’Œ views ä¸­ï¼ˆå¦‚ form è¡¨å•ï¼‰çš„è®¾è®¡äº†ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘åˆšå­¦çš„æ—¶å€™ï¼Œæœ€å¤´ç–¼è¿™ä¸ªäº†ï¼Œå› ä¸ºå¯¹ params å‚æ•°é€šè¿‡è¡¨å•åˆ° controller çš„ä¼ é€’æ²¡æŒæ¡å¥½ã€‚\nåœ¨å†™è¿™äº›ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹å¦‚ä½•å†™è·¯ç”±å§ï¼Œå› ä¸ºä¸€ä¸ª topic æœ‰å¤šä¸ª commentsï¼ŒMicropost åŒç†ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·å†™\nresources :topics do resources :comments end resources :microposts do resources :comments end ç„¶åæˆ‘ä»¬é€šè¿‡å‘½ä»¤ rake routes å°±å¯ä»¥å¾—åˆ°ç›¸åº”çš„è·¯ç”±äº†å¦‚ï¼š\ntopic_comments GET /topics/:topic_id/comments(.:format) comments#index POST /topics/:topic_id/comments(.:format) comments#create new_topic_comment GET /topics/:topic_id/comments/new(.:format) comments#new edit_topic_comment GET /topics/:topic_id/comments/:id/edit(.:format) comments#edit topic_comment GET /topics/:topic_id/comments/:id(.:format) comments#show PUT /topics/:topic_id/comments/:id(.:format) comments#update DELETE /topics/:topic_id/comments/:id(.:format) comments#destroy è¿™äº›å¾…ä¼šæˆ‘ä»¬ä¼šç”¨åˆ°ã€‚\nç„¶åæˆ‘ä»¬å†æ¥åˆ†æ controller å’Œ views ä¹‹é—´çš„å‚æ•°ä¼ é€’ã€‚æˆ‘ä»¬é€šè¿‡å®Œæ•´çš„åˆ›å»º comment çš„è¿‡ç¨‹è¿›è¡Œè¯´æ˜\n(1)é¦–å…ˆé¡µé¢ä¸Šè‚¯å®šæœ‰ä¸€ä¸ªåˆ›å»º comment çš„è¿æ¥æˆ–æŒ‰é’®ï¼ˆå‡è®¾åˆ›å»º comment çš„è¡¨å•å’Œ topic show é¡µé¢ä¸åœ¨ç»Ÿä¸€é¡µé¢ä¸Šï¼‰ï¼Œä»£ç åº”è¯¥æ˜¯è¿™æ ·çš„ï¼š\n\u0026lt;%= link_to \u0026#34;å‘è¡¨è¯„è®º\u0026#34;, new_topic_comment_path%\u0026gt; (2)ç‚¹å‡»è¿™ä¸ªé“¾æ¥åï¼Œé€šè¿‡è·¯ç”±æ¥åˆ° controller ä¸­çš„ new æ–¹æ³•(åŒæ—¶ä¼šå°†å¯¹åº”çš„ topic ç›¸å…³çš„å‚æ•°ä¼ ç»™ controller)\ndef new @topic = Topic.find(parmas[:id]) #æ‰¾åˆ°commentå±äºçš„topic @comment = @topic.comments.build #å»ºç«‹è¿™ä¸ªå…³ç³» end (3)ç»è¿‡è¿™ä¸ªæ–¹æ³•ï¼ˆactionï¼‰åï¼Œé¡µé¢æ¥åˆ°äº† comments/new.html.erb,åœ¨è¿™ä¸ªé¡µé¢ä¸­æœ‰ä¸€ä¸ªè¯„è®ºçš„è¡¨å•ï¼Œå¤§æ¦‚æ˜¯è¿™æ ·çš„\n\u0026lt;%= form_for([@comment.commentable, @comment]) do |f| %\u0026gt;\r......\r\u0026lt;%end%\u0026gt; è¿™ä¸ªè¡¨çš„å‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œ[email protected]\n@commentï¼Œå¦‚æœæ²¡æœ‰å…³è”çš„åŒ–ï¼Œ[email protected]ï¼Œ\n[email protected]\nï¿½ï¿½ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯ commentableï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯ topicã€‚\nè¿˜è®°å¾— new ä¸­çš„ @comment = @topic.comments.build çš„å—ï¼Œè¿™é‡Œå°±æš‚æ—¶å°†å¯¹åº”çš„ topic å¯¹è±¡å†™å…¥ commentableï¼ˆæ³¨æ„ï¼šåªæ˜¯æš‚æ—¶å»ºç«‹å…³ç³»ï¼Œè¿˜æ²¡æœ‰å†™å…¥æ•°æ®åº“ï¼‰ï¼Œ[email protected]\n@topicã€‚\n(4)ç„¶åä½ å¡«å®Œè¡¨å•åï¼ŒæŒ‰æäº¤æŒ‰é’®åï¼Œè¡¨å•ä¸­çš„å‚æ•°ï¼ˆåŒ…æ‹¬ commentableï¼Œ@post çš„ id ç­‰ä¿¡æ¯ï¼‰ï¼Œä¸€èµ·æ¥åˆ° controller çš„ create æ–¹æ³•ä¸­\ndef create Topic.find(parmas[:topic_id]).comments.create(parmas[:comment]) ...... end è¿™æ ·å°±çœŸæ­£åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ commentã€‚micropost åŒç†ã€‚\nå…¶å®å¤šæ€è®²çš„ä¹Ÿå·®ä¸å¤šäº†ï¼Œä½†åœ¨æä¸€ä¸ªåœ°æ–¹\n**é‡è¦çŸ¥è¯†ç‚¹:**å‡è®¾ä¸€ä¸ª comment å·²ç»å»ºç«‹äº†ï¼Œå®ƒçš„ commentable_type æ˜¯:topic.comment_id æ˜¯ 1ã€‚å¦‚æœæˆ‘ä»¬å¾—åˆ°äº†è¿™ä¸ª id ä¸º 1 çš„ topicï¼Œ@topicï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆå¾—åˆ°å®ƒçš„ comments å‘¢ï¼Ÿæ˜¯çš„å¾ˆç®€å•ï¼Œç›´æ¥ @topic.comments å°± ok äº†ã€‚ä½†æ˜¯åè¿‡æ¥å‘¢ï¼Œæˆ‘ä»¬å¾—åˆ°äº†è¿™ä¸ª commentï¼Œ@commentï¼Œæˆ‘ä»¬å¦‚ä½•å¾—åˆ°å¯¹åº”çš„ topic çš„ä¿¡æ¯å‘¢ï¼Ÿæˆ‘ä»¥å‰åˆšå­¦çš„æ—¶å€™ï¼Œå°±ç”¨äº†@comment.topic ï¼Œå‘µå‘µï¼Œæ²¡é”™ï¼Œå¾—åˆ°çš„æ˜¯ä¸€ä¸²é”™è¯¯ï¼Œæ­£ç¡®ä¸€æ¦‚æ˜¯ @comment.commentable\nå…³äºå¤šæ€æˆ‘ä»¬å·²ç»è®²çš„å·®ä¸å¤šäº†ã€‚\nè¡¥å……ï¼šä¸Šé¢çš„ä¾‹å­ comment çš„è¡¨å•æ˜¯ç‹¬ç«‹åœ¨ comments/new.html.erb ä¸­çš„ï¼Œä½†æ˜¯ä¸€èˆ¬çš„åº”ç”¨ comment çš„è¡¨å•æ˜¯åœ¨ topics/show.html.erb ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ä¸€ä¸ª topicï¼Œtopic ä¸‹æœ‰ä¸€ä¸ª comment è¡¨å•ã€‚è¿™æ ·çš„è¯åœ¨ controller ä¸­æˆ‘ä»¬å°±ä¸éœ€è¦ new è¿™ä¸ªæ–¹æ³•äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨å“ªå»ºç«‹å…³ç³»å‘¢ï¼Ÿ\n@comment = @topic.comments.build #å»ºç«‹è¿™ä¸ªå…³ç³» æˆ‘ä»¬å°±åœ¨è¡¨å•çš„ \u0026lt;%= form_for ...%\u0026gt; å‰é¢å†™ \u0026lt;@comment = @topic.comments.build\u0026gt;\n","date":"2018-11-21T15:35:41Z","permalink":"https://dccmmtop.github.io/posts/rails_%E5%A4%9A%E6%80%81%E5%85%B3%E8%81%94/","section":"posts","tags":["rails"],"title":"rails_å¤šæ€å…³è”"},{"categories":null,"contents":"å®‰è£… redis gem redis bundle install ä¿®æ”¹ cable.yml development: adapter: redis ç”Ÿæˆè®¢é˜… rails g channel block speak\nè¿æ¥è®¾ç½® è¿æ¥æ˜¯å®¢æˆ·ç«¯-æœåŠ¡å™¨é€šä¿¡çš„åŸºç¡€ã€‚æ¯å½“æœåŠ¡å™¨æ¥å—ä¸€ä¸ª WebSocketï¼Œå°±ä¼šå®ä¾‹åŒ–ä¸€ä¸ªè¿æ¥å¯¹è±¡ã€‚æ‰€æœ‰é¢‘é“è®¢é˜…ï¼ˆchannel subscriptionï¼‰éƒ½æ˜¯åœ¨ç»§æ‰¿è¿æ¥å¯¹è±¡çš„åŸºç¡€ä¸Šåˆ›å»ºçš„ã€‚è¿æ¥æœ¬èº«å¹¶ä¸å¤„ç†èº«ä»½éªŒè¯å’Œæˆæƒä¹‹å¤–çš„ä»»ä½•åº”ç”¨é€»è¾‘ã€‚WebSocket è¿æ¥çš„å®¢æˆ·ç«¯è¢«ç§°ä¸ºè¿æ¥ç”¨æˆ·ï¼ˆconnection consumerï¼‰ã€‚æ¯å½“ç”¨æˆ·æ–°æ‰“å¼€ä¸€ä¸ªæµè§ˆå™¨æ ‡ç­¾ã€çª—å£æˆ–è®¾å¤‡ï¼Œå¯¹åº”åœ°éƒ½ä¼šæ–°å»ºä¸€ä¸ªç”¨æˆ·-è¿æ¥å¯¹ï¼ˆconsumer-connection pairï¼‰ã€‚ è¿æ¥æ˜¯ ApplicationCable::Connection ç±»çš„å®ä¾‹ã€‚å¯¹è¿æ¥çš„æˆæƒå°±æ˜¯åœ¨è¿™ä¸ªç±»ä¸­å®Œæˆçš„ï¼Œå¯¹äºèƒ½å¤Ÿè¯†åˆ«çš„ç”¨æˆ·ï¼Œæ‰ä¼šç»§ç»­å»ºç«‹è¿æ¥ã€‚\nä¾‹å­ï¼š\nmodule ApplicationCable class Connection \u0026lt; ActionCable::Connection::Base identified_by :current_user def connect self.current_user = find_verified_user end private def find_verified_user if cu_user = User.find_by(id: cookies.signed[:user_id]) cu_user else reject_unauthorized_connection end end end end action cable ä¸­ä¸èƒ½ä½¿ç”¨ sessionï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ cookie æ¥éªŒè¯ç”¨æˆ·ã€‚ä¸‹é¢åœ¨ SessionHelper ä¸­åŠ å…¥ cookieï¼Œæ–¹ä¾¿ action cable ä½¿ç”¨\nmodule SessionsHelper def log_in(user) session[:user_address] = user.address user = User.find_by(address: session[:user_address]) if user cookies.permanent.signed[:user_id] = user.id end end def current_user @current_user ||= User.find_by(address: session[:user_address]) end def logged_in? !current_user.nil? end def log_out session.delete(:user_address) @current_user = nil cookies.delete(:user_id) end end è®¢é˜… App.block = App.cable.subscriptions.create channel: \u0026#34;BlockChannel\u0026#34;, connected: -\u0026gt; # Called when the subscription is ready for use on the server disconnected: -\u0026gt; # Called when the subscription has been terminated by the server received: (data) -\u0026gt; alert(data) ä¸Šè¿°channel: 'BlockChannel'æ˜¯å¿…é¡»çš„ï¼Œå£°æ˜åƒå“ªä¸ªé¢‘é“è®¢é˜…\nå¤„ç†è®¢é˜… class BlockChannel \u0026lt; ApplicationCable::Channel def subscribed # è®¾ç½®å¯ä»¥å‘å“ªäº›è®¢é˜…è€…å‘å¸ƒä¿¡æ¯ stream_from current_user.address end def unsubscribed # Any cleanup needed when channel is unsubscribed end æµ‹è¯• åœ¨ rails console ä¸­\n# å‘ç”¨æˆ·22å‘é€ä¸€æ¡é€šçŸ¥ ActionCable.server.broadcast User.find(22).address, data: 22 å…³äº action cable çš„éƒ¨ç½² cable.yml action cable é»˜è®¤ä¸ºâ€œå¼‚æ­¥â€é€‚é…å™¨ï¼Œå½“æ¶‰åŠå¤šä¸ªè¿›ç¨‹æ—¶ï¼Œå®ƒä¸èµ·ä½œç”¨ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦é…ç½® Action Cable ä»¥ä½¿ç”¨å…¶ä»–é€‚é…å™¨ï¼Œä¾‹å¦‚ Redis æˆ– PostgreSQLã€‚\nproduction: adapter: redis url: redis://localhost:6379 staging: adapter: redis url: redis://localhost:6379 local: \u0026amp;local adapter: redis url: redis://localhost:6379 development: *local test: *local ä¸è¦å¿˜è®°å¯åŠ¨ redis\nåœ¨å’Œ rails ç›¸åŒçš„ä¸»æœºå’Œç«¯å£ä½¿ç”¨ action cable ä¸‹é¢æ˜¯ Rails æ¨èçš„é»˜è®¤è®¾ç½®ï¼Œä¹Ÿæ˜¯æœ€ç®€å•çš„è®¾ç½®.å®ƒçš„å·¥ä½œåŸç†æ˜¯å°† ActionCable.server æŒ‚è½½åˆ° config / routes.rb ä¸­çš„æŸä¸ªè·¯å¾„ã€‚è¿™æ ·ï¼Œæ‚¨çš„ Action Cable æœåŠ¡å™¨å°†åœ¨ä¸æ‚¨çš„åº”ç”¨ç¨‹åºç›¸åŒçš„ä¸»æœºå’Œç«¯å£ä¸Šè¿è¡Œï¼Œä½†åœ¨å­ URI ä¸‹è¿è¡Œã€‚\nåœ¨ router.rb æ–‡ä»¶ä¸­\nmount ActionCable.server =\u0026gt; \u0026#39;/cable\u0026#39; ä½ éœ€è¦é…ç½®ä¸€ä¸ª locationå— é…ç½® cable çš„è¯·æ±‚,åƒä¸‹é¢è¿™æ ·ï¼š\nserver { listen 80; server_name www.foo.com; root /path-to-your-app/public; passenger_enabled on; ### INSERT THIS!!! ### location /cable { passenger_force_max_concurrent_requests_per_process 0; } } ä¸ºäº†åº”ç”¨çš„æ€§èƒ½ï¼Œå¿…é¡»æ·»åŠ passenger_force_max_concurrent_requests_per_process 0çš„é…ç½®ï¼Œå…³äºè¿™ä¸ªé…ç½®çš„è¯¦è§£è¯·çœ‹ æ–‡æ¡£\næœ¬æ–‡å†…å®¹æ•´ç†è‡ª ruby-china å’Œ passenger çš„é…ç½®æ–‡æ¡£\n","date":"2018-11-18T17:24:00Z","permalink":"https://dccmmtop.github.io/posts/rails_action_cable%E4%BD%BF%E7%94%A8/","section":"posts","tags":["rails"],"title":"rails_action_cableä½¿ç”¨"},{"categories":null,"contents":"æ—¥ç§¯æœˆç´¯ï¼Œè‡ªå·±å†™çš„ vim è„šæœ¬è¶Šæ¥è¶Šå¤šï¼Œå¤§å¤§çš„æ–¹ä¾¿äº†æ—¥å¸¸ç¼–å†™ä»»åŠ¡ï¼Œä½†æ˜¯è¿™äº›è„šæœ¬æ²¡æœ‰åšæˆæ’ä»¶çš„å½¢å¼ï¼Œå¯¼è‡´æ¢ä¸€å°æ–°æœºå™¨æ—¶ï¼Œä¸æ–¹ä¾¿ä¸‹è½½ä½¿ç”¨ï¼Œä¸‹é¢å°±ä»‹ç»ä¸€ä¸‹å¦‚ä½•æŠŠ\nè‡ªå·±å†™çš„è„šæœ¬åšæˆä¸€ä¸ªæ’ä»¶ï¼Œå¯ä»¥åœ¨vimrcä¸­ä½¿ç”¨Plug xxxå®‰è£…ã€‚\nbegin æ–°å»ºæ–‡ä»¶å¤¹ï¼Œå‘½åä¸ºvim_script è¿›å…¥æ–‡ä»¶ä»·ï¼Œæ‰§è¡Œ git initåˆå§‹åŒ–ä¸€ä¸ªä»“åº“ å» github æ–°å»ºä¸€ä¸ªä»“åº“ï¼Œvim_scipt è®¾ç½®æœ¬åœ°ä»“åº“çš„ remote ä¿¡æ¯ åœ¨ vim_script ä¸‹æ–°å»º autoload æ–‡ä»¶å¤¹ï¼ŒæŠŠè‡ªå·±å†™çš„ vim è„šæœ¬æ”¾åˆ° autoload ä¸‹ åœ¨ vim_script ä¸‹æ–°å»º plugin æ–‡ä»¶å¤¹ï¼Œæ–°å»ºscript.vim(åå­—éšæ„)ï¼Œåœ¨è¯¥æ–‡ä»¶å†…è®¾ç½®è„šæœ¬æ‰§è¡Œçš„å‘½ä»¤ï¼Œæˆ–è€…è®¾ç½®æ‰§è¡Œè„šæœ¬çš„å¿«æ·é”® å¦‚å›¾ï¼š\n","date":"2018-10-28T15:48:33Z","permalink":"https://dccmmtop.github.io/posts/vim%E8%84%9A%E6%9C%AC%E6%8F%92%E4%BB%B6%E5%8C%96/","section":"posts","tags":["vim"],"title":"vimè„šæœ¬æ’ä»¶åŒ–"},{"categories":null,"contents":"æœ¬æ–‡ç« ä¸ºè½¬è½½å†…å®¹ï¼Œç‚¹å‡»æŸ¥çœ‹åŸæ–‡ç« https://zhuanlan.zhihu.com/p/27389503\nä½¿ç”¨è„šæœ¬è¯­è¨€ï¼Œå¯ä»¥æ›´çµæ´»åœ°å®šåˆ¶ç¼–è¾‘å™¨ä»¥å®Œæˆå¤æ‚çš„ä»»åŠ¡ã€‚\nè‡ªå®šä¹‰å‘½ä»¤ Vim ç¼–è¾‘å™¨å…è®¸å®šä¹‰è‡ªå·±çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥åƒæ‰§è¡Œå†…ç½®å‘½ä»¤ä¸€æ ·æ¥æ‰§è¡Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å‘½ä»¤ã€‚\nä½¿ç”¨ä»¥ä¸‹:command å‘½ä»¤è‡ªå®šä¹‰å‘½ä»¤ï¼š\n:command Delete_first :1delete æ³¨æ„è‡ªå®šä¹‰å‘½ä»¤çš„åç§°ï¼Œå¿…é¡»ä»¥å¤§å†™å­—æ¯å¼€å¤´ï¼Œè€Œä¸”ä¸èƒ½åŒ…å«ä¸‹åˆ’çº¿ï¼›å¦‚æœæˆ‘ä»¬æ‰§è¡Œ:Delete_first è‡ªå®šä¹‰å‘½ä»¤ï¼Œé‚£ä¹ˆ Vim å°±ä¼šæ‰§è¡Œ:1delete å‘½ä»¤ï¼Œä»è€Œåˆ é™¤ç¬¬ä¸€è¡Œã€‚\nå¯ä»¥ä½¿ç”¨!æ¥å¼ºåˆ¶é‡æ–°å®šä¹‰åŒåçš„è‡ªå®šä¹‰å‘½ä»¤ï¼š\n:command! -nargs=+ Say :echo \u0026lt;args\u0026gt; ç”¨æˆ·å®šä¹‰çš„å‘½ä»¤å¯ä»¥æŒ‡å®šä¸€ç³»åˆ—çš„å‚æ•°ï¼Œå‚æ•°çš„ä¸ªæ•°ç”±-nargs é€‰é¡¹åœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šã€‚ä¾‹å¦‚å®šä¹‰ Delete_one å‘½ä»¤æ²¡æœ‰å‚æ•°ï¼š\n:command Delete_one -nargs=0 1delete é»˜è®¤æƒ…å†µä¸‹-nargs=0ï¼Œæ‰€ä»¥å¯ä»¥çœç•¥ã€‚å…¶ä»–-nargs é€‰é¡¹å€¼å¦‚ä¸‹ï¼š\n-nargs=0 æ²¡æœ‰å‚æ•°\n-nargs=1 1 ä¸ªå‚æ•°\n-nargs=* ä»»ä½•ä¸ªæ•°çš„å‚æ•°\n-nargs=? é›¶ä¸ªæˆ–æ˜¯ä¸€ä¸ªå‚æ•°\n-nargs=+ ä¸€ä¸ªæˆ–æ˜¯æ›´å¤šä¸ªå‚æ•°\nåœ¨å‘½ä»¤å®šä¹‰ä¸­ï¼Œå‚æ•°æ˜¯ç”±å…³é”®å­—æŒ‡å®šçš„ï¼š\n:command -nargs=+ Say :echo \u0026#34;\u0026lt;args\u0026gt;\u0026#34; è¾“å…¥ä»¥ä¸‹è‡ªå®šä¹‰å‘½ä»¤ï¼š\n:Say Hello World å‘½ä»¤çš„æ‰§è¡Œç»“æœæ˜¾ç¤ºï¼š\nHello World ä½¿ç”¨-range é€‰é¡¹ï¼Œå¯ä»¥æŒ‡å®šä¸€ä¸ªèŒƒå›´ä½œä¸ºè‡ªå®šä¹‰å‘½ä»¤çš„å‚æ•°ã€‚-range é€‰é¡¹å€¼å¦‚ä¸‹ï¼š\n-range å…è®¸èŒƒå›´ï¼Œé»˜è®¤ä¸ºå½“å‰è¡Œ\n-range=%å…è®¸èŒƒå›´ï¼Œé»˜è®¤ä¸ºå½“å‰æ–‡ä»¶(while file)\n-range=count å…è®¸èŒƒå›´ï¼Œå•ä¸€çš„æ•°å­—\nå½“æŒ‡å®šèŒƒå›´ä¹‹åï¼Œå°±å¯ä»¥ç”¨å…³é”®å­—å’Œå¾—åˆ°è¿™ä¸ªèŒƒå›´çš„ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œã€‚\nä¾‹å¦‚ä»¥ä¸‹å®šä¹‰äº† SaveIt å‘½ä»¤ï¼Œç”¨äºå°†æŒ‡å®šèŒƒå›´çš„æ–‡ä»¶å†™å…¥æ–‡ä»¶ save_fileï¼š\n:command -range=% SaveIt :\u0026lt;line1\u0026gt;,\u0026lt;line2\u0026gt;write! save_file å…³é”®å­—å«æœ‰ä¸å…³é”®å­—ç›¸åŒçš„ä¿¡æ¯ï¼Œæ‰€ä¸åŒçš„æ˜¯å®ƒç”¨äºè°ƒç”¨å‡½æ•°ã€‚ä¾‹å¦‚ä»¥ä¸‹è‡ªå®šä¹‰å‘½ä»¤ï¼š\n:command -nargs=* DoIt :call AFunction(\u0026lt;f-args\u0026gt;) æ‰§è¡Œè‡ªå®šä¹‰å‘½ä»¤ï¼š\n:DoIt a b c å°†ä¼šä¼ é€’å‚æ•°ç»™è°ƒç”¨çš„å‡½æ•°ï¼š\n:call AFunction(\u0026#34;a\u0026#34;,\u0026#34;b\u0026#34;,\u0026#34;c\u0026#34;) å…¶ä»–é€‰é¡¹å’Œå…³é”®å­—åŒ…æ‹¬ï¼š\n-count=number æŒ‡å®šæ•°é‡ä¿å­˜åœ¨å…³é”®å­—ä¸­\n-bang æŒ‡å®š!ä¿®é¥°ç¬¦å­˜æ”¾åœ¨å…³é”®å­—ä¸­\n-register æŒ‡å®šå¯„å­˜å™¨ï¼Œé»˜è®¤ä¸ºæœªå‘½åå¯„å­˜å™¨ï¼Œå¯„å­˜å™¨çš„å®šä¹‰ä¿å­˜åœ¨å…³é”®å­—ä¸­\n-bar å…¶ä»–å‘½ä»¤å¯ä»¥ç”¨|è·Ÿéšåœ¨æ­¤å‘½ä»¤ä¹‹å\n-buffer å‘½ä»¤ä»…å¯¹å½“å‰ç¼“å†²åŒºæœ‰æ•ˆ\nä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œé¦–å…ˆåˆ†åˆ«åˆ›å»ºä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰å‘½ä»¤ï¼Œç„¶åå†å°†ä¸¤ä¸ªå‘½ä»¤ç»„åˆèµ·æ¥ã€‚\ncommand! -bar DelTab %s/\t// command! DelLF %s/\\n// command! FmtCode DelTab|DelLF view raw\nScriptCommandMulti.vim\nhosted with â¤ by\nGitHub\nåˆ—ç¤ºè‡ªå®šä¹‰å‘½ä»¤ ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œå¯ä»¥åˆ—å‡ºç”¨æˆ·å®šä¹‰çš„å‘½ä»¤ï¼š\n:command åˆ é™¤è‡ªå®šä¹‰å‘½ä»¤ ä½¿ç”¨ä»¥ä¸‹:delcommand å‘½ä»¤ï¼Œå¯ä»¥åˆ é™¤ç”¨æˆ·å®šä¹‰çš„å‘½ä»¤ï¼š\n:delcommand Delete_one ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œæ¸…é™¤æ‰€æœ‰çš„ç”¨æˆ·å®šä¹‰çš„å‘½ä»¤ï¼š\n:comclear ","date":"2018-10-23T14:29:42Z","permalink":"https://dccmmtop.github.io/posts/vim%E8%87%AA%E5%AE%9A%E4%B9%89%E5%91%BD%E4%BB%A4/","section":"posts","tags":["vim"],"title":"vimè‡ªå®šä¹‰å‘½ä»¤"},{"categories":null,"contents":"éœ€æ±‚ ç»™ä¸€æ®µæ–‡å­—è‡ªåŠ¨æ·»åŠ åºå·ï¼Œè¦æ±‚æœ¬è¡Œçš„åºå·å¯ä»¥æ ¹æ®ä¸Šä¸€è¡Œçš„åºå·è‡ªåŠ¨å¢ä¸€ï¼Œè‹¥ä¸Šä¸€è¡Œæ²¡æœ‰åºå·ï¼Œåˆ™ä» 1 å¼€å§‹\nå®ç° ç”¨ ruby ç¼–å†™ vim è„šæœ¬éå¸¸å®¹æ˜“å®ç°\n\u0026#34; æ¯è¡Œçš„å‰é¢æ·»åŠ åºå·ï¼Œæ ¹æ®ä¸Šä¸€è¡Œåºå·è‡ªåŠ¨é€’å¢ï¼Œè‹¥ä¸Šä¸€è¡Œæ²¡æœ‰åºå·ï¼Œåˆ™ä»1å¼€å§‹ function! num#add_num() ruby \u0026lt;\u0026lt; EOF def get_current_line() count = 0 \u0026#34; å¾—åˆ°å½“å‰ç¼“å†²åŒº cb = Vim::Buffer.current \u0026#34; å¾—åˆ°ä¸Šä¸€è¡Œçš„è¡Œå· previousLine = cb.line_number - 1 \u0026#34; å¦‚æœè¡Œå·å­˜åœ¨ï¼Œå¹¶ä¸”ä»¥æ•°å­—å¼€å¤´ if previousLine \u0026gt;= 1 \u0026amp;\u0026amp; cb[previousLine] =~ /^\\d+/ \u0026#34; å¾—åˆ°ä¸Šä¸€è¡Œçš„åºå· count = $\u0026amp;.to_i end \u0026#34; ä¿®æ”¹æœ¬è¡Œå†…å®¹ cb.line = \u0026#34;#{count + 1}. #{line}\u0026#34; end get_current_line() EOF endfunction æ·»åŠ è‡ªå®šä¹‰å‘½ä»¤ åœ¨.vimrcä¸­ï¼Œæ·»åŠ å¦‚ä¸‹ä¸€è¡Œ\ncommand! -range=% AddNum :\u0026lt;line1\u0026gt;,\u0026lt;line2\u0026gt; cal num#add_num()\nå…³äºè‡ªå®šä¹‰å‘½ä»¤è¯·æŸ¥çœ‹è¿™ç¯‡æ–‡ç« ï¼švim æ·»åŠ è‡ªå®šä¹‰å‘½ä»¤\næ¼”ç¤º ","date":"2018-10-23T12:58:16Z","permalink":"https://dccmmtop.github.io/posts/%E8%87%AA%E5%8A%A8%E6%B7%BB%E5%8A%A0%E5%BA%8F%E5%8F%B7/","section":"posts","tags":["vim"],"title":"è‡ªåŠ¨æ·»åŠ åºå·"},{"categories":null,"contents":"ruby ä¸­æœ‰ä¸ª range å¯¹è±¡ï¼Œå¯ä»¥è‡ªåŠ¨æ¨æµ‹èŒƒå›´å†…çš„æ•°æ®ï¼Œæ¯”å¦‚ï¼š\n(1..100).each do |i| puts i end ä¼šè¾“å‡º 1 åˆ° 100 å†…çš„æ‰€æœ‰æ•°å­—\nè‡ªå®šä¹‰ å¦‚æœæˆ‘ä»¬æœ‰ä¸€ä¸ªè‡ªå®šä¹‰çš„å¯¹è±¡ï¼Œå‡å¦‚åå­—ä¸ºYm\nclass Ym attr_accessor :year, :month def initialize @year, @month = year, month end end è‹¥æ˜¯æƒ³åœ¨Ymä¸Šä½¿ç”¨((Ym.new(2009,1))..(Ym.new(2010,1))).each {|i| puts i},è¾“å‡ºçš„ç»“æœæŒ‰ç…§æ­£å¸¸çš„å¹´æœˆé€»è¾‘æ¥æ˜¾ç¤ºï¼Œè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ\nå…¶å®è¦å®ç°ç±»ä¼¼(1..100)çš„æ–¹æ³•å¾ˆå®¹æ˜“ï¼Œåªéœ€åœ¨è¯¥ç±»ä¸­include Compareableç„¶åå®ç° succå’Œ\u0026lt;=\u0026gt;æ–¹æ³•å°±è¡Œäº†ã€‚\nclass Ym include Comparable attr_accessor :year, :month def initialize(year, month) @year, @month = year, month end def succ #å¦‚æœæœˆä»½æ»¡12ï¼Œåˆ™å¹´ä»½å¢åŠ ä¸€ï¼Œæœˆä»½å†ä»ä¸€å¼€å§‹ã€‚ # å¯ä»¥æŒ‰éœ€æ±‚å®šåˆ¶æ›´å¤æ‚çš„æ¨æµ‹æ–¹æ³• yyy, mmm = @month == 12 ? [@year + 1, 1] : [@year, @month + 1] Ym.new(yyy, mmm) end def \u0026lt;=\u0026gt;(other) # å®šä¹‰å¤§å°è§„åˆ™ (@year * 12 + @month) \u0026lt;=\u0026gt; (other.year * 12 + other.month) end def to_s sprintf \u0026#34;%4d-%02d\u0026#34;, @year, @month end end (Ym.new(2008,8)..(Ym.new(2019,9))).each do |y| puts y end ç»“æœå¦‚å›¾:\n","date":"2018-09-27T09:10:50Z","permalink":"https://dccmmtop.github.io/posts/%E8%87%AA%E5%AE%9A%E4%B9%89range%E5%AF%B9%E8%B1%A1/","section":"posts","tags":["ruby"],"title":"è‡ªå®šä¹‰rangeå¯¹è±¡"},{"categories":null,"contents":"é¦–å…ˆï¼Œåœ¨å“ªäº›æƒ…å†µä¸‹ä¼šç”¨åˆ°æ­£åˆ™è¡¨è¾¾å¼ï¼Ÿ\nä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„å‘½ä»¤æœ€å¸¸è§çš„å°±æ˜¯ / å’Œ ? å‘½ä»¤ã€‚å…¶æ ¼å¼å¦‚ä¸‹ï¼š\n/æ­£åˆ™è¡¨è¾¾å¼\r?æ­£åˆ™è¡¨è¾¾å¼ å¦ä¸€ä¸ªå¾ˆæœ‰ç”¨çš„å‘½ä»¤å°±æ˜¯ :sï¼ˆæ›¿æ¢ï¼‰å‘½ä»¤ï¼Œå°†ç¬¬ä¸€ä¸ª//ä¹‹é—´çš„æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢æˆç¬¬äºŒä¸ª//ä¹‹é—´çš„å­—ç¬¦ä¸²ã€‚\n:s/æ­£åˆ™è¡¨è¾¾å¼/æ›¿æ¢å­—ç¬¦ä¸²/é€‰é¡¹ åœ¨å­¦ä¹ æ­£åˆ™è¡¨è¾¾å¼æ—¶å¯ä»¥åˆ©ç”¨ / å‘½ä»¤æ¥ç»ƒä¹ ã€‚\nå…ƒå­—ç¬¦ å…ƒå­—ç¬¦ è¯´æ˜ . åŒ¹é…ä»»æ„å­—ç¬¦ [abc] åŒ¹é…æ–¹æ‹¬å·ä¸­çš„ä»»æ„ä¸€ä¸ªå­—ç¬¦ã€‚å¯ä»¥ä½¿ç”¨ - è¡¨ç¤ºå­—ç¬¦èŒƒå›´ï¼Œå¦‚[a-z0-9]åŒ¹ é…å°å†™å­—æ¯å’Œé˜¿æ‹‰ä¼¯æ•°å­—ã€‚ \\d åŒ¹é…é˜¿æ‹‰ä¼¯æ•°å­—ï¼Œç­‰åŒäº[0-9]ã€‚ [^abc] åœ¨æ–¹æ‹¬å·å†…å¼€å¤´ä½¿ç”¨^ç¬¦å·ï¼Œè¡¨ç¤ºåŒ¹é…é™¤æ–¹æ‹¬å·ä¸­å­—ç¬¦ä¹‹å¤–çš„ä»»æ„å­—ç¬¦ã€‚ \\d åŒ¹é…é˜¿æ‹‰ä¼¯æ•°å­—ï¼Œç­‰åŒäº[0-9]ã€‚ \\D åŒ¹é…é˜¿æ‹‰ä¼¯æ•°å­—ä¹‹å¤–çš„ä»»æ„å­—ç¬¦ï¼Œç­‰åŒäº[^0-9]ã€‚ \\x åŒ¹é…åå…­è¿›åˆ¶æ•°å­—ï¼Œç­‰åŒäº[0-9A-Fa-f]ã€‚ \\X åŒ¹é…åå…­è¿›åˆ¶æ•°å­—ä¹‹å¤–çš„ä»»æ„å­—ç¬¦ï¼Œç­‰åŒäº[^0-9a-fa-f]ã€‚ \\w åŒ¹é…å•è¯å­—æ¯ï¼Œç­‰åŒäº[0-9A-Za-z_]ã€‚ \\W åŒ¹é…å•è¯å­—æ¯ä¹‹å¤–çš„ä»»æ„å­—ç¬¦ï¼Œç­‰åŒäº[^0-9a-za-z_]ã€‚ \\t åŒ¹é…å­—ç¬¦ã€‚ \\s åŒ¹é…ç©ºç™½å­—ç¬¦ï¼Œç­‰åŒäº[ \\t]ã€‚ \\S åŒ¹é…éç©ºç™½å­—ç¬¦ï¼Œç­‰åŒäº[^ \\t]ã€‚ å¦‚æœéœ€è¦æŸ¥æ‰¾ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œå¦‚ *ã€.ã€/ ç­‰ï¼Œå¯ä»¥åœ¨è¿™äº›å­—ç¬¦å‰é¢æ·»åŠ  \\ï¼Œè¡¨ç¤ºè¿™äº›ä¸æ˜¯å…ƒå­—ç¬¦ï¼Œè€Œæ˜¯æ™®é€šå­—ç¬¦ã€‚æ¯”å¦‚ï¼š\\/d åŒ¹é…çš„æ˜¯ /dè¿™ä¸¤ä¸ªå­—ç¬¦ï¼Œè€Œä¸æ˜¯åŒ¹é…ä»»æ„æ•°å­—ã€‚\nè¡¨ç¤ºæ•°é‡çš„å…ƒå­—ç¬¦\nå…ƒå­—ç¬¦ è¯´æ˜ * åŒ¹é… 0-ä»»æ„ä¸ª \\+ åŒ¹é… 1-ä»»æ„ä¸ª \\? åŒ¹é… 0-1 ä¸ª \\{n,m} åŒ¹é… n-m ä¸ª \\{n} åŒ¹é… n ä¸ª \\{n,} åŒ¹é… n-ä»»æ„ä¸ª \\{,m} åŒ¹é… 0-m ä¸ª è¡¨ç¤ºä½ç½®çš„ç¬¦å·\nå…ƒå­—ç¬¦ è¯´æ˜ $ åŒ¹é…è¡Œå°¾ ^ åŒ¹é…è¡Œé¦– \\\u0026lt; åŒ¹é…å•è¯è¯é¦– \\\u0026gt; åŒ¹é…å•è¯è¯å°¾ ä½¿ç”¨ç¤ºä¾‹\nå‘½ä»¤ æè¿° /char\\s\\+[A-Za-z_]\\w*; æŸ¥æ‰¾æ‰€æœ‰ä»¥ char å¼€å¤´ï¼Œä¹‹åæ˜¯ä¸€ä¸ªä»¥ä¸Šçš„ç©ºç™½ï¼Œæœ€åæ˜¯ä¸€ä¸ªæ ‡è¯†ç¬¦å’Œåˆ†å· /\\d\\d:\\d\\d:\\d\\d æŸ¥æ‰¾å¦‚ 17:37:01 æ ¼å¼çš„æ—¶é—´å­—ç¬¦ :g/^\\s*$/d åˆ é™¤åªæœ‰ç©ºç™½çš„è¡Œ :s/\\\u0026lt;four\\\u0026gt;/4/g å°†æ‰€æœ‰çš„ four æ›¿æ¢æˆ 4ï¼Œä½†æ˜¯ fourteen ä¸­çš„ four ä¸æ›¿æ¢ æ›¿æ¢å˜é‡ åœ¨æ­£è§„è¡¨è¾¾å¼ä¸­ä½¿ç”¨ \\( å’Œ \\) ç¬¦å·æ‹¬èµ·æ­£è§„è¡¨è¾¾å¼ï¼Œå³å¯åœ¨åé¢ä½¿ç”¨\\1ã€\\2 ç­‰å˜é‡æ¥è®¿é—® \\(å’Œ \\) ä¸­çš„å†…å®¹ã€‚\nä½¿ç”¨ç¤ºä¾‹\nå‘½ä»¤ æè¿° /\\(a\\+\\)[^a]\\+\\1 æŸ¥æ‰¾å¼€å¤´å’Œç»“å°¾å¤„ a çš„ä¸ªæ•°ç›¸åŒçš„å­—ç¬¦ä¸²ï¼Œå¦‚ aabbbaaï¼Œaaacccaaaï¼Œä½†æ˜¯ä¸åŒ¹é… abbbaa :s/\\(http:\\/\\/[-a-z\\._~\\+%\\/]\\+\\)/\u0026lt;a href=\u0026quot;\\1\u0026quot;\u0026gt;\\1\u0026lt;\\/a\u0026gt;/ å°† url æ›¿æ¢ä¸ºhttp://urlçš„æ ¼å¼ :s/\\(\\w\\+\\)\\s\\+\\(\\w\\+\\)/\\2\\t\\1 å°† data1 data2 ä¿®æ”¹ä¸º data2 data1 å‡½æ•°å¼ åœ¨æ›¿æ¢å‘½ä»¤ :s/{pattern}/{string}/[flags] ä¸­å¯ä»¥ä½¿ç”¨å‡½æ•°è¡¨è¾¾å¼æ¥ä¹¦å†™æ›¿æ¢å†…å®¹ï¼Œæ ¼å¼ä¸º\n:s/æ›¿æ¢å­—ç¬¦ä¸²/\\=å‡½æ•°å¼ åœ¨å‡½æ•°å¼ä¸­å¯ä»¥ä½¿ç”¨ submatch(1)ã€submatch(2) ç­‰æ¥å¼•ç”¨ \\1ã€\\2 ç­‰çš„å†…å®¹ï¼Œè€Œsubmatch(0)å¯ä»¥å¼•ç”¨åŒ¹é…çš„æ•´ä¸ªå†…å®¹ã€‚\nä½¿ç”¨ä¾‹\n:%s/\\\u0026lt;id\\\u0026gt;/\\=line(\u0026#34;.\u0026#34;) å°†å„è¡Œçš„ id å­—ç¬¦ä¸²æ›¿æ¢ä¸ºè¡Œå·\n:%s/^\\\u0026lt;\\w\\+\\\u0026gt;/\\=(line(\u0026#34;.\u0026#34;)-10) .\u0026#34;.\u0026#34;. submatch(1) å°†æ¯è¡Œå¼€å¤´çš„å•è¯æ›¿æ¢ä¸º (è¡Œå·-10).å•è¯ çš„æ ¼å¼ï¼Œå¦‚ç¬¬ 11 è¡Œçš„ word æ›¿æ¢æˆ 1. word\nä¸ Perl æ­£åˆ™è¡¨è¾¾å¼çš„åŒºåˆ« Vim è¯­æ³• Perl è¯­æ³• å«ä¹‰ \\+ + 1-ä»»æ„ä¸ª \\? ? 0-1 ä¸ª \\{n,m} {n,m} n-m ä¸ª \\( å’Œ \\) ( å’Œ ) åˆ†ç»„ è´ªå©ªæ¨¡å¼å’Œéè´ªå©ªæ¨¡å¼ åœ¨ Vim é‡Œï¼Œé»˜è®¤æ˜¯è´ªå©ªæ¨¡å¼ï¼Œå³ a.*b ä¼šå°½å¯èƒ½å¤šæ»´åŒ¹é…å­—ç¬¦ï¼Œåœ¨ ahdbjkbkls ä¸­åŒ¹é… ahdbjkb è€Œä¸æ˜¯ ahdbã€‚\nå¦‚æœæ˜¯éè´ªå©ªçš„ï¼Œå¯ä»¥ä½¿ç”¨ \\{-} ä»£æ›¿ *ï¼Œå³ a.\\{-}b åŒ¹é… ahdb è€Œä¸æ˜¯ ahdbjkbã€‚\nä½œè€…ï¼šSpaceVim é“¾æ¥ï¼šhttps://www.jianshu.com/p/03770041397c ä¾†æºï¼šç®€ä¹¦ ç®€ä¹¦è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒå¹¶æ³¨æ˜å‡ºå¤„ã€‚ ","date":"2018-09-21T14:28:51Z","permalink":"https://dccmmtop.github.io/posts/vim%E4%B8%AD%E7%9A%84%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/","section":"posts","tags":["vim"],"title":"vimä¸­çš„æ­£åˆ™è¡¨è¾¾å¼"},{"categories":null,"contents":"ä»€ä¹ˆæ˜¯è·¨åŸŸ ç†è§£è·¨åŸŸé¦–å…ˆå¿…é¡»è¦äº†è§£åŒæºç­–ç•¥ã€‚åŒæºç­–ç•¥æ˜¯æµè§ˆå™¨ä¸Šä¸ºå®‰å…¨æ€§è€ƒè™‘å®æ–½çš„éå¸¸é‡è¦çš„å®‰å…¨ç­–ç•¥ã€‚\né‚£ä¹ˆä»€ä¹ˆæ˜¯åŒæºï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼ŒURL ç”±åè®®ã€åŸŸåã€ç«¯å£å’Œè·¯å¾„ç»„æˆï¼Œå¦‚æœä¸¤ä¸ª URL çš„åè®®ã€åŸŸåå’Œç«¯å£ç›¸åŒï¼Œåˆ™è¡¨ç¤ºä»–ä»¬åŒæºã€‚\næˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜ï¼š\nURL: http://www.example.com:8080/script/jquery.js\nåœ¨è¿™ä¸ª url ä¸­ï¼Œå„ä¸ªå­—æ®µåˆ†åˆ«ä»£è¡¨çš„å«ä¹‰ï¼š\nhttp://â€”â€”åè®®\nwwwâ€”â€”å­åŸŸå\nexample.comâ€”â€”ä¸»åŸŸå\n8080â€”â€”ç«¯å£å·\nscript/jquery.jsâ€”â€”è¯·æ±‚çš„åœ°å€\nå½“åè®®ã€å­åŸŸåã€ä¸»åŸŸåã€ç«¯å£å·ä¸­ä»»æ„ä¸€å„ä¸ç›¸åŒæ—¶ï¼Œéƒ½ç®—ä¸åŒçš„â€œåŸŸâ€ã€‚ä¸åŒçš„åŸŸä¹‹é—´ç›¸äº’è¯·æ±‚èµ„æºï¼Œå°±å«è·¨åŸŸã€‚\nè¿™é‡Œè¦æ³¨æ„ï¼Œå¦‚æœåªæ˜¯é€šè¿‡ AJAX å‘å¦ä¸€ä¸ªæœåŠ¡å™¨å‘é€è¯·æ±‚è€Œä¸è¦æ±‚æ•°æ®è¿”å›ï¼Œæ˜¯ä¸å—è·¨åŸŸé™åˆ¶çš„ã€‚æµè§ˆå™¨åªæ˜¯é™åˆ¶ä¸èƒ½è®¿é—®å¦ä¸€ä¸ªåŸŸçš„æ•°æ®ï¼Œå³ä¸èƒ½è®¿é—®è¿”å›çš„æ•°æ®ï¼Œå¹¶ä¸é™åˆ¶å‘é€è¯·æ±‚ã€‚\näº‹å®ä¸Šï¼Œä¸ºäº†è§£å†³å› åŒæºç­–ç•¥è€Œå¯¼è‡´çš„è·¨åŸŸè¯·æ±‚é—®é¢˜ï¼Œè§£å†³æ–¹æ³•æœ‰äº”ç§ï¼š\ndocument.domain Cross-Origin Resource Sharing(CORS) Cross-document messaging JSONP WebSockets ä»€ä¹ˆæ˜¯ CORS(è·¨åŸŸèµ„æºå…±äº«ï¼ŒCross-Origin Resource Sharing)ï¼Ÿ æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ wiki ä¸Šçš„å®šä¹‰ï¼š\nè·¨æ¥æºèµ„æºå…±äº«ï¼ˆCORSï¼‰æ˜¯ä¸€ä»½æµè§ˆå™¨æŠ€æœ¯çš„è§„èŒƒï¼Œæä¾›äº† Web æœåŠ¡ä»ä¸åŒç½‘åŸŸä¼ æ¥æ²™ç›’è„šæœ¬çš„æ–¹æ³•ï¼Œä»¥é¿å¼€æµè§ˆå™¨çš„åŒæºç­–ç•¥ï¼Œæ˜¯ JSONP æ¨¡å¼çš„ç°ä»£ç‰ˆã€‚ä¸ JSONP ä¸åŒï¼ŒCORS é™¤äº† GET è¦æ±‚æ–¹æ³•ä»¥å¤–ä¹Ÿæ”¯æŒå…¶ä»–çš„ HTTP è¦æ±‚ã€‚ç”¨ CORS å¯ä»¥è®©ç½‘é¡µè®¾è®¡å¸ˆç”¨ä¸€èˆ¬çš„ XMLHttpRequestï¼Œè¿™ç§æ–¹å¼çš„é”™è¯¯å¤„ç†æ¯” JSONP è¦æ¥çš„å¥½ã€‚å¦ä¸€æ–¹é¢ï¼ŒJSONP å¯ä»¥åœ¨ä¸æ”¯æŒ CORS çš„è€æ—§æµè§ˆå™¨ä¸Šè¿ä½œã€‚ç°ä»£çš„æµè§ˆå™¨éƒ½æ”¯æŒ CORSã€‚\nç”±æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œ CORS å®šä¹‰ä¸€ç§è·¨åŸŸè®¿é—®çš„æœºåˆ¶ï¼Œå¯ä»¥è®© AJAX å®ç°è·¨åŸŸè®¿é—®ã€‚CORS å…è®¸ä¸€ä¸ªåŸŸä¸Šçš„ç½‘ç»œåº”ç”¨å‘å¦ä¸€ä¸ªåŸŸæäº¤è·¨åŸŸ AJAX è¯·æ±‚ã€‚å¯¹äº CORS æ¥è¯´ï¼Œå®ç°æ­¤åŠŸèƒ½éå¸¸ç®€å•ï¼Œåªéœ€ç”±æœåŠ¡å™¨å‘é€ä¸€ä¸ªå“åº”æ ‡å¤´å³å¯ã€‚æœåŠ¡å™¨ç«¯å¯¹äº CORS çš„æ”¯æŒï¼Œä¸»è¦å°±æ˜¯é€šè¿‡è®¾ç½® Access-Control-Allow-Origin æ¥è¿›è¡Œçš„ã€‚å…·ä½“çš„å…³äº CORS åŸç†æ€§çš„çŸ¥è¯†æ­¤å¤„ä¸å†è¿›è¡Œä»‹ç»ï¼Œåªåœ¨æ­¤å¯¹ CORS å’Œ JSONP è¿›è¡Œç®€å•çš„æ¯”è¾ƒ.\nCORS ä¸ JSONP æ¯”è¾ƒ\nCORS ä¸ JSONP ç›¸æ¯”ï¼Œæ›´ä¸ºå…ˆè¿›ã€æ–¹ä¾¿å’Œå¯é ã€‚\nJSONP åªèƒ½å®ç° GET è¯·æ±‚ï¼Œè€Œ CORS æ”¯æŒæ‰€æœ‰ç±»å‹çš„ HTTP è¯·æ±‚ã€‚ ä½¿ç”¨ CORSï¼Œå¼€å‘è€…å¯ä»¥ä½¿ç”¨æ™®é€šçš„ XMLHttpRequest å‘èµ·è¯·æ±‚å’Œè·å¾—æ•°æ®ï¼Œæ¯”èµ· JSONP æœ‰æ›´å¥½çš„é”™è¯¯å¤„ç†ã€‚ JSONP ä¸»è¦è¢«è€çš„æµè§ˆå™¨æ”¯æŒï¼Œå®ƒä»¬å¾€å¾€ä¸æ”¯æŒ CORSï¼Œè€Œç»å¤§å¤šæ•°ç°ä»£æµè§ˆå™¨éƒ½å·²ç»æ”¯æŒäº† CORSã€‚ rack-cors æ€æ ·è§£å†³è·¨åŸŸé—®é¢˜ï¼Ÿ Rack Middleware for handling Cross-Origin Resource Sharing (CORS), which makes cross-origin AJAX possible.\nä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ª gem æ˜¯åŸºäº CORS æ¥å®ç° Ajax çš„è·¨åŸŸè¯·æ±‚åŠŸèƒ½çš„ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ è¿™ä¸ª gem æ¥è§£å†³æˆ‘ä»¬é¡¹ç›®ä¸­é‡åˆ°çš„é—®é¢˜ã€‚\næˆ‘ä»¬çœ‹åˆ° gem ä¸­ç»™å‡ºçš„é…ç½®æ¥å£ï¼š\nRack\nIn config.ru, configure Rack::Cors by passing a block to the use command:\nuse Rack::Cors do allow do origins \u0026#39;localhost:3000\u0026#39;, \u0026#39;127.0.0.1:3000\u0026#39;, /\\Ahttp:\\/\\/192\\.168\\.0\\.\\d{1,3}(:\\d+)?\\z/ # regular expressions can be used here resource \u0026#39;/file/list_all/\u0026#39;, :headers =\u0026gt; \u0026#39;x-domain-token\u0026#39; resource \u0026#39;/file/at/_\u0026#39;, :methods =\u0026gt; [:get, :post, :delete, :put, :patch, :options, :head], :headers =\u0026gt; \u0026#39;x-domain-token\u0026#39;, :expose =\u0026gt; [\u0026#39;Some-Custom-Response-Header\u0026#39;], :max_age =\u0026gt; 600 # headers to expose end allow do origins \u0026#39;_\u0026#39; resource \u0026#39;/public/\\*\u0026#39;, :headers =\u0026gt; :any, :methods =\u0026gt; :get end end Rails\nPut something like the code below in config/application.rb of your Rails application. For example, this will allow GET, POST or OPTIONS requests from any origin on any resource.\nmodule YourApp class Application \u0026lt; Rails::Application # ... # Rails 3/4 config.middleware.insert_before 0, \u0026#34;Rack::Cors\u0026#34; do allow do origins \u0026#39;_\u0026#39; resource \u0026#39;_\u0026#39;, :headers =\u0026gt; :any, :methods =\u0026gt; [:get, :post, :options] end end # Rails 5 config.middleware.insert_before 0, Rack::Cors do allow do origins \u0026#39;_\u0026#39; resource \u0026#39;_\u0026#39;, :headers =\u0026gt; :any, :methods =\u0026gt; [:get, :post, :options] end end end end å¯ä»¥çœ‹å‡ºï¼Œrack-cors å®é™…ä¸Šç›´æ¥ç»™å‡ºäº†å€Ÿå£ï¼Œæˆ‘ä»¬åœ¨ bundle è¿™ä¸ª gem åï¼Œç›´æ¥åœ¨ config/application.rb æ–‡ä»¶ä¸­æ·»åŠ é…ç½®ä¿¡æ¯å³å¯ï¼Œè€Œæ— éœ€è‡ªå·±åœ¨ä»£ç ä¸­æ·»åŠ æœ‰å…³è·¨åŸŸèµ„æºçš„ç­–ç•¥ä¿¡æ¯ã€‚\nå®é™…åº”ç”¨ è¿™ä¸ª gem æ˜¯ç”¨åœ¨è¢«è®¿é—®çš„èµ„æºæœåŠ¡å™¨ä¸Šçš„ï¼Œç”¨æ¥å®šä¹‰å“ªäº›åŸŸå¯ä»¥è®¿é—®èµ„æºä»¥åŠå¯ä»¥è®¿é—®è‡ªå·±çš„å“ªäº›èµ„æºç­‰ç­–ç•¥ä¿¡æ¯ã€‚è¿™ä¸ª gem å¯ä»¥å¾ˆè½»æ¾å¾ˆæ–¹ä¾¿åœ°è§£å†³ ajax è·¨åŸŸé—®é¢˜ã€‚\nå®‰è£… gem\ngem 'rack-cors', :require =\u0026gt; 'rack/cors'\nä¿®æ”¹ config/application.rb\næˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ railsï¼Œå› æ­¤åªéœ€è¦åšä»¥ä¸‹ä¿®æ”¹å³å¯ï¼š config.middleware.insert*before 0, Rack::Cors do allow do origins \u0026#39;*\u0026#39; resource \u0026#39;\\_\u0026#39;, :headers =\u0026gt; :any, :methods =\u0026gt; [:get, :post, :options] end end å…¶ä¸­ï¼Œorigins ç”¨æ¥é…ç½®å¯ä»¥è¯·æ±‚è‡ªå·±èµ„æºçš„åŸŸï¼Œ*è¡¨ç¤ºä»»ä½•åŸŸéƒ½å¯ä»¥è¯·æ±‚ï¼›resource ç”¨æ¥é…ç½®è‡ªå·±çš„å“ªäº›èµ„æºå¯ä»¥è¢«è¯·æ±‚ï¼Œ*ä»£è¡¨æ‰€æœ‰èµ„æºéƒ½å¯ä»¥è¢«è¯·æ±‚ï¼Œmethods ä»£è¡¨å¯ä»¥è¢«è¯·æ±‚çš„æ–¹æ³•ã€‚\nåšå®Œè¿™ä¸¤éƒ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°è·¨åŸŸè¯·æ±‚èµ„æºäº†ã€‚æ­¤æ—¶é‡å¯æœåŠ¡å™¨ï¼Œæœ¬åœ°å†æ¬¡è¯·æ±‚èµ„æºå°±ä¼šæˆåŠŸï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è‡ªå·±çš„è¯·æ±‚ä¸­å¤šäº†ç±»ä¼¼ä¸‹é¢çš„ä¸€äº›ä¿¡æ¯ï¼š\nAccess-Control-Allow-Origin: http://localhost:3000\rAccess-Control-Allow-Methods: GET, POST, OPTIONS\rAccess-Control-Max-Age: 1728000\rAccess-Control-Allow-Credentials: true è¿™æ ·ï¼Œæˆ‘ä»¬ä¾¿åœ¨ rails ä¸­è§£å†³äº† Ajax çš„è·¨åŸŸè¯·æ±‚èµ„æºçš„é—®é¢˜ï¼Œé¡¹ç›®ä¹Ÿå¯ä»¥ç»§ç»­å‘å‰å¼€å‘äº†ã€‚\nä½œè€…ï¼švito1994 é“¾æ¥ï¼šhttps://www.jianshu.com/p/c54a1dbaab24 ä¾†æºï¼šç®€ä¹¦ ç®€ä¹¦è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒå¹¶æ³¨æ˜å‡ºå¤„ã€‚ ","date":"2018-09-19T09:25:49Z","permalink":"https://dccmmtop.github.io/posts/rack-cors%E8%A7%A3%E5%86%B3ajax%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98-cors/","section":"posts","tags":["rails"],"title":"rack-corsè§£å†³Ajaxè·¨åŸŸé—®é¢˜-CORS"},{"categories":null,"contents":"åœ¨å¼€å§‹ç¼–å†™æ’ä»¶ä¹‹å‰ï¼Œä½ éœ€è¦ç¡®è®¤ Vim æ˜¯å¦æ”¯æŒ Rubyï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤æ¥åˆ¤åˆ«ï¼š\n$ vim --version | grep +ruby å¦‚æœè¾“å‡ºä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºä½ å½“å‰çš„ vim ä¸æ”¯æŒ Rubyï¼Œéœ€è¦é‡æ–°ç¼–è¯‘ä¸€ä¸‹ï¼Œå¹¶å¯ç”¨å¯¹ Ruby çš„æ”¯æŒã€‚\nå¦‚æœæ²¡æœ‰é—®é¢˜é‚£å°±å¼€å§‹å§ï¼\nä¸‹é¢çš„ç¤ºä¾‹æ˜¯æˆ‘ç”¨æ¥æŠŠæœ¬åœ°å›¾ç‰‡ä¸Šä¼ åˆ°ä¸ƒç‰›äº‘å›¾åºŠã€‚\næ–°å»º åœ¨.vim/autoloadä¸­æ–°å»ºtest.vim,å¤åˆ¶ä»¥ä¸‹ä»£ç \nfunction! qiniu#get_picture_url() ruby \u0026lt;\u0026lt; EOF class Qiniu def initialize @buffer = Vim::Buffer.current end def get_current_line s = @buffer.line # gets the current line # qiniu æ˜¯ä¸ƒç‰›äº‘çš„ä¸€ä¸ªgemï¼Œä¿®æ”¹äº†éƒ¨åˆ†ä»£ç ï¼Œå¹¶é‡å‘½åã€‚ real_link = `qiniu #{s}` real_link = real_link.split(/\\n/).last Vim::Buffer.current.line = \u0026#34;![](#{real_link})\u0026#34; # sets the current line number end end gem = Qiniu.new gem.get_current_line EOF endfunction ç»‘å®šå¿«æ·é”® åœ¨.vimrcä¸­ï¼Œæ˜ å°„å¿«æ·é”®\nnoremap \u0026lt;leader\u0026gt;qn :cal qiniu#get_picture_url()\u0026lt;cr\u0026gt;\u0026lt;CR\u0026gt; [\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;]\næˆ‘æŠŠå›¾ç‰‡çš„æœ¬åœ°åœ°å€ç²˜è´´åˆ° vim ä¸­ï¼Œç„¶åä½¿ç”¨qnå¿«æ·é”®ï¼Œæœ¬åœ°åœ°å€å°±ä¼šè¢«ä¿®æ”¹æˆè¯¥å›¾ç‰‡åœ¨ä¸ƒç‰›äº‘çš„å¤–é“¾ï¼Œç»å¸¸å†™åšå®¢ç”¨åˆ°\nvim API åœ¨ vim ä¸­æ‰§è¡Œ:h ruby æŸ¥çœ‹ vim æä¾› ruby çš„ API\næ¼”ç¤º ","date":"2018-08-30T17:36:12Z","permalink":"https://dccmmtop.github.io/posts/%E7%94%A8ruby%E7%BC%96%E5%86%99vim%E8%84%9A%E6%9C%AC/","section":"posts","tags":["vim"],"title":"ç”¨rubyç¼–å†™vimè„šæœ¬"},{"categories":null,"contents":"åœ¨ rails ä¸­,model çš„å±æ€§æ˜¯é»˜è®¤çš„å¯è¯»å¯å†™çš„ï¼Œæœ‰æ—¶æˆ‘ä»¬éœ€è¦é‡å†™æŸä¸ªå­—æ®µçš„è®¿é—®å™¨ã€‚å½“æŸ¥è¯¢æŸä¸ªå­—æ®µçš„å€¼æ—¶ï¼Œéœ€è¦è¿›è¡Œå…¶ä»–æ“ä½œï¼›\nå¦‚ï¼š å½“æŸ¥è¯¢recommand_codeçš„å€¼æ—¶ï¼Œè‹¥å­˜åœ¨ï¼Œåˆ™è¿”å›ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªåŒ…å«å¤§å†™å­—æ¯å’Œæ•°å­—çš„ 6 ä¸ºéšæœºå­—ç¬¦ä¸²\nä¸»è¦æ˜¯ read_attribute() å’Œ write_attribute() çš„ç”¨æ³•\ndef recommand_code # é‡å†™ recommand_code å­—æ®µ _code = read_attribute(:recommand_code) # _code = self.recommand_code é”™è¯¯ï¼Œä¼šå¼•èµ·æ— é™é€’å½’ if self.block.empty? self.recommand_code=nil; return end return _code if _code loop do _code = ((\u0026#34;0\u0026#34;..\u0026#34;9\u0026#34;).to_a + (\u0026#34;A\u0026#34;..\u0026#34;Z\u0026#34;).to_a).sample(6).join break if User.find_by_recommand_code(_code).nil? end self.recommand_code = nil; return _code end def recommand_code=(value) write_attribute(:recommand_code,value) end ","date":"2018-08-20T18:09:07Z","permalink":"https://dccmmtop.github.io/posts/rails%E9%87%8D%E5%86%99%E5%AD%97%E6%AE%B5/","section":"posts","tags":["rails"],"title":"railsé‡å†™å­—æ®µ"},{"categories":null,"contents":"åœ¨å¼€å‘å¾®ä¿¡å…¬ä¼—å·æˆ–å°ç¨‹åºçš„æ—¶å€™ï¼Œç”±äºå¾®ä¿¡å¹³å°è§„åˆ™çš„é™åˆ¶ï¼Œéƒ¨åˆ†æ¥å£éœ€è¦é€šè¿‡çº¿ä¸ŠåŸŸåæ‰èƒ½æ­£å¸¸è®¿é—®ã€‚ä½†æˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šåœ¨æœ¬åœ°å¼€å‘ï¼Œå› ä¸ºè¿™èƒ½å¿«é€Ÿçš„çœ‹åˆ°æºç ä¿®æ”¹åçš„è¿è¡Œç»“æœã€‚ä½†å½“æ¶‰åŠåˆ°éœ€è¦è°ƒç”¨å¾®ä¿¡æ¥å£æ—¶ï¼Œç”±äºä¸å’Œä½ åœ¨åŒä¸€ä¸ªå±€åŸŸç½‘ä¸­çš„ç”¨æˆ·æ˜¯æ— æ³•è®¿é—®ä½ çš„æœ¬åœ°å¼€å‘æœºçš„ï¼Œå°±å¿…é¡»æŠŠä¿®æ”¹åçš„ä»£ç é‡æ–°å‘å¸ƒåˆ°çº¿ä¸ŠåŸŸåæ‰€åœ¨çš„æœåŠ¡å™¨æ‰èƒ½å»éªŒè¯ç»“æœã€‚æ¯æ¬¡ä¿®æ”¹éƒ½é‡æ–°å‘å¸ƒå¾ˆç¹çä¹Ÿå¾ˆæµªè´¹æ—¶é—´ã€‚\næœ¬æ–‡å°†æ•™ä½ å¦‚ä½•é€šè¿‡ SSH éš§é“æŠŠæœ¬åœ°æœåŠ¡æ˜ å°„åˆ°å¤–ç½‘ï¼Œä»¥æ–¹ä¾¿è°ƒè¯•ï¼Œé€šå¸¸æŠŠè¿™ç§æ–¹æ³•å«å†…ç½‘ç©¿é€ã€‚\né˜…è¯»å®Œæœ¬æ–‡åï¼Œä½ èƒ½è§£å†³ä»¥ä¸‹å¸¸è§é—®é¢˜ï¼š\nå¼€å‘å¾®ä¿¡å…¬ä¼—å·ç­‰åº”ç”¨æ—¶æŠŠæœ¬åœ°æœåŠ¡æ˜ å°„åˆ°å¤–ç½‘ï¼ŒåŠ é€Ÿè°ƒè¯•æµç¨‹ï¼› æŠŠä½ æ­£åœ¨å¼€å‘çš„æœ¬åœ°æœåŠ¡åˆ†äº«ç»™äº’è”ç½‘ä¸Šå…¶å®ƒäººè®¿é—®ä½“éªŒï¼› åœ¨ä»»ä½•åœ°æ–¹é€šè¿‡äº’è”ç½‘æ§åˆ¶ä½ å®¶ä¸­åœ¨å±€åŸŸç½‘é‡Œçš„ç”µè„‘ï¼› æœ€ç»ˆç›®çš„ æŠŠè¿è¡Œåœ¨æœ¬åœ°å¼€å‘æœºä¸Šçš„ HTTP æœåŠ¡æ˜ å°„åˆ°å¤–ç½‘ï¼Œè®©å…¨ä¸–ç•Œéƒ½èƒ½é€šè¿‡å¤–ç½‘ IP æœåŠ¡åˆ°ä½ æœ¬åœ°å¼€å‘æœºä¸Šçš„ HTTP æœåŠ¡ã€‚ä¾‹å¦‚ä½ æœ¬åœ°çš„ HTTP æœåŠ¡ç›‘å¬åœ¨ 127.0.0.1:8080ï¼Œä½ æœ‰ä¸€å°å…¬ç½‘ IP ä¸º 12.34.56.78 çš„æœåŠ¡å™¨ï¼Œé€šè¿‡æœ¬æ–‡ä»‹ç»çš„æ–¹æ³•ï¼Œå¯ä»¥è®©å…¨ä¸–ç•Œçš„ç”¨æˆ·é€šè¿‡ http://12.34.56.78:8080 è®¿é—®åˆ°ä½ æœ¬åœ°å¼€å‘æœºä¸Šçš„ HTTP æœåŠ¡ã€‚\næ€»ç»“æˆä¸€å¥è¯å°±æ˜¯ï¼šæŠŠå†…ç½‘ç«¯å£æ˜ å°„åˆ°å¤–ç½‘ã€‚\nå‰ææ¡ä»¶ ä¸ºäº†æŠŠå†…ç½‘æœåŠ¡æ˜ å°„åˆ°å¤–ç½‘ï¼Œä»¥ä¸‹èµ„æºä¸ºå¿…é¡»çš„ï¼š\nä¸€å°æœ‰å¤–ç½‘ IP çš„æœåŠ¡å™¨ï¼› èƒ½åœ¨æœ¬åœ°å¼€å‘æœºä¸Šé€šè¿‡ ssh ç™»å…¥åˆ°å¤–ç½‘æœåŠ¡å™¨ã€‚ è¦æ»¡è¶³ä»¥ä¸Šæ¡ä»¶å¾ˆç®€å•ï¼š\nå¯¹äºæ¡ä»¶ 1ï¼šè´­ä¹°ä¸€å°ä½é… Linux æœåŠ¡å™¨ï¼Œæ¨èå›½å¤–çš„ DigitalOceanï¼› å¯¹äºæ¡ä»¶ 2ï¼šå¯¹äº Macã€Linux å¼€å‘æœºæ˜¯å†…ç½®äº† ssh å®¢æˆ·ç«¯çš„ï¼Œå¯¹äº Windows å¯ä»¥å®‰è£… Cygwinã€‚ å®ç°åŸç† è¦å®ç°æŠŠå†…ç½‘ç«¯å£æ˜ å°„åˆ°å¤–ç½‘ï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯é€šè¿‡ SSH éš§é“ã€‚\nSSH éš§é“å°±åƒä¸€æ ¹ç®¡é“ï¼Œèƒ½æŠŠä»»ä½• 2 å°æœºå™¨è¿æ¥åœ¨ä¸€èµ·ï¼ŒæŠŠå‘é€åˆ°å…¶ä¸­ä¸€å°æœºå™¨çš„æ•°æ®é€šè¿‡ç®¡é“ä¼ è¾“åˆ°å¦ä¸€å°æœºå™¨ã€‚å‡å¦‚å·²ç»é€šè¿‡ SSH éš§é“æŠŠæœ¬åœ°å¼€å‘æœºå’Œå¤–ç½‘æœåŠ¡å™¨è¿æ¥åœ¨äº†ä¸€èµ·ï¼Œå¤–ç½‘æœåŠ¡å™¨ç«¯ç›‘å¬åœ¨ 12.34.56.78:8080ï¼Œé‚£ä¹ˆæ‰€æœ‰å‘ç»™ 12.34.56.78:8080 çš„æ•°æ®éƒ½ä¼šé€šè¿‡ SSH éš§é“åŸå°ä¸åŠ¨åœ°ä¼ è¾“ç»™æœ¬åœ°å¼€å‘æœºçš„ 127.0.0.1:8080ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š\nä¹Ÿå°±æ˜¯è¯´ï¼Œå»è®¿é—® 12.34.56.78:8080 å°±åƒæ˜¯è®¿é—®æœ¬åœ°å¼€å‘æœºçš„ 127.0.0.1:8080ï¼Œæœ¬åœ°å¼€å‘æœºä¸Šçš„ 8080 ç«¯å£è¢«æ˜ å°„åˆ°äº†å¤–ç½‘æœåŠ¡å™¨ä¸Šçš„ 8080 ç«¯å£ã€‚\nå¦‚æœä½ çš„å¤–ç½‘æœåŠ¡å™¨ IP é…ç½®äº†åŸŸåè§£æï¼Œä¾‹å¦‚ yourdomin.com ä¼šé€šè¿‡ DNS è§£æä¸º 12.34.56.78ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥é€šè¿‡ yourdomin.com:8080 å»è®¿é—®æœ¬åœ°å¼€å‘æœºä¸Šçš„æœåŠ¡ã€‚\nè¿™æ ·å°±åšåˆ°äº†è®¿é—®å¤–ç½‘åœ°å€æ—¶å…¶å®æ˜¯æœ¬åœ°æœåŠ¡è¿”å›çš„ç»“æœã€‚\né€šè¿‡ SSH éš§é“ä¼ è¾“æ•°æ®æ—¶ï¼Œæ•°æ®ä¼šè¢«åŠ å¯†ï¼Œå°±ç®—ä¸­é—´è¢«åŠ«æŒï¼Œé»‘å®¢ä¹Ÿæ— æ³•å¾—åˆ°æ•°æ®çš„åŸå†…å®¹ã€‚\næ‰€ä»¥ SSH éš§é“è¿˜æœ‰ä¸€ä¸ªåŠŸèƒ½å°±æ˜¯ä¿è¯æ•°æ®ä¼ è¾“çš„å®‰å…¨æ€§ã€‚\nå®ç°æ­¥éª¤ æŠŠæœ¬åœ°å¼€æœºå’Œå¤–ç½‘æœåŠ¡å™¨é€šè¿‡ SSH éš§é“è¿æ¥èµ·æ¥å°±å’Œåœ¨æœ¬åœ°å¼€å‘æœº SSH ç™»å…¥è¿œç¨‹ç™»å…¥åˆ°å¤–ç½‘æœåŠ¡å™¨ä¸€æ ·ç®€å•ã€‚\nå…ˆæ¥å›é¡¾ä»¥ä¸‹ SSH è¿œç¨‹ç™»å…¥å‘½ä»¤ï¼Œå‡å¦‚æƒ³åœ¨æœ¬åœ°è¿œç¨‹ç™»å…¥åˆ° 12.34.56.78ï¼Œå¯ä»¥åœ¨æœ¬åœ°å¼€å‘æœºä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š\nssh username@12.34.56.78\nè€Œå®ç° SSH éš§é“åªéœ€åœ¨æœ¬åœ°å¼€å‘æœºä¸Šæ‰§è¡Œï¼š\nssh -R 8080:127.0.0.1:8080 username@12.34.56.78\nå¯ä»¥çœ‹å‡ºå®ç° SSH éš§é“çš„å‘½ä»¤ç›¸å¯¹äº SSH ç™»å…¥å¤šå‡ºæ¥ -R 8080:127.0.0.1:8080ï¼Œå¤šå‡ºçš„è¿™éƒ¨åˆ†çš„å«ä¹‰æ˜¯ï¼š\nåœ¨è¿œç¨‹æœºå™¨(12.34.56.78)ä¸Šå¯åŠ¨ TCP 8080 ç«¯å£ç›‘å¬ç€ï¼Œå†æŠŠè¿œç¨‹æœºå™¨(12.34.56.78)ä¸Š 8080 ç«¯å£æ˜ å°„åˆ°æœ¬åœ°çš„ 127.0.0.1:8080ã€‚\næ‰§è¡Œå®Œä»¥ä¸Šå‘½ä»¤åï¼Œå°±å¯ä»¥é€šè¿‡ 12.34.56.78:8080 å»è®¿é—®æœ¬åœ°çš„ 127.0.0.1:8080 äº†ã€‚\né€šå¸¸æŠŠè¿™ç§æŠ€æœ¯å«åš SSH è¿œç¨‹ç«¯å£è½¬å‘(remote forwarding)ã€‚\nå…¶å®ä¸é™äºåªèƒ½æŠŠæœ¬åœ°å¼€å‘æœºä¸Šè¿è¡Œçš„æœåŠ¡æ˜ å°„åˆ°å¤–ç½‘æœåŠ¡å™¨ä¸Šå»ï¼Œè¿˜å¯ä»¥æŠŠä»»ä½•æœ¬åœ°å¼€å‘æœºå¯ä»¥è®¿é—®çš„æœåŠ¡æ˜ å°„åˆ°å¤–ç½‘æœåŠ¡å™¨ä¸Šå»ã€‚ä¾‹å¦‚åœ¨æœ¬åœ°å¼€å‘æœºä¸Šèƒ½è®¿é—® github.com:80ï¼Œåœ¨æœ¬åœ°å¼€å‘æœºä¸Šæ‰§è¡Œï¼š\nssh -R 8080:github.com:80 username@12.34.56.78\nå°±èƒ½é€šè¿‡ 12.34.56.78:8080 å»è®¿é—® github.com:80 äº†ã€‚\nä¿æŒè¿è¡Œ\nåœ¨æ‰§è¡Œå®Œä¸Šé¢ä»‹ç»çš„ SSH éš§é“å‘½ä»¤åï¼Œä½ ä¼šå‘ç°ç™»å…¥åˆ°äº†å¤–ç½‘æœåŠ¡å™¨ä¸Šå»äº†ï¼Œå¦‚æœä½ ç™»å‡ºå¤–ç½‘æœåŠ¡å™¨ï¼Œå°±ä¼šå‘ç° 12.34.56.78:8080 æ— æ³•è®¿é—®äº†ã€‚å¯¼è‡´è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯ä½ ç™»å‡ºå¤–ç½‘æœåŠ¡å™¨æ—¶ï¼Œåœ¨å¤–ç½‘æœåŠ¡å™¨ä¸Šæœ¬æ¬¡æ“ä½œå¯¹åº”çš„ SSH è¿›ç¨‹ä¹Ÿè·Ÿç€é€€å‡ºäº†ï¼Œè€Œè¿™ä¸ªé€€å‡ºçš„è¿›ç¨‹æ›¾è´Ÿè´£ç›‘å¬åœ¨ 8080 ç«¯å£è¿›è¡Œè½¬å‘æ“ä½œã€‚\nä¸ºäº†è®© SSH éš§é“ä¸€ç›´ä¿æŒåœ¨åå°æ‰§è¡Œï¼Œæœ‰ä»¥ä¸‹æ–¹æ³•ã€‚\né€šè¿‡ SSH è‡ªå¸¦çš„å‚æ•°\nSSH è¿˜æ”¯æŒè¿™äº›å‚æ•°ï¼š\nN å‚æ•°ï¼šè¡¨ç¤ºåªè¿æ¥è¿œç¨‹ä¸»æœºï¼Œä¸æ‰“å¼€è¿œç¨‹ shellï¼› T å‚æ•°ï¼šè¡¨ç¤ºä¸ä¸ºè¿™ä¸ªè¿æ¥åˆ†é… TTYï¼› f å‚æ•°ï¼šè¡¨ç¤ºè¿æ¥æˆåŠŸåï¼Œè½¬å…¥åå°è¿è¡Œï¼› å› æ­¤è¦è®© SSH éš§é“ä¸€ç›´ä¿æŒåœ¨åå°æ‰§è¡Œï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ï¼š\nssh -NTf -R 8080:127.0.0.1:8080 username@12.34.56.78\né€šè¿‡ AutoSSH SSH éš§é“æ˜¯ä¸ç¨³å®šçš„ï¼Œåœ¨ç½‘ç»œæ¶åŠ£çš„æƒ…å†µä¸‹å¯èƒ½éšæ—¶æ–­å¼€ã€‚å¦‚æœæ–­å¼€å°±éœ€è¦æ‰‹åŠ¨å»æœ¬åœ°å¼€å‘æœºå†æ¬¡å‘å¤–ç½‘æœåŠ¡å™¨å‘èµ·è¿æ¥ã€‚\nAutoSSH èƒ½è®© SSH éš§é“ä¸€ç›´ä¿æŒæ‰§è¡Œï¼Œä»–ä¼šå¯åŠ¨ä¸€ä¸ª SSH è¿›ç¨‹ï¼Œå¹¶ç›‘æ§è¯¥è¿›ç¨‹çš„å¥åº·çŠ¶å†µï¼›å½“ SSH è¿›ç¨‹å´©æºƒæˆ–åœæ­¢é€šä¿¡æ—¶ï¼ŒAutoSSH å°†é‡å¯åŠ¨ SSH è¿›ç¨‹ã€‚\nä½¿ç”¨ AutoSSH åªéœ€åœ¨æœ¬åœ°å¼€å‘æœºä¸Šå®‰è£… AutoSSH ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š\nMac ç³»ç»Ÿï¼šbrew install autosshï¼› Linux ç³»ç»Ÿï¼šapt-get install autosshï¼› å®‰è£…æˆåŠŸåï¼Œåœ¨æœ¬åœ°å¼€å‘æœºä¸Šæ‰§è¡Œï¼š\nautossh -N -R 8080:127.0.0.1:8080 username@12.34.56.78\nå°±èƒ½å®Œæˆå’Œä¸Šé¢ä¸€æ ·çš„æ•ˆæœï¼Œä½†æœ¬æ–¹æ³•èƒ½ä¿æŒ SSH éš§é“ä¸€ç›´è¿è¡Œã€‚\nå¯ä»¥çœ‹å‡ºè¿™è¡Œå‘½ä»¤å’Œä¸Šé¢çš„åŒºåˆ«åœ¨äºæŠŠ ssh æ¢æˆäº† autosshï¼Œå¹¶ä¸”å°‘äº† -f å‚æ•°ï¼ŒåŸå› æ˜¯ autossh é»˜è®¤ä¼šè½¬å…¥åå°è¿è¡Œã€‚\nå¸¸è§é—®é¢˜\nå¦‚æœä½ é‡åˆ°é€šè¿‡ä»¥ä¸Šæ–¹æ³•æˆåŠŸå¯åŠ¨ SSH éš§é“åï¼Œè¿˜æ˜¯æ— æ³•è®¿é—® 12.34.56.78:8080ï¼Œé‚£ä¹ˆå¾ˆæœ‰å¯èƒ½æ˜¯å¤–ç½‘æœåŠ¡å™¨ä¸Šçš„ SSH æ²¡æœ‰é…ç½®å¯¹ã€‚ä¸ºæ­¤ä½ éœ€è¦å»å¤–ç½‘æœåŠ¡å™¨ä¸Šä¿®æ”¹ /etc/ssh/sshd_config æ–‡ä»¶å¦‚ä¸‹ï¼š\nGatewayPorts yes\nè¿™ä¸ªé€‰é¡¹çš„æ„æ€æ˜¯ï¼ŒSSH éš§é“ç›‘å¬çš„æœåŠ¡çš„ IP æ˜¯å¯¹å¤–å¼€æ”¾çš„ 0.0.0.0ï¼Œè€Œä¸æ˜¯åªå¯¹æœ¬æœºçš„ 127.0.0.1ã€‚ä¸å¼€ GatewayPorts çš„åæœæ˜¯ä¸èƒ½é€šè¿‡ 12.34.56.78:8080 è®¿é—®ï¼Œåªèƒ½åœ¨å¤–ç½‘æœåŠ¡å™¨ä¸Šé€šè¿‡ 127.0.0.1:8080 æœåŠ¡åˆ°æœ¬åœ°å¼€å‘æœºçš„æœåŠ¡ã€‚\nä¿®æ”¹å¥½é…ç½®æ–‡ä»¶åï¼Œä½ è¿˜éœ€è¦é‡å¯ sshd æœåŠ¡æ¥åŠ è½½æ–°çš„é…ç½®ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š\nservice sshd restart\nå¦‚æœä½¿ç”¨ä»¥ä¸Šæ–¹æ³•è¿˜æ˜¯æ— æ³•è®¿é—® 12.34.56.78:8080ï¼Œè¯·æ£€æŸ¥ä½ å¤–ç½‘æœåŠ¡å™¨çš„é˜²ç«å¢™é…ç½®ï¼Œç¡®ä¿ 8080 ç«¯å£æ˜¯å¯¹å¤–å¼€æ”¾çš„ã€‚\nå…¶å®ƒä»£æ›¿æ–¹æ¡ˆ\né™¤äº† SSH éš§é“èƒ½å®ç°å†…ç½‘ç©¿é€å¤–ï¼Œè¿˜æœ‰ä»¥ä¸‹å¸¸ç”¨æ–¹æ³•ã€‚\nfrp frp æ˜¯ä¸€ä¸ªå¯ç”¨äºå†…ç½‘ç©¿é€çš„é«˜æ€§èƒ½çš„åå‘ä»£ç†åº”ç”¨ï¼Œæ”¯æŒ tcp, udp, http, https åè®®ã€‚\nfrp æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š\nfrp æ¯” SSH éš§é“åŠŸèƒ½æ›´å¤šï¼Œé…ç½®é¡¹æ›´å¤šï¼› frp ä¹Ÿéœ€è¦ä¸€å°å¤–ç½‘æœåŠ¡å™¨ï¼Œå¹¶ä¸”éœ€è¦åœ¨å¤–ç½‘æœåŠ¡å™¨ä¸Šå®‰è£… frpsï¼Œåœ¨æœ¬åœ°å¼€å‘æœºä¸Šå®‰è£… frpcï¼› ngrok ngrok æ˜¯ä¸€ä¸ªå•†ç”¨çš„å†…ç½‘ç©¿é€å·¥å…·ï¼Œå®ƒæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š\nä¸éœ€è¦æœ‰å¤–ç½‘æœåŠ¡å™¨ï¼Œå› ä¸º ngrok ä¼šä¸ºä½ æä¾›ï¼› åªéœ€è¦åœ¨æœ¬åœ°å¼€å‘æœºå®‰è£… ngrok å®¢æˆ·ç«¯ï¼Œå’Œæ³¨å†Œ ngrok è´¦æˆ·ï¼› æŒ‰ç…§æœåŠ¡æ”¶è´¹ï¼› è¿™äº›ä»£æ›¿æ–¹æ¡ˆçš„ç¼ºç‚¹åœ¨äºéƒ½éœ€è¦å†é¢å¤–å®‰è£…å…¶å®ƒå·¥å…·ï¼Œæ²¡æœ‰ SSH éš§é“æ¥çš„ç›´æ¥ã€‚\næƒ³äº†è§£æ›´å¤šå¯ä»¥è®¿é—®å®ƒä»¬çš„ä¸»é¡µã€‚\né˜…è¯»åŸæ–‡\n","date":"2018-08-19T17:04:28Z","permalink":"https://dccmmtop.github.io/posts/ssh%E9%9A%A7%E9%81%93/","section":"posts","tags":["linux"],"title":"SSHéš§é“"},{"categories":null,"contents":"å…³äº Rails çš„æ¨¡å‹è‡ªå…³è”æœ‰ä¸€ä¸ªéå¸¸æœ‰æ„æ€çš„é¢˜ç›®ï¼Œå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š\nlisa = Person.create(name:\u0026#39;Lisa\u0026#39;) tom = Person.create(name:\u0026#39;Tom\u0026#39;,parent_id:lisa.id) andy = Person.create(name:\u0026#39;Andy\u0026#39;,parent_id:lisa.id) tom.parent.name =\u0026gt; \u0026#39;Lisa\u0026#39; lisa.children.map(\u0026amp;:name) =\u0026gt; [\u0026#39;Tom\u0026#39;,\u0026#39;Andy\u0026#39;] thomas = Person.create(name: \u0026#39;Thomas\u0026#39;,parent_id: tom.id) peter = Person.create(name:\u0026#39;Peter\u0026#39;,parent_id:tom.id) gavin = Person.create(name:\u0026#39;Gavin\u0026#39;, parent_id: andy.id) lisa.grandchildren.map(\u0026amp;:name) =\u0026gt; [\u0026#39;Thomas\u0026#39;,\u0026#39;Peter\u0026#39;,\u0026#39;Gavin\u0026#39;] é—®å¦‚ä½•å®šä¹‰ Person æ¨¡å‹æ¥æ»¡è¶³ä»¥ä¸Šéœ€æ±‚ï¼Ÿ\né¢˜ç›®è€ƒå¯Ÿäº†å¯¹æ¨¡å‹è‡ªå…³è”çš„ç†è§£ï¼Œé€šè¿‡å®¡é¢˜æˆ‘ä»¬å¯ä»¥å¾—å‡ºä»¥ä¸‹å‡ ç‚¹ï¼š\nPerson å¯¹è±¡çš„ Parent åŒæ ·æ˜¯ Person å¯¹è±¡ï¼ˆè‡ªå…³è”ï¼‰ Person å¯¹è±¡å¯¹ Parent æ˜¯å¤šå¯¹ä¸€å…³ç³» Person å¯¹è±¡å¯¹ Children æ˜¯ä¸€å¯¹å¤šå…³ç³» Person å¯¹è±¡é€šè¿‡ Children ä¸ GrandChildren å»ºç«‹äº†ä¸€å¯¹å¤šå…³ç³»\nåœ¨ä¸è€ƒè™‘ GrandChildren æ—¶ï¼Œä¸éš¾å¾—å‡ºæ¨¡å‹å®šä¹‰å¦‚ä¸‹ï¼š class Person \u0026lt; ActiveRecord::Base belongs_to :parent, class_name: \u0026#39;Person\u0026#39;, foreign_key: \u0026#39;parent_id\u0026#39; has_many :children, class_name: \u0026#39;Person\u0026#39;, foreign_key: \u0026#39;parent_id\u0026#39; end å…¶ä¸­ Person åŒ…å«ä¸¤ä¸ªè‡ªå…³è”å…³ç³»ï¼š\nç¬¬ä¸€ä¸ªå°±æ˜¯éå¸¸å¸¸è§çš„ä»å­åˆ°çˆ¶çš„å…³ç³»ï¼Œåœ¨ Person å¯¹è±¡åˆ›å»ºæ—¶æŒ‡å®š parent_id æ¥æŒ‡å‘çˆ¶å¯¹è±¡ï¼›\nç¬¬äºŒä¸ªå…³ç³»ç”¨æ¥æŒ‡å®š Person å¯¹è±¡å¯¹åº”çš„æ‰€æœ‰å­å¯¹è±¡\næ¥ä¸‹æ¥æ›´è¿‘ä¸€æ­¥ï¼Œæˆ‘ä»¬è¦æ‰¾åˆ° Person å¯¹è±¡å­å¯¹è±¡çš„å­å¯¹è±¡ï¼Œæ¢å¥è¯è¯´ï¼šå­™å­å¯¹è±¡ã€‚\nå¦‚æˆ‘ä»¬ä¸Šé¢çš„åˆ†æï¼ŒPerson å¯¹è±¡é€šè¿‡ Children ä¸ GrandChildren å»ºç«‹äº†ä¸€å¯¹å¤šå…³ç³»ï¼Œå…¶ä»£ç è¡¨ç°ä¸ºï¼š\nhas_many :grandchildren, :through =\u0026gt; :children, :source =\u0026gt; :children\n:source é€‰é¡¹çš„å®˜æ–¹æ–‡æ¡£è¯´æ˜å¦‚ä¸‹ï¼š\nThe :source option specifies the source association name for a has_many :through association. You only need to use this option if the name of the source association cannot be automatically inferred from the association name. â€”â€” rails guide\nåœ¨è¿™é‡Œæˆ‘ä»¬é€šè¿‡:source é€‰é¡¹å‘Šè¯‰ Rails åœ¨ children å¯¹è±¡ä¸ŠæŸ¥æ‰¾ children å…³è”å…³ç³»ã€‚\näºæ˜¯è¯¥é¢˜ç›®å®Œæ•´çš„æ¨¡å‹å®šä¹‰å¦‚ä¸‹ï¼š\nclass Person \u0026lt; ActiveRecord::Base belongs_to :parent, class_name: \u0026#39;Person\u0026#39;, foreign_key: \u0026#39;parent_id\u0026#39; has_many :children, class_name: \u0026#39;Person\u0026#39;, foreign_key: \u0026#39;parent_id\u0026#39; has_many :grandchildren, :through =\u0026gt; :children, :source =\u0026gt; :children end ä½œè€…ï¼šæå°è¥¿ 033\né“¾æ¥ï¼šhttps://www.jianshu.com/p/076b5fec4dad\nä¾†æºï¼šç®€ä¹¦\nç®€ä¹¦è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ï¼Œä»»ä½•å½¢å¼çš„è½¬è½½éƒ½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒå¹¶æ³¨æ˜å‡ºå¤„ã€‚\n","date":"2018-08-15T12:22:06Z","permalink":"https://dccmmtop.github.io/posts/rails-%E8%87%AA%E5%85%B3%E8%81%94/","section":"posts","tags":["rails"],"title":"rails-è‡ªå…³è”"},{"categories":null,"contents":"shuffle ((\u0026#34;0\u0026#34;..\u0026#34;9\u0026#34;).to_a + (\u0026#34;A\u0026#34;..\u0026#34;Z\u0026#34;).to_a).shuffle[0..6].to_a.join shuffle: éšæœºæ’åˆ—ï¼Œä¸­æ–‡åç§°æ˜¯æ´—ç‰Œ\nsample ((\u0026#34;0\u0026#34;..\u0026#34;9\u0026#34;).to_a + (\u0026#34;A\u0026#34;..\u0026#34;Z\u0026#34;).to_a).sample(6).join * [*\u0026#39;0\u0026#39;..\u0026#39;9\u0026#39;,*\u0026#39;A\u0026#39;..\u0026#39;Z\u0026#39;].sample(6).join *çš„æ„æ€æ˜¯å°†èŒƒå›´å±•å¼€\n","date":"2018-08-12T10:23:46Z","permalink":"https://dccmmtop.github.io/posts/ruby%E9%9A%8F%E6%9C%BA%E7%94%9F%E6%88%90%E5%AD%97%E7%AC%A6%E4%B8%B2/","section":"posts","tags":["ruby"],"title":"rubyéšæœºç”Ÿæˆå­—ç¬¦ä¸²"},{"categories":null,"contents":"ç”¨ app æ¥è°ƒç”¨ routesï¼Œæ¯”å¦‚ app.posts_path, app.topic_path(1)\nirb \u0026gt; app.topics_path =\u0026gt; \u0026#34;/topics\u0026#34; irb \u0026gt; app.get(app.root_path) ...... =\u0026gt; 200 ç”¨ helper æ¥è°ƒç”¨ Helper æ–¹æ³•ï¼Œæ¯”å¦‚:\nirb \u0026gt; helper.link_to(\u0026#34;Ruby China\u0026#34;, \u0026#34;http://ruby-china.org\u0026#34;) =\u0026gt; \u0026#34;\u0026lt;a href=\\\u0026#34;http://ruby-china.org\\\u0026#34;\u0026gt;Ruby China\u0026lt;/a\u0026gt;\u0026#34; irb \u0026gt; helper.truncate(\u0026#34;Here is Ruby China.\u0026#34;, length: 15) =\u0026gt; \u0026#34;Here is Ruby...\u0026#34; ä½¿ç”¨ source_location æ–¹æ³•æŸ¥çœ‹æ–¹æ³•åœ¨é‚£é‡Œå®šä¹‰çš„, æ¯”å¦‚:\nirb \u0026gt;Topic.instance_method(:destroy).source_location =\u0026gt; [\u0026#34;/Users/jason/.rvm/gems/ruby-1.9.3-p0/gems/mongoid-2.4.8/lib/mongoid/persistence.rb\u0026#34;, 30] irb \u0026gt;Topic.method(:destroy_all).source_location =\u0026gt; [\u0026#34;/Users/jason/.rvm/gems/ruby-1.9.3-p0/gems/mongoid-2.4.8/lib/mongoid/persistence.rb\u0026#34;, 239] ","date":"2018-08-07T23:58:40Z","permalink":"https://dccmmtop.github.io/posts/rails_console%E5%A5%BD%E7%94%A8%E7%9A%84%E6%8A%80%E5%B7%A7/","section":"posts","tags":["rails"],"title":"rails_consoleå¥½ç”¨çš„æŠ€å·§"},{"categories":null,"contents":"è½¬è½½ http://api.rubyonrails.org/classes/ActiveRecord/Store.html\né˜…è¯» http://api.rubyonrails.org ç›¸å…³çš„ç¬”è®°\nä½¿ç”¨ Model é‡Œé¢çš„ä¸€ä¸ªå­—æ®µä½œä¸ºä¸€ä¸ªåºåˆ—åŒ–çš„å°è£…ï¼Œç”¨æ¥å­˜å‚¨ä¸€ä¸ª key/value\næ–‡æ¡£é‡Œé¢æåˆ°ï¼Œå¯¹åº”çš„å­˜å‚¨å­—æ®µçš„ç±»å‹æœ€å¥½æ˜¯ textï¼Œ ä»¥ä¾¿ç¡®ä¿æœ‰è¶³å¤Ÿçš„å­˜å‚¨ç©ºé—´\nMake sure that you declare the database column used for the serialized store as a text, so there\u0026#39;s plenty of room. å‡è®¾ Model é‡Œé¢æœ‰ä¸€ä¸ªå­—æ®µ body\nclass CreatePosts \u0026lt; ActiveRecord::Migration[5.0] def change create_table :posts do |t| t.string :title t.text :body # ä½œä¸ºstoreåºåˆ—åŒ–çš„å­—æ®µ t.boolean :published t.integer :status t.timestamps end end end æ¥ç€è®¾ç½®å¯¹åº”çš„åºåˆ—åŒ–å±æ€§\nclass Post \u0026lt; ApplicationRecord # enum status: [ :active, :archived ] # è¿™é‡Œä½¿ç”¨æ•°ç»„ ä¸ä¹‹å¯¹åº”çš„æ•°å­—ä»0ä¾æ¬¡å¢åŠ  enum status: { active: 10, archived: 20 } # æ˜ç¡®æŒ‡å®šå¯¹åº”çš„æ•°å­— store :body, accessors: [ :color, :homepage, :email ], coder: JSON # åºåˆ—åŒ–å±æ€§ end è¿™æ ·è®¾ç½®åï¼Œåœ¨ body è¿™ä¸€ä¸ªå­—æ®µä¸Šå°±å¯ä»¥å­˜å‚¨å¤šä¸ª key/value äº†\nirb(main):001:0\u0026gt; p = Post.create (0.1ms) begin transaction SQL (1.2ms) INSERT INTO \u0026#34;posts\u0026#34; (\u0026#34;created_at\u0026#34;, \u0026#34;updated_at\u0026#34;) VALUES (?, ?) [[\u0026#34;created_at\u0026#34;, 2017-02-16 07:32:44 UTC], [\u0026#34;updated_at\u0026#34;, 2017-02-16 07:32:44 UTC]] (1.9ms) commit transaction =\u0026gt; #\u0026lt;Post id: 4, title: nil, body: {}, published: nil, status: nil, created_at: \u0026#34;2017-02-16 07:32:44\u0026#34;, updated_at: \u0026#34;2017-02-16 07:32:44\u0026#34;\u0026gt; irb(main):002:0\u0026gt; p.body =\u0026gt; {} irb(main):003:0\u0026gt; p.body.class =\u0026gt; ActiveSupport::HashWithIndifferentAccess irb(main):004:0\u0026gt; p.body[:color] = \u0026#34;red\u0026#34; =\u0026gt; \u0026#34;red\u0026#34; irb(main):005:0\u0026gt; p.body[:email] = \u0026#34;hello@126.com\u0026#34; =\u0026gt; \u0026#34;hello@126.com\u0026#34; irb(main):006:0\u0026gt; p.color =\u0026gt; \u0026#34;red\u0026#34; irb(main):007:0\u0026gt; p.email =\u0026gt; \u0026#34;hello@126.com\u0026#34; irb(main):008:0\u0026gt; p.body[:no_set] = \u0026#34;è¿™ä¸ªå±æ€§æ²¡æœ‰åœ¨modelå£°æ˜\u0026#34; =\u0026gt; \u0026#34;è¿™ä¸ªå±æ€§æ²¡æœ‰åœ¨modelå£°æ˜\u0026#34; irb(main):009:0\u0026gt; p.body[:no_set] =\u0026gt; \u0026#34;è¿™ä¸ªå±æ€§æ²¡æœ‰åœ¨modelå£°æ˜\u0026#34; irb(main):010:0\u0026gt; p.no_set #è¿™ä¸ªä¼šæŠ¥é”™ ","date":"2018-08-07T22:53:19Z","permalink":"https://dccmmtop.github.io/posts/activerecord_store%E7%94%A8%E6%B3%95%E7%A4%BA%E4%BE%8B/","section":"posts","tags":["rails"],"title":"ActiveRecord_Storeç”¨æ³•ç¤ºä¾‹"},{"categories":null,"contents":"è¿™ä¸ªå‘½ä»¤å¯ä»¥ä»¥é€’å½’çš„æ–¹å¼ä¸‹è½½æ•´ç«™ï¼Œå¹¶å¯ä»¥å°†ä¸‹è½½çš„é¡µé¢ä¸­çš„é“¾æ¥è½¬æ¢ä¸ºæœ¬åœ°é“¾æ¥ã€‚\nwget åŠ ä¸Šå‚æ•°ä¹‹åï¼Œå³å¯æˆä¸ºç›¸å½“å¼ºå¤§çš„ä¸‹è½½å·¥å…·ã€‚\nwget -r -p -np -k http://xxx.com/abc/ -r, \u0026ndash;recursiveï¼ˆé€’å½’ï¼‰ specify recursive download.ï¼ˆæŒ‡å®šé€’å½’ä¸‹è½½ï¼‰ -k, \u0026ndash;convert-linksï¼ˆè½¬æ¢é“¾æ¥ï¼‰ make links in downloaded HTML point to local files.ï¼ˆå°†ä¸‹è½½çš„ HTML é¡µé¢ä¸­çš„é“¾æ¥è½¬æ¢ä¸ºç›¸å¯¹é“¾æ¥å³æœ¬åœ°é“¾æ¥ï¼‰ -p, \u0026ndash;page-requisitesï¼ˆé¡µé¢å¿…éœ€å…ƒç´ ï¼‰ get all images, etc. needed to display HTML page.ï¼ˆä¸‹è½½æ‰€æœ‰çš„å›¾ç‰‡ç­‰é¡µé¢æ˜¾ç¤ºæ‰€éœ€çš„å†…å®¹ï¼‰ -np, \u0026ndash;no-parentï¼ˆä¸è¿½æº¯è‡³çˆ¶çº§ï¼‰ don\u0026rsquo;t ascend to the parent directory.\nå¦å¤–æ–­ç‚¹ç»­ä¼ ç”¨-nc å‚æ•° æ—¥å¿— ç”¨-o å‚æ•° â€‹ ç†Ÿç»ƒæŒæ¡ wget å‘½ä»¤ï¼Œå¯ä»¥å¸®åŠ©ä½ æ–¹ä¾¿çš„ä½¿ç”¨ linuxã€‚\nå‘½ä»¤ç”¨æ³•è¯¦è§£ http://www.cnblogs.com/peida/archive/2013/03/18/2965369.html\nLinux ç³»ç»Ÿä¸­çš„ wget æ˜¯ä¸€ä¸ªä¸‹è½½æ–‡ä»¶çš„å·¥å…·ï¼Œå®ƒç”¨åœ¨å‘½ä»¤è¡Œä¸‹ã€‚å¯¹äº Linux ç”¨æˆ·æ˜¯å¿…ä¸å¯å°‘çš„å·¥å…·ï¼Œæˆ‘ä»¬ç»å¸¸è¦ä¸‹è½½ä¸€äº›è½¯ä»¶æˆ–ä»è¿œç¨‹æœåŠ¡å™¨æ¢å¤å¤‡ä»½åˆ°æœ¬åœ°æœåŠ¡å™¨ã€‚wget æ”¯æŒ HTTPï¼ŒHTTPS å’Œ FTP åè®®ï¼Œå¯ä»¥ä½¿ç”¨ HTTP ä»£ç†ã€‚æ‰€è°“çš„è‡ªåŠ¨ä¸‹è½½æ˜¯æŒ‡ï¼Œwget å¯ä»¥åœ¨ç”¨æˆ·é€€å‡ºç³»ç»Ÿçš„ä¹‹ååœ¨åå°æ‰§è¡Œã€‚è¿™æ„å‘³è¿™ä½ å¯ä»¥ç™»å½•ç³»ç»Ÿï¼Œå¯åŠ¨ä¸€ä¸ª wget ä¸‹è½½ä»»åŠ¡ï¼Œç„¶åé€€å‡ºç³»ç»Ÿï¼Œwget å°†åœ¨åå°æ‰§è¡Œç›´åˆ°ä»»åŠ¡å®Œæˆï¼Œç›¸å¯¹äºå…¶å®ƒå¤§éƒ¨åˆ†æµè§ˆå™¨åœ¨ä¸‹è½½å¤§é‡æ•°æ®æ—¶éœ€è¦ç”¨æˆ·ä¸€ç›´çš„å‚ä¸ï¼Œè¿™çœå»äº†æå¤§çš„éº»çƒ¦ã€‚\nwget å¯ä»¥è·Ÿè¸ª HTML é¡µé¢ä¸Šçš„é“¾æ¥ä¾æ¬¡ä¸‹è½½æ¥åˆ›å»ºè¿œç¨‹æœåŠ¡å™¨çš„æœ¬åœ°ç‰ˆæœ¬ï¼Œå®Œå…¨é‡å»ºåŸå§‹ç«™ç‚¹çš„ç›®å½•ç»“æ„ã€‚è¿™åˆå¸¸è¢«ç§°ä½œâ€é€’å½’ä¸‹è½½â€ã€‚åœ¨é€’å½’ä¸‹è½½çš„æ—¶å€™ï¼Œwget éµå¾ª Robot Exclusion æ ‡å‡†(/robots.txt). wget å¯ä»¥åœ¨ä¸‹è½½çš„åŒæ—¶ï¼Œå°†é“¾æ¥è½¬æ¢æˆæŒ‡å‘æœ¬åœ°æ–‡ä»¶ï¼Œä»¥æ–¹ä¾¿ç¦»çº¿æµè§ˆã€‚\nwget éå¸¸ç¨³å®šï¼Œå®ƒåœ¨å¸¦å®½å¾ˆçª„çš„æƒ…å†µä¸‹å’Œä¸ç¨³å®šç½‘ç»œä¸­æœ‰å¾ˆå¼ºçš„é€‚åº”æ€§.å¦‚æœæ˜¯ç”±äºç½‘ç»œçš„åŸå› ä¸‹è½½å¤±è´¥ï¼Œwget ä¼šä¸æ–­çš„å°è¯•ï¼Œç›´åˆ°æ•´ä¸ªæ–‡ä»¶ä¸‹è½½å®Œæ¯•ã€‚å¦‚æœæ˜¯æœåŠ¡å™¨æ‰“æ–­ä¸‹è½½è¿‡ç¨‹ï¼Œå®ƒä¼šå†æ¬¡è”åˆ°æœåŠ¡å™¨ä¸Šä»åœæ­¢çš„åœ°æ–¹ç»§ç»­ä¸‹è½½ã€‚è¿™å¯¹ä»é‚£äº›é™å®šäº†é“¾æ¥æ—¶é—´çš„æœåŠ¡å™¨ä¸Šä¸‹è½½å¤§æ–‡ä»¶éå¸¸æœ‰ç”¨ã€‚\n1ï¼å‘½ä»¤æ ¼å¼ï¼š\nwget [å‚æ•°][urlåœ°å€]\n2ï¼å‘½ä»¤åŠŸèƒ½ï¼š\nç”¨äºä»ç½‘ç»œä¸Šä¸‹è½½èµ„æºï¼Œæ²¡æœ‰æŒ‡å®šç›®å½•ï¼Œä¸‹è½½èµ„æºå›é»˜è®¤ä¸ºå½“å‰ç›®å½•ã€‚wget è™½ç„¶åŠŸèƒ½å¼ºå¤§ï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•ï¼š\n1ï¼‰æ”¯æŒæ–­ç‚¹ä¸‹ä¼ åŠŸèƒ½ï¼›è¿™ä¸€ç‚¹ï¼Œä¹Ÿæ˜¯ç½‘ç»œèš‚èšå’Œ FlashGet å½“å¹´æœ€å¤§çš„å–ç‚¹ï¼Œç°åœ¨ï¼ŒWget ä¹Ÿå¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œé‚£äº›ç½‘ç»œä¸æ˜¯å¤ªå¥½çš„ç”¨æˆ·å¯ä»¥æ”¾å¿ƒäº†ï¼›\n2ï¼‰åŒæ—¶æ”¯æŒ FTP å’Œ HTTP ä¸‹è½½æ–¹å¼ï¼›å°½ç®¡ç°åœ¨å¤§éƒ¨åˆ†è½¯ä»¶å¯ä»¥ä½¿ç”¨ HTTP æ–¹å¼ä¸‹è½½ï¼Œä½†æ˜¯ï¼Œæœ‰äº›æ—¶å€™ï¼Œä»ç„¶éœ€è¦ä½¿ç”¨ FTP æ–¹å¼ä¸‹è½½è½¯ä»¶ï¼›\n3ï¼‰æ”¯æŒä»£ç†æœåŠ¡å™¨ï¼›å¯¹å®‰å…¨å¼ºåº¦å¾ˆé«˜çš„ç³»ç»Ÿè€Œè¨€ï¼Œä¸€èˆ¬ä¸ä¼šå°†è‡ªå·±çš„ç³»ç»Ÿç›´æ¥æš´éœ²åœ¨äº’è”ç½‘ä¸Šï¼Œæ‰€ä»¥ï¼Œæ”¯æŒä»£ç†æ˜¯ä¸‹è½½è½¯ä»¶å¿…é¡»æœ‰çš„åŠŸèƒ½ï¼›\n4ï¼‰è®¾ç½®æ–¹ä¾¿ç®€å•ï¼›å¯èƒ½ï¼Œä¹ æƒ¯å›¾å½¢ç•Œé¢çš„ç”¨æˆ·å·²ç»ä¸æ˜¯å¤ªä¹ æƒ¯å‘½ä»¤è¡Œäº†ï¼Œä½†æ˜¯ï¼Œå‘½ä»¤è¡Œåœ¨è®¾ç½®ä¸Šå…¶å®æœ‰æ›´å¤šçš„ä¼˜ç‚¹ï¼Œæœ€å°‘ï¼Œé¼ æ ‡å¯ä»¥å°‘ç‚¹å¾ˆå¤šæ¬¡ï¼Œä¹Ÿä¸è¦æ‹…å¿ƒæ˜¯å¦é”™ç‚¹é¼ æ ‡ï¼›\n5ï¼‰ç¨‹åºå°ï¼Œå®Œå…¨å…è´¹ï¼›ç¨‹åºå°å¯ä»¥è€ƒè™‘ä¸è®¡ï¼Œå› ä¸ºç°åœ¨çš„ç¡¬ç›˜å®åœ¨å¤ªå¤§äº†ï¼›å®Œå…¨å…è´¹å°±ä¸å¾—ä¸è€ƒè™‘äº†ï¼Œå³ä½¿ç½‘ç»œä¸Šæœ‰å¾ˆå¤šæ‰€è°“çš„å…è´¹è½¯ä»¶ï¼Œä½†æ˜¯ï¼Œè¿™äº›è½¯ä»¶çš„å¹¿å‘Šå´ä¸æ˜¯æˆ‘ä»¬å–œæ¬¢çš„ã€‚\n3ï¼å‘½ä»¤å‚æ•°ï¼š\nå¯åŠ¨å‚æ•°ï¼š\n-V, â€“version æ˜¾ç¤º wget çš„ç‰ˆæœ¬åé€€å‡º -h, â€“help æ‰“å°è¯­æ³•å¸®åŠ© -b, â€“background å¯åŠ¨åè½¬å…¥åå°æ‰§è¡Œ -e, â€“execute=COMMAND æ‰§è¡Œ.wgetrcæ ¼å¼çš„å‘½ä»¤ï¼Œwgetrc æ ¼å¼å‚è§/etc/wgetrc æˆ–~/.wgetrc è®°å½•å’Œè¾“å…¥æ–‡ä»¶å‚æ•°ï¼š\n-o, â€“output-file=FILE æŠŠè®°å½•å†™åˆ° FILE æ–‡ä»¶ä¸­ -a, â€“append-output=FILE æŠŠè®°å½•è¿½åŠ åˆ° FILE æ–‡ä»¶ä¸­ -d, â€“debug æ‰“å°è°ƒè¯•è¾“å‡º -q, â€“quiet å®‰é™æ¨¡å¼(æ²¡æœ‰è¾“å‡º) -v, â€“verbose å†—é•¿æ¨¡å¼(è¿™æ˜¯ç¼ºçœè®¾ç½®) -nv, â€“non-verbose å…³æ‰å†—é•¿æ¨¡å¼ï¼Œä½†ä¸æ˜¯å®‰é™æ¨¡å¼ -i, â€“input-file=FILE ä¸‹è½½åœ¨ FILE æ–‡ä»¶ä¸­å‡ºç°çš„ URLs -F, â€“force-html æŠŠè¾“å…¥æ–‡ä»¶å½“ä½œ HTML æ ¼å¼æ–‡ä»¶å¯¹å¾… -B, â€“base=URL å°† URL ä½œä¸ºåœ¨-F -i å‚æ•°æŒ‡å®šçš„æ–‡ä»¶ä¸­å‡ºç°çš„ç›¸å¯¹é“¾æ¥çš„å‰ç¼€ â€“sslcertfile=FILE å¯é€‰å®¢æˆ·ç«¯è¯ä¹¦ â€“sslcertkey=KEYFILE å¯é€‰å®¢æˆ·ç«¯è¯ä¹¦çš„ KEYFILE â€“egd-file=FILE æŒ‡å®š EGD socket çš„æ–‡ä»¶å ä¸‹è½½å‚æ•°ï¼š\nâ€“bind-address=ADDRESS æŒ‡å®šæœ¬åœ°ä½¿ç”¨åœ°å€(ä¸»æœºåæˆ– IPï¼Œå½“æœ¬åœ°æœ‰å¤šä¸ª IP æˆ–åå­—æ—¶ä½¿ç”¨) -t, â€“tries=NUMBER è®¾å®šæœ€å¤§å°è¯•é“¾æ¥æ¬¡æ•°(0 è¡¨ç¤ºæ— é™åˆ¶). -O â€“output-document=FILE æŠŠæ–‡æ¡£å†™åˆ° FILE æ–‡ä»¶ä¸­ -nc, â€“no-clobber ä¸è¦è¦†ç›–å­˜åœ¨çš„æ–‡ä»¶æˆ–ä½¿ç”¨.#å‰ç¼€ -c, â€“continue æ¥ç€ä¸‹è½½æ²¡ä¸‹è½½å®Œçš„æ–‡ä»¶ â€“progress=TYPE è®¾å®šè¿›ç¨‹æ¡æ ‡è®° -N, â€“timestamping ä¸è¦é‡æ–°ä¸‹è½½æ–‡ä»¶é™¤éæ¯”æœ¬åœ°æ–‡ä»¶æ–° -S, â€“server-response æ‰“å°æœåŠ¡å™¨çš„å›åº” â€“spider ä¸ä¸‹è½½ä»»ä½•ä¸œè¥¿ -T, â€“timeout=SECONDS è®¾å®šå“åº”è¶…æ—¶çš„ç§’æ•° -w, â€“wait=SECONDS ä¸¤æ¬¡å°è¯•ä¹‹é—´é—´éš” SECONDS ç§’ â€“waitretry=SECONDS åœ¨é‡æ–°é“¾æ¥ä¹‹é—´ç­‰å¾… 1â€¦SECONDS ç§’ â€“random-wait åœ¨ä¸‹è½½ä¹‹é—´ç­‰å¾… 0â€¦2*WAIT ç§’ -Y, â€“proxy=on/off æ‰“å¼€æˆ–å…³é—­ä»£ç† -Q, â€“quota=NUMBER è®¾ç½®ä¸‹è½½çš„å®¹é‡é™åˆ¶ â€“limit-rate=RATE é™å®šä¸‹è½½è¾“ç‡ ç›®å½•å‚æ•°ï¼š\n-nd â€“no-directories ä¸åˆ›å»ºç›®å½• -x, â€“force-directories å¼ºåˆ¶åˆ›å»ºç›®å½• -nH, â€“no-host-directories ä¸åˆ›å»ºä¸»æœºç›®å½• -P, â€“directory-prefix=PREFIX å°†æ–‡ä»¶ä¿å­˜åˆ°ç›®å½• PREFIX/â€¦ â€“cut-dirs=NUMBER å¿½ç•¥ NUMBER å±‚è¿œç¨‹ç›®å½• HTTP é€‰é¡¹å‚æ•°ï¼š\nâ€“http-user=USER è®¾å®š HTTP ç”¨æˆ·åä¸º USER. â€“http-passwd=PASS è®¾å®š http å¯†ç ä¸º PASS -C, â€“cache=on/off å…è®¸/ä¸å…è®¸æœåŠ¡å™¨ç«¯çš„æ•°æ®ç¼“å­˜ (ä¸€èˆ¬æƒ…å†µä¸‹å…è®¸) -E, â€“html-extension å°†æ‰€æœ‰ text/html æ–‡æ¡£ä»¥.html æ‰©å±•åä¿å­˜ â€“ignore-length å¿½ç•¥ Content-Lengthå¤´åŸŸ â€“header=STRING åœ¨ headers ä¸­æ’å…¥å­—ç¬¦ä¸² STRING â€“proxy-user=USER è®¾å®šä»£ç†çš„ç”¨æˆ·åä¸º USER â€“proxy-passwd=PASS è®¾å®šä»£ç†çš„å¯†ç ä¸º PASS â€“referer=URL åœ¨ HTTP è¯·æ±‚ä¸­åŒ…å« Referer: URLå¤´ -s, â€“save-headers ä¿å­˜ HTTP å¤´åˆ°æ–‡ä»¶ -U, â€“user-agent=AGENT è®¾å®šä»£ç†çš„åç§°ä¸º AGENT è€Œä¸æ˜¯ Wget/VERSION â€“no-http-keep-alive å…³é—­ HTTP æ´»åŠ¨é“¾æ¥ (æ°¸è¿œé“¾æ¥) â€“cookies=off ä¸ä½¿ç”¨ cookies â€“load-cookies=FILE åœ¨å¼€å§‹ä¼šè¯å‰ä»æ–‡ä»¶ FILE ä¸­åŠ è½½ cookie â€“save-cookies=FILE åœ¨ä¼šè¯ç»“æŸåå°† cookies ä¿å­˜åˆ° FILE æ–‡ä»¶ä¸­ FTP é€‰é¡¹å‚æ•°ï¼š\n-nr, â€“dont-remove-listing ä¸ç§»èµ° .listingæ–‡ä»¶ -g, â€“glob=on/off æ‰“å¼€æˆ–å…³é—­æ–‡ä»¶åçš„ globbing æœºåˆ¶ â€“passive-ftp ä½¿ç”¨è¢«åŠ¨ä¼ è¾“æ¨¡å¼ (ç¼ºçœå€¼). â€“active-ftp ä½¿ç”¨ä¸»åŠ¨ä¼ è¾“æ¨¡å¼ â€“retr-symlinks åœ¨é€’å½’çš„æ—¶å€™ï¼Œå°†é“¾æ¥æŒ‡å‘æ–‡ä»¶(è€Œä¸æ˜¯ç›®å½•) é€’å½’ä¸‹è½½å‚æ•°ï¼š\n-r, â€“recursive é€’å½’ä¸‹è½½ï¼ï¼æ…ç”¨! -l, â€“level=NUMBER æœ€å¤§é€’å½’æ·±åº¦ (inf æˆ– 0 ä»£è¡¨æ— ç©·) â€“delete-after åœ¨ç°åœ¨å®Œæ¯•åå±€éƒ¨åˆ é™¤æ–‡ä»¶ -k, â€“convert-links è½¬æ¢éç›¸å¯¹é“¾æ¥ä¸ºç›¸å¯¹é“¾æ¥ -K, â€“backup-converted åœ¨è½¬æ¢æ–‡ä»¶ X ä¹‹å‰ï¼Œå°†ä¹‹å¤‡ä»½ä¸º X.orig -m, â€“mirror ç­‰ä»·äº -r -N -l inf -nr -p, â€“page-requisites ä¸‹è½½æ˜¾ç¤º HTML æ–‡ä»¶çš„æ‰€æœ‰å›¾ç‰‡ é€’å½’ä¸‹è½½ä¸­çš„åŒ…å«å’Œä¸åŒ…å«(accept/reject)ï¼š\n-A, â€“accept=LIST åˆ†å·åˆ†éš”çš„è¢«æ¥å—æ‰©å±•åçš„åˆ—è¡¨ -R, â€“reject=LIST åˆ†å·åˆ†éš”çš„ä¸è¢«æ¥å—çš„æ‰©å±•åçš„åˆ—è¡¨ -D, â€“domains=LIST åˆ†å·åˆ†éš”çš„è¢«æ¥å—åŸŸçš„åˆ—è¡¨ â€“exclude-domains=LIST åˆ†å·åˆ†éš”çš„ä¸è¢«æ¥å—çš„åŸŸçš„åˆ—è¡¨ â€“follow-ftp è·Ÿè¸ª HTML æ–‡æ¡£ä¸­çš„ FTP é“¾æ¥ â€“follow-tags=LIST åˆ†å·åˆ†éš”çš„è¢«è·Ÿè¸ªçš„ HTML æ ‡ç­¾çš„åˆ—è¡¨ -G, â€“ignore-tags=LIST åˆ†å·åˆ†éš”çš„è¢«å¿½ç•¥çš„ HTML æ ‡ç­¾çš„åˆ—è¡¨ -H, â€“span-hosts å½“é€’å½’æ—¶è½¬åˆ°å¤–éƒ¨ä¸»æœº -L, â€“relative ä»…ä»…è·Ÿè¸ªç›¸å¯¹é“¾æ¥ -I, â€“include-directories=LIST å…è®¸ç›®å½•çš„åˆ—è¡¨ -X, â€“exclude-directories=LIST ä¸è¢«åŒ…å«ç›®å½•çš„åˆ—è¡¨ -np, â€“no-parent ä¸è¦è¿½æº¯åˆ°çˆ¶ç›®å½• wget -S â€“spider url ä¸ä¸‹è½½åªæ˜¾ç¤ºè¿‡ç¨‹ 4ï¼ä½¿ç”¨å®ä¾‹ï¼š\nå®ä¾‹ 1ï¼šä½¿ç”¨ wget ä¸‹è½½å•ä¸ªæ–‡ä»¶\nå‘½ä»¤ï¼š\nwget http://www.linuxidc.com/linuxidc.zip\nè¯´æ˜ï¼š\nä»¥ä¸‹çš„ä¾‹å­æ˜¯ä»ç½‘ç»œä¸‹è½½ä¸€ä¸ªæ–‡ä»¶å¹¶ä¿å­˜åœ¨å½“å‰ç›®å½•ï¼Œåœ¨ä¸‹è½½çš„è¿‡ç¨‹ä¸­ä¼šæ˜¾ç¤ºè¿›åº¦æ¡ï¼ŒåŒ…å«ï¼ˆä¸‹è½½å®Œæˆç™¾åˆ†æ¯”ï¼Œå·²ç»ä¸‹è½½çš„å­—èŠ‚ï¼Œå½“å‰ä¸‹è½½é€Ÿåº¦ï¼Œå‰©ä½™ä¸‹è½½æ—¶é—´ï¼‰ã€‚\nå®ä¾‹ 2ï¼šä½¿ç”¨ wget -O ä¸‹è½½å¹¶ä»¥ä¸åŒçš„æ–‡ä»¶åä¿å­˜\nå‘½ä»¤ï¼š\nwget -O wordpress.zip http://www.linuxidc.com/download.aspx?id=1080\nè¯´æ˜ï¼š\nwget é»˜è®¤ä¼šä»¥æœ€åä¸€ä¸ªç¬¦åˆâ€/â€çš„åé¢çš„å­—ç¬¦æ¥å‘½ä»¤ï¼Œå¯¹äºåŠ¨æ€é“¾æ¥çš„ä¸‹è½½é€šå¸¸æ–‡ä»¶åä¼šä¸æ­£ç¡®ã€‚\né”™è¯¯ï¼šä¸‹é¢çš„ä¾‹å­ä¼šä¸‹è½½ä¸€ä¸ªæ–‡ä»¶å¹¶ä»¥åç§° download.aspx?id=1080 ä¿å­˜\nwget http://www.linuxidc.com/download?id=1\nå³ä½¿ä¸‹è½½çš„æ–‡ä»¶æ˜¯ zip æ ¼å¼ï¼Œå®ƒä»ç„¶ä»¥ download.php?id=1080 å‘½ä»¤ã€‚\næ­£ç¡®ï¼šä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‚æ•°-O æ¥æŒ‡å®šä¸€ä¸ªæ–‡ä»¶åï¼š\nwget -O wordpress.zip http://www.linuxidc.com/download.aspx?id=1080\nå®ä¾‹ 3ï¼šä½¿ç”¨ wget â€“limit -rate é™é€Ÿä¸‹è½½\nå‘½ä»¤ï¼š\nwget \u0026ndash;limit-rate=300k http://www.linuxidc.com/linuxidc.zip\nè¯´æ˜ï¼š\nå½“ä½ æ‰§è¡Œ wget çš„æ—¶å€™ï¼Œå®ƒé»˜è®¤ä¼šå ç”¨å…¨éƒ¨å¯èƒ½çš„å®½å¸¦ä¸‹è½½ã€‚ä½†æ˜¯å½“ä½ å‡†å¤‡ä¸‹è½½ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œè€Œä½ è¿˜éœ€è¦ä¸‹è½½å…¶å®ƒæ–‡ä»¶æ—¶å°±æœ‰å¿…è¦é™é€Ÿäº†ã€‚\nå®ä¾‹ 4ï¼šä½¿ç”¨ wget -c æ–­ç‚¹ç»­ä¼ \nå‘½ä»¤ï¼š\nwget -c http://www.linuxidc.com/linuxidc.zip\nè¯´æ˜ï¼š\nä½¿ç”¨ wget -c é‡æ–°å¯åŠ¨ä¸‹è½½ä¸­æ–­çš„æ–‡ä»¶ï¼Œå¯¹äºæˆ‘ä»¬ä¸‹è½½å¤§æ–‡ä»¶æ—¶çªç„¶ç”±äºç½‘ç»œç­‰åŸå› ä¸­æ–­éå¸¸æœ‰å¸®åŠ©ï¼Œæˆ‘ä»¬å¯ä»¥ç»§ç»­æ¥ç€ä¸‹è½½è€Œä¸æ˜¯é‡æ–°ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶ã€‚éœ€è¦ç»§ç»­ä¸­æ–­çš„ä¸‹è½½æ—¶å¯ä»¥ä½¿ç”¨-c å‚æ•°ã€‚\nå®ä¾‹ 5ï¼šä½¿ç”¨ wget -b åå°ä¸‹è½½\nå‘½ä»¤ï¼š\nwget -b http://www.linuxidc.com/linuxidc.zip\nè¯´æ˜ï¼š\nå¯¹äºä¸‹è½½éå¸¸å¤§çš„æ–‡ä»¶çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‚æ•°-b è¿›è¡Œåå°ä¸‹è½½ã€‚\nwget -b http://www.linuxidc.com/linuxidc.zip\nContinuing in background, pid 1840.\nOutput will be written to wget-log.\nä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ¥å¯Ÿçœ‹ä¸‹è½½è¿›åº¦ï¼š\ntail -f wget-log\nå®ä¾‹ 6ï¼šä¼ªè£…ä»£ç†åç§°ä¸‹è½½\nå‘½ä»¤ï¼š\nwget \u0026ndash;user-agent=\u0026ldquo;Mozilla/5.0 (Windows; U; Windows NT 6.1; en-US) AppleWebKit/534.16 (KHTML, like Gecko) Chrome/10.0.648.204 Safari/534.16\u0026rdquo; http://www.linuxidc.com/linuxidc.zip\nè¯´æ˜ï¼š\næœ‰äº›ç½‘ç«™èƒ½é€šè¿‡æ ¹æ®åˆ¤æ–­ä»£ç†åç§°ä¸æ˜¯æµè§ˆå™¨è€Œæ‹’ç»ä½ çš„ä¸‹è½½è¯·æ±‚ã€‚ä¸è¿‡ä½ å¯ä»¥é€šè¿‡â€“user-agent å‚æ•°ä¼ªè£…ã€‚\nå®ä¾‹ 7ï¼šä½¿ç”¨ wget â€“spider æµ‹è¯•ä¸‹è½½é“¾æ¥\nå‘½ä»¤ï¼š\nwget \u0026ndash;spider URL\nè¯´æ˜ï¼š\nå½“ä½ æ‰“ç®—è¿›è¡Œå®šæ—¶ä¸‹è½½ï¼Œä½ åº”è¯¥åœ¨é¢„å®šæ—¶é—´æµ‹è¯•ä¸‹è½½é“¾æ¥æ˜¯å¦æœ‰æ•ˆã€‚æˆ‘ä»¬å¯ä»¥å¢åŠ â€“spider å‚æ•°è¿›è¡Œæ£€æŸ¥ã€‚\nwget \u0026ndash;spider URL\nå¦‚æœä¸‹è½½é“¾æ¥æ­£ç¡®ï¼Œå°†ä¼šæ˜¾ç¤º\nwget --spider URL\rSpider mode enabled. Check if remote file exists.\rHTTP request sent, awaiting response... 200 OK\rLength: unspecified [text/html]\rRemote file exists and could contain further links,\rbut recursion is disabled -- not retrieving.\rè¿™ä¿è¯äº†ä¸‹è½½èƒ½åœ¨é¢„å®šçš„æ—¶é—´è¿›è¡Œï¼Œä½†å½“ä½ ç»™é”™äº†ä¸€ä¸ªé“¾æ¥ï¼Œå°†ä¼šæ˜¾ç¤ºå¦‚ä¸‹é”™è¯¯\rwget --spider url\rSpider mode enabled. Check if remote file exists.\rHTTP request sent, awaiting response... 404 Not Found\rRemote file does not exist -- broken link!!! ä½ å¯ä»¥åœ¨ä»¥ä¸‹å‡ ç§æƒ…å†µä¸‹ä½¿ç”¨ spider å‚æ•°ï¼š\nå®šæ—¶ä¸‹è½½ä¹‹å‰è¿›è¡Œæ£€æŸ¥\né—´éš”æ£€æµ‹ç½‘ç«™æ˜¯å¦å¯ç”¨\næ£€æŸ¥ç½‘ç«™é¡µé¢çš„æ­»é“¾æ¥\nå®ä¾‹ 8ï¼šä½¿ç”¨ wget â€“tries å¢åŠ é‡è¯•æ¬¡æ•°\nå‘½ä»¤ï¼š\nwget \u0026ndash;tries=40 URL\nè¯´æ˜ï¼š\nå¦‚æœç½‘ç»œæœ‰é—®é¢˜æˆ–ä¸‹è½½ä¸€ä¸ªå¤§æ–‡ä»¶ä¹Ÿæœ‰å¯èƒ½å¤±è´¥ã€‚wget é»˜è®¤é‡è¯• 20 æ¬¡è¿æ¥ä¸‹è½½æ–‡ä»¶ã€‚å¦‚æœéœ€è¦ï¼Œä½ å¯ä»¥ä½¿ç”¨â€“tries å¢åŠ é‡è¯•æ¬¡æ•°ã€‚\nå®ä¾‹ 9ï¼šä½¿ç”¨ wget -i ä¸‹è½½å¤šä¸ªæ–‡ä»¶\nå‘½ä»¤ï¼š\nwget -i filelist.txt\nè¯´æ˜ï¼š\né¦–å…ˆï¼Œä¿å­˜ä¸€ä»½ä¸‹è½½é“¾æ¥æ–‡ä»¶\ncat \u0026gt; filelist.txt\nurl1\nurl2\nurl3\nurl4\næ¥ç€ä½¿ç”¨è¿™ä¸ªæ–‡ä»¶å’Œå‚æ•°-i ä¸‹è½½\nå®ä¾‹ 10ï¼šä½¿ç”¨ wget â€“mirror é•œåƒç½‘ç«™\nå‘½ä»¤ï¼š\nwget \u0026ndash;mirror -p \u0026ndash;convert-links -P ./LOCAL URL\nè¯´æ˜ï¼š\nä¸‹è½½æ•´ä¸ªç½‘ç«™åˆ°æœ¬åœ°ã€‚\nâ€“miror:å¼€æˆ·é•œåƒä¸‹è½½\n-p:ä¸‹è½½æ‰€æœ‰ä¸ºäº† html é¡µé¢æ˜¾ç¤ºæ­£å¸¸çš„æ–‡ä»¶\nâ€“convert-links:ä¸‹è½½åï¼Œè½¬æ¢æˆæœ¬åœ°çš„é“¾æ¥\n-P ./LOCALï¼šä¿å­˜æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•åˆ°æœ¬åœ°æŒ‡å®šç›®å½•\nå®ä¾‹ 11ï¼šä½¿ç”¨ wget â€“reject è¿‡æ»¤æŒ‡å®šæ ¼å¼ä¸‹è½½\nå‘½ä»¤ï¼š\nwget \u0026ndash;reject=gif ur\nè¯´æ˜ï¼š\nä¸‹è½½ä¸€ä¸ªç½‘ç«™ï¼Œä½†ä½ ä¸å¸Œæœ›ä¸‹è½½å›¾ç‰‡ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ã€‚\nå®ä¾‹ 12ï¼šä½¿ç”¨ wget -o æŠŠä¸‹è½½ä¿¡æ¯å­˜å…¥æ—¥å¿—æ–‡ä»¶\nå‘½ä»¤ï¼š\nwget -o download.log URL\nè¯´æ˜ï¼š\nä¸å¸Œæœ›ä¸‹è½½ä¿¡æ¯ç›´æ¥æ˜¾ç¤ºåœ¨ç»ˆç«¯è€Œæ˜¯åœ¨ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨\nå®ä¾‹ 13ï¼šä½¿ç”¨ wget -Q é™åˆ¶æ€»ä¸‹è½½æ–‡ä»¶å¤§å°\nå‘½ä»¤ï¼š\nwget -Q5m -i filelist.txt\nè¯´æ˜ï¼š\nå½“ä½ æƒ³è¦ä¸‹è½½çš„æ–‡ä»¶è¶…è¿‡ 5M è€Œé€€å‡ºä¸‹è½½ï¼Œä½ å¯ä»¥ä½¿ç”¨ã€‚æ³¨æ„ï¼šè¿™ä¸ªå‚æ•°å¯¹å•ä¸ªæ–‡ä»¶ä¸‹è½½ä¸èµ·ä½œç”¨ï¼Œåªèƒ½é€’å½’ä¸‹è½½æ—¶æ‰æœ‰æ•ˆã€‚\nå®ä¾‹ 14ï¼šä½¿ç”¨ wget -r -A ä¸‹è½½æŒ‡å®šæ ¼å¼æ–‡ä»¶\nå‘½ä»¤ï¼š\nwget -r -A.pdf url\nè¯´æ˜ï¼š\nå¯ä»¥åœ¨ä»¥ä¸‹æƒ…å†µä½¿ç”¨è¯¥åŠŸèƒ½ï¼š\nä¸‹è½½ä¸€ä¸ªç½‘ç«™çš„æ‰€æœ‰å›¾ç‰‡\nä¸‹è½½ä¸€ä¸ªç½‘ç«™çš„æ‰€æœ‰è§†é¢‘\nä¸‹è½½ä¸€ä¸ªç½‘ç«™çš„æ‰€æœ‰ PDF æ–‡ä»¶\nå®ä¾‹ 15ï¼šä½¿ç”¨ wget FTP ä¸‹è½½\nå‘½ä»¤ï¼š\nwget ftp-url\nwget \u0026ndash;ftp-user=USERNAME \u0026ndash;ftp-password=PASSWORD url\nè¯´æ˜ï¼š\nå¯ä»¥ä½¿ç”¨ wget æ¥å®Œæˆ ftp é“¾æ¥çš„ä¸‹è½½ã€‚\nä½¿ç”¨ wget åŒ¿å ftp ä¸‹è½½ï¼š\nwget ftp-url\nä½¿ç”¨ wget ç”¨æˆ·åå’Œå¯†ç è®¤è¯çš„ ftp ä¸‹è½½\nwget \u0026ndash;ftp-user=USERNAME \u0026ndash;ftp-password=PASSWORD url\nå¤‡æ³¨ï¼šç¼–è¯‘å®‰è£…\nä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘å®‰è£…ï¼š\ntar zxvf wget-1.9.1.tar.gz cd wget-1.9.1 ./configure make make install ","date":"2018-06-22T10:56:46Z","permalink":"https://dccmmtop.github.io/posts/wget%E6%95%B4%E7%AB%99%E4%B8%8B%E8%BD%BD/","section":"posts","tags":["linux"],"title":"wgetæ•´ç«™ä¸‹è½½"},{"categories":null,"contents":"æ·»åŠ æ–°ç”¨æˆ· åœ¨æœåŠ¡å™¨æ·»åŠ ä¸€ä¸ªæ–°çš„ç”¨æˆ·ï¼Œç”¨æˆ·åä¸º deployæ•™ç¨‹\næ‰§è¡Œå‘½ä»¤sudo adduser ç”¨æˆ·å\næŒ‰æç¤ºè¾“å…¥å¯†ç \nè®¾ç½®ä¸€äº›ä¸ªäººä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥æŒ‰ enter é”®ï¼Œè®¾ä¸ºç©º\næ·»åŠ æƒé™\nåœ¨ root ç”¨æˆ·ä¸‹ï¼Œæ‰“å¼€/etc/sudoersæ–‡ä»¶\n# # This file MUST be edited with the \u0026#39;visudo\u0026#39; command as root. # # Please consider adding local content in /etc/sudoers.d/ instead of # directly modifying this file. # # See the man page for details on how to write a sudoers file. # Defaults env_reset Defaults mail_badpass Defaults secure_path=\u0026#34;/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin\u0026#34; # Host alias specification # User alias specification # Cmnd alias specification # User privilege specification root ALL=(ALL:ALL) ALL deploy ALL=(ALL:ALL) ALL # æ·»åŠ è¿™ä¸€è¡Œï¼Œä½¿deployå…·æœ‰ä½¿ç”¨sudoçš„æƒé™ # Members of the admin group may gain root privileges %admin ALL=(ALL) ALL # Allow members of group sudo to execute any command %sudo ALL=(ALL:ALL) ALL # See sudoers(5) for more information on \u0026#34;#include\u0026#34; directives: #includedir /etc/sudoers.d ruby å®‰è£… å®‰è£…rbenv æ•™ç¨‹æ¥æº\nsudo deployå›åˆ° deploy ä¸‹\ngit clone https://github.com/rbenv/rbenv.git ~/.rbenv # ç”¨æ¥ç¼–è¯‘å®‰è£… ruby git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build # ç”¨æ¥ç®¡ç† gemset, å¯é€‰, å› ä¸ºæœ‰ bundler ä¹Ÿæ²¡ä»€ä¹ˆå¿…è¦ git clone git://github.com/jamis/rbenv-gemset.git ~/.rbenv/plugins/rbenv-gemset # é€šè¿‡ rbenv update å‘½ä»¤æ¥æ›´æ–° rbenv ä»¥åŠæ‰€æœ‰æ’ä»¶, æ¨è git clone git://github.com/rkh/rbenv-update.git ~/.rbenv/plugins/rbenv-update # ä½¿ç”¨ Ruby China çš„é•œåƒå®‰è£… Ruby, å›½å†…ç”¨æˆ·æ¨è git clone git://github.com/AndorChen/rbenv-china-mirror.git ~/.rbenv/plugins/rbenv-china-mirror ç„¶åæŠŠä¸‹é¢çš„ä»£ç æ”¾åˆ° ~/.bashrc é‡Œ\nexport PATH=\u0026#34;$HOME/.rbenv/bin:$PATH\u0026#34; eval \u0026#34;$(rbenv init -)\u0026#34; ç„¶åé‡å¼€ä¸€ä¸ªç»ˆç«¯å°±å¯ä»¥æ‰§è¡Œ rbenv äº†.\nå®‰è£… ruby\nrbenv install --list # åˆ—å‡ºæ‰€æœ‰ ruby ç‰ˆæœ¬ rbenv install 2.5.0 # å®‰è£… 2.5.0 å®‰è½¬è¿‡ç¨‹å¯èƒ½å‡ºç°ç¼ºå°‘ä¾èµ–çš„é”™è¯¯ï¼Œå¯å‚è€ƒè¿™ç¯‡æ–‡ç« è§£å†³\nä¸€èˆ¬è§£å†³åŠæ³•:\nsudo apt-get install autoconf bison build-essential libssl-dev libyaml-dev libreadline6 libreadline6-dev zlib1g zlib1g-dev éªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸ\nrbenv versions # åˆ—å‡ºå®‰è£…çš„ç‰ˆæœ¬ rbenv version # åˆ—å‡ºæ­£åœ¨ä½¿ç”¨çš„ç‰ˆæœ¬ è®¾ç½®ç‰ˆæœ¬\nrbenv global 2.5.0 # é»˜è®¤ä½¿ç”¨ 2.5.0 rbenv shell 2.5.0 # å½“å‰çš„ shell ä½¿ç”¨ 2.5.0, ä¼šè®¾ç½®ä¸€ä¸ª `RBENV_VERSION` ç¯å¢ƒå˜é‡ rbenv local jruby-1.7.3 # å½“å‰ç›®å½•ä½¿ç”¨ jruby-1.7.3, ä¼šç”Ÿæˆä¸€ä¸ª `.rbenv-version` æ–‡ä»¶ last\nrbenv rehash # æ¯å½“åˆ‡æ¢ ruby ç‰ˆæœ¬å’Œæ‰§è¡Œ bundle install ä¹‹åå¿…é¡»æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ rbenv which irb # åˆ—å‡º irb è¿™ä¸ªå‘½ä»¤çš„å®Œæ•´è·¯å¾„ rbenv whence irb # åˆ—å‡ºåŒ…å« irb è¿™ä¸ªå‘½ä»¤çš„ç‰ˆæœ¬ å®‰è£…bundle\ngem install bundle å®‰è£…rails\ngem install rails å®‰è£… nodejs\ncurl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash - sudo apt-get install -y nodejs æ•°æ®åº“ ä½¿ç”¨ postgresql æ•°æ®åº“æ•™ç¨‹æ¥æº\nsudo apt-get install postgresql æ–°å»ºæ•°æ®åº“ç”¨æˆ·\nsudo -i -u postgres //åˆ‡æ¢åˆ°æ•°æ®åº“çš„è¶…çº§ç®¡ç†å‘˜ psql //è¿›å…¥æ•°æ®åº“æ§åˆ¶å° create user deploy with password \u0026#39;xxxx\u0026#39;; //æ–°å»ºä¸€ä¸ªdeployç”¨æˆ·ï¼Œå¯†ç æ˜¯xxx alter role deploy with createdb; //ä½¿deployç”¨æˆ·å…·æœ‰åˆ›å»ºæ•°æ®åº“çš„æƒé™ alter role deploy with loginï¼›//ä½¿deployç”¨æˆ·å…·æœ‰ç™»å½•æ•°æ®åº“çš„æƒé™ æ³¨æ„ï¼š\nåœ¨åé¢å®‰è£… pg gem æ—¶ï¼Œå¯èƒ½ä¼šå‡ºç°You need to install postgresql-server-dev-X.Y for building a server-side extension or libpq-dev for building a client-side applic ationé”™è¯¯,ä¾æ¬¡æ‰§è¡Œï¼š\nsudo apt-get install python-psycopg2 sudo apt-get install libpq-dev nginx passenger å®‰è£… è¿™é‡Œå¾ˆè¯¦ç»†äº†\nsudo apt-get install -y dirmngr gnupg sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 561F9B9CAC40B2F7 sudo apt-get install -y apt-transport-https ca-certificates sudo sh -c \u0026#39;echo deb https://oss-binaries.phusionpassenger.com/apt/passenger xenial main \u0026gt; /etc/apt/sources.list.d/passenger.list\u0026#39; sudo apt-get update sudo apt-get install -y nginx-extras passenger passenger çš„é…ç½®\nnginx å®‰è£…ä»¥åï¼Œæ‰“å¼€/etc/nginx/passenger.confä¼šçœ‹åˆ°\npassenger_root /usr/lib/ruby/vendor_ruby/phusion_passenger/locations.ini;\rpassenger_ruby /home/deploy/.rbenv/shims/ruby; //è¿™é‡Œéœ€è¦ä¿®æ”¹rubyçš„å®‰è£…è·¯å¾„ which ruby å¯ä»¥æŸ¥çœ‹ ruby çš„è·¯å¾„\nCapistrano é…ç½®åŸæ–‡æ•™ç¨‹ å®‰è£…å¿…è¦çš„åŒ…\ngroup :development do gem \u0026#39;capistrano\u0026#39; gem \u0026#39;capistrano-bundler\u0026#39; gem \u0026#39;capistrano-rails\u0026#39; gem \u0026#39;capistrano-rbenv\u0026#39; # Add this if you\u0026#39;re using rvm # gem \u0026#39;capistrano-rvm\u0026#39; end cap install\næˆ‘çš„ capfile æ–‡ä»¶\n# Load DSL and set up stages require \u0026#34;capistrano/setup\u0026#34; # Include default deployment tasks require \u0026#34;capistrano/deploy\u0026#34; # Load the SCM plugin appropriate to your project: # # require \u0026#34;capistrano/scm/hg\u0026#34; # install_plugin Capistrano::SCM::Hg # or # require \u0026#34;capistrano/scm/svn\u0026#34; # install_plugin Capistrano::SCM::Svn # or require \u0026#34;capistrano/scm/git\u0026#34; install_plugin Capistrano::SCM::Git # Include tasks from other gems included in your Gemfile # # For documentation on these, see for example: # # https://github.com/capistrano/rvm # https://github.com/capistrano/rbenv # https://github.com/capistrano/chruby # https://github.com/capistrano/bundler # https://github.com/capistrano/rails # https://github.com/capistrano/passenger # # require \u0026#34;capistrano/rvm\u0026#34; require \u0026#34;capistrano/rbenv\u0026#34; # require \u0026#34;capistrano/chruby\u0026#34; require \u0026#34;capistrano/bundler\u0026#34; require \u0026#34;capistrano/rails/assets\u0026#34; require \u0026#34;capistrano/rails/migrations\u0026#34; require \u0026#34;capistrano/passenger\u0026#34; set :rbenv_type, :user set :rbenv_ruby, \u0026#39;2.5.0\u0026#39; # Load custom tasks from `lib/capistrano/tasks` if you have any defined Dir.glob(\u0026#34;lib/capistrano/tasks/*.rake\u0026#34;).each { |r| import r } æˆ‘çš„ deploy.rb æ–‡ä»¶\n# config valid for current version and patch releases of Capistrano lock \u0026#34;~\u0026gt; 3.10.2\u0026#34; set :application, \u0026#34;script_blog\u0026#34; set :repo_url, \u0026#34;https://github.com/dccmmtop/script_blog.git\u0026#34; # Default branch is :master # ask :branch, `git rev-parse --abbrev-ref HEAD`.chomp # Default deploy_to directory is /var/www/my_app_name set :deploy_to, \u0026#34;/home/deploy/scrit_blog\u0026#34; # Default value for :format is :airbrussh. # set :format, :airbrussh # You can configure the Airbrussh format using :format_options. # These are the defaults. # set :format_options, command_output: true, log_file: \u0026#34;log/capistrano.log\u0026#34;, color: :auto, truncate: :auto # Default value for :pty is false # set :pty, true # Default value for :linked_files is [] # åœ¨æœåŠ¡å™¨\u0026lt;project-name\u0026gt;/share/config/ ä¸‹ï¼Œè¦æ‰‹åŠ¨æ–°å»ºè¿™ä¸¤ä¸ªæ–‡ä»¶ï¼Œ append :linked_files, \u0026#34;config/database.yml\u0026#34;,\u0026#34;config/secrets.yml\u0026#34; # Default value for linked_dirs is [] append :linked_dirs, \u0026#34;log\u0026#34;, \u0026#34;tmp/pids\u0026#34;, \u0026#34;tmp/cache\u0026#34;, \u0026#34;tmp/sockets\u0026#34;, \u0026#34;public/system\u0026#34; # Default value for default_env is {} # set :default_env, { path: \u0026#34;/opt/ruby/bin:$PATH\u0026#34; } # Default value for local_user is ENV[\u0026#39;USER\u0026#39;] # set :local_user, -\u0026gt; { `git config user.name`.chomp } # Default value for keep_releases is 5 # set :keep_releases, 5 # Uncomment the following to require manually verifying the host key before first deploy. # set :ssh_options, verify_host_key: :secure æ³¨æ„append :linked_files, \u0026quot;config/database.yml\u0026quot;,\u0026quot;config/secrets.yml\u0026quot;\ndatabase.ymlå’Œsecrets.ymlæ˜¯æ‰‹åŠ¨åœ¨,share/config/ç›®å½•ä¸‹æ–°å»ºçš„ï¼Œä¸€ä¸ªæ˜¯è¿æ¥æ•°æ®åº“çš„ç›¸å…³ä¿¡æ¯ï¼Œä¸€ä¸ªæ˜¯å®‰å…¨éªŒè¯ç›¸å…³ä¿¡æ¯ã€‚æˆ‘çš„éƒ¨ç½²ç›®å½•æ˜¯scriot_blog/ å°±æ–°å»º script_blog/share/config/ ç›®å½•\nåŒæ—¶æ–°å»ºä»¥ä¸Šä¸¤ä¸ªæ–‡ä»¶ã€‚\ndatabase.yml\nproduction: adapter: postgresql pool: \u0026lt;%= ENV.fetch(\u0026#34;RAILS_MAX_THREADS\u0026#34;) { 5 } %\u0026gt; timeout: 5000 database: production_blog username: \u0026#39;xxx\u0026#39; password: \u0026#39;xxx\u0026#39; secrets.yml\nproduction: secret_key_base: xxxxxx å…¶ä¸­secret_key_baseçš„å€¼æ˜¯åœ¨æœ¬åœ°é¡¹ç›®ä¸‹ æ‰§è¡Œrake secret å‘½ä»¤ç”Ÿæˆçš„ã€‚\ndeploy/production.rb\n# server-based syntax # ====================== # Defines a single server with a list of roles and multiple properties. # You can define all roles on a single server, or split them: # server \u0026#34;39.108.138.149\u0026#34;, user: \u0026#34;root\u0026#34;, roles: %w{app db web}, my_property: :my_value server \u0026#34;xxxxæœåŠ¡å™¨çš„ip\u0026#34;, user: \u0026#34;deploy\u0026#34;, roles: %w{app db web} # server \u0026#34;example.com\u0026#34;, user: \u0026#34;deploy\u0026#34;, roles: %w{app web}, other_property: :other_value # server \u0026#34;db.example.com\u0026#34;, user: \u0026#34;deploy\u0026#34;, roles: %w{db} # role-based syntax # ================== # Defines a role with one or multiple servers. The primary server in each # group is considered to be the first unless any hosts have the primary # property set. Specify the username and a domain or IP for the server. # Don\u0026#39;t use `:all`, it\u0026#39;s a meta role. # role :app, %w{deploy@example.com}, my_property: :my_value # role :web, %w{user1@primary.com user2@additional.com}, other_property: :other_value # role :db, %w{deploy@example.com} # Configuration # ============= # You can set any configuration variable like in config/deploy.rb # These variables are then only loaded and set in this stage. # For available Capistrano configuration variables see the documentation page. # http://capistranorb.com/documentation/getting-started/configuration/ # Feel free to add new variables to customise your setup. # Custom SSH Options # ================== # You may pass any option but keep in mind that net/ssh understands a # limited set of options, consult the Net::SSH documentation. # http://net-ssh.github.io/net-ssh/classes/Net/SSH.html#method-c-start # # Global options # -------------- set :ssh_options, { keys: %w(/home/deploy/.ssh/id_rsa), port: xxx # forward_agent: false, # auth_methods: %w(password) } # # The server-based syntax can be used to override options: # ------------------------------------ # server \u0026#34;example.com\u0026#34;, # user: \u0026#34;user_name\u0026#34;, # keys: %w(/home/user_name/.ssh/id_rsa), # forward_agent: false, # auth_methods: %w(publickey password) # # password: \u0026#34;please use keys\u0026#34; # } æœ€å æœ¬åœ°æ‰§è¡Œcap production deploy\n","date":"2018-05-29T15:26:09Z","permalink":"https://dccmmtop.github.io/posts/%E9%83%A8%E7%BD%B2rails/","section":"posts","tags":["rails","éƒ¨ç½²"],"title":"éƒ¨ç½²Rails"},{"categories":null,"contents":" ç”Ÿæˆ key\nåœ¨æœ¬åœ°æ‰§è¡Œssh-keygen å°†æœ¬åœ°çš„å…¬é’¥æ‹·è´åˆ°è¿œç¨‹æœåŠ¡å™¨ ssh-copy-id -i ~/.ssh/id_rsa.pub -p 22222 username@ip ","date":"2018-05-29T11:24:54Z","permalink":"https://dccmmtop.github.io/posts/ssh%E5%85%8D%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95/","section":"posts","tags":["linux"],"title":"sshå…å¯†ç ç™»å½•"},{"categories":null,"contents":"ä½ è¦å¿ï¼Œå¿åˆ°æ˜¥æš–èŠ±å¼€ï¼›\nä½ è¦èµ°ï¼Œèµ°åˆ°ç¯ç«é€šæ˜ï¼›\nä½ è¦çœ‹è¿‡ä¸–ç•Œè¾½é˜”ï¼Œå†è¯„åˆ¤æ˜¯å¥½æ˜¯åï¼›\nä½ è¦å¯è¶³åŠ²å˜å¥½ï¼Œå†æ——é¼“ç›¸å½“çš„ç«™åœ¨ä¸æ•¢æƒ³è±¡çš„äººèº«è¾¹ï¼›\nä½ è¦å˜æˆæƒ³åƒä¸­çš„æ ·å­ï¼Œè¿™ä»¶äº‹ï¼Œä¸€æ­¥éƒ½ä¸èƒ½é€€è®©ã€‚\n","date":"1023-04-11T21:51:57Z","permalink":"https://dccmmtop.github.io/posts/%E4%BD%A0%E8%A6%81/","section":"posts","tags":["æ–‡æ‘˜"],"title":"ä½ è¦"},{"categories":null,"contents":"æˆ‘æƒ³\næˆ‘æƒ³çˆ±ä½ è€Œä¸ç”¨æŠ“ä½ä½ \næ¬£èµä½ è€Œä¸éœ€æ‰¹åˆ¤ä½ \nå’Œä½ ä¸€èµ·å‚ä¸è€Œä¸å¼ºæ±‚ä½ \nç¦»å¼€ä½ äº¦æ— éœ€è¨€æ­‰ç–š\nå¸®åŠ©ä½ è€Œæ²¡æœ‰åŠç‚¹ä½çœ‹ä½ \né‚£ä¹ˆæˆ‘ä¿©çš„ç›¸å¤„å°±æ˜¯çœŸè¯šçš„\nå¹¶ä¸”èƒ½å½¼æ­¤æ»‹å…»\nâ€”â€”â€”â€”è¨æäºš\n","date":"1023-03-30T23:50:26Z","permalink":"https://dccmmtop.github.io/posts/%E6%88%91%E6%83%B3/","section":"posts","tags":["æ–‡æ‘˜"],"title":"æˆ‘æƒ³"},{"categories":null,"contents":"ä½ çš„çœ¼ç›çœŸå¥½çœ‹\né‡Œé¢æœ‰æ™´é›¨æ—¥æœˆ\nå±±å·æ±Ÿæ²³äº‘é›¾èŠ±é¸Ÿ\nä½†æˆ‘çš„çœ¼ç›æ›´å¥½çœ‹\nå› ä¸ºæˆ‘çš„çœ¼é‡Œæœ‰ä½ \nâ€”â€”â€”â€” ä½™å…‰ä¸­\né‡è§ä½ æˆ‘å˜å¾—å¾ˆä½å¾ˆä½\nä¸€ç›´ä½åˆ°å°˜åŸƒé‡Œå»\nä½†æˆ‘çš„å¿ƒé‡Œæ˜¯æ¬¢å–œçš„\nå¹¶åœ¨é‚£é‡Œå¼€å‡ºä¸€æœµèŠ±æ¥\nâ€”â€”â€”â€” å¼ çˆ±ç²\næ‰‹ï¼Œæˆ‘æ˜¯æœ‰çš„\nå°±æ˜¯ä¸çŸ¥å¦‚ä½•ç¢°ä½ \nâ€”â€”â€”â€” é¡¾åŸ\næˆ‘å–œæ¬¢ä½ \næ‰€ä»¥å¸Œæœ›ä½ è¢«ç°‡æ‹¥åŒ…å›´\næ‰€ä»¥ä½ èµ°çš„è·¯\nè¦ç¹èŠ±ç››å¼€ è¦äººç”Ÿé¼æ²¸\nâ€”â€”â€”â€” æœ¨è‹é‡Œ\né™ªæˆ‘åˆ°å¯å¯è¥¿é‡Œçœ‹ä¸€çœ‹æµ·\nä¸è¦æœªæ¥\nåªè¦ä½ æ¥\nâ€”â€”â€”â€” å¤§å†°\nåœ¨ä½ å­¤ç‹¬ï¼Œæ‚²ä¼¤çš„æ—¥å­\nè¯·ä½ æ‚„æ‚„çš„å¿µä¸€å¿µæˆ‘çš„åå­—\nå¹¶ä¸”è¯´ï¼šâ€œæœ‰äººåœ¨æ€å¿µæˆ‘ï¼Œåœ¨ä¸–é—´æˆ‘æ´»åœ¨ä¸€ä¸ªäººå¿ƒé‡Œã€‚â€\nâ€”â€”â€”â€” æ™®å¸Œé‡‘ã€Šæˆ‘çš„åå­—ã€‹\nå¾…æˆ‘äº†æ— ç‰µæŒ‚\næ¼‚æ³Šå››æµ·ä¸ºå®¶\nçœ‹çœ‹å¤©å±±é›ªè²\nèµ°èµ°å¤§æ¼ é»„æ²™\næ³°å±±é¡¶ä¸Šé¥®é…’\nè¥¿å­æ¹–ç•”æµ£çº±\nè’™å¤è‰åŸçºµé©¬\nå†è®¿è‹—ç–†äººå®¶\nå°±æ­¤å³°å›è·¯è½¬\nå»çœ‹å¤§ç†ä¸‰å¡”\nèµ°è¿‡é’çŸ³å°å··\nä¼ä¸‹äººé¢æ¡ƒèŠ±\næ­¤ç”Ÿå¿ƒæ„¿å·²äº†\nç”Ÿè€ç—…æ­»ç”±ä»–\n","date":"1023-03-26T16:48:35Z","permalink":"https://dccmmtop.github.io/posts/%E9%9A%90%E6%99%A6/","section":"posts","tags":["æ–‡æ‘˜"],"title":"éšæ™¦"},{"categories":null,"contents":" äººå¹¶ä¸å—è¿‡å»çš„åŸå› æ‰€å·¦å³ï¼Œè€Œæ˜¯æœç€è‡ªå·±å®šä¸‹çš„ç›®æ ‡å‰è¿›\næˆ‘æœ‰ä¸€ä½å¹´è½»æœ‹å‹ï¼Œè™½ç„¶æ¢¦æƒ³ç€æˆä¸ºå°è¯´å®¶ï¼Œä½†å´æ€»æ˜¯å†™ä¸å‡ºä½œå“ã€‚ä»–è¯´æ˜¯å› ä¸ºå·¥ä½œå¤ªå¿™ã€å†™å°è¯´çš„æ—¶é—´éå¸¸æœ‰é™ï¼Œæ‰€ä»¥æ‰å†™ä¸å‡ºæ¥ä½œå“ï¼Œä¹Ÿä»æœªå‚åŠ è¿‡ä»»ä½•æ¯”èµ›ã€‚ã€€ä½†çœŸæ˜¯å¦‚æ­¤å—ï¼Ÿå®é™…ä¸Šï¼Œä»–æ˜¯æƒ³é€šè¿‡ä¸å»æ¯”èµ›è¿™ä¸€æ–¹å¼æ¥ä¿ç•™ä¸€ç§â€œå¦‚æœåšçš„è¯æˆ‘ä¹Ÿå¯ä»¥â€çš„å¯èƒ½æ€§ï¼Œå³ä¸æ„¿å‡ºå»è¢«äººè¯„ä»·ï¼Œæ›´ä¸æ„¿å»é¢å¯¹å› ä½œå“æ‹™åŠ£è€Œè½é€‰çš„ç°å®ã€‚\nä»–åªæƒ³æ´»åœ¨â€œåªè¦æœ‰æ—¶é—´æˆ‘ä¹Ÿå¯ä»¥ã€åªè¦ç¯å¢ƒå…·å¤‡æˆ‘ä¹Ÿèƒ½å†™ã€è‡ªå·±æœ‰è¿™ç§æ‰èƒ½â€ä¹‹ç±»çš„å¯èƒ½æ€§ä¸­ã€‚æˆ–è®¸å†è¿‡5å¹´æˆ–è€…10å¹´ï¼Œä»–åˆä¼šå¼€å§‹ä½¿ç”¨â€œå·²ç»ä¸å†å¹´è½»â€æˆ–è€…â€œä¹Ÿå·²ç»æœ‰äº†å®¶åº­â€ä¹‹ç±»çš„å€Ÿå£\nå‡è‹¥åº”å¾è½é€‰ä¹Ÿåº”è¯¥å»åšã€‚é‚£æ ·çš„è¯æˆ–è®¸èƒ½å¤Ÿæœ‰æ‰€æˆé•¿ï¼Œæˆ–è®¸ä¼šæ˜ç™½åº”è¯¥é€‰æ‹©åˆ«çš„é“è·¯ã€‚æ€»ä¹‹ï¼Œå¯ä»¥æœ‰æ‰€å‘å±•ã€‚æ‰€è°“æ”¹å˜ç°åœ¨çš„ç”Ÿæ´»æ–¹å¼å°±æ˜¯è¿™æ ·ã€‚å¦‚æœä¸€ç›´ä¸å»æŠ•ç¨¿åº”å¾ï¼Œé‚£å°±ä¸ä¼šæœ‰æ‰€å‘å±•ã€‚ã€€é’å¹´ï¼šæ¢¦ä¹Ÿè®¸ä¼šç ´ç­å•Šï¼ã€€å“²äººï¼šä½†é‚£åˆæ€æ ·å‘¢ï¼Ÿ åº”è¯¥å»åšâ€”â€”è¿™ä¸€ç®€å•çš„è¯¾é¢˜æ‘†åœ¨é¢å‰ï¼Œä½†å´ä¸æ–­åœ°æ‰¯å‡ºå„ç§â€œä¸èƒ½åšçš„ç†ç”±â€ï¼Œä½ éš¾é“ä¸è®¤ä¸ºè¿™æ˜¯ä¸€ç§å¾ˆç—›è‹¦çš„ç”Ÿæ´»æ–¹å¼å—ï¼Ÿæ¢¦æƒ³ç€åšå°è¯´å®¶çš„ä»–ï¼Œæ­£æ˜¯â€œè‡ªå·±â€æŠŠäººç”Ÿå˜å¾—å¤æ‚ç»§è€Œéš¾ä»¥è·å¾—å¹¸ç¦ã€‚\n","date":"1023-03-26T16:20:44Z","permalink":"https://dccmmtop.github.io/posts/%E8%A2%AB%E8%AE%A8%E5%8E%8C%E7%9A%84%E5%8B%87%E6%B0%94/","section":"posts","tags":["æ–‡æ‘˜"],"title":"è¢«è®¨åŒçš„å‹‡æ°”"},{"categories":null,"contents":"æˆ‘è¯´ä½ æ˜¯äººé—´çš„å››æœˆå¤©ï¼›\nç¬‘å“ç‚¹äº®äº†å››é¢é£ï¼›\nè½»çµåœ¨æ˜¥çš„å…‰è‰³ä¸­äº¤èˆç€å˜ã€‚\nä½ æ˜¯å››æœˆæ—©å¤©é‡Œçš„äº‘çƒŸï¼Œ\né»„æ˜å¹ç€é£çš„è½¯ï¼Œ\næ˜Ÿå­åœ¨æ— æ„ä¸­é—ªï¼Œ\nç»†é›¨ç‚¹æ´’åœ¨èŠ±å‰ã€‚\né‚£è½»ï¼Œé‚£å¨‰å©·ï¼Œä½ æ˜¯ï¼Œ\né²œå¦ç™¾èŠ±çš„å† å†•ä½ æˆ´ç€ï¼Œ\nä½ æ˜¯å¤©çœŸï¼Œåº„ä¸¥ï¼Œ\nä½ æ˜¯å¤œå¤œçš„æœˆåœ†ã€‚\né›ªåŒ–åé‚£ç‰‡é¹…é»„ï¼Œä½ åƒï¼›\næ–°é²œåˆæ”¾èŠ½çš„ç»¿ï¼Œä½ æ˜¯ï¼›\næŸ”å«©å–œæ‚¦ï¼Œ\næ°´å…‰æµ®åŠ¨ç€ä½ æ¢¦æœŸå¾…ä¸­ç™½è²ã€‚\nä½ æ˜¯ä¸€æ ‘ä¸€æ ‘çš„èŠ±å¼€ï¼Œ\næ˜¯ç‡•åœ¨æ¢é—´å‘¢å–ƒï¼Œ\nâ€”â€”ä½ æ˜¯çˆ±ï¼Œæ˜¯æš–ï¼Œæ˜¯å¸Œæœ›ï¼Œ\nä½ æ˜¯äººé—´çš„å››æœˆå¤©ï¼\n","date":"1023-03-26T16:01:37Z","permalink":"https://dccmmtop.github.io/posts/%E4%BD%A0%E6%98%AF%E4%BA%BA%E9%97%B4%E5%9B%9B%E6%9C%88%E5%A4%A9/","section":"posts","tags":["æ–‡æ‘˜"],"title":"ä½ æ˜¯äººé—´å››æœˆå¤©"},{"categories":null,"contents":"ã€Šå½“æˆ‘å¼€å§‹çˆ±è‡ªå·±ã€‹â€”â€”æŸ¥ç† Â· å“åˆ«æ— å½“æˆ‘å¼€å§‹çˆ±è‡ªå·±\næˆ‘æ‰å‘ç°æ‰€æœ‰çš„è‹¦ç—›åªæ˜¯åœ¨è­¦ç¤º\næˆ‘èƒŒç¦»äº†æœ¬çœŸ\nä»Šå¤©æˆ‘æ‡‚å¾—ï¼Œè¿™æ˜¯ \u0026ldquo;çœŸå®\u0026rdquo;\nå½“æˆ‘å¼€å§‹çˆ±è‡ªå·±\næˆ‘æ‰æ˜ç™½æœ‰ä¸€ç§å†’çŠ¯\næ˜¯æŠŠæˆ‘çš„æ¬²æ±‚å¼ºåŠ äºäºº\nå°½ç®¡æˆ‘çŸ¥é“æ—¶æœºä¸å¯¹\né‚£ä¸ªäººä¹Ÿæ²¡æœ‰å‡†å¤‡å¥½\næœ‰æ—¶é‚£ä¸ªäººæ­£æ˜¯æˆ‘è‡ªå·±\nä»Šå¤©æˆ‘æ‡‚å¾—ï¼Œè¿™æ˜¯â€œå°Šé‡â€\nå½“æˆ‘å¼€å§‹çˆ±è‡ªå·±\næˆ‘ä¸å†æ¸´æ±‚è¿‡å¦å¤–ä¸€ç§äººç”Ÿ\næˆ‘çœ‹åˆ°èº«è¾¹æ¯ä¸€ä»¶äº‹ï¼Œéƒ½æ˜¯åœ¨é‚€è¯·æˆ‘æˆé•¿\nä»Šå¤©æˆ‘æ‡‚å¾—ï¼Œè¿™æ˜¯â€œæˆç†Ÿâ€\nå½“æˆ‘å¼€å§‹çˆ±è‡ªå·±\næˆ‘æ‰å‘ç°\næˆ‘ä¸€ç›´éƒ½å¤„åœ¨æ­£ç¡®çš„æ—¶é—´å’Œæ­£ç¡®çš„åœ°ç‚¹\nå‘ç”Ÿçš„ä¸€åˆ‡éƒ½æ°å¦‚å…¶åˆ†\nç”±æ­¤æˆ‘å½’äºå¹³é™\nä»Šå¤©æˆ‘æ‡‚å¾—ï¼Œè¿™æ˜¯â€œè‡ªä¿¡â€\nå½“æˆ‘å¼€å§‹çˆ±è‡ªå·±\næˆ‘ä¾¿ä¸å†ç‰ºç‰²æˆ‘çš„æ—¶é—´\nä¸å†å»å‹¾ç”»å®ä¼Ÿçš„æ˜å¤©\næ­¤åˆ»æˆ‘åªåšæœ‰è¶£å’Œå¿«ä¹çš„äº‹\nåªåšçœŸæ­£çƒ­çˆ±å’Œç”±è¡·å–œæ¬¢ä¹‹äº‹\nä»¥æˆ‘çš„æ–¹å¼ã€ä»¥æˆ‘çš„èŠ‚å¥\nä»Šå¤©æˆ‘æ‡‚å¾—ï¼Œè¿™æ˜¯â€œå•çº¯â€\nå½“æˆ‘å¼€å§‹çˆ±è‡ªå·±\næˆ‘è®©è‡ªå·±è¿œç¦»äº†ä¸€åˆ‡ä¸å¥åº·çš„é£Ÿç‰©ã€äººã€äº‹æƒ…å’Œç¯å¢ƒ\nè¿˜æœ‰ä¸€åˆ‡ä»¤æˆ‘å •è½ï¼Œä»¤æˆ‘è¿œç¦»è‡ªæˆ‘çš„ä¸œè¥¿\nä»¥å‰æˆ‘è®¤ä¸ºè¿™ç§æ€åº¦æ˜¯å¥åº·çš„è‡ªç§\nä»Šå¤©æˆ‘æ‡‚å¾—ï¼Œè¿™æ˜¯â€œè‡ªçˆ±â€\nå½“æˆ‘å¼€å§‹çˆ±è‡ªå·±\næˆ‘ä¸å†å¥¢æœ›ä¸€ç›´æ­£ç¡®\nä¸å†ä¼å›¾ä¸é”™å¤±æ—¶é—´\nä»Šå¤©æˆ‘æ‡‚å¾—ï¼Œè¿™æ˜¯â€œè°¦é€Šâ€\nå½“æˆ‘å¼€å§‹çˆ±è‡ªå·±\næˆ‘ä¸å†ç¼…æ€€è¿‡å»ï¼Œä¹Ÿä¸å†å¿§è™‘æœªæ¥\næˆ‘åªæ´»åœ¨å½“ä¸‹\nè¿›å…¥æ­£åœ¨å‘ç”Ÿçš„ä¸€åˆ‡äº‹ç‰©ä¹‹ä¸­\næˆ‘å……åˆ†çš„æ´»åœ¨æ¯ä¸€æ—¥\nå¦‚æ­¤æ—¥å¤ä¸€æ—¥\nè€Œæˆ‘æ‡‚å¾—ï¼Œè¿™å°±æ˜¯å®Œç¾\nå½“æˆ‘å¼€å§‹çˆ±è‡ªå·±\næˆ‘æ‰æ˜ç™½ï¼Œå¤´è„‘ä¼šè®©æˆ‘æ··ä¹±è€Œç—…æ€\nç„¶è€Œå½“å¤´è„‘ä¸å¿ƒç›¸è¿\nå®ƒå°±æˆäº†å¯ä¿¡èµ–çš„ä¼™ä¼´\nä»Šå¤©æˆ‘å°†è¿™ä»½ç»„åˆç§°ä¹‹ä¸ºâ€œå¿ƒä¹‹æ™ºæ…§â€\næˆ‘ä»¬ä¸å¿…å®³æ€•è‡ªå·±ä¸ä»–äººçš„ä»»ä½•åˆ†æ­§ã€çŸ›ç›¾å’Œé—®é¢˜\nå³ä¾¿æ˜Ÿçƒä¹Ÿä¼šæ’å‡»åˆ°ä¸€èµ·\næ–°ä¸–ç•Œå°±æ­¤è€Œç”Ÿ\nä»Šå¤©æˆ‘æ‡‚å¾—ï¼Œè¿™å°±æ˜¯â€œç”Ÿå‘½â€\n","date":"1023-03-25T19:10:22Z","permalink":"https://dccmmtop.github.io/posts/%E5%BD%93%E6%88%91%E5%BC%80%E5%A7%8B%E7%88%B1%E8%87%AA%E5%B7%B1/","section":"posts","tags":["æ–‡æ‘˜"],"title":"å½“æˆ‘å¼€å§‹çˆ±è‡ªå·±"},{"categories":null,"contents":"fastJsonåºåˆ—åŒ– Map \u0026lt; String , Object \u0026gt; jsonMap = new HashMap\u0026lt; String , Object\u0026gt;(); jsonMap.put(\u0026#34;a\u0026#34;,1); jsonMap.put(\u0026#34;b\u0026#34;,\u0026#34;\u0026#34;); jsonMap.put(\u0026#34;c\u0026#34;,null); jsonMap.put(\u0026#34;d\u0026#34;,\u0026#34;wuzhuti.cn\u0026#34;); String str = JSONObject.toJSONString(jsonMap); System.out.println(str); //è¾“å‡ºç»“æœ:{\u0026#34;a\u0026#34;:1,\u0026#34;b\u0026#34;:\u0026#34;\u0026#34;,d:\u0026#34;wuzhuti.cn\u0026#34;} ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼Œnullå¯¹åº”çš„keyå·²ç»è¢«è¿‡æ»¤æ‰ï¼›è¿™æ˜æ˜¾ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œè¿™æ—¶æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°fastjsonçš„SerializerFeatureåºåˆ—åŒ–å±æ€§\nä¹Ÿå°±æ˜¯è¿™ä¸ªæ–¹æ³•ï¼šJSONObject.toJSONString(Object object, SerializerFeature\u0026hellip; features)\nFastjsonçš„SerializerFeatureåºåˆ—åŒ–å±æ€§\nQuoteFieldNamesâ€”â€”â€”-è¾“å‡ºkeyæ—¶æ˜¯å¦ä½¿ç”¨åŒå¼•å·,é»˜è®¤ä¸ºtrue WriteMapNullValueâ€”â€”â€“æ˜¯å¦è¾“å‡ºå€¼ä¸ºnullçš„å­—æ®µ,é»˜è®¤ä¸ºfalse WriteNullNumberAsZeroâ€”-æ•°å€¼å­—æ®µå¦‚æœä¸ºnull,è¾“å‡ºä¸º0,è€Œénull WriteNullListAsEmptyâ€”â€“Listå­—æ®µå¦‚æœä¸ºnull,è¾“å‡ºä¸º[],è€Œénull WriteNullStringAsEmptyâ€”å­—ç¬¦ç±»å‹å­—æ®µå¦‚æœä¸ºnull,è¾“å‡ºä¸ºâ€â€œ,è€Œénull WriteNullBooleanAsFalseâ€“Booleanå­—æ®µå¦‚æœä¸ºnull,è¾“å‡ºä¸ºfalse,è€Œénull Map \u0026lt; String , Object \u0026gt; jsonMap = new HashMap\u0026lt; String , Object\u0026gt;(); jsonMap.put(\u0026#34;a\u0026#34;,1); jsonMap.put(\u0026#34;b\u0026#34;,\u0026#34;\u0026#34;); jsonMap.put(\u0026#34;c\u0026#34;,null); jsonMap.put(\u0026#34;d\u0026#34;,\u0026#34;wuzhuti.cn\u0026#34;); String str = JSONObject.toJSONString(jsonMap,SerializerFeature.WriteMapNullValue); System.out.println(str); //è¾“å‡ºç»“æœ:{\u0026#34;a\u0026#34;:1,\u0026#34;b\u0026#34;:\u0026#34;\u0026#34;,\u0026#34;c\u0026#34;:null,\u0026#34;d\u0026#34;:\u0026#34;wuzhuti.cn\u0026#34;} ","date":"0001-01-01T00:00:00Z","permalink":"https://dccmmtop.github.io/posts/fastjson%E5%BA%8F%E5%88%97%E5%8C%96/","section":"posts","tags":null,"title":""},{"categories":null,"contents":"HTTP ä»£ç† ä»£ç†ä½¿ç”¨åŒä¸€ç§åè®®ï¼Œç½‘å…³ä½¿ç”¨ä¸åŒçš„åè®®è¿æ¥ç«¯ ä½œç”¨ ç›‘è§†æµé‡å¹¶ä¿®æ”¹\nå„¿ç«¥è¿‡æ»¤å™¨\nå®‰å…¨é˜²ç«å¢™\nç¼“å­˜\nåå‘ä»£ç† å‡æ‰®æœåŠ¡å™¨\næ–‡æ¡£è®¿é—®æ§åˆ¶ï¼Œç»Ÿä¸€è¾“å…¥å¯†ç \nè½¬ç å™¨ å›¾ç‰‡æ ¼å¼ï¼Œè¯­è¨€\nåŒ¿åè€…\nä»æŠ¥æ–‡ä¸­åˆ é™¤èº«ä»½ç‰¹å¾ï¼Œip,é¦–éƒ¨ï¼Œcookieç­‰ å±‚çº§ç»“æ„ é™æ€\nå›ºå®šé¡ºåºè½¬å‘ åŠ¨æ€\nè´Ÿè½½å‡è¡¡ å°±è¿‘è·¯ç”± åè®®ç±»å‹è·¯ç”± å¦‚ä½•è·å–æµé‡ ä¿®æ”¹å®¢æˆ·ç«¯ç½‘ç»œé…ç½®\nä¸è®¾ç½®ä»£ç† å‘é€ç›¸å¯¹URIè·¯å¾„ æœ‰ä»£ç†å‘é€å®Œæ•´è·¯å¾„ ä¿®æ”¹è·¯ç”±è®¾å¤‡ç½‘ç»œ\nåœ¨å®¢æˆ·ç«¯ä¸å‚ä¸çš„æƒ…å†µä¸‹æ‹¦æˆªç½‘ç»œæµé‡ï¼Œä¾èµ–æµé‡äº¤æ¢è®¾å¤‡å’Œè·¯ç”±è®¾å¤‡ ä¿®æ”¹DNSå‘½åç©ºé—´\nä¿®æ”¹webæœåŠ¡å™¨\né‡å®šå‘ è¿½è¸ªæŠ¥æ–‡ Via é¦–éƒ¨\nè®°å½•ç»è¿‡çš„æ¯ä¸ªä¸­é—´èŠ‚ç‚¹\nç”¨æ¥æ£€æµ‹æ˜¯å¦æœ‰è·¯ç”±å¾ªç¯\nç»„æˆ\nåè®®å åè®®ç‰ˆæœ¬ èŠ‚ç‚¹å èŠ‚ç‚¹æ³¨é‡Š trace æ–¹æ³•\nMax-Forwards\næ•´æ•° æœ¬æŠ¥æ–‡è¿˜å¯ä»¥è¢«è½¬å‘çš„æ¬¡æ•° æ¯ç»è¿‡ä¸€ä¸ªèŠ‚ç‚¹æ•°é‡å‡ä¸€ ä»£ç†è®¤è¯ ä»£ç†çš„äº’æ“ä½œ ä¿ç•™ä¸æ”¯æŒçš„é¦–éƒ¨å’Œæ–¹æ³•ï¼Œå‘ä¸‹è½¬å‘\nOPTIONSæ–¹æ³•\nURI æ˜¯*ï¼Œ æŸ¥çœ‹æœåŠ¡æ”¯æŒçš„æ‰€æœ‰æ–¹æ³• URLI æ˜¯å…·ä½“èµ„æºï¼ŒæŸ¥çœ‹å¯¹è¯¥èµ„æºæ”¯æŒçš„æ–¹æ³• Allow é¦–éƒ¨\nå¯¹èµ„æºæ‰€æ”¯æŒçš„æ–¹æ³•åˆ—è¡¨ ç¼“å­˜ é—®é¢˜ å†—ä½™æ•°æ®ä¼ è¾“ å¸¦å®½ç“¶é¢ˆ ç¬é—´å µå¡ è·ç¦»æ—¶å»¶ åŒºåˆ†å‘½ä¸­å’Œæœªå‘½ä¸­çš„æƒ…å†µ Dateé¦–éƒ¨\nå°†å“åº”ä¸­Dateé¦–éƒ¨çš„å€¼ä¸å½“å‰æ—¶é—´è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå“åº”ä¸­çš„æ—¥æœŸå€¼æ¯”è¾ƒæ—©ï¼Œå®¢æˆ·ç«¯é€šå¸¸å°±å¯ä»¥è®¤ä¸ºè¿™æ˜¯ä¸€æ¡ç¼“å­˜çš„å“åº”ã€‚\nç¼“å­˜çš„å±‚æ¬¡ç»“æ„ åœ¨å®é™…ä¸­ï¼Œå®ç°å±‚æ¬¡åŒ–ï¼ˆhierarchyï¼‰çš„ç¼“å­˜æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ï¼Œåœ¨è¿™ç§ç»“æ„ä¸­ï¼Œåœ¨è¾ƒå°ç¼“å­˜ä¸­æœªå‘½ä¸­çš„è¯·æ±‚ä¼šè¢«å¯¼å‘è¾ƒå¤§çš„çˆ¶ç¼“å­˜ï¼ˆparent cacheï¼‰ï¼Œç”±å®ƒæ¥ä¸ºå‰©ä¸‹çš„é‚£äº›â€œæç‚¼è¿‡çš„â€æµé‡æä¾›æœåŠ¡ã€‚å›¾7-9æ˜¾ç¤ºäº†ä¸€ä¸ªä¸¤çº§çš„ç¼“å­˜å±‚æ¬¡ç»“æ„ã€‚[æ’å›¾]å…¶åŸºæœ¬æ€æƒ³æ˜¯åœ¨é è¿‘å®¢æˆ·ç«¯çš„åœ°æ–¹ä½¿ç”¨å°å‹å»‰ä»·ç¼“å­˜ï¼Œè€Œæ›´é«˜å±‚æ¬¡ä¸­ï¼Œåˆ™é€æ­¥é‡‡ç”¨æ›´å¤§ã€åŠŸèƒ½æ›´å¼ºçš„ç¼“å­˜æ¥è£…è½½å¤šç”¨æˆ·å…±äº«çš„æ–‡æ¡£ã€‚\nç½‘çŠ¶ç¼“å­˜ã€å†…å®¹è·¯ç”±ä»¥åŠå¯¹ç­‰ç¼“å­˜ å¤„ç†æ­¥éª¤ æ¥æ”¶ ç¼“å­˜ä»ç½‘ç»œä¸­è¯»å–æŠµè¾¾çš„è¯·æ±‚æŠ¥æ–‡ è§£æ ç¼“å­˜å¯¹æŠ¥æ–‡è¿›è¡Œè§£æï¼Œæå–å‡ºURLå’Œå„ç§é¦–éƒ¨ æŸ¥è¯¢ å­˜æŸ¥çœ‹æ˜¯å¦æœ‰æœ¬åœ°å‰¯æœ¬å¯ç”¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±è·å–ä¸€ä»½å‰¯æœ¬ï¼ˆå¹¶å°†å…¶ä¿å­˜åœ¨æœ¬åœ°ï¼‰ æ–°é²œåº¦æ£€æµ‹ ç¼“å­˜æŸ¥çœ‹å·²ç¼“å­˜å‰¯æœ¬æ˜¯å¦è¶³å¤Ÿæ–°é²œï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±è¯¢é—®æœåŠ¡å™¨æ˜¯å¦æœ‰ä»»ä½•æ›´æ–° åˆ›å»ºç›¸åº” ç¼“å­˜ä¼šç”¨æ–°çš„é¦–éƒ¨å’Œå·²ç¼“å­˜çš„ä¸»ä½“æ¥æ„å»ºä¸€æ¡å“åº”æŠ¥æ–‡ å‘é€ ç¼“å­˜é€šè¿‡ç½‘ç»œå°†å“åº”å‘å›ç»™å®¢æˆ·ç«¯ æ—¥å¿— ç¼“å­˜å¯é€‰åœ°åˆ›å»ºä¸€ä¸ªæ—¥å¿—æ–‡ä»¶æ¡ç›®æ¥æè¿°è¿™ä¸ªäº‹åŠ¡ æµç¨‹å›¾\nä¿æŒå‰¯æœ¬çš„æ–°é²œ è¯´æ˜\nå¯èƒ½ä¸æ˜¯æ‰€æœ‰çš„å·²ç¼“å­˜å‰¯æœ¬éƒ½ä¸æœåŠ¡å™¨ä¸Šçš„æ–‡æ¡£ä¸€è‡´ã€‚æ¯•ç«Ÿï¼Œè¿™äº›æ–‡æ¡£ä¼šéšç€æ—¶é—´å‘ç”Ÿå˜åŒ–ã€‚æŠ¥å‘Šå¯èƒ½æ¯ä¸ªæœˆéƒ½ä¼šå˜åŒ–ã€‚åœ¨çº¿æŠ¥çº¸æ¯å¤©éƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚è´¢ç»æ•°æ®å¯èƒ½æ¯è¿‡å‡ ç§’é’Ÿå°±ä¼šå‘ç”Ÿå˜åŒ–ã€‚å¦‚æœç¼“å­˜æä¾›çš„æ€»æ˜¯è€çš„æ•°æ®ï¼Œå°±ä¼šå˜å¾—æ¯«æ— ç”¨å¤„ã€‚å·²ç¼“å­˜æ•°æ®è¦ä¸æœåŠ¡å™¨æ•°æ®ä¿æŒä¸€è‡´ã€‚\nå†éªŒè¯\nç¼“å­˜è¿‡æœŸä¸ä»£è¡¨æ–‡æ¡£å˜åŒ–ï¼Œè€Œæ˜¯éœ€è¦æ ¸å¯¹äº†\næœ‰å˜åŒ–\nè·å–ä¸€ä»½æ–°çš„æ–‡æ¡£ æ— å˜åŒ–\nåªéœ€è¦è·å–æ–°çš„é¦–éƒ¨ï¼ŒåŒ…æ‹¬ä¸€ä¸ªæ–°çš„è¿‡æœŸæ—¥æœŸï¼Œå¹¶å¯¹ç¼“å­˜ä¸­çš„é¦–éƒ¨è¿›è¡Œæ›´æ–° æ¡ä»¶å†éªŒè¯\nHTTPçš„æ¡ä»¶æ–¹æ³•å¯ä»¥é«˜æ•ˆåœ°å®ç°å†éªŒè¯ã€‚HTTPå…è®¸ç¼“å­˜å‘åŸå§‹æœåŠ¡å™¨å‘é€ä¸€ä¸ªâ€œæ¡ä»¶GETâ€ï¼Œè¯·æ±‚æœåŠ¡å™¨åªæœ‰åœ¨æ–‡æ¡£ä¸ç¼“å­˜ä¸­ç°æœ‰çš„å‰¯æœ¬ä¸åŒæ—¶ï¼Œæ‰å›é€å¯¹è±¡ä¸»ä½“ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå°†æ–°é²œåº¦æ£€æµ‹å’Œå¯¹è±¡è·å–ç»“åˆæˆäº†å•ä¸ªæ¡ä»¶GETã€‚å‘GETè¯·æ±‚æŠ¥æ–‡ä¸­æ·»åŠ ä¸€äº›ç‰¹æ®Šçš„æ¡ä»¶é¦–éƒ¨ï¼Œå°±å¯ä»¥å‘èµ·æ¡ä»¶GETã€‚åªæœ‰æ¡ä»¶ä¸ºçœŸæ—¶ï¼ŒWebæœåŠ¡å™¨æ‰ä¼šè¿”å›å¯¹è±¡ã€‚\nIf-Modified-Since:Date\nIf-Modified-Sinceé¦–éƒ¨å¯ä»¥ä¸Last-ModifiedæœåŠ¡å™¨å“åº”é¦–éƒ¨é…åˆå·¥ä½œã€‚åŸå§‹æœåŠ¡å™¨ä¼šå°†æœ€åçš„ä¿®æ”¹æ—¥æœŸé™„åŠ åˆ°æ‰€æä¾›çš„æ–‡æ¡£ä¸Šå»ã€‚å½“ç¼“å­˜è¦å¯¹å·²ç¼“å­˜æ–‡æ¡£è¿›è¡Œå†éªŒè¯æ—¶ï¼Œå°±ä¼šåŒ…å«ä¸€ä¸ªIf-Modified-Sinceé¦–éƒ¨ï¼Œå…¶ä¸­æºå¸¦æœ‰æœ€åä¿®æ”¹å·²ç¼“å­˜å‰¯æœ¬çš„æ—¥æœŸ\nå¦‚æœåœ¨æ­¤æœŸé—´å†…å®¹è¢«ä¿®æ”¹äº†ï¼Œæœ€åçš„ä¿®æ”¹æ—¥æœŸå°±ä¼šæœ‰æ‰€ä¸åŒï¼ŒåŸå§‹æœåŠ¡å™¨å°±ä¼šå›é€æ–°çš„æ–‡æ¡£ã€‚å¦åˆ™ï¼ŒæœåŠ¡å™¨ä¼šæ³¨æ„åˆ°ç¼“å­˜çš„æœ€åä¿®æ”¹æ—¥æœŸä¸æœåŠ¡å™¨æ–‡æ¡£å½“å‰çš„æœ€åä¿®æ”¹æ—¥æœŸç›¸ç¬¦ï¼Œä¼šè¿”å›ä¸€ä¸ª304 NotModifiedå“åº”ã€‚\nè‡ªæŒ‡å®šæ—¥æœŸåï¼Œæ–‡æ¡£è¢«ä¿®æ”¹äº†ï¼Œä¸º true\nè‡ªæŒ‡å®šæ—¥æœŸåï¼Œæ–‡æ¡£æ²¡è¢«ä¿®æ”¹è¿‡ï¼Œä¸º false\næ˜¯å¦å‘½ä¸­\nå†éªŒè¯å‘½ä¸­\næœåŠ¡å™¨è¿”å›ä¸€ä¸ªå°çš„HTTP 304 Not Modifiedå“åº” å†éªŒè¯æœªå‘½ä¸­\nHTTP 200 OKå“åº” å¯¹è±¡è¢«åˆ é™¤\n404 Not Foundå“åº” æ— æ³•ä½¿ç”¨è¯¥ç±»å‹éªŒè¯å¾—åœºæ™¯\nå†…å®¹ä¸å˜ï¼Œæ—¶é—´å˜ ä¸é‡è¦å¾—å†…å®¹å˜åŒ– æ— æ³•å¾—åˆ°ä¿®æ”¹æ—¶é—´ äºšç§’é—´éš™å‘ç”Ÿå˜åŒ–ï¼Œç§’çº§ç²’åº¦ä¸å¤Ÿ If-None-Matchï¼šå®ä½“æ ‡ç­¾å†éªŒè¯\nHTTPå…è®¸ç”¨æˆ·å¯¹è¢«ç§°ä¸ºå®ä½“æ ‡ç­¾ï¼ˆETagï¼‰çš„â€œç‰ˆæœ¬æ ‡è¯†ç¬¦â€è¿›è¡Œæ¯”è¾ƒã€‚å®ä½“æ ‡ç­¾æ˜¯é™„åŠ åˆ°æ–‡æ¡£ä¸Šçš„ä»»æ„æ ‡ç­¾ï¼ˆå¼•ç”¨å­—ç¬¦ä¸²ï¼‰ã€‚å®ƒä»¬å¯èƒ½åŒ…å«äº†æ–‡æ¡£çš„åºåˆ—å·æˆ–ç‰ˆæœ¬åï¼Œæˆ–è€…æ˜¯æ–‡æ¡£å†…å®¹çš„æ ¡éªŒå’ŒåŠå…¶ä»–æŒ‡çº¹ä¿¡æ¯ã€‚å½“å‘å¸ƒè€…å¯¹æ–‡æ¡£è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå¯ä»¥ä¿®æ”¹æ–‡æ¡£çš„å®ä½“æ ‡ç­¾æ¥è¯´æ˜è¿™ä¸ªæ–°çš„ç‰ˆæœ¬ã€‚è¿™æ ·ï¼Œå¦‚æœå®ä½“æ ‡ç­¾è¢«ä¿®æ”¹äº†ï¼Œç¼“å­˜å°±å¯ä»¥ç”¨If-None-Matchæ¡ä»¶é¦–éƒ¨æ¥GETæ–‡æ¡£çš„æ–°å‰¯æœ¬äº†\nç¼“å­˜ä¸­å·²æœ‰æŸäº›å‰¯æœ¬ If-None-Match:\u0026ldquo;v2.4,v2.5\u0026rdquo;\nå¼ºå¼±éªŒè¯å™¨\nå¼±: æ”¹å˜ä¸é‡è¦å¾—å†…å®¹æ—¶ï¼Œç¼“å­˜ä¸å¤±æ•ˆ å¼º: ä»»ä½•æ”¹å˜éƒ½ä¼šå¤±æ•ˆ æœåŠ¡å™¨ä¼šç”¨å‰ç¼€â€œW/â€æ¥æ ‡è¯†å¼±éªŒè¯å™¨\nETag: W/\u0026ldquo;v2.6\u0026rdquo;\nIf-None-Match: W/\u0026ldquo;v2.6\u0026rdquo; é€‰æ‹©\næœåŠ¡å™¨åªå›é€äº†ä¸€ä¸ªLast-Modifiedï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥ä½¿ç”¨If-Modified-SinceéªŒè¯\nå®ä½“æ ‡ç­¾å’Œæœ€åä¿®æ”¹æ—¥æœŸéƒ½æä¾›äº†ï¼Œå®¢æˆ·ç«¯å°±åº”è¯¥åŒæ—¶ä½¿ç”¨è¿™ä¸¤ç§å†éªŒè¯æ–¹æ¡ˆ\nåªæœ‰è¿™ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³æ—¶ï¼Œæ‰èƒ½è¿”å›304 Not Modifiedå“åº” æ§åˆ¶ç¼“å­˜çš„èƒ½åŠ› é¦–éƒ¨ Cache-Control:max-age (æ¨è)\nmax-age=600 æœ€å¤§ç”Ÿå­˜æ—¶é—´ä¸º600ç§’ Expiresé¦–éƒ¨\næŒ‡å®šç»å¯¹æ—¥æœŸï¼Œä¾èµ–æœºå™¨æœ¬èº«æ—¶é—´ XMind: ZEN - Trial Version\n''\nSLL æ¡æ‰‹\næœåŠ¡å™¨è¯ä¹¦\nä»£ç†\n","date":"0001-01-01T00:00:00Z","permalink":"https://dccmmtop.github.io/posts/http%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/","section":"posts","tags":null,"title":""},{"categories":null,"contents":"javaçŸ¥è¯†ç‚¹ java å˜é‡åˆå§‹åŒ–é¡ºåº æ€»ç»“ä¸€ä¸‹å¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹,å‡è®¾æœ‰ä¸ªåä¸ºDogçš„ç±»\r1.å³ä½¿æ²¡æœ‰æ˜¾å¼åœ°ä½¿ç”¨ staticå…³é”®å­—,æ„é€ å™¨å®é™…ä¸Šä¹Ÿæ˜¯é™æ€æ–¹æ³•ã€‚å› æ­¤,å½“é¦–æ¬¡åˆ›å»ºç±»å‹ä¸ºDogçš„å¯¹è±¡æ—¶(æ„é€ å™¨å¯ä»¥çœ‹æˆé™æ€æ–¹æ³•),æˆ–è€…Dogç±»çš„é™æ€æ–¹æ³•/é™æ€åŸŸé¦–æ¬¡è¢«è®¿é—®æ—¶,\navaè§£é‡Šå™¨å¿…é¡»æŸ»æ‰¾ç±»è·¯å¾„,ä»¥å®šä½ Dog. classæ–‡ä»¶ã€‚\n2ç„¶åè½½å…¥ Dog.class(åé¢ä¼šå­¦åˆ°,è¿™å°†åˆ›å»ºä¸€ä¸ªClaså¯¹è±¡),æœ‰å…³é™æ€åˆå§‹åŒ–çš„æ‰€æœ‰åŠ¨ä½œéƒ½ä¼šæ‰§è¡Œã€‚å› æ­¤,é™æ€åˆå§‹åŒ–åªåœ¨ Classå¯¹è±¡é¦–æ¬¡åŠ è½½çš„æ—¶å€™è¿›è¡Œä¸€æ¬¡\n3.å½“ç”¨ new Dog0åˆ›å»ºå¯¹è±¡çš„æ—¶å€™,é¦–å…ˆå°†åœ¨å †ä¸Šä¸ºDogå¯¹è±¡åˆ†é…è¶³å¤Ÿçš„å­˜å‚¨ç©ºé—´ã€‚\n4.è¿™å—å­˜å‚¨ç©ºé—´ä¼šè¢«æ¸…é›¶,è¿™å°±è‡ªåŠ¨åœ°å°†Dogå¯¹è±¡ä¸­çš„æ‰€æœ‰åŸºæœ¬ç±»å‹æ•°æ®éƒ½è®¾ç½®æˆäº†é»˜è®¤å€¼ (å¯¹æ•°å­—æ¥è¯´å°±æ˜¯0,å¯¹å¸ƒå°”å‹å’Œå­—ç¬¦å‹ä¹Ÿç›¸åŒ),è€Œå¼•ç”¨åˆ™è¢«è®¾ç½®æˆäº†nul\n5æ‰§è¡Œæ‰€æœ‰å‡ºç°äºå­—æ®µå®šä¹‰å¤„çš„åˆå§‹åŒ–åŠ¨ä½œã€‚\n6.æ‰§è¡Œæ„é€ å™¨ã€‚æ­£å¦‚å°†åœ¨ç¬¬7ç« æ‰€çœ‹åˆ°çš„,è¿™å¯èƒ½ä¼šç‰µæ¶‰åˆ°å¾ˆå¤šåŠ¨ä½œ,å°¤å…¶æ˜¯æ¶‰åŠç»§æ‰¿çš„\næ—¶å€™ã€‚\n","date":"0001-01-01T00:00:00Z","permalink":"https://dccmmtop.github.io/posts/java%E7%9F%A5%E8%AF%86%E7%82%B9/","section":"posts","tags":null,"title":""},{"categories":null,"contents":"ç¼“å­˜ 2.2 ä½¿ç”¨ Redis ç¼“å­˜\næ³¨æ„ï¼š@Cacheable / @CachePut /@CacheEvict æ³¨è§£éœ€ä½¿ç”¨åœ¨ public ä¿®é¥°çš„æ–¹æ³•ä¸Š\n2.2.2 ç¼“å­˜æ³¨è§£ä½¿ç”¨\n@Cacheable\n@Cacheable(value = \u0026#34;test\u0026#34;, key = \u0026#34;#msg\u0026#34;) public String put(String msg) { return msg; } ä½¿ç”¨ @Cacheable æ³¨è§£ï¼Œä¼šä»¥ value::key çš„å½¢å¼ä½œä¸º keyï¼Œå°†æ–¹æ³•çš„è¿”å›å€¼åšä¸º valueï¼Œè¿›è¡Œç¼“å­˜ã€‚ä¾‹å¦‚ç¤ºä¾‹ä¸­ä¼ å…¥çš„å‚æ•° msg ä¸º â€œABCâ€ï¼Œåˆ™ Redis ç¼“å­˜ä¸­å¯¹åº”çš„ key-value ä¸º test::ABC - ABC.\nè‹¥åœ¨å…¶å®ƒæ–¹æ³•ä¸­éœ€è¦ä»ç¼“å­˜ä¸­è·å–å¯¹åº”çš„æ•°æ®ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–ï¼š\n@Autowired private StringRedisTemplate stringRedisTemplate; String value= stringRedisTemplate.opsForValue().get(key); // å¦‚ test:ABC å¦‚æœå­˜åœ¨å¤šä¸ªå‚æ•°ï¼Œä¸”è¦æ±‚å¤šä¸ªå‚æ•°åŒæ—¶åšä¸ºkey æ—¶ï¼Œå‚è€ƒå¦‚ä¸‹é…ç½®ï¼Œæ­¤æ—¶åªæœ‰ id,name,age åŒæ—¶ä¸€è‡´æ—¶ï¼Œæ‰ä¼šä» Redis è·å–æ•°æ®\n@Cacheable(value = \u0026#34;test\u0026#34;, key = \u0026#34;#id + #name + #age\u0026#34;) public String testCache(String id, String name, String age) { System.out.println(\u0026#34;å¯¹æ•°æ® ã€\u0026#34; + id + name + age + \u0026#34;ã€‘ æ‰§è¡Œæœ¬åœ°ç¼“å­˜\u0026#34;); return \u0026#34;nativeCache\u0026#34; + id + name + age; } @CacheaPut\nä½¿ç”¨è¯¥æ³¨è§£ï¼Œåˆ™ä¸ä¼šä»ç¼“å­˜ä¸­è·å–å¯¹åº”çš„æ•°æ®ï¼Œè€Œæ˜¯æ¯æ¬¡éƒ½æ‰§è¡Œç›¸åº”çš„ä»£ç ï¼Œå¹¶å°†æ‰§è¡Œç»“æœå­˜å…¥æŒ‡å®šçš„ç¼“å­˜ã€‚\n@CacheaEvict\nä½¿ç”¨è¯¥æ³¨è§£ï¼Œä¼šæ¸…é™¤å¯¹åº”çš„ç¼“å­˜ä¿¡æ¯ã€‚\næ³¨ï¼šè¿™é‡Œåªæ˜¯ç®€å•çš„æè¿°äº†ä½¿ç”¨æ–¹æ³•ï¼Œæ›´åŠ è¯¦ç»†çš„ä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥è‡ªè¡Œç™¾åº¦ã€‚\n","date":"0001-01-01T00:00:00Z","permalink":"https://dccmmtop.github.io/posts/%E7%BC%93%E5%AD%98/","section":"posts","tags":null,"title":""},{"categories":null,"contents":"","date":"0001-01-01T00:00:00Z","permalink":"https://dccmmtop.github.io/search/","section":"","tags":null,"title":"Search Results"},{"categories":null,"contents":" ä¸ªäººç®€ä»‹ï¼šå–œçˆ±ç¼–ç¨‹ æ“…é•¿ Java Ruby Golang Linux å¯¹ Vim æƒ…æœ‰ç‹¬é’Ÿ\né‚®ç®±ï¼šdccmmtop@foxmail.com\nCSDN: https://blog.csdn.net/a141210104/\nè¦åšå¼º\nä½ è¦å…‹æœæ‡’æƒ°\rä½ è¦å…‹æœæ¸¸æ‰‹å¥½é—²\rä½ è¦å…‹æœæ¼«é•¿çš„ç™½æ—¥æ¢¦\rä½ è¦å…‹æœä¸€è¹´è€Œå°±çš„å¦„æƒ³\rä½ è¦å…‹æœè‡ªä»¥ä¸ºæ˜¯æµ…è–„çš„å¹½é»˜æ„Ÿ\rä½ è¦ç‹¬ç«‹ç”Ÿé•¿åœ¨è¿™ä¸–ä¸Š\rä¸å¯»æ‰¾ä¸ä¾é \rå› ä¸ºå†·æ¼ å¯¡æƒ…çš„äººå­¤ç‹¬ä¸€ç”Ÿ\rä½ è¦åšå¼ºï¼ŒæŒ¯ä½œï¼Œè‡ªç«‹\rä¸èƒ½è½¯å¼±ï¼Œé€ƒé¿ï¼Œå®³æ€•\rä¸è¦æ²‰æººåœ¨æ¶ˆæè´Ÿé¢å¾—æƒ…ç»ªé‡Œ\rè¦æ­£é¢é˜³å…‰å¾—å¯¹å¾…ç”Ÿæ´»å’Œçˆ±ä½ çš„äºº\r","date":"0001-01-01T00:00:00Z","permalink":"https://dccmmtop.github.io/about/","section":"","tags":null,"title":"ä½ å¥½"}]